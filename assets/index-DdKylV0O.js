import{v as Yr,B as qr,t as ce,E as ue,g as gr,a as Le,b as at,V as Te,S as Xr,c as Zr,d as Jr,e as xe,f as Bt,R as Rt,T as Qr,m as C,h as K,i as G,j as en,k as tn,l as rn,M as Y,n as Z,o as fe,p as lr,q as nn,I as an,r as ne,s as Se,u as te,w as Ue,x as De,y as pr,z as sn,A as We,C as Lt,D as on,F as He,G as J,H as Ct,J as Q,K as hr,L as cn,N as Ut,O as ye,P as St,Q as dr,U as xr,W as un,X as L,Y as Ne,Z as fn,_ as gn,$ as ve,a0 as bt,a1 as dt,a2 as Ke,a3 as be,a4 as ln,a5 as pn,a6 as hn,a7 as wt,a8 as E,a9 as ie,aa as dn,ab as xn,ac as yn,ad as he,ae as mn,af as vn,ag as Oe,ah as Tn,ai as Cn,aj as Sn,ak as bn}from"./index-Cp4iUYqv.js";import{au as ji,at as Yi,aW as qi,as as Xi,ay as Zi,aS as Ji,aU as Qi,aw as eo,av as to,ax as ro,ar as no,aV as ao,aT as so,aX as io,aY as oo,aF as co,aG as uo,aB as fo,aC as go,aE as lo,aD as po,az as ho,aA as xo,aO as yo,aq as mo,aN as vo,aH as To,al as Co,am as So,aK as bo,an as wo,aI as Do,aN as Oo,ao as Vo,aR as Mo,aZ as ko,ap as Bo,aQ as Ro,aP as Lo,aM as Uo,aL as No,aJ as Po}from"./index-Cp4iUYqv.js";import{D as rt,B as je,v as wn,a as ge}from"./Texture-C9D3AFRO.js";import{S as Eo,c as Go,b as _o}from"./Texture-C9D3AFRO.js";import{i as Io}from"./imageRetrievalPoolManager-DiP2nqZv.js";class Dn{constructor(e){this.contexts=[],this.offScreenCanvasContainers=[],this.viewportToContext=new Map,this.viewportSizes=new Map,this.contextMaxSizes=new Map;for(let r=0;r<e;r++){const n=Yr.newInstance(),a=document.createElement("div");n.setContainer(a),this.contexts.push(n),this.offScreenCanvasContainers.push(a)}}getContextByIndex(e){return e>=0&&e<this.contexts.length?{context:this.contexts[e],container:this.offScreenCanvasContainers[e]}:null}assignViewportToContext(e,r){this.viewportToContext.set(e,r)}getContextIndexForViewport(e){return this.viewportToContext.get(e)}getAllContexts(){return this.contexts}getContextCount(){return this.contexts.length}updateViewportSize(e,r,n){const a=this.viewportToContext.get(e);if(a===void 0)return!1;this.viewportSizes.set(e,{width:r,height:n});const s=this.contextMaxSizes.get(a),i=this.calculateMaxSizeForContext(a);return this.contextMaxSizes.set(a,i),!s||s.width!==i.width||s.height!==i.height}getMaxSizeForContext(e){return this.contextMaxSizes.get(e)}calculateMaxSizeForContext(e){let r=0,n=0;return this.viewportToContext.forEach((a,s)=>{if(a===e){const i=this.viewportSizes.get(s);i&&(r=Math.max(r,i.width),n=Math.max(n,i.height))}}),{width:r,height:n}}removeViewport(e){const r=this.viewportToContext.get(e);if(this.viewportToContext.delete(e),this.viewportSizes.delete(e),r!==void 0){const n=this.calculateMaxSizeForContext(r);this.contextMaxSizes.set(r,n)}}destroy(){this.contexts.forEach(e=>{e.delete()}),this.contexts=[],this.offScreenCanvasContainers=[],this.viewportToContext.clear(),this.viewportSizes.clear(),this.contextMaxSizes.clear()}}class Nt extends qr{constructor(e){super(e),this._renderFlaggedViewports=()=>{this._throwIfDestroyed();const s=this._getViewportsAsArray().filter(o=>this._needsRender.has(o.id));if(s.length===0){this._animationFrameSet=!1,this._animationFrameHandle=null;return}const i=s.map(o=>{const c=this.renderViewportUsingCustomOrVtkPipeline(o);return o.setRendered(),this._needsRender.delete(o.id),c});this._animationFrameSet=!1,this._animationFrameHandle=null,i.forEach(o=>{o?.element&&ce(o.element,ue.IMAGE_RENDERED,o)})};const{rendering:r}=gr(),{webGlContextCount:n}=r;this.useCPURendering||(this.contextPool=new Dn(n))}enableVTKjsDrivenViewport(e){const a=this._getViewportsAsArray().filter(o=>Le(o.type)===!1).map(o=>o.canvas),s=at(e.element);a.push(s);const i={...e,canvas:s};this.addVtkjsDrivenViewport(i)}addVtkjsDrivenViewport(e){const{element:r,canvas:n,viewportId:a,type:s,defaultOptions:i}=e;r.tabIndex=-1;let o=0;if(s===Te.STACK){const x=this.contextPool.getAllContexts();o=this._viewports.size%x.length}this.contextPool.assignViewportToContext(a,o),this.contextPool.updateViewportSize(a,n.width,n.height);const c=this.contextPool.getContextByIndex(o),{context:u,container:g}=c,f=this.contextPool.getMaxSizeForContext(o);g.width=f.width,g.height=f.height,u.resize(),u.addRenderer({viewport:[0,0,1,1],id:a,background:i.background?i.background:[0,0,0]});const p={id:a,element:r,renderingEngineId:this.id,type:s,canvas:n,sx:0,sy:0,sWidth:n.width,sHeight:n.height,defaultOptions:i||{}};let l;if(s===Te.STACK)l=new Xr(p);else if(s===Te.ORTHOGRAPHIC||s===Te.PERSPECTIVE)l=new Zr(p);else if(s===Te.VOLUME_3D)l=new Jr(p);else throw new Error(`Viewport Type ${s} is not supported`);this._viewports.set(a,l);const h={element:r,viewportId:a,renderingEngineId:this.id};l.suppressEvents||ce(xe,ue.ELEMENT_ENABLED,h)}setVtkjsDrivenViewports(e){if(e.length){const r=e.map(n=>at(n.element));r.forEach(n=>{const a=window.devicePixelRatio||1,s=n.getBoundingClientRect();n.width=s.width*a,n.height=s.height*a});for(let n=0;n<e.length;n++){const a=e[n],s=r[n],i={...a,canvas:s};this.addVtkjsDrivenViewport(i)}}}_resizeVTKViewports(e,r=!0,n=!0){const a=e.map(s=>at(s.element));a.forEach(s=>{const i=window.devicePixelRatio||1;s.width=s.clientWidth*i,s.height=s.clientHeight*i}),a.length&&this._resize(e),e.forEach(s=>{const i=s.getCamera(),o=s.getRotation(),{flipHorizontal:c}=i;s.resetCameraForResize();const u=s.getDisplayArea();r&&(u?(c&&s.setCamera({flipHorizontal:c}),o&&s.setViewPresentation({rotation:o})):s.setCamera(i))}),n&&this.render()}renderViewportUsingCustomOrVtkPipeline(e){if(Le(e.type))return e.customRenderViewportToCanvas();if(this.useCPURendering)throw new Error("GPU not available, and using a viewport with no custom render pipeline.");const r=this.contextPool.getContextIndexForViewport(e.id),n=this.contextPool.getContextByIndex(r),{context:a,container:s}=n;return this._renderViewportWithContext(e,a,s)}_renderViewportWithContext(e,r,n){if(e.sWidth<Bt||e.sHeight<Bt){console.warn("Viewport is too small",e.sWidth,e.sHeight);return}if(Le(e.type))return e.customRenderViewportToCanvas();if(this.useCPURendering)throw new Error("GPU not available, and using a viewport with no custom render pipeline.");r.getRenderer(e.id)||r.addRenderer({viewport:[0,0,1,1],id:e.id,background:e.defaultOptions?.background||[0,0,0]});const a=r.getRenderWindow(),s=a.getViews()[0],i=s.getRenderPasses(),o=this.getViewportRenderPasses(e.id);o&&s.setRenderPasses(o),this._resizeOffScreenCanvasForViewport(e,n,r);const c=r.getRenderer(e.id),u=this.contextPool.getContextIndexForViewport(e.id),g=this.contextPool.getMaxSizeForContext(u),f=e.canvas.width,p=e.canvas.height,l=Math.min(1,f/g.width),h=Math.min(1,p/g.height);c.setViewport(0,0,l,h);const x=r.getRenderers();x.forEach(({renderer:y,id:S})=>{y.setDraw(S===e.id)});const d=this.getWidgetRenderers();d.forEach((y,S)=>{S.setDraw(y===e.id)}),a.render(),x.forEach(({renderer:y})=>y.setDraw(!1)),d.forEach((y,S)=>{S.setDraw(!1)}),i&&s.setRenderPasses(i);const m=r.getOpenGLRenderWindow().get3DContext().canvas;return this._copyToOnscreenCanvas(e,m)}_renderViewportFromVtkCanvasToOnscreenCanvas(e,r){return this._copyToOnscreenCanvas(e,r)}_resizeOffScreenCanvasForViewport(e,r,n){const a=this.contextPool.getContextIndexForViewport(e.id);if(a===void 0||!this.contextPool.updateViewportSize(e.id,e.canvas.width,e.canvas.height))return;const i=this.contextPool.getMaxSizeForContext(a);r.width===i.width&&r.height===i.height||(r.width=i.width,r.height=i.height,n.resize())}_copyToOnscreenCanvas(e,r){const{element:n,canvas:a,id:s,renderingEngineId:i,suppressEvents:o}=e,{width:c,height:u}=a,g=a.getContext("2d"),f=this.contextPool.getContextIndexForViewport(s),l=this.contextPool.getMaxSizeForContext(f).height-u;return g.drawImage(r,0,l,c,u,0,0,c,u),{element:n,suppressEvents:o,viewportId:s,renderingEngineId:i,viewportStatus:e.viewportStatus}}_resize(e){const r=new Set;for(const n of e){n.sx=0,n.sy=0,n.sWidth=n.canvas.width,n.sHeight=n.canvas.height;const a=this.contextPool.getContextIndexForViewport(n.id);this.contextPool.updateViewportSize(n.id,n.canvas.width,n.canvas.height)&&r.add(a);const i=this.contextPool.getContextByIndex(a),{context:o}=i,c=o.getRenderer(n.id),u=this.contextPool.getMaxSizeForContext(a),g=Math.min(1,n.canvas.width/u.width),f=Math.min(1,n.canvas.height/u.height);c.setViewport(0,0,g,f)}r.forEach(n=>{const a=this.contextPool.getContextByIndex(n);if(a){const{context:s,container:i}=a,o=this.contextPool.getMaxSizeForContext(n);i.width=o.width,i.height=o.height,s.resize()}})}getWidgetRenderers(){const e=this._getViewportsAsArray(),r=new Map;return e.forEach(n=>{(n.getWidgets?n.getWidgets():[]).forEach(s=>{const i=s.getRenderer?s.getRenderer():null;i&&r.set(i,n.id)})}),r}getViewportRenderPasses(e){const r=this.getViewport(e);return r?.getRenderPasses?r.getRenderPasses():null}getRenderer(e){const r=this.contextPool?.getContextIndexForViewport(e),n=this.contextPool.getContextByIndex(r),{context:a}=n;return a.getRenderer(e)}disableElement(e){const r=this.getViewport(e);if(r&&(super.disableElement(e),!Le(r.type)&&!this.useCPURendering)){const n=this.contextPool.getContextIndexForViewport(e);if(n!==void 0){const a=this.contextPool.getContextByIndex(n);if(a){const{context:s}=a;s.removeRenderer(e)}}this.contextPool.removeViewport(e)}}destroy(){this.contextPool&&this.contextPool.destroy(),super.destroy()}getOffscreenMultiRenderWindow(e){if(this.useCPURendering)throw new Error("Offscreen multi render window is not available when using CPU rendering.");const r=this.contextPool.getContextIndexForViewport(e);return this.contextPool.getContextByIndex(r).context}}class Ii{constructor(e){const n=gr()?.rendering?.renderingEngineMode;switch(n){case Rt.Tiled:this._implementation=new Qr(e);break;case Rt.ContextPool:this._implementation=new Nt(e);break;default:console.warn(`RenderingEngine: Unknown rendering engine mode "${n}". Defaulting to Next rendering engine.`),this._implementation=new Nt(e);break}}get id(){return this._implementation.id}enableElement(e){return this._implementation.enableElement(e)}disableElement(e){return this._implementation.disableElement(e)}setViewports(e){return this._implementation.setViewports(e)}resize(e=!0,r=!0){return this._implementation.resize(e,r)}getViewport(e){return this._implementation.getViewport(e)}getViewports(){return this._implementation.getViewports()}getStackViewport(e){return this._implementation.getStackViewport(e)}getStackViewports(){return this._implementation.getStackViewports()}getVolumeViewports(){return this._implementation.getVolumeViewports()}getRenderer(e){return this._implementation.getRenderer(e)}fillCanvasWithBackgroundColor(e,r){return this._implementation.fillCanvasWithBackgroundColor(e,r)}render(){return this._implementation.render()}renderViewports(e){return this._implementation.renderViewports(e)}renderViewport(e){return this._implementation.renderViewport(e)}destroy(){return this._implementation.destroy()}getOffscreenMultiRenderWindow(e){return this._implementation.getOffscreenMultiRenderWindow(e)}}const zi="4.14.4";class On{constructor(e){this._color=[200,0,0],this.id=e.id,this._points=e.points,this._polys=e.polys,this._color=e.color??this._color,this.frameOfReferenceUID=e.frameOfReferenceUID,this._segmentIndex=e.segmentIndex,this.sizeInBytes=this._getSizeInBytes(),this._updateCentroid(),this._visible=!0}_getSizeInBytes(){return this._points.length*4+this._polys.length*4}_updateCentroid(){const e=this._points.length/3;let r=0,n=0,a=0;for(let s=0;s<this._points.length;s+=3)r+=this._points[s],n+=this._points[s+1],a+=this._points[s+2];this._centroid=[r/e,n/e,a/e]}get color(){return this._color}set color(e){this._color=e}get points(){return this._points}set points(e){this._points=e,this._updateCentroid()}get polys(){return this._polys}set polys(e){this._polys=e}get segmentIndex(){return this._segmentIndex}get visible(){return this._visible}set visible(e){this._visible=e}get centroid(){return this._centroid}get flatPointsArray(){return this._points}get totalNumberOfPoints(){return this._points.length/3}}const st={ASCII:"ascii",BINARY_LITTLE_ENDIAN:"binary_little_endian"},Pt={diffuse_red:"red",diffuse_green:"green",diffuse_blue:"blue"},yr={patternHeader:/ply([\s\S]*)end_header\r?\n/,patternBody:/end_header\s([\s\S]*)$/};function At(t){let e="",r=0;const n=yr.patternHeader.exec(t);n!==null&&(e=n[1],r=n[0].length);const a={comments:[],elements:[],headerLength:r},s=e.split(`
`);let i,o,c;for(let u=0;u<s.length;u++){let g=s[u];if(g=g.trim(),g!==""){let f;switch(c=g.split(/\s+/),o=c.shift(),g=c.join(" "),o){case"format":a.format=c[0],a.version=c[1];break;case"comment":a.comments.push(g);break;case"element":i!==void 0&&a.elements.push(i),i={},i.name=c[0],i.count=parseInt(c[1],10),i.properties=[];break;case"property":f={type:c[0]},f.type==="list"?(f.name=c[3],f.countType=c[1],f.itemType=c[2]):f.name=c[1],f.name in Pt&&(f.name=Pt[f.name]),i.properties.push(f);break;case"obj_info":a.objInfo=g;break;default:console.warn("unhandled",o,c);break}}}return i!==void 0&&a.elements.push(i),a}function Et(t,e,r,n){const a=e.find(m=>m.name==="vertex"),s=e.find(m=>m.name==="face");let i=0,o=0;a&&(i=a.count),s&&(o=s.count);let c=new Float32Array(i*3),u=new Uint8Array(i*3),g=new Float32Array(i*2),f=new Float32Array(i*3);const p=t.colors.length>0,l=t.uvs.length>0,h=t.normals.length>0,x=t.faceVertexUvs.length>0,d=new Map;let T=i;for(let m=0;m<i;m++){let v=m*3+0,y=m*3+1;const S=m*3+2;c[v]=t.vertices[v],c[y]=t.vertices[y],c[S]=t.vertices[S],p&&(u[v]=t.colors[v],u[y]=t.colors[y],u[S]=t.colors[S]),l?(v=m*2+0,y=m*2+1,g[v]=t.uvs[v],g[y]=t.uvs[y]):(g[m*2]=-1,g[m*2+1]=-1),h&&(f[v]=t.normals[v],f[y]=t.normals[y],f[S]=t.normals[S])}if(x&&!l&&o>0){let m=0,v=0;if(n){const y=[],S=[],M=[],B=[];for(let N=0;N<o;++N){const _=t.indices[m++],O=t.faceVertexUvs[v++];if(O&&_*2===O.length)for(let U=0;U<_;++U){const V=t.indices[m+U],A=[O[U*2],O[U*2+1]],le=[g[V*2],g[V*2+1]];if(le[0]===-1){g[V*2]=A[0],g[V*2+1]=A[1];const X=`${A[0]},${A[1]}`;d.has(X)||d.set(X,[]),d.get(X).push(V)}else if(Math.abs(le[0]-A[0])>r||Math.abs(le[1]-A[1])>r){const j=`${A[0]},${A[1]}`;let ee=-1;if(d.has(j)){const z=d.get(j);for(let nt=0,jr=z.length;nt<jr;nt++){const Re=z[nt];if(Math.abs(c[Re*3]-c[V*3])<=r&&Math.abs(c[Re*3+1]-c[V*3+1])<=r&&Math.abs(c[Re*3+2]-c[V*3+2])<=r){ee=Re;break}}}ee===-1?(y.push(c[V*3],c[V*3+1],c[V*3+2]),p&&S.push(u[V*3],u[V*3+1],u[V*3+2]),h&&M.push(f[V*3],f[V*3+1],f[V*3+2]),B.push(A[0],A[1]),d.has(j)||d.set(j,[]),d.get(j).push(T),t.indices[m+U]=T,T++):t.indices[m+U]=ee}}m+=_}if(y.length>0){const N=i+y.length/3,_=new Float32Array(N*3),O=new Float32Array(N*2),U=p?new Uint8Array(N*3):null,V=h?new Float32Array(N*3):null;_.set(c),O.set(g),p&&U&&U.set(u),h&&V&&V.set(f),_.set(y,i*3),O.set(B,i*2),p&&U&&U.set(S,i*3),h&&V&&V.set(M,i*3),c=_,g=O,p&&(u=U),h&&(f=V)}}else for(let y=0;y<o;++y){const S=t.indices[m++],M=t.faceVertexUvs[v++];if(M&&S*2===M.length)for(let B=0;B<S;++B){const N=t.indices[m++];g[N*2]=M[B*2],g[N*2+1]=M[B*2+1]}else m+=S}}const b=K.newInstance();if(b.getPoints().setData(c,3),o>0)b.getPolys().setData(Uint32Array.from(t.indices));else{const m=new Uint32Array(i*2);for(let v=0;v<i;v++)m[v*2]=1,m[v*2+1]=v;b.getVerts().setData(m)}if(p&&b.getPointData().setScalars(G.newInstance({numberOfComponents:3,values:u,name:"RGB"})),l||x){const m=G.newInstance({numberOfComponents:2,values:g,name:"TextureCoordinates"}),v=b.getPointData();v.addArray(m),v.setActiveTCoords(m.getName())}return h&&b.getPointData().setNormals(G.newInstance({numberOfComponents:3,name:"Normals",values:f})),b}function it(t,e){let r;switch(e){case"char":case"uchar":case"short":case"ushort":case"int":case"uint":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":r=parseInt(t,10);break;case"float":case"double":case"float32":case"float64":r=parseFloat(t);break;default:console.log("Unsupported type");break}return r}function Vn(t,e){const r=e.split(/\s+/),n={};for(let a=0;a<t.length;a++)if(t[a].type==="list"){const s=[],i=it(r.shift(),t[a].countType);for(let o=0;o<i;o++)s.push(it(r.shift(),t[a].itemType));n[t[a].name]=s}else n[t[a].name]=it(r.shift(),t[a].type);return n}function Gt(t,e,r){if(e==="vertex")t.vertices.push(r.x,r.y,r.z),"nx"in r&&"ny"in r&&"nz"in r&&t.normals.push(r.nx,r.ny,r.nz),"s"in r&&"t"in r?t.uvs.push(r.s,r.t):"u"in r&&"v"in r?t.uvs.push(r.u,r.v):"texture_u"in r&&"texture_v"in r&&t.uvs.push(r.texture_u,r.texture_v),"red"in r&&"green"in r&&"blue"in r&&t.colors.push(r.red,r.green,r.blue);else if(e==="face"){const n=r.vertex_indices||r.vertex_index,a=r.texcoord;n&&n.length>0&&(t.indices.push(n.length),n.forEach((s,i)=>{t.indices.push(s)})),t.faceVertexUvs.push(a)}}function ot(t,e,r,n){let a;switch(r){case"int8":case"char":a=[t.getInt8(e),1];break;case"uint8":case"uchar":a=[t.getUint8(e),1];break;case"int16":case"short":a=[t.getInt16(e,n),2];break;case"uint16":case"ushort":a=[t.getUint16(e,n),2];break;case"int32":case"int":a=[t.getInt32(e,n),4];break;case"uint32":case"uint":a=[t.getUint32(e,n),4];break;case"float32":case"float":a=[t.getFloat32(e,n),4];break;case"float64":case"double":a=[t.getFloat64(e,n),8];break;default:console.log("Unsupported type");break}return a}function Mn(t,e,r,n){const a={};let s,i=0;for(let o=0;o<r.length;o++)if(r[o].type==="list"){const c=[];s=ot(t,e+i,r[o].countType,n);const u=s[0];i+=s[1];for(let g=0;g<u;g++)s=ot(t,e+i,r[o].itemType,n),c.push(s[0]),i+=s[1];a[r[o].name]=c}else s=ot(t,e+i,r[o].type,n),a[r[o].name]=s[0],i+=s[1];return[a,i]}function kn(t,e){e.classHierarchy.push("vtkPLYReader"),e.dataAccessHelper||(e.dataAccessHelper=rt.get("http"));function r(n){let a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const{compression:s,progressCallback:i}=e;return a.binary?e.dataAccessHelper.fetchBinary(n,{compression:s,progressCallback:i}):e.dataAccessHelper.fetchText(t,n,{compression:s,progressCallback:i})}t.setUrl=function(n){let a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{binary:!0};e.url=n;const s=n.split("/");return s.pop(),e.baseURL=s.join("/"),e.compression=a.compression,t.loadData({progressCallback:a.progressCallback,binary:!!a.binary})},t.loadData=function(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const a=r(e.url,n);return a.then(t.parse),a},t.parse=n=>{typeof n=="string"?t.parseAsText(n):t.parseAsArrayBuffer(n)},t.parseAsArrayBuffer=n=>{if(!n)return;if(n!==e.parseData)t.modified();else return;let a=n;n instanceof ArrayBuffer&&(a=je.arrayBufferToString(n));const s=At(a);if(!(s.format!==st.ASCII)){t.parseAsText(a);return}e.parseData=n;const o={indices:[],vertices:[],normals:[],uvs:[],faceVertexUvs:[],colors:[]},c=s.format===st.BINARY_LITTLE_ENDIAN,u=n instanceof ArrayBuffer?n:n.buffer,g=new DataView(u,s.headerLength);let f,p=0;for(let h=0;h<s.elements.length;h++)for(let x=0;x<s.elements[h].count;x++){f=Mn(g,p,s.elements[h].properties,c),p+=f[1];const d=f[0];Gt(o,s.elements[h].name,d)}const l=Et(o,s.elements,e.faceTextureTolerance,e.duplicatePointsForFaceTexture);e.output[0]=l},t.parseAsText=n=>{if(!n)return;if(n!==e.parseData)t.modified();else return;e.parseData=n;let a=n;n instanceof ArrayBuffer&&(a=je.arrayBufferToString(n));const s=At(a);if(s.format!==st.ASCII){t.parseAsArrayBuffer(n);return}const o={indices:[],vertices:[],normals:[],uvs:[],faceVertexUvs:[],colors:[]},c=yr.patternBody.exec(a);let u="";c!==null&&(u=c[1]);const g=u.split(`
`);let f=0,p=0;for(let h=0;h<g.length;h++){let x=g[h];if(x=x.trim(),x!==""){p>=s.elements[f].count&&(f++,p=0);const d=Vn(s.elements[f].properties,x);Gt(o,s.elements[f].name,d),p++}}const l=Et(o,s.elements,e.faceTextureTolerance,e.duplicatePointsForFaceTexture);e.output[0]=l},t.requestData=(n,a)=>{t.parse(e.parseData)}}const Bn={faceTextureTolerance:1e-6,duplicatePointsForFaceTexture:!0};function mr(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,Bn,r),C.obj(t,e),C.get(t,e,["url","baseURL","duplicatePointsForFaceTexture","faceTextureTolerance"]),C.setGet(t,e,["dataAccessHelper"]),C.algo(t,e,0,1),kn(t,e),e.compression||(e.compression=null),e.progressCallback||(e.progressCallback=null)}const Rn=C.newInstance(mr,"vtkPLYReader");var Ln={extend:mr,newInstance:Rn};const{vtkErrorMacro:ct}=C;function Un(t){const r=t.split(" ").filter(a=>a.indexOf("=")>-1),n={};for(let a=0;a<r.length;++a){const i=r[a].split("=");i.length===2&&(n[i[0]]=i[1])}return n}function _t(t,e){for(let r=0;r<t.length;r++)e.push(t[r])}function Nn(t,e,r,n,a){const s=t[e];if(s===void 0)return-1;if(s.indexOf("endfacet")!==-1||s.indexOf("facet")===-1)return e+1;let i=0,o=2;const c=r.length/3,u=s.split(/[ \t]+/).filter(g=>g).slice(-3).map(Number);for(_t(u,a);t[e+o].indexOf("vertex")!==-1;){const f=t[e+o].split(/[ \t]+/).filter(p=>p).slice(-3).map(Number);_t(f,r),i++,o++}n.push(i);for(let g=0;g<i;g++)n.push(c+g);for(;t[e+o]&&t[e+o].indexOf("endfacet")!==-1;)o++;return e+o+2}function Pn(t,e){e.classHierarchy.push("vtkSTLReader"),e.dataAccessHelper||(e.dataAccessHelper=rt.get("http"));function r(a){let s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const i=s.compression!==void 0?s.compression:e.compression,o=s.progressCallback!==void 0?s.progressCallback:e.progressCallback;return s.binary?e.dataAccessHelper.fetchBinary(a,{compression:i,progressCallback:o}):e.dataAccessHelper.fetchText(t,a,{compression:i,progressCallback:o})}function n(a){const s=e.output[0],i=s.getPoints().getData(),o=s.getPolys().getData();if(!i||!o){console.warn("No valid polydata.");return}const c=new Map,u=new Map;let g=0,f=!1;for(let p=0;p<i.length;p+=3){const l=(i[p]*10**a).toFixed(0),h=(i[p+1]*10**a).toFixed(0),x=(i[p+2]*10**a).toFixed(0),d=`${l},${h},${x}`;c.get(d)!==void 0?(u.set(p/3,c.get(d)),f=!0):(u.set(p/3,g),c.set(d,g),g++)}if(f){const p=new Float32Array(c.size*3),l=Array.from(c.keys());for(let x=0;x<l.length;x++){const d=l[x],T=c.get(d)*3,b=d.split(",").map(m=>+m*10**-a);p[T]=b[0],p[T+1]=b[1],p[T+2]=b[2]}const h=new Int32Array(o.length);for(let x=0;x<o.length;x+=4)h[x]=3,h[x+1]=u.get(o[x+1]),h[x+2]=u.get(o[x+2]),h[x+3]=u.get(o[x+3]);s.getPoints().setData(p),s.getPolys().setData(h),s.modified()}}t.setUrl=function(a){let s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{binary:!0};e.url=a;const i=a.split("/");return i.pop(),e.baseURL=i.join("/"),t.loadData(s)},t.loadData=function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const s=r(e.url,a);return s.then(t.parse),s},t.parse=a=>{typeof a=="string"?t.parseAsText(a):t.parseAsArrayBuffer(a)},t.parseAsArrayBuffer=a=>{if(!a)return;if(a!==e.parseData)t.modified();else return;e.parseData=a;let s=!1;if(s=84+new DataView(a,0,84).getUint32(80,!0)*50===a.byteLength,!s){t.parseAsText(je.arrayBufferToString(a));return}const c=a.slice(0,80),u=je.arrayBufferToString(c),g=Un(u),f=new DataView(a,84),p=(a.byteLength-84)/50,l=new Float32Array(p*9),h=new Float32Array(p*3),x=new Uint32Array(p*4),d=new Uint16Array(p);let T=0;for(let v=0;v<p;v++){const y=v*50;h[v*3+0]=f.getFloat32(y+0,!0),h[v*3+1]=f.getFloat32(y+4,!0),h[v*3+2]=f.getFloat32(y+8,!0),l[v*9+0]=f.getFloat32(y+12,!0),l[v*9+1]=f.getFloat32(y+16,!0),l[v*9+2]=f.getFloat32(y+20,!0),l[v*9+3]=f.getFloat32(y+24,!0),l[v*9+4]=f.getFloat32(y+28,!0),l[v*9+5]=f.getFloat32(y+32,!0),l[v*9+6]=f.getFloat32(y+36,!0),l[v*9+7]=f.getFloat32(y+40,!0),l[v*9+8]=f.getFloat32(y+44,!0),x[T++]=3,x[T++]=v*3+0,x[T++]=v*3+1,x[T++]=v*3+2,d[v]=f.getUint16(y+48,!0)}const b="SPACE";if(b in g&&g[b]!=="LPS"){const v=g[b],y=new Float32Array(16);switch(y[15]=1,v[0]){case"L":y[0]=1;break;case"R":y[0]=-1;break;default:ct(`Can not convert STL file from ${v} to LPS space: permutations not supported. Use itk.js STL reader instead.`);return}switch(v[1]){case"P":y[5]=1;break;case"A":y[5]=-1;break;default:ct(`Can not convert STL file from ${v} to LPS space: permutations not supported. Use itk.js STL reader instead.`);return}switch(v[2]){case"S":y[10]=1;break;case"I":y[10]=-1;break;default:ct(`Can not convert STL file from ${v} to LPS space: permutations not supported. Use itk.js STL reader instead.`);return}en.buildFromDegree().setMatrix(y).apply(l).apply(h)}const m=K.newInstance();m.getPoints().setData(l,3),m.getPolys().setData(x),m.getCellData().setScalars(G.newInstance({name:"Attribute",values:d})),m.getCellData().setNormals(G.newInstance({name:"Normals",values:h,numberOfComponents:3})),e.output[0]=m,e.removeDuplicateVertices>=0&&n(e.removeDuplicateVertices)},t.parseAsText=a=>{if(!a)return;if(a!==e.parseData)t.modified();else return;e.parseData=a;const s=a.split(`
`);let i=1;const o=[],c=[],u=[];for(;i!==-1;)i=Nn(s,i,o,c,u);const g=K.newInstance();g.getPoints().setData(Float32Array.from(o),3),g.getPolys().setData(Uint32Array.from(c)),g.getCellData().setNormals(G.newInstance({name:"Normals",values:Float32Array.from(u),numberOfComponents:3})),e.output[0]=g,e.removeDuplicateVertices>=0&&n(e.removeDuplicateVertices)},t.requestData=(a,s)=>{t.parse(e.parseData)}}const An={removeDuplicateVertices:-1};function vr(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,An,r),C.obj(t,e),C.get(t,e,["url","baseURL"]),C.setGet(t,e,["dataAccessHelper","removeDuplicateVertices"]),C.algo(t,e,0,1),Pn(t,e),e.compression||(e.compression=null),e.progressCallback||(e.progressCallback=null)}const En=C.newInstance(vr,"vtkSTLReader");var Gn={extend:vr,newInstance:En};const D={};function ut(t,e,r,n,a){for(let s=0;s<a;s++)r[n+s]=t[e+s]}function _n(t){D.splitOn=t,D.pieces=[],D.v=[],D.vt=[],D.vn=[],D.f=[[]],D.size=0}function Fn(t){const e=t.split("/").map(s=>Number(s));let r=e[0]-1;r=r<0?r+1+D.v.length/3:r;let n=e[1]?e[1]-1:r;n=n<0?n+1+D.vt.length/2:n;let a=e[2]?e[2]-1:r;return a=a<0?a+1+D.vn.length/3:a,[r,n,a]}function In(t){if(t[0]==="#")return;const e=t.split(/[ \t]+/);if(e[0]===D.splitOn)e.shift(),D.pieces.push(e.join(" ").trim()),D.f.push([]),D.size++;else if(e[0]==="v")D.v.push(Number(e[1])),D.v.push(Number(e[2])),D.v.push(Number(e[3]));else if(e[0]==="vt")D.vt.push(Number(e[1])),D.vt.push(Number(e[2]));else if(e[0]==="vn")D.vn.push(Number(e[1])),D.vn.push(Number(e[2])),D.vn.push(Number(e[3]));else if(e[0]==="f"){D.size===0&&D.size++;const r=D.f[D.size-1];e.shift();const n=e.filter(s=>s.length>0&&s!=="\r"),a=n.length;r.push(a);for(let s=0;s<a;s++)r.push(Fn(n[s]))}}function zn(t){const e=!!D.vt.length,r=!!D.vn.length;if(t.splitMode){t.numberOfOutputs=D.size;for(let n=0;n<D.size;n++){const a=D.f[n],s=a.length,i=D.v.length/3,o={};let c;if(t.trackDuplicates){const d=[];let T=0;for(let m=0;m<s;){const v=a[m++];for(let y=0;y<v;y++){const[S,M,B]=a[m++],N=`${S}/${M}/${B}`;o[N]===void 0&&(d[S]===void 0?d[S]=[N]:(d[S].push(N),++T),o[N]=S)}}c=new Uint16Array(i+T);let b=0;for(let m=0;m<d.length;++m){const v=d[m]?d[m].length:0;c[m]=v>1?i+b:m;for(let y=1;y<v;++y){const S=i+b++;c[S]=m,o[d[m][y]]=S}}}const u={},g=K.newInstance({name:D.pieces[n]}),f=[],p=[],l=[],h=[];let x=0;for(;x<s;){const d=a[x];h.push(d);for(let T=0;T<d;T++){const[b,m,v]=a[x+T+1],y=`${b}/${m}/${v}`;if(u[y]===void 0){const S=t.trackDuplicates?o[y]:f.length/3;u[y]=S,ut(D.v,b*3,f,S*3,3),e&&ut(D.vt,m*2,p,S*2,2),r&&ut(D.vn,v*3,l,S*3,3)}h.push(u[y])}x+=d+1}if(g.getPoints().setData(Float32Array.from(f),3),t.trackDuplicates){const d=G.newInstance({name:"Duplicates",values:c});g.getPointData().addArray(d)}if(g.getPolys().setData(Uint32Array.from(h)),e){const d=G.newInstance({numberOfComponents:2,values:Float32Array.from(p),name:"TextureCoordinates"});g.getPointData().setTCoords(d)}if(r){const d=G.newInstance({numberOfComponents:3,values:Float32Array.from(l),name:"Normals"});g.getPointData().setNormals(d)}t.output[n]=g}}else{t.numberOfOutputs=1;const n=K.newInstance();if(n.getPoints().setData(Float32Array.from(D.v),3),e&&D.v.length/3===D.vt.length/2){const c=G.newInstance({numberOfComponents:2,values:Float32Array.from(D.vt),name:"TextureCoordinates"});n.getPointData().setTCoords(c)}if(r&&D.v.length===D.vn.length){const c=G.newInstance({numberOfComponents:3,values:Float32Array.from(D.vn),name:"Normals"});n.getPointData().setNormals(c)}const a=[],s=D.f[0],i=s.length;let o=0;for(;o<i;){const c=s[o];a.push(c);for(let u=0;u<c;u++){const[g]=s[o+u+1];a.push(g)}o+=c+1}n.getPolys().setData(Uint32Array.from(a)),t.output[0]=n}}function Wn(t,e){const r=[],n=t.getPointData().getArrayByName("Duplicates");if(n==null)return r;const a=n.getData(),s=Math.min(e,a[e]);r.push(s);let i=a[s];if(i!==s)for(;i<a.length&&a[i]===s;)r.push(i++);return r}const $n={getPointDuplicateIds:Wn};function Hn(t,e){e.classHierarchy.push("vtkOBJReader"),e.dataAccessHelper||(e.dataAccessHelper=rt.get("http"));function r(n){let a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return e.dataAccessHelper.fetchText(t,n,a)}t.setUrl=function(n){let a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(n.indexOf(".obj")===-1&&!a.fullpath)e.baseURL=n,e.url=`${n}/index.obj`;else{e.url=n;const s=n.split("/");s.pop(),e.baseURL=s.join("/")}return t.loadData(a)},t.loadData=function(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return r(e.url,n).then(a=>t.isDeleted()?!1:t.parseAsText(a))},t.parseAsText=n=>(n&&(n!==e.parseData&&t.modified(),e.parseData=n,e.numberOfOutputs=0,_n(e.splitMode),n.split(`
`).forEach(In),zn(e)),!0),t.requestData=(n,a)=>{t.parseAsText(e.parseData)},t.isBusy=()=>!!e.requestCount,t.getNumberOfOutputPorts=()=>e.numberOfOutputs}const Kn={numberOfOutputs:1,requestCount:0,splitMode:null,trackDuplicates:!1};function Tr(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,Kn,r),C.obj(t,e),C.get(t,e,["url","baseURL"]),C.setGet(t,e,["dataAccessHelper","splitMode","trackDuplicates"]),C.algo(t,e,0,1),C.event(t,e,"busy"),Hn(t,e)}const jn=C.newInstance(Tr,"vtkOBJReader");var Yn={newInstance:jn,extend:Tr,...$n};function qn(t,e){e.classHierarchy.push("vtkPolyDataNormals"),t.vtkPolyDataNormalsExecute=(r,n,a)=>{if(!a)return null;const s=new Float32Array(a.length),i=new Float32Array(3*r);let o=0,c=0;const u=n.length,g=[0,0,0],f=[0,0,0];for(let p=0;p<u;p+=c+1)if(c=n[p],!(c<3)){for(let l=1;l<=3;++l)g[l-1]=3*n[p+l];if(tn.computeNormal(a.slice(g[0],g[0]+3),a.slice(g[1],g[1]+3),a.slice(g[2],g[2]+3),f),i[o++]=f[0],i[o++]=f[1],i[o++]=f[2],e.computePointNormals)for(let l=1;l<=c;++l){let h=3*n[p+l];s[h]+=f[0],s[++h]+=f[1],s[++h]+=f[2]}}if(e.computePointNormals){const p=[0,0,0];for(let l=0;l<a.length;)p[0]=s[l],p[1]=s[l+1],p[2]=s[l+2],rn.normalize(p),s[l++]=p[0],s[l++]=p[1],s[l++]=p[2]}return[i,s]},t.requestData=(r,n)=>{if(!t.getNumberOfInputPorts())return;const s=r[0];if(!s)return;const i=n[0]?.initialize()||K.newInstance();i.setPoints(s.getPoints()),i.setVerts(s.getVerts()),i.setLines(s.getLines()),i.setPolys(s.getPolys()),i.setStrips(s.getStrips()),i.getPointData().passData(s.getPointData()),i.getCellData().passData(s.getCellData()),i.getFieldData().passData(s.getFieldData());const[o,c]=t.vtkPolyDataNormalsExecute(s.getNumberOfPolys(),s.getPolys().getData(),s.getPoints().getData());if(e.computePointNormals){const u=G.newInstance({numberOfComponents:3,name:"Normals",values:c});i.getPointData().setNormals(u)}if(e.computeCellNormals){const u=G.newInstance({numberOfComponents:3,name:"Normals",values:o});i.getCellData().setNormals(u)}n[0]=i}}function Xn(t){return{computeCellNormals:!1,computePointNormals:!0,...t}}function Cr(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,Xn(r)),C.obj(t,e),C.algo(t,e,1,1),C.setGet(t,e,["computeCellNormals","computePointNormals"]),qn(t,e)}const Zn=C.newInstance(Cr,"vtkPolyDataNormals");var Jn={newInstance:Zn,extend:Cr};class Qn{constructor(e){this._color=[255,255,255],this._actors=[],this.id=e.id,this._color=e.color??this._color,this._format=e.format;const r=new TextDecoder,n=Jn.newInstance(),a=s=>{const i=fe.newInstance();i.setMapper(s);const o=lr.newInstance();return o.setColor(this._color[0]/255,this._color[1]/255,this._color[2]/255),i.setProperty(o),i};if(this._format===Y.PLY){const s=Z.newInstance(),i=Ln.newInstance();i.parseAsArrayBuffer(e.arrayBuffer),s.setInputConnection(i.getOutputPort()),this._actors.push(a(s))}else if(this._format===Y.STL){const s=Z.newInstance(),i=Gn.newInstance();i.parseAsArrayBuffer(e.arrayBuffer),n.setInputConnection(i.getOutputPort()),s.setInputConnection(n.getOutputPort()),this._actors.push(a(s))}else if(this._format===Y.OBJ){const s=Yn.newInstance({splitMode:e.materialUrl?"usemtl":null});s.parseAsText(r.decode(e.arrayBuffer));const i=s.getNumberOfOutputPorts();for(let o=0;o<i;o++){const c=s.getOutputData(o),u=Z.newInstance();u.setInputData(c),this._actors.push(a(u))}}else if(this._format===Y.VTP){const s=Z.newInstance(),i=wn.newInstance();i.parseAsArrayBuffer(e.arrayBuffer),s.setInputConnection(i.getOutputPort()),this._actors.push(a(s))}this.sizeInBytes=this._getSizeInBytes()}_getSizeInBytes(){let e=0;for(let r=0;r<this._actors.length;r++){const s=this._actors[r].getMapper().getInputData(),i=s.getPoints(),o=s.getPolys(),c=i.getData().length,u=o.getData().length;e+=c*4+u*4}return e}get defaultActor(){return this._actors[0]}get actors(){return this._actors}get color(){return this._color}get format(){return this._format}}class ea extends nn{constructor(e,r){super(e,r),this._dimensionGroupNumber=1,this._loadedDimensionGroups=new Set,this._getImageIdRequests=(s,i)=>this.getImageIdsRequests(s,i),this.getImageLoadRequests=s=>{const i=this.getImageIdsToLoad();return this._getImageIdRequests(i,s)};const{imageIdGroups:n,splittingTag:a}=e;this._splittingTag=a,this._imageIdGroups=n,this.numDimensionGroups=this._imageIdGroups.length}_getImageIdsToLoad(){const e=this._imageIdGroups,r=this._dimensionGroupNumber-1,n=[...e[r]];let a=r-1,s=r+1;for(;a>=0||s<e.length;)a>=0&&n.push(...e[a--]),s<e.length&&n.push(...e[s++]);return n}getImageIdsToLoad(){return this._getImageIdsToLoad()}get dimensionGroupNumber(){return this._dimensionGroupNumber}set dimensionGroupNumber(e){this._dimensionGroupNumber!==e&&(this._dimensionGroupNumber=e,this.voxelManager.setDimensionGroupNumber(e),this.invalidateVolume(!0),ce(xe,ue.DYNAMIC_VOLUME_DIMENSION_GROUP_CHANGED,{volumeId:this.volumeId,dimensionGroupNumber:e,numDimensionGroups:this.numDimensionGroups,imageIdGroupIndex:e-1,numImageIdGroups:this.numDimensionGroups,splittingTag:this.splittingTag}))}scroll(e){const r=this._dimensionGroupNumber+e;r<1?this.dimensionGroupNumber=this.numDimensionGroups:r>this.numDimensionGroups?this.dimensionGroupNumber=1:this.dimensionGroupNumber=r}getCurrentDimensionGroupImageIds(){return this._imageIdGroups[this._dimensionGroupNumber-1]}flatImageIdIndexToDimensionGroupNumber(e){return Math.floor(e/this._imageIdGroups[0].length)+1}flatImageIdIndexToImageIdIndex(e){return e%this._imageIdGroups[0].length}get splittingTag(){return this._splittingTag}isDimensionGroupLoaded(e){return this._loadedDimensionGroups.has(e)}markDimensionGroupAsLoaded(e){this._loadedDimensionGroups.add(e),ce(xe,ue.DYNAMIC_VOLUME_DIMENSION_GROUP_LOADED,{volumeId:this.volumeId,dimensionGroupNumber:e})}checkDimensionGroupCompletion(e){const r=this.flatImageIdIndexToDimensionGroupNumber(e);this._imageIdGroups[r-1].every(s=>{const i=this.getImageIdIndex(s);return this.cachedFrames[i]===an.FULL_RESOLUTION})&&!this.isDimensionGroupLoaded(r)&&this.markDimensionGroupAsLoaded(r)}}function $e(t,e){return t==null||e==null?NaN:t<e?-1:t>e?1:t>=e?0:NaN}function ta(t,e){return t==null||e==null?NaN:e<t?-1:e>t?1:e>=t?0:NaN}function Sr(t){let e,r,n;t.length!==2?(e=$e,r=(o,c)=>$e(t(o),c),n=(o,c)=>t(o)-c):(e=t===$e||t===ta?t:ra,r=t,n=t);function a(o,c,u=0,g=o.length){if(u<g){if(e(c,c)!==0)return g;do{const f=u+g>>>1;r(o[f],c)<0?u=f+1:g=f}while(u<g)}return u}function s(o,c,u=0,g=o.length){if(u<g){if(e(c,c)!==0)return g;do{const f=u+g>>>1;r(o[f],c)<=0?u=f+1:g=f}while(u<g)}return u}function i(o,c,u=0,g=o.length){const f=a(o,c,u,g-1);return f>u&&n(o[f-1],c)>-n(o[f],c)?f-1:f}return{left:a,center:i,right:s}}function ra(){return 0}function na(t){return t===null?NaN:+t}const aa=Sr($e),sa=aa.right;Sr(na).center;const ia=Math.sqrt(50),oa=Math.sqrt(10),ca=Math.sqrt(2);function Ye(t,e,r){const n=(e-t)/Math.max(0,r),a=Math.floor(Math.log10(n)),s=n/Math.pow(10,a),i=s>=ia?10:s>=oa?5:s>=ca?2:1;let o,c,u;return a<0?(u=Math.pow(10,-a)/i,o=Math.round(t*u),c=Math.round(e*u),o/u<t&&++o,c/u>e&&--c,u=-u):(u=Math.pow(10,a)*i,o=Math.round(t/u),c=Math.round(e/u),o*u<t&&++o,c*u>e&&--c),c<o&&.5<=r&&r<2?Ye(t,e,r*2):[o,c,u]}function ua(t,e,r){if(e=+e,t=+t,r=+r,!(r>0))return[];if(t===e)return[t];const n=e<t,[a,s,i]=n?Ye(e,t,r):Ye(t,e,r);if(!(s>=a))return[];const o=s-a+1,c=new Array(o);if(n)if(i<0)for(let u=0;u<o;++u)c[u]=(s-u)/-i;else for(let u=0;u<o;++u)c[u]=(s-u)*i;else if(i<0)for(let u=0;u<o;++u)c[u]=(a+u)/-i;else for(let u=0;u<o;++u)c[u]=(a+u)*i;return c}function xt(t,e,r){return e=+e,t=+t,r=+r,Ye(t,e,r)[2]}function fa(t,e,r){e=+e,t=+t,r=+r;const n=e<t,a=n?xt(e,t,r):xt(t,e,r);return(n?-1:1)*(a<0?1/-a:a)}function ga(t,e){switch(arguments.length){case 0:break;case 1:this.range(t);break;default:this.range(e).domain(t);break}return this}function Dt(t,e,r){t.prototype=e.prototype=r,r.constructor=t}function br(t,e){var r=Object.create(t.prototype);for(var n in e)r[n]=e[n];return r}function Be(){}var Ve=.7,qe=1/Ve,de="\\s*([+-]?\\d+)\\s*",Me="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",q="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",la=/^#([0-9a-f]{3,8})$/,pa=new RegExp(`^rgb\\(${de},${de},${de}\\)$`),ha=new RegExp(`^rgb\\(${q},${q},${q}\\)$`),da=new RegExp(`^rgba\\(${de},${de},${de},${Me}\\)$`),xa=new RegExp(`^rgba\\(${q},${q},${q},${Me}\\)$`),ya=new RegExp(`^hsl\\(${Me},${q},${q}\\)$`),ma=new RegExp(`^hsla\\(${Me},${q},${q},${Me}\\)$`),Ft={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};Dt(Be,ke,{copy(t){return Object.assign(new this.constructor,this,t)},displayable(){return this.rgb().displayable()},hex:It,formatHex:It,formatHex8:va,formatHsl:Ta,formatRgb:zt,toString:zt});function It(){return this.rgb().formatHex()}function va(){return this.rgb().formatHex8()}function Ta(){return wr(this).formatHsl()}function zt(){return this.rgb().formatRgb()}function ke(t){var e,r;return t=(t+"").trim().toLowerCase(),(e=la.exec(t))?(r=e[1].length,e=parseInt(e[1],16),r===6?Wt(e):r===3?new I(e>>8&15|e>>4&240,e>>4&15|e&240,(e&15)<<4|e&15,1):r===8?Pe(e>>24&255,e>>16&255,e>>8&255,(e&255)/255):r===4?Pe(e>>12&15|e>>8&240,e>>8&15|e>>4&240,e>>4&15|e&240,((e&15)<<4|e&15)/255):null):(e=pa.exec(t))?new I(e[1],e[2],e[3],1):(e=ha.exec(t))?new I(e[1]*255/100,e[2]*255/100,e[3]*255/100,1):(e=da.exec(t))?Pe(e[1],e[2],e[3],e[4]):(e=xa.exec(t))?Pe(e[1]*255/100,e[2]*255/100,e[3]*255/100,e[4]):(e=ya.exec(t))?Kt(e[1],e[2]/100,e[3]/100,1):(e=ma.exec(t))?Kt(e[1],e[2]/100,e[3]/100,e[4]):Ft.hasOwnProperty(t)?Wt(Ft[t]):t==="transparent"?new I(NaN,NaN,NaN,0):null}function Wt(t){return new I(t>>16&255,t>>8&255,t&255,1)}function Pe(t,e,r,n){return n<=0&&(t=e=r=NaN),new I(t,e,r,n)}function Ca(t){return t instanceof Be||(t=ke(t)),t?(t=t.rgb(),new I(t.r,t.g,t.b,t.opacity)):new I}function yt(t,e,r,n){return arguments.length===1?Ca(t):new I(t,e,r,n??1)}function I(t,e,r,n){this.r=+t,this.g=+e,this.b=+r,this.opacity=+n}Dt(I,yt,br(Be,{brighter(t){return t=t==null?qe:Math.pow(qe,t),new I(this.r*t,this.g*t,this.b*t,this.opacity)},darker(t){return t=t==null?Ve:Math.pow(Ve,t),new I(this.r*t,this.g*t,this.b*t,this.opacity)},rgb(){return this},clamp(){return new I(oe(this.r),oe(this.g),oe(this.b),Xe(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:$t,formatHex:$t,formatHex8:Sa,formatRgb:Ht,toString:Ht}));function $t(){return`#${se(this.r)}${se(this.g)}${se(this.b)}`}function Sa(){return`#${se(this.r)}${se(this.g)}${se(this.b)}${se((isNaN(this.opacity)?1:this.opacity)*255)}`}function Ht(){const t=Xe(this.opacity);return`${t===1?"rgb(":"rgba("}${oe(this.r)}, ${oe(this.g)}, ${oe(this.b)}${t===1?")":`, ${t})`}`}function Xe(t){return isNaN(t)?1:Math.max(0,Math.min(1,t))}function oe(t){return Math.max(0,Math.min(255,Math.round(t)||0))}function se(t){return t=oe(t),(t<16?"0":"")+t.toString(16)}function Kt(t,e,r,n){return n<=0?t=e=r=NaN:r<=0||r>=1?t=e=NaN:e<=0&&(t=NaN),new H(t,e,r,n)}function wr(t){if(t instanceof H)return new H(t.h,t.s,t.l,t.opacity);if(t instanceof Be||(t=ke(t)),!t)return new H;if(t instanceof H)return t;t=t.rgb();var e=t.r/255,r=t.g/255,n=t.b/255,a=Math.min(e,r,n),s=Math.max(e,r,n),i=NaN,o=s-a,c=(s+a)/2;return o?(e===s?i=(r-n)/o+(r<n)*6:r===s?i=(n-e)/o+2:i=(e-r)/o+4,o/=c<.5?s+a:2-s-a,i*=60):o=c>0&&c<1?0:i,new H(i,o,c,t.opacity)}function ba(t,e,r,n){return arguments.length===1?wr(t):new H(t,e,r,n??1)}function H(t,e,r,n){this.h=+t,this.s=+e,this.l=+r,this.opacity=+n}Dt(H,ba,br(Be,{brighter(t){return t=t==null?qe:Math.pow(qe,t),new H(this.h,this.s,this.l*t,this.opacity)},darker(t){return t=t==null?Ve:Math.pow(Ve,t),new H(this.h,this.s,this.l*t,this.opacity)},rgb(){var t=this.h%360+(this.h<0)*360,e=isNaN(t)||isNaN(this.s)?0:this.s,r=this.l,n=r+(r<.5?r:1-r)*e,a=2*r-n;return new I(ft(t>=240?t-240:t+120,a,n),ft(t,a,n),ft(t<120?t+240:t-120,a,n),this.opacity)},clamp(){return new H(jt(this.h),Ae(this.s),Ae(this.l),Xe(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const t=Xe(this.opacity);return`${t===1?"hsl(":"hsla("}${jt(this.h)}, ${Ae(this.s)*100}%, ${Ae(this.l)*100}%${t===1?")":`, ${t})`}`}}));function jt(t){return t=(t||0)%360,t<0?t+360:t}function Ae(t){return Math.max(0,Math.min(1,t||0))}function ft(t,e,r){return(t<60?e+(r-e)*t/60:t<180?r:t<240?e+(r-e)*(240-t)/60:e)*255}const Ot=t=>()=>t;function wa(t,e){return function(r){return t+r*e}}function Da(t,e,r){return t=Math.pow(t,r),e=Math.pow(e,r)-t,r=1/r,function(n){return Math.pow(t+n*e,r)}}function Oa(t){return(t=+t)==1?Dr:function(e,r){return r-e?Da(e,r,t):Ot(isNaN(e)?r:e)}}function Dr(t,e){var r=e-t;return r?wa(t,r):Ot(isNaN(t)?e:t)}const Yt=(function t(e){var r=Oa(e);function n(a,s){var i=r((a=yt(a)).r,(s=yt(s)).r),o=r(a.g,s.g),c=r(a.b,s.b),u=Dr(a.opacity,s.opacity);return function(g){return a.r=i(g),a.g=o(g),a.b=c(g),a.opacity=u(g),a+""}}return n.gamma=t,n})(1);function Va(t,e){e||(e=[]);var r=t?Math.min(e.length,t.length):0,n=e.slice(),a;return function(s){for(a=0;a<r;++a)n[a]=t[a]*(1-s)+e[a]*s;return n}}function Ma(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)}function ka(t,e){var r=e?e.length:0,n=t?Math.min(r,t.length):0,a=new Array(n),s=new Array(r),i;for(i=0;i<n;++i)a[i]=Vt(t[i],e[i]);for(;i<r;++i)s[i]=e[i];return function(o){for(i=0;i<n;++i)s[i]=a[i](o);return s}}function Ba(t,e){var r=new Date;return t=+t,e=+e,function(n){return r.setTime(t*(1-n)+e*n),r}}function Ze(t,e){return t=+t,e=+e,function(r){return t*(1-r)+e*r}}function Ra(t,e){var r={},n={},a;(t===null||typeof t!="object")&&(t={}),(e===null||typeof e!="object")&&(e={});for(a in e)a in t?r[a]=Vt(t[a],e[a]):n[a]=e[a];return function(s){for(a in r)n[a]=r[a](s);return n}}var mt=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,gt=new RegExp(mt.source,"g");function La(t){return function(){return t}}function Ua(t){return function(e){return t(e)+""}}function Na(t,e){var r=mt.lastIndex=gt.lastIndex=0,n,a,s,i=-1,o=[],c=[];for(t=t+"",e=e+"";(n=mt.exec(t))&&(a=gt.exec(e));)(s=a.index)>r&&(s=e.slice(r,s),o[i]?o[i]+=s:o[++i]=s),(n=n[0])===(a=a[0])?o[i]?o[i]+=a:o[++i]=a:(o[++i]=null,c.push({i,x:Ze(n,a)})),r=gt.lastIndex;return r<e.length&&(s=e.slice(r),o[i]?o[i]+=s:o[++i]=s),o.length<2?c[0]?Ua(c[0].x):La(e):(e=c.length,function(u){for(var g=0,f;g<e;++g)o[(f=c[g]).i]=f.x(u);return o.join("")})}function Vt(t,e){var r=typeof e,n;return e==null||r==="boolean"?Ot(e):(r==="number"?Ze:r==="string"?(n=ke(e))?(e=n,Yt):Na:e instanceof ke?Yt:e instanceof Date?Ba:Ma(e)?Va:Array.isArray(e)?ka:typeof e.valueOf!="function"&&typeof e.toString!="function"||isNaN(e)?Ra:Ze)(t,e)}function Pa(t,e){return t=+t,e=+e,function(r){return Math.round(t*(1-r)+e*r)}}function Aa(t){return function(){return t}}function Ea(t){return+t}var qt=[0,1];function pe(t){return t}function vt(t,e){return(e-=t=+t)?function(r){return(r-t)/e}:Aa(isNaN(e)?NaN:.5)}function Ga(t,e){var r;return t>e&&(r=t,t=e,e=r),function(n){return Math.max(t,Math.min(e,n))}}function _a(t,e,r){var n=t[0],a=t[1],s=e[0],i=e[1];return a<n?(n=vt(a,n),s=r(i,s)):(n=vt(n,a),s=r(s,i)),function(o){return s(n(o))}}function Fa(t,e,r){var n=Math.min(t.length,e.length)-1,a=new Array(n),s=new Array(n),i=-1;for(t[n]<t[0]&&(t=t.slice().reverse(),e=e.slice().reverse());++i<n;)a[i]=vt(t[i],t[i+1]),s[i]=r(e[i],e[i+1]);return function(o){var c=sa(t,o,1,n)-1;return s[c](a[c](o))}}function Ia(t,e){return e.domain(t.domain()).range(t.range()).interpolate(t.interpolate()).clamp(t.clamp()).unknown(t.unknown())}function za(){var t=qt,e=qt,r=Vt,n,a,s,i=pe,o,c,u;function g(){var p=Math.min(t.length,e.length);return i!==pe&&(i=Ga(t[0],t[p-1])),o=p>2?Fa:_a,c=u=null,f}function f(p){return p==null||isNaN(p=+p)?s:(c||(c=o(t.map(n),e,r)))(n(i(p)))}return f.invert=function(p){return i(a((u||(u=o(e,t.map(n),Ze)))(p)))},f.domain=function(p){return arguments.length?(t=Array.from(p,Ea),g()):t.slice()},f.range=function(p){return arguments.length?(e=Array.from(p),g()):e.slice()},f.rangeRound=function(p){return e=Array.from(p),r=Pa,g()},f.clamp=function(p){return arguments.length?(i=p?!0:pe,g()):i!==pe},f.interpolate=function(p){return arguments.length?(r=p,g()):r},f.unknown=function(p){return arguments.length?(s=p,f):s},function(p,l){return n=p,a=l,g()}}function Wa(){return za()(pe,pe)}function $a(t){return Math.abs(t=Math.round(t))>=1e21?t.toLocaleString("en").replace(/,/g,""):t.toString(10)}function Je(t,e){if((r=(t=e?t.toExponential(e-1):t.toExponential()).indexOf("e"))<0)return null;var r,n=t.slice(0,r);return[n.length>1?n[0]+n.slice(2):n,+t.slice(r+1)]}function me(t){return t=Je(Math.abs(t)),t?t[1]:NaN}function Ha(t,e){return function(r,n){for(var a=r.length,s=[],i=0,o=t[0],c=0;a>0&&o>0&&(c+o+1>n&&(o=Math.max(1,n-c)),s.push(r.substring(a-=o,a+o)),!((c+=o+1)>n));)o=t[i=(i+1)%t.length];return s.reverse().join(e)}}function Ka(t){return function(e){return e.replace(/[0-9]/g,function(r){return t[+r]})}}var ja=/^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i;function Qe(t){if(!(e=ja.exec(t)))throw new Error("invalid format: "+t);var e;return new Mt({fill:e[1],align:e[2],sign:e[3],symbol:e[4],zero:e[5],width:e[6],comma:e[7],precision:e[8]&&e[8].slice(1),trim:e[9],type:e[10]})}Qe.prototype=Mt.prototype;function Mt(t){this.fill=t.fill===void 0?" ":t.fill+"",this.align=t.align===void 0?">":t.align+"",this.sign=t.sign===void 0?"-":t.sign+"",this.symbol=t.symbol===void 0?"":t.symbol+"",this.zero=!!t.zero,this.width=t.width===void 0?void 0:+t.width,this.comma=!!t.comma,this.precision=t.precision===void 0?void 0:+t.precision,this.trim=!!t.trim,this.type=t.type===void 0?"":t.type+""}Mt.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(this.width===void 0?"":Math.max(1,this.width|0))+(this.comma?",":"")+(this.precision===void 0?"":"."+Math.max(0,this.precision|0))+(this.trim?"~":"")+this.type};function Ya(t){e:for(var e=t.length,r=1,n=-1,a;r<e;++r)switch(t[r]){case".":n=a=r;break;case"0":n===0&&(n=r),a=r;break;default:if(!+t[r])break e;n>0&&(n=0);break}return n>0?t.slice(0,n)+t.slice(a+1):t}var Or;function qa(t,e){var r=Je(t,e);if(!r)return t+"";var n=r[0],a=r[1],s=a-(Or=Math.max(-8,Math.min(8,Math.floor(a/3)))*3)+1,i=n.length;return s===i?n:s>i?n+new Array(s-i+1).join("0"):s>0?n.slice(0,s)+"."+n.slice(s):"0."+new Array(1-s).join("0")+Je(t,Math.max(0,e+s-1))[0]}function Xt(t,e){var r=Je(t,e);if(!r)return t+"";var n=r[0],a=r[1];return a<0?"0."+new Array(-a).join("0")+n:n.length>a+1?n.slice(0,a+1)+"."+n.slice(a+1):n+new Array(a-n.length+2).join("0")}const Zt={"%":(t,e)=>(t*100).toFixed(e),b:t=>Math.round(t).toString(2),c:t=>t+"",d:$a,e:(t,e)=>t.toExponential(e),f:(t,e)=>t.toFixed(e),g:(t,e)=>t.toPrecision(e),o:t=>Math.round(t).toString(8),p:(t,e)=>Xt(t*100,e),r:Xt,s:qa,X:t=>Math.round(t).toString(16).toUpperCase(),x:t=>Math.round(t).toString(16)};function Jt(t){return t}var Qt=Array.prototype.map,er=["y","z","a","f","p","n","","m","","k","M","G","T","P","E","Z","Y"];function Xa(t){var e=t.grouping===void 0||t.thousands===void 0?Jt:Ha(Qt.call(t.grouping,Number),t.thousands+""),r=t.currency===void 0?"":t.currency[0]+"",n=t.currency===void 0?"":t.currency[1]+"",a=t.decimal===void 0?".":t.decimal+"",s=t.numerals===void 0?Jt:Ka(Qt.call(t.numerals,String)),i=t.percent===void 0?"%":t.percent+"",o=t.minus===void 0?"":t.minus+"",c=t.nan===void 0?"NaN":t.nan+"";function u(f){f=Qe(f);var p=f.fill,l=f.align,h=f.sign,x=f.symbol,d=f.zero,T=f.width,b=f.comma,m=f.precision,v=f.trim,y=f.type;y==="n"?(b=!0,y="g"):Zt[y]||(m===void 0&&(m=12),v=!0,y="g"),(d||p==="0"&&l==="=")&&(d=!0,p="0",l="=");var S=x==="$"?r:x==="#"&&/[boxX]/.test(y)?"0"+y.toLowerCase():"",M=x==="$"?n:/[%p]/.test(y)?i:"",B=Zt[y],N=/[defgprs%]/.test(y);m=m===void 0?6:/[gprs]/.test(y)?Math.max(1,Math.min(21,m)):Math.max(0,Math.min(20,m));function _(O){var U=S,V=M,A,le,X;if(y==="c")V=B(O)+V,O="";else{O=+O;var j=O<0||1/O<0;if(O=isNaN(O)?c:B(Math.abs(O),m),v&&(O=Ya(O)),j&&+O==0&&h!=="+"&&(j=!1),U=(j?h==="("?h:o:h==="-"||h==="("?"":h)+U,V=(y==="s"?er[8+Or/3]:"")+V+(j&&h==="("?")":""),N){for(A=-1,le=O.length;++A<le;)if(X=O.charCodeAt(A),48>X||X>57){V=(X===46?a+O.slice(A+1):O.slice(A))+V,O=O.slice(0,A);break}}}b&&!d&&(O=e(O,1/0));var ee=U.length+O.length+V.length,z=ee<T?new Array(T-ee+1).join(p):"";switch(b&&d&&(O=e(z+O,z.length?T-V.length:1/0),z=""),l){case"<":O=U+O+V+z;break;case"=":O=U+z+O+V;break;case"^":O=z.slice(0,ee=z.length>>1)+U+O+V+z.slice(ee);break;default:O=z+U+O+V;break}return s(O)}return _.toString=function(){return f+""},_}function g(f,p){var l=u((f=Qe(f),f.type="f",f)),h=Math.max(-8,Math.min(8,Math.floor(me(p)/3)))*3,x=Math.pow(10,-h),d=er[8+h/3];return function(T){return l(x*T)+d}}return{format:u,formatPrefix:g}}var Ee,Vr,Mr;Za({thousands:",",grouping:[3],currency:["$",""]});function Za(t){return Ee=Xa(t),Vr=Ee.format,Mr=Ee.formatPrefix,Ee}function Ja(t){return Math.max(0,-me(Math.abs(t)))}function Qa(t,e){return Math.max(0,Math.max(-8,Math.min(8,Math.floor(me(e)/3)))*3-me(Math.abs(t)))}function es(t,e){return t=Math.abs(t),e=Math.abs(e)-t,Math.max(0,me(e)-me(t))+1}function ts(t,e,r,n){var a=fa(t,e,r),s;switch(n=Qe(n??",f"),n.type){case"s":{var i=Math.max(Math.abs(t),Math.abs(e));return n.precision==null&&!isNaN(s=Qa(a,i))&&(n.precision=s),Mr(n,i)}case"":case"e":case"g":case"p":case"r":{n.precision==null&&!isNaN(s=es(a,Math.max(Math.abs(t),Math.abs(e))))&&(n.precision=s-(n.type==="e"));break}case"f":case"%":{n.precision==null&&!isNaN(s=Ja(a))&&(n.precision=s-(n.type==="%")*2);break}}return Vr(n)}function rs(t){var e=t.domain;return t.ticks=function(r){var n=e();return ua(n[0],n[n.length-1],r??10)},t.tickFormat=function(r,n){var a=e();return ts(a[0],a[a.length-1],r??10,n)},t.nice=function(r){r==null&&(r=10);var n=e(),a=0,s=n.length-1,i=n[a],o=n[s],c,u,g=10;for(o<i&&(u=i,i=o,o=u,u=a,a=s,s=u);g-- >0;){if(u=xt(i,o,r),u===c)return n[a]=i,n[s]=o,e(n);if(u>0)i=Math.floor(i/u)*u,o=Math.ceil(o/u)*u;else if(u<0)i=Math.ceil(i*u)/u,o=Math.floor(o*u)/u;else break;c=u}return t},t}function kt(){var t=Wa();return t.copy=function(){return Ia(t,kt())},ga.apply(t,arguments),rs(t)}const ns=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]],tr=[[8,7,11,3],[9,1,10,5],[4,9,0,8],[2,11,6,10],[0,3,2,1],[4,5,6,7]],Ge=[[0,1],[1,3],[2,3],[0,2],[4,5],[5,7],[6,7],[4,6],[0,4],[1,5],[3,7],[2,6]],rr=[0,1,0,1,0,1,0,1,2,2,2,2],R=[[1,2],[1,2],[0,2],[0,2],[0,1],[0,1]],w=new Float64Array(3),_e=new Float64Array(3),k=new Float64Array(3),ae=new Float64Array(3),re=new Float64Array(3),Fe=new Float64Array(3),lt=new Float64Array(16);function pt(t,e){t.strokeStyle=e.strokeColor,t.lineWidth=e.strokeSize,t.fillStyle=e.fontColor,t.font=`${e.fontStyle} ${e.fontSize}px ${e.fontFamily}`}function kr(t){const e=[],r=[];for(let n=0;n<3;n++){const a=kt().domain([t[n*2],t[n*2+1]]);e[n]=a.ticks(5);const s=a.tickFormat(5);r[n]=e[n].map(s)}return{ticks:e,tickStrings:r}}function as(t,e){e.classHierarchy.push("vtkCubeAxesActorHelper"),t.setRenderable=r=>{e.renderable!==r&&(e.renderable=r,e.tmActor.addTexture(e.renderable.getTmTexture()),e.tmActor.setProperty(r.getProperty()),e.tmActor.setParentProp(r),t.modified())},t.createPolyDataForOneLabel=(r,n,a,s,i,o,c)=>{const u=e.renderable.get_tmAtlas().get(r);if(!u)return;const g=e.renderable.getTextPolyData().getPoints().getData(),f=e.lastSize;w[0]=g[n*3],w[1]=g[n*3+1],w[2]=g[n*3+2],ne(k,w,a),k[0]+=.1,ne(_e,k,s),Se(re,_e,w),k[0]-=.1,k[1]+=.1,ne(_e,k,s),Se(Fe,_e,w);for(let h=0;h<3;h++)re[h]/=.5*.1*f[0],Fe[h]/=.5*.1*f[1];let p=c.ptIdx,l=c.cellIdx;w[0]=g[n*3],w[1]=g[n*3+1],w[2]=g[n*3+2],i[0]<-.5?te(k,re,i[0]*o-u.width):i[0]>.5?te(k,re,i[0]*o):te(k,re,i[0]*o-u.width/2),Ue(w,w,k),te(k,Fe,i[1]*o-u.height/2),Ue(w,w,k),c.points[p*3]=w[0],c.points[p*3+1]=w[1],c.points[p*3+2]=w[2],c.tcoords[p*2]=u.tcoords[0],c.tcoords[p*2+1]=u.tcoords[1],p++,te(k,re,u.width),Ue(w,w,k),c.points[p*3]=w[0],c.points[p*3+1]=w[1],c.points[p*3+2]=w[2],c.tcoords[p*2]=u.tcoords[2],c.tcoords[p*2+1]=u.tcoords[3],p++,te(k,Fe,u.height),Ue(w,w,k),c.points[p*3]=w[0],c.points[p*3+1]=w[1],c.points[p*3+2]=w[2],c.tcoords[p*2]=u.tcoords[4],c.tcoords[p*2+1]=u.tcoords[5],p++,te(k,re,u.width),Se(w,w,k),c.points[p*3]=w[0],c.points[p*3+1]=w[1],c.points[p*3+2]=w[2],c.tcoords[p*2]=u.tcoords[6],c.tcoords[p*2+1]=u.tcoords[7],p++,c.polys[l*4]=3,c.polys[l*4+1]=p-4,c.polys[l*4+2]=p-3,c.polys[l*4+3]=p-2,l++,c.polys[l*4]=3,c.polys[l*4+1]=p-4,c.polys[l*4+2]=p-2,c.polys[l*4+3]=p-1,c.ptIdx+=4,c.cellIdx+=2},t.updateTexturePolyData=()=>{const r=e.camera.getCompositeProjectionMatrix(e.lastAspectRatio,-1,1);De(r,r);const n=e.renderable.getTextValues().length,a=n*4,s=n*2,i=new Float64Array(a*3),o=new Uint16Array(s*4),c=new Float32Array(a*2);pr(lt,r);const u={ptIdx:0,cellIdx:0,polys:o,points:i,tcoords:c};let g=0,f=0,p=0;const l=e.renderable.getTextPolyData().getPoints().getData(),h=e.renderable.getTextValues();for(;g<l.length/3;){w[0]=l[g*3],w[1]=l[g*3+1],w[2]=l[g*3+2],ne(k,w,r),w[0]=l[g*3+3],w[1]=l[g*3+4],w[2]=l[g*3+5],ne(ae,w,r),Se(k,k,ae);const d=[k[0],k[1]];sn(d),t.createPolyDataForOneLabel(h[f],g,r,lt,d,e.renderable.getAxisTitlePixelOffset(),u),g+=2,f++;for(let T=0;T<e.renderable.getTickCounts()[p];T++)t.createPolyDataForOneLabel(h[f],g,r,lt,d,e.renderable.getTickLabelPixelOffset(),u),g++,f++;p++}const x=G.newInstance({numberOfComponents:2,values:c,name:"TextureCoordinates"});e.tmPolyData.getPointData().setTCoords(x),e.tmPolyData.getPoints().setData(i,3),e.tmPolyData.getPoints().modified(),e.tmPolyData.getPolys().setData(o,1),e.tmPolyData.getPolys().modified(),e.tmPolyData.modified()},t.updateAPISpecificData=(r,n,a)=>{(e.lastSize[0]!==r[0]||e.lastSize[1]!==r[1])&&(e.lastSize[0]=r[0],e.lastSize[1]=r[1],e.lastAspectRatio=r[0]/r[1],e.forceUpdate=!0),e.camera=n,t.updateTexturePolyData()}}const ss=C.newInstance(function(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{renderable:null};Object.assign(e,{},r),C.obj(t,e),e.tmPolyData=K.newInstance(),e.tmMapper=Z.newInstance(),e.tmMapper.setInputData(e.tmPolyData),e.tmActor=fe.newInstance({parentProp:t}),e.tmActor.setMapper(e.tmMapper),C.setGet(t,e,["renderable"]),C.get(t,e,["lastSize","lastAspectRatio","axisTextStyle","tickTextStyle","tmActor","ticks"]),e.forceUpdate=!1,e.lastRedrawTime={},C.obj(e.lastRedrawTime,{mtime:0}),e.lastRebuildTime={},C.obj(e.lastRebuildTime,{mtime:0}),e.lastSize=[-1,-1],e.lastTickBounds=[],as(t,e)},"vtkCubeAxesActorHelper");function is(t,e){e.classHierarchy.push("vtkCubeAxesActor"),t.setCamera=n=>{e.camera!==n&&(e.cameraModifiedSub&&(e.cameraModifiedSub.unsubscribe(),e.cameraModifiedSub=null),e.camera=n,n&&(e.cameraModifiedSub=n.onModified(t.update)),t.update(),t.modified())},t.computeFacesToDraw=()=>{const n=e.camera.getViewMatrix();De(n,n);let a=!1;const s=We.getDiagonalLength(e.dataBounds),i=Math.sin(e.faceVisibilityAngle*Math.PI/180);for(let o=0;o<6;o++){let c=!1;const u=Math.floor(o/2),g=(u+1)%3,f=(u+2)%3;e.dataBounds[g*2]!==e.dataBounds[g*2+1]&&e.dataBounds[f*2]!==e.dataBounds[f*2+1]&&(w[u]=e.dataBounds[o]-.1*s*ns[o][u],w[g]=.5*(e.dataBounds[g*2]+e.dataBounds[g*2+1]),w[f]=.5*(e.dataBounds[f*2]+e.dataBounds[f*2+1]),ne(k,w,n),w[u]=e.dataBounds[o],ne(ae,w,n),Se(k,ae,k),Lt(k,k),c=k[2]>i,e.camera.getParallelProjection()||(Lt(ae,ae),c=on(ae,k)>i)),c!==e.lastFacesToDraw[o]&&(e.lastFacesToDraw[o]=c,a=!0)}return a},t.updatePolyData=(n,a,s)=>{let i=0,o=0;i+=8;let c=0;for(let l=0;l<12;l++)a[l]>0&&c++;if(o+=c,e.gridLines)for(let l=0;l<6;l++)n[l]&&(i+=s[R[l][0]].length*2+s[R[l][1]].length*2,o+=s[R[l][0]].length+s[R[l][1]].length);const u=new Float64Array(i*3),g=new Uint32Array(o*3);let f=0,p=0;for(let l=0;l<2;l++)for(let h=0;h<2;h++)for(let x=0;x<2;x++)u[f*3]=e.dataBounds[x],u[f*3+1]=e.dataBounds[2+h],u[f*3+2]=e.dataBounds[4+l],f++;for(let l=0;l<12;l++)a[l]>0&&(g[p*3]=2,g[p*3+1]=Ge[l][0],g[p*3+2]=Ge[l][1],p++);if(e.gridLines){for(let l=0;l<6;l++)if(n[l]){const h=Math.floor(l/2);let x=s[R[l][0]];for(let d=0;d<x.length;d++)u[f*3+h]=e.dataBounds[l],u[f*3+R[l][0]]=x[d],u[f*3+R[l][1]]=e.dataBounds[R[l][1]*2],f++,u[f*3+h]=e.dataBounds[l],u[f*3+R[l][0]]=x[d],u[f*3+R[l][1]]=e.dataBounds[R[l][1]*2+1],f++,g[p*3]=2,g[p*3+1]=f-2,g[p*3+2]=f-1,p++;x=s[R[l][1]];for(let d=0;d<x.length;d++)u[f*3+h]=e.dataBounds[l],u[f*3+R[l][1]]=x[d],u[f*3+R[l][0]]=e.dataBounds[R[l][0]*2],f++,u[f*3+h]=e.dataBounds[l],u[f*3+R[l][1]]=x[d],u[f*3+R[l][0]]=e.dataBounds[R[l][0]*2+1],f++,g[p*3]=2,g[p*3+1]=f-2,g[p*3+2]=f-1,p++}}e.polyData.getPoints().setData(u,3),e.polyData.getPoints().modified(),e.polyData.getLines().setData(g,1),e.polyData.getLines().modified(),e.polyData.modified()},t.updateTextData=(n,a,s,i)=>{let o=0;for(let l=0;l<12;l++)a[l]===1&&(o+=2,o+=s[rr[l]].length);const c=e.polyData.getPoints().getData(),u=new Float64Array(o*3);let g=0,f=0,p=0;for(let l=0;l<6;l++)if(n[l])for(let h=0;h<4;h++){const x=tr[l][h];if(a[x]===1){const d=rr[x],T=Ge[x][0]*3,b=Ge[x][1]*3;u[g*3]=.5*(c[T]+c[b]),u[g*3+1]=.5*(c[T+1]+c[b+1]),u[g*3+2]=.5*(c[T+2]+c[b+2]),g++;const m=Math.floor(l/2);u[g*3+m]=e.dataBounds[l],u[g*3+R[l][0]]=.5*(e.dataBounds[R[l][0]*2]+e.dataBounds[R[l][0]*2+1]),u[g*3+R[l][1]]=.5*(e.dataBounds[R[l][1]*2]+e.dataBounds[R[l][1]*2+1]),g++,e.textValues[f]=e.axisLabels[d],f++;const v=(d+1)%3,y=(d+2)%3,S=s[d],M=i[d];e.tickCounts[p]=S.length;for(let B=0;B<S.length;B++)u[g*3+d]=S[B],u[g*3+v]=c[T+v],u[g*3+y]=c[T+y],g++,e.textValues[f]=M[B],f++;p++}}e.textPolyData.getPoints().setData(u,3),e.textPolyData.modified()},t.update=()=>{if(!e.camera)return;const n=t.computeFacesToDraw(),a=e.lastFacesToDraw;let s=!1;for(let i=0;i<6;i++)e.dataBounds[i]!==e.lastTickBounds[i]&&(s=!0,e.lastTickBounds[i]=e.dataBounds[i]);if(n||s||e.forceUpdate){const i=new Array(12).fill(0);for(let c=0;c<6;c++)if(a[c])for(let u=0;u<4;u++)i[tr[c][u]]++;const o=e.generateTicks(e.dataBounds);t.updatePolyData(a,i,o.ticks),t.updateTextData(a,i,o.ticks,o.tickStrings),(s||e.forceUpdate)&&t.updateTextureAtlas(o.tickStrings)}e.forceUpdate=!1},t.updateTextureAtlas=n=>{e.tmContext.textBaseline="bottom",e.tmContext.textAlign="left",e._tmAtlas.clear();let a=0,s=1;for(let i=0;i<3;i++){if(!e._tmAtlas.has(e.axisLabels[i])){pt(e.tmContext,e.axisTextStyle);const o=e.tmContext.measureText(e.axisLabels[i]),c={height:o.actualBoundingBoxAscent+2,startingHeight:s,width:o.width+2,textStyle:e.axisTextStyle};e._tmAtlas.set(e.axisLabels[i],c),s+=c.height,a<c.width&&(a=c.width)}pt(e.tmContext,e.tickTextStyle);for(let o=0;o<n[i].length;o++)if(!e._tmAtlas.has(n[i][o])){const c=e.tmContext.measureText(n[i][o]),u={height:c.actualBoundingBoxAscent+2,startingHeight:s,width:c.width+2,textStyle:e.tickTextStyle};e._tmAtlas.set(n[i][o],u),s+=u.height,a<u.width&&(a=u.width)}}a=He(a),s=He(s),e._tmAtlas.forEach(i=>{i.tcoords=[0,(s-i.startingHeight-i.height)/s,i.width/a,(s-i.startingHeight-i.height)/s,i.width/a,(s-i.startingHeight)/s,0,(s-i.startingHeight)/s]}),e.tmCanvas.width=a,e.tmCanvas.height=s,e.tmContext.textBaseline="bottom",e.tmContext.textAlign="left",e.tmContext.clearRect(0,0,a,s),e._tmAtlas.forEach((i,o)=>{pt(e.tmContext,i.textStyle),e.tmContext.fillText(o,1,i.startingHeight+i.height-1)}),e.tmTexture.setCanvas(e.tmCanvas),e.tmTexture.modified()},t.onModified(()=>{e.forceUpdate=!0,t.update()}),t.setTickTextStyle=n=>{e.tickTextStyle={...e.tickTextStyle,...n},t.modified()},t.setAxisTextStyle=n=>{e.axisTextStyle={...e.axisTextStyle,...n},t.modified()},t.get_tmAtlas=()=>e._tmAtlas,t.getBounds=()=>(t.update(),We.setBounds(e.bounds,e.gridActor.getBounds()),We.scaleAboutCenter(e.bounds,e.boundsScaleFactor,e.boundsScaleFactor,e.boundsScaleFactor),e.bounds);const r=C.chain(t.setProperty,e.gridActor.setProperty);t.setProperty=n=>r(n)[0]}function os(t,e,r){return{boundsScaleFactor:1.3,camera:null,dataBounds:[...We.INIT_BOUNDS],faceVisibilityAngle:8,gridLines:!0,axisLabels:null,axisTitlePixelOffset:35,tickLabelPixelOffset:12,generateTicks:kr,...r,axisTextStyle:{fontColor:"white",fontStyle:"normal",fontSize:18,fontFamily:"serif",...r?.axisTextStyle},tickTextStyle:{fontColor:"white",fontStyle:"normal",fontSize:14,fontFamily:"serif",...r?.tickTextStyle}}}function Br(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};fe.extend(t,e,os(t,e,r)),e.lastFacesToDraw=[!1,!1,!1,!1,!1,!1],e.axisLabels=["X-Axis","Y-Axis","Z-Axis"],e.tickCounts=[],e.textValues=[],e.lastTickBounds=[],e.tmCanvas=document.createElement("canvas"),e.tmContext=e.tmCanvas.getContext("2d"),e._tmAtlas=new Map,e.tmTexture=ge.newInstance({resizable:!0}),e.tmTexture.setInterpolate(!1),t.getProperty().setDiffuse(0),t.getProperty().setAmbient(1),e.gridMapper=Z.newInstance(),e.polyData=K.newInstance(),e.gridMapper.setInputData(e.polyData),e.gridActor=fe.newInstance(),e.gridActor.setMapper(e.gridMapper),e.gridActor.setProperty(t.getProperty()),e.gridActor.setParentProp(t),e.textPolyData=K.newInstance(),C.setGet(t,e,["axisTitlePixelOffset","boundsScaleFactor","faceVisibilityAngle","gridLines","tickLabelPixelOffset","generateTicks"]),C.setGetArray(t,e,["dataBounds"],6),C.setGetArray(t,e,["axisLabels"],3),C.get(t,e,["axisTextStyle","tickTextStyle","camera","tmTexture","textValues","textPolyData","tickCounts","gridActor"]),is(t,e)}const cs=C.newInstance(Br,"vtkCubeAxesActor");var Rr={newInstance:cs,extend:Br,newCubeAxesActorHelper:ss,defaultGenerateTicks:kr};function us(t,e){e.classHierarchy.push("vtkOpenGLCubeAxesActor"),t.buildPass=r=>{r&&(e._openGLRenderer=t.getFirstAncestorOfType("vtkOpenGLRenderer"),e._openGLRenderWindow=e._openGLRenderer.getParent(),e.CubeAxesActorHelper.getRenderable()||e.CubeAxesActorHelper.setRenderable(e.renderable),t.prepareNodes(),t.addMissingNode(e.CubeAxesActorHelper.getTmActor()),t.addMissingNode(e.renderable.getGridActor()),t.removeUnusedNodes())},t.opaquePass=(r,n)=>{if(r){const a=e._openGLRenderer?e._openGLRenderer.getRenderable().getActiveCamera():null,s=e._openGLRenderer.getTiledSizeAndOrigin();e.CubeAxesActorHelper.updateAPISpecificData([s.usize,s.vsize],a,e._openGLRenderWindow.getRenderable())}}}const fs={};function gs(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,fs,r),Q.extend(t,e,r),e.CubeAxesActorHelper=Rr.newCubeAxesActorHelper(),us(t,e)}const ls=J(gs,"vtkOpenGLCubeAxesActor");Ct("vtkCubeAxesActor",ls);var ps=`//VTK::System::Dec

/*=========================================================================

  Program:   Visualization Toolkit
  Module:    vtkPolyData2DFS.glsl

  Copyright (c) Ken Martin, Will Schroeder, Bill Lorensen
  All rights reserved.
  See Copyright.txt or http://www.kitware.com/Copyright.htm for details.

     This software is distributed WITHOUT ANY WARRANTY; without even
     the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
     PURPOSE.  See the above copyright notice for more information.

=========================================================================*/

uniform int PrimitiveIDOffset;

// Texture coordinates
//VTK::TCoord::Dec

// Scalar coloring
//VTK::Color::Dec

// Depth Peeling
//VTK::DepthPeeling::Dec

// picking support
//VTK::Picking::Dec

// the output of this shader
//VTK::Output::Dec

// Apple Bug
//VTK::PrimID::Dec

void main()
{
  // Apple Bug
  //VTK::PrimID::Impl

  //VTK::Color::Impl
  //VTK::TCoord::Impl

  //VTK::DepthPeeling::Impl
  //VTK::Picking::Impl

  if (gl_FragData[0].a <= 0.0)
    {
    discard;
    }
}
`,hs=`//VTK::System::Dec

/*=========================================================================

  Program:   Visualization Toolkit
  Module:    vtkPolyData2DVS.glsl

  Copyright (c) Ken Martin, Will Schroeder, Bill Lorensen
  All rights reserved.
  See Copyright.txt or http://www.kitware.com/Copyright.htm for details.

     This software is distributed WITHOUT ANY WARRANTY; without even
     the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
     PURPOSE.  See the above copyright notice for more information.

=========================================================================*/

// all variables that represent positions or directions have a suffix
// indicating the coordinate system they are in. The possible values are
// MC - Model Coordinates
// WC - WC world coordinates
// VC - View Coordinates
// DC - Display Coordinates

in vec4 vertexWC;

// frag position in VC
//VTK::PositionVC::Dec

// material property values
//VTK::Color::Dec

// Texture coordinates
//VTK::TCoord::Dec

// Apple Bug
//VTK::PrimID::Dec

uniform mat4 WCVCMatrix;  // World to view matrix

void main()
{
  // Apple Bug
  //VTK::PrimID::Impl

  gl_Position = WCVCMatrix*vertexWC;

  //VTK::TCoord::Impl

  //VTK::Color::Impl

  //VTK::PositionVC::Impl
}
`;const Lr={BACKGROUND:0,FOREGROUND:1};var Ur={DisplayLocation:Lr};const{primTypes:$}=hr,{Filter:nr,Wrap:ar}=xr,{vtkErrorMacro:Ce}=cn,ds={type:"StartEvent"},xs={type:"EndEvent"};function ys(t,e){e.classHierarchy.push("vtkOpenGLPolyDataMapper2D"),t.buildPass=n=>{n&&(e.openGLActor2D=t.getFirstAncestorOfType("vtkOpenGLActor2D"),e._openGLRenderer=e.openGLActor2D.getFirstAncestorOfType("vtkOpenGLRenderer"),e._openGLRenderWindow=e._openGLRenderer.getLastAncestorOfType("vtkOpenGLRenderWindow"),e.openGLCamera=e._openGLRenderer.getViewNodeFor(e._openGLRenderer.getRenderable().getActiveCamera()))},t.overlayPass=n=>{n&&t.render()},t.getShaderTemplate=(n,a,s)=>{n.Vertex=hs,n.Fragment=ps,n.Geometry=""},t.render=()=>{const n=e._openGLRenderWindow.getContext();if(e.context!==n){e.context=n;for(let i=$.Start;i<$.End;i++)e.primitives[i].setOpenGLRenderWindow(e._openGLRenderWindow)}const a=e.openGLActor2D.getRenderable(),s=e._openGLRenderer.getRenderable();t.renderPiece(s,a)},t.renderPiece=(n,a)=>{if(t.invokeEvent(ds),e.renderable.getStatic()||e.renderable.update(),e.currentInput=e.renderable.getInputData(),t.invokeEvent(xs),!e.currentInput){Ce("No input!");return}if(!e.currentInput.getPoints||!e.currentInput.getPoints().getNumberOfValues())return;const s=e.context;e._openGLRenderWindow.enableCullFace(),s.cullFace(s.BACK),t.renderPieceStart(n,a),t.renderPieceDraw(n,a),t.renderPieceFinish(n,a)},t.renderPieceStart=(n,a)=>{if(e.primitiveIDOffset=0,e._openGLRenderer.getSelector())switch(e._openGLRenderer.getSelector().getCurrentPass()){default:e._openGLRenderer.getSelector().renderProp(a)}e.renderable.getColorTextureMap()&&e.internalColorTexture.activate(),t.updateBufferObjects(n,a),e.lastBoundBO=null},t.getNeedToRebuildShaders=(n,a,s)=>n.getShaderSourceTime().getMTime()<e.renderable.getMTime()||n.getShaderSourceTime().getMTime()<e.currentInput.getMTime(),t.updateBufferObjects=(n,a)=>{t.getNeedToRebuildBufferObjects(n,a)&&t.buildBufferObjects(n,a)},t.getNeedToRebuildBufferObjects=(n,a)=>{const s=e.VBOBuildTime.getMTime();return!!(s<t.getMTime()||s<e._openGLRenderWindow.getMTime()||s<e.renderable.getMTime()||s<a.getMTime()||s<e.currentInput.getMTime()||e.renderable.getTransformCoordinate()&&s<n.getMTime())},t.buildBufferObjects=(n,a)=>{const s=e.currentInput;if(s===null)return;e.renderable.mapScalars(s,a.getProperty().getOpacity());const i=e.renderable.getColorMapColors(),o=a.getProperty().getRepresentation();let c=s.getPointData().getTCoords();e.openGLActor2D.getActiveTextures()||(c=null);let u=!1;if(e.renderable.getColorCoordinates()){c=e.renderable.getColorCoordinates(),u=e.renderable.getAreScalarsMappedFromCells(),e.internalColorTexture||(e.internalColorTexture=xr.newInstance({resizable:!0}));const h=e.internalColorTexture;h.setMinificationFilter(nr.NEAREST),h.setMagnificationFilter(nr.NEAREST),h.setWrapS(ar.CLAMP_TO_EDGE),h.setWrapT(ar.CLAMP_TO_EDGE),h.setOpenGLRenderWindow(e._openGLRenderWindow);const x=e.renderable.getColorTextureMap(),d=x.getExtent(),T=x.getPointData().getScalars();h.create2DFromRaw({width:d[1]-d[0]+1,height:d[3]-d[2]+1,numComps:T.getNumberOfComponents(),dataType:T.getDataType(),data:T.getData()}),h.activate(),h.sendParameters(),h.deactivate()}const g=e.renderable.getTransformCoordinate(),p=n.getRenderWindow().getViews()[0].getViewportSize(n),l=`${s.getMTime()}A${o}B${s.getMTime()}C${i?i.getMTime():1}D${c?c.getMTime():1}E${g?n.getMTime():1}F${p}`;if(e.VBOBuildString!==l){let h=s.getPoints();if(g){const d=un.newInstance(),T=h.getNumberOfPoints();d.setNumberOfPoints(T);const b=[];for(let m=0;m<T;++m){h.getPoint(m,b),g.setValue(b);const v=g.getComputedDoubleViewportValue(n);d.setPoint(m,v[0],v[1],0)}h=d}const x={points:h,tcoords:c,colors:i,cellOffset:0,useTCoordsPerCell:u,haveCellScalars:e.renderable.getAreScalarsMappedFromCells(),customAttributes:e.renderable.getCustomShaderAttributes().map(d=>s.getPointData().getArrayByName(d))};x.cellOffset+=e.primitives[$.Points].getCABO().createVBO(s.getVerts(),"verts",o,x),x.cellOffset+=e.primitives[$.Lines].getCABO().createVBO(s.getLines(),"lines",o,x),x.cellOffset+=e.primitives[$.Tris].getCABO().createVBO(s.getPolys(),"polys",o,x),x.cellOffset+=e.primitives[$.TriStrips].getCABO().createVBO(s.getStrips(),"strips",o,x),e.VBOBuildTime.modified(),e.VBOBuildString=l}},t.renderPieceDraw=(n,a)=>{const s=a.getProperty().getRepresentation();e.context.depthMask(!0);for(let o=$.Start;o<$.End;o++)e.primitives[o].getCABO().getElementCount()&&(e.lastBoundBO=e.primitives[o],e.primitiveIDOffset+=e.primitives[o].drawArrays(n,a,s,t))},t.renderPieceFinish=(n,a)=>{e.lastBoundBO&&e.lastBoundBO.getVAO().release(),e.renderable.getColorTextureMap()&&e.internalColorTexture.deactivate()},t.replaceShaderValues=(n,a,s)=>{t.replaceShaderColor(n,a,s),t.replaceShaderTCoord(n,a,s),t.replaceShaderPicking(n,a,s),t.replaceShaderPositionVC(n,a,s)},t.replaceShaderColor=(n,a,s)=>{let i=n.Vertex,o=n.Geometry,c=n.Fragment,u=["uniform vec3 diffuseColorUniform;","uniform float opacityUniform;"],g=["vec3 diffuseColor = diffuseColorUniform;","float opacity = opacityUniform;"];e.lastBoundBO.getCABO().getColorComponents()!==0?(u=u.concat(["varying vec4 vertexColorVSOutput;"]),i=L.substitute(i,"//VTK::Color::Dec",["attribute vec4 scalarColor;","varying vec4 vertexColorVSOutput;"]).result,i=L.substitute(i,"//VTK::Color::Impl",["vertexColorVSOutput =  scalarColor;"]).result,o=L.substitute(o,"//VTK::Color::Dec",["in vec4 vertexColorVSOutput[];","out vec4 vertexColorGSOutput;"]).result,o=L.substitute(o,"//VTK::Color::Impl",["vertexColorGSOutput = vertexColorVSOutput[i];"]).result,c=L.substitute(c,"//VTK::Color::Impl",g.concat(["  diffuseColor = vertexColorVSOutput.rgb;","  opacity = opacity*vertexColorVSOutput.a;"])).result):e.renderable.getAreScalarsMappedFromCells()&&(g=g.concat(["  vec4 texColor = texture2D(texture1, tcoordVCVSOutput.st);","  diffuseColor = texColor.rgb;","  opacity = opacity*texColor.a;"])),g=g.concat(["gl_FragData[0] = vec4(diffuseColor, opacity);"]),c=L.substitute(c,"//VTK::Color::Dec",u).result,c=L.substitute(c,"//VTK::Color::Impl",g).result,n.Vertex=i,n.Geometry=o,n.Fragment=c},t.replaceShaderTCoord=(n,a,s)=>{if(e.lastBoundBO.getCABO().getTCoordOffset()){let i=n.Vertex,o=n.Geometry,c=n.Fragment;const u=e.lastBoundBO.getCABO().getTCoordComponents();u===1?(i=L.substitute(i,"//VTK::TCoord::Dec",["in float tcoordMC;","out float tcoordVCVSOutput;"]).result,i=L.substitute(i,"//VTK::TCoord::Impl",["tcoordVCVSOutput = tcoordMC;"]).result,o=L.substitute(o,"//VTK::TCoord::Dec",[`in float tcoordVCVSOutput[];
`,"out float tcoordVCGSOutput;"]).result,o=L.substitute(o,["//VTK::TCoord::Impl","tcoordVCGSOutput = tcoordVCVSOutput[i];"]).result,c=L.substitute(c,"//VTK::TCoord::Dec",["in float tcoordVCVSOutput;","uniform sampler2D texture1;"]).result,c=L.substitute(c,"//VTK::TCoord::Impl",["gl_FragData[0] = gl_FragData[0]*texture2D(texture1, vec2(tcoordVCVSOutput,0));"]).result):u===2&&(i=L.substitute(i,"//VTK::TCoord::Dec",["in vec2 tcoordMC;","out vec2 tcoordVCVSOutput;"]).result,i=L.substitute(i,"//VTK::TCoord::Impl",["tcoordVCVSOutput = tcoordMC;"]).result,o=L.substitute(o,"//VTK::TCoord::Dec",[`in vec2 tcoordVCVSOutput[];
`,"out vec2 tcoordVCGSOutput;"]).result,o=L.substitute(o,"//VTK::TCoord::Impl",["tcoordVCGSOutput = tcoordVCVSOutput[i];"]).result,c=L.substitute(c,"//VTK::TCoord::Dec",["in vec2 tcoordVCVSOutput;","uniform sampler2D texture1;"]).result,c=L.substitute(c,"//VTK::TCoord::Impl",["gl_FragData[0] = gl_FragData[0]*texture2D(texture1, tcoordVCVSOutput.st);"]).result),e.renderable.getAreScalarsMappedFromCells()&&(o=L.substitute(o,"//VTK::PrimID::Impl",["gl_PrimitiveID = gl_PrimitiveIDIn;"]).result),n.Vertex=i,n.Geometry=o,n.Fragment=c}},t.replaceShaderPicking=(n,a,s)=>{let i=n.Fragment;i=L.substitute(i,"//VTK::Picking::Dec",["uniform vec3 mapperIndex;","uniform int picking;"]).result,i=L.substitute(i,"//VTK::Picking::Impl","  gl_FragData[0] = picking != 0 ? vec4(mapperIndex,1.0) : gl_FragData[0];").result,n.Fragment=i},t.replaceShaderPositionVC=(n,a,s)=>{e.lastBoundBO.replaceShaderPositionVC(n,a,s)},t.invokeShaderCallbacks=(n,a,s)=>{const i=e.renderable.getViewSpecificProperties().ShadersCallbacks;i&&i.forEach(o=>{o.callback(o.userData,n,a,s)})},t.setMapperShaderParameters=(n,a,s)=>{if(n.getProgram().isUniformUsed("PrimitiveIDOffset")&&n.getProgram().setUniformi("PrimitiveIDOffset",e.primitiveIDOffset),n.getProgram().isAttributeUsed("vertexWC")&&(n.getVAO().addAttributeArray(n.getProgram(),n.getCABO(),"vertexWC",n.getCABO().getVertexOffset(),n.getCABO().getStride(),e.context.FLOAT,3,!1)||Ce("Error setting vertexWC in shader VAO.")),n.getCABO().getElementCount()&&(e.VBOBuildTime.getMTime()>n.getAttributeUpdateTime().getMTime()||n.getShaderSourceTime().getMTime()>n.getAttributeUpdateTime().getMTime())){e.renderable.getCustomShaderAttributes().forEach((c,u)=>{n.getProgram().isAttributeUsed(`${c}MC`)&&(n.getVAO().addAttributeArray(n.getProgram(),n.getCABO(),`${c}MC`,n.getCABO().getCustomData()[u].offset,n.getCABO().getStride(),e.context.FLOAT,n.getCABO().getCustomData()[u].components,!1)||Ce(`Error setting ${c}MC in shader VAO.`))}),n.getProgram().isAttributeUsed("tcoordMC")&&n.getCABO().getTCoordOffset()?n.getVAO().addAttributeArray(n.getProgram(),n.getCABO(),"tcoordMC",n.getCABO().getTCoordOffset(),n.getCABO().getStride(),e.context.FLOAT,n.getCABO().getTCoordComponents(),!1)||Ce("Error setting tcoordMC in shader VAO."):n.getVAO().removeAttributeArray("tcoordMC"),n.getProgram().isAttributeUsed("scalarColor")&&n.getCABO().getColorComponents()?n.getVAO().addAttributeArray(n.getProgram(),n.getCABO().getColorBO(),"scalarColor",n.getCABO().getColorOffset(),n.getCABO().getColorBOStride(),e.context.UNSIGNED_BYTE,4,!0)||Ce("Error setting scalarColor in shader VAO."):n.getVAO().removeAttributeArray("scalarColor"),e.internalColorTexture&&n.getProgram().isUniformUsed("texture1")&&e.internalColorTexture.getTextureUnit()>-1&&n.getProgram().setUniformi("texture1",e.internalColorTexture.getTextureUnit());const i=e.openGLActor2D.getActiveTextures();if(i)for(let c=0;c<i.length;++c){const g=i[c].getTextureUnit(),f=`texture${g+1}`;n.getProgram().isUniformUsed(f)&&n.getProgram().setUniformi(f,g)}n.setMapperShaderParameters(a,s,e._openGLRenderer.getTiledSizeAndOrigin());const o=e._openGLRenderer.getSelector();n.getProgram().setUniform3fArray("mapperIndex",o?o.getPropColorValue():[0,0,0]),n.getProgram().setUniformi("picking",o?o.getCurrentPass()+1:0)}},t.setPropertyShaderParameters=(n,a,s)=>{const i=e.renderable.getColorMapColors();if(!i||i.getNumberOfComponents()===0){const o=n.getProgram(),c=s.getProperty(),u=c.getOpacity();o.setUniformf("opacityUniform",u);const g=c.getColor();o.setUniform3fArray("diffuseColorUniform",g)}},t.setLightingShaderParameters=(n,a,s)=>{};function r(n,a,s){return a.identity(s),n.reduce((i,o,c)=>c===0?o?a.copy(i,o):a.identity(i):o?a.multiply(i,i,o):i,s)}t.setCameraShaderParameters=(n,a,s)=>{const i=n.getProgram(),c=n.getCABO().getCoordShiftAndScaleEnabled()?n.getCABO().getInverseShiftAndScaleMatrix():null,g=a.getRenderWindow().getViews()[0].getViewportSize(a),f=a.getViewport(),p=s.getActualPositionCoordinate().getComputedDoubleViewportValue(a),l=[0,0,1,1],h=[0,0,1,1];if(h[0]=f[0]>=l[0]?f[0]:l[0],h[1]=f[1]>=l[1]?f[1]:l[1],h[2]=f[2]<=l[2]?f[2]:l[2],h[3]=f[3]<=l[3]?f[3]:l[3],h[0]>=h[2]||h[1]>=h[3])return;g[0]=Ne(g[0]*(h[2]-h[0])/(f[2]-f[0])),g[1]=Ne(g[1]*(h[3]-h[1])/(f[3]-f[1]));const x=e._openGLRenderer.getParent().getSize(),d=Ne(p[0]-(h[0]-f[0])*x[0]),T=Ne(p[1]-(h[1]-f[1])*x[1]),b=-d;let m=-d+g[0];const v=-T;let y=-T+g[1];b===m&&(m=b+1),v===y&&(y=v+1);const S=ye(new Float64Array(16));S[0]=2/(m-b),S[5]=2/(y-v),S[3]=-1*(m+b)/(m-b),S[7]=-1*(y+v)/(y-v),S[10]=0,S[11]=s.getProperty().getDisplayLocation()===Lr.FOREGROUND?-1:1,S[15]=1,De(S,S),i.setUniformMatrix("WCVCMatrix",r([S,c],fn,e.tmpMat4))},t.getAllocatedGPUMemoryInBytes=()=>{let n=0;return e.primitives.forEach(a=>{n+=a.getAllocatedGPUMemoryInBytes()}),n}}const ms={context:null,VBOBuildTime:0,VBOBuildString:null,primitives:null,primTypes:null,shaderRebuildString:null};function vs(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,ms,r),Q.extend(t,e,r),Ut.implementReplaceShaderCoincidentOffset(t,e,r),Ut.implementBuildShadersWithReplacements(t,e,r),e.primitives=[],e.primTypes=$,e.tmpMat4=ye(new Float64Array(16));for(let n=$.Start;n<$.End;n++)e.primitives[n]=hr.newInstance(),e.primitives[n].setPrimitiveType(n),e.primitives[n].set({lastLightComplexity:0,lastLightCount:0,lastSelectionPass:!1},!0);St(t,e,["context"]),e.VBOBuildTime={},dr(e.VBOBuildTime,{mtime:0}),ys(t,e)}const Ts=J(vs,"vtkOpenGLPolyDataMapper2D");Ct("vtkMapper2D",Ts);const Cs={HORIZONTAL:"horizontal",VERTICAL:"vertical",AUTO:"auto"};var Nr={Orientation:Cs};const{VectorMode:Ss}=gn,{Orientation:et}=Nr;function ht(t,e,r){t.strokeStyle=e.strokeColor,t.lineWidth=e.strokeSize,t.fillStyle=e.fontColor;const n=e.fontSize??r;t.font=`${e.fontStyle} ${n}px ${e.fontFamily}`}function Pr(t,e){return r=>{const n=r.getLastSize(),a=(n[0]/700)**.8,s=(n[1]/700)**.8,i=Math.min(a,s),o=r.getAxisTextStyle(),c=r.getTickTextStyle();Object.assign(o,e.axisTextStyle),Object.assign(c,e.tickTextStyle),o.fontSize===void 0&&(o.fontSize=Math.max(24*i,12)),c.fontSize===void 0&&(r.getLastAspectRatio()>1?c.fontSize=Math.max(20*i,10):c.fontSize=Math.max(16*i,10));const u=r.updateTextureAtlas();r.setTopTitle(!1);const g=r.getBoxSizeByReference();let f=!1;if(e.orientation===et.VERTICAL?f=!0:e.orientation===et.HORIZONTAL?f=!1:f=r.getLastAspectRatio()>1,f)r.setTickLabelPixelOffset(.3*c.fontSize),u.titleWidth<=u.tickWidth+r.getTickLabelPixelOffset()+.8*c.fontSize?(r.setTopTitle(!0),r.setAxisTitlePixelOffset(.2*c.fontSize),g[0]=2*(u.tickWidth+r.getTickLabelPixelOffset()+.8*c.fontSize)/n[0],r.setBoxPosition([.98-g[0],-.92])):(r.setAxisTitlePixelOffset(.2*c.fontSize),g[0]=2*(u.titleHeight+r.getAxisTitlePixelOffset()+u.tickWidth+r.getTickLabelPixelOffset()+.8*c.fontSize)/n[0],r.setBoxPosition([.99-g[0],-.92])),g[1]=Math.max(1.2,Math.min(1.84/s,1.84));else{r.setAxisTitlePixelOffset(1.2*c.fontSize),r.setTickLabelPixelOffset(.1*c.fontSize);const p=2*(.8*c.fontSize+u.titleHeight+r.getAxisTitlePixelOffset())/n[1],l=2*u.tickWidth/n[0];g[0]=Math.min(1.9,Math.max(1.4,1.4*l*(r.getTicks().length+3))),g[1]=p,r.setBoxPosition([-.5*g[0],-.97])}r.recomputeBarSegments(u)}}function Ar(t,e){return r=>{const n=r.getLastTickBounds(),a=kt().domain([n[0],n[1]]),s=a.ticks(5),i=a.tickFormat(5);r.setTicks(s),r.setTickStrings(s.map(i))}}function bs(t,e){e.classHierarchy.push("vtkScalarBarActorHelper"),t.setRenderable=a=>{e.renderable!==a&&(e.renderable=a,e.barActor.setProperty(a.getProperty()),e.barActor.setParentProp(a),e.barActor.setCoordinateSystemToDisplay(),e.tmActor.setProperty(a.getProperty()),e.tmActor.setParentProp(a),e.tmActor.setCoordinateSystemToDisplay(),e.generateTicks=a.generateTicks,e.axisTextStyle={...a.getAxisTextStyle()},e.tickTextStyle={...a.getTickTextStyle()},t.modified())},t.updateAPISpecificData=(a,s,i)=>{(e.lastSize[0]!==a[0]||e.lastSize[1]!==a[1])&&(e.lastSize[0]=a[0],e.lastSize[1]=a[1],e.lastAspectRatio=a[0]/a[1],e.forceUpdate=!0);const o=e.renderable.getScalarsToColors();if(!(!o||!e.renderable.getVisibility())&&(e.barMapper.setLookupTable(o),e.camera=s,e.renderWindow=i,e.forceUpdate||Math.max(o.getMTime(),t.getMTime(),e.renderable.getMTime())>e.lastRebuildTime.getMTime())){const c=o.getMappingRange();if(e.lastTickBounds=[...c],e.renderable.getGenerateTicks()(t),e.renderable.getAutomated())e.renderable.getAutoLayout()(t);else{e.axisTextStyle={...e.renderable.getAxisTextStyle()},e.tickTextStyle={...e.renderable.getTickTextStyle()},e.barPosition=[...e.renderable.getBarPosition()],e.barSize=[...e.renderable.getBarSize()],e.boxPosition=[...e.renderable.getBoxPosition()],e.boxSize=[...e.renderable.getBoxSize()],e.axisTitlePixelOffset=e.renderable.getAxisTitlePixelOffset(),e.tickLabelPixelOffset=e.renderable.getTickLabelPixelOffset();const u=t.updateTextureAtlas();t.recomputeBarSegments(u)}t.updatePolyDataForLabels(),t.updatePolyDataForBarSegments(),e.lastRebuildTime.modified(),e.forceUpdate=!1}},t.updateTextureAtlas=()=>{e.tmContext.textBaseline="bottom",e.tmContext.textAlign="left";const a={},s=new Map;let i=0,o=1;ht(e.tmContext,e.axisTextStyle,18);let c=e.tmContext.measureText(e.renderable.getAxisLabel()),u={height:c.actualBoundingBoxAscent+2,startingHeight:o,width:c.width+2,textStyle:e.axisTextStyle};s.set(e.renderable.getAxisLabel(),u),o+=u.height,i=u.width,a.titleWidth=u.width,a.titleHeight=u.height,a.tickWidth=0,a.tickHeight=0,ht(e.tmContext,e.tickTextStyle,14);const g=[...t.getTickStrings(),"NaN","Below","Above"];for(let f=0;f<g.length;f++)s.has(g[f])||(c=e.tmContext.measureText(g[f]),u={height:c.actualBoundingBoxAscent+2,startingHeight:o,width:c.width+2,textStyle:e.tickTextStyle},s.set(g[f],u),o+=u.height,i<u.width&&(i=u.width),a.tickWidth<u.width&&(a.tickWidth=u.width),a.tickHeight<u.height&&(a.tickHeight=u.height));return i=He(i),o=He(o),s.forEach(f=>{f.tcoords=[0,(o-f.startingHeight-f.height)/o,f.width/i,(o-f.startingHeight-f.height)/o,f.width/i,(o-f.startingHeight)/o,0,(o-f.startingHeight)/o]}),e.tmCanvas.width=i,e.tmCanvas.height=o,e.tmContext.textBaseline="bottom",e.tmContext.textAlign="left",e.tmContext.clearRect(0,0,i,o),s.forEach((f,p)=>{const l=f.textStyle===e.axisTextStyle?18:14;ht(e.tmContext,f.textStyle,l),e.tmContext.fillText(p,1,f.startingHeight+f.height-1)}),e.tmTexture.setCanvas(e.tmCanvas),e.tmTexture.modified(),e._tmAtlas=s,a},t.computeBarSize=a=>{e.vertical=e.boxSize[1]>e.boxSize[0];const s=2*a.tickHeight/e.lastSize[1],i=[1,1];if(e.vertical){const o=2*(a.tickWidth+e.tickLabelPixelOffset)/e.lastSize[0];if(e.topTitle){const c=2*(a.titleHeight+e.axisTitlePixelOffset)/e.lastSize[1];e.barSize[0]=e.boxSize[0]-o,e.barSize[1]=e.boxSize[1]-c}else{const c=2*(a.titleHeight+e.axisTitlePixelOffset)/e.lastSize[0];e.barSize[0]=e.boxSize[0]-c-o,e.barSize[1]=e.boxSize[1]}e.barPosition[0]=e.boxPosition[0]+o,e.barPosition[1]=e.boxPosition[1],i[1]=s}else{const o=(2*a.tickWidth-8)/e.lastSize[0],c=2*(a.titleHeight+e.axisTitlePixelOffset)/e.lastSize[1];e.barSize[0]=e.boxSize[0],e.barPosition[0]=e.boxPosition[0],e.barSize[1]=e.boxSize[1]-c,e.barPosition[1]=e.boxPosition[1],i[0]=o}return i},t.recomputeBarSegments=a=>{const s=t.computeBarSize(a);e.barSegments=[];const i=[0,0],o=e.vertical?1:0,c=e.vertical?.01:.02;function u(p,l){e.barSegments.push({corners:[[...i],[i[0]+s[0],i[1]],[i[0]+s[0],i[1]+s[1]],[i[0],i[1]+s[1]]],scalars:l,title:p}),i[o]+=s[o]+c}e.renderable.getDrawNanAnnotation()&&e.renderable.getScalarsToColors().getNanColor()&&u("NaN",[NaN,NaN,NaN,NaN]),e.renderable.getDrawBelowRangeSwatch()&&e.renderable.getScalarsToColors().getUseBelowRangeColor?.()&&u("Below",[-.1,-.1,-.1,-.1]);const g=e.renderable.getScalarsToColors().getUseAboveRangeColor?.();i[o]+=c;const f=s[o];s[o]=g?1-2*c-s[o]-i[o]:1-c-i[o],u("ticks",e.vertical?[0,0,.995,.995]:[0,.995,.995,0]),e.renderable.getDrawAboveRangeSwatch()&&g&&(s[o]=f,i[o]+=c,u("Above",[1.1,1.1,1.1,1.1]))};const r=new Float64Array(3);t.createPolyDataForOneLabel=(a,s,i,o,c,u)=>{const g=e._tmAtlas.get(a);if(!g)return;let f=u.ptIdx,p=u.cellIdx;r[0]=(.5*s[0]+.5)*e.lastSize[0],r[1]=(.5*s[1]+.5)*e.lastSize[1],r[2]=s[2],r[0]+=c[0],r[1]+=c[1];const l=[],h=o==="vertical"?[1,0]:[0,1];o==="vertical"?(l[0]=g.width,l[1]=-g.height,i[0]==="middle"?r[1]-=g.width/2:i[0]==="right"&&(r[1]-=g.width),i[1]==="middle"?r[0]+=g.height/2:i[1]==="top"&&(r[0]+=g.height)):(l[0]=g.width,l[1]=g.height,i[0]==="middle"?r[0]-=g.width/2:i[0]==="right"&&(r[0]-=g.width),i[1]==="middle"?r[1]-=g.height/2:i[1]==="top"&&(r[1]-=g.height)),u.points[f*3]=r[0],u.points[f*3+1]=r[1],u.points[f*3+2]=r[2],u.tcoords[f*2]=g.tcoords[0],u.tcoords[f*2+1]=g.tcoords[1],f++,r[h[0]]+=l[0],u.points[f*3]=r[0],u.points[f*3+1]=r[1],u.points[f*3+2]=r[2],u.tcoords[f*2]=g.tcoords[2],u.tcoords[f*2+1]=g.tcoords[3],f++,r[h[1]]+=l[1],u.points[f*3]=r[0],u.points[f*3+1]=r[1],u.points[f*3+2]=r[2],u.tcoords[f*2]=g.tcoords[4],u.tcoords[f*2+1]=g.tcoords[5],f++,r[h[0]]-=l[0],u.points[f*3]=r[0],u.points[f*3+1]=r[1],u.points[f*3+2]=r[2],u.tcoords[f*2]=g.tcoords[6],u.tcoords[f*2+1]=g.tcoords[7],f++,u.polys[p*4]=3,u.polys[p*4+1]=f-4,u.polys[p*4+2]=f-3,u.polys[p*4+3]=f-2,p++,u.polys[p*4]=3,u.polys[p*4+1]=f-4,u.polys[p*4+2]=f-2,u.polys[p*4+3]=f-1,u.ptIdx+=4,u.cellIdx+=2};const n=new Float64Array(3);t.updatePolyDataForLabels=()=>{const a=t.getTickStrings().length+e.barSegments.length,s=a*4,i=a*2,o=new Float64Array(s*3),c=new Uint16Array(i*4),u=new Float32Array(s*2),g={ptIdx:0,cellIdx:0,polys:c,points:o,tcoords:u},f=e.vertical?0:1,p=e.vertical?1:0;n[2]=-.99;const l=e.vertical?["right","middle"]:["middle","bottom"];let h=[0,1];const x=[0,0];e.vertical?(x[0]=-e.tickLabelPixelOffset,e.topTitle?(n[0]=e.boxPosition[0]+.5*e.boxSize[0],n[1]=e.barPosition[1]+e.barSize[1],t.createPolyDataForOneLabel(e.renderable.getAxisLabel(),n,["middle","bottom"],"horizontal",[0,e.axisTitlePixelOffset],g)):(n[0]=e.barPosition[0]+e.barSize[0],n[1]=e.barPosition[1]+.5*e.barSize[1],t.createPolyDataForOneLabel(e.renderable.getAxisLabel(),n,["middle","top"],"vertical",[e.axisTitlePixelOffset,0],g)),h=[-1,0]):(x[1]=e.tickLabelPixelOffset,n[0]=e.barPosition[0]+.5*e.barSize[0],n[1]=e.barPosition[1]+e.barSize[1],t.createPolyDataForOneLabel(e.renderable.getAxisLabel(),n,["middle","bottom"],"horizontal",[0,e.axisTitlePixelOffset],g)),n[f]=e.barPosition[f]+(.5*h[f]+.5)*e.barSize[f],n[p]=e.barPosition[p]+e.barSize[p]*.5;let d=null;for(let M=0;M<e.barSegments.length;M++){const B=e.barSegments[M];B.title==="ticks"?d=B:(n[p]=e.barPosition[p]+.5*e.barSize[p]*(B.corners[2][p]+B.corners[0][p]),t.createPolyDataForOneLabel(B.title,n,l,"horizontal",x,g))}const T=e.barPosition[p]+e.barSize[p]*d.corners[0][p],b=e.barSize[p]*(d.corners[2][p]-d.corners[0][p]),m=t.getTicks(),v=t.getTickStrings(),y=t.getTickPositions();for(let M=0;M<m.length;M++){const B=y?y[M]:(m[M]-e.lastTickBounds[0])/(e.lastTickBounds[1]-e.lastTickBounds[0]);n[p]=T+b*B,t.createPolyDataForOneLabel(v[M],n,l,"horizontal",x,g)}const S=G.newInstance({numberOfComponents:2,values:u,name:"TextureCoordinates"});e.tmPolyData.getPointData().setTCoords(S),e.tmPolyData.getPoints().setData(o,3),e.tmPolyData.getPoints().modified(),e.tmPolyData.getPolys().setData(c,1),e.tmPolyData.getPolys().modified(),e.tmPolyData.modified()},t.updatePolyDataForBarSegments=()=>{const a=e.renderable.getScalarsToColors();let s=0;e.renderable.getDrawNanAnnotation()&&a.getNanColor()&&(s+=1),e.renderable.getDrawBelowRangeSwatch()&&a.getUseBelowRangeColor?.()&&(s+=1),e.renderable.getDrawAboveRangeSwatch()&&a.getUseAboveRangeColor?.()&&(s+=1);const i=4*(1+s),o=i;let c=1;a.getVectorMode()===Ss.COMPONENT&&(c=a.getVectorComponent()+1);const u=new Float64Array(i*3),g=new Uint16Array(o*5),f=new Float32Array(i*c);let p=0,l=0;for(let x=0;x<e.barSegments.length;x++){const d=e.barSegments[x];for(let T=0;T<4;T++){n[0]=e.barPosition[0]+d.corners[T][0]*e.barSize[0],n[1]=e.barPosition[1]+d.corners[T][1]*e.barSize[1],u[p*3]=(.5*n[0]+.5)*e.lastSize[0],u[p*3+1]=(.5*n[1]+.5)*e.lastSize[1],u[p*3+2]=n[2];for(let b=0;b<c;b++)f[p*c+b]=e.lastTickBounds[0]+d.scalars[T]*(e.lastTickBounds[1]-e.lastTickBounds[0]);p++}g[l*5]=4,g[l*5+1]=p-4,g[l*5+2]=p-3,g[l*5+3]=p-2,g[l*5+4]=p-1,l++}const h=G.newInstance({numberOfComponents:c,values:f,name:"Scalars"});e.polyData.getPointData().setScalars(h),e.polyData.getPoints().setData(u,3),e.polyData.getPoints().modified(),e.polyData.getPolys().setData(g,1),e.polyData.getPolys().modified(),e.polyData.modified()}}const ws=C.newInstance(function(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{renderable:null};Object.assign(e,{},r),C.obj(t,e),C.setGet(t,e,["axisTitlePixelOffset","tickLabelPixelOffset","renderable","topTitle","ticks","tickStrings","tickPositions"]),C.get(t,e,["lastSize","lastAspectRatio","lastTickBounds","axisTextStyle","tickTextStyle","barActor","tmActor"]),C.getArray(t,e,["boxPosition","boxSize"]),C.setArray(t,e,["boxPosition","boxSize"],2),e.forceUpdate=!1,e.lastRebuildTime={},C.obj(e.lastRebuildTime,{mtime:0}),e.lastSize=[-1,-1],e.tmCanvas=document.createElement("canvas"),e.tmContext=e.tmCanvas.getContext("2d"),e._tmAtlas=new Map,e.barMapper=Z.newInstance(),e.barMapper.setInterpolateScalarsBeforeMapping(!0),e.barMapper.setUseLookupTableScalarRange(!0),e.polyData=K.newInstance(),e.barMapper.setInputData(e.polyData),e.barActor=fe.newInstance(),e.barActor.setMapper(e.barMapper),e.tmPolyData=K.newInstance(),e.tmMapper=Z.newInstance(),e.tmMapper.setInputData(e.tmPolyData),e.tmTexture=ge.newInstance({resizable:!0}),e.tmTexture.setInterpolate(!1),e.tmActor=fe.newInstance({parentProp:t}),e.tmActor.setMapper(e.tmMapper),e.tmActor.addTexture(e.tmTexture),e.barPosition=[0,0],e.barSize=[0,0],e.boxPosition=[.88,-.92],e.boxSize=[.1,1.1],e.lastTickBounds=[],bs(t,e)},"vtkScalarBarActorHelper");function Ds(t,e){e.classHierarchy.push("vtkScalarBarActor"),t.setTickTextStyle=r=>{e.tickTextStyle={...e.tickTextStyle,...r},t.modified()},t.setAxisTextStyle=r=>{e.axisTextStyle={...e.axisTextStyle,...r},t.modified()},t.setOrientationToHorizontal=()=>t.setOrientation(et.HORIZONTAL),t.setOrientationToVertical=()=>t.setOrientation(et.VERTICAL),t.resetAutoLayoutToDefault=()=>{t.setAutoLayout(Pr(t,e))},t.resetGenerateTicksToDefault=()=>{t.setGenerateTicks(Ar())}}function Os(t){return{automated:!0,autoLayout:null,axisLabel:"Scalar Value",barPosition:[0,0],barSize:[0,0],boxPosition:[.88,-.92],boxSize:[.1,1.1],scalarToColors:null,axisTitlePixelOffset:36,axisTextStyle:{fontColor:"white",fontStyle:"normal",fontSize:void 0,fontFamily:"serif"},tickLabelPixelOffset:14,tickTextStyle:{fontColor:"white",fontStyle:"normal",fontSize:void 0,fontFamily:"serif"},generateTicks:null,drawNanAnnotation:!0,drawBelowRangeSwatch:!0,drawAboveRangeSwatch:!0,orientation:null,...t}}function Er(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,Os(r)),e.autoLayout||(e.autoLayout=Pr(t,e)),e.generateTicks||(e.generateTicks=Ar()),fe.extend(t,e,r),t.getProperty().setDiffuse(0),t.getProperty().setAmbient(1),C.setGet(t,e,["automated","autoLayout","axisTitlePixelOffset","axisLabel","scalarsToColors","tickLabelPixelOffset","generateTicks","drawNanAnnotation","drawBelowRangeSwatch","drawAboveRangeSwatch","orientation"]),C.get(t,e,["axisTextStyle","tickTextStyle"]),C.getArray(t,e,["barPosition","barSize","boxPosition","boxSize"]),C.setArray(t,e,["barPosition","barSize","boxPosition","boxSize"],2),Ds(t,e)}const Vs=C.newInstance(Er,"vtkScalarBarActor");var Gr={newInstance:Vs,extend:Er,newScalarBarActorHelper:ws,...Nr};function Ms(t,e){e.classHierarchy.push("vtkOpenGLScalarBarActor"),t.buildPass=r=>{r&&(e._openGLRenderer=t.getFirstAncestorOfType("vtkOpenGLRenderer"),e._openGLRenderWindow=e._openGLRenderer.getParent(),e.scalarBarActorHelper.getRenderable()||e.scalarBarActorHelper.setRenderable(e.renderable),t.prepareNodes(),t.addMissingNode(e.scalarBarActorHelper.getBarActor()),t.addMissingNode(e.scalarBarActorHelper.getTmActor()),t.removeUnusedNodes())},t.opaquePass=(r,n)=>{if(r){const a=e._openGLRenderer?e._openGLRenderer.getRenderable().getActiveCamera():null,s=e._openGLRenderer.getTiledSizeAndOrigin();e.scalarBarActorHelper.updateAPISpecificData([s.usize,s.vsize],a,e._openGLRenderWindow.getRenderable())}}}const ks={};function Bs(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,ks,r),Q.extend(t,e,r),e.scalarBarActorHelper=Gr.newScalarBarActorHelper(),Ms(t,e)}const Rs=J(Bs,"vtkOpenGLScalarBarActor");Ct("vtkScalarBarActor",Rs);const{CoordinateSystem:sr}=bt;function Ls(t,e){e.classHierarchy.push("vtkWebGPUActor"),t.buildPass=r=>{r&&(e.WebGPURenderer=t.getFirstAncestorOfType("vtkWebGPURenderer"),e.WebGPURenderWindow=e.WebGPURenderer.getFirstAncestorOfType("vtkWebGPURenderWindow"),e.propID===void 0&&(e.propID=e.WebGPURenderWindow.getUniquePropID()),t.prepareNodes(),t.addMissingNode(e.renderable.getMapper()),t.removeUnusedNodes())},t.traverseOpaquePass=r=>{!e.renderable||!e.renderable.getNestedVisibility()||!e.renderable.getIsOpaque()||e.WebGPURenderer.getSelector()&&!e.renderable.getNestedPickable()||(t.apply(r,!0),e.children[0]&&e.children[0].traverse(r),t.apply(r,!1))},t.traverseTranslucentPass=r=>{!e.renderable||!e.renderable.getNestedVisibility()||e.renderable.getIsOpaque()||e.WebGPURenderer.getSelector()&&!e.renderable.getNestedPickable()||(t.apply(r,!0),e.children[0]&&e.children[0].traverse(r),t.apply(r,!1))},t.queryPass=(r,n)=>{if(r){if(!e.renderable||!e.renderable.getVisibility())return;e.renderable.getIsOpaque()?n.incrementOpaqueActorCount():n.incrementTranslucentActorCount()}},t.getBufferShift=r=>(t.getKeyMatrices(r),e.bufferShift),t.getKeyMatrices=r=>{if(Math.max(e.renderable.getMTime(),r.getStabilizedTime())>e.keyMatricesTime.getMTime()){e.renderable.computeMatrix();const n=e.renderable.getMatrix();e.bufferShift[0]=n[3],e.bufferShift[1]=n[7],e.bufferShift[2]=n[11];const a=r.getStabilizedCenterByReference();e.renderable.getCoordinateSystem()===sr.WORLD&&(e.bufferShift[0]-=a[0],e.bufferShift[1]-=a[1],e.bufferShift[2]-=a[2]),De(e.keyMatrices.bcwc,n),e.renderable.getIsIdentity()?ye(e.keyMatrices.normalMatrix):(dt(e.keyMatrices.normalMatrix,e.keyMatrices.bcwc),e.keyMatrices.normalMatrix[3]=0,e.keyMatrices.normalMatrix[7]=0,e.keyMatrices.normalMatrix[11]=0,pr(e.keyMatrices.normalMatrix,e.keyMatrices.normalMatrix),De(e.keyMatrices.normalMatrix,e.keyMatrices.normalMatrix)),Ke(e.keyMatrices.bcwc,e.keyMatrices.bcwc,[-e.bufferShift[0],-e.bufferShift[1],-e.bufferShift[2]]),e.renderable.getCoordinateSystem()===sr.WORLD?Ke(e.keyMatrices.bcsc,e.keyMatrices.bcwc,[-a[0],-a[1],-a[2]]):dt(e.keyMatrices.bcsc,e.keyMatrices.bcwc),e.keyMatricesTime.modified()}return e.keyMatrices}}const Us={keyMatricesTime:null,keyMatrices:null,propID:void 0,bufferShift:void 0};function Ns(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,Us,r),Q.extend(t,e,r),e.keyMatricesTime={},C.obj(e.keyMatricesTime,{mtime:0}),e.keyMatrices={normalMatrix:new Float64Array(16),bcwc:new Float64Array(16),bcsc:new Float64Array(16)},C.get(t,e,["propID","keyMatricesTime"]),e.bufferShift=[0,0,0,0],Ls(t,e)}const Ps=C.newInstance(Ns);ve("vtkActor",Ps);const{CoordinateSystem:ir}=bt;function As(t,e){e.classHierarchy.push("vtkWebGPUActor2D"),t.buildPass=r=>{r&&(e.WebGPURenderer=t.getFirstAncestorOfType("vtkWebGPURenderer"),e.WebGPURenderWindow=e.WebGPURenderer.getFirstAncestorOfType("vtkWebGPURenderWindow"),e.propID===void 0&&(e.propID=e.WebGPURenderWindow.getUniquePropID()),t.prepareNodes(),t.addMissingNode(e.renderable.getMapper()),t.removeUnusedNodes())},t.traverseOpaquePass=r=>{!e.renderable||!e.renderable.getNestedVisibility()||!e.renderable.getIsOpaque()||e.WebGPURenderer.getSelector()&&!e.renderable.getNestedPickable()||(t.apply(r,!0),e.children[0]&&e.children[0].traverse(r),t.apply(r,!1))},t.traverseTranslucentPass=r=>{!e.renderable||!e.renderable.getNestedVisibility()||e.renderable.getIsOpaque()||e.WebGPURenderer.getSelector()&&!e.renderable.getNestedPickable()||(t.apply(r,!0),e.children[0]&&e.children[0].traverse(r),t.apply(r,!1))},t.queryPass=(r,n)=>{if(r){if(!e.renderable||!e.renderable.getVisibility())return;e.renderable.getIsOpaque()?n.incrementOpaqueActorCount():n.incrementTranslucentActorCount()}},t.getBufferShift=r=>(t.getKeyMatrices(r),e.bufferShift),t.getKeyMatrices=r=>{if(Math.max(e.renderable.getMTime(),r.getStabilizedTime())>e.keyMatricesTime.getMTime()){e.bufferShift[0]=0,e.bufferShift[1]=0,e.bufferShift[2]=0;const n=r.getStabilizedCenterByReference();e.renderable.getCoordinateSystem()===ir.WORLD&&(e.bufferShift[0]-=n[0],e.bufferShift[1]-=n[1],e.bufferShift[2]-=n[2]),ye(e.keyMatrices.bcwc),ye(e.keyMatrices.normalMatrix),Ke(e.keyMatrices.bcwc,e.keyMatrices.bcwc,[-e.bufferShift[0],-e.bufferShift[1],-e.bufferShift[2]]),e.renderable.getCoordinateSystem()===ir.WORLD?Ke(e.keyMatrices.bcsc,e.keyMatrices.bcwc,[-n[0],-n[1],-n[2]]):dt(e.keyMatrices.bcsc,e.keyMatrices.bcwc),e.keyMatricesTime.modified()}return e.keyMatrices}}const Es={keyMatricesTime:null,keyMatrices:null,propID:void 0,bufferShift:void 0};function Gs(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,Es,r),Q.extend(t,e,r),e.keyMatricesTime={},C.obj(e.keyMatricesTime,{mtime:0}),e.keyMatrices={normalMatrix:new Float64Array(16),bcwc:new Float64Array(16),bcsc:new Float64Array(16)},C.get(t,e,["propID","keyMatricesTime"]),e.bufferShift=[0,0,0,0],As(t,e)}const _s=C.newInstance(Gs);ve("vtkActor2D",_s);function Fs(t,e){e.classHierarchy.push("vtkWebGPUCubeAxesActor"),t.buildPass=r=>{r&&(e.WebGPURenderer=t.getFirstAncestorOfType("vtkWebGPURenderer"),e.WebGPURenderWindow=e.WebGPURenderer.getParent(),e.CubeAxesActorHelper.getRenderable()||e.CubeAxesActorHelper.setRenderable(e.renderable),t.prepareNodes(),t.addMissingNode(e.CubeAxesActorHelper.getTmActor()),t.addMissingNode(e.renderable.getGridActor()),t.removeUnusedNodes())},t.opaquePass=(r,n)=>{if(r){const a=e.WebGPURenderer?e.WebGPURenderer.getRenderable().getActiveCamera():null,s=e.WebGPURenderer.getTiledSizeAndOrigin();e.CubeAxesActorHelper.updateAPISpecificData([s.usize,s.vsize],a,e.WebGPURenderWindow.getRenderable())}}}const Is={};function zs(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,Is,r),Q.extend(t,e,r),e.CubeAxesActorHelper=Rr.newCubeAxesActorHelper(),Fs(t,e)}const Ws=J(zs,"vtkWebGPUCubeAxesActor");ve("vtkCubeAxesActor",Ws);const{DisplayLocation:Tt}=Ur;function $s(t,e){e.classHierarchy.push("vtkProperty2D"),t.setDisplayLocationToBackground=()=>t.setDisplayLocation(Tt.BACKGROUND),t.setDisplayLocationToForeground=()=>t.setDisplayLocation(Tt.FOREGROUND),t.setRepresentationToWireframe=()=>t.setRepresentation(be.WIREFRAME),t.setRepresentationToSurface=()=>t.setRepresentation(be.SURFACE),t.setRepresentationToPoints=()=>t.setRepresentation(be.POINTS),t.getRepresentationAsString=()=>C.enumToString(be,e.representation)}const Hs={color:[1,1,1],opacity:1,pointSize:1,lineWidth:1,representation:be.SURFACE,displayLocation:Tt.FOREGROUND};function Ks(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,Hs,r),C.obj(t,e),C.setGet(t,e,["opacity","lineWidth","pointSize","displayLocation","representation"]),C.setGetArray(t,e,["color"],3),$s(t,e)}C.newInstance(Ks,"vtkProperty2D");var js={...Ur};const{BufferUsage:P,PrimitiveTypes:F}=wt,{Representation:Ie}=lr,{ScalarMode:ze}=Z,{CoordinateSystem:Ys}=bt,{DisplayLocation:or}=js,qs=`
//VTK::Renderer::Dec

//VTK::Color::Dec

//VTK::Normal::Dec

//VTK::TCoord::Dec

//VTK::Select::Dec

//VTK::Mapper::Dec

//VTK::IOStructs::Dec

@vertex
fn main(
//VTK::IOStructs::Input
)
//VTK::IOStructs::Output
{
  var output : vertexOutput;

  var vertex: vec4<f32> = vertexBC;

  //VTK::Color::Impl

  //VTK::Normal::Impl

  //VTK::TCoord::Impl

  //VTK::Select::Impl

  //VTK::Position::Impl

  return output;
}
`,Xs=`
struct PBRData {
  diffuse: vec3<f32>,
  specular: vec3<f32>,
}

struct Material {
  ior: f32,
  roughness: f32,
  metallic: f32,
  base: vec3<f32>,
};

struct DirectionalLight {
  direction: vec3<f32>,
  color: vec3<f32>,
};

struct PointLight {
  position: vec3<f32>,
  color: vec3<f32>,
};

struct SpotLight {
  position: vec3<f32>,
  direction: vec3<f32>,
  cones: vec2<f32>,
  color: vec3<f32>,
};

const pi: f32 = 3.14159265359;

// Dot product with the max already in it
fn mdot(a: vec3<f32>, b: vec3<f32>) -> f32 {
  return max(0.0, dot(a, b));
}
// Dot product with a max in it that does not allow for negative values
// Physically based rendering is accurate as long as normals are accurate,
// however this is pretty often not the case. In order to prevent negative
// values from ruining light calculations and creating zones of zero light,
// this remapping is used, which smoothly clamps the dot product between
// zero and one while still maintaining a good amount of accuracy.
fn cdot(a: vec3<f32>, b: vec3<f32>) -> f32 {
  var d: f32 = max(0.0, dot(a, b));
  d = pow((d + 1.0) / 2.0, 2.6);
  return d;
}

// Lambertian diffuse model
fn lambertDiffuse(base: vec3<f32>, N: vec3<f32>, L: vec3<f32>) -> vec3<f32> {
  var NdotL: f32 = mdot(N, L);
  NdotL = pow(NdotL, 1.5);
  return (base/pi)*NdotL;
}

// Yasuhiro Fujii improvement on the Oren-Nayar model
// https://mimosa-pudica.net/improved-oren-nayar.html
// p is surface color, o is roughness
fn fujiiOrenNayar(p: vec3<f32>, o: f32, N: vec3<f32>, L: vec3<f32>, V: vec3<f32>) -> vec3<f32> {
  var invpi: f32 = 0.31830988618; // 1/pi

  var o2 = o*o;
  var NdotL: f32 = mdot(N, L);
  NdotL = pow(NdotL, 1.5); // Less physically accurate, but hides the "seams" between lights better

  var NdotV: f32 = mdot(N, V);
  var LdotV: f32 = mdot(L, V);

  var s: f32 = LdotV - NdotL*NdotV;
  var t: f32 = mix(1.0, max(NdotL, NdotV), step(0.0, s)); // Mix with step is the equivalent of an if statement
  var A: vec3<f32> = 0.5*(o2 / (o2 + 0.33)) + 0.17*p*(o2 / (o2 + 0.13));
  A = invpi*(1 - A);
  var B: f32 = 0.45*(o2 / (o2 + 0.09));
  B = invpi*B;

  return p*NdotL*(A + B*(s/t));
}

// Fresnel portion of BRDF (IOR only, simplified)
fn schlickFresnelIOR(V: vec3<f32>, N: vec3<f32>, ior: f32, k: f32) -> f32 {
  var NdotV: f32 = mdot(V, N);
  var F0: f32 = (pow((ior - 1.0), 2.0) + k*k) / (pow((ior + 1.0), 2.0) + k*k); // This takes into account the roughness, which the other one does not
  return F0 + (1.0 - F0) * pow((1.0-NdotV), 5.0);
}

// Fresnel portion of BRDF (Color ior, better)
fn schlickFresnelRGB(V: vec3<f32>, N: vec3<f32>, F0: vec3<f32>) -> vec3<f32> {
  var NdotV: f32 = mdot(V, N);
  return F0 + (1.0 - F0) * pow((1-NdotV), 5.0);
}

// Normal portion of BRDF
// https://learnopengl.com/PBR/Theory
// Trowbridge-Reitz GGX functions: normal, halfway, roughness^2
fn trGGX(N: vec3<f32>, H: vec3<f32>, a: f32) -> f32 {
  var a2: f32 = a*a;
  var NdotH = mdot(N, H);
  var NdotH2 = NdotH*NdotH;

  var denom: f32 = NdotH2 * (a2 - 1.0) + 1.0;

  return a2 / max((pi*denom*denom), 0.000001);
}

// A VERY bad approximation of anisotropy. Real anisotropic calculations require tangent and bitangent
fn anisotrophicTrGGX(N: vec3<f32>, H: vec3<f32>, O: vec3<f32>, s: f32, a: f32) -> f32 {
  var Op: vec3<f32> = (rendererUBO.WCVCNormals * vec4<f32>(normalize(O) * s, 0.)).xyz;

  var ggx1: f32 = trGGX(N + Op*s, H, a);
  var ggx2: f32 = trGGX(N - Op*s, H, a);
  return (0.5 * ggx1 + 0.5 * ggx2);
}

// Geometry portion of BRDF
fn schlickGGX(N: vec3<f32>, X: vec3<f32>, k: f32) -> f32 {
  var NdotX = cdot(N, X);
  return NdotX / max(0.000001, (NdotX*(1.0-k) + k));
}

fn smithSurfaceRoughness(N: vec3<f32>, V: vec3<f32>, L: vec3<f32>, k: f32) -> f32 {
  var ggx1: f32 = min(1.0, schlickGGX(N, V, k));
  var ggx2: f32 = min(1.0, schlickGGX(N, L, k));
  return ggx1*ggx2;
}

// BRDF Combination
fn cookTorrance(D: f32, F: f32, G: f32, N: vec3<f32>, V: vec3<f32>, L: vec3<f32>) -> f32 {
  var num: f32 = D*F*G;
  var denom: f32 = 4*cdot(V, N)*cdot(L, N);

  return num / max(denom, 0.000001);
}

// Different lighting calculations for different light sources
fn calcDirectionalLight(N: vec3<f32>, V: vec3<f32>, mat: Material, light: DirectionalLight) -> PBRData {
  var L: vec3<f32> = normalize(light.direction); // Light Vector
  var H: vec3<f32> = normalize(L + V); // Halfway Vector

  var alpha = mat.roughness * mat.roughness;
  var k: f32 = alpha * alpha / 2.0;

  var D: f32 = trGGX(N, H, alpha); // Distribution
  // var F: f32 = schlickFresnelIOR(V, N, ior, k); // Fresnel
  var G: f32 = smithSurfaceRoughness(N, V, L, k); // Geometry

  var brdf: f32 = cookTorrance(D, 1.0, G, N, V, L); // Fresnel term is replaced with 1 because it is added later
  var incoming: vec3<f32> = light.color;
  var angle: f32 = mdot(L, N);
  angle = pow(angle, 1.5);

  var specular: vec3<f32> = brdf * incoming * angle;
  // Oren-Nayar gives a clay-like effect when fully rough which some people may not want, so it might be better to give a separate
  // control property for the diffuse vs specular roughness
  var diffuse: vec3<f32> = incoming * fujiiOrenNayar(mat.base, mat.roughness, N, L, V);
  // Stores the specular and diffuse separately to allow for finer post processing
  var out = PBRData(diffuse, specular);

  return out; // Returns angle along with color of light so the final color can be multiplied by angle as well (creates black areas)
}

fn calcPointLight(N: vec3<f32>, V: vec3<f32>, fragPos: vec3<f32>, mat: Material, light: PointLight) -> PBRData {
  var L: vec3<f32> = normalize(light.position - fragPos);
  var H: vec3<f32> = normalize(L + V);
  var dist = distance(light.position, fragPos);

  var alpha = mat.roughness * mat.roughness;
  var k: f32 = alpha * alpha / 2.0;

  var D: f32 = trGGX(N, H, alpha); // Distribution
  var F: f32 = schlickFresnelIOR(V, N, mat.ior, k); // Fresnel
  var G: f32 = smithSurfaceRoughness(N, V, L, k); // Geometry

  var brdf: f32 = cookTorrance(D, 1.0, G, N, V, L);
  var incoming: vec3<f32> = light.color * (1.0 / (dist * dist));
  var angle: f32 = mdot(L, N);
  angle = pow(angle, 1.5); // Smoothing factor makes it less accurate, but reduces ugly "seams" between light sources

  var specular: vec3<f32> = brdf * incoming * angle;
  var diffuse: vec3<f32> = incoming * fujiiOrenNayar(mat.base, mat.roughness, N, L, V);
  // Stores the specular and diffuse separately to allow for finer post processing
  // Could also be done (propably more properly) with a struct
  var out = PBRData(diffuse, specular);

  return out; // Returns angle along with color of light so the final color can be multiplied by angle as well (creates black areas)
}

// For a reason unknown to me, spheres dont seem to behave propperly with head-on spot lights
fn calcSpotLight(N: vec3<f32>, V: vec3<f32>, fragPos: vec3<f32>, mat: Material, light: SpotLight) -> PBRData {
  var L: vec3<f32> = normalize(light.position - fragPos);
  var H: vec3<f32> = normalize(L + V); // Halfway Vector
  var dist = distance(light.position, fragPos);

  var alpha = mat.roughness * mat.roughness;
  var k: f32 = alpha * alpha / 2.0; // could also be pow(alpha + 1.0, 2) / 8

  var D: f32 = trGGX(N, H, alpha); // Distribution
  // var F: f32 = schlickFresnelIOR(V, N, ior, k); // Fresnel
  var G: f32 = smithSurfaceRoughness(N, V, L, k); // Geometry

  var brdf: f32 = cookTorrance(D, 1.0, G, N, V, L);

  var theta: f32 = mdot(normalize(light.direction), L);
  var epsilon: f32 = light.cones.x - light.cones.y;
  var intensity: f32 = (theta - light.cones.y) / epsilon;
  intensity = clamp(intensity, 0.0, 1.0);
  intensity /= dist * dist;

  var incoming: vec3<f32> = light.color * intensity;

  var angle: f32 = mdot(L, N);
  angle = pow(angle, 1.5); // Smoothing factor makes it less accurate, but reduces ugly "seams" between light sources

  var specular: vec3<f32> = brdf * incoming * angle;
  var diffuse: vec3<f32> = incoming * fujiiOrenNayar(mat.base, mat.roughness, N, L, V);

  // Stores the specular and diffuse separately to allow for finer post processing
  // Could also be done (propably more properly) with a struct
  var out = PBRData(diffuse, specular);

  return out; // Returns angle along with color of light so the final color can be multiplied by angle as well (creates black areas)
}

// Environment mapping stuff
// Takes in a vector and converts it to an equivalent coordinate in a rectilinear texture. Should be replaced with cubemaps at some point
fn vecToRectCoord(dir: vec3<f32>) -> vec2<f32> {
  var tau: f32 = 6.28318530718;
  var out: vec2<f32> = vec2<f32>(0.0);

  out.x = atan2(dir.z, dir.x) / tau;
  out.x += 0.5;

  var phix: f32 = length(vec2(dir.x, dir.z));
  out.y = atan2(dir.y, phix) / pi + 0.5;

  return out;
}

//VTK::Renderer::Dec

//VTK::Color::Dec

//VTK::TCoord::Dec

// optional surface normal declaration
//VTK::Normal::Dec

//VTK::Select::Dec

//VTK::RenderEncoder::Dec

//VTK::Mapper::Dec

//VTK::IOStructs::Dec

@fragment
fn main(
//VTK::IOStructs::Input
)
//VTK::IOStructs::Output
{
  var output : fragmentOutput;

  // Temporary ambient, diffuse, and opacity
  var ambientColor: vec4<f32> = mapperUBO.AmbientColor;
  var diffuseColor: vec4<f32> = mapperUBO.DiffuseColor;
  var opacity: f32 = mapperUBO.Opacity;
  var ior: f32 = mapperUBO.BaseIOR;

  // This should be declared somewhere else
  var _diffuseMap: vec4<f32> = vec4<f32>(1.0);
  var _roughnessMap: vec4<f32> = vec4<f32>(1.0);
  var _metallicMap: vec4<f32> = vec4<f32>(1.0);
  var _normalMap: vec4<f32> = vec4<f32>(0.0, 0.0, 1.0, 0.0); // normal map was setting off the normal vector detection in fragment
  var _ambientOcclusionMap: vec4<f32> = vec4<f32>(1.);
  var _emissionMap: vec4<f32> = vec4<f32>(0.);

  //VTK::Color::Impl

  //VTK::TCoord::Impl

  //VTK::Normal::Impl

  var computedColor: vec4<f32> = vec4<f32>(diffuseColor.rgb, 1.0);

  //VTK::Light::Impl

  //VTK::Select::Impl

  // Use texture alpha for transparency
  computedColor.a = mapperUBO.Opacity * _diffuseMap.a;
  if (computedColor.a == 0.0) { discard; };

  //VTK::Position::Impl

  //VTK::RenderEncoder::Impl

  return output;
}
`;function cr(t){return t.indexOf("edge")>=0}function Zs(t,e){e.classHierarchy.push("vtkWebGPUCellArrayMapper"),t.buildPass=r=>{r&&(e.is2D?(e.WebGPUActor=t.getFirstAncestorOfType("vtkWebGPUActor2D"),e.forceZValue=!0):(e.WebGPUActor=t.getFirstAncestorOfType("vtkWebGPUActor"),e.forceZValue=!1),e.coordinateSystem=e.WebGPUActor.getRenderable().getCoordinateSystem(),e.useRendererMatrix=e.coordinateSystem!==Ys.DISPLAY,e.WebGPURenderer=e.WebGPUActor.getFirstAncestorOfType("vtkWebGPURenderer"),e.WebGPURenderWindow=e.WebGPURenderer.getParent(),e.device=e.WebGPURenderWindow.getDevice())},t.translucentPass=r=>{r&&(t.prepareToDraw(e.WebGPURenderer.getRenderEncoder()),e.renderEncoder.registerDrawCallback(e.pipeline,t.draw))},t.opaquePass=r=>{r&&(t.prepareToDraw(e.WebGPURenderer.getRenderEncoder()),e.renderEncoder.registerDrawCallback(e.pipeline,t.draw))},t.updateUBO=()=>{const n=e.WebGPUActor.getRenderable().getProperty(),a=e.UBO.getSendTime();if(t.getMTime()<=a&&n.getMTime()<=a&&e.renderable.getMTime()<=a)return;const s=e.WebGPUActor.getKeyMatrices(e.WebGPURenderer);if(e.UBO.setArray("BCWCMatrix",s.bcwc),e.UBO.setArray("BCSCMatrix",s.bcsc),e.UBO.setArray("MCWCNormals",s.normalMatrix),e.is2D){const o=n.getDisplayLocation?.()??or.BACKGROUND;e.UBO.setValue("ZValue",o===or.FOREGROUND?1:0);const c=n.getColorByReference();e.UBO.setValue("AmbientIntensity",1),e.UBO.setArray("DiffuseColor",[...c,1]),e.UBO.setValue("DiffuseIntensity",0),e.UBO.setValue("SpecularIntensity",0)}else e.UBO.setValue("AmbientIntensity",n.getAmbient()),e.UBO.setArray("AmbientColor",[...n.getAmbientColorByReference(),1]),e.UBO.setValue("DiffuseIntensity",n.getDiffuse()),e.UBO.setArray("DiffuseColor",[...n.getDiffuseColorByReference(),1]),e.UBO.setValue("Roughness",n.getRoughness()),e.UBO.setValue("BaseIOR",n.getBaseIOR()),e.UBO.setValue("Metallic",n.getMetallic()),e.UBO.setValue("NormalStrength",n.getNormalStrength()),e.UBO.setValue("Emission",n.getEmission()),e.UBO.setValue("SpecularIntensity",n.getSpecular()),n.getSpecularColorByReference()&&e.UBO.setArray("SpecularColor",[...n.getSpecularColorByReference(),1]);const i=n.getEdgeColorByReference?.();i&&e.UBO.setArray("EdgeColor",[...i,1]),e.UBO.setValue("LineWidth",n.getLineWidth()),e.UBO.setValue("Opacity",n.getOpacity()),e.UBO.setValue("PropID",e.WebGPUActor.getPropID()),e.UBO.sendIfNeeded(e.WebGPURenderWindow.getDevice())},t.haveWideLines=()=>{const r=e.WebGPUActor.getRenderable(),n=r.getProperty().getRepresentation();return r.getProperty().getLineWidth()<=1||e.primitiveType===F.Verts?!1:e.primitiveType===F.Triangles||e.primitiveType===F.TriangleStrips?n===Ie.WIREFRAME:!0},t.replaceShaderPosition=(r,n,a)=>{const s=n.getShaderDescription("vertex");s.addBuiltinOutput("vec4<f32>","@builtin(position) Position"),s.hasOutput("vertexVC")||s.addOutput("vec4<f32>","vertexVC");let i=s.getCode();e.useRendererMatrix?(i=E.substitute(i,"//VTK::Position::Impl",["    var pCoord: vec4<f32> = rendererUBO.SCPCMatrix*mapperUBO.BCSCMatrix*vertexBC;","    output.vertexVC = rendererUBO.SCVCMatrix * mapperUBO.BCSCMatrix * vec4<f32>(vertexBC.xyz, 1.0);","//VTK::Position::Impl"]).result,e.forceZValue&&(i=E.substitute(i,"//VTK::Position::Impl",["pCoord = vec4<f32>(pCoord.xyz/pCoord.w, 1.0);","pCoord.z = mapperUBO.ZValue;","//VTK::Position::Impl"]).result)):(i=E.substitute(i,"//VTK::Position::Impl",["    var pCoord: vec4<f32> = mapperUBO.BCSCMatrix*vertexBC;","    pCoord.x = 2.0* pCoord.x / rendererUBO.viewportSize.x - 1.0;","    pCoord.y = 2.0* pCoord.y / rendererUBO.viewportSize.y - 1.0;","    pCoord.z = 0.5 - 0.5 * pCoord.z;","//VTK::Position::Impl"]).result,e.forceZValue&&(i=E.substitute(i,"//VTK::Position::Impl",["    pCoord.z = mapperUBO.ZValue;","//VTK::Position::Impl"]).result)),t.haveWideLines()&&(s.addBuiltinInput("u32","@builtin(instance_index) instanceIndex"),i=E.substitute(i,"//VTK::Position::Impl",["    var tmpPos: vec4<f32> = pCoord;","    var numSteps: f32 = ceil(mapperUBO.LineWidth - 1.0);","    var offset: f32 = (mapperUBO.LineWidth - 1.0) * (f32(input.instanceIndex / 2u) - numSteps/2.0) / numSteps;","    var tmpPos2: vec3<f32> = tmpPos.xyz / tmpPos.w;","    tmpPos2.x = tmpPos2.x + 2.0 * (f32(input.instanceIndex) % 2.0) * offset / rendererUBO.viewportSize.x;","    tmpPos2.y = tmpPos2.y + 2.0 * (f32(input.instanceIndex + 1u) % 2.0) * offset / rendererUBO.viewportSize.y;","    tmpPos2.z = min(1.0, tmpPos2.z + 0.00001);","    pCoord = vec4<f32>(tmpPos2.xyz * tmpPos.w, tmpPos.w);","//VTK::Position::Impl"]).result),i=E.substitute(i,"//VTK::Position::Impl",["    output.Position = pCoord;"]).result,s.setCode(i)},e.shaderReplacements.set("replaceShaderPosition",t.replaceShaderPosition),t.replaceShaderNormal=(r,n,a)=>{const s=a.getBuffer("normalMC"),i=e.WebGPUActor.getRenderable();if(s){const o=n.getShaderDescription("vertex");o.hasOutput("normalVC")||o.addOutput("vec3<f32>","normalVC",s.getArrayInformation()[0].interpolation),o.hasOutput("tangentVC")||o.addOutput("vec3<f32>","tangentVC",s.getArrayInformation()[0].interpolation),o.hasOutput("bitangentVC")||o.addOutput("vec3<f32>","bitangentVC",s.getArrayInformation()[0].interpolation);let c=o.getCode();c=E.substitute(c,"//VTK::Normal::Impl",["  output.normalVC = normalize((rendererUBO.WCVCNormals * mapperUBO.MCWCNormals * normalMC).xyz);","  var c1: vec3<f32> = cross(output.normalVC, vec3<f32>(0, 0, 1));","  var c2: vec3<f32> = cross(output.normalVC, vec3<f32>(0, 1, 0));","  var tangent: vec3<f32> = mix(c1, c2, distance(c1, c2));","  output.tangentVC = normalize(tangent);","  output.bitangentVC = normalize(cross(output.normalVC, tangent));"]).result,o.setCode(c);const u=n.getShaderDescription("fragment");c=u.getCode(),i.getProperty().getNormalTexture()?c=E.substitute(c,"//VTK::Normal::Impl",["  var normal: vec3<f32> = input.normalVC;","  if (!input.frontFacing) { normal = -normal; }","  var tangent: vec3<f32> = input.tangentVC;","  var bitangent: vec3<f32> = input.bitangentVC;","  var TCVCMatrix: mat3x3<f32> = mat3x3<f32>(","    tangent.x, bitangent.x, normal.x,","    tangent.y, bitangent.y, normal.y,","    tangent.z, bitangent.z, normal.z,","  );","  var mappedNormal: vec3<f32> = TCVCMatrix * (_normalMap.xyz * 2 - 1);","  normal = mix(normal, mappedNormal, mapperUBO.NormalStrength);","  normal = normalize(normal);"]).result:c=E.substitute(c,"//VTK::Normal::Impl",["  var normal: vec3<f32> = input.normalVC;","  if (!input.frontFacing) { normal = -normal; }","  normal = normalize(normal);"]).result,u.setCode(c)}},e.shaderReplacements.set("replaceShaderNormal",t.replaceShaderNormal),t.replaceShaderLight=(r,n,a)=>{if(r.includes("sel"))return;const s=n.getShaderDescription("vertex");s.hasOutput("vertexVC")||s.addOutput("vec4<f32>","vertexVC");const i=e.WebGPURenderer.getRenderable(),o=n.getShaderDescription("fragment");let c=o.getCode();if(c.includes("var normal:")&&e.useRendererMatrix&&!cr(r)&&!e.is2D&&!r.includes("sel")){const u=["  let fragPos = vec3<f32>(input.vertexVC.xyz);","  let V = mix(normalize(-fragPos), vec3<f32>(0, 0, 1), f32(rendererUBO.cameraParallel)); // View Vector","  let baseColor = _diffuseMap.rgb * diffuseColor.rgb;","  let roughness = max(0.000001, mapperUBO.Roughness * _roughnessMap.r);","  let metallic = mapperUBO.Metallic * _metallicMap.r;","  let alpha = roughness * roughness;","  let k = alpha * alpha / 2.0;","  var diffuse = vec3<f32>(0.);","  var specular = vec3<f32>(0.);","  let emission = _emissionMap.rgb * mapperUBO.Emission;","","  // Material struct","  let mat = Material(ior, roughness, metallic, baseColor);","","  {","    var i = 0;","    loop {","      if (!(i < rendererUBO.LightCount)) { break; }","      switch (i32(rendererLightSSBO.values[i].LightData.x)) {","         // Point Light","         case 0 {","           let color = rendererLightSSBO.values[i].LightColor.rgb * rendererLightSSBO.values[i].LightColor.w;","           let pos = (rendererLightSSBO.values[i].LightPos).xyz;","           let pointLight = PointLight(pos, color);","           let result = calcPointLight(normal, V, fragPos, mat, pointLight);","           diffuse += max(vec3<f32>(0), result.diffuse);","           specular += max(vec3<f32>(0), result.specular);","          }","         // Directional light","         case 1 {","           let dir = normalize((rendererUBO.WCVCNormals * vec4<f32>(normalize(rendererLightSSBO.values[i].LightDir.xyz), 0.)).xyz);","           let color = rendererLightSSBO.values[i].LightColor.rgb * rendererLightSSBO.values[i].LightColor.w;","           let dirLight = DirectionalLight(dir, color);","           let result = calcDirectionalLight(normal, V, mat, dirLight); // diffuseColor.rgb needs to be fixed with a more dynamic diffuse color","           diffuse += max(vec3<f32>(0), result.diffuse);","           specular += max(vec3<f32>(0), result.specular);","         }","         // Spot Light","         case 2 {","           let color = rendererLightSSBO.values[i].LightColor.rgb * rendererLightSSBO.values[i].LightColor.w;","           let pos = (rendererLightSSBO.values[i].LightPos).xyz;","           let dir = normalize((rendererUBO.WCVCNormals * vec4<f32>(normalize(rendererLightSSBO.values[i].LightDir.xyz), 0.)).xyz);","           let cones = vec2<f32>(rendererLightSSBO.values[i].LightData.y, rendererLightSSBO.values[i].LightData.z);","           let spotLight = SpotLight(pos, dir, cones, color);","           let result = calcSpotLight(normal, V, fragPos, mat, spotLight);","           diffuse += max(vec3<f32>(0), result.diffuse);","           specular += max(vec3<f32>(0), result.specular);","         }","         default { continue; }","       }","      continuing { i++; }","    }","  }","  let fresnel = min(1.0, schlickFresnelIOR(V, normal, ior, k)); // Fresnel","  // This could be controlled with its own variable (that isnt base color) for better artistic control","  let fresnelMetallic = schlickFresnelRGB(V, normal, baseColor); // Fresnel for metal, takes color into account","  let kS = min(vec3<f32>(1.0), mix(vec3<f32>(fresnel), fresnelMetallic, metallic));","  let kD = (1.0 - kS) * (1.0 - metallic);","  let PBR = mapperUBO.DiffuseIntensity * kD * diffuse + kS * specular;","  computedColor = vec4<f32>(PBR + emission, mapperUBO.Opacity);"];i.getEnvironmentTexture()?.getImageLoaded()&&u.push("  // To get diffuse IBL, the texture is sampled with normals in worldspace","  let diffuseIBLCoords = (transpose(rendererUBO.WCVCNormals) * vec4<f32>(normal, 1.)).xyz;","  let diffuseCoords = vecToRectCoord(diffuseIBLCoords);","  // To get specular IBL, the texture is sampled as the worldspace reflection between the normal and view vectors","  // Reflections are first calculated in viewspace, then converted to worldspace to sample the environment","  let VreflN = normalize(reflect(-V, normal));","  let reflectionIBLCoords = (transpose(rendererUBO.WCVCNormals) * vec4<f32>(VreflN, 1.)).xyz;","  let specularCoords = vecToRectCoord(reflectionIBLCoords);","  let diffuseIBL = textureSampleLevel(EnvironmentTexture, EnvironmentTextureSampler, diffuseCoords, rendererUBO.MaxEnvironmentMipLevel);","  let level = roughness * rendererUBO.MaxEnvironmentMipLevel;","  let specularIBL = textureSampleLevel(EnvironmentTexture, EnvironmentTextureSampler, specularCoords, level);","  let specularIBLContribution = specularIBL.rgb * rendererUBO.BackgroundSpecularStrength;","  computedColor += vec4<f32>(specularIBLContribution * kS, 0);","  let diffuseIBLContribution = diffuseIBL.rgb * rendererUBO.BackgroundDiffuseStrength;","  computedColor += vec4<f32>(diffuseIBLContribution * baseColor * _ambientOcclusionMap.rgb * kD, 0);"),c=E.substitute(c,"//VTK::Light::Impl",u).result,o.setCode(c)}else c=E.substitute(c,"//VTK::Light::Impl",["  let diffuse = diffuseColor.rgb;","  let specular = mapperUBO.SpecularColor.rgb * mapperUBO.SpecularColor.a;","  computedColor = vec4<f32>(diffuse * _diffuseMap.rgb, mapperUBO.Opacity);"]).result,o.setCode(c)},e.shaderReplacements.set("replaceShaderLight",t.replaceShaderLight),t.replaceShaderColor=(r,n,a)=>{if(cr(r)){const u=n.getShaderDescription("fragment");let g=u.getCode();g=E.substitute(g,"//VTK::Color::Impl",["ambientColor = mapperUBO.EdgeColor;","diffuseColor = mapperUBO.EdgeColor;"]).result,u.setCode(g);return}const s=a.getBuffer("colorVI");if(!s)return;const i=n.getShaderDescription("vertex");i.addOutput("vec4<f32>","color",s.getArrayInformation()[0].interpolation);let o=i.getCode();o=E.substitute(o,"//VTK::Color::Impl",["  output.color = colorVI;"]).result,i.setCode(o);const c=n.getShaderDescription("fragment");o=c.getCode(),o=E.substitute(o,"//VTK::Color::Impl",["ambientColor = input.color;","diffuseColor = input.color;","opacity = mapperUBO.Opacity * input.color.a;"]).result,c.setCode(o)},e.shaderReplacements.set("replaceShaderColor",t.replaceShaderColor),t.replaceShaderTCoord=(r,n,a)=>{if(!a.hasAttribute("tcoord"))return;const s=n.getShaderDescription("vertex"),i=a.getBuffer("tcoord"),o=ie.getNumberOfComponentsFromBufferFormat(i.getArrayInformation()[0].format);let c=s.getCode();s.addOutput(`vec${o}<f32>`,"tcoordVS"),c=E.substitute(c,"//VTK::TCoord::Impl",["  output.tcoordVS = tcoord;"]).result,s.setCode(c);const u=n.getShaderDescription("fragment");c=u.getCode();const g=e.WebGPUActor.getRenderable(),f=g.getProperty(),p=S=>S?S.getDimensionality()===o:!1,l=[],h=f.getDiffuseTexture?.();(h?.getImageLoaded()||g.getTextures()[0]||e.colorTexture)&&(p(h)||p(g.getTextures()[0])||p(e.colorTexture))&&l.push("_diffuseMap = textureSample(DiffuseTexture, DiffuseTextureSampler, input.tcoordVS);");const x=f.getORMTexture?.(),d=f.getRMTexture?.(),T=f.getRoughnessTexture?.(),b=f.getMetallicTexture?.(),m=f.getAmbientOcclusionTexture?.(),v=f.getEmissionTexture?.(),y=f.getNormalTexture?.();x?.getImageLoaded()?p(x)&&l.push("_ambientOcclusionMap = textureSample(ORMTexture, ORMTextureSampler, input.tcoordVS).rrra;","_roughnessMap = textureSample(ORMTexture, ORMTextureSampler, input.tcoordVS).ggga;","_metallicMap = textureSample(ORMTexture, ORMTextureSampler, input.tcoordVS).bbba;"):d?.getImageLoaded()?p(d)&&l.push("_roughnessMap = textureSample(RMTexture, RMTextureSampler, input.tcoordVS).ggga;","_metallicMap = textureSample(RMTexture, RMTextureSampler, input.tcoordVS).bbba;"):(T?.getImageLoaded()&&p(T)&&l.push("_roughnessMap = textureSample(RoughnessTexture, RoughnessTextureSampler, input.tcoordVS).ggga;"),b?.getImageLoaded()&&p(b)&&l.push("_metallicMap = textureSample(MetallicTexture, MetallicTextureSampler, input.tcoordVS).bbba;"),m?.getImageLoaded()&&p(m)&&l.push("_ambientOcclusionMap = textureSample(AmbientOcclusionTexture, AmbientOcclusionTextureSampler, input.tcoordVS).rrra;")),v?.getImageLoaded()&&p(v)&&l.push("_emissionMap = textureSample(EmissionTexture, EmissionTextureSampler, input.tcoordVS);"),y?.getImageLoaded()&&p(y)&&l.push("_normalMap = textureSample(NormalTexture, NormalTextureSampler, input.tcoordVS);"),c=E.substitute(c,"//VTK::TCoord::Impl",l).result,u.setCode(c)},e.shaderReplacements.set("replaceShaderTCoord",t.replaceShaderTCoord),t.replaceShaderSelect=(r,n,a)=>{if(r.includes("sel")){const s=n.getShaderDescription("fragment");let i=s.getCode();i=E.substitute(i,"//VTK::Select::Impl",["  var compositeID: u32 = 0u;"]).result,s.setCode(i)}},e.shaderReplacements.set("replaceShaderSelect",t.replaceShaderSelect),t.getUsage=(r,n)=>r===Ie.POINTS||n===F.Points?P.Verts:n===F.Lines?P.Lines:r===Ie.WIREFRAME?n===F.Triangles?P.LinesFromTriangles:P.LinesFromStrips:n===F.Triangles?P.Triangles:n===F.TriangleStrips?P.Strips:n===F.TriangleEdges?P.LinesFromTriangles:P.LinesFromStrips,t.getHashFromUsage=r=>`pt${r}`,t.getTopologyFromUsage=r=>{switch(r){case P.Triangles:return"triangle-list";case P.Verts:return"point-list";case P.Lines:default:return"line-list"}},t.buildVertexInput=()=>{const r=e.currentInput,n=e.cellArray,a=e.primitiveType;let i=e.WebGPUActor.getRenderable().getProperty().getRepresentation();const o=e.WebGPURenderWindow.getDevice();let c=!1;a===F.TriangleEdges&&(c=!0,i=Ie.WIREFRAME);const u=e.vertexInput,g=r.getPoints();let f=null;if(n?(f=o.getBufferManager().getBuffer({hash:`R${i}P${a}${n.getMTime()}`,usage:P.Index,cells:n,numberOfPoints:g.getNumberOfPoints(),primitiveType:a,representation:i}),u.setIndexBuffer(f)):u.setIndexBuffer(null),g){const x=e.WebGPUActor.getBufferShift(e.WebGPURenderer);u.addBuffer(o.getBufferManager().getBuffer({hash:`${g.getMTime()}I${f?.getMTime?.()??0}${x.join()}float32x4`,usage:P.PointArray,format:"float32x4",dataArray:g,indexBuffer:f,shift:x,packExtra:!0}),["vertexBC"])}else u.removeBufferIfPresent("vertexBC");const p=t.getUsage(i,a);if(e._usesCellNormals=!1,!e.is2D&&(p===P.Triangles||p===P.Strips)){const x=r.getPointData().getNormals(),d={format:"snorm8x4",indexBuffer:f,packExtra:!0,shift:0,scale:127};x?(d.hash=`${x.getMTime()}I${f.getMTime()}snorm8x4`,d.dataArray=x,d.usage=P.PointArray,u.addBuffer(o.getBufferManager().getBuffer(d),["normalMC"])):a===F.Triangles?(e._usesCellNormals=!0,d.hash=`PFN${g.getMTime()}I${f.getMTime()}snorm8x4`,d.dataArray=g,d.cells=n,d.usage=P.NormalsFromPoints,u.addBuffer(o.getBufferManager().getBuffer(d),["normalMC"])):u.removeBufferIfPresent("normalMC")}else u.removeBufferIfPresent("normalMC");let l=!1;if(e.renderable.getScalarVisibility()){const x=e.renderable.getColorMapColors();if(x&&!c){const d=e.renderable.getScalarMode(),T=(d===ze.USE_CELL_DATA||d===ze.USE_CELL_FIELD_DATA||d===ze.USE_FIELD_DATA||!r.getPointData().getScalars())&&d!==ze.USE_POINT_FIELD_DATA&&x;u.addBuffer(o.getBufferManager().getBuffer({usage:P.PointArray,format:"unorm8x4",hash:`${T}${x.getMTime()}I${f.getMTime()}unorm8x4`,dataArray:x,indexBuffer:f,cellData:T,cellOffset:0}),["colorVI"]),l=!0}}l||u.removeBufferIfPresent("colorVI");let h=null;e.renderable.getInterpolateScalarsBeforeMapping?.()&&e.renderable.getColorCoordinates()?h=e.renderable.getColorCoordinates():h=r.getPointData().getTCoords(),h&&!c?u.addBuffer(o.getBufferManager().getBufferForPointArray(h,u.getIndexBuffer()),["tcoord"]):u.removeBufferIfPresent("tcoord")},t.updateTextures=()=>{const r=[],n=[],a=e.renderable.getColorTextureMap?.();a&&!e.colorTexture&&(e.colorTexture=ge.newInstance({label:"polyDataColor"})),a&&(e.colorTexture.setInputData(a),n.push(["DiffuseTexture",e.colorTexture]));const s=e.WebGPUActor.getRenderable(),i=e.WebGPURenderer.getRenderable();[["DiffuseTexture",s.getProperty().getDiffuseTexture?.()],["DiffuseTexture",s.getTextures()[0]],["DiffuseTexture",e.colorTexture],["ORMTexture",s.getProperty().getORMTexture?.()],["RMTexture",s.getProperty().getRMTexture?.()],["RoughnessTexture",s.getProperty().getRoughnessTexture?.()],["MetallicTexture",s.getProperty().getMetallicTexture?.()],["NormalTexture",s.getProperty().getNormalTexture?.()],["AmbientOcclusionTexture",s.getProperty().getAmbientOcclusionTexture?.()],["EmissionTexture",s.getProperty().getEmissionTexture?.()],["EnvironmentTexture",i.getEnvironmentTexture?.()]].forEach(c=>{let[u,g]=c;g&&((g.getInputData()||g.getJsImageData()||g.getCanvas()||g.getImageBitmap())&&n.push([u,g]),g.getImage()&&g.getImageLoaded()&&n.push([u,g]))}),n.forEach(c=>{let[u,g]=c;const f=e.device.getTextureManager().getTextureForVTKTexture(g,u);if(!f.getReady())return;let p=!1;for(let l=0;l<e.textures.length;++l)if(e.textures[l]===f){p=!0,r[l]=!0;break}if(!p){r[e.textures.length]=!0;const l=f.createView(u);e.textures.push(f),e.textureViews.push(l);const h=g.getInterpolate()?"linear":"nearest";let x=null;g.getEdgeClamp()&&g.getRepeat()?x="mirror-repeat":g.getEdgeClamp()?x="clamp-to-edge":g.getRepeat()&&(x="repeat");let d={addressModeU:x,addressModeV:x,addressModeW:x,minFilter:h,magFilter:h};u==="EnvironmentTexture"&&(d={addressModeU:"repeat",addressModeV:"clamp-to-edge",addressModeW:"repeat",minFilter:h,magFilter:h,mipmapFilter:"linear"}),l.addSampler(e.device,d)}});for(let c=e.textures.length-1;c>=0;c--)r[c]||(e.textures.splice(c,1),e.textureViews.splice(c,1))},t.computePipelineHash=()=>{let r=`pd${e.useRendererMatrix?"r":""}${e.forceZValue?"z":""}`;if(e.primitiveType===F.TriangleEdges||e.primitiveType===F.TriangleStripEdges)r+="edge";else{if(e.vertexInput.hasAttribute("normalMC")&&(r+="n"),e.vertexInput.hasAttribute("colorVI")&&(r+="c"),e.vertexInput.hasAttribute("tcoord")){const a=e.vertexInput.getBuffer("tcoord"),s=ie.getNumberOfComponentsFromBufferFormat(a.getArrayInformation()[0].format);r+=`t${s}`}e.textures.length&&(r+=`tx${e.textures.length}`)}e._usesCellNormals&&(r+="cn"),e.SSBO&&(r+="ssbo");const n=t.getHashFromUsage(e.usage);r+=n,r+=e.renderEncoder.getPipelineHash(),e.pipelineHash=r},t.updateBuffers=()=>{e.primitiveType!==F.TriangleEdges&&e.primitiveType!==F.TriangleStripEdges&&t.updateTextures();const r=e.WebGPUActor.getRenderable(),n=r.getProperty().getRepresentation();e.usage=t.getUsage(n,e.primitiveType),t.buildVertexInput();const a=e.vertexInput.getBuffer("vertexBC");if(t.setNumberOfVertices(a.getSizeInBytes()/a.getStrideInBytes()),t.setTopology(t.getTopologyFromUsage(e.usage)),t.updateUBO(),t.haveWideLines()){const s=r.getProperty();t.setNumberOfInstances(Math.ceil(s.getLineWidth()*2))}else t.setNumberOfInstances(1)}}const Js={is2D:!1,cellArray:null,currentInput:null,cellOffset:0,primitiveType:0,colorTexture:null,renderEncoder:null,textures:null};function _r(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,Js,r),ln.extend(t,e,r),e.fragmentShaderTemplate=Xs,e.vertexShaderTemplate=qs,e._tmpMat3=pn(new Float64Array(9)),e._tmpMat4=ye(new Float64Array(16)),e.UBO=hn.newInstance({label:"mapperUBO"}),e.UBO.addEntry("BCWCMatrix","mat4x4<f32>"),e.UBO.addEntry("BCSCMatrix","mat4x4<f32>"),e.UBO.addEntry("MCWCNormals","mat4x4<f32>"),e.UBO.addEntry("AmbientColor","vec4<f32>"),e.UBO.addEntry("DiffuseColor","vec4<f32>"),e.UBO.addEntry("EdgeColor","vec4<f32>"),e.UBO.addEntry("SpecularColor","vec4<f32>"),e.UBO.addEntry("AmbientIntensity","f32"),e.UBO.addEntry("DiffuseIntensity","f32"),e.UBO.addEntry("Roughness","f32"),e.UBO.addEntry("Metallic","f32"),e.UBO.addEntry("Ambient","f32"),e.UBO.addEntry("Normal","f32"),e.UBO.addEntry("Emission","f32"),e.UBO.addEntry("NormalStrength","f32"),e.UBO.addEntry("BaseIOR","f32"),e.UBO.addEntry("SpecularIntensity","f32"),e.UBO.addEntry("LineWidth","f32"),e.UBO.addEntry("Opacity","f32"),e.UBO.addEntry("ZValue","f32"),e.UBO.addEntry("PropID","u32"),e.UBO.addEntry("ClipNear","f32"),e.UBO.addEntry("ClipFar","f32"),e.UBO.addEntry("Time","u32"),St(t,e,["cellArray","currentInput","cellOffset","is2D","primitiveType","renderEncoder"]),e.textures=[],Zs(t,e)}const Qs=J(_r,"vtkWebGPUCellArrayMapper");var Fr={newInstance:Qs,extend:_r};const{PrimitiveTypes:W}=wt;function ei(t,e){e.classHierarchy.push("vtkWebGPUPolyDataMapper"),t.createCellArrayMapper=()=>Fr.newInstance(),t.buildPass=r=>{if(r){e.WebGPUActor=t.getFirstAncestorOfType("vtkWebGPUActor"),e.renderable.getStatic()||e.renderable.update();const n=e.renderable.getInputData();e.renderable.mapScalars(n,1),t.updateCellArrayMappers(n)}},t.updateCellArrayMappers=r=>{if(!r){dn("No input!");return}const n=[r.getVerts(),r.getLines(),r.getPolys(),r.getStrips()],a=[];let s=0;for(let i=W.Points;i<=W.TriangleStrips;i++)if(n[i].getNumberOfValues()>0){e.primitives[i]||(e.primitives[i]=t.createCellArrayMapper());const o=e.primitives[i];o.setCellArray(n[i]),o.setCurrentInput(r),o.setCellOffset(s),o.setPrimitiveType(i),o.setRenderable(e.renderable),s+=n[i].getNumberOfCells(),a.push(o)}else e.primitives[i]=null;if(e.WebGPUActor.getRenderable().getProperty().getEdgeVisibility()){if(n[W.Triangles].getNumberOfValues()>0){const i=W.TriangleEdges;e.primitives[i]||(e.primitives[i]=t.createCellArrayMapper());const o=e.primitives[i];o.setCellArray(n[W.Triangles]),o.setCurrentInput(r),o.setCellOffset(e.primitives[W.Triangles].getCellOffset()),o.setPrimitiveType(i),o.setRenderable(e.renderable),a.push(o)}else e.primitives[W.TriangleEdges]=null;if(n[W.TriangleStrips].getNumberOfValues()>0){const i=W.TriangleStripEdges;e.primitives[i]||(e.primitives[i]=t.createCellArrayMapper());const o=e.primitives[i];o.setCellArray(n[W.TriangleStrips]),o.setCurrentInput(r),o.setCellOffset(e.primitives[W.TriangleStrips].getCellOffset()),o.setPrimitiveType(i),o.setRenderable(e.renderable),a.push(o)}else e.primitives[W.TriangleStripEdges]=null}t.prepareNodes(),t.addMissingChildren(a),t.removeUnusedNodes()}}const ti={primitives:null};function ri(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,ti,r),Q.extend(t,e,r),e.primitives=[],ei(t,e)}const ni=J(ri,"vtkWebGPUPolyDataMapper");ve("vtkMapper",ni);const{PrimitiveTypes:ur}=wt;function ai(t,e){e.classHierarchy.push("vtkWebGPUPolyDataMapper2D"),t.createCellArrayMapper=()=>Fr.newInstance(),t.buildPass=r=>{if(r){e.WebGPUActor=t.getFirstAncestorOfType("vtkWebGPUActor2D"),e.renderable.getStatic()||e.renderable.update();const n=e.renderable.getInputData();e.renderable.mapScalars(n,1),t.updateCellArrayMappers(n)}},t.updateCellArrayMappers=r=>{const n=[r.getVerts(),r.getLines(),r.getPolys(),r.getStrips()],a=[];let s=0;for(let i=ur.Points;i<=ur.Triangles;i++)if(n[i].getNumberOfValues()>0){e.primitives[i]||(e.primitives[i]=t.createCellArrayMapper());const o=e.primitives[i];o.setCellArray(n[i]),o.setCurrentInput(r),o.setCellOffset(s),o.setPrimitiveType(i),o.setRenderable(e.renderable),o.setIs2D(!0),s+=n[i].getNumberOfCells(),a.push(o)}else e.primitives[i]=null;t.prepareNodes(),t.addMissingChildren(a),t.removeUnusedNodes()}}function si(t){return{primitives:[],...t}}function ii(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,si(r)),Q.extend(t,e,r),e.primitives=[],ai(t,e)}const oi=J(ii,"vtkWebGPUPolyDataMapper2D");ve("vtkMapper2D",oi);function ci(t,e){e.classHierarchy.push("vtkWebGPUScalarBarActor"),t.buildPass=r=>{r&&(e.WebGPURenderer=t.getFirstAncestorOfType("vtkWebGPURenderer"),e.WebGPURenderWindow=e.WebGPURenderer.getParent(),e.scalarBarActorHelper.getRenderable()||e.scalarBarActorHelper.setRenderable(e.renderable),t.prepareNodes(),t.addMissingNode(e.scalarBarActorHelper.getBarActor()),t.addMissingNode(e.scalarBarActorHelper.getTmActor()),t.removeUnusedNodes())},t.opaquePass=(r,n)=>{if(r){const a=e.WebGPURenderer?e.WebGPURenderer.getRenderable().getActiveCamera():null,s=e.WebGPURenderer.getTiledSizeAndOrigin();e.scalarBarActorHelper.updateAPISpecificData([s.usize,s.vsize],a,e.WebGPURenderWindow.getRenderable())}}}const ui={};function fi(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,ui,r),Q.extend(t,e,r),e.scalarBarActorHelper=Gr.newScalarBarActorHelper(),ci(t,e)}const gi=J(fi,"vtkWebGPUScalarBarActor");ve("vtkScalarBarActor",gi);function li(t,e){e.classHierarchy.push("vtkWebGPUTextureView"),t.create=(r,n)=>{e.texture=r,e.options=n,e.options.dimension=e.options.dimension||"2d",e.options.label=e.label,e.textureHandle=r.getHandle(),e.handle=e.textureHandle.createView(e.options),e.bindGroupLayoutEntry.texture.viewDimension=e.options.dimension;const a=ie.getDetailsFromTextureFormat(e.texture.getFormat());e.bindGroupLayoutEntry.texture.sampleType=a.sampleType},t.createFromTextureHandle=(r,n)=>{e.texture=null,e.options=n,e.options.dimension=e.options.dimension||"2d",e.options.label=e.label,e.textureHandle=r,e.handle=e.textureHandle.createView(e.options),e.bindGroupLayoutEntry.texture.viewDimension=e.options.dimension;const a=ie.getDetailsFromTextureFormat(n.format);e.bindGroupLayoutEntry.texture.sampleType=a.sampleType,e.bindGroupTime.modified()},t.getBindGroupEntry=()=>({resource:t.getHandle()}),t.getShaderCode=(r,n)=>{let a="f32";e.bindGroupLayoutEntry.texture.sampleType==="sint"?a="i32":e.bindGroupLayoutEntry.texture.sampleType==="uint"&&(a="u32");let s=`@binding(${r}) @group(${n}) var ${e.label}: texture_${e.options.dimension}<${a}>;`;return e.bindGroupLayoutEntry.texture.sampleType==="depth"&&(s=`@binding(${r}) @group(${n}) var ${e.label}: texture_depth_${e.options.dimension};`),s},t.addSampler=(r,n)=>{const a=xn.newInstance({label:`${e.label}Sampler`});a.create(r,n),t.setSampler(a)},t.getBindGroupTime=()=>(e.texture&&e.texture.getHandle()!==e.textureHandle&&(e.textureHandle=e.texture.getHandle(),e.handle=e.textureHandle.createView(e.options),e.bindGroupTime.modified()),e.bindGroupTime),t.getHandle=()=>(e.texture&&e.texture.getHandle()!==e.textureHandle&&(e.textureHandle=e.texture.getHandle(),e.handle=e.textureHandle.createView(e.options),e.bindGroupTime.modified()),e.handle)}const pi={texture:null,handle:null,sampler:null,label:null};function Ir(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,pi,r),C.obj(t,e),e.bindGroupLayoutEntry={visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,texture:{sampleType:"float",viewDimension:"2d"}},e.bindGroupTime={},C.obj(e.bindGroupTime,{mtime:0}),C.get(t,e,["bindGroupTime","texture"]),C.setGet(t,e,["bindGroupLayoutEntry","label","sampler"]),li(t,e)}const hi=C.newInstance(Ir);var di={newInstance:hi,extend:Ir};function xi(t,e){e.classHierarchy.push("vtkWebGPUTexture"),t.create=(r,n)=>{e.device=r,e.width=n.width,e.height=n.height,e.depth=n.depth?n.depth:1;const a=e.depth===1?"2d":"3d";e.format=n.format?n.format:"rgba8unorm",e.mipLevel=n.mipLevel?n.mipLevel:0,e.usage=n.usage?n.usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST,e.handle=e.device.getHandle().createTexture({size:[e.width,e.height,e.depth],format:e.format,usage:e.usage,label:e.label,dimension:a,mipLevelCount:e.mipLevel+1})},t.assignFromHandle=(r,n,a)=>{e.device=r,e.handle=n,e.width=a.width,e.height=a.height,e.depth=a.depth?a.depth:1,e.format=a.format?a.format:"rgba8unorm",e.usage=a.usage?a.usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST},t.writeImageData=r=>{let n=[];const a=f=>{e.device.getHandle().queue.copyExternalImageToTexture({source:f,flipY:r.flip},{texture:e.handle,premultipliedAlpha:!0,mipLevel:0,origin:{x:0,y:0,z:0}},[f.width,f.height,e.depth]),t.getDimensionality()!==3&&e.mipLevel>0&&ge.generateMipmaps(e.device.getHandle(),e.handle,e.mipLevel+1),e.ready=!0};if(r.canvas){a(r.canvas);return}if(r.imageBitmap){r.width=r.imageBitmap.width,r.height=r.imageBitmap.height,r.depth=1,r.format="rgba8unorm",r.flip=!0,a(r.imageBitmap);return}if(r.jsImageData){r.width=r.jsImageData.width,r.height=r.jsImageData.height,r.depth=1,r.format="rgba8unorm",r.flip=!0,a(r.jsImageData);return}if(r.image){r.width=r.image.width,r.height=r.image.height,r.depth=1,r.format="rgba8unorm",r.flip=!0,a(r.image);return}const s=ie.getDetailsFromTextureFormat(e.format);let i=e.width*s.stride;const o=(f,p,l)=>{const h=s.elementSize===2&&s.sampleType==="float",x=f.BYTES_PER_ELEMENT,d=f.length/(p*l)*x;if(!h&&d%256===0)return[f,d];const T=d/x,b=s.elementSize,m=256*Math.floor((T*b+255)/256),v=m/b,y=C.newTypedArray(h?"Uint16Array":f.constructor.name,v*p*l),S=p*l;if(h)for(let M=0;M<S;M++){const B=M*T,N=M*v;for(let _=0;_<T;_++)y[N+_]=yn.toHalf(f[B+_])}else if(v===T)y.set(f);else for(let M=0;M<S;M++)y.set(f.subarray(M*T,(M+1)*T),M*v);return[y,m]};r.nativeArray&&(n=r.nativeArray);const c=t.getDimensionality()===3,u=o(n,e.height,c?e.depth:1);i=u[1];const g=u[0];e.device.getHandle().queue.writeTexture({texture:e.handle,mipLevel:0,origin:{x:0,y:0,z:0}},g,{offset:0,bytesPerRow:i,rowsPerImage:e.height},{width:e.width,height:e.height,depthOrArrayLayers:c?e.depth:1}),!c&&e.mipLevel>0&&ge.generateMipmaps(e.device.getHandle(),e.handle,e.mipLevel+1),e.ready=!0},t.getScale=()=>{const r=ie.getDetailsFromTextureFormat(e.format);return r.elementSize===2&&r.sampleType==="float"?1:255},t.getNumberOfComponents=()=>ie.getDetailsFromTextureFormat(e.format).numComponents,t.getDimensionality=()=>{let r=0;return e.width>1&&r++,e.height>1&&r++,e.depth>1&&r++,r},t.resizeToMatch=r=>{(r.getWidth()!==e.width||r.getHeight()!==e.height||r.getDepth()!==e.depth)&&(e.width=r.getWidth(),e.height=r.getHeight(),e.depth=r.getDepth(),e.handle=e.device.getHandle().createTexture({size:[e.width,e.height,e.depth],format:e.format,usage:e.usage,label:e.label}))},t.resize=function(r,n){let a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;(r!==e.width||n!==e.height||a!==e.depth)&&(e.width=r,e.height=n,e.depth=a,e.handle=e.device.getHandle().createTexture({size:[e.width,e.height,e.depth],format:e.format,usage:e.usage,label:e.label}))},t.createView=function(r){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};n.dimension||(n.dimension=e.depth===1?"2d":"3d");const a=di.newInstance({label:r});return a.create(t,n),a}}const yi={device:null,handle:null,buffer:null,ready:!1,label:null};function mi(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,yi,r),C.obj(t,e),C.get(t,e,["handle","ready","width","height","depth","format","usage"]),C.setGet(t,e,["device","label"]),xi(t,e)}C.newInstance(mi);function vi(t){if(!t||t.data.length===0)throw new Error("Invalid contour set data, see publicContourSetData type for more info");if(!t.id)throw new Error("Invalid contour set data, each contour set must have an id");if(!t.data||!Array.isArray(t.data))throw new Error("Invalid contour set data, each contour set must have an array of contours");t.data.forEach(e=>{if(!e.points||!Array.isArray(e.points))throw new Error("Invalid contour set data, each contour must have an array of points");e.points.forEach(r=>{if(!r||!Array.isArray(r)||r.length!==3)throw new Error("Invalid contour set data, each point must be an array of length 3")})})}class fr{constructor(e){const{points:r,type:n}=e.data;this.id=e.id,this._points=r,this._type=n,this._color=e.color,this._segmentIndex=e.segmentIndex,this.sizeInBytes=this._getSizeInBytes()}_getSizeInBytes(){return this._points.length*3}get points(){return this._points}set points(e){this._points=e}get color(){return this._color}set color(e){this._color=e}get type(){return this._type}set type(e){this._type=e}get segmentIndex(){return this._segmentIndex}set segmentIndex(e){this._segmentIndex=e}get flatPointsArray(){return this._points.map(e=>[...e]).flat()}}class Ti{constructor(e){this._color=[200,0,0],this.id=e.id,this._contours=[],this._color=e.color??this._color,this.frameOfReferenceUID=e.frameOfReferenceUID,this._segmentIndex=e.segmentIndex,this._createEachContour(e.data),this.sizeInBytes=this._getSizeInBytes()}_createEachContour(e){e.forEach(r=>{const{points:n,type:a,color:s}=r,i=new fr({id:`${this.id}-segment-${this._segmentIndex}`,data:{points:n,type:a,segmentIndex:this._segmentIndex,color:s??this._color},segmentIndex:this._segmentIndex,color:s??this._color});this._contours.push(i)}),this._updateContourSetCentroid()}_updateContourSetCentroid(){const e=this.totalNumberOfPoints,r=this.flatPointsArray,n=r.reduce((i,o)=>[i[0]+o[0],i[1]+o[1],i[2]+o[2]],[0,0,0]),a=[n[0]/e,n[1]/e,n[2]/e],s=r.reduce((i,o)=>{const c=this._getDistance(a,o),u=this._getDistance(a,i);return c<u?o:i},r[0]);this._centroid=s}_getSizeInBytes(){return this._contours.reduce((e,r)=>e+r.sizeInBytes,0)}_getDistance(e,r){return Math.sqrt((e[0]-r[0])**2+(e[1]-r[1])**2+(e[2]-r[2])**2)}get centroid(){return this._centroid}get segmentIndex(){return this._segmentIndex}get color(){return this._color}set color(e){this._color=e,this._contours.forEach(r=>{r instanceof fr&&(r.color=e)})}get contours(){return this._contours}get flatPointsArray(){return this._contours.flatMap(e=>e.points)}get numberOfContours(){return this._contours.length}get totalNumberOfPoints(){return this._contours.reduce((e,r)=>e+r.points.length,0)}get numberOfPointsArray(){return this._contours.map(e=>e.points.length)}getPointsInContour(e){return this._contours[e].points}getNumberOfPointsInAContour(e){return this.getPointsInContour(e).length}}function Ci(t,e){vi(e);const r=new Ti({id:e.id,data:e.data,color:e.color,frameOfReferenceUID:e.frameOfReferenceUID,segmentIndex:e.segmentIndex??1});return{id:t,type:he.CONTOUR,data:r,sizeInBytes:r.sizeInBytes}}function Si(t){if(!t.id)throw new Error("Surface must have an id");if(t.points?.length===0)throw new Error("Surface must have non-empty points array");if(t.polys?.length===0)throw new Error("Surface must have non-empty polys array");if(!t.frameOfReferenceUID)throw new Error("Surface must have a frameOfReferenceUID")}function bi(t,e){Si(e);const r=new On({id:e.id,points:e.points,polys:e.polys,color:e.color,frameOfReferenceUID:e.frameOfReferenceUID,segmentIndex:e.segmentIndex??1});return{id:t,type:he.SURFACE,data:r,sizeInBytes:r.sizeInBytes}}function wi(t){if(!t.id)throw new Error("Mesh must have an id");if(!t.arrayBuffer)throw new Error("Mesh must have an arrayBuffer");if(!(t.format in Y))throw new Error(`Mesh format must be one of the following: ${Object.values(Y).join(", ")}`)}function Di(t,e){e.classHierarchy.push("vtkMTLReader");function r(){e.requestCount--,e.requestCount===0&&t.invokeBusy(!1)}function n(s){if(s[0]==="#"||s.length===0)return;const i=s.split(/[ \t]+/).map(o=>o.trim()).filter(o=>o.length);if(i[0]==="newmtl")i.shift(),e.currentMaterial=i.join(" ").trim();else if(e.currentMaterial){if(i.length<2)return;if(e.materials[e.currentMaterial]||(e.materials[e.currentMaterial]={}),e.materials[e.currentMaterial][i[0]]=i.slice(1),i[0]==="map_Kd"){const o=new Image;o.onload=()=>setTimeout(r,0),o.src=[e.baseURL,i[1]].join("/"),e.materials[e.currentMaterial].image=o,e.requestCount++}}}e.dataAccessHelper||(e.dataAccessHelper=rt.get("http"));function a(s,i){return e.dataAccessHelper.fetchText(t,s,i)}t.setUrl=function(s){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(s.indexOf(".mtl")===-1&&!i.fullpath)e.baseURL=s,e.url=`${s}/index.mtl`;else{e.url=s;const o=s.split("/");o.pop(),e.baseURL=o.join("/")}return t.loadData(i)},t.loadData=s=>new Promise((i,o)=>{a(e.url,s).then(c=>{t.parseAsText(c),i()},c=>{o()})}),t.parseAsText=s=>{t.modified(),e.materials={},s.split(`
`).forEach(n)},t.isBusy=()=>!!e.requestCount,t.getMaterialNames=()=>Object.keys(e.materials),t.getMaterial=s=>e.materials[s],t.listImages=()=>Object.keys(e.materials).map(s=>e.materials[s].map_Kd).filter(s=>!!s).map(s=>s[0].trim()),t.setImageSrc=(s,i)=>new Promise((o,c)=>{const u=Object.keys(e.materials).find(f=>e.materials[f].map_Kd&&e.materials[f].map_Kd[0].trim()===s.trim()),g=e.materials[u];g&&g.image?(g.image.src=i,g.image.onload=()=>setTimeout(o,0)):o()}),t.applyMaterialToActor=(s,i)=>{const o=e.materials[s];if(o&&i){const c=[1,1,1],u={ambientColor:o.Ka?o.Ka.map(f=>Number(f)):c,specularColor:o.Ks?o.Ks.map(f=>Number(f)):c,diffuseColor:o.Kd?o.Kd.map(f=>Number(f)):c,opacity:o.d?Number(o.d):1,specularPower:o.Ns?Number(o.Ns):1},g=Number(o.illum||2);if(["ambient","diffuse","specular"].forEach((f,p)=>{u[f]=p<=g?1:0}),o.image){const f=ge.newInstance({interpolate:e.interpolateTextures});f.setImage(o.image),i.addTexture(f)}i.getProperty().set(u)}}}const Oi={numberOfOutputs:1,requestCount:0,materials:{},interpolateTextures:!0};function zr(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(e,Oi,r),dr(t,e),mn(t,e,["url","baseURL"]),St(t,e,["dataAccessHelper","interpolateTextures","splitGroup"]),vn(t,e,"busy"),Di(t,e)}const Vi=J(zr,"vtkMTLReader");var Mi={newInstance:Vi,extend:zr};function Wr(t,e){wi(e);const r=new Qn({...e}),n={id:t,type:he.MESH,data:r,sizeInBytes:r.sizeInBytes};switch(e.format){case Y.PLY:if(e.materialUrl){const a=new Image;return new Promise((s,i)=>{a.onload=()=>{try{const o=ge.newInstance();o.setInterpolate(!0),o.setImage(a),r.defaultActor.addTexture(o),s(n)}catch(o){i(o)}},a.onerror=o=>i(o),a.src=e.materialUrl})}return Promise.resolve(n);case Y.OBJ:if(e.materialUrl){const a=Mi.newInstance();return a.setUrl(e.materialUrl).then(()=>{for(let s=0;s<r.actors.length;s++){const i=r.actors[s],o=i.getMapper();if(o){const c=o.getInputData();if(c){const u=c.get("name").name;a.applyMaterialToActor(u,i)}}}return n}).catch(s=>{throw new Error(`Failed to load material: ${s}`)})}return Promise.resolve(n);case Y.STL:case Y.VTP:return Promise.resolve(n);default:return Promise.reject(new Error(`Unsupported format: ${e.format}`))}}function ki({url:t,signal:e,onload:r,loaderOptions:n}){return new Promise(async(a,s)=>{const i=new XMLHttpRequest;i.open("GET",t,!0);const o={},c=await n.beforeSend(i,o),u=Object.assign({},o,c);i.responseType="arraybuffer",Object.keys(u).forEach(function(l){u[l]!==null&&i.setRequestHeader(l,u[l])});const g=function(l){r&&typeof r=="function"&&r(),e&&e.removeEventListener("abort",f),a(i.response)},f=()=>{i.abort(),i.removeEventListener("load",g),s(new Error("Request aborted"))};i.addEventListener("load",g);const p=(l,h)=>{const x={url:t,loaded:l,total:h};ce(xe,ue.GEOMETRY_LOAD_PROGRESS,{data:x})};i.onprogress=function(l){p(l.loaded,l.total)},e&&e.aborted?(i.abort(),s(new Error("Request aborted"))):e&&e.addEventListener("abort",f),i.send()})}function Bi(t,e,r){return{promise:new Promise((a,s)=>{Ri(t,e,r).then(a).catch(s)}),cancelFn:void 0,decache:()=>{}}}async function Ri(t,e,r){const a=t.split(":").slice(1).join(":"),s=await ki({url:a,loaderOptions:r});if(!e||!("geometryData"in e))throw new Error("Mesh must have a geometryData");return Wr(a,{...e.geometryData,arrayBuffer:s})}let tt={beforeSend(t){}};function Li(t){tt=Object.assign(tt,t)}function Ui(){return tt}const $r={};let we;function Hr(t,e){const r=t.indexOf(":"),n=t.substring(0,r);let a=$r[n];if(a==null){if(we==null||typeof we!="function")throw new Error(`No geometry loader for scheme ${n} has been registered`);a=we}const s=a(t,e,tt);return s.promise.then(function(i){ce(xe,ue.GEOMETRY_LOADED,{geometry:i})},function(i){const o={geometryId:t,error:i};ce(xe,ue.GEOMETRY_LOADED_FAILED,o)}),s}function Ni(t,e){if(t===void 0)throw new Error("loadGeometry: parameter geometryId must not be undefined");let r=Oe.getGeometryLoadObject(t);return r!==void 0||(r=Hr(t,e)),r.promise}async function Pi(t,e){if(t===void 0)throw new Error("createAndCacheGeometry: parameter geometryId must not be undefined");let r=Oe.getGeometryLoadObject(t);return r!==void 0||(r=Hr(t,e),await Oe.putGeometryLoadObject(t,r)),r.promise}function Ai(t,e){if(t===void 0)throw new Error("createAndCacheGeometry: parameter geometryId must not be undefined");let r=Oe.getGeometry(t);if(r)return r;if(e.type===he.CONTOUR)r=Ci(t,e.geometryData);else if(e.type===he.SURFACE)r=bi(t,e.geometryData);else if(e.type===he.MESH)Wr(t,e.geometryData).then(n=>{r=n});else throw new Error(`Unknown geometry type: ${e.type}`);return Oe.putGeometrySync(t,r),r}function Kr(t,e){$r[t]=e}function Ei(t){const e=we;return we=t,e}Kr("mesh",Bi);const Wi=Object.freeze(Object.defineProperty({__proto__:null,createAndCacheGeometry:Ai,getOptions:Ui,loadAndCacheGeometry:Pi,loadGeometry:Ni,registerGeometryLoader:Kr,registerUnknownGeometryLoader:Ei,setOptions:Li},Symbol.toStringTag,{value:"Module"}));function $i(t,e){if(!e||!e.imageIds||!e.imageIds.length)throw new Error("ImageIds must be provided to create a 4D streaming image volume");const{imageIds:r}=e,{splittingTag:n,imageIdGroups:a}=Tn(r),s=Math.floor(a.length/2),i=Cn(a[s],t),{metadata:o,dimensions:c,spacing:u,direction:g,sizeInBytes:f,origin:p,numberOfComponents:l,dataType:h}=i,x=g.slice(6,9),d=a.map(v=>Sn(v,x).sortedImageIds),T=d.flat(),b=bn.createScalarDynamicVolumeVoxelManager({dimensions:c,imageIdGroups:d,dimensionGroupNumber:1,numberOfComponents:l});let m=new ea({volumeId:t,metadata:o,dimensions:c,spacing:u,origin:p,direction:g,sizeInBytes:f,imageIds:T,imageIdGroups:d,splittingTag:n,voxelManager:b,numberOfComponents:l,dataType:h},{imageIds:T,loadStatus:{loaded:!1,loading:!1,cancelled:!1,cachedFrames:[],callbacks:[]}});return{promise:Promise.resolve(m),decache:()=>{m.destroy(),m=null},cancel:()=>{m.cancelLoading()}}}export{qr as BaseRenderingEngine,ji as BaseVolumeViewport,Yi as CONSTANTS,Nt as ContextPoolRenderingEngine,qi as EPSILON,ue as EVENTS,Xi as Enums,Zi as ImageVolume,Ji as ProgressiveRetrieveImages,Ii as RenderingEngine,Eo as Settings,Xr as StackViewport,ea as StreamingDynamicImageVolume,Qi as StreamingImageVolume,On as Surface,Qr as TiledRenderingEngine,eo as VideoViewport,to as Viewport,Zr as VolumeViewport,Jr as VolumeViewport3D,ro as WSIViewport,Go as addImageSlicesToViewports,_o as addVolumesToViewports,Oe as cache,no as canRenderFloatTextures,ao as convertMapperToNotSharedMapper,Bi as cornerstoneMeshLoader,$i as cornerstoneStreamingDynamicImageVolumeLoader,so as cornerstoneStreamingImageVolumeLoader,io as createCanvas,oo as createViewportElement,co as createVolumeActor,uo as createVolumeMapper,xe as eventTarget,Wi as geometryLoader,gr as getConfiguration,fo as getEnabledElement,go as getEnabledElementByIds,lo as getEnabledElementByViewportId,po as getEnabledElements,at as getOrCreateCanvas,ho as getRenderingEngine,xo as getRenderingEngines,yo as getShouldUseCPURendering,mo as getWebWorkerManager,vo as imageLoadPoolManager,To as imageLoader,Io as imageRetrievalPoolManager,Co as init,So as isCornerstoneInitialized,bo as metaData,wo as peerImport,Do as registerImageLoader,Oo as requestPoolManager,Vo as resetInitialization,Mo as resetUseCPURendering,ko as setCanvasCreator,Bo as setConfiguration,Ro as setPreferSizeOverAccuracy,Lo as setUseCPURendering,Uo as setVolumesForViewports,ce as triggerEvent,No as utilities,zi as version,Po as volumeLoader};
