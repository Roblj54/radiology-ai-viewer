const w={BASE_URL:"/radiology-ai-viewer/",DEV:!1,MODE:"production",PROD:!0,SSR:!1};function l(e){return Math.max(0,Math.min(1,e))}function g(){const t=new URLSearchParams(location.search).get("api");if(t)return t;try{if(w?.VITE_AI_API_BASE)return}catch{}const n=localStorage.getItem("AI_API_BASE");return n||"http://localhost:8787"}function A(e){localStorage.setItem("AI_API_BASE",e)}function y(){return document.getElementById("dicomViewport")||document.getElementById("viewport")||document.querySelector("[data-viewport]")||(document.querySelector("canvas")?document.querySelector("canvas").parentElement:null)}function I(e){return e?e.querySelector("canvas")||document.querySelector("canvas"):null}function C(e){let t=e.querySelector(".ai-server-overlay");return t||(e.style.position=e.style.position||"relative",t=document.createElement("div"),t.className="ai-server-overlay",t.style.cssText="position:absolute; inset:0; pointer-events:none; z-index:9999;",e.appendChild(t)),t}function E(e){const t=e?.querySelector?.(".ai-server-overlay");t&&(t.innerHTML="")}function P(e,t){const n=C(e);n.innerHTML="";const o=e.getBoundingClientRect(),r=o.width,a=o.height;(t||[]).forEach(s=>{const i=s.x,d=s.y,p=s.w,u=s.h,c=i<=1&&d<=1&&p<=1&&u<=1,f=c?l(i)*r:i,b=c?l(d)*a:d,h=c?l(p)*r:p,v=c?l(u)*a:u,x=document.createElement("div");x.style.cssText=`position:absolute; left:${f}px; top:${b}px; width:${h}px; height:${v}px;border:2px solid rgba(0,255,255,0.95); border-radius:8px;box-shadow:0 0 0 1px rgba(0,0,0,0.25) inset;`;const m=document.createElement("div"),S=typeof s.score=="number"?` (${Math.round(s.score*100)}%)`:"";m.textContent=(s.label||"Finding")+S,m.style.cssText="position:absolute; left:0; top:-22px; padding:3px 6px; border-radius:8px;background:rgba(255,255,255,0.92); color:#111; font:700 12px/1 system-ui;border:1px solid rgba(255,255,255,0.35);",x.appendChild(m),n.appendChild(x)})}async function _(){const e=y();if(!e){alert("Viewport container not found.");return}const t=I(e);if(!t||typeof t.toDataURL!="function"){alert("Canvas not ready. Load a DICOM series first.");return}const o=(g()||"").replace(/\/+$/,"")+"/analyze",r=t.toDataURL("image/png");try{const a=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image:r,meta:{ts:Date.now()}})});if(!a.ok){const i=await a.text();throw new Error(`API error ${a.status}: ${i}`)}const s=await a.json();P(e,s.boxes||[])}catch(a){console.warn(a),alert("AI API call failed. Check API URL and CORS, then try again.")}}function B(){let e=document.getElementById("aiServerPanel");if(e)return e;e=document.createElement("div"),e.id="aiServerPanel",e.style.cssText="position:fixed; top:12px; right:12px; z-index:1000000;display:flex; gap:8px; align-items:center;background:rgba(15,23,42,0.55); border:1px solid rgba(148,163,184,0.35);padding:10px; border-radius:14px; backdrop-filter:blur(8px);";const t=document.createElement("input");t.type="text",t.value=g(),t.placeholder="AI API base URL",t.style.cssText="width:320px; max-width:45vw; padding:8px 10px; border-radius:10px;border:1px solid rgba(148,163,184,0.45); background:rgba(255,255,255,0.92);color:#111; font:600 12px/1 system-ui; outline:none;";const n=document.createElement("button");n.textContent="Save API",n.style.cssText="padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.35);background:rgba(255,255,255,0.92); color:#111; font:800 12px/1 system-ui; cursor:pointer;",n.onclick=()=>{A(t.value.trim()),alert("Saved API URL.")};const o=document.createElement("button");o.textContent="AI Analyze",o.style.cssText="padding:8px 10px; border-radius:10px; border:1px solid rgba(0,255,255,0.55);background:rgba(255,255,255,0.92); color:#111; font:900 12px/1 system-ui; cursor:pointer;",o.onclick=()=>_();const r=document.createElement("button");return r.textContent="Clear",r.style.cssText="padding:8px 10px; border-radius:10px; border:1px solid rgba(148,163,184,0.45);background:rgba(255,255,255,0.92); color:#111; font:800 12px/1 system-ui; cursor:pointer;",r.onclick=()=>E(y()),e.appendChild(t),e.appendChild(n),e.appendChild(o),e.appendChild(r),document.body.appendChild(e),e}function T(){B()}export{T as installAIServerPanel};
