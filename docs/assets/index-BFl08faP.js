import{a_ as fs,a$ as FI,b0 as BI,t as gt,e as z,aC as Gt,b1 as Ro,az as te,aA as Co,aB as y,b2 as Xt,at as Qo,b3 as xe,b4 as GI,aE as At,au as ve,ag as X,b5 as Sg,b6 as WI,b7 as $I,h as Eo,b8 as Bc,n as xi,o as yi,b9 as ye,S as Ie,ba as To,bb as qa,bc as W,bd as me,D as dt,E as ut,C as Zt,aL as Rt,be as xa,u as hn,bf as Pt,bg as Ft,bh as et,bi as Xn,bj as ua,bk as mo,bl as jt,bm as be,bn as Tl,s as oe,bo as sn,bp as _g,bq as We,br as Kn,bs as Gc,aD as HI,ad as zI,bt as jI,bu as XI,aV as YI,bv as $o,aF as qI,c as ae,as as fr,bw as wt,bx as Pl,by as yn,bz as Be,bA as Je,bB as Wc,bC as Ml,bD as Dg,bE as we,bF as bg,bG as ks,bH as Wt,aq as ti,bI as ei,bJ as xl,bK as Tg,bL as po,bM as KI,bN as ZI,bO as Te,bP as le,bQ as _t,bR as Pg,i as Zn,bS as Mg,bT as JI,O as So,bU as mr,bV as QI,r as Se,bW as xg,bX as t0,bY as yg,bZ as yl,b_ as Fo,b$ as Ag,c0 as pr,c1 as $c,c2 as e0,c3 as n0,w as je,c4 as Og,c5 as xn,c6 as In,ak as Al,c7 as Ol,c8 as Lg,c9 as o0,ca as i0,cb as a0,cc as s0,aw as Rg,cd as ya,ce as r0,cf as c0,y as l0,cg as d0,ch as u0,ci as h0,aN as Aa,cj as Ng,ck as Qr,cl as Ug,cm as Ll,cn as g0,co as f0,cp as kg,cq as Vg,cr as tc,cs as m0,ct as p0,cu as fu,cv as v0,cw as I0,cx as w0,a2 as Ai,cy as Yo,l as st,m as Mt,cz as ec,cA as Wn,cB as mu,cC as C0,cD as E0,cE as S0,cF as _0,W as Fg,cG as uo,cH as Re,V as Rl,cI as pu,g as D0,cJ as b0,j as pn,cK as ms,cL as T0,cM as P0,cN as Hc,cO as Vs,cP as vu,cQ as M0,cR as Iu,cS as x0,cT as y0,aW as _i,cU as A0,cV as wu,cW as Cu,ai as O0,ay as L0,cX as R0,cY as N0,cZ as U0,c_ as k0,c$ as V0,d0 as zc,d1 as Eu}from"./index-Cp4iUYqv.js";import{S as Bg,b as F0,c as B0,a as G0,v as W0}from"./Texture-C9D3AFRO.js";function $0(i,t){let n;if(t===void 0)for(const e of i)e!=null&&(n>e||n===void 0&&e>=e)&&(n=e);else{let e=-1;for(let o of i)(o=t(o,++e,i))!=null&&(n>o||n===void 0&&o>=o)&&(n=o)}return n}function H0(i){if(!(a=i.length))return[];for(var t=-1,n=$0(i,z0),e=new Array(n);++t<n;)for(var o=-1,a,s=e[t]=new Array(a);++o<a;)s[o]=i[o][t];return e}function z0(i){return i.length}function Su(){return H0(arguments)}function j0(i,t,n,e,o){var a=i*i,s=a*i;return((1-3*i+3*a-s)*t+(4-6*a+3*s)*n+(1+3*i+3*a-3*s)*e+s*o)/6}function nc(i){var t=i.length-1;return function(n){var e=n<=0?n=0:n>=1?(n=1,t-1):Math.floor(n*t),o=i[e],a=i[e+1],s=e>0?i[e-1]:2*o-a,r=e<t-1?i[e+2]:2*a-o;return j0((n-e/t)*t,s,o,a,r)}}function ia(i,t){for(var n=new Array(t),e=0;e<t;++e)n[e]=i(e/(t-1));return n}var Nn;(function(i){i[i.Primary=1]="Primary",i[i.Secondary=2]="Secondary",i[i.Primary_And_Secondary=3]="Primary_And_Secondary",i[i.Auxiliary=4]="Auxiliary",i[i.Primary_And_Auxiliary=5]="Primary_And_Auxiliary",i[i.Secondary_And_Auxiliary=6]="Secondary_And_Auxiliary",i[i.Primary_And_Secondary_And_Auxiliary=7]="Primary_And_Secondary_And_Auxiliary",i[i.Fourth_Button=8]="Fourth_Button",i[i.Fifth_Button=16]="Fifth_Button",i[i.Wheel=524288]="Wheel",i[i.Wheel_Primary=524289]="Wheel_Primary"})(Nn||(Nn={}));var De;(function(i){i[i.Shift=16]="Shift",i[i.Ctrl=17]="Ctrl",i[i.Alt=18]="Alt",i[i.Meta=91]="Meta",i[i.ShiftCtrl=1617]="ShiftCtrl",i[i.ShiftAlt=1618]="ShiftAlt",i[i.ShiftMeta=1691]="ShiftMeta",i[i.CtrlAlt=1718]="CtrlAlt",i[i.CtrlMeta=1791]="CtrlMeta",i[i.AltMeta=1891]="AltMeta"})(De||(De={}));var Ot;(function(i){i.Active="Active",i.Passive="Passive",i.Enabled="Enabled",i.Disabled="Disabled"})(Ot||(Ot={}));var vn;(function(i){i.Default="",i.Highlighted="Highlighted",i.Selected="Selected",i.Locked="Locked",i.AutoGenerated="AutoGenerated"})(vn||(vn={}));var w;(function(i){i.TOOL_ACTIVATED="CORNERSTONE_TOOLS_TOOL_ACTIVATED",i.TOOLGROUP_VIEWPORT_ADDED="CORNERSTONE_TOOLS_TOOLGROUP_VIEWPORT_ADDED",i.TOOLGROUP_VIEWPORT_REMOVED="CORNERSTONE_TOOLS_TOOLGROUP_VIEWPORT_REMOVED",i.TOOL_MODE_CHANGED="CORNERSTONE_TOOLS_TOOL_MODE_CHANGED",i.CROSSHAIR_TOOL_CENTER_CHANGED="CORNERSTONE_TOOLS_CROSSHAIR_TOOL_CENTER_CHANGED",i.VOLUMECROPPINGCONTROL_TOOL_CHANGED="CORNERSTONE_TOOLS_VOLUMECROPPINGCONTROL_TOOL_CHANGED",i.VOLUMECROPPING_TOOL_CHANGED="CORNERSTONE_TOOLS_VOLUMECROPPING_TOOL_CHANGED",i.STACK_PREFETCH_COMPLETE="CORNERSTONE_TOOLS_STACK_PREFETCH_COMPLETE",i.ANNOTATION_ADDED="CORNERSTONE_TOOLS_ANNOTATION_ADDED",i.ANNOTATION_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_COMPLETED",i.ANNOTATION_MODIFIED="CORNERSTONE_TOOLS_ANNOTATION_MODIFIED",i.ANNOTATION_REMOVED="CORNERSTONE_TOOLS_ANNOTATION_REMOVED",i.ANNOTATION_SELECTION_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_SELECTION_CHANGE",i.ANNOTATION_LOCK_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_LOCK_CHANGE",i.ANNOTATION_VISIBILITY_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_VISIBILITY_CHANGE",i.ANNOTATION_RENDERED="CORNERSTONE_TOOLS_ANNOTATION_RENDERED",i.ANNOTATION_CUT_MERGE_PROCESS_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_CUT_MERGE_PROCESS_COMPLETED",i.ANNOTATION_INTERPOLATION_PROCESS_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_INTERPOLATION_PROCESS_COMPLETED",i.INTERPOLATED_ANNOTATIONS_REMOVED="CORNERSTONE_TOOLS_INTERPOLATED_ANNOTATIONS_REMOVED",i.SEGMENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_MODIFIED",i.SEGMENTATION_RENDERED="CORNERSTONE_TOOLS_SEGMENTATION_RENDERED",i.SEGMENTATION_REPRESENTATION_ADDED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_ADDED",i.SEGMENTATION_ADDED="CORNERSTONE_TOOLS_SEGMENTATION_ADDED",i.SEGMENTATION_REPRESENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_MODIFIED",i.SEGMENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REMOVED",i.SEGMENTATION_REPRESENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_REMOVED",i.SEGMENTATION_DATA_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_DATA_MODIFIED",i.HISTORY_UNDO="CORNERSTONE_TOOLS_HISTORY_UNDO",i.HISTORY_REDO="CORNERSTONE_TOOLS_HISTORY_REDO",i.KEY_DOWN="CORNERSTONE_TOOLS_KEY_DOWN",i.KEY_UP="CORNERSTONE_TOOLS_KEY_UP",i.MOUSE_DOWN="CORNERSTONE_TOOLS_MOUSE_DOWN",i.MOUSE_UP="CORNERSTONE_TOOLS_MOUSE_UP",i.MOUSE_DOWN_ACTIVATE="CORNERSTONE_TOOLS_MOUSE_DOWN_ACTIVATE",i.MOUSE_DRAG="CORNERSTONE_TOOLS_MOUSE_DRAG",i.MOUSE_MOVE="CORNERSTONE_TOOLS_MOUSE_MOVE",i.MOUSE_CLICK="CORNERSTONE_TOOLS_MOUSE_CLICK",i.MOUSE_DOUBLE_CLICK="CORNERSTONE_TOOLS_MOUSE_DOUBLE_CLICK",i.MOUSE_WHEEL="CORNERSTONE_TOOLS_MOUSE_WHEEL",i.TOUCH_START="CORNERSTONE_TOOLS_TOUCH_START",i.TOUCH_START_ACTIVATE="CORNERSTONE_TOOLS_TOUCH_START_ACTIVATE",i.TOUCH_PRESS="CORNERSTONE_TOOLS_TOUCH_PRESS",i.TOUCH_DRAG="CORNERSTONE_TOOLS_TOUCH_DRAG",i.TOUCH_END="CORNERSTONE_TOOLS_TOUCH_END",i.TOUCH_TAP="CORNERSTONE_TOOLS_TAP",i.TOUCH_SWIPE="CORNERSTONE_TOOLS_SWIPE"})(w||(w={}));var tt;(function(i){i.Labelmap="Labelmap",i.Contour="Contour",i.Surface="Surface"})(tt||(tt={}));var Bo;(function(i){i.UP="UP",i.DOWN="DOWN",i.LEFT="LEFT",i.RIGHT="RIGHT"})(Bo||(Bo={}));var J;(function(i){i.CalculateCursorGeometry="calculateCursorGeometry",i.RenderCursor="renderCursor",i.OnInteractionStart="onInteractionStart",i.OnInteractionEnd="onInteractionEnd",i.Preview="preview",i.RejectPreview="rejectPreview",i.AcceptPreview="acceptPreview",i.Fill="fill",i.Interpolate="interpolate",i.StrategyFunction="strategyFunction",i.CreateIsInThreshold="createIsInThreshold",i.Initialize="initialize",i.INTERNAL_setValue="setValue",i.AddPreview="addPreview",i.ComputeInnerCircleRadius="computeInnerCircleRadius",i.GetStatistics="getStatistics",i.EnsureImageVolumeFor3DManipulation="ensureImageVolumeFor3DManipulation",i.EnsureSegmentationVolumeFor3DManipulation="ensureSegmentationVolumeFor3DManipulation"})(J||(J={}));var lt;(function(i){i.Interaction="Interaction",i.HandlesUpdated="HandlesUpdated",i.StatsUpdated="StatsUpdated",i.InitialSetup="InitialSetup",i.Completed="Completed",i.InterpolationUpdated="InterpolationUpdated",i.History="History",i.MetadataReferenceModified="MetadataReferenceModified",i.LabelChange="LabelChange"})(lt||(lt={}));var Qe;(function(i){i.POLYSEG_CONTOUR_TO_LABELMAP="Converting Contour to Labelmap",i.POLYSEG_SURFACE_TO_LABELMAP="Converting Surfaces to Labelmap",i.POLYSEG_CONTOUR_TO_SURFACE="Converting Contour to Surface",i.POLYSEG_LABELMAP_TO_SURFACE="Converting Labelmap to Surface",i.SURFACE_CLIPPING="Clipping Surfaces",i.COMPUTE_STATISTICS="Computing Statistics",i.INTERPOLATE_LABELMAP="Interpolating Labelmap",i.COMPUTE_LARGEST_BIDIRECTIONAL="Computing Largest Bidirectional",i.GENERATE_CONTOUR_SETS="Generating Contour Sets"})(Qe||(Qe={}));var rn;(function(i){i.Linear="Linear",i.Area="Area",i.Volume="Volume",i.Pixel="Pixel"})(rn||(rn={}));const $2=Object.freeze(Object.defineProperty({__proto__:null,AnnotationStyleStates:vn,ChangeTypes:lt,Events:w,get KeyboardBindings(){return De},get MeasurementType(){return rn},get MouseBindings(){return Nn},SegmentationRepresentations:tt,StrategyCallbacks:J,get Swipe(){return Bo},ToolModes:Ot,WorkerTypes:Qe},Symbol.toStringTag,{value:"Module"}));let vr={};function X0(){vr={}}const _u={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:vr,enabledElements:[],handleRadius:6};let U={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:vr,enabledElements:[],handleRadius:6};function Y0(){X0(),U={...structuredClone({..._u,svgNodeCache:{}}),svgNodeCache:{..._u.svgNodeCache}}}var oc,Du;function q0(){if(Du)return oc;Du=1;var i="Expected a function",t="__lodash_hash_undefined__",n="[object Function]",e="[object GeneratorFunction]",o="[object Symbol]",a=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,s=/^\w*$/,r=/^\./,c=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,l=/[\\^$.*+?()[\]{}|]/g,d=/\\(\\)?/g,u=/^\[object .+?Constructor\]$/,h=typeof fs=="object"&&fs&&fs.Object===Object&&fs,g=typeof self=="object"&&self&&self.Object===Object&&self,f=h||g||Function("return this")();function m(F,Z){return F?.[Z]}function v(F){var Z=!1;if(F!=null&&typeof F.toString!="function")try{Z=!!(F+"")}catch{}return Z}var p=Array.prototype,I=Function.prototype,C=Object.prototype,E=f["__core-js_shared__"],S=(function(){var F=/[^.]+$/.exec(E&&E.keys&&E.keys.IE_PROTO||"");return F?"Symbol(src)_1."+F:""})(),_=I.toString,D=C.hasOwnProperty,b=C.toString,M=RegExp("^"+_.call(D).replace(l,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),P=f.Symbol,T=p.splice,x=Kt(f,"Map"),A=Kt(Object,"create"),O=P?P.prototype:void 0,R=O?O.toString:void 0;function N(F){var Z=-1,ct=F?F.length:0;for(this.clear();++Z<ct;){var Ht=F[Z];this.set(Ht[0],Ht[1])}}function k(){this.__data__=A?A(null):{}}function B(F){return this.has(F)&&delete this.__data__[F]}function V(F){var Z=this.__data__;if(A){var ct=Z[F];return ct===t?void 0:ct}return D.call(Z,F)?Z[F]:void 0}function $(F){var Z=this.__data__;return A?Z[F]!==void 0:D.call(Z,F)}function H(F,Z){var ct=this.__data__;return ct[F]=A&&Z===void 0?t:Z,this}N.prototype.clear=k,N.prototype.delete=B,N.prototype.get=V,N.prototype.has=$,N.prototype.set=H;function G(F){var Z=-1,ct=F?F.length:0;for(this.clear();++Z<ct;){var Ht=F[Z];this.set(Ht[0],Ht[1])}}function Y(){this.__data__=[]}function q(F){var Z=this.__data__,ct=Tt(Z,F);if(ct<0)return!1;var Ht=Z.length-1;return ct==Ht?Z.pop():T.call(Z,ct,1),!0}function j(F){var Z=this.__data__,ct=Tt(Z,F);return ct<0?void 0:Z[ct][1]}function K(F){return Tt(this.__data__,F)>-1}function it(F,Z){var ct=this.__data__,Ht=Tt(ct,F);return Ht<0?ct.push([F,Z]):ct[Ht][1]=Z,this}G.prototype.clear=Y,G.prototype.delete=q,G.prototype.get=j,G.prototype.has=K,G.prototype.set=it;function at(F){var Z=-1,ct=F?F.length:0;for(this.clear();++Z<ct;){var Ht=F[Z];this.set(Ht[0],Ht[1])}}function bt(){this.__data__={hash:new N,map:new(x||G),string:new N}}function Bt(F){return ee(this,F).delete(F)}function Yt(F){return ee(this,F).get(F)}function qt(F){return ee(this,F).has(F)}function Nt(F,Z){return ee(this,F).set(F,Z),this}at.prototype.clear=bt,at.prototype.delete=Bt,at.prototype.get=Yt,at.prototype.has=qt,at.prototype.set=Nt;function Tt(F,Z){for(var ct=F.length;ct--;)if(us(F[ct][0],Z))return ct;return-1}function Jt(F,Z){Z=ie(Z,F)?[Z]:ue(Z);for(var ct=0,Ht=Z.length;F!=null&&ct<Ht;)F=F[ea(Z[ct++])];return ct&&ct==Ht?F:void 0}function yt(F){if(!oa(F)||he(F))return!1;var Z=gs(F)||v(F)?M:u;return Z.test(Zr(F))}function Dt(F){if(typeof F=="string")return F;if(Ke(F))return R?R.call(F):"";var Z=F+"";return Z=="0"&&1/F==-1/0?"-0":Z}function ue(F){return hs(F)?F:xo(F)}function ee(F,Z){var ct=F.__data__;return He(Z)?ct[typeof Z=="string"?"string":"hash"]:ct.map}function Kt(F,Z){var ct=m(F,Z);return yt(ct)?ct:void 0}function ie(F,Z){if(hs(F))return!1;var ct=typeof F;return ct=="number"||ct=="symbol"||ct=="boolean"||F==null||Ke(F)?!0:s.test(F)||!a.test(F)||Z!=null&&F in Object(Z)}function He(F){var Z=typeof F;return Z=="string"||Z=="number"||Z=="symbol"||Z=="boolean"?F!=="__proto__":F===null}function he(F){return!!S&&S in F}var xo=na(function(F){F=yo(F);var Z=[];return r.test(F)&&Z.push(""),F.replace(c,function(ct,Ht,Tn,Pn){Z.push(Tn?Pn.replace(d,"$1"):Ht||ct)}),Z});function ea(F){if(typeof F=="string"||Ke(F))return F;var Z=F+"";return Z=="0"&&1/F==-1/0?"-0":Z}function Zr(F){if(F!=null){try{return _.call(F)}catch{}try{return F+""}catch{}}return""}function na(F,Z){if(typeof F!="function"||Z&&typeof Z!="function")throw new TypeError(i);var ct=function(){var Ht=arguments,Tn=Z?Z.apply(this,Ht):Ht[0],Pn=ct.cache;if(Pn.has(Tn))return Pn.get(Tn);var gu=F.apply(this,Ht);return ct.cache=Pn.set(Tn,gu),gu};return ct.cache=new(na.Cache||at),ct}na.Cache=at;function us(F,Z){return F===Z||F!==F&&Z!==Z}var hs=Array.isArray;function gs(F){var Z=oa(F)?b.call(F):"";return Z==n||Z==e}function oa(F){var Z=typeof F;return!!F&&(Z=="object"||Z=="function")}function Jr(F){return!!F&&typeof F=="object"}function Ke(F){return typeof F=="symbol"||Jr(F)&&b.call(F)==o}function yo(F){return F==null?"":Dt(F)}function Ao(F,Z,ct){var Ht=F==null?void 0:Jt(F,Z);return Ht===void 0?ct:Ht}return oc=Ao,oc}var K0=q0();const Z0=FI(K0),bu=Symbol("DefinedCursors"),Gg=new Set(["alias","all-scroll","auto","cell","col-resize","context-menu","copy","crosshair","default","e-resize","ew-resize","grab","grabbing","help","move","ne-resize","nesw-resize","no-drop","none","not-allowed","n-resize","ns-resize","nw-resize","nwse-resize","pointer","progress","row-resize","se-resize","s-resize","sw-resize","text","vertical-text","wait","w-resize","zoom-in","zoom-out"]);class Ue{constructor(t,n){this.name=t+"",this.fallback=n}getName(){return this.name+""}addFallbackStyleProperty(t){const{fallback:n}=this;return n instanceof Ue?`${t}, ${n.getStyleProperty()}`:t+""}getStyleProperty(){return this.addFallbackStyleProperty(this.name)+""}static getDefinedCursor(t){const n=Tu(Ue,bu);let e=n.get(t);if(e instanceof Ue)return e;if(Gg.has(t))return e=new Ue(t),n.set(t,e),e}static setDefinedCursor(t,n){return n instanceof Ue?(Tu(Ue,bu).set(t,n),!0):!1}}function Tu(i,t){let n=i[t];return n instanceof Map||(n=new Map,Object.defineProperty(i,t,{value:n})),n}const J0=Gg.values(),Q0="image-cursor";class Oa extends Ue{constructor(t,n,e,o,a){super(o||Oa.getUniqueInstanceName(Q0),a),this.url=t,this.x=Number(n)||0,this.y=Number(e)||0}getStyleProperty(){const{url:t,x:n,y:e}=this;let o=`url('${t}')`;return n>=0&&e>=0&&(n>0||e>0)&&(o+=` ${n} ${e}`),this.addFallbackStyleProperty(o)}static getUniqueInstanceName(t){return`${t}-${BI(Oa)}`}}const Ut={iconContent:"",iconSize:16,viewBox:{x:16,y:16},mousePoint:{x:8,y:8},mousePointerGroupString:`
    <path stroke="{{color}}" d="M8 16L8 0"></path>
    <path stroke="{{color}}" d="M16 8L0 8"></path>
  `},ze={x:127,y:60},ri=`
<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>
`,ro=`
<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>
<rect fill="{{color}}" x="95.84" y="9.38" width="15.85" height="47.14"/>
`,ps='<path fill="{{color}}" d="M82.89,10a12.09,12.09,0,0,0-16.8-2.5l-27.5,20.4-8.5-6.3a2.93,2.93,0,0,1-1.1-3,14.66,14.66,0,0,0,.1-6.6,14.08,14.08,0,1,0-6.5,15.2,2.87,2.87,0,0,1,3.2.2l8.2,6.1-8.2,6.1a2.87,2.87,0,0,1-3.2.2,14.16,14.16,0,1,0,6.7,14.4,14,14,0,0,0-.3-5.8,2.93,2.93,0,0,1,1.1-3l8.5-6.3,27.5,20.4A11.91,11.91,0,0,0,82.89,57l-31.7-23.5ZM15.29,21a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,21Zm0,36.8a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,57.77Zm28.3-21.5a2.8,2.8,0,1,1,2.8-2.8A2.8,2.8,0,0,1,43.59,36.27Z" transform="translate(-1.17 -0.96)"/>',ci='<path fill="{{color}}" d="M8.86,2.25V66.08H72.69V2.25H8.86ZM65.28,58.67h-49v-49h49v49Z" transform="translate(-8.86 -2.25)"/>',vs='<path fill="{{color}}" d="M40.77,2.25A31.92,31.92,0,1,0,72.69,34.16,31.92,31.92,0,0,0,40.77,2.25Zm0,57.63A25.71,25.71,0,1,1,66.48,34.16,25.71,25.71,0,0,1,40.77,59.87Z" transform="translate(-8.86 -2.25)"/>',Ir={Angle:kt(Ut,{name:"Angle",iconContent:`<path fill="{{color}}" d="M1203 544q0 13-10 23l-393 393 393 393q10 10 10 23t-10 23l-50
    50q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l466-466q10-10 23-10t23
    10l50 50q10 10 10 23z" />`,viewBox:{x:1792,y:1792}}),ArrowAnnotate:kt(Ut,{name:"ArrowAnnotate",iconContent:`<g id="arrowAnnotate-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">
    <path id="arrowAnnotate-arrow" d="M23,7 l-15,15 M7,17 l0,6 6,0" stroke-width="2" />
  </g>`,viewBox:{x:24,y:24}}),Bidirectional:kt(Ut,{name:"Bidirectional",iconContent:`<g fill="{{color}}" stroke-width="3" stroke="{{color}}">
    <path d="M27.63 3.21L3.12 28.81"></path>
    <path d="M27.63 15.75L15.27 4.43"></path>
    <path d="M16.5 4.28C16.5 4.96 15.95 5.51 15.27 5.51C14.59 5.51 14.03 4.96 14.03 4.28C14.03 3.59 14.59 3.04 15.27 3.04C15.95 3.04 16.5 3.59 16.5 4.28Z" ></path>
    <path d="M28.87 3.19C28.87 3.87 28.31 4.43 27.63 4.43C26.95 4.43 26.4 3.87 26.4 3.19C26.4 2.51 26.95 1.95 27.63 1.95C28.31 1.95 28.87 2.51 28.87 3.19Z"></path>
    <path d="M28.87 15.75C28.87 16.43 28.31 16.99 27.63 16.99C26.95 16.99 26.4 16.43 26.4 15.75C26.4 15.07 26.95 14.51 27.63 14.51C28.31 14.51 28.87 15.07 28.87 15.75Z"></path>
    <path d="M4.73 28.44C4.73 29.12 4.17 29.68 3.49 29.68C2.81 29.68 2.25 29.12 2.25 28.44C2.25 27.76 2.81 27.2 3.49 27.2C4.17 27.2 4.73 27.76 4.73 28.44Z"></path>
  </g>`,viewBox:{x:48,y:48}}),CobbAngle:kt(Ut,{name:"CobbAngle",iconContent:`<g stroke="{{color}}" stroke-width="3">
    <path d="M28.59 2.34L3.82 12.32"></path>
    <path d="M28.59 29.66L3.82 19.68"></path>
    <path stroke-dasharray="2" fill-opacity="0" d="M12.37
      23.06C12.67 22.36 12.85 21.93 12.92 21.76C14.6 17.8 14.68 13.35 13.15
      9.33C13.11 9.24 13.02 9 12.88 8.63">
    </path>
  </g>`,viewBox:{x:32,y:32}}),CircleROI:kt(Ut,{name:"CircleROI",iconContent:'<circle stroke="{{color}}" fill="none" stroke-width="3" cx="16" cy="16" r="14" />',viewBox:{x:32,y:32}}),EllipticalROI:kt(Ut,{name:"EllipticalROI",iconContent:`<path stroke="{{color}}" fill="none" stroke-width="3" d="M30.74 15.76C30.74 20.99 24.14 25.23 16
    25.23C7.86 25.23 1.26 20.99 1.26 15.76C1.26 10.54 7.86 6.3 16 6.3C24.14
    6.3 30.74 10.54 30.74 15.76Z" />`,viewBox:{x:32,y:32}}),FreehandROI:kt(Ut,{name:"FreehandROI",iconContent:`<g fill="{{color}}" stroke="{{color}}" stroke-width="2">
    <ellipse ry="1" rx="1" id="svg_3" cy="4.240343" cx="14.306499"/>
    <line id="svg_4" y2="3.58462" x2="12.242186" y1="3.997482" x1="13.432202"/>
    <line id="svg_5" y2="3.268901" x2="10.857882" y1="3.608906" x1="12.387902"/>
    <line id="svg_6" y2="3.147471" x2="9.740724" y1="3.293187" x1="10.955026"/>
    <line id="svg_7" y2="3.147471" x2="8.089274" y1="3.196043" x1="9.983585"/>
    <line id="svg_8" y2="3.268901" x2="6.874972" y1="3.123185" x1="8.307848"/>
    <line id="svg_9" y2="3.657478" x2="5.587812" y1="3.220329" x1="7.020688"/>
    <line id="svg_10" y2="4.046054" x2="4.737801" y1="3.560334" x1="5.854959"/>
    <line id="svg_11" y2="4.337487" x2="4.300652" y1="3.997482" x1="4.834945"/>
    <line id="svg_12" y2="4.726063" x2="3.88779" y1="4.191771" x1="4.470655"/>
    <line id="svg_15" y2="5.3575" x2="3.377783" y1="4.604633" x1="3.960648"/>
    <line id="svg_16" y2="6.183226" x2="2.916348" y1="5.138926" x1="3.547785"/>
    <line id="svg_17" y2="6.960379" x2="2.770632" y1="5.867507" x1="3.037779"/>
    <line id="svg_18" y2="7.713246" x2="2.673488" y1="6.741804" x1="2.819204"/>
    <line id="svg_19" y2="8.684687" x2="2.697774" y1="7.616102" x1="2.673488"/>
    <line id="svg_20" y2="9.753273" x2="2.892062" y1="8.611829" x1="2.697774"/>
    <line id="svg_21" y2="10.724714" x2="3.134923" y1="9.534698" x1="2.84349"/>
    <line id="svg_23" y2="11.647583" x2="3.596357" y1="10.578998" x1="3.086351"/>
    <line id="svg_25" y2="12.521881" x2="4.276366" y1="11.501867" x1="3.499213"/>
    <line id="svg_26" y2="13.930471" x2="5.830673" y1="12.376165" x1="4.13065"/>
    <line id="svg_28" y2="14.707624" x2="7.263549" y1="13.881899" x1="5.733528"/>
    <line id="svg_29" y2="15.339061" x2="8.963571" y1="14.61048" x1="7.06926"/>
    <line id="svg_30" y2="15.581921" x2="10.882168" y1="15.314775" x1="8.817855"/>
    <line id="svg_31" y2="15.460491" x2="12.023612" y1="15.581921" x1="10.785024"/>
    <line id="svg_33" y2="15.120487" x2="13.092197" y1="15.484777" x1="11.877895"/>
    <line id="svg_34" y2="14.586194" x2="13.86935" y1="15.217631" x1="12.897909"/>
    <line id="svg_35" y2="13.833327" x2="14.597931" y1="14.756196" x1="13.699348"/>
    <line id="svg_37" y2="12.716169" x2="15.180796" y1="13.881899" x1="14.549359"/>
    <line id="svg_39" y2="11.429009" x2="15.520801" y1="12.813313" x1="15.15651"/>
    <ellipse ry="1" rx="1" id="svg_40" cy="10.967574" cx="15.520801"/>
  </g>`,viewBox:{x:18,y:18}}),FreehandROISculptor:kt(Ut,{name:"FreehandROISculptor",iconContent:`<g id="icon-freehand-sculpt" fill="none" stroke-width="1.5" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">
    <line id="svg_1" y2="2.559367" x2="10.184807" y1="4.467781" x1="8.81711"/>
    <line id="svg_4" y2="1.493836" x2="11.727442" y1="2.766112" x1="10.089386"/>
    <line id="svg_7" y2="1.080346" x2="13.047428" y1="1.748291" x1="11.345759"/>
    <line id="svg_8" y2="1.000829" x2="14.351511" y1="1.112153" x1="12.77707"/>
    <line id="svg_9" y2="1.350705" x2="15.242104" y1="0.905408" x1="13.969828"/>
    <line id="svg_10" y2="2.098167" x2="15.862339" y1="1.14396" x1="14.955842"/>
    <line id="svg_11" y2="3.195505" x2="16.41896" y1="1.939133" x1="15.766918"/>
    <line id="svg_12" y2="4.292843" x2="16.530284" y1="2.925147" x1="16.387153"/>
    <line id="svg_16" y2="5.644637" x2="16.196311" y1="3.831643" x1="16.593898"/>
    <line id="svg_18" y2="7.266789" x2="15.623787" y1="5.19934" x1="16.275829"/>
    <line id="svg_19" y2="10.813258" x2="14.526449" y1="6.726071" x1="15.766918"/>
    <line id="svg_20" y2="5.056209" x2="8.085552" y1="4.181519" x1="8.976145"/>
    <line id="svg_23" y2="5.326568" x2="7.481221" y1="4.78585" x1="8.403621"/>
    <line id="svg_24" y2="5.565119" x2="6.749662" y1="5.294761" x1="7.624352"/>
    <line id="svg_25" y2="5.994512" x2="5.429675" y1="5.533312" x1="6.956407"/>
    <line id="svg_27" y2="6.551133" x2="4.284627" y1="5.962706" x1="5.572807"/>
    <line id="svg_28" y2="7.584858" x2="3.044158" y1="6.392099" x1="4.427758"/>
    <line id="svg_29" y2="8.84123" x2="2.185372" y1="7.489437" x1="3.219096"/>
    <line id="svg_31" y2="10.606513" x2="1.644654" y1="8.602678" x1="2.280792"/>
    <line id="svg_32" y2="13.214679" x2="1.48562" y1="10.352058" x1="1.724171"/>
    <line id="svg_33" y2="14.375631" x2="1.676461" y1="12.992031" x1="1.453813"/>
    <line id="svg_34" y2="15.298031" x2="2.264889" y1="14.152983" x1="1.517427"/>
    <line id="svg_35" y2="16.172721" x2="3.521261" y1="14.948155" x1="1.915013"/>
    <line id="svg_36" y2="16.824762" x2="5.207027" y1="15.997783" x1="3.28271"/>
    <line id="svg_38" y2="17.063314" x2="7.035924" y1="16.745245" x1="4.968475"/>
    <line id="svg_39" y2="16.888376" x2="9.278311" y1="17.047411" x1="6.733758"/>
    <line id="svg_40" y2="16.284045" x2="10.661911" y1="16.983797" x1="8.992048"/>
    <line id="svg_41" y2="15.313934" x2="11.647925" y1="16.395369" x1="10.455166"/>
    <line id="svg_44" y2="13.898527" x2="12.82478" y1="15.425259" x1="11.504794"/>
    <line id="svg_45" y2="12.037824" x2="14.144766" y1="14.312017" x1="12.522614"/>
    <line id="svg_47" y2="10.59061" x2="14.605966" y1="12.228665" x1="13.953925"/>
    <ellipse ry="1" rx="1" id="svg_48" cy="3.982726" cx="13.460918"/>
  </g>`,viewBox:{x:18,y:18}}),Length:kt(Ut,{name:"Length",iconContent:`<g id="length-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">
    <path id="length-dashes" d="m22.5,6 -16.5,16.5" stroke-width="3" stroke-dasharray="0.6666,5" />
  </g>`,viewBox:{x:24,y:24}}),Height:kt(Ut,{name:"Height",iconContent:'<path d="m 6 22 l 8.5 0 v -16 h 8" stroke-width="3" fill="none" stroke="{{color}}" />',viewBox:{x:24,y:24}}),Probe:kt(Ut,{name:"Probe",iconContent:`<path fill="{{color}}" d="M1152 896q0 106-75 181t-181 75-181-75-75-181 75-181 181-75 181 75
    75 181zm-256-544q-148 0-273 73t-198 198-73 273 73 273 198 198 273 73 273-73
    198-198 73-273-73-273-198-198-273-73zm768 544q0 209-103 385.5t-279.5
    279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5
    385.5-103 385.5 103 279.5 279.5 103 385.5z" />`,viewBox:{x:1792,y:1792}}),RectangleROI:kt(Ut,{name:"RectangleROI",iconContent:`<path fill="{{color}}" d="M1312 256h-832q-66 0-113 47t-47 113v832q0 66 47
    113t113 47h832q66 0 113-47t47-113v-832q0-66-47-113t-113-47zm288 160v832q0
    119-84.5 203.5t-203.5 84.5h-832q-119 0-203.5-84.5t-84.5-203.5v-832q0-119
    84.5-203.5t203.5-84.5h832q119 0 203.5 84.5t84.5 203.5z" />`,viewBox:{x:1792,y:1792}}),Label:kt(Ut,{name:"Label",iconContent:`<path fill="{{color}}" d="M789 559l-170 450q33 0 136.5 2t160.5 2q19 0
    57-2-87-253-184-452zm-725 1105l2-79q23-7 56-12.5t57-10.5 49.5-14.5 44.5-29
    31-50.5l237-616 280-724h128q8 14 11 21l205 480q33 78 106 257.5t114 274.5q15
    34 58 144.5t72 168.5q20 45 35 57 19 15 88 29.5t84 20.5q6 38 6 57 0 5-.5
    13.5t-.5 12.5q-63 0-190-8t-191-8q-76 0-215 7t-178 8q0-43 4-78l131-28q1 0
    12.5-2.5t15.5-3.5 14.5-4.5 15-6.5 11-8 9-11
    2.5-14q0-16-31-96.5t-72-177.5-42-100l-450-2q-26 58-76.5 195.5t-50.5 162.5q0
    22 14 37.5t43.5 24.5 48.5 13.5 57 8.5 41 4q1 19 1 58 0 9-2 27-58
    0-174.5-10t-174.5-10q-8 0-26.5 4t-21.5 4q-80 14-188 14z" />`,viewBox:{x:1792,y:1792}}),Crosshairs:kt(Ut,{name:"Crosshairs",iconContent:`<path fill="{{color}}" d="M1325 1024h-109q-26 0-45-19t-19-45v-128q0-26
    19-45t45-19h109q-32-108-112.5-188.5t-188.5-112.5v109q0 26-19 45t-45
    19h-128q-26 0-45-19t-19-45v-109q-108 32-188.5 112.5t-112.5 188.5h109q26
    0 45 19t19 45v128q0 26-19 45t-45 19h-109q32 108 112.5 188.5t188.5
    112.5v-109q0-26 19-45t45-19h128q26 0 45 19t19 45v109q108-32
    188.5-112.5t112.5-188.5zm339-192v128q0 26-19 45t-45 19h-143q-37 161-154.5
    278.5t-278.5 154.5v143q0 26-19 45t-45 19h-128q-26
    0-45-19t-19-45v-143q-161-37-278.5-154.5t-154.5-278.5h-143q-26
    0-45-19t-19-45v-128q0-26 19-45t45-19h143q37-161
    154.5-278.5t278.5-154.5v-143q0-26 19-45t45-19h128q26 0 45 19t19 45v143q161
    37 278.5 154.5t154.5 278.5h143q26 0 45 19t19 45z" />`,viewBox:{x:1792,y:1792}}),Eraser:kt(Ut,{name:"Eraser",iconContent:`<path transform="translate(0,1792) scale(1,-1)" fill="{{color}}" d="M960 1408l336-384h-768l-336 384h768zm1013-1077q15
    34 9.5 71.5t-30.5 65.5l-896 1024q-38 44-96 44h-768q-38
    0-69.5-20.5t-47.5-54.5q-15-34-9.5-71.5t30.5-65.5l896-1024q38-44 96-44h768q38
    0 69.5 20.5t47.5 54.5z" />`,viewBox:{x:2048,y:1792}}),Magnify:kt(Ut,{name:"Magnify",iconContent:`<path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395
    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5
    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17
    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208
    32s176 78.7 176 176-78.7 176-176 176z" />`,viewBox:{x:512,y:512}}),Pan:kt(Ut,{name:"Pan",iconContent:`<path fill="{{color}}" d="M1411 541l-355 355 355 355 144-144q29-31 70-14 39 17
    39 59v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39 14-69l144-144-355-355-355
    355 144 144q31 30 14 69-17 40-59 40h-448q-26 0-45-19t-19-45v-448q0-42 40-59
    39-17 69 14l144 144 355-355-355-355-144 144q-19 19-45 19-12
    0-24-5-40-17-40-59v-448q0-26 19-45t45-19h448q42 0 59 40 17 39-14 69l-144
    144 355 355 355-355-144-144q-31-30-14-69 17-40 59-40h448q26 0 45 19t19
    45v448q0 42-39 59-13 5-25 5-26 0-45-19z" />`,viewBox:{x:1792,y:1792}}),Rotate:kt(Ut,{name:"Rotate",iconContent:`<path fill="{{color}}" d="M1664 256v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39
    14-69l138-138q-148-137-349-137-104 0-198.5 40.5t-163.5 109.5-109.5
    163.5-40.5 198.5 40.5 198.5 109.5 163.5 163.5 109.5 198.5 40.5q119 0
    225-52t179-147q7-10 23-12 15 0 25 9l137 138q9 8 9.5 20.5t-7.5 22.5q-109
    132-264 204.5t-327 72.5q-156 0-298-61t-245-164-164-245-61-298 61-298
    164-245 245-164 298-61q147 0 284.5 55.5t244.5 156.5l130-129q29-31 70-14
    39 17 39 59z" />`,viewBox:{x:1792,y:1792}}),StackScroll:kt(Ut,{name:"StackScroll",iconContent:`<path fill="{{color}}" d="M24 21v2c0 0.547-0.453 1-1 1h-22c-0.547
    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1zM24 13v2c0
    0.547-0.453 1-1 1h-22c-0.547 0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547
    0 1 0.453 1 1zM24 5v2c0 0.547-0.453 1-1 1h-22c-0.547
    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1z" />`,viewBox:{x:24,y:28}}),WindowLevelRegion:kt(Ut,{name:"WindowLevelRegion",iconContent:`<path fill="{{color}}" d="M1664 416v960q0 119-84.5 203.5t-203.5 84.5h-960q-119
    0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5
    84.5t84.5 203.5z" />`,viewBox:{x:1792,y:1792}}),WindowLevel:kt(Ut,{name:"WindowLevel",iconContent:`
    <path fill="{{color}}" d="M14.5,3.5 a1 1 0 0 1 -11,11 Z" stroke="none" opacity="0.8" />
    <circle cx="9" cy="9" r="8" fill="none" stroke-width="2" stroke="{{color}}" />`,viewBox:{x:18,y:18}}),Zoom:kt(Ut,{name:"Zoom",iconContent:`
  <path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395
    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5
    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17
    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208
    32s176 78.7 176 176-78.7 176-176 176z" />
  <path fill="{{color}}" transform="scale(0.22,0.22) translate(1400,0)" d="M1216
    320q0 26-19 45t-45 19h-128v1024h128q26 0 45 19t19 45-19 45l-256 256q-19
    19-45 19t-45-19l-256-256q-19-19-19-45t19-45 45-19h128v-1024h-128q-26
    0-45-19t-19-45 19-45l256-256q19-19 45-19t45 19l256 256q19 19 19 45z" />`,viewBox:{x:640,y:512}}),SegmentationFreeHandEraseInside:kt(Ut,{name:"SegmentationFreeHandEraseInside",iconContent:`${ps} ${ri}`,viewBox:ze}),SegmentationFreeHandFillInside:kt(Ut,{name:"SegmentationFreeHandFillInside",iconContent:`${ps} ${ro}`,viewBox:ze}),SegmentationFreeHandEraseOutside:kt(Ut,{name:"SegmentationFreeHandEraseOutside",iconContent:`${ps} ${ri}`,viewBox:ze}),SegmentationFreeHandFillOutside:kt(Ut,{name:"SegmentationFreeHandFillOutside",iconContent:`${ps} ${ro}`,viewBox:ze}),SegmentationRectangleEraseInside:kt(Ut,{name:"SegmentationRectangleEraseInside",iconContent:`${ci} ${ri}`,viewBox:ze}),RectangleScissor:kt(Ut,{name:"RectangleScissor",iconContent:`${ci} ${ro}`,viewBox:ze}),"RectangleScissor.FILL_INSIDE":kt(Ut,{name:"RectangleScissor.FILL_INSIDE",iconContent:`${ci} ${ro}`,viewBox:ze}),"RectangleScissor.FILL_OUTSIDE":kt(Ut,{name:"RectangleScissor.FILL_OUTSIDE",iconContent:`${ci} ${ro}`,viewBox:ze}),"RectangleScissor.ERASE_OUTSIDE":kt(Ut,{name:"RectangleScissor.ERASE_OUTSIDE",iconContent:`${ci} ${ri}`,viewBox:ze}),"RectangleScissor.ERASE_INSIDE":kt(Ut,{name:"RectangleScissor.ERASE_INSIDE",iconContent:`${ci} ${ri}`,viewBox:ze}),CircleScissor:kt(Ut,{name:"CircleScissor",iconContent:`${vs} ${ro}`,viewBox:ze}),"CircleScissor.FILL_INSIDE":kt(Ut,{name:"CircleScissor.FILL_INSIDE",iconContent:`${vs} ${ro}`,viewBox:ze}),"CircleScissor.ERASE_OUTSIDE":kt(Ut,{name:"CircleScissor.ERASE_OUTSIDE",iconContent:`${vs} ${ri}`,viewBox:ze}),"CircleScissor.FILL_OUTSIDE":kt(Ut,{name:"CircleScissor.FILL_OUTSIDE",iconContent:`${vs} ${ro}`,viewBox:ze})};function kt(i,t){return Object.assign(Object.create(i),{...t,name:t.name||i.name})}function tw(i,t,n){Ir[i]=kt(Ut,{iconContent:t,viewBox:n})}function ew(i){return Ir[i]}const nw=Object.keys(Ir);class ow{constructor(){const t={color:"rgb(255, 255, 0)",colorHighlighted:"rgb(0, 255, 0)",colorSelected:"rgb(0, 220, 0)",colorLocked:"rgb(209, 193, 90)",lineWidth:"1",lineDash:"",shadow:!0,textBoxVisibility:!0,textBoxFontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",textBoxFontSize:"14px",textBoxColor:"rgb(255, 255, 0)",textBoxColorHighlighted:"rgb(0, 255, 0)",textBoxColorSelected:"rgb(0, 255, 0)",textBoxColorLocked:"rgb(209, 193, 90)",textBoxBackground:"",textBoxLinkLineWidth:"1",textBoxLinkLineDash:"2,3",textBoxShadow:!0,markerSize:"10",angleArcLineDash:""};this._initializeConfig(t)}getAnnotationToolStyles(t){return this.config.annotations&&this.config.annotations[t]}getViewportToolStyles(t){return this.config.viewports&&this.config.viewports[t]}getToolGroupToolStyles(t){return this.config.toolGroups&&this.config.toolGroups[t]}getDefaultToolStyles(){return this.config.default}setAnnotationStyles(t,n){let e=this.config.annotations;e||(this.config={...this.config,annotations:{}},e=this.config.annotations),e[t]=n}setViewportToolStyles(t,n){let e=this.config.viewports;e||(this.config={...this.config,viewports:{}},e=this.config.viewports),e[t]=n}setToolGroupToolStyles(t,n){let e=this.config.toolGroups;e||(this.config={...this.config,toolGroups:{}},e=this.config.toolGroups),e[t]=n}setDefaultToolStyles(t){this.config.default=t}getStyleProperty(t,n){const{annotationUID:e,viewportId:o,toolGroupId:a,toolName:s}=n;return this._getToolStyle(t,e,o,a,s)}_getToolStyle(t,n,e,o,a){if(n){const r=this.getAnnotationToolStyles(n);if(r&&r[t]!==void 0)return r[t]}if(e){const r=this.getViewportToolStyles(e);if(r){if(r[a]&&r[a][t]!==void 0)return r[a][t];if(r.global&&r.global[t]!==void 0)return r.global[t]}}if(o){const r=this.getToolGroupToolStyles(o);if(r){if(r[a]&&r[a][t]!==void 0)return r[a][t];if(r.global&&r.global[t]!==void 0)return r.global[t]}}const s=this.getDefaultToolStyles();if(s[a]&&s[a][t]!==void 0)return s[a][t];if(s.global&&s.global[t]!==void 0)return s.global[t]}_initializeConfig(t){const n={};for(const e in t)n[e]=t[e];this.config={default:{global:n}}}}const Nl=new ow;function iw(i,t,n){const e=[`${i}`];return t&&e.push(`${e[0]}${t}`),n&&e.push(`${e[e.length-1]}${n}`),e}function Ve(i,t,n,e){const o=iw(i,n,e);for(let a=o.length-1;a>=0;--a){const s=Nl.getStyleProperty(o[a],t);if(s!==void 0)return s}}const aw="color",sw=vn.Highlighted,rw=Ot.Active;class Di extends Oa{constructor(t,n,e,o,a){super(t,n,e,o,a)}static getDefinedCursor(t,n=!1,e){e||(e=Ve(aw,{},sw,rw));const o=cw(t,n,e);let a=super.getDefinedCursor(o);const s=Number(Ve("pointerStrokeWidth",{}));if(!a){const r=ew(t);r&&(a=lw(r,o,n,e,s,super.getDefinedCursor("default")),super.setDefinedCursor(o,a))}return a}}function Wg(i,t){const n=Object(t),e=Object.prototype.hasOwnProperty.bind(n);return(i+"").replace(/\{\{(\w+)\}\}/g,(o,a)=>e(a)?n[a]+"":"")}function cw(i,t,n){return`${t?"pointer":"cursor"}:${i}/${n}`}function lw(i,t,n,e,o,a){const{x:s,y:r}=i.mousePoint;return new Di(dw(i,n,{color:e,pointerStrokeWidth:o}),s,r,t,a)}function dw(i,t,n){const e=uw(i,t,n);return`${URL.createObjectURL(e)}#${i.name||"unknown"}-${t?"pointer":"cursor"}`}function uw(i,t,n){const e=(t?gw:hw)(i,n);return new Blob([e],{type:"image/svg+xml"})}function hw(i,t){const{iconContent:n,iconSize:e,viewBox:o}=i,a=`
    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"
      width="${e}" height="${e}" viewBox="0 0
      ${o.x} ${o.y}">
      ${n}
    </svg>`;return Wg(a,t)}function gw(i,t){const{iconContent:n,iconSize:e,viewBox:o,mousePointerGroupString:a}=i,s=e/Math.max(o.x,o.y,1),r=16+e,c=t.pointerStrokeWidth||1,l=`
    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"
      width="${r}" height="${r}" viewBox="0 0 ${r} ${r}">
      <g stroke-width="${c}">${a}</g>
      <g transform="translate(16, 16) scale(${s})">${n}</g>
    </svg>`;return Wg(l,t)}const Pu=Symbol("ElementCursorsMap");function $g(i,t){La(i)[0]=t,Ka(i,t)}function Ka(i,t){const n=La(i);n[1]=n[0],n[0]=t,i.style.cursor=(t instanceof Ue?t:Ue.getDefinedCursor("auto")).getStyleProperty()}function ht(i){Ka(i,La(i)[1])}function nt(i){Ka(i,Ue.getDefinedCursor("none"))}function La(i){let t=La[Pu];t instanceof WeakMap||(t=new WeakMap,Object.defineProperty(La,Pu,{value:t}));let n=t.get(i);return n||(n=[null,null],t.set(i,n)),n}const fw=Object.freeze(Object.defineProperty({__proto__:null,hideElementCursor:nt,initElementCursor:$g,resetElementCursor:ht,setElementCursor:Ka},Symbol.toStringTag,{value:"Module"}));function mw(i,t){let n=Di.getDefinedCursor(t,!0);n||(n=Ue.getDefinedCursor(t)),n||(console.log(`Cursor ${t} is not defined either as SVG or as a standard cursor.`),n=Ue.getDefinedCursor(t)),Ka(i,n)}const pw=[...nw,...J0],H2=Object.freeze(Object.defineProperty({__proto__:null,CursorNames:pw,CursorSVG:Ir,ImageMouseCursor:Oa,MouseCursor:Ue,SVGMouseCursor:Di,elementCursor:fw,registerCursor:tw,setCursorForElement:mw},Symbol.toStringTag,{value:"Module"}));function _e(i){return U.toolGroups.find(t=>t.id===i)}const{Active:aa,Passive:ic,Enabled:ac,Disabled:sc}=Ot,vw=[{mouseButton:Nn.Primary}];class Ul{constructor(t){this.viewportsInfo=[],this.toolOptions={},this.currentActivePrimaryToolName=null,this.prevActivePrimaryToolName=null,this.restoreToolOptions={},this._toolInstances={},this.id=t}getViewportIds(){return this.viewportsInfo.map(({viewportId:t})=>t)}getViewportsInfo(){return this.viewportsInfo.slice()}getToolInstance(t){const n=this._toolInstances[t];if(!n){console.warn(`'${t}' is not registered with this toolGroup (${this.id}).`);return}return n}getToolInstances(){return this._toolInstances}hasTool(t){return!!this._toolInstances[t]}addTool(t,n={}){const e=U.tools[t],o=typeof t<"u"&&t!=="",a=this.toolOptions[t];if(!o){console.warn("Tool with configuration did not produce a toolName: ",n);return}if(!e){console.warn(`'${t}' is not registered with the library. You need to use cornerstoneTools.addTool to register it.`);return}if(a){console.warn(`'${t}' is already registered for ToolGroup ${this.id}.`);return}const{toolClass:s}=e,r={name:t,toolGroupId:this.id,configuration:n},c=new s(r);this._toolInstances[t]=c}addToolInstance(t,n,e={}){let o=U.tools[t]?.toolClass;if(!o){const a=U.tools[n].toolClass;class s extends a{}s.toolName=t,o=s,U.tools[t]={toolClass:s}}this.addTool(o.toolName,e)}addViewport(t,n){if(typeof t!="string")throw new Error("viewportId must be defined and be a string");const e=this._findRenderingEngine(t,n);this.viewportsInfo.some(({viewportId:s})=>s===t)||this.viewportsInfo.push({viewportId:t,renderingEngineId:e});const o=this.getActivePrimaryMouseButtonTool();this.setViewportsCursorByToolName(o);const a={toolGroupId:this.id,viewportId:t,renderingEngineId:e};gt(z,w.TOOLGROUP_VIEWPORT_ADDED,a)}removeViewports(t,n){const e=[];if(this.viewportsInfo.forEach((a,s)=>{let r=!1;a.renderingEngineId===t&&(r=!0,n&&a.viewportId!==n&&(r=!1)),r&&e.push(s)}),e.length)for(let a=e.length-1;a>=0;a--)this.viewportsInfo.splice(e[a],1);const o={toolGroupId:this.id,viewportId:n,renderingEngineId:t};gt(z,w.TOOLGROUP_VIEWPORT_REMOVED,o)}setActiveStrategy(t,n){const e=this._toolInstances[t];if(e===void 0){console.warn(`Tool ${t} not added to toolGroup, can't set tool configuration.`);return}e.setActiveStrategy(n)}setToolMode(t,n,e={}){if(!t){console.warn("setToolMode: toolName must be defined");return}if(n===Ot.Active){this.setToolActive(t,e||this.restoreToolOptions[t]);return}if(n===Ot.Passive){this.setToolPassive(t);return}if(n===Ot.Enabled){this.setToolEnabled(t);return}if(n===Ot.Disabled){this.setToolDisabled(t);return}console.warn("setToolMode: mode must be defined")}setToolActive(t,n={}){const e=this._toolInstances[t];if(e===void 0){console.warn(`Tool ${t} not added to toolGroup, can't set tool mode.`);return}if(!e){console.warn(`'${t}' instance ${e} is not registered with this toolGroup, can't set tool mode.`);return}const o=this.toolOptions[t]?this.toolOptions[t].bindings:[],a=n.bindings?n.bindings:[],r={bindings:[...o,...a].reduce((l,d)=>{const u=d.numTouchPoints!==void 0,h=d.mouseButton!==void 0;return!l.some(g=>rc(g,d))&&(u||h)&&l.push(d),l},[]),mode:aa};if(this.toolOptions[t]=r,this._toolInstances[t].mode=aa,this._hasMousePrimaryButtonBinding(n))this.setViewportsCursorByToolName(t),e.isPrimary=!0;else{if(!this.getActivePrimaryMouseButtonTool()){const d=Ue.getDefinedCursor("default");this._setCursorForViewports(d)}e.isPrimary=!1}this._hasMousePrimaryButtonBinding(n)&&(this.prevActivePrimaryToolName===null?this.prevActivePrimaryToolName=t:this.prevActivePrimaryToolName=this.currentActivePrimaryToolName,this.currentActivePrimaryToolName=t),typeof e.onSetToolActive=="function"&&e.onSetToolActive(),this._renderViewports();const c={toolGroupId:this.id,toolName:t,toolBindingsOptions:n};gt(z,w.TOOL_ACTIVATED,c),this._triggerToolModeChangedEvent(t,aa,n)}setToolPassive(t,n){const e=this._toolInstances[t];if(e===void 0){console.warn(`Tool ${t} not added to toolGroup, can't set tool mode.`);return}const o=this.getToolOptions(t),a=Object.assign({bindings:o?o.bindings:[]},o,{mode:ic}),s=Array.isArray(n?.removeAllBindings)?n.removeAllBindings:this.getDefaultPrimaryBindings();a.bindings=a.bindings.filter(c=>n?.removeAllBindings!==!0&&!s.some(l=>rc(c,l)));let r=ic;a.bindings.length!==0&&(r=aa,a.mode=r),this.toolOptions[t]=a,e.mode=r,e.isPrimary=!1,typeof e.onSetToolPassive=="function"&&e.onSetToolPassive(),this._renderViewports(),this._triggerToolModeChangedEvent(t,ic)}setToolEnabled(t){const n=this._toolInstances[t];if(n===void 0){console.warn(`Tool ${t} not added to toolGroup, can't set tool mode.`);return}const e={bindings:[],mode:ac};this.toolOptions[t]=e,n.mode=ac,typeof n.onSetToolEnabled=="function"&&n.onSetToolEnabled(),this._renderViewports(),this._triggerToolModeChangedEvent(t,ac)}setToolDisabled(t){const n=this._toolInstances[t];if(n===void 0){console.warn(`Tool ${t} not added to toolGroup, can't set tool mode.`);return}const e={bindings:[],mode:sc};this.restoreToolOptions[t]=this.toolOptions[t],this.toolOptions[t]=e,n.mode=sc,typeof n.onSetToolDisabled=="function"&&n.onSetToolDisabled(),this._renderViewports(),this._triggerToolModeChangedEvent(t,sc)}getToolOptions(t){const n=this.toolOptions[t];if(n!==void 0)return n}getActivePrimaryMouseButtonTool(){return Object.keys(this.toolOptions).find(t=>{const n=this.toolOptions[t];return n.mode===aa&&this._hasMousePrimaryButtonBinding(n)})}setViewportsCursorByToolName(t,n){const e=this._getCursor(t,n);this._setCursorForViewports(e)}_getCursor(t,n){let e,o;return n&&(e=`${t}.${n}`,o=Di.getDefinedCursor(e,!0),o)||(e=`${t}`,o=Di.getDefinedCursor(e,!0),o)||(e=t,o=Di.getDefinedCursor(e,!0),o)?o:Ue.getDefinedCursor("default")}_setCursorForViewports(t){Bg.getRuntimeSettings().get("useCursors")&&this.viewportsInfo.forEach(({renderingEngineId:e,viewportId:o})=>{const a=Gt(o,e);if(!a)return;const{viewport:s}=a;$g(s.element,t)})}setToolConfiguration(t,n,e){const o=this._toolInstances[t];if(o===void 0)return console.warn(`Tool ${t} not present, can't set tool configuration.`),!1;let a;return e?a=n:a=Object.assign(o.configuration,n),o.configuration=a,typeof o.onSetToolConfiguration=="function"&&o.onSetToolConfiguration(),this._renderViewports(),!0}getDefaultMousePrimary(){return Nn.Primary}getDefaultPrimaryBindings(){return vw}getToolConfiguration(t,n){if(this._toolInstances[t]===void 0){console.warn(`Tool ${t} not present, can't set tool configuration.`);return}const e=Z0(this._toolInstances[t].configuration,n)||this._toolInstances[t].configuration;return Ro(e)}getPrevActivePrimaryToolName(){return this.prevActivePrimaryToolName}setActivePrimaryTool(t){const n=this.getCurrentActivePrimaryToolName();this.setToolDisabled(n),this.setToolActive(t,{bindings:[{mouseButton:Nn.Primary}]})}getCurrentActivePrimaryToolName(){return this.currentActivePrimaryToolName}clone(t,n=null){let e=_e(t);return e?(console.debug(`ToolGroup ${t} already exists`),e):(e=new Ul(t),U.toolGroups.push(e),n=n??(()=>!0),Object.keys(this._toolInstances).filter(n).forEach(o=>{const a=this._toolInstances[o],s=this.toolOptions[o],r=a.mode;e.addTool(o),e.setToolMode(o,r,{bindings:s.bindings??[]})}),e)}_hasMousePrimaryButtonBinding(t){const n=this.getDefaultPrimaryBindings();return t?.bindings?.some(e=>n.some(o=>rc(e,o)))}_renderViewports(){this.viewportsInfo.forEach(({renderingEngineId:t,viewportId:n})=>{te(t).renderViewport(n)})}_triggerToolModeChangedEvent(t,n,e){const o={toolGroupId:this.id,toolName:t,mode:n,toolBindingsOptions:e};gt(z,w.TOOL_MODE_CHANGED,o)}_findRenderingEngine(t,n){const e=Co();if(e?.length===0)throw new Error("No rendering engines found.");if(n)return n;const o=e.filter(a=>a.getViewport(t));if(o.length===0){if(e.length===1)return e[0].id;throw new Error("No rendering engines found that contain the viewport with the same viewportId, you must specify a renderingEngineId.")}if(o.length>1)throw new Error("Multiple rendering engines found that contain the viewport with the same viewportId, you must specify a renderingEngineId.");return o[0].id}}function rc(i,t){return i.mouseButton!==t.mouseButton||i.numTouchPoints!==t.numTouchPoints?!1:i.modifierKey===t.modifierKey}function Iw(i){if(U.toolGroups.some(e=>e.id===i)){console.warn(`'${i}' already exists.`);return}const n=new Ul(i);return U.toolGroups.push(n),n}function Hg(i){const t=U.toolGroups.findIndex(n=>n.id===i);t>-1&&U.toolGroups.splice(t,1)}function zg(){const i=[...U.toolGroups];for(const t of i)Hg(t.id);U.toolGroups=[]}function ne(i,t){t||(t=Co().find(e=>e.getViewports().find(o=>o.id===i))?.id);const n=U.toolGroups.filter(e=>e.viewportsInfo.some(o=>o.renderingEngineId===t&&(!o.viewportId||o.viewportId===i)));if(n.length){if(n.length>1)throw new Error(`Multiple tool groups found for renderingEngineId: ${t} and viewportId: ${i}. You should only
      have one tool group per viewport in a renderingEngine.`);return n[0]}}function ww(){return U.toolGroups}const Cw=[Ot.Active,Ot.Passive,Ot.Enabled];function jg(i){return U.toolGroups.filter(({toolOptions:t})=>{const n=Object.keys(t);for(let e=0;e<n.length;e++)if(i===n[e]&&t[i]&&Cw.includes(t[i].mode))return!0;return!1})}const Ew=Object.freeze(Object.defineProperty({__proto__:null,createToolGroup:Iw,destroy:zg,destroyToolGroup:Hg,getAllToolGroups:ww,getToolGroup:_e,getToolGroupForViewport:ne,getToolGroupsWithToolName:jg},Symbol.toStringTag,{value:"Module"}));function Xg(i,t){const n=y(t),{renderingEngine:e,viewportId:o}=n,a=w.ANNOTATION_ADDED,s={annotation:i,viewportId:o,renderingEngineId:e.id};gt(z,a,s)}function Yg(i){const{toolName:t}=i.metadata,n=jg(t);if(!n.length)return;const e=[];n.forEach(s=>{s.viewportsInfo.forEach(r=>{const{renderingEngineId:c,viewportId:l}=r,{FrameOfReferenceUID:d}=Gt(l,c);i.metadata.FrameOfReferenceUID===d&&e.push(r)})});const o=w.ANNOTATION_ADDED,a={annotation:i};if(!e.length){gt(z,o,a);return}e.forEach(({renderingEngineId:s,viewportId:r})=>{a.viewportId=r,a.renderingEngineId=s,gt(z,o,a)})}function wr(i){const t=w.ANNOTATION_REMOVED;gt(z,t,i)}function It(i,t,n=lt.HandlesUpdated){const e=t&&y(t),{viewportId:o,renderingEngineId:a}=e||{},s=w.ANNOTATION_MODIFIED;gt(z,s,{annotation:i,viewportId:o,renderingEngineId:a,changeType:n})}function Lt(i){qg({annotation:i})}function Cr(i,t=!1){qg({annotation:i,contourHoleProcessingEnabled:t})}function qg(i){const t=w.ANNOTATION_COMPLETED;gt(z,t,i)}const Sw=Object.freeze(Object.defineProperty({__proto__:null,triggerAnnotationAddedForElement:Xg,triggerAnnotationAddedForFOR:Yg,triggerAnnotationCompleted:Lt,triggerAnnotationModified:It,triggerAnnotationRemoved:wr,triggerContourAnnotationCompleted:Cr},Symbol.toStringTag,{value:"Module"}));let Kg;function Dn(){return Kg}function kl(i){Kg=i}function Ct(i,t){const n=Dn(),e=n.getGroupKey(t);return n.getAnnotations(e,i)}function xt(i){return Dn().getAnnotation(i)}function Fi(){return Dn().getAllAnnotations()}function Bi(i){const{annotationUID:t,parentAnnotationUID:n}=i;if(!n)return;const e=xt(n),o=e.childAnnotationUIDs.indexOf(t);e.childAnnotationUIDs.splice(o,1),i.parentAnnotationUID=void 0}function Za(i,t){const{annotationUID:n}=i,{annotationUID:e}=t;Bi(t),i.childAnnotationUIDs||(i.childAnnotationUIDs=[]),!i.childAnnotationUIDs.includes(e)&&(i.childAnnotationUIDs.push(e),t.parentAnnotationUID=n)}function Zg(i){return i.parentAnnotationUID?xt(i.parentAnnotationUID):void 0}function Ja(i){return i.childAnnotationUIDs?.map(t=>xt(t))??[]}function mt(i,t){i.annotationUID||(i.annotationUID=Xt());const n=Dn();if(t instanceof HTMLDivElement){const e=n.getGroupKey(t);n.addAnnotation(i,e),Xg(i,t)}else n.addAnnotation(i,void 0),Yg(i);return i.annotationUID}function _w(i,t){const n=Dn(),e=n.getGroupKey(t);return n.getNumberOfAnnotations(e,i)}function ft(i){if(!i)return;const t=Dn(),n=t.getAnnotation(i);n&&(n.childAnnotationUIDs?.forEach(e=>ft(e)),t.removeAnnotation(i),wr({annotation:n,annotationManagerUID:t.uid}))}function Dw(){const i=Dn(),t=i.removeAllAnnotations();for(const n of t)wr({annotation:n,annotationManagerUID:i.uid})}function bw(i,t){const n=Dn(),e=n.getGroupKey(t),o=n.removeAnnotations(e,i);for(const a of o)wr({annotation:a,annotationManagerUID:n.uid})}function Vl(i){let t=i;for(;t;)t.invalidated=!0,t=t.parentAnnotationUID?xt(t.parentAnnotationUID):void 0}const Tw=Object.freeze(Object.defineProperty({__proto__:null,addAnnotation:mt,addChildAnnotation:Za,clearParentAnnotation:Bi,getAllAnnotations:Fi,getAnnotation:xt,getAnnotationManager:Dn,getAnnotations:Ct,getChildAnnotations:Ja,getNumberOfAnnotations:_w,getParentAnnotation:Zg,invalidateAnnotation:Vl,removeAllAnnotations:Dw,removeAnnotation:ft,removeAnnotations:bw,setAnnotationManager:kl},Symbol.toStringTag,{value:"Module"}));function Jg(i){const t=i.toolName;if(!t)throw new Error(`No Tool Found for the ToolClass ${i.name}`);U.tools[t]||(U.tools[t]={toolClass:i})}function Pw(i){const t=i.toolName;return!!(t&&U.tools[t])}function Er(i){return!!(i&&U.tools[i])}function Mw(i){const t=i.toolName;if(!t)throw new Error(`No tool found for: ${i.name}`);if(!U.tools[t]!==void 0)delete U.tools[t];else throw new Error(`${t} cannot be removed because it has not been added`)}function ni(i,t){const n=t||i.currentTarget,{viewport:e}=y(n)||{};if(!e)return;const o=Aw(i),a=yw(i),s=xw(n,a),r=e.canvasToWorld(s);return{page:a,client:o,canvas:s,world:r}}function xw(i,t){const n=i.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}function yw(i){return[i.pageX,i.pageY]}function Aw(i){return[i.clientX,i.clientY]}function Qg(i){const t=i.currentTarget,{viewportId:n,renderingEngineId:e}=y(t),o=ni(i,t),a={page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},s={event:i,eventName:w.MOUSE_DOUBLE_CLICK,viewportId:n,renderingEngineId:e,camera:{},element:t,startPoints:o,lastPoints:o,currentPoints:o,deltaPoints:a};!gt(t,w.MOUSE_DOUBLE_CLICK,s)&&(i.stopImmediatePropagation(),i.preventDefault())}const Mu=w.MOUSE_MOVE;function Qa(i){const t=i.currentTarget,n=y(t);if(!n)return;const{renderingEngineId:e,viewportId:o}=n,a=ni(i);!gt(t,Mu,{renderingEngineId:e,viewportId:o,camera:{},element:t,currentPoints:a,eventName:Mu,event:i})&&(i.stopImmediatePropagation(),i.preventDefault())}const{MOUSE_DOWN:xu,MOUSE_DOWN_ACTIVATE:Ow,MOUSE_CLICK:Lw,MOUSE_UP:Rw,MOUSE_DRAG:yu}=w,Nw=400,Uw=150,kw=3,Vw={mouseButton:void 0,element:null,renderingEngineId:void 0,viewportId:void 0,isClickEvent:!0,clickDelay:200,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}};let vt={mouseButton:void 0,renderingEngineId:void 0,viewportId:void 0,isClickEvent:!0,clickDelay:200,element:null,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}};const Ee={doubleClickTimeout:null,mouseDownEvent:null,mouseUpEvent:null,ignoreDoubleClick:!1};function tf(i){if(Ee.doubleClickTimeout){if(i.buttons===Ee.mouseDownEvent.buttons)return;Ee.mouseDownEvent=i,Fs();return}Ee.doubleClickTimeout=setTimeout(Fs,i.buttons===1?Nw:Uw),Ee.mouseDownEvent=i,Ee.ignoreDoubleClick=!1,vt.element=i.currentTarget,vt.mouseButton=i.buttons;const t=y(vt.element),{renderingEngineId:n,viewportId:e}=t;vt.renderingEngineId=n,vt.viewportId=e,vt.preventClickTimeout=setTimeout(Bw,vt.clickDelay),vt.element.removeEventListener("mousemove",Qa);const o=ni(i,vt.element);vt.startPoints=vo(o),vt.lastPoints=vo(o),document.addEventListener("mouseup",Fl),document.addEventListener("mousemove",ef)}function Fw(i){const t=Sr(vt.startPoints,vt.startPoints),n={event:i,eventName:xu,element:vt.element,mouseButton:vt.mouseButton,renderingEngineId:vt.renderingEngineId,viewportId:vt.viewportId,camera:{},startPoints:vt.startPoints,lastPoints:vt.startPoints,currentPoints:vt.startPoints,deltaPoints:t};vt.lastPoints=vo(n.lastPoints),gt(n.element,xu,n)&&gt(n.element,Ow,n)}function ef(i){if(!y(vt.element)?.viewport)return;const n=ni(i,vt.element),e=sf(vt.element,vt.lastPoints),o=Sr(n,e);if(Ee.doubleClickTimeout)if(of(o.canvas))Fs();else return;const a={event:i,eventName:yu,mouseButton:vt.mouseButton,renderingEngineId:vt.renderingEngineId,viewportId:vt.viewportId,camera:{},element:vt.element,startPoints:vo(vt.startPoints),lastPoints:vo(e),currentPoints:n,deltaPoints:o};!gt(vt.element,yu,a)&&(i.stopImmediatePropagation(),i.preventDefault()),vt.lastPoints=vo(n)}function Fl(i){if(clearTimeout(vt.preventClickTimeout),Ee.doubleClickTimeout)Ee.mouseUpEvent?jc():(Ee.mouseUpEvent=i,vt.element.addEventListener("mousemove",nf));else{const t=vt.isClickEvent?Lw:Rw,n=ni(i,vt.element),e=Sr(n,vt.lastPoints),o={event:i,eventName:t,mouseButton:vt.mouseButton,element:vt.element,renderingEngineId:vt.renderingEngineId,viewportId:vt.viewportId,camera:{},startPoints:vo(vt.startPoints),lastPoints:vo(vt.lastPoints),currentPoints:n,deltaPoints:e};gt(o.element,t,o),jc()}document.removeEventListener("mousemove",ef)}function nf(i){const t=ni(i,vt.element),n=sf(vt.element,vt.lastPoints),e=Sr(t,n);of(e.canvas)&&(Fs(),Qa(i))}function of(i){return Math.abs(i[0])+Math.abs(i[1])>kw}function Bw(){vt.isClickEvent=!1}function Fs(){Ee.ignoreDoubleClick=!0;const i=Ee.mouseDownEvent,t=Ee.mouseUpEvent;af(),Fw(i),t&&Fl(t)}function af(){Ee.doubleClickTimeout&&(clearTimeout(Ee.doubleClickTimeout),Ee.doubleClickTimeout=null),Ee.mouseDownEvent=null,Ee.mouseUpEvent=null}function jc(){document.removeEventListener("mouseup",Fl),vt.element?.removeEventListener("mousemove",nf),vt.element?.addEventListener("mousemove",Qa),af(),vt=JSON.parse(JSON.stringify(Vw))}function vo(i){return JSON.parse(JSON.stringify(i))}function sf(i,t){const{viewport:n}=y(i)||{};if(!n)return t;const e=n.canvasToWorld(t.canvas);return{page:t.page,client:t.client,canvas:t.canvas,world:e}}function Sr(i,t){return!i||!t?{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}:{page:cc(i.page,t.page),client:cc(i.client,t.client),canvas:cc(i.canvas,t.canvas),world:Gw(i.world,t.world)}}function cc(i,t){return[i[0]-t[0],i[1]-t[1]]}function Gw(i,t){return[i[0]-t[0],i[1]-t[1],i[2]-t[2]]}function Ww(){return vt.mouseButton}function rf(i){Ee.ignoreDoubleClick?(Ee.ignoreDoubleClick=!1,i.stopImmediatePropagation(),i.preventDefault()):jc()}function cf(i){i.removeEventListener("dblclick",Qg),i.removeEventListener("mousedown",tf),i.removeEventListener("mousemove",Qa),i.removeEventListener("dblclick",rf,{capture:!0})}function $w(i){cf(i),i.addEventListener("dblclick",Qg),i.addEventListener("mousedown",tf),i.addEventListener("mousemove",Qa),i.addEventListener("dblclick",rf,{capture:!0})}const lf={enable:$w,disable:cf},Hw=2e3,Oi={mouse:0,touch:1};let Au,Ou;function df(i,t){const n=Date.now();if(i!==Au){if(n-Ou<=Hw)return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1;Au=i}Ou=n}const uf=df.bind(null,Oi.mouse),hf=df.bind(null,Oi.touch);function Lu(i,t,n){const e=n?uf:hf;t.forEach(function(o){i.addEventListener(o,e,{passive:!1})})}function Ru(i,t,n){const e=n?uf:hf;t.forEach(function(o){i.removeEventListener(o,e)})}const gf=["mousedown","mouseup","mousemove"],ff=["touchstart","touchend"];function mf(i){Ru(i,gf,Oi.mouse),Ru(i,ff,Oi.touch)}function zw(i){mf(i),Lu(i,gf,Oi.mouse),Lu(i,ff,Oi.touch)}const pf={enable:zw,disable:mf};function _r(i,t){const n=t||i.currentTarget,e=i.type==="touchend"?i.changedTouches:i.touches;return Object.keys(e).map(o=>{const a=Yw(e[o]),s=Xw(e[o]),r=jw(n,s),{viewport:c}=y(n),l=c.canvasToWorld(r);return{page:s,client:a,canvas:r,world:l,touch:{identifier:o,radiusX:e[o].radiusX,radiusY:e[o].radiusY,force:e[o].force,rotationAngle:e[o].rotationAngle}}})}function jw(i,t){const n=i.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}function Xw(i){return[i.pageX,i.pageY]}function Yw(i){return[i.clientX,i.clientY]}function Bs(i,t){const n=Ra(i),e=Ra(t);return{page:lc(n.page,e.page),client:lc(n.client,e.client),canvas:lc(n.canvas,e.canvas),world:Kw(n.world,e.world)}}function Bl(i,t){const n=Ra(i),e=Ra(t);return{page:bi(n.page,e.page),client:bi(n.client,e.client),canvas:bi(n.canvas,e.canvas),world:vf(n.world,e.world)}}function qw(i,t){}function Gs(i,t){const n=Nu(i),e=Nu(t);return{page:n.page-e.page,client:n.client-e.client,canvas:n.canvas-e.canvas,world:n.world-e.world}}function Ln(i){return JSON.parse(JSON.stringify(i))}function Xc(i){return JSON.parse(JSON.stringify(i))}function Ra(i){return i.reduce((t,n)=>({page:[t.page[0]+n.page[0]/i.length,t.page[1]+n.page[1]/i.length],client:[t.client[0]+n.client[0]/i.length,t.client[1]+n.client[1]/i.length],canvas:[t.canvas[0]+n.canvas[0]/i.length,t.canvas[1]+n.canvas[1]/i.length],world:[t.world[0]+n.world[0]/i.length,t.world[1]+n.world[1]/i.length,t.world[2]+n.world[2]/i.length]}),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]})}function Cn(i){return i.reduce((t,n)=>({page:[t.page[0]+n.page[0]/i.length,t.page[1]+n.page[1]/i.length],client:[t.client[0]+n.client[0]/i.length,t.client[1]+n.client[1]/i.length],canvas:[t.canvas[0]+n.canvas[0]/i.length,t.canvas[1]+n.canvas[1]/i.length],world:[t.world[0]+n.world[0]/i.length,t.world[1]+n.world[1]/i.length,t.world[2]+n.world[2]/i.length],touch:{identifier:null,radiusX:t.touch.radiusX+n.touch.radiusX/i.length,radiusY:t.touch.radiusY+n.touch.radiusY/i.length,force:t.touch.force+n.touch.force/i.length,rotationAngle:t.touch.rotationAngle+n.touch.rotationAngle/i.length}}),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0],touch:{identifier:null,radiusX:0,radiusY:0,force:0,rotationAngle:0}})}function lc(i,t){return[i[0]-t[0],i[1]-t[1]]}function Kw(i,t){return[i[0]-t[0],i[1]-t[1],i[2]-t[2]]}function Nu(i){const t=[];for(let n=0;n<i.length;n++)for(let e=0;e<i.length;e++)n<e&&t.push({page:bi(i[n].page,i[e].page),client:bi(i[n].client,i[e].client),canvas:bi(i[n].canvas,i[e].canvas),world:vf(i[n].world,i[e].world)});return t.reduce((n,e)=>({page:n.page+e.page/t.length,client:n.client+e.client/t.length,canvas:n.canvas+e.canvas/t.length,world:n.world+e.world/t.length}),{page:0,client:0,canvas:0,world:0})}function bi(i,t){return Math.sqrt(Math.pow(i[0]-t[0],2)+Math.pow(i[1]-t[1],2))}function vf(i,t){return Math.sqrt(Math.pow(i[0]-t[0],2)+Math.pow(i[1]-t[1],2)+Math.pow(i[2]-t[2],2))}const Zw=Object.freeze(Object.defineProperty({__proto__:null,copyPoints:Xc,copyPointsList:Ln,getDeltaDistance:Bl,getDeltaDistanceBetweenIPoints:Gs,getDeltaPoints:Bs,getDeltaRotation:qw,getMeanPoints:Ra,getMeanTouchPoints:Cn},Symbol.toStringTag,{value:"Module"}));Bg.getRuntimeSettings();const{TOUCH_START:Uu,TOUCH_START_ACTIVATE:Jw,TOUCH_PRESS:ku,TOUCH_DRAG:Vu,TOUCH_END:Fu,TOUCH_TAP:Bu,TOUCH_SWIPE:dc}=w,Na={page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},Ws={page:0,client:0,canvas:0,world:0},If={renderingEngineId:void 0,viewportId:void 0,element:null,startPointsList:[{...Na,touch:null}],lastPointsList:[{...Na,touch:null}],isTouchStart:!1,startTime:null,pressTimeout:null,pressDelay:700,pressMaxDistance:5,accumulatedDistance:Ws,swipeDistanceThreshold:48,swiped:!1,swipeToleranceMs:300},wf={renderingEngineId:void 0,viewportId:void 0,element:null,startPointsList:[{...Na,touch:null}],taps:0,tapTimeout:null,tapMaxDistance:24,tapToleranceMs:300};let ot=JSON.parse(JSON.stringify(If)),ge=JSON.parse(JSON.stringify(wf));function _o(i,t,n){return gt(i,t,n)}function Cf(i){ot.element=i.currentTarget;const t=y(ot.element),{renderingEngineId:n,viewportId:e}=t;ot.renderingEngineId=n,ot.viewportId=e,!ot.isTouchStart&&(clearTimeout(ot.pressTimeout),ot.pressTimeout=setTimeout(()=>Qw(i),ot.pressDelay),tC(i),document.addEventListener("touchmove",Ef),document.addEventListener("touchend",Sf))}function Qw(i){if(ot.accumulatedDistance.canvas>ot.pressMaxDistance)return;const n={event:i,eventName:ku,renderingEngineId:ot.renderingEngineId,viewportId:ot.viewportId,camera:{},element:ot.element,startPointsList:Ln(ot.startPointsList),lastPointsList:Ln(ot.lastPointsList),startPoints:Xc(Cn(ot.startPointsList)),lastPoints:Xc(Cn(ot.lastPointsList))};_o(n.element,ku,n)}function tC(i){ot.isTouchStart=!0,ot.startTime=new Date;const t=_r(i,ot.element),n=Cn(t),e=Na,o=Ws,a={event:i,eventName:Uu,element:ot.element,renderingEngineId:ot.renderingEngineId,viewportId:ot.viewportId,camera:{},startPointsList:t,lastPointsList:t,currentPointsList:t,startPoints:n,lastPoints:n,currentPoints:n,deltaPoints:e,deltaDistance:o};ot.startPointsList=Ln(a.startPointsList),ot.lastPointsList=Ln(a.lastPointsList),_o(a.element,Uu,a)&&_o(a.element,Jw,a)}function Ef(i){const t=_r(i,ot.element),n=_f(ot.element,ot.lastPointsList),e=t.length===n.length?Bs(t,n):Na,o=t.length===n.length?Gs(t,n):Ws,a=t.length===n.length?Bl(t,ot.lastPointsList):Ws;ot.accumulatedDistance={page:ot.accumulatedDistance.page+a.page,client:ot.accumulatedDistance.client+a.client,canvas:ot.accumulatedDistance.canvas+a.canvas,world:ot.accumulatedDistance.world+a.world};const s={event:i,eventName:Vu,renderingEngineId:ot.renderingEngineId,viewportId:ot.viewportId,camera:{},element:ot.element,startPoints:Cn(ot.startPointsList),lastPoints:Cn(n),currentPoints:Cn(t),startPointsList:Ln(ot.startPointsList),lastPointsList:Ln(n),currentPointsList:t,deltaPoints:e,deltaDistance:o};_o(ot.element,Vu,s),nC(i,e),ot.lastPointsList=Ln(t)}function Sf(i){clearTimeout(ot.pressTimeout);const t=_r(i,ot.element),n=_f(ot.element,ot.lastPointsList),e=t.length===n.length?Bs(t,n):Bs(t,t),o=t.length===n.length?Gs(t,n):Gs(t,t),a={event:i,eventName:Fu,element:ot.element,renderingEngineId:ot.renderingEngineId,viewportId:ot.viewportId,camera:{},startPointsList:Ln(ot.startPointsList),lastPointsList:Ln(n),currentPointsList:t,startPoints:Cn(ot.startPointsList),lastPoints:Cn(n),currentPoints:Cn(t),deltaPoints:e,deltaDistance:o};_o(a.element,Fu,a),eC(i),ot=JSON.parse(JSON.stringify(If)),document.removeEventListener("touchmove",Ef),document.removeEventListener("touchend",Sf)}function eC(i){const t=new Date().getTime(),n=ot.startTime.getTime();if(t-n>ge.tapToleranceMs||(ge.taps===0&&(ge.element=ot.element,ge.renderingEngineId=ot.renderingEngineId,ge.viewportId=ot.viewportId,ge.startPointsList=ot.startPointsList),ge.taps>0&&!(ge.element==ot.element&&ge.renderingEngineId==ot.renderingEngineId&&ge.viewportId==ot.viewportId)))return;const e=_r(i,ge.element);Bl(e,ge.startPointsList).canvas>ge.tapMaxDistance||(clearTimeout(ge.tapTimeout),ge.taps+=1,ge.tapTimeout=setTimeout(()=>{const a={event:i,eventName:Bu,element:ge.element,renderingEngineId:ge.renderingEngineId,viewportId:ge.viewportId,camera:{},currentPointsList:e,currentPoints:Cn(e),taps:ge.taps};_o(a.element,Bu,a),ge=JSON.parse(JSON.stringify(wf))},ge.tapToleranceMs))}function nC(i,t){const n=new Date().getTime(),e=ot.startTime.getTime();if(ot.swiped||n-e>ot.swipeToleranceMs)return;const[o,a]=t.canvas,s={event:i,eventName:dc,renderingEngineId:ot.renderingEngineId,viewportId:ot.viewportId,camera:{},element:ot.element,swipe:null};Math.abs(o)>ot.swipeDistanceThreshold&&(s.swipe=o>0?Bo.RIGHT:Bo.LEFT,_o(s.element,dc,s),ot.swiped=!0),Math.abs(a)>ot.swipeDistanceThreshold&&(s.swipe=a>0?Bo.DOWN:Bo.UP,_o(s.element,dc,s),ot.swiped=!0)}function _f(i,t){const{viewport:n}=y(i);return t.map(e=>{const o=n.canvasToWorld(e.canvas);return{page:e.page,client:e.client,canvas:e.canvas,world:o,touch:e.touch}})}function Df(i){pf.disable(i),i.removeEventListener("touchstart",Cf)}function oC(i){Df(i),pf.enable(i),i.addEventListener("touchstart",Cf,{passive:!1})}const bf={enable:oC,disable:Df},Gu=10,Wu=40,$u=800;function iC(i){let t=0,n=0,e=0,o=0;return"detail"in i&&(n=i.detail),"wheelDelta"in i&&(n=-i.wheelDelta/120),"wheelDeltaY"in i&&(n=-i.wheelDeltaY/120),"wheelDeltaX"in i&&(t=-i.wheelDeltaX/120),e=t*Gu,o=n*Gu,"deltaY"in i&&(o=i.deltaY),"deltaX"in i&&(e=i.deltaX),(e||o)&&i.deltaMode&&(i.deltaMode===1?(e*=Wu,o*=Wu):(e*=$u,o*=$u)),e&&!t&&(t=e<1?-1:1),o&&!n&&(n=o<1?-1:1),{spinX:t,spinY:n,pixelX:e,pixelY:o}}function Tf(i){const t=i.currentTarget,n=y(t),{renderingEngineId:e,viewportId:o}=n;if(i.deltaY>-1&&i.deltaY<1)return;i.preventDefault();const{spinX:a,spinY:s,pixelX:r,pixelY:c}=iC(i),l=s<0?-1:1,d={event:i,eventName:w.MOUSE_WHEEL,renderingEngineId:e,viewportId:o,element:t,camera:{},detail:i,wheel:{spinX:a,spinY:s,pixelX:r,pixelY:c,direction:l},points:ni(i)};gt(t,w.MOUSE_WHEEL,d)}function aC(i){Pf(i),i.addEventListener("wheel",Tf,{passive:!1})}function Pf(i){i.removeEventListener("wheel",Tf)}const Mf={enable:aC,disable:Pf},sC={renderingEngineId:void 0,viewportId:void 0,key:void 0,keyCode:void 0,element:null};let pe={renderingEngineId:void 0,viewportId:void 0,key:void 0,keyCode:void 0,element:null};function Dr(i){pe.element=i.currentTarget;const t=y(pe.element),{renderingEngineId:n,viewportId:e}=t;pe.renderingEngineId=n,pe.viewportId=e,pe.key=i.key,pe.keyCode=i.keyCode,i.preventDefault();const o={renderingEngineId:pe.renderingEngineId,viewportId:pe.viewportId,element:pe.element,key:pe.key,keyCode:pe.keyCode};gt(o.element,w.KEY_DOWN,o),document.addEventListener("keyup",xf),document.addEventListener("visibilitychange",Gl),pe.element.removeEventListener("keydown",Dr)}function Gl(){document.removeEventListener("visibilitychange",Gl),document.visibilityState==="hidden"&&yf()}function xf(i){const t={renderingEngineId:pe.renderingEngineId,viewportId:pe.viewportId,element:pe.element,key:pe.key,keyCode:pe.keyCode};document.removeEventListener("keyup",xf),document.removeEventListener("visibilitychange",Gl),pe.element.addEventListener("keydown",Dr),pe=structuredClone(sC),gt(t.element,w.KEY_UP,t)}function rC(){return pe.keyCode}function yf(){pe.keyCode=void 0}function cC(i){Af(i),i.addEventListener("keydown",Dr)}function Af(i){i.removeEventListener("keydown",Dr)}const Gi={enable:cC,disable:Af,getModifierKey:rC},{EPSILON:li}=Qo;function Of(i,t,n=!1){let e=1/0,o=n?-1/0:0,a=1/0,s=n?-1/0:0,r=1/0,c=n?-1/0:0;const l=i[0]?.length===3;for(let d=0;d<i.length;d++){const u=i[d];e=Math.min(u[0],e),o=Math.max(u[0],o),a=Math.min(u[1],a),s=Math.max(u[1],s),l&&(r=Math.min(u[2]??r,r),c=Math.max(u[2]??c,c))}return t?(e=Math.max(n?t[0]+li:0,e),o=Math.min(n?t[0]-li:t[0]-1,o),a=Math.max(n?t[1]+li:0,a),s=Math.min(n?t[1]-li:t[1]-1,s),l&&t.length===3&&(r=Math.max(n?t[2]+li:0,r),c=Math.min(n?t[2]-li:t[2]-1,c))):n||(e=Math.max(0,e),o=Math.min(1/0,o),a=Math.max(0,a),s=Math.min(1/0,s),l&&(r=Math.max(0,r),c=Math.min(1/0,c))),l?[[e,o],[a,s],[r,c]]:[[e,o],[a,s],null]}function Do(i,t){return Of(i,t,!1)}function lC(i,t){return Of(i,t,!0)}const dC=(i,t)=>JSON.stringify(i)===JSON.stringify(t);function Wl(i,t,n,e){const o=n[0]/2,a=n[1]/2,s=n[2]/2,r=new Array(8);r[0]=xe(i,[e[0]-o,e[1]-a,e[2]-s]);const c=[[1,-1,-1],[-1,1,-1],[1,1,-1],[-1,-1,1],[1,-1,1],[-1,1,1],[1,1,1]];for(let l=0;l<7;l++){const[d,u,h]=c[l];r[l+1]=xe(i,[e[0]+d*o,e[1]+u*a,e[2]+h*s])}return Do(r,t)}function Lf(i,t){const{spacing:n}=i,e=i.voxelManager.getScalarDataLength(),o=[];let a=0;for(let s=0;s<t.length;s++){const{imageData:r,spacing:c,dimensions:l,voxelManager:d}=t[s].volume,u=t[s].volume.voxelManager.getScalarDataLength();u===e&&dC(c,n)&&(a=s);const h=t[s].lower,g=t[s].upper;o.push({imageData:r,lower:h,upper:g,spacing:c,dimensions:l,volumeSize:u,voxelManager:d})}return{volumeInfoList:o,baseVolumeIdx:a}}const $l=new Map,uC=i=>{const t=$l.get(i);t&&(t.isDirty=!0)},hC=i=>{const t=$l.get(i);return t&&!t.isDirty?t.indices:null},gC=(i,t)=>{$l.set(i,{indices:t,isDirty:!1})};function Pe(i,t,n){const e={segmentationId:i,modifiedSlicesToUse:t,segmentIndex:n};uC(i),gt(z,w.SEGMENTATION_DATA_MODIFIED,e)}function gn(i){const t={segmentationId:i};gt(z,w.SEGMENTATION_MODIFIED,t)}function Hl(i){const t={segmentationId:i};gt(z,w.SEGMENTATION_REMOVED,t)}function An(i,t,n){const e={segmentationId:t,type:n,viewportId:i};gt(z,w.SEGMENTATION_REPRESENTATION_MODIFIED,e)}function Yc(i,t,n){const e={viewportId:i,segmentationId:t,type:n};gt(z,w.SEGMENTATION_REPRESENTATION_REMOVED,e)}const fC=Object.freeze(Object.defineProperty({__proto__:null,triggerSegmentationDataModified:Pe,triggerSegmentationModified:gn,triggerSegmentationRemoved:Hl,triggerSegmentationRepresentationModified:An,triggerSegmentationRepresentationRemoved:Yc},Symbol.toStringTag,{value:"Module"})),mC={renderOutline:!0,outlineWidthAutoGenerated:3,outlineWidth:1,outlineWidthInactive:1,outlineOpacity:1,outlineOpacityInactive:.85,outlineDash:void 0,outlineDashInactive:void 0,outlineDashAutoGenerated:"5,3",activeSegmentOutlineWidthDelta:0,renderFill:!0,fillAlpha:.5,fillAlphaInactive:.3,fillAlphaAutoGenerated:.3};function pC(){return mC}const vC={renderOutline:!0,renderOutlineInactive:!0,outlineWidth:3,outlineWidthInactive:2,activeSegmentOutlineWidthDelta:0,renderFill:!0,renderFillInactive:!0,fillAlpha:.5,fillAlphaInactive:.4,outlineOpacity:1,outlineOpacityInactive:.85};function IC(){return vC}class wC{constructor(){this.config={global:{},segmentations:{},viewportsStyle:{}}}setStyle(t,n,e=!0){const{viewportId:o,segmentationId:a,type:s,segmentIndex:r}=t,c=this.getStyle(t),l=e?{...c,...n}:n;let d;if(!o&&!a?d=l:e?d=this.copyActiveToInactiveIfNotProvided(l,s):d=l,!s)throw new Error("Type is required to set a style");if(o){this.config.viewportsStyle[o]||(this.config.viewportsStyle[o]={renderInactiveSegmentations:!1,representations:{}});const u=this.config.viewportsStyle[o].representations;if(a){u[a]||(u[a]={}),u[a][s]||(u[a][s]={});const h=u[a][s];r!==void 0?(h.perSegment||(h.perSegment={}),h.perSegment[r]=d):h.allSegments=d}else{const h="__allSegmentations__";u[h]||(u[h]={}),u[h][s]||(u[h][s]={}),u[h][s].allSegments=d}}else if(a){this.config.segmentations[a]||(this.config.segmentations[a]={}),this.config.segmentations[a][s]||(this.config.segmentations[a][s]={});const u=this.config.segmentations[a][s];r!==void 0?(u.perSegment||(u.perSegment={}),u.perSegment[r]=d):u.allSegments=d}else this.config.global[s]=d}copyActiveToInactiveIfNotProvided(t,n){const e={...t};if(n===tt.Labelmap){const o=e;o.renderOutlineInactive??=o.renderOutline,o.outlineWidthInactive??=o.outlineWidth,o.renderFillInactive??=o.renderFill,o.fillAlphaInactive??=o.fillAlpha,o.outlineOpacityInactive??=o.outlineOpacity}else if(n===tt.Contour){const o=e;o.outlineWidthInactive??=o.outlineWidth,o.outlineOpacityInactive??=o.outlineOpacity,o.outlineDashInactive??=o.outlineDash,o.renderOutlineInactive??=o.renderOutline,o.renderFillInactive??=o.renderFill,o.fillAlphaInactive??=o.fillAlpha}return e}getStyle(t){const{viewportId:n,segmentationId:e,type:o,segmentIndex:a}=t;let s=this.getDefaultStyle(o);if(this.config.global[o]&&(s={...s,...this.config.global[o]}),this.config.segmentations[e]?.[o]&&(s={...s,...this.config.segmentations[e][o].allSegments},a!==void 0&&this.config.segmentations[e][o].perSegment?.[a]&&(s={...s,...this.config.segmentations[e][o].perSegment[a]})),n&&this.config.viewportsStyle[n]){this.config.viewportsStyle[n].renderInactiveSegmentations;const r="__allSegmentations__";this.config.viewportsStyle[n].representations[r]?.[o]&&(s={...s,...this.config.viewportsStyle[n].representations[r][o].allSegments}),e&&this.config.viewportsStyle[n].representations[e]?.[o]&&(s={...s,...this.config.viewportsStyle[n].representations[e][o].allSegments},a!==void 0&&this.config.viewportsStyle[n].representations[e][o].perSegment?.[a]&&(s={...s,...this.config.viewportsStyle[n].representations[e][o].perSegment[a]}))}return s}getRenderInactiveSegmentations(t){return this.config.viewportsStyle[t]?.renderInactiveSegmentations}setRenderInactiveSegmentations(t,n){this.config.viewportsStyle[t]||(this.config.viewportsStyle[t]={renderInactiveSegmentations:!1,representations:{}}),this.config.viewportsStyle[t].renderInactiveSegmentations=n}getDefaultStyle(t){switch(t){case tt.Labelmap:return IC();case tt.Contour:return pC();case tt.Surface:return{};default:throw new Error(`Unknown representation type: ${t}`)}}clearSegmentationStyle(t){this.config.segmentations[t]&&delete this.config.segmentations[t]}clearAllSegmentationStyles(){this.config.segmentations={}}clearViewportStyle(t){this.config.viewportsStyle[t]&&delete this.config.viewportsStyle[t]}clearAllViewportStyles(){for(const t in this.config.viewportsStyle){const e=this.config.viewportsStyle[t].renderInactiveSegmentations;this.config.viewportsStyle[t]={renderInactiveSegmentations:e,representations:{}}}}resetToGlobalStyle(){this.clearAllSegmentationStyles(),this.clearAllViewportStyles()}hasCustomStyle(t){const{type:n}=t,e=this.getStyle(t),o=this.getDefaultStyle(n);return!GI(e,o)}}const Xe=new wC;function CC(i){const t={segmentationId:i};gt(z,w.SEGMENTATION_ADDED,t)}const Hu={colorLUT:[],segmentations:[],viewportSegRepresentations:{}};class EC{constructor(t){this._stackLabelmapImageIdReferenceMap=new Map,this._labelmapImageIdReferenceMap=new Map,t||=Xt(),this.state=Object.freeze(Ro(Hu)),this.uid=t}getState(){return this.state}updateState(t){const n=Ro(this.state);t(n),this.state=Object.freeze(n)}getColorLUT(t){return this.state.colorLUT[t]}getNextColorLUTIndex(){return this.state.colorLUT.length}resetState(){this._stackLabelmapImageIdReferenceMap.clear(),this._labelmapImageIdReferenceMap.clear(),this.state=Object.freeze(Ro(Hu))}getSegmentation(t){return this.state.segmentations.find(n=>n.segmentationId===t)}updateSegmentation(t,n){this.updateState(e=>{const o=e.segmentations.find(a=>a.segmentationId===t);if(!o){console.warn(`Segmentation with id ${t} not found. Update aborted.`);return}Object.assign(o,n)}),gn(t)}addSegmentation(t){if(this.getSegmentation(t.segmentationId))throw new Error(`Segmentation with id ${t.segmentationId} already exists`);this.updateState(n=>{const e=Ro(t);if(e.representationData.Labelmap&&"volumeId"in e.representationData.Labelmap&&!("imageIds"in e.representationData.Labelmap)){const o=this.getLabelmapImageIds(e.representationData);e.representationData.Labelmap.imageIds=o}n.segmentations.push(e)}),CC(t.segmentationId)}removeSegmentation(t){this.updateState(n=>{const e=n.segmentations.filter(o=>o.segmentationId!==t);n.segmentations.splice(0,n.segmentations.length,...e)}),Hl(t)}addSegmentationRepresentation(t,n,e,o){if(!At(t))return;if(this.getSegmentationRepresentations(t,{type:e,segmentationId:n}).length>0){console.debug("A segmentation representation of type",e,"already exists in viewport",t,"for segmentation",n);return}this.updateState(r=>{r.viewportSegRepresentations[t]||(r.viewportSegRepresentations[t]=[],Xe.setRenderInactiveSegmentations(t,!0)),e!==tt.Labelmap?this.addDefaultSegmentationRepresentation(r,t,n,e,o):this.addLabelmapRepresentation(r,t,n,o)}),An(t,n,e)}addDefaultSegmentationRepresentation(t,n,e,o,a){const s=t.segmentations.find(c=>c.segmentationId===e);if(!s)return;const r={};Object.keys(s.segments).forEach(c=>{r[Number(c)]={visible:!0}}),t.viewportSegRepresentations[n].push({segmentationId:e,type:o,active:!0,visible:!0,colorLUTIndex:a?.colorLUTIndex||0,segments:r,config:{...zu(o),...a}}),this._setActiveSegmentation(t,n,e)}addLabelmapRepresentation(t,n,e,o=zu(tt.Labelmap)){if(!At(n))return;const s=this.getSegmentation(e);if(!s)return;const{representationData:r}=s;if(!r.Labelmap)return this.addDefaultSegmentationRepresentation(t,n,e,tt.Labelmap,o);this.processLabelmapRepresentationAddition(n,e),this.addDefaultSegmentationRepresentation(t,n,e,tt.Labelmap,o)}async processLabelmapRepresentationAddition(t,n){const e=At(t);if(!e)return;const o=this.getSegmentation(n);if(!o)return;const a=e.viewport instanceof ve,{representationData:s}=o,r="volumeId"in s.Labelmap;e.viewport,!a&&!r&&this.updateLabelmapSegmentationImageReferences(t,o.segmentationId)}_updateLabelmapSegmentationReferences(t,n,e,o){const a=n.getCurrentImageId();let s=!1;for(const r of e)n.isReferenceViewable({referencedImageId:r},{asOverlay:!0})&&(s=!0,this._stackLabelmapImageIdReferenceMap.get(t).set(a,r),this._updateLabelmapImageIdReferenceMap({segmentationId:t,referenceImageId:a,labelmapImageId:r}));return o&&o(n,t,e),s?this._stackLabelmapImageIdReferenceMap.get(t).get(a):void 0}updateLabelmapSegmentationImageReferences(t,n){const e=this.getSegmentation(n);if(!e)return;this._stackLabelmapImageIdReferenceMap.has(n)||this._stackLabelmapImageIdReferenceMap.set(n,new Map);const{representationData:o}=e;if(!o.Labelmap)return;const a=this.getLabelmapImageIds(o),r=At(t).viewport;return this._updateLabelmapSegmentationReferences(n,r,a,null)}_updateAllLabelmapSegmentationImageReferences(t,n){const e=this.getSegmentation(n);if(!e)return;this._stackLabelmapImageIdReferenceMap.has(n)||this._stackLabelmapImageIdReferenceMap.set(n,new Map);const{representationData:o}=e;if(!o.Labelmap)return;const a=this.getLabelmapImageIds(o),r=At(t).viewport;this._updateLabelmapSegmentationReferences(n,r,a,(c,l,d)=>{c.getImageIds().forEach((h,g)=>{for(const f of d)c.isReferenceViewable({referencedImageId:f,sliceIndex:g},{asOverlay:!0,withNavigation:!0})&&(this._stackLabelmapImageIdReferenceMap.get(l).set(h,f),this._updateLabelmapImageIdReferenceMap({segmentationId:l,referenceImageId:h,labelmapImageId:f}))})})}getLabelmapImageIds(t){const n=t.Labelmap;let e;if(n.imageIds)e=n.imageIds;else if(!e&&n.volumeId){const o=n.volumeId;e=X.getVolume(o).imageIds}return e}getLabelmapImageIdsForImageId(t,n){const e=this._generateMapKey({segmentationId:n,referenceImageId:t});return this._labelmapImageIdReferenceMap.get(e)}getCurrentLabelmapImageIdsForViewport(t,n){const e=At(t);if(!e)return;const a=e.viewport.getCurrentImageId();return this.getLabelmapImageIdsForImageId(a,n)}getCurrentLabelmapImageIdForViewport(t,n){const e=At(t);if(!e||!this._stackLabelmapImageIdReferenceMap.has(n))return;const a=e.viewport.getCurrentImageId();return this._stackLabelmapImageIdReferenceMap.get(n).get(a)}getStackSegmentationImageIdsForViewport(t,n){if(!this.getSegmentation(n))return[];this._updateAllLabelmapSegmentationImageReferences(t,n);const{viewport:o}=At(t),a=o.getImageIds(),s=this._stackLabelmapImageIdReferenceMap.get(n);return a.map(r=>s.get(r))}removeSegmentationRepresentationsInternal(t,n){const e=[];return this.updateState(o=>{if(!o.viewportSegRepresentations[t])return;const a=o.viewportSegRepresentations[t];let s=!1;if(!n||Object.values(n).every(r=>r===void 0))e.push(...a),delete o.viewportSegRepresentations[t];else{const{segmentationId:r,type:c}=n;o.viewportSegRepresentations[t]=a.filter(l=>{const d=r&&c&&l.segmentationId===r&&l.type===c||r&&!c&&l.segmentationId===r||!r&&c&&l.type===c;return d&&(e.push(l),l.active&&(s=!0)),!d}),o.viewportSegRepresentations[t].length===0?delete o.viewportSegRepresentations[t]:s&&(o.viewportSegRepresentations[t][0].active=!0)}}),e}removeSegmentationRepresentations(t,n){const e=this.removeSegmentationRepresentationsInternal(t,n);e.forEach(a=>{Yc(t,a.segmentationId,a.type)});const o=this.getSegmentationRepresentations(t);return o.length>0&&o[0].active&&An(t,o[0].segmentationId,o[0].type),e}removeSegmentationRepresentation(t,n,e){const o=this.removeSegmentationRepresentationsInternal(t,n);return e||o.forEach(({segmentationId:a,type:s})=>{Yc(t,a,s)}),o}_updateLabelmapImageIdReferenceMap({segmentationId:t,referenceImageId:n,labelmapImageId:e}){const o=this._generateMapKey({segmentationId:t,referenceImageId:n});if(!this._labelmapImageIdReferenceMap.has(o)){this._labelmapImageIdReferenceMap.set(o,[e]);return}const a=this._labelmapImageIdReferenceMap.get(o),s=Array.from(new Set([...a,e]));this._labelmapImageIdReferenceMap.set(o,s)}_setActiveSegmentation(t,n,e){const o=t.viewportSegRepresentations[n];o&&o.forEach(a=>{a.active=a.segmentationId===e})}setActiveSegmentation(t,n){this.updateState(e=>{const o=e.viewportSegRepresentations[t];o&&o.forEach(a=>{a.active=a.segmentationId===n})}),An(t,n)}getActiveSegmentation(t){if(!this.state.viewportSegRepresentations[t])return;const n=this.state.viewportSegRepresentations[t].find(e=>e.active);if(n)return this.getSegmentation(n.segmentationId)}getSegmentationRepresentations(t,n={}){const e=this.state.viewportSegRepresentations[t];return e?!n.type&&!n.segmentationId?e:e.filter(o=>{const a=n.type?o.type===n.type:!0,s=n.segmentationId?o.segmentationId===n.segmentationId:!0;return a&&s}):[]}getSegmentationRepresentation(t,n){return this.getSegmentationRepresentations(t,n)[0]}getSegmentationRepresentationVisibility(t,n){return this.getSegmentationRepresentation(t,n)?.visible}setSegmentationRepresentationVisibility(t,n,e){this.updateState(o=>{const a=this.getSegmentationRepresentations(t,n);a&&a.forEach(s=>{s.visible=e,Object.entries(s.segments).forEach(([r,c])=>{c.visible=e})})}),An(t,n.segmentationId,n.type)}addColorLUT(t,n){this.updateState(e=>{e.colorLUT[n]&&console.warn("Color LUT table already exists, overwriting"),e.colorLUT[n]=Ro(t)})}removeColorLUT(t){this.updateState(n=>{delete n.colorLUT[t]})}_getStackIdForImageIds(t){return t.map(n=>n.slice(-Math.round(n.length*.15))).join("_")}getAllViewportSegmentationRepresentations(){return Object.entries(this.state.viewportSegRepresentations).map(([t,n])=>({viewportId:t,representations:n}))}getSegmentationRepresentationsBySegmentationId(t){const n=[];return Object.entries(this.state.viewportSegRepresentations).forEach(([e,o])=>{const a=o.filter(s=>s.segmentationId===t);a.length>0&&n.push({viewportId:e,representations:a})}),n}_generateMapKey({segmentationId:t,referenceImageId:n}){return`${t}-${n}`}}async function Rf({imageIds:i,options:t}){const n=i,e=t?.volumeId||Xt();return await Sg(e,n),{volumeId:e}}async function SC({segmentationId:i,options:t}){const n=Vt.getSegmentation(i),e=n.representationData.Labelmap,{volumeId:o}=await Rf({imageIds:e.imageIds,options:t});n.representationData.Labelmap.volumeId=o}function zu(i){const t=WI.newInstance(),n=$I.newInstance();return n.addPoint(0,0),i===tt.Labelmap?{cfun:t,ofun:n}:{}}const Vt=new EC("DEFAULT");function pt(i){return Vt.getSegmentation(i)}function Ye(i,t={}){return Vt.getSegmentationRepresentations(i,t)}function zl(i,t){const n=Vt;if(!t.segmentationId||!t.type)throw new Error("getSegmentationRepresentation: No segmentationId or type provided, you need to provide at least one of them");return n.getSegmentationRepresentations(i,t)?.[0]}function Nf(i){return Vt.getSegmentationRepresentationsBySegmentationId(i)}function _C(i,t){const n=y(i),{viewport:e}=n,a=e.getActors().filter(s=>s.representationUID&&typeof s.representationUID=="string"&&s.representationUID.startsWith(t));e.removeActors(a.map(s=>s.uid))}function Uf(i,t,n){const e=At(i);if(!e)return;const{renderingEngine:o,viewport:a}=e;if(!o||!a)return;const r=a.getActors().filter(n);return r.length>0?r[0]:void 0}function DC(i,t){const n=At(i);if(!n)return;const{renderingEngine:e,viewport:o}=n;if(!e||!o)return;const s=o.getActors().filter(t);return s.length>0?s:void 0}function bC(i,t){return br(i,t)?.uid}function fa(i,t){return DC(i,n=>n.representationUID?.startsWith(`${t}-${tt.Labelmap}`))}function br(i,t){return Uf(i,t,n=>n.representationUID?.startsWith(`${t}-${tt.Labelmap}`))}function TC(i,t,n){return Uf(i,t,e=>e.representationUID===kf(t,n))}function kf(i,t){return`${i}-${tt.Surface}-${t}`}function PC(i,t,n){const o=TC(i.id,n,t.segmentIndex)?.actor,a=t.visible;if(o){if(o.setVisibility(a),!a)return;const m=o.getMapper(),v=m.getInputData(),p=t.points,I=t.polys,C=v.getPoints().getData(),E=v.getPolys().getData();if(p.length===C.length&&I.length===E.length)return;const S=Eo.newInstance();S.getPoints().setData(p,3);const _=Bc.newInstance({values:Float32Array.from(I)});S.setPolys(_),m.setInputData(S),m.modified(),i.getRenderer().resetCameraClippingRange();return}const s=t.points,r=t.polys,c=t.color,l=Eo.newInstance();l.getPoints().setData(s,3);const d=Bc.newInstance({values:Float32Array.from(r)});l.setPolys(d);const u=xi.newInstance({});let h;u.setInputData(l);const g=yi.newInstance();g.setMapper(u),g.getProperty().setColor(c[0]/255,c[1]/255,c[2]/255),g.getProperty().setLineWidth(2);const f=kf(n,t.segmentIndex);i.addActor({uid:Xt(),actor:g,clippingFilter:h,representationUID:f}),i.resetCamera(),i.getRenderer().resetCameraClippingRange(),i.render()}function ts(i){return Vt.getColorLUT(i)}let $s={};function MC(){return $s}function xC(i){$s=i}let ju=!1;function Rn(){if(!$s.addons?.polySeg)return console.warn("PolySeg add-on not configured. This will prevent automatic conversion between segmentation representations (labelmap, contour, surface). To enable these features, install @cornerstonejs/polymorphic-segmentation and register it during initialization: cornerstoneTools.init({ addons: { polySeg } })."),null;const i=$s.addons.polySeg;return ju||(i.init(),ju=!0),i}function jl({segmentationId:i,type:t,data:n}){const e=pt(i);if(!e)throw new Error(`Segmentation ${i} not found`);switch(e.representationData[t]&&console.warn(`Representation data of type ${t} already exists for segmentation ${i}, overwriting it.`),t){case tt.Labelmap:n&&(e.representationData[t]=n);break;case tt.Contour:n&&(e.representationData[t]=n);break;case tt.Surface:n&&(e.representationData[t]=n);break;default:throw new Error(`Invalid representation type ${t}`)}}async function Xl(i,t,n,e){const o=await n();return jl({segmentationId:i,type:t,data:o}),e?.(),o}function Yl(i,t){const n=zl(i,t);return n?Object.entries(n.segments).reduce((o,[a,s])=>(s.visible||o.add(Number(a)),o),new Set):new Set}function yC(i,t,n=!1){const e=At(i);if(!e)return;const{viewport:o}=e;_C(o.element,t),n&&o.render()}async function AC(i,t){const{segmentationId:n,type:e}=t,o=pt(n);if(!o)return;let a=o.representationData[tt.Surface];if(!a&&Rn()?.canComputeRequestedRepresentation(n,tt.Surface)){const l=Rn();if(a=await Xl(n,tt.Surface,()=>l.computeSurfaceData(n,{viewport:i})),!a)throw new Error(`No Surface data found for segmentationId ${n} even we tried to compute it`)}else!a&&!Rn()&&console.debug(`No surface data found for segmentationId ${n} and PolySeg add-on is not configured. Unable to convert from other representations to surface. Please register PolySeg using cornerstoneTools.init({ addons: { polySeg } }) to enable automatic conversion.`);if(!a){console.warn(`No Surface data found for segmentationId ${n}. Skipping render.`);return}const{geometryIds:s}=a;s?.size||console.warn(`No Surfaces found for segmentationId ${n}. Skipping render.`);const{colorLUTIndex:r}=t,c=ts(r);s.forEach(l=>{const d=X.getGeometry(l);if(!d?.data){console.warn(`No Surfaces found for geometryId ${l}. Skipping render.`);return}const{segmentIndex:u}=d.data,g=Yl(i.id,{segmentationId:n,type:e}).has(u),f=d.data,m=c[u];f.color=m.slice(0,3),f.visible=!g,PC(i,f,n)}),i.render()}function OC(i){const t=Rn();return n=>t.updateSurfaceData(n,{viewport:i})}const ql={getUpdateFunction:OC,render:AC,removeRepresentation:yC};function LC(i,t,n,e){const o=i.getViewReference(),{viewPlaneNormal:a,FrameOfReferenceUID:s}=o,r={annotationUID:e?.annotationUID||Xt(),data:{handles:{points:n}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:t,viewPlaneNormal:a,FrameOfReferenceUID:s,referencedImageId:RC(i,n[0],a),...e}};return mt(r,i.element),r}function RC(i,t,n){let e;if(i instanceof Ie)e=Kl(i,t,n);else if(i instanceof ve){const o=NC(i),a=To(o),s=X.getVolume(a);e=qa(s,t,n)}else throw new Error("getReferencedImageId: viewport must be a StackViewport or BaseVolumeViewport");return e}function NC(i){const t=i.getViewReferenceId?.();if(t)return t;if(i instanceof ve)return`volumeId:${UC(i)}`;throw new Error("getTargetId: viewport must have a getTargetId method")}function UC(i){const t=i.getActors();if(t)return t.find(n=>n.actor.getClassName()==="vtkVolume")?.uid}function Kl(i,t,n){const e=i.getImageIds();if(!e||!e.length)return;const o=e.map(a=>{const{imagePositionPatient:s}=ye("imagePlaneModule",a),r=kC(t,s,n);return{imageId:a,distance:r}});return o.sort((a,s)=>a.distance-s.distance),o[0].imageId}function kC(i,t,n){const e=W();me(e,i,t);const o=dt(e,n);return Math.abs(o)}function Vf(i,t){const{segmentation:n}=i.data,{segmentation:e}=t.data;return n.segmentationId===e.segmentationId&&n.segmentIndex===e.segmentIndex}class Ff{constructor(t){this.getGroupKey=n=>{if(typeof n=="string")return n;const o=y(n);if(!o)throw new Error("Element not enabled, you must have an enabled element if you are not providing a FrameOfReferenceUID");return o.FrameOfReferenceUID},this._imageVolumeModifiedHandler=n=>{const e=n.detail,{FrameOfReferenceUID:o}=e,s=this.annotations[o];s&&Object.keys(s).forEach(r=>{s[r].forEach(l=>{l.invalidated!==void 0&&(l.invalidated=!0)})})},this.getFramesOfReference=()=>Object.keys(this.annotations),this.getAnnotations=(n,e)=>{const o=this.annotations;return o[n]?e?o[n][e]?o[n][e]:[]:o[n]:[]},this.getAnnotation=n=>{const e=this.annotations;for(const o in e){const a=e[o];for(const s in a){const r=a[s];for(const c of r)if(n===c.annotationUID)return c}}},this.getNumberOfAnnotations=(n,e)=>{const o=this.getAnnotations(n,e);if(!o.length)return 0;if(e)return o.length;let a=0;for(const s in o)a+=o[s].length;return a},this.addAnnotation=(n,e)=>{const{metadata:o}=n,{FrameOfReferenceUID:a,toolName:s}=o;e=e||a;const r=this.annotations;let c=r[e];c||(r[e]={},c=r[e]);let l=c[s];l||(c[s]=[],l=c[s]),this.preprocessingFn&&(n=this.preprocessingFn(n)),l.push(n)},this.removeAnnotation=n=>{const{annotations:e}=this;for(const o in e){const a=e[o];for(const s in a){const r=a[s],c=r.findIndex(l=>l.annotationUID===n);c!==-1&&(r.splice(c,1),r.length===0&&delete a[s])}Object.keys(a).length===0&&delete e[o]}},this.removeAnnotations=(n,e)=>{const o=this.annotations,a=[];if(!o[n])return a;if(e){const s=o[n][e];if(s)for(const r of s)this.removeAnnotation(r.annotationUID),a.push(r)}else for(const s in o[n]){const r=o[n][s];for(const c of r)this.removeAnnotation(c.annotationUID),a.push(c)}return a},this.saveAnnotations=(n,e)=>{const o=this.annotations;if(n&&e){const a=o[n];if(!a)return;const s=a[e];return structuredClone(s)}else if(n){const a=o[n];return structuredClone(a)}return structuredClone(o)},this.restoreAnnotations=(n,e,o)=>{const a=this.annotations;if(e&&o){let s=a[e];s||(a[e]={},s=a[e]),s[o]=n}else e?a[e]=n:this.annotations=structuredClone(n)},this.getAllAnnotations=()=>Object.values(this.annotations).map(n=>Object.values(n)).flat(2),this.getNumberOfAllAnnotations=()=>{let n=0;const e=this.annotations;for(const o in e){const a=e[o];for(const s in a){const r=a[s];n+=r.length}}return n},this.removeAllAnnotations=()=>{const n=[];for(const e of this.getAllAnnotations())this.removeAnnotation(e.annotationUID),n.push(e);return n},t||(t=Xt()),this.annotations={},this.uid=t,z.addEventListener(ut.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedHandler)}setPreprocessingFn(t){this.preprocessingFn=t}}const VC=new Ff("DEFAULT"),Io=new Set;function Tr(i,t=!0){const n=Gf();i&&(t?WC(i,Io,n):Wf(i,Io,n)),$f(n,Io)}function FC(){const i=Gf();$C(Io,i),$f(i,Io)}function BC(){return Array.from(Io)}function se(i){return Io.has(i)}function GC(){return Io.size}function Bf(i){const t=se(i);return Tr(i,t),t}function Gf(){return Object.freeze({added:[],removed:[],locked:[]})}function WC(i,t,n){if(!t.has(i)){t.add(i),n.added.push(i);const e=xt(i);e&&(e.isLocked=!0)}}function Wf(i,t,n){if(t.delete(i)){n.removed.push(i);const e=xt(i);e&&(e.isLocked=!1)}}function $C(i,t){i.forEach(n=>{Wf(n,i,t)})}function $f(i,t){(i.added.length>0||i.removed.length>0)&&(t.forEach(n=>{i.locked.push(n)}),gt(z,w.ANNOTATION_LOCK_CHANGE,i))}const HC=Object.freeze(Object.defineProperty({__proto__:null,checkAndSetAnnotationLocked:Bf,getAnnotationsLocked:BC,getAnnotationsLockedCount:GC,isAnnotationLocked:se,setAnnotationLocked:Tr,unlockAllAnnotations:FC},Symbol.toStringTag,{value:"Module"})),On=new Set;function cn(i,t=!0,n=!1){t?zC(i,n):Zl(i)}function zC(i,t=!1){const n=zf();if(!t){jf(On,n);const e=xt(i);e&&(e.isSelected=!0)}if(i&&!On.has(i)){On.add(i),n.added.push(i);const e=xt(i);e&&(e.isSelected=!0)}Xf(n,On)}function Zl(i){const t=zf();if(i){if(On.delete(i)){t.removed.push(i);const n=xt(i);n.isSelected=!1}}else jf(On,t);Xf(t,On)}function Hf(){return Array.from(On)}function jC(i){return Hf().filter(t=>xt(t)?.metadata?.toolName===i)}function es(i){return On.has(i)}function XC(){return On.size}function zf(){return Object.freeze({added:[],removed:[],selection:[]})}function jf(i,t){i.forEach(n=>{if(i.delete(n)){t.removed.push(n);const e=xt(n);e&&(e.isSelected=!1)}})}function Xf(i,t){(i.added.length>0||i.removed.length>0)&&(t.forEach(n=>{i.selection.push(n)}),gt(z,w.ANNOTATION_SELECTION_CHANGE,i))}const YC=Object.freeze(Object.defineProperty({__proto__:null,deselectAnnotation:Zl,getAnnotationsSelected:Hf,getAnnotationsSelectedByToolName:jC,getAnnotationsSelectedCount:XC,isAnnotationSelected:es,setAnnotationSelected:cn},Symbol.toStringTag,{value:"Module"})),qC=i=>(i.data||(i.data={}),i.data.handles||(i.data.handles={}),i.data.handles.textBox||(i.data.handles.textBox={}),i),KC=i=>(i.data||(i.data={}),i.data.cachedStats||(i.data.cachedStats={}),i),qo=new Set;function Yf(i,t=!0){const n=qf();i&&(t?Kf(i,qo,n):JC(i,qo,n)),Zf(n)}function ZC(){const i=qf();qo.forEach(t=>{Kf(t,qo,i)}),Zf(i)}function re(i){if(xt(i))return!qo.has(i)}function qf(){return Object.freeze({lastVisible:[],lastHidden:[],hidden:[]})}function Kf(i,t,n){if(t.delete(i)){n.lastVisible.push(i);const e=xt(i);e.isVisible=!0}}function JC(i,t,n){if(!t.has(i)){t.add(i),es(i)&&Zl(i),n.lastHidden.push(i);const e=xt(i);e.isVisible=!1}}function Zf(i){(i.lastHidden.length>0||i.lastVisible.length>0)&&(qo.forEach(t=>{i.hidden.push(t)}),gt(z,w.ANNOTATION_VISIBILITY_CHANGE,i))}function Jf(i){const t=!qo.has(i);return Yf(i,t),t}const QC=Object.freeze(Object.defineProperty({__proto__:null,checkAndSetAnnotationVisibility:Jf,isAnnotationVisible:re,setAnnotationVisibility:Yf,showAllAnnotations:ZC},Symbol.toStringTag,{value:"Module"})),Jl=VC,t1=i=>{i=qC(i),i=KC(i);const t=i.annotationUID,n=Bf(t);i.isLocked=n;const e=Jf(t);return i.isVisible=e,i};Jl.setPreprocessingFn(t1);kl(Jl);function e1(){kl(Jl)}function Sn(i){if(!i.data.segmentation)throw new Error("removeContourSegmentationAnnotation: annotation does not have a segmentation data");const{segmentationId:t,segmentIndex:n}=i.data.segmentation,e=pt(t),{annotationUIDsMap:o}=e?.representationData.Contour||{},a=o?.get(n);a&&(a.delete(i.annotationUID),a.size||o.delete(n))}function Qn(i){if(i.parentAnnotationUID)return;if(!i.data.segmentation)throw new Error("addContourSegmentationAnnotation: annotation does not have a segmentation data");const{segmentationId:t,segmentIndex:n}=i.data.segmentation,e=pt(t);e.representationData.Contour||(e.representationData.Contour={annotationUIDsMap:new Map});let{annotationUIDsMap:o}=e.representationData.Contour;o||(o=new Map);let a=o?.get(n);a||(a=new Set,o.set(n,a)),e.segments[n].locked&&Tr(i.annotationUID,!0),o.set(n,a.add(i.annotationUID))}const n1="PlanarFreehandContourSegmentationTool";function Ql(i){const{polyline:t}=i.data?.contour||{};if(!t||t.length<3){console.warn("Skipping creation of new annotation due to invalid polyline:",t);return}ft(i.annotationUID),Sn(i);const n=t[0],e=t[t.length-1],o={metadata:{...i.metadata,toolName:n1,originalToolName:i.metadata.originalToolName||i.metadata.toolName},data:{cachedStats:{},handles:{points:[n,e],textBox:i.data.handles.textBox?{...i.data.handles.textBox}:void 0},contour:{...i.data.contour},spline:i.data.spline,segmentation:{...i.data.segmentation}},annotationUID:Xt(),highlighted:!0,invalidated:!0,isLocked:!1,isVisible:void 0,interpolationUID:i.interpolationUID,interpolationCompleted:i.interpolationCompleted};return mt(o,i.metadata.FrameOfReferenceUID),Qn(o),It(o),o}function oi(i){const e=Vt.getState().viewportSegRepresentations;return Object.entries(e).filter(([,a])=>a.some(s=>s.segmentationId===i)).map(([a])=>a)}function td(i){const t=oi(i);if(t?.length===0)return[];const n=[];for(const e of t){const{viewport:o}=At(e)||{};o&&n.push(o)}return n}function ed(i){const t=td(i);return t.length>0?t[0]:void 0}function nd(i,t,n=.99){const e=t.metadata?.viewPlaneNormal;if(!e||!Array.isArray(e))return;const o=W();Zt(o,e);for(const a of i){const s=a.getCamera();if(!s?.viewPlaneNormal)continue;const r=W();Zt(r,s.viewPlaneNormal);const c=dt(o,r);if(Math.abs(c)>=n)return a}}function Ua(i){const t=pt(i);if(!t)return;const n=t.representationData?.Contour;if(!n)return;const{annotationUIDsMap:e}=n;if(e)return e}function Qf(i,t,n){const e={annotationUID:Xt(),data:{contour:{closed:!0,polyline:[]},segmentation:{segmentationId:t,segmentIndex:n},handles:{}},handles:{},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{...i.metadata,toolName:i.metadata.toolName}};return e.data.segmentation.segmentationId=t,e.data.segmentation.segmentIndex=n,i.data.contour?.polyline&&(e.data.contour.polyline=[...i.data.contour.polyline]),i.data.handles?.points&&(e.data.handles.points=i.data.handles.points.map(o=>[...o])),e}function tm(i,t,n,e){const o=Ua(i),a=Ua(n);if(!o||!a||!o?.has(t))return;const s=o.get(t),r=ed(n);if(!r)return;const c=ne(r.id),l=u=>{const h=Qf(u,n,e);if(c){const g=c.getToolInstance(u.metadata.toolName);g&&typeof g.isSplineAnnotation=="function"&&g.isSplineAnnotation(u)&&g.createSplineObjectFromType(h,u.data.spline.type)}return mt(h,r.element),d.add(h.annotationUID),h},d=new Set;for(const u of s){const h=xt(u),g=l(h);if(h?.childAnnotationUIDs){g.childAnnotationUIDs=[];for(const f of h.childAnnotationUIDs){const m=xt(f),v=l(m);v.parentAnnotationUID=g.annotationUID,g.childAnnotationUIDs.push(v.annotationUID)}}}a.set(e,d)}var Ge;(function(i){i[i.CounterClockwise=-1]="CounterClockwise",i[i.Unknown=0]="Unknown",i[i.Clockwise=1]="Clockwise"})(Ge||(Ge={}));function od(i,t){return i.minX<=t.maxX&&i.maxX>=t.minX&&i.minY<=t.maxY&&i.maxY>=t.minY}function Hs(i,t){const n=i.maxX-i.minX,e=i.maxY-i.minY,o=[n,e],a=[i.minX+n/2,i.minY+e/2],s=[Math.abs(t[0]-a[0]),Math.abs(t[1]-a[1])],r=s[0]-o[0]*.5,c=s[1]-o[1]*.5;if(r>0&&c>0)return r*r+c*c;const l=Math.max(r,0)+Math.max(c,0);return l*l}function o1(i,t){return Math.sqrt(Hs(i,t))}const i1=Object.freeze(Object.defineProperty({__proto__:null,distanceToPoint:o1,distanceToPointSquared:Hs,intersectAABB:od},Symbol.toStringTag,{value:"Module"}));class em{}class nm{constructor(t){this.storePointData=t.storePointData}getStatistics(){console.debug("InstanceCalculator getStatistics called")}}const{PointsManager:a1}=Rt;function ka(i){return{max:[-1/0],min:[1/0],sum:[0],count:0,maxIJK:null,maxLPS:null,minIJK:null,minLPS:null,runMean:[0],m2:[0],m3:[0],m4:[0],allValues:[[]],pointsInShape:i?a1.create3(1024):null,sumLPS:[0,0,0]}}function om(i,t,n=null,e=null){Array.isArray(t)&&t.length>1&&i.max.length===1&&(i.max.push(i.max[0],i.max[0]),i.min.push(i.min[0],i.min[0]),i.sum.push(i.sum[0],i.sum[0]),i.runMean.push(0,0),i.m2.push(i.m2[0],i.m2[0]),i.m3.push(i.m3[0],i.m3[0]),i.m4.push(i.m4[0],i.m4[0]),i.allValues.push([],[])),i?.pointsInShape&&n&&i.pointsInShape.push(n);const o=Array.isArray(t)?t:[t];i.count+=1,n&&(i.sumLPS[0]+=n[0],i.sumLPS[1]+=n[1],i.sumLPS[2]+=n[2]),i.max.forEach((a,s)=>{const r=o[s];i.allValues[s].push(r);const c=i.count,l=r-i.runMean[s],d=l/c,u=l*d*(c-1);i.sum[s]+=r,i.runMean[s]+=d,i.m4[s]+=u*d*d*(c*c-3*c+3)+6*d*d*i.m2[s]-4*d*i.m3[s],i.m3[s]+=u*d*(c-2)-3*d*i.m2[s],i.m2[s]+=u,r<i.min[s]&&(i.min[s]=r,s===0&&(i.minIJK=e?[...e]:null,i.minLPS=n?[...n]:null)),r>i.max[s]&&(i.max[s]=r,s===0&&(i.maxIJK=e?[...e]:null,i.maxLPS=n?[...n]:null))})}function s1(i){if(i.length===0)return 0;const t=[...i].sort((e,o)=>e-o),n=Math.floor(t.length/2);return t.length%2===0?(t[n-1]+t[n])/2:t[n]}function im(i,t){const n=i.sum.map(u=>u/i.count),e=i.m2.map(u=>Math.sqrt(u/i.count)),o=i.sumLPS.map(u=>u/i.count),a=i.m3.map((u,h)=>{const g=i.m2[h]/i.count;return g===0?0:u/(i.count*Math.pow(g,1.5))}),s=i.m4.map((u,h)=>{const g=i.m2[h]/i.count;return g===0?0:u/(i.count*g*g)-3}),r=i.allValues.map(u=>s1(u)),c={max:{name:"max",label:"Max Pixel",value:i.max.length===1?i.max[0]:i.max,unit:t,pointIJK:i.maxIJK?[...i.maxIJK]:null,pointLPS:i.maxLPS?[...i.maxLPS]:null},min:{name:"min",label:"Min Pixel",value:i.min.length===1?i.min[0]:i.min,unit:t,pointIJK:i.minIJK?[...i.minIJK]:null,pointLPS:i.minLPS?[...i.minLPS]:null},mean:{name:"mean",label:"Mean Pixel",value:n.length===1?n[0]:n,unit:t},stdDev:{name:"stdDev",label:"Standard Deviation",value:e.length===1?e[0]:e,unit:t},count:{name:"count",label:"Voxel Count",value:i.count,unit:null},median:{name:"median",label:"Median",value:r.length===1?r[0]:r,unit:t},skewness:{name:"skewness",label:"Skewness",value:a.length===1?a[0]:a,unit:null},kurtosis:{name:"kurtosis",label:"Kurtosis",value:s.length===1?s[0]:s,unit:null},maxLPS:{name:"maxLPS",label:"Max LPS",value:i.maxLPS?Array.from(i.maxLPS):null,unit:null},minLPS:{name:"minLPS",label:"Min LPS",value:i.minLPS?Array.from(i.minLPS):null,unit:null},pointsInShape:i.pointsInShape,center:{name:"center",label:"Center",value:o?[...o]:null,unit:null},array:[]};c.array.push(c.min,c.max,c.mean,c.stdDev,c.median,c.skewness,c.kurtosis,c.count,c.maxLPS,c.minLPS),c.center.value&&c.array.push(c.center);const l=i.pointsInShape!==null,d=ka(l);return i.max=d.max,i.min=d.min,i.sum=d.sum,i.count=d.count,i.maxIJK=d.maxIJK,i.maxLPS=d.maxLPS,i.minIJK=d.minIJK,i.minLPS=d.minLPS,i.runMean=d.runMean,i.m2=d.m2,i.m3=d.m3,i.m4=d.m4,i.allValues=d.allValues,i.pointsInShape=d.pointsInShape,i.sumLPS=d.sumLPS,c}const No=class No extends em{static statsInit(t){t.storePointData||(this.state.pointsInShape=null),this.state=ka(t.storePointData)}};No.state=ka(!0),No.statsCallback=({value:t,pointLPS:n=null,pointIJK:e=null})=>{om(No.state,t,n,e)},No.getStatistics=t=>im(No.state,t?.unit);let Un=No;class am extends nm{constructor(t){super(t),this.state=ka(t.storePointData)}statsInit(t){this.state=ka(t.storePointData)}statsCallback(t){om(this.state,t.value,t.pointLPS,t.pointIJK)}getStatistics(t){return im(this.state,t?.unit)}}const r1=Object.freeze(Object.defineProperty({__proto__:null,BasicStatsCalculator:Un,Calculator:em,InstanceBasicStatsCalculator:am,InstanceCalculator:nm},Symbol.toStringTag,{value:"Module"}));function to(i,t){if(i.length!==t.length)throw Error("Both points should have the same dimensionality");const[n,e,o=0]=i,[a,s,r=0]=t,c=a-n,l=s-e,d=r-o;return c*c+l*l+d*d}function Fn(i,t){return Math.sqrt(to(i,t))}function qc(i,t){const[n,e]=i,[o,a]=t,s=2*o-n,r=2*a-e;return[s,r]}const c1=Object.freeze(Object.defineProperty({__proto__:null,distanceToPoint:Fn,distanceToPointSquared:to,mirror:qc},Symbol.toStringTag,{value:"Module"}));function wo(i){const[t,n]=i;return Fn(t,n)}function Go(i){const[t,n]=i,e=Fn(t,n),o=[t[0]-e,t[1]-e],a=[t[0]+e,t[1]+e];return[o,a]}const l1=Object.freeze(Object.defineProperty({__proto__:null,getCanvasCircleCorners:Go,getCanvasCircleRadius:wo},Symbol.toStringTag,{value:"Module"}));function Pr(i,t,n={}){return n.precalculated||sm(i,n),n.precalculated(t)}const sm=(i,t={})=>{const{xRadius:n,yRadius:e,zRadius:o}=i;(t.invXRadiusSq===void 0||t.invYRadiusSq===void 0||t.invZRadiusSq===void 0)&&(t.invXRadiusSq=n!==0?1/n**2:0,t.invYRadiusSq=e!==0?1/e**2:0,t.invZRadiusSq=o!==0?1/o**2:0);const{invXRadiusSq:a,invYRadiusSq:s,invZRadiusSq:r}=t,{center:c}=i,[l,d,u]=c;return t.precalculated=h=>{const g=h[0]-l;let f=g*g*a;if(f>1)return!1;const m=h[1]-d;if(f+=m*m*s,f>1)return!1;const v=h[2]-u;return f+=v*v*r,f<=1},t};function Kc(i){const[t,n,e,o]=i,a=[e[0],n[1]],s=[o[0],t[1]];return[a,s]}const d1=Object.freeze(Object.defineProperty({__proto__:null,getCanvasEllipseCorners:Kc,pointInEllipse:Pr,precalculatePointInEllipse:sm},Symbol.toStringTag,{value:"Module"}));function zs(i,t,n){let e;const o=to(i,t);if(i[0]===t[0]&&i[1]===t[1]&&(e=i),!e){const a=((n[0]-i[0])*(t[0]-i[0])+(n[1]-i[1])*(t[1]-i[1]))/o;a<0?e=i:a>1?e=t:e=[i[0]+a*(t[0]-i[0]),i[1]+a*(t[1]-i[1])]}return{point:[...e],distanceSquared:to(n,e)}}function ns(i,t,n){return zs(i,t,n).distanceSquared}function fe(i,t,n){if(i.length!==2||t.length!==2||n.length!==2)throw Error("lineStart, lineEnd, and point should have 2 elements of [x, y]");return Math.sqrt(ns(i,t,n))}function Is(i){return typeof i=="number"?i?i<0?-1:1:i===i?0:NaN:NaN}function js(i,t,n,e,o=!1){const[a,s]=i,[r,c]=t,[l,d]=n,[u,h]=e;if(o){const x=(a-r)*(d-h)-(s-c)*(l-u);if(Math.abs(x)<1e-10)return;const A=((a-l)*(d-h)-(s-d)*(l-u))/x,O=a+A*(r-a),R=s+A*(c-s);return[O,R]}const g=c-s,f=a-r,m=r*s-a*c,v=g*l+f*d+m,p=g*u+f*h+m;if(v!==0&&p!==0&&Is(v)===Is(p))return;const I=h-d,C=l-u,E=u*d-l*h,S=I*a+C*s+E,_=I*r+C*c+E;if(S!==0&&_!==0&&Is(S)===Is(_))return;const D=g*C-I*f;let b;b=f*E-C*m;const M=b/D;b=I*m-g*E;const P=b/D;return[M,P]}const sa=.01;function Ls(i,t,n){const e=i[0]<=t[0]?i[0]:t[0],o=i[0]>=t[0]?i[0]:t[0],a=i[1]<=t[1]?i[1]:t[1],s=i[1]>=t[1]?i[1]:t[1];if(!(n[0]>=e-sa&&n[0]<=o+sa&&n[1]>=a-sa&&n[1]<=s+sa))return!1;const c=(t[1]-i[1])*(n[0]-t[0])-(t[0]-i[0])*(n[1]-t[1]);return(c>=0?c:-c)<=sa}const u1=Object.freeze(Object.defineProperty({__proto__:null,distanceToPoint:fe,distanceToPointSquared:ns,distanceToPointSquaredInfo:zs,intersectLine:js,isPointOnLineSegment:Ls},Symbol.toStringTag,{value:"Module"}));function Mr(i){if(i.length<3)return!1;const t=i.length,n=i[0],e=i[t-1],o=to(n,e);return xa(0,o)}function ke(i,t,n={closed:void 0}){if(i.length<3)return!1;const e=i.length;let o=0;const{closed:a,holes:s}=n;if(s?.length){for(const l of s)if(ke(l,t))return!1}const r=!(a===void 0?Mr(i):a),c=i.length-(r?1:2);for(let l=0;l<=c;l++){const d=i[l],u=l===e-1?0:l+1,h=i[u],g=d[0]>=h[0]?d[0]:h[0],f=d[1]>=h[1]?d[1]:h[1],m=d[1]<=h[1]?d[1]:h[1];if(t[0]<=g&&t[1]>=m&&t[1]<f){let I=d[0]===h[0];if(!I){const C=(t[1]-d[1])*(h[0]-d[0])/(h[1]-d[1])+d[0];I=t[0]<=C}o+=I?1:0}}return!!(o%2)}function ii(i,t){for(let n=0,e=t.length;n<e;n++)if(!ke(i,t[n]))return!1;return!0}function bo(i,t){let n=i;const e=t?.numDimensions||2,o=e===3;if(!Array.isArray(i[0])){const u=i,h=u.length/e;n=new Array(u.length/e);for(let g=0,f=h;g<f;g++)n[g]=[u[g*e],u[g*e+1]],o&&n[g].push(u[g*e+2])}let a=1/0,s=1/0,r=-1/0,c=-1/0,l=1/0,d=-1/0;n=n;for(let u=0,h=n.length;u<h;u++){const[g,f,m]=n[u];a=a<g?a:g,s=s<f?s:f,r=r>g?r:g,c=c>f?c:f,o&&(l=l<m?l:m,d=d>m?d:m)}return o?{minX:a,maxX:r,minY:s,maxY:c,minZ:l,maxZ:d}:{minX:a,maxX:r,minY:s,maxY:c}}function os(i){const t=i.length;let n=0,e=t-1;for(let o=0;o<t;o++)n+=(i[e][0]+i[o][0])*(i[e][1]-i[o][1]),e=o;return Math.abs(n/2)}function ln(i){if(i.length<3)return 0;const t=i[0];let n=0;for(let e=0,o=i.length;e<o;e++){const a=i[e],s=e===o-1?0:e+1,r=i[s],c=a[0]-t[0],l=a[1]-t[1],d=r[0]-t[0],u=r[1]-t[1];n+=c*u-l*d}return n*=.5,n}function Rs(i){return ln(i)>=0?1:-1}function h1(i){const t=W(),n=i[0];for(let e=0,o=i.length;e<o;e++){const a=i[e],s=e===o-1?0:e+1,r=i[s],c=a[0]-n[0],l=a[1]-n[1],d=a[2]-n[2],u=r[0]-n[0],h=r[1]-n[1],g=r[2]-n[2];t[0]+=l*g-d*h,t[1]+=d*u-c*g,t[2]+=c*h-l*u}return hn(t,t,.5),t}function g1(i){const t=h1(i);return Zt(t,t)}function Zc(i){const t=ln(i);return[0,0,t/Math.abs(t)]}const Ce=1e-7;function uc(i,t){return i[0]*t[1]-i[1]*t[0]}function ce(i,t){return Pt(i,t,Ce)}function rm(i,t,n,e){const o=Ft(et(),t,i),a=Ft(et(),e,n),s=uc(o,a),r=Ft(et(),n,i),c=uc(r,o);if(Math.abs(s)<Ce){if(Math.abs(c)<Ce){const u=Xn(o,o),h=Xn(a,a);if(u<Ce||h<Ce)return ce(i,n)||ce(i,e)?i:ce(t,n)||ce(t,e)?t:null;const g=Xn(Ft(et(),n,i),o)/u,f=Xn(Ft(et(),e,i),o)/u,m=Xn(Ft(et(),i,n),a)/h,v=Xn(Ft(et(),t,n),a)/h,p=I=>I>=-Ce&&I<=1+Ce;if(p(g)){const I=ua(et(),i,o,g);if(ce(n,I))return n}if(p(f)){const I=ua(et(),i,o,f);if(ce(e,I))return e}if(p(m)){const I=ua(et(),n,a,m);if(ce(i,I))return i}if(p(v)){const I=ua(et(),n,a,v);if(ce(t,I))return t}}return null}const l=uc(r,a)/s,d=c/s;return l>=-Ce&&l<=1+Ce&&d>=-Ce&&d<=1+Ce?[i[0]+l*o[0],i[1]+l*o[1]]:null}var Yn;(function(i){i[i.Vertex=0]="Vertex",i[i.Intersection=1]="Intersection"})(Yn||(Yn={}));var Ne;(function(i){i[i.Entering=0]="Entering",i[i.Exiting=1]="Exiting",i[i.Unknown=2]="Unknown"})(Ne||(Ne={}));function Wi(i,t){if(i.length!==t.length)return!1;const n=i.length;if(n===0)return!0;let e=!0;for(let a=0;a<n;a++)if(!ce(i[a],t[a])){e=!1;break}if(e)return!0;let o=!0;for(let a=0;a<n;a++)if(!ce(i[a],t[n-1-a])){o=!1;break}if(o)return!0;for(let a=1;a<n;a++){let s=!0;for(let c=0;c<n;c++)if(!ce(i[c],t[(c+a)%n])){s=!1;break}if(s)return!0;let r=!0;for(let c=0;c<n;c++)if(!ce(i[c],t[(n-1-c+a)%n])){r=!1;break}if(r)return!0}return!1}function xr(i,t){if(i.length<3)return[];if(t.length<3)return[i.slice()];const n=t.slice();if(Wi(i,t))return[];const e=ln(i),o=ln(n);Math.sign(e)===Math.sign(o)&&Math.abs(o)>Ce&&n.reverse();const a=[];for(let d=0;d<i.length;d++){const u=i[d],h=i[(d+1)%i.length];for(let g=0;g<n.length;g++){const f=n[g],m=n[(g+1)%n.length],v=rm(u,h,f,m);if(v){const p=Math.sqrt(mo(u,h)),I=Math.sqrt(mo(f,m));a.push({coord:v,seg1Idx:d,seg2Idx:g,alpha1:p<Ce?0:Math.sqrt(mo(u,v))/p,alpha2:I<Ce?0:Math.sqrt(mo(f,v))/I})}}}const s=(d,u,h)=>{const g=[];let f=0;for(let v=0;v<d.length;v++){const p=d[v];g.push({id:`${u}_v${f++}`,coordinates:p,type:Yn.Vertex,originalPolyIndex:u,originalVertexIndex:v,next:null,prev:null,isIntersection:!1,visited:!1});const I=h.filter(C=>(u===0?C.seg1Idx:C.seg2Idx)===v).sort((C,E)=>(u===0?C.alpha1:C.alpha2)-(u===0?E.alpha1:E.alpha2));for(const C of I){if(g.length>0&&ce(g[g.length-1].coordinates,C.coord)){g[g.length-1].isIntersection||(g[g.length-1].isIntersection=!0,g[g.length-1].intersectionInfo=C,g[g.length-1].alpha=u===0?C.alpha1:C.alpha2);continue}g.push({id:`${u}_i${f++}`,coordinates:C.coord,type:Yn.Intersection,originalPolyIndex:u,next:null,prev:null,isIntersection:!0,visited:!1,alpha:u===0?C.alpha1:C.alpha2,intersectionInfo:C})}}const m=[];if(g.length>0){m.push(g[0]);for(let v=1;v<g.length;v++)ce(g[v].coordinates,m[m.length-1].coordinates)?g[v].isIntersection&&(m[m.length-1].isIntersection=!0,m[m.length-1].intersectionInfo=g[v].intersectionInfo,m[m.length-1].alpha=g[v].alpha):m.push(g[v])}if(m.length>0)for(let v=0;v<m.length;v++)m[v].next=m[(v+1)%m.length],m[v].prev=m[(v-1+m.length)%m.length];return m},r=s(i,0,a),c=s(n,1,a);r.forEach(d=>{if(d.isIntersection){const u=d.intersectionInfo,h=c.find(g=>g.isIntersection&&ce(g.coordinates,d.coordinates)&&g.intersectionInfo.seg1Idx===u.seg1Idx&&g.intersectionInfo.seg2Idx===u.seg2Idx);if(h){d.partnerNode=h,h.partnerNode=d;const g=d.prev.coordinates,f=d.coordinates,m=h.next.coordinates;Ft(et(),f,g),Ft(et(),m,f);const v=[(d.prev.coordinates[0]+d.coordinates[0])/2,(d.prev.coordinates[1]+d.coordinates[1])/2];ke(t,v)?d.intersectionDir=Ne.Exiting:d.intersectionDir=Ne.Entering}else d.isIntersection=!1}}),r.forEach(d=>delete d.intersectionInfo),c.forEach(d=>delete d.intersectionInfo);const l=[];for(let d=0;d<r.length;d++){const u=r[d];if(u.visited||u.isIntersection||ke(t,u.coordinates))continue;const h=[];let g=u,f=!0,m=0;const v=(r.length+c.length)*2;do{if(m++>v){console.warn("Subtraction: Max iterations reached, possible infinite loop.");break}g.visited=!0,(h.length===0||!ce(h[h.length-1],g.coordinates))&&h.push(g.coordinates),g.isIntersection&&(f?g.intersectionDir===Ne.Entering&&g.partnerNode&&(g=g.partnerNode,f=!1):g.partnerNode?(g=g.partnerNode,f=!0):console.warn("Subtraction: Intersection on source without partner.")),g=g.next}while(g!==u||!f);h.length>=3&&(ce(h[0],h[h.length-1])&&h.pop(),h.length>=3&&l.push(h))}return l}function cm(i,t){if(i.length<3||t.length<3)return[];let n=t.slice();const e=ln(i),o=ln(n);if(Math.abs(e)<Ce||Math.abs(o)<Ce)return[];e<0&&(i=i.slice().reverse()),o<0&&(n=n.slice().reverse());const a=n,s=[];for(let u=0;u<i.length;u++){const h=i[u],g=i[(u+1)%i.length];for(let f=0;f<n.length;f++){const m=n[f],v=n[(f+1)%n.length],p=rm(h,g,m,v);if(p){const I=Math.sqrt(mo(h,g)),C=Math.sqrt(mo(m,v));s.push({coord:[...p],seg1Idx:u,seg2Idx:f,alpha1:I<Ce?0:Math.sqrt(mo(h,p))/I,alpha2:C<Ce?0:Math.sqrt(mo(m,p))/C})}}}if(s.length===0)return ke(a,i[0])&&i.every(u=>ke(a,u))?[[...i.map(u=>[...u])]]:ke(i,n[0])&&n.every(u=>ke(i,u))?[[...n.map(u=>[...u])]]:[];const r=(u,h,g)=>{const f=[];let m=0;for(let p=0;p<u.length;p++){const I=u[p];f.push({id:`${h}_v${m++}`,coordinates:[...I],type:Yn.Vertex,originalPolyIndex:h,originalVertexIndex:p,next:null,prev:null,isIntersection:!1,visited:!1,processedInPath:!1,intersectionDir:Ne.Unknown});const C=g.filter(E=>(h===0?E.seg1Idx:E.seg2Idx)===p).sort((E,S)=>(h===0?E.alpha1:E.alpha2)-(h===0?S.alpha1:S.alpha2));for(const E of C){if(f.length>0&&ce(f[f.length-1].coordinates,E.coord)){const S=f[f.length-1];S.isIntersection||(S.isIntersection=!0,S.intersectionInfo=E,S.alpha=h===0?E.alpha1:E.alpha2,S.type=Yn.Intersection);continue}f.push({id:`${h}_i${m++}`,coordinates:[...E.coord],type:Yn.Intersection,originalPolyIndex:h,next:null,prev:null,isIntersection:!0,visited:!1,processedInPath:!1,alpha:h===0?E.alpha1:E.alpha2,intersectionInfo:E,intersectionDir:Ne.Unknown})}}const v=[];if(f.length>0){v.push(f[0]);for(let p=1;p<f.length;p++)if(!ce(f[p].coordinates,v[v.length-1].coordinates))v.push(f[p]);else{const I=v[v.length-1];f[p].isIntersection&&f[p].intersectionInfo&&(I.isIntersection=!0,I.intersectionInfo=f[p].intersectionInfo,I.alpha=f[p].alpha,I.type=Yn.Intersection)}}if(v.length>1&&ce(v[0].coordinates,v[v.length-1].coordinates)){const p=v[0],I=v.pop();I.isIntersection&&!p.isIntersection&&I.intersectionInfo&&(p.isIntersection=!0,p.intersectionInfo=I.intersectionInfo,p.alpha=I.alpha,p.type=Yn.Intersection)}if(v.length>0)for(let p=0;p<v.length;p++)v[p].next=v[(p+1)%v.length],v[p].prev=v[(p-1+v.length)%v.length];return v},c=r(i,0,s),l=r(n,1,s);if(c.length===0||l.length===0)return[];c.forEach(u=>{if(u.isIntersection&&u.intersectionInfo){const h=u.intersectionInfo,g=l.find(f=>f.isIntersection&&f.intersectionInfo&&ce(f.coordinates,u.coordinates)&&f.intersectionInfo.seg1Idx===h.seg1Idx&&f.intersectionInfo.seg2Idx===h.seg2Idx);if(g){u.partnerNode=g,g.partnerNode=u;const f=Ft(et(),u.coordinates,u.prev.coordinates),m=Ft(et(),g.next.coordinates,g.coordinates),v=f[0]*m[1]-f[1]*m[0];if(v>Ce)u.intersectionDir=Ne.Entering,g.intersectionDir=Ne.Exiting;else if(v<-Ce)u.intersectionDir=Ne.Exiting,g.intersectionDir=Ne.Entering;else{const p=[(u.prev.coordinates[0]+u.coordinates[0])/2,(u.prev.coordinates[1]+u.coordinates[1])/2];ke(a,p)?(u.intersectionDir=Ne.Exiting,g.intersectionDir=Ne.Entering):(u.intersectionDir=Ne.Entering,g.intersectionDir=Ne.Exiting)}}else u.isIntersection=!1,u.intersectionInfo=void 0}});const d=[];for(const u of c){if(!u.isIntersection||u.visited||u.intersectionDir!==Ne.Entering)continue;let h=[],g=u,f=!0;const m=u;let v=0;const p=(c.length+l.length)*2;c.forEach(I=>I.processedInPath=!1),l.forEach(I=>I.processedInPath=!1);do{if(v++>p){console.warn("Intersection: Max iterations in path tracing.",m.id,g.id),h=[];break}if(g.processedInPath&&g!==m){console.warn("Intersection: Path processing loop detected, discarding path segment.",m.id,g.id),h=[];break}g.processedInPath=!0,g.visited=!0,(h.length===0||!ce(h[h.length-1],g.coordinates))&&h.push([...g.coordinates]);let I=!1;g.isIntersection&&g.partnerNode&&(f?(g=g.partnerNode,f=!1,I=!0):(g=g.partnerNode,f=!0,I=!0)),g=g.next}while(g!==m||f&&g.originalPolyIndex!==0||!f&&g.originalPolyIndex!==1);if(v>p||h.length===0||h.length>0&&ce(h[0],h[h.length-1])&&h.pop(),h.length>=3){const I=ln(h);(e>0&&I<0||e<0&&I>0)&&h.reverse(),d.push(h.map(C=>[...C]))}}return d}function id(i,t,n,e){let o=!1;const a=i[0]<t[0]?i[0]:t[0],s=i[1]<t[1]?i[1]:t[1],r=i[0]>t[0]?i[0]:t[0],c=i[1]>t[1]?i[1]:t[1],l=n[0]<e[0]?n[0]:e[0],d=n[1]<e[1]?n[1]:e[1],u=n[0]>e[0]?n[0]:e[0],h=n[1]>e[1]?n[1]:e[1];if(a>u||r<l||s>h||c<d)return!1;const g=[ws(i,t,n),ws(i,t,e),ws(n,e,i),ws(n,e,t)];return g[0]!==g[1]&&g[2]!==g[3]?!0:((g[0]===0&&Cs(i,n,t)||g[1]===0&&Cs(i,e,t)||g[2]===0&&Cs(n,i,e)||g[3]===0&&Cs(n,t,e))&&(o=!0),o)}function ws(i,t,n){const e=(t[1]-i[1])*(n[0]-t[0])-(t[0]-i[0])*(n[1]-t[1]);return e===0?0:e>0?1:2}function Cs(i,t,n){return t[0]<=Math.max(i[0],n[0])&&t[0]>=Math.min(i[0],n[0])&&t[1]<=Math.max(i[1],n[1])&&t[1]>=Math.min(i[1],n[1])}function ad(i,t,n,e=!0){const o=[],a=i.length,s=a-(e?1:2);for(let r=0;r<=s;r++){const c=i[r],l=r===a-1?0:r+1,d=i[l];id(t,n,c,d)&&o.push([r,l])}return o}function lm(i,t,n,e=!0){let o,a;e?(a=i.length-1,o=0):(a=0,o=1);for(let s=o;s<i.length;s++){const r=i[a],c=i[s];if(id(t,n,r,c))return[a,s];a=s}}function yr(i,t){for(let n=0,e=i.length;n<e;n++){const o=i[n],a=n===e-1?0:n+1,s=i[a];if(lm(t,o,s)?.length===2)return!0}return!1}const f1=.01;function dm(i,t,n,e){const o=[t[0]-i[0],t[1]-i[1]],a=[e[0]-n[0],e[1]-n[1]],s=a[1]*o[0]-a[0]*o[1];if((s>=0?s:-s)<f1){const f=[i[0]<t[0]?i[0]:t[0],i[0]>t[0]?i[0]:t[0],i[1]<t[1]?i[1]:t[1],i[1]>t[1]?i[1]:t[1]],m=[n[0]<e[0]?n[0]:e[0],n[0]>e[0]?n[0]:e[0],n[1]<e[1]?n[1]:e[1],n[1]>e[1]?n[1]:e[1]];if(!(f[0]<=m[1]&&f[1]>=m[0]&&f[2]<=m[3]&&f[3]>=m[2])||!(Ls(i,t,n)||Ls(i,t,e)||Ls(n,e,i)))return;const I=f[0]>m[0]?f[0]:m[0],C=f[1]<m[1]?f[1]:m[1],E=f[2]>m[2]?f[2]:m[2],S=f[3]<m[3]?f[3]:m[3],_=(I+C)*.5,D=(E+S)*.5;return[_,D]}let c=i[1]-n[1],l=i[0]-n[0];const d=a[0]*c-a[1]*l,u=o[0]*c-o[1]*l;c=d/s,l=u/s;const h=i[0]+c*o[0],g=i[1]+c*o[1];return[h,g]}var Ho;(function(i){i[i.Vertex=0]="Vertex",i[i.Intersection=1]="Intersection"})(Ho||(Ho={}));var zo;(function(i){i[i.Outside=-1]="Outside",i[i.Edge=0]="Edge",i[i.Inside=1]="Inside"})(zo||(zo={}));var mi;(function(i){i[i.Exiting=-1]="Exiting",i[i.Unknown=0]="Unknown",i[i.Entering=1]="Entering"})(mi||(mi={}));function Xu(i){for(let t=0,n=i.length;t<n;t++){const e=i[t];e.next||(e.next=i[t===n-1?0:t+1])}}function m1(i,t){const n=[],e=[],o=new Map;let s=ke(t,i[0])?mi.Exiting:mi.Entering;for(let r=0,c=i.length;r<c;r++){const l=i[r],d=ke(t,l),u={type:Ho.Vertex,coordinates:l,position:d?zo.Inside:zo.Outside,visited:!1,next:null};n.push(u);const h=i[r===c-1?0:r+1],g=ad(t,l,h).map(f=>{const m=f[0],v=t[f[0]],p=t[f[1]],I=dm(l,h,v,p),C=to(l,I);return{sourceLineSegmentId:m,coordinate:I,targetStartPointDistSquared:C}});g.sort((f,m)=>f.targetStartPointDistSquared-m.targetStartPointDistSquared),g.forEach(f=>{const{sourceLineSegmentId:m,coordinate:v}=f,p={type:Ho.Intersection,coordinates:v,position:zo.Edge,direction:s,visited:!1,next:null},I={...p,direction:mi.Unknown,cloned:!0};s===mi.Entering?p.next=I:I.next=p;let C=o.get(m);C||(C=[],o.set(m,C)),n.push(p),C.push(I),s*=-1})}for(let r=0,c=t.length;r<c;r++){const l=r,d=t[r],u={type:Ho.Vertex,coordinates:d,visited:!1,next:null};e.push(u);const h=o.get(l);h?.length&&h.map(g=>({intersectionPoint:g,lineSegStartDistSquared:to(d,g.coordinates)})).sort((g,f)=>g.lineSegStartDistSquared-f.lineSegStartDistSquared).map(({intersectionPoint:g})=>g).forEach(g=>e.push(g))}return Xu(n),Xu(e),{targetPolylinePoints:n,sourcePolylinePoints:e}}function p1(i){for(let t=0,n=i.length;t<n;t++){const e=i[t];if(!e.visited&&e.position===zo.Outside&&e.type===Ho.Vertex)return e}for(let t=0,n=i.length;t<n;t++){const e=i[t];if(!e.visited&&e.position===zo.Outside)return e}}function Ar(i,t){const n=Zc(i),e=Zc(t),o=dt(e,n);if(xa(1,o)||(t=t.slice().reverse()),!yr(t,i)&&ii(t,i))return t.slice();const{targetPolylinePoints:r}=m1(i,t),c=p1(r);if(!c)return i.slice();const l=[c.coordinates];let d=c.next,u=0;const h=i.length+t.length+1e3;for(;d!==c&&u<h;){if(u++,d.type===Ho.Intersection&&d.cloned){d=d.next;continue}if(l.push(d.coordinates),d=d.next,!d){console.warn("Broken linked list detected in mergePolylines, breaking loop");break}}return u>=h&&console.warn("Maximum iterations reached in mergePolylines, possible infinite loop detected"),l}const v1=.1;function Or(i,t=v1){const n=i.length;if(n<3)return i;const e=t*t,o=[[0,n-1]],a=new Array(n).fill(!1);let s=2;for(a[0]=!0,a[n-1]=!0;o.length;){const[c,l]=o.pop();if(l-c===1)continue;const d=i[c],u=i[l];let h=-1/0,g=-1;for(let f=c+1;f<l;f++){const m=i[f],v=ns(d,u,m);v>h&&(h=v,g=f)}h<e||(a[g]=!0,s++,o.push([g,l]),o.push([c,g]))}const r=new Array(s);for(let c=0,l=0;c<n;c++)a[c]&&(r[l++]=i[c]);return r}function um(i,t,n,e=!0){const o=[],a=ad(i,t,n,e);for(let s=0;s<a.length;s++){const r=i[a[s][0]],c=i[a[s][1]],l=dm(t,n,r,c);o.push(l)}return o}function I1(i,t,n,e=!0){let o,a;e?(a=i.length-1,o=0):(a=0,o=1);const s=[];for(let d=o;d<i.length;d++){const u=i[a],h=i[d];id(t,n,u,h)&&s.push([a,d]),a=d}if(s.length===0)return;const r=[];s.forEach(d=>{const u=[i[d[0]],i[d[1]]],h=[(u[0][0]+u[1][0])/2,(u[0][1]+u[1][1])/2];r.push(jt(h,t))});const c=Math.min(...r),l=r.indexOf(c);return{segment:s[l],distance:c}}const di=.001,w1=(i,t)=>{let n,e,o;if(i instanceof Ie){const s=i.getImageData();if(!s)return;e=s.direction.slice(0,3),o=s.direction.slice(3,6),n=s.spacing}else{const s=i.getImageData(),{direction:r,spacing:c}=s,{viewPlaneNormal:l,viewUp:d}=i.getCamera(),u=r.slice(0,3),h=r.slice(3,6),g=r.slice(6,9),f=W();be(f,d,l);const m=Math.abs(dt(f,u)),v=Math.abs(dt(f,h)),p=Math.abs(dt(f,g));let I;if(Math.abs(1-m)<di)I=c[0],e=u;else if(Math.abs(1-v)<di)I=c[1],e=h;else if(Math.abs(1-p)<di)I=c[2],e=g;else throw new Error("No support yet for oblique plane planar contours");const C=Math.abs(dt(d,u)),E=Math.abs(dt(d,h)),S=Math.abs(dt(d,g));let _;if(Math.abs(1-C)<di)_=c[0],o=u;else if(Math.abs(1-E)<di)_=c[1],o=h;else if(Math.abs(1-S)<di)_=c[2],o=g;else throw new Error("No support yet for oblique plane planar contours");n=[I,_]}return{spacing:[n[0]/t,n[1]/t],xDir:e,yDir:o}},C1=(i,t,n)=>Tl(i,t)<n,E1=(i,t,n,e)=>{const{xDir:o,yDir:a,spacing:s}=e,r=y(i),{viewport:c}=r;if(!t.length)return t.push(n),console.log(">>>>> !canvasPoints. :: RETURN"),1;const l=c.canvasToWorld(t[t.length-1]),d=c.canvasToWorld(n),u=W();oe(u,d,l);const h=Math.abs(dt(u,o)),g=Math.abs(dt(u,a)),f=Math.max(Math.floor(h/s[0]),Math.floor(g/s[0]));if(f>1){const m=t[t.length-1],v=Tl(m,n),p=et();Ft(p,n,m),sn(p,p[0]/v,p[1]/v);const I=v/f;for(let C=1;C<=f;C++)t.push([m[0]+I*p[0]*C,m[1]+I*p[1]*C])}else t.push(n);return f},S1=(i,t,n,e)=>{const o=[i[0]-t[0],i[1]-t[1]],a=[n[0]-t[0],n[1]-t[1]],s=o[0]*a[0]+o[1]*a[1];if(s<0)return!1;const r=Math.sqrt(a[0]*a[0]+a[1]*a[1]);if(r===0)return!1;const c=s/r,l=[a[0]/r,a[1]/r],d=[l[0]*c,l[1]*c],u=[t[0]+d[0],t[1]+d[1]];return!(jt(i,u)>e||jt(t,u)>jt(t,n))},_1=1e-6;function hm(i){let t;const n=_g(i,50);for(let s=0;s<3;s++)if(n.every((r,c,l)=>Math.abs(r[s]-l[0][s])<_1)){t=s;break}if(t===void 0)throw new Error("Cannot find a shared dimension index for polyline, probably oblique plane");const e=[],o=(t+1)%3,a=(t+2)%3;for(let s=0;s<i.length;s++)e.push([i[s][o],i[s][a]]);return{sharedDimensionIndex:t,projectedPolyline:e}}function sd(i,t,n={}){const{sharedDimensionIndex:e,projectedPolyline:o}=hm(t),{holes:a}=n,s=[];if(a)for(let c=0;c<a.length;c++){const l=a[c],d=[];for(let u=0;u<l.length;u++)d.push([l[u][(e+1)%3],l[u][(e+2)%3]]);s.push(d)}const r=[i[(e+1)%3],i[(e+2)%3]];return ke(o,r,{holes:s})}function gm(i){if(i.length<3)return i.slice();const t=i.map(a=>[a[0],a[1]]).sort((a,s)=>a[0]===s[0]?a[1]-s[1]:a[0]-s[0]);function n(a,s,r){return(s[0]-a[0])*(r[1]-a[1])-(s[1]-a[1])*(r[0]-a[0])}const e=[];for(const a of t){for(;e.length>=2&&n(e[e.length-2],e[e.length-1],a)<=0;)e.pop();e.push(a)}const o=[];for(let a=t.length-1;a>=0;a--){const s=t[a];for(;o.length>=2&&n(o[o.length-2],o[o.length-1],s)<=0;)o.pop();o.push(s)}return e.pop(),o.pop(),e.concat(o)}const Po=Object.freeze(Object.defineProperty({__proto__:null,addCanvasPointsToArray:E1,arePolylinesIdentical:Wi,containsPoint:ke,containsPoints:ii,convexHull:gm,decimate:Or,getAABB:bo,getArea:os,getClosestLineSegmentIntersection:I1,getFirstLineSegmentIntersectionIndexes:lm,getLineSegmentIntersectionsCoordinates:um,getLineSegmentIntersectionsIndexes:ad,getNormal2:Zc,getNormal3:g1,getSignedArea:ln,getSubPixelSpacingAndXYDirections:w1,getWindingDirection:Rs,intersectPolyline:yr,intersectPolylines:cm,isClosed:Mr,isPointInsidePolyline3D:sd,mergePolylines:Ar,pointCanProjectOnLine:S1,pointsAreWithinCloseContourProximity:C1,projectTo2D:hm,subtractPolylines:xr},Symbol.toStringTag,{value:"Module"}));function D1(i,t,n,e){const o=[i,t],a=[i+n,t],s=[i+n,t],r=[i+n,t+e],c=[i+n,t+e],l=[i,t+e],d=[i,t+e];return{top:[o,a],right:[s,r],bottom:[c,l],left:[d,[i,t]]}}function rd(i,t){if(i.length!==4||t.length!==2)throw Error("rectangle:[left, top, width, height] or point: [x,y] not defined correctly");const[n,e,o,a]=i;let s=655535;const r=D1(n,e,o,a);return Object.keys(r).forEach(c=>{const[l,d]=r[c],u=fe(l,d,t);u<s&&(s=u)}),s}const b1=Object.freeze(Object.defineProperty({__proto__:null,distanceToPoint:rd},Symbol.toStringTag,{value:"Module"}));function Jc(i,t){let n=[0,0],e=Number.MAX_SAFE_INTEGER;return i.forEach(function(o){const a=T1(t,o);a<e&&(e=a,n=[...o])}),n}function T1(i,t){const[n,e]=i,[o,a]=t;return Math.sqrt(Math.pow(n-o,2)+Math.pow(e-a,2))}const Qc=1e-6,Yu=1,P1=0;function Es(i,t,n){const[e,o]=n;if(Math.abs(t)<Qc)return i<0;const a=i/t;if(t>0){if(a>o)return 0;a>e&&(n[0]=a)}else{if(a<e)return 0;a<o&&(n[1]=a)}return 1}function Wo(i,t,n,e,o){const[a,s]=i,[r,c]=t,l=r-a,d=c-s;if(e===void 0||o===void 0?(e=i,o=t):(e[0]=i[0],e[1]=i[1],o[0]=t[0],o[1]=t[1]),Math.abs(l)<Qc&&Math.abs(d)<Qc&&a>=n[0]&&a<=n[2]&&s>=n[1]&&s<=n[3])return Yu;const u=[0,1];if(Es(n[0]-a,l,u)&&Es(a-n[2],-l,u)&&Es(n[1]-s,d,u)&&Es(s-n[3],-d,u)){const[h,g]=u;return g<1&&(o[0]=a+g*l,o[1]=s+g*d),h>0&&(e[0]+=h*l,e[1]+=h*d),Yu}return P1}const M1=Object.freeze(Object.defineProperty({__proto__:null,findClosestPoint:Jc,liangBarksyClip:Wo},Symbol.toStringTag,{value:"Module"}));function x1(i,t){const[n,e]=i,[o,a]=t,s=me(W(),e,n),r=me(W(),o,a),c=dt(s,r),l=We(s),d=We(r),u=c/(l*d);return Math.acos(u)*180/Math.PI}function y1(i,t){const[n,e]=i,[o,a]=t,s=Kn(et(),e,n),r=Kn(et(),o,a),c=Xn(s,r),l=Gc(s),d=Gc(r),u=c/(l*d);return Math.acos(u)*(180/Math.PI)}function Ti(i,t){return i[0].length===3?x1(i,t):y1(i,t)}const A1=Object.freeze(Object.defineProperty({__proto__:null,angleBetweenLines:Ti},Symbol.toStringTag,{value:"Module"})),O1=Object.freeze(Object.defineProperty({__proto__:null,BasicStatsCalculator:r1,aabb:i1,angle:A1,circle:l1,ellipse:d1,lineSegment:u1,point:c1,polyline:Po,rectangle:b1,vec2:M1},Symbol.toStringTag,{value:"Module"}));function bn(i,t,n,e){const{canvasToWorld:o,worldToCanvas:a}=n,{data:s}=i,{targetWindingDirection:r}=t;let{points:c}=t,l=Rs(c);e?.decimate?.enabled&&(c=Or(t.points,e?.decimate?.epsilon));let{closed:d}=t;const u=c.length,h=new Array(u);Rs(c);const g=Zg(i);if(d===void 0){let f=!1;if(c.length>3){const m=to(c[0],c[u-1]);f=Pt(0,m)}d=f}if(e?.updateWindingDirection!==!1){let f=g?g.data.contour.windingDirection*-1:r;f===void 0&&(f=l),f!==l&&c.reverse();const m=(s.handles?.points??[]).map(a);m.length>2&&Rs(m)!==f&&s.handles.points.reverse(),l=f}for(let f=0;f<u;f++)h[f]=o(c[f]);s.contour.polyline=h,s.contour.closed=d,s.contour.windingDirection=l,Vl(i)}const L1="viewport-element";function R1(i){const t=y(i),{viewportId:n,renderingEngineId:e}=t,o=`${n}:${e}`,a=N1(i);return Object.keys(U.svgNodeCache[o]).forEach(s=>{U.svgNodeCache[o][s].touched=!1}),{svgLayerElement:a,svgNodeCacheForCanvas:U.svgNodeCache,getSvgNode:U1.bind(this,o),appendNode:k1.bind(this,a,o),setNodeTouched:V1.bind(this,o),clearUntouched:F1.bind(this,a,o)}}function N1(i){const t=`.${L1}`;return i.querySelector(t)?.querySelector(":scope > .svg-layer")}function U1(i,t){if(U.svgNodeCache[i]&&U.svgNodeCache[i][t])return U.svgNodeCache[i][t].domRef}function k1(i,t,n,e){if(!U.svgNodeCache[t])return null;U.svgNodeCache[t][e]={touched:!0,domRef:n},i.appendChild(n)}function V1(i,t){U.svgNodeCache[i]&&U.svgNodeCache[i][t]&&(U.svgNodeCache[i][t].touched=!0)}function F1(i,t){U.svgNodeCache[t]&&Object.keys(U.svgNodeCache[t]).forEach(n=>{const e=U.svgNodeCache[t][n];!e.touched&&e.domRef&&(i.removeChild(e.domRef),delete U.svgNodeCache[t][n])})}function fm(i,t){const n=R1(i);t(n),n.clearUntouched()}function Bn(i,t,n){return`${i}::${t}::${n}`}function tn(i,t){Object.keys(i).forEach(n=>{const e=t.getAttribute(n),o=i[n];o===void 0||o===""?t.removeAttribute(n):e!==o&&t.setAttribute(n,o)})}function Gn(i,t){Object.keys(i).forEach(n=>{const e=i[n];e!==void 0&&e!==""&&t.setAttribute(n,e)})}function Ae(i,t,n,e,o,a={},s=""){const{color:r,fill:c,width:l,lineWidth:d,lineDash:u,fillOpacity:h,strokeOpacity:g}=Object.assign({color:"rgb(0, 255, 0)",fill:"transparent",width:"2",lineDash:void 0,lineWidth:void 0,strokeOpacity:1,fillOpacity:1},a),f=d||l,m="http://www.w3.org/2000/svg",v=Bn(t,"circle",n),p=i.getSvgNode(v),I={cx:`${e[0]}`,cy:`${e[1]}`,r:`${o}`,stroke:r,fill:c,"stroke-width":f,"stroke-dasharray":u,"fill-opacity":h,"stroke-opacity":g};if(p)tn(I,p),i.setNodeTouched(v);else{const C=document.createElementNS(m,"circle");s!==""&&C.setAttribute("data-id",s),Gn(I,C),i.appendNode(C,v)}}function cd(i,t,n,e,o={},a=""){const{color:s,width:r,lineWidth:c,lineDash:l}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},o),d=c||r,u="http://www.w3.org/2000/svg",h=Bn(t,"ellipse",n),g=i.getSvgNode(h),[f,m,v,p]=e,I=Math.hypot(v[0]-p[0],v[1]-p[1]),C=Math.hypot(m[0]-f[0],m[1]-f[1]),E=Math.atan2(v[1]-p[1],v[0]-p[0])*180/Math.PI,S=[(v[0]+p[0])/2,(m[1]+f[1])/2],_=I/2,D=C/2,b={cx:`${S[0]}`,cy:`${S[1]}`,rx:`${_}`,ry:`${D}`,stroke:s,fill:"transparent",transform:`rotate(${E} ${S[0]} ${S[1]})`,"stroke-width":d,"stroke-dasharray":l};if(g)tn(b,g),i.setNodeTouched(h);else{const M=document.createElementNS(u,"ellipse");a!==""&&M.setAttribute("data-id",a),Gn(b,M),i.appendNode(M,h)}}function B1(i,t,n,e,o,a={},s=""){const r=[(e[0]+o[0])/2,e[1]],c=[(e[0]+o[0])/2,o[1]],l=[e[0],(e[1]+o[1])/2],d=[o[0],(e[1]+o[1])/2];cd(i,t,n,[c,r,l,d],a={},s="")}function Xs(i,t,n,e,o={},a){const{color:s,handleRadius:r,width:c,lineWidth:l,fill:d,type:u,opacity:h}=Object.assign({color:"rgb(0, 255, 0)",handleRadius:"6",width:"2",lineWidth:void 0,fill:"transparent",type:"circle",opacity:1},o),g=l||c,f="http://www.w3.org/2000/svg",m=Bn(t,"handle",`hg-${n}-index-${a}`);let v;if(u==="circle")v={cx:`${e[0]}`,cy:`${e[1]}`,r,stroke:s,fill:d,"stroke-width":g,opacity:h};else if(u==="rect"){const C=parseFloat(r)*1.5,E=e[0]-C*.5,S=e[1]-C*.5;v={x:`${E}`,y:`${S}`,width:`${C}`,height:`${C}`,stroke:s,fill:d,"stroke-width":g,rx:`${C*.1}`,opacity:h}}else throw new Error(`Unsupported handle type: ${u}`);const p=i.getSvgNode(m);if(p)tn(v,p),i.setNodeTouched(m);else{const I=document.createElementNS(f,u);Gn(v,I),i.appendNode(I,m)}}function $t(i,t,n,e,o={}){e.forEach((a,s)=>{Xs(i,t,n,a,o,s)})}function Et(i,t,n,e,o,a={},s=""){if(isNaN(e[0])||isNaN(e[1])||isNaN(o[0])||isNaN(o[1]))return;const{color:r="rgb(0, 255, 0)",width:c=10,lineWidth:l,lineDash:d,markerStartId:u=null,markerEndId:h=null,shadow:g=!1,strokeOpacity:f=1,textBoxLinkLineColor:m}=a,v=l||c,p="http://www.w3.org/2000/svg",I=Bn(t,"line",n),C=i.getSvgNode(I),E=i.svgLayerElement.id,S=g?`filter:url(#shadow-${E});`:"",_={x1:`${e[0]}`,y1:`${e[1]}`,x2:`${o[0]}`,y2:`${o[1]}`,stroke:m||r,style:S,"stroke-width":v,"stroke-dasharray":d,"marker-start":u?`url(#${u})`:"","marker-end":h?`url(#${h})`:"","stroke-opacity":f};if(C)tn(_,C),i.setNodeTouched(I);else{const D=document.createElementNS(p,"line");s!==""&&D.setAttribute("data-id",s),Gn(_,D),i.appendNode(D,I)}}function mm(i,t,n,e,o,a={}){if(isNaN(e[0])||isNaN(e[1])||isNaN(o[0])||isNaN(o[1]))return;const{color:s,width:r,lineWidth:c,lineDash:l}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},a),d=o[0]+(e[0]-o[0])/2,u=[d,e[1]],h=[d,o[1]],g={start:e,end:u},f={start:u,end:h},m={start:h,end:o};Et(i,t,"1",g.start,g.end,{color:s,width:r,lineWidth:c,lineDash:l}),Et(i,t,"2",f.start,f.end,{color:s,width:r,lineWidth:c,lineDash:l}),Et(i,t,"3",m.start,m.end,{color:s,width:r,lineWidth:c,lineDash:l})}function dn(i,t,n,e,o){if(e.length<2)return;const{color:a="rgb(0, 255, 0)",width:s=10,fillColor:r="none",fillOpacity:c=0,lineWidth:l,lineDash:d,closePath:u=!1,markerStartId:h=null,markerEndId:g=null}=o,f=l||s,m="http://www.w3.org/2000/svg",v=Bn(t,"polyline",n),p=i.getSvgNode(v);let I="";for(const E of e)I+=`${E[0].toFixed(1)}, ${E[1].toFixed(1)} `;if(u){const E=e[0];I+=`${E[0]}, ${E[1]}`}const C={points:I,stroke:a,fill:r,"fill-opacity":c,"stroke-width":f,"stroke-dasharray":d,"marker-start":h?`url(#${h})`:"","marker-end":g?`url(#${g})`:""};if(p)tn(C,p),i.setNodeTouched(v);else{const E=document.createElementNS(m,"polyline");Gn(C,E),i.appendNode(E,v)}}function Jn(i,t,n,e,o){const s=e.length&&e[0].length&&Array.isArray(e[0][0])?e:[e],{color:r="rgb(0, 255, 0)",width:c=10,fillColor:l="none",fillOpacity:d=0,lineWidth:u,lineDash:h,closePath:g=!1}=o,f=u||c,m="http://www.w3.org/2000/svg",v=Bn(t,"path",n),p=i.getSvgNode(v);let I="";for(let E=0,S=s.length;E<S;E++){const _=s[E],D=_.length;if(!(D<2)){for(let b=0;b<D;b++){const M=_[b];I+=`${b?"L":"M"} ${M[0].toFixed(1)}, ${M[1].toFixed(1)} `}g&&(I+="Z ")}}if(!I)return;const C={d:I,stroke:r,fill:l,"fill-opacity":d,"stroke-width":f,"stroke-dasharray":h};if(p)tn(C,p),i.setNodeTouched(v);else{const E=document.createElementNS(m,"path");Gn(C,E),i.appendNode(E,v)}}function tl(i,t,n,e,o,a,s,r,c={},l="",d){const{color:u,fill:h,width:g,lineWidth:f,lineDash:m,fillOpacity:v,strokeOpacity:p}=Object.assign({color:"rgb(0, 255, 0)",fill:"transparent",width:"2",lineDash:void 0,lineWidth:void 0,strokeOpacity:1,fillOpacity:1},c),I=f||g,C="http://www.w3.org/2000/svg",E=Bn(t,"fan",n),S=i.getSvgNode(E),_=s*Math.PI/180,D=r*Math.PI/180,b=e[0],M=e[1],P=b+a*Math.cos(_),T=M+a*Math.sin(_),x=b+a*Math.cos(D),A=M+a*Math.sin(D),O=b+o*Math.cos(_),R=M+o*Math.sin(_),N=b+o*Math.cos(D),k=M+o*Math.sin(D),B=r-s<=180?0:1;let V=`M ${P} ${T}`;V+=` A ${a} ${a} 0 ${B} 1 ${x} ${A}`,V+=` L ${N} ${k}`,V+=` A ${o} ${o} 0 ${B} 0 ${O} ${R}`,V+=" Z";const $={d:V,stroke:u,fill:h,"stroke-width":I,"stroke-dasharray":m,"fill-opacity":v,"stroke-opacity":p,"mix-blend-mode":"normal"};if(S)tn($,S),i.setNodeTouched(E);else{const H=document.createElementNS(C,"path");l!==""&&H.setAttribute("data-id",l),d!==void 0&&(H.style.zIndex=d.toString()),Gn($,H),i.appendNode(H,E)}}function eo(i,t,n,e,o,a={}){const s=Object.assign({fontFamily:"Helvetica, Arial, sans-serif",fontSize:"14px",color:"rgb(255, 255, 0)",background:"",padding:25,centerX:!1,centerY:!0},a);return G1(i,t,n,e,o,s)}function G1(i,t,n,e=[""],o,a){const{padding:s,color:r,fontFamily:c,fontSize:l,background:d,textBoxBorderRadius:u,textBoxMargin:h}=a;let g;const[f,m]=[o[0]+s,o[1]+s],v={color:d,textBoxBorderRadius:u,textBoxMargin:h},p="http://www.w3.org/2000/svg",I=Bn(t,"text",n),C=i.getSvgNode(I);if(C){const E=C.querySelector("text"),S=Array.from(E.children);for(let b=0;b<S.length;b++){const M=S[b],P=e[b]||"";M.textContent=P}if(e.length>S.length){for(let b=0;b<e.length-S.length;b++){const M=e[b+S.length],P=qu(M);E.appendChild(P)}C.appendChild(E),i.appendNode(C,I)}const _={fill:r,"font-size":l,"font-family":c},D={transform:`translate(${f} ${m})`};tn(_,E),tn(D,C),C.setAttribute("data-annotation-uid",t),g=Ku(C,v),i.setNodeTouched(I)}else{const E=document.createElementNS(p,"g");E.setAttribute("data-annotation-uid",t),E.setAttribute("transform",`translate(${f} ${m})`);const S=W1(i,a);for(let _=0;_<e.length;_++){const D=e[_],b=qu(D);S.appendChild(b)}E.appendChild(S),i.appendNode(E,I),g=Ku(E,v)}return Object.assign({},g,{x:f,y:m,height:g.height+s,width:g.width+s})}function W1(i,t){const{color:n,fontFamily:e,fontSize:o}=t,s=document.createElementNS("http://www.w3.org/2000/svg","text"),r="user-select: none; pointer-events: none; -webkit-tap-highlight-color:  rgba(255, 255, 255, 0);",c=`filter:url(#shadow-${i.svgLayerElement.id});`,l=`${r}${c}`;return s.setAttribute("x","0"),s.setAttribute("y","0"),s.setAttribute("fill",n),s.setAttribute("font-family",e),s.setAttribute("font-size",o),s.setAttribute("style",l),s.setAttribute("pointer-events","visible"),s}function qu(i){const n=document.createElementNS("http://www.w3.org/2000/svg","tspan");return n.setAttribute("x","0"),n.setAttribute("dy","1.2em"),n.textContent=i,n}function Ku(i,t){const{color:n,textBoxBorderRadius:e=0,textBoxMargin:o=0}=t;let a=i.querySelector("rect.background");const s=i.querySelector("text").getBBox();if(!n)return a&&i.removeChild(a),i.getBBox();a||(a=document.createElementNS("http://www.w3.org/2000/svg","rect"),a.setAttribute("class","background"),i.insertBefore(a,i.firstChild));const r=i.getBBox(),c={x:`${r.x}`,y:`${r.y}`,width:`${s.width+Number(o)*2}`,height:`${s.height+Number(o)*2}`,fill:n,rx:e,ry:e};return o&&Array.from(i.querySelector("text").querySelectorAll("tspan")).forEach((d,u)=>{u===0&&d.setAttribute("y",o),d.setAttribute("x",o)}),tn(c,a),r}function $1(i,t,n,e,o,a,s={}){const r=e.length>0?Jc(e,o):o,c=H1(a),l=Jc(c,r),d=Object.assign({color:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"2,3"},s);Et(i,t,`link-${n}`,r,l,d)}function H1(i){const{x:t,y:n,height:e,width:o}=i,a=o/2,s=e/2,r=[t+a,n],c=[t,n+s],l=[t+a,n+e],d=[t+o,n+s];return[r,c,l,d]}function Oe(i,t,n,e,o,a,s,r={}){const c=Object.assign({handleRadius:"6",centering:{x:!1,y:!0}},r),l=eo(i,t,n,e,o,c);return $1(i,t,n,a,o,l,c),l}function ld(i,t,n,e,o={},a=""){const{color:s,width:r,lineWidth:c,lineDash:l}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},o),d=c||r,u="http://www.w3.org/2000/svg",h=Bn(t,"rect",n),g=i.getSvgNode(h),[f,m,v,p]=e,I=Math.hypot(f[0]-m[0],f[1]-m[1]),C=Math.hypot(f[0]-v[0],f[1]-v[1]),E=[(p[0]+f[0])/2,(p[1]+f[1])/2],S=[(v[0]+f[0])/2,(v[1]+f[1])/2],_=Math.atan2(E[1]-S[1],E[0]-S[0])*180/Math.PI,D={x:`${E[0]-I/2}`,y:`${E[1]-C/2}`,width:`${I}`,height:`${C}`,stroke:s,fill:"transparent",transform:`rotate(${_} ${E[0]} ${E[1]})`,"stroke-width":d,"stroke-dasharray":l};if(g)tn(D,g),i.setNodeTouched(h);else{const b=document.createElementNS(u,"rect");a!==""&&b.setAttribute("data-id",a),Gn(D,b),i.appendNode(b,h)}}function is(i,t,n,e,o,a={},s=""){const r=[e[0],e[1]],c=[o[0],e[1]],l=[e[0],o[1]],d=[o[0],o[1]];ld(i,t,n,[r,c,l,d],a,s)}const Zu="http://www.w3.org/2000/svg";function Ys(i,t,n,e,o,a={}){if(isNaN(e[0])||isNaN(e[1])||isNaN(o[0])||isNaN(o[1]))return;const{viaMarker:s=!1,color:r="rgb(0, 255, 0)",markerSize:c=10}=a;if(!s){z1(i,t,n,e,o,a);return}const l=i.svgLayerElement.id,u=`${`arrow-${t}`}-${l}`,h=i.svgLayerElement.querySelector("defs");let g=h.querySelector(`#${u}`);if(g){g.setAttribute("markerWidth",`${c}`),g.setAttribute("markerHeight",`${c}`);const f=g.querySelector("path");f&&f.setAttribute("fill",r)}else{g=document.createElementNS(Zu,"marker"),g.setAttribute("id",u),g.setAttribute("viewBox","0 0 10 10"),g.setAttribute("refX","8"),g.setAttribute("refY","5"),g.setAttribute("markerWidth",`${c}`),g.setAttribute("markerHeight",`${c}`),g.setAttribute("orient","auto");const f=document.createElementNS(Zu,"path");f.setAttribute("d","M 0 0 L 10 5 L 0 10 z"),f.setAttribute("fill",r),g.appendChild(f),h.appendChild(g)}a.markerEndId=u,Et(i,t,n,e,o,a)}function z1(i,t,n,e,o,a={}){const{color:s="rgb(0, 255, 0)",width:r=2,lineWidth:c,lineDash:l}=a,d=10,u=Math.atan2(o[1]-e[1],o[0]-e[0]),h={start:[o[0]-d*Math.cos(u-Math.PI/7),o[1]-d*Math.sin(u-Math.PI/7)],end:o},g={start:[o[0]-d*Math.cos(u+Math.PI/7),o[1]-d*Math.sin(u+Math.PI/7)],end:o};Et(i,t,n,e,o,{color:s,width:r,lineWidth:c,lineDash:l}),Et(i,t,"2",h.start,h.end,{color:s,width:r,lineWidth:c,lineDash:l}),Et(i,t,"3",g.start,g.end,{color:s,width:r,lineWidth:c,lineDash:l})}function pm(i,t,n,e,o,a={}){const{color:s,width:r,lineWidth:c,lineDash:l}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},a),d=c||r,u="http://www.w3.org/2000/svg",h=Bn(t,"rect",n),g=i.getSvgNode(h),f=[Math.min(e[0],o[0]),Math.min(e[1],o[1])],m=Math.abs(e[0]-o[0]),v=Math.abs(e[1]-o[1]),p={x:`${f[0]}`,y:`${f[1]}`,width:`${m}`,height:`${v}`,stroke:s,fill:"black","stroke-width":d,"stroke-dasharray":l};if(g)tn(p,g),i.setNodeTouched(h);else{const I=document.createElementNS(u,"rect");Gn(p,I),i.appendNode(I,h)}}const z2=Object.freeze(Object.defineProperty({__proto__:null,draw:fm,drawArrow:Ys,drawCircle:Ae,drawEllipse:B1,drawEllipseByCoordinates:cd,drawFan:tl,drawHandle:Xs,drawHandles:$t,drawHeight:mm,drawLine:Et,drawLinkedTextBox:Oe,drawPath:Jn,drawPolyline:dn,drawRect:is,drawRectByCoordinates:ld,drawRedactionRect:pm,drawTextBox:eo,setAttributesIfNecessary:tn,setNewAttributesIfValid:Gn},Symbol.toStringTag,{value:"Module"}));function vm(i,t){const n=y(i),{renderingEngineId:e,viewportId:o}=n,a=ne(o,e);if(!a)return[];const s=[],r=Object.keys(a.toolOptions);for(let c=0;c<r.length;c++){const l=r[c],d=a.toolOptions[l];if(d&&t.includes(d.mode)){const u=a.getToolInstance(l);s.push(u)}}return s}const{Active:j1,Passive:X1,Enabled:Y1}=Ot;class q1{constructor(){this._needsRender=new Set,this._animationFrameSet=!1,this._animationFrameHandle=null,this._renderFlaggedViewports=()=>{this._throwIfDestroyed();const t=Array.from(this._viewportElements.values());for(let n=0;n<t.length;n++){const e=t[n];if(this._needsRender.has(e)&&(this._triggerRender(e),this._needsRender.delete(e),this._needsRender.size===0))break}this._animationFrameSet=!1,this._animationFrameHandle=null,this._render()},this._viewportElements=new Map}addViewportElement(t,n){this._viewportElements.set(t,n)}removeViewportElement(t,n){this._viewportElements.delete(t),this._needsRender.delete(n),this._reset()}renderViewport(t){this._setViewportsToBeRenderedNextFrame([t])}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setAllViewportsToBeRenderedNextFrame(){[...this._viewportElements.values()].forEach(n=>{this._needsRender.add(n)}),this._renderFlaggedViewports()}_setViewportsToBeRenderedNextFrame(t){const n=[...this._viewportElements.values()];t.forEach(e=>{n.indexOf(e)!==-1&&this._needsRender.add(e)}),this._render()}_render(){this._needsRender.size>0&&this._animationFrameSet===!1&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedViewports),this._animationFrameSet=!0)}_triggerRender(t){const n=y(t);if(!n)return;if(!te(n.renderingEngineId)){console.warn("rendering Engine has been destroyed");return}const o=vm(t,[j1,X1,Y1]),{renderingEngineId:a,viewportId:s}=n,r={element:t,renderingEngineId:a,viewportId:s};fm(t,c=>{let l=!1;const d=u=>{if(u.renderAnnotation){const h=u.renderAnnotation(n,c);l=l||h}};o.forEach(d),l&&gt(t,w.ANNOTATION_RENDERED,{...r})})}_reset(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null,this._setAllViewportsToBeRenderedNextFrame()}}const dd=new q1;function $i(i){dd.renderViewport(i)}function L(i){i.length&&i.forEach(t=>{const n=At(t);if(!n){console.warn(`Viewport not available for ${t}`);return}const{viewport:e}=n;if(!e){console.warn(`Viewport not available for ${t}`);return}const o=e.element;$i(o)})}function Im(i,t){const n=i.length,e=[];for(let o=0;o<n;o++){const a=i[o];a.getFrameOfReferenceUID()===t&&e.push(a)}return e}const{Active:K1,Passive:Z1,Enabled:J1}=Ot;function Lr(i,t){const n=i.length,e=[];for(let o=0;o<n;o++){const a=i[o],s=ne(a.id,a.renderingEngineId);if(!s)continue;Q1(s,t)&&e.push(a)}return e}function Q1(i,t){const{toolOptions:n}=i,e=n[t];if(!e)return!1;const o=e.mode;return o===K1||o===Z1||o===J1}function wm(i,t,n=.999){return i.filter(e=>{const o=e.getCamera();return Math.abs(dt(o.viewPlaneNormal,t.viewPlaneNormal))>n})}function Q(i,t,n=!0){const e=y(i),{renderingEngine:o,FrameOfReferenceUID:a}=e;let s=o.getViewports();s=Im(s,a),s=Lr(s,t);const r=o.getViewport(e.viewportId);return n&&(s=wm(s,r.getCamera())),s.map(l=>l.id)}const tE=Object.freeze(Object.defineProperty({__proto__:null,filterViewportsWithFrameOfReferenceUID:Im,filterViewportsWithParallelNormals:wm,filterViewportsWithToolEnabled:Lr,getViewportIdsWithToolToRender:Q},Symbol.toStringTag,{value:"Module"})),Ju=1e-10,qs="PlanarFreehandContourSegmentationTool";function en(i,t){const n=i.length,e=new Array(n);for(let o=0;o<n;o++)e[o]=t.worldToCanvas(i[o]);return e}function Cm(i,t){const n=i.length,e=new Array(n);for(let o=0;o<n;o++)e[o]=t.canvasToWorld(i[o]);return e}function as(i,t){const n=bo(i),e=bo(t);if(!od(n,e))return{hasIntersection:!1,isContourHole:!1};const a=yr(i,t),s=!a&&ii(t,i);return{hasIntersection:a||s,isContourHole:s}}function Em(i,t){return Ja(t).map(n=>{const e=n,o=en(e.data.contour.polyline,i);return{annotation:e,polyline:o}})}function Rr(i,t,n){Za(t,n),Sn(n);const{contour:e}=n.data,o=en(e.polyline,i);bn(n,{points:o,closed:e.closed,targetWindingDirection:t.data.contour.windingDirection===Ge.Clockwise?Ge.CounterClockwise:Ge.Clockwise},i);const{element:a}=i;hd(i,[t,n])}function ud(i,t,n,e,o){if(!Er(qs)){console.warn(`${qs} is not registered in cornerstone. Cannot combine polylines.`);return}const a=o[0],s=ke(n,a),r=Em(i,t),c=new Set(r),l=new Map,d=(I,C)=>{let E=l.get(I);E||(E=[],l.set(I,E)),E.push(C),c.delete(C)},u=[];if(s){const I=Ar(n,o);u.push(I),Array.from(c.keys()).forEach(C=>d(I,C))}else xr(n,o).forEach(C=>{u.push(C),Array.from(c.keys()).forEach(E=>{ii(C,E.polyline)&&d(C,E)})});Array.from(l.values()).forEach(I=>I.forEach(C=>Bi(C.annotation)));const{element:h}=i,{metadata:g,data:f}=t,{handles:m,segmentation:v}=f,{textBox:p}=m;ft(e.annotationUID),ft(t.annotationUID),Sn(e),Sn(t);for(let I=0;I<u.length;I++){const C=u[I];if(!C||C.length<3){console.warn("Skipping creation of new annotation due to invalid polyline:",C);continue}const E=Sm(i,t,C);mt(E,h),Qn(E),It(E,i.element),l.get(C)?.forEach(S=>Za(E,S.annotation))}hd(i,[t,e])}function Sm(i,t,n){const e=i.canvasToWorld(n[0]),o=i.canvasToWorld(n[n.length-1]),a={metadata:{...t.metadata,toolName:qs,originalToolName:t.metadata.originalToolName||t.metadata.toolName},data:{cachedStats:{},handles:{points:[e,o],textBox:t.data.handles.textBox?{...t.data.handles.textBox}:void 0},contour:{polyline:[],closed:!0},spline:t.data.spline,segmentation:{...t.data.segmentation}},annotationUID:Xt(),highlighted:!0,invalidated:!0,isLocked:!1,isVisible:void 0,interpolationUID:t.interpolationUID,interpolationCompleted:t.interpolationCompleted};return bn(a,{points:n,closed:!0,targetWindingDirection:Ge.Clockwise},i),a}function hd(i,t){const{element:n}=i,e=new Set([qs]);t.forEach(o=>{e.add(o.metadata.toolName)});for(const o of e.values())if(Er(o)){const a=Q(n,o);L(a)}}function gd(i){if(!i||i.length<2)return i;const t=[i[0]];for(let n=1;n<i.length;n++){const e=i[n],o=t[t.length-1],a=Math.abs(e[0]-o[0]),s=Math.abs(e[1]-o[1]);(a>Ju||s>Ju)&&t.push(e)}return t}function fd(i){const t=[],n=new Set;for(let e of i){if(!e||e.length<3||(e=gd(e),e.length<3))continue;const a=[...e].sort((s,r)=>s[0]!==r[0]?s[0]-r[0]:s[1]-r[1]).map(s=>`${s[0].toFixed(6)},${s[1].toFixed(6)}`).join("|");n.has(a)||(n.add(a),t.push(e))}return t}const eE="PlanarFreehandContourSegmentationTool";function nE(i,t,n,e,o){return e.forEach(({polyline:a,viewReference:s})=>{if(a.length<3)return;const r={annotationUID:Xt(),data:{contour:{closed:!0,polyline:a},segmentation:{segmentationId:n,segmentIndex:o},handles:{}},handles:{},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:eE,...s}};mt(r,i.element);const c=t?.get(o)||new Set;c.add(r.annotationUID),t.set(o,c)}),t}function Va(i){const{metadata:t}=i;if(!t)return{};const{FrameOfReferenceUID:n,referencedImageId:e,referencedImageURI:o,multiSliceReference:a,cameraFocalPoint:s,viewPlaneNormal:r,viewUp:c,sliceIndex:l,volumeId:d,bounds:u}=t;return{FrameOfReferenceUID:n,referencedImageId:e,referencedImageURI:o,multiSliceReference:a,cameraFocalPoint:s,viewPlaneNormal:r,viewUp:c,sliceIndex:l,volumeId:d,bounds:u}}function Nr(i,t){if(!i||!t||i.FrameOfReferenceUID!==t.FrameOfReferenceUID||i.referencedImageId!==t.referencedImageId||!i.viewPlaneNormal||!t.viewPlaneNormal||i.viewPlaneNormal.length!==t.viewPlaneNormal.length)return!1;for(let n=0;n<i.viewPlaneNormal.length;n++)if(i.viewPlaneNormal[n]!==t.viewPlaneNormal[n])return!1;return!0}function Fa(i,t){const n=[],e=new Set,o=new Set;for(let a=0;a<i.length;a++){if(e.has(a))continue;const s=i[a];let r=!1;for(let c=0;c<t.length;c++){if(o.has(c))continue;const l=t[c];if(!Nr(s.viewReference,l.viewReference))continue;if(Wi(s.polyline,l.polyline)){n.push(s),e.add(a),o.add(c),r=!0;break}const d=as(s.polyline,l.polyline);if(d.hasIntersection&&!d.isContourHole){const u=Ar(s.polyline,l.polyline);n.push({polyline:u,viewReference:s.viewReference}),e.add(a),o.add(c),r=!0;break}}r||(n.push(s),e.add(a))}for(let a=0;a<t.length;a++)o.has(a)||n.push(t[a]);return n}function oE(i){if(i.length===0)return[];if(i.length===1)return[...i[0]];let t=[...i[0]];for(let n=1;n<i.length;n++)t=Fa(t,i[n]);return t}function iE(i,t,n){const e=i.map(a=>({polyline:en(a.data.contour.polyline,n),viewReference:Va(a)})),o=t.map(a=>({polyline:en(a.data.contour.polyline,n),viewReference:Va(a)}));return Fa(e,o)}function Li(i,t){const n=[];for(let e=0;e<i.length;e++){let o=[i[e]];for(let a=0;a<t.length;a++){const s=t[a],r=[];for(const c of o){if(!Nr(c.viewReference,s.viewReference)){r.push(c);continue}if(Wi(c.polyline,s.polyline))continue;const l=as(c.polyline,s.polyline);if(l.hasIntersection&&!l.isContourHole){const d=fd(xr(c.polyline,s.polyline));for(const u of d){const h=gd(u);h.length>=3&&r.push({polyline:h,viewReference:c.viewReference})}}else r.push({polyline:c.polyline,viewReference:c.viewReference})}o=r}n.push(...o)}return n}function aE(i,t){if(t.length===0)return[...i];let n=[...i];for(let e=0;e<t.length;e++)n=Li(n,t[e]);return n}function sE(i,t,n){const e=i.map(a=>({polyline:en(a.data.contour.polyline,n),viewReference:Va(a)})),o=t.map(a=>({polyline:en(a.data.contour.polyline,n),viewReference:Va(a)}));return Li(e,o)}function _m(i,t){if(!i.length||!t.length)return[];const n=[];for(const e of i)for(const o of t){if(!Nr(e.viewReference,o.viewReference))continue;if(Wi(e.polyline,o.polyline)){n.push({...e});continue}const a=as(e.polyline,o.polyline);if(a.hasIntersection&&!a.isContourHole){const s=fd(cm(e.polyline,o.polyline));s&&s.length>0&&s.forEach(r=>{n.push({polyline:r,viewReference:e.viewReference})})}}return n}function Dm(i,t){if(!i.length&&!t.length)return[];if(!i.length)return t;if(!t.length)return i;if(i.length===t.length){let a=!0;for(let s=0;s<i.length;s++){let r=!1;for(let c=0;c<t.length;c++)if(Nr(i[s].viewReference,t[c].viewReference)&&Wi(i[s].polyline,t[c].polyline)){r=!0;break}if(!r){a=!1;break}}if(a)return[]}const n=Li(i,t),e=Li(t,i);return[...n,...e]}var wn;(function(i){i[i.Union=0]="Union",i[i.Subtract=1]="Subtract",i[i.Intersect=2]="Intersect",i[i.XOR=3]="XOR",i[i.Copy=4]="Copy",i[i.Delete=5]="Delete"})(wn||(wn={}));function Qu(i,t){const n=[],{annotationUIDsMap:e}=i||{};if(!e?.has(t))return;const o=e.get(t);for(const a of o){const s=xt(a),{polyline:r}=s.data.contour;n.push({polyline:r,viewReference:Va(s)})}return n}function rE(i,t,n){const e=pt(t.segmentationId),o=pt(n.segmentationId);if(!e||!o||!e.representationData.Contour||!o.representationData.Contour)return;const a=Qu(e.representationData.Contour,t.segmentIndex),s=Qu(o.representationData.Contour,n.segmentIndex);if(!a||!s)return;const r=a.map(({polyline:l,viewReference:d})=>({polyline:en(l,i),viewReference:d})),c=s.map(({polyline:l,viewReference:d})=>({polyline:en(l,i),viewReference:d}));return{polyLinesInfoCanvas1:r,polyLinesInfoCanvas2:c}}function cE(i,{segmentIndex:t,label:n,color:e}){if(!i?.segments)return;const o=i.segments[t]??{active:!1,locked:!1,segmentIndex:t,cachedStats:{},label:n,color:e};n!==void 0&&(o.label=n),e!==void 0&&(o.color=e),i.segments[t]=o}function bm(i){i.forEach(t=>{const n=xt(t);ft(t),Sn(n)}),i.clear()}function Ur(i,t,n,e){const o=ed(i.segmentationId);if(!o)return;const{polyLinesInfoCanvas1:a,polyLinesInfoCanvas2:s}=rE(o,i,t)||{};if(!a||!s)return;let r;switch(e){case wn.Union:r=Fa(a,s);break;case wn.Subtract:r=Li(a,s);break;case wn.Intersect:r=_m(a,s);break;case wn.XOR:r=Dm(a,s);break;default:r=Fa(a,s);break}const c=r.map(({polyline:v,viewReference:p})=>({polyline:Cm(v,o),viewReference:p})),l=n,d=pt(l.segmentationId),u=l.segmentIndex,h=l.color,g=l.label,f=d.representationData.Contour,{annotationUIDsMap:m}=f;if(m){if(i.segmentationId===l.segmentationId&&i.segmentIndex===u){const v=m.get(u);v&&bm(v)}nE(o,m,d.segmentationId,c,u),cE(d,{segmentIndex:u,color:h,label:g})}}function lE(i,t,n){Ur(i,t,n,wn.Union)}function dE(i,t,n){Ur(i,t,n,wn.Subtract)}function uE(i,t,n){Ur(i,t,n,wn.Intersect)}function hE(i,t,n){Ur(i,t,n,wn.XOR)}function gE(i,t){tm(i.segmentationId,i.segmentIndex,t.segmentationId,t.segmentIndex)}function fE(i){const t=pt(i.segmentationId);if(!t){console.log("No active segmentation detected");return}if(!t.representationData.Contour){console.log("No contour representation found");return}const n=t.representationData.Contour,{annotationUIDsMap:e}=n;if(!e){console.log("No annotation map found");return}if(!e.has(i.segmentIndex)){console.log("Segmentation index has no annotations");return}const o=e.get(i.segmentIndex);bm(o)}function Hi(i){return!!i.data?.segmentation}function Tm(i,t,n){const e=[],o=bo(t);for(let a=0;a<n.length;a++){const s=n[a],r=mE(s.data.contour.polyline,i),c=bo(r);if(!od(o,c))continue;const d=yr(t,r),u=!d&&ii(r,t);(d||u)&&e.push({targetAnnotation:s,targetPolyline:r,isContourHole:u})}return e}function mE(i,t){const n=i.length,e=new Array(n);for(let o=0;o<n;o++)e[o]=t.worldToCanvas(i[o]);return e}const Ks="PlanarFreehandContourSegmentationTool";function Pm(i,t,n,e){const o=e.filter(s=>s.isContourHole),a=e.filter(s=>!s.isContourHole);if(o.length>0){const s=o[0];CE(i,s.targetAnnotation,t),Mm(i,[t,s.targetAnnotation]);return}if(a.length!==0){if(!Er(Ks)){console.warn(`${Ks} is not registered in cornerstone. Cannot process multiple intersections.`);return}pE(i,t,n,a)}}function pE(i,t,n,e){const{element:o}=i,a=[t],s=[],r=[];e.forEach(({targetAnnotation:h})=>{const g=wE(i,h);r.push(...g),a.push(h)});const c=n[0];if(e.some(({targetPolyline:h})=>ke(h,c))){let h=n;e.forEach(({targetPolyline:g})=>{h=Ar(h,g)}),s.push(h)}else e.forEach(({targetPolyline:h})=>{const g=xr(h,n);s.push(...g)});a.forEach(h=>{ft(h.annotationUID),Sn(h)}),r.forEach(h=>Bi(h.annotation));const d=e[0].targetAnnotation,u=[];s.forEach(h=>{if(!h||h.length<3){console.warn("Skipping creation of new annotation due to invalid polyline:",h);return}const g=vE(i,d,h);mt(g,o),Qn(g),It(g,i.element),u.push(g)}),IE(i,r,u),Mm(i,a)}function vE(i,t,n){const e=i.canvasToWorld(n[0]),o=i.canvasToWorld(n[n.length-1]),a={metadata:{...t.metadata,toolName:Ks,originalToolName:t.metadata.originalToolName||t.metadata.toolName},data:{cachedStats:{},handles:{points:[e,o],textBox:t.data.handles.textBox?{...t.data.handles.textBox}:void 0},contour:{polyline:[],closed:!0},spline:t.data.spline,segmentation:{...t.data.segmentation}},annotationUID:Xt(),highlighted:!0,invalidated:!0,isLocked:!1,isVisible:void 0,interpolationUID:t.interpolationUID,interpolationCompleted:t.interpolationCompleted};return bn(a,{points:n,closed:!0,targetWindingDirection:Ge.Clockwise},i),a}function IE(i,t,n){t.forEach(e=>{const o=n.find(a=>{const s=md(a.data.contour.polyline,i);return ii(s,e.polyline)});o&&Za(o,e.annotation)})}function wE(i,t){return Ja(t).map(n=>{const e=n,o=md(e.data.contour.polyline,i);return{annotation:e,polyline:o}})}function CE(i,t,n){Za(t,n),Sn(n);const{contour:e}=n.data,o=md(e.polyline,i);bn(n,{points:o,closed:e.closed,targetWindingDirection:t.data.contour.windingDirection===Ge.Clockwise?Ge.CounterClockwise:Ge.Clockwise},i)}function md(i,t){const n=i.length,e=new Array(n);for(let o=0;o<n;o++)e[o]=t.worldToCanvas(i[o]);return e}function Mm(i,t){const{element:n}=i,e=new Set([Ks]);t.forEach(o=>{e.add(o.metadata.toolName)});for(const o of e.values())if(Er(o)){const a=Q(n,o);L(a)}}const{isEqual:th}=Rt;function pd(i){const{metadata:t}=i;return HI().filter(n=>{if(n.FrameOfReferenceUID===t.FrameOfReferenceUID){const e=n.viewport,{viewPlaneNormal:o,viewUp:a}=e.getCamera();return th(o,t.viewPlaneNormal)&&(!t.viewUp||th(a,t.viewUp))}}).map(n=>n.viewport)}async function EE(i,t,n,e=!0){const o=typeof i=="string"?xt(i):i,a=typeof t=="string"?xt(t):t;if(!o||!a)throw new Error("Both source and target annotations must be valid");n||(n=SE(o));const s=en(o.data.contour.polyline,n),r=en(a.data.contour.polyline,n),c=as(s,r);if(!c.hasIntersection){console.warn("No intersection found between the two annotations");return}if(c.isContourHole){if(!e){console.warn("Hole processing is disabled");return}Rr(n,a,o)}else ud(n,a,r,o,s)}function SE(i){const t=pd(i);if(!t.length)throw new Error("No viewport found for the annotation");return t[0]}const _E=Object.freeze(Object.defineProperty({__proto__:null,get LogicalOperation(){return wn},add:lE,addContourSegmentationAnnotation:Qn,areSameSegment:Vf,checkIntersection:as,cleanupPolylines:fd,combinePolylines:ud,contourSegmentationOperation:EE,convertContourPolylineToCanvasSpace:en,convertContourPolylineToWorld:Cm,convertContourSegmentationAnnotation:Ql,copy:gE,copyAnnotation:Qf,copyContourSegment:tm,createNewAnnotationFromPolyline:Sm,createPolylineHole:Rr,deleteOperation:fE,findAllIntersectingContours:Tm,getContourHolesData:Em,intersect:uE,intersectPolylinesSets:_m,isContourSegmentationAnnotation:Hi,processMultipleIntersections:Pm,removeContourSegmentationAnnotation:Sn,removeDuplicatePoints:gd,subtract:dE,subtractAnnotationPolylines:sE,subtractMultiplePolylineSets:aE,subtractPolylineSets:Li,unifyAnnotationPolylines:iE,unifyMultiplePolylineSets:oE,unifyPolylineSets:Fa,updateViewportsForAnnotations:hd,xor:hE,xorPolylinesSets:Dm},Symbol.toStringTag,{value:"Module"}));function DE(i){if(!i)throw new Error(`No contours found for geometryId ${i.id}`);const t=i.id;if(i.type!==zI.CONTOUR)throw new Error(`Geometry type ${i.type} not supported for rendering.`);if(!i.data){console.warn(`No contours found for geometryId ${t}. Skipping render.`);return}}function bE(i,t,n,e){n.size?i.render():TE(i,t,e)}function TE(i,t,n){const{segmentationId:e}=n,o=new Map;t.forEach(a=>{const s=X.getGeometry(a);if(!s){console.warn(`No geometry found for geometryId ${a}. Skipping render.`);return}const r=s.data.segmentIndex;DE(s);const c=Xe.getStyle({viewportId:i.id,segmentationId:e,type:tt.Contour,segmentIndex:r}),l=s.data,d=i.getCamera().viewPlaneNormal;l.contours.forEach(u=>{const{points:h,color:g,id:f}=u,m=Kl(i,h[0],d),v={annotationUID:Xt(),data:{contour:{closed:!0,polyline:h},segmentation:{segmentationId:e,segmentIndex:r,color:g,id:f},handles:{}},handles:{},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!0,isVisible:!0,metadata:{referencedImageId:m,toolName:"PlanarFreehandContourSegmentationTool",FrameOfReferenceUID:i.getFrameOfReferenceUID(),viewPlaneNormal:i.getCamera().viewPlaneNormal}},p=i.element;mt(v,p),Qn(v)}),c&&o.set(r,c)}),i.render()}function xm(i){const t=hC(i);if(t)return t;const n=pt(i);if(!n)throw new Error(`No segmentation found for segmentationId ${i}`);let e;if(n.representationData.Labelmap)e=PE(n,i);else if(n.representationData.Contour)e=yE(n);else if(n.representationData.Surface)e=AE(n);else throw new Error(`Unsupported segmentation type: ${n.representationData}`);return gC(i,e),e}function PE(i,t){const n=i.representationData[tt.Labelmap],e=new Set;return n.imageIds?xE(e,n.imageIds):ME(e,t),Array.from(e).map(Number).sort((o,a)=>o-a)}function ME(i,t){X.getVolume(t).voxelManager.forEach(({value:e})=>{e!==0&&i.add(e)})}function xE(i,t){t.forEach(n=>{X.getImage(n).voxelManager.getScalarData().forEach(a=>{a!==0&&i.add(a)})})}function yE(i){const{annotationUIDsMap:t,geometryIds:n}=i.representationData.Contour||{};if(!n)throw new Error(`No geometryIds found for segmentationId ${i.segmentationId}`);const e=new Set([...t.keys()]);return n.forEach(o=>{const a=X.getGeometry(o);e.add(a.data.segmentIndex)}),Array.from(e).sort((o,a)=>o-a)}function AE(i){const t=i.representationData.Surface?.geometryIds??[];return Array.from(t.keys()).map(Number).sort((n,e)=>n-e)}const ui=new Map,eh=new Map;function OE(i,t,n=!1){const e=At(i);if(!e)return;const{viewport:o}=e;n&&o.render()}async function LE(i,t){const{segmentationId:n}=t,e=pt(n);if(!e)return;let o=e.representationData[tt.Contour];const a=Rn();if(!o&&Rn()?.canComputeRequestedRepresentation(n,tt.Contour)&&!ui.get(i.id)?(ui.set(i.id,!0),o=await Xl(n,tt.Contour,()=>a.computeContourData(n,{viewport:i})),ui.set(i.id,!1)):!o&&!Rn()&&console.debug(`No contour data found for segmentationId ${n} and PolySeg add-on is not configured. Unable to convert from other representations to contour. Please register PolySeg using cornerstoneTools.init({ addons: { polySeg } }) to enable automatic conversion.`),!o||!o.geometryIds?.length)return;let s=!1;const r=i.getCamera().viewPlaneNormal;o.annotationUIDsMap&&(s=!NE(o.annotationUIDsMap,r)),o.geometryIds.length>0&&(s=!RE(o.geometryIds,r));const c=eh.get(i.id)||new Set;if(s&&!ui.get(i.id)&&!c.has(n)&&i.viewportStatus===jI.RENDERED){ui.set(i.id,!0);const l=xm(n),u=(await a.computeSurfaceData(n,{segmentIndices:l,viewport:i})).geometryIds,h=[];for(const v of u.values()){const I=X.getGeometry(v).data;h.push({points:I.points,polys:I.polys,segmentIndex:I.segmentIndex,id:I.segmentIndex})}const g=await a.clipAndCacheSurfacesForViewport(h,i),f=a.extractContourData(g),m=a.createAndAddContourSegmentationsFromClippedSurfaces(f,i,n);o.annotationUIDsMap=new Map([...o.annotationUIDsMap,...m]),c.add(n),eh.set(i.id,c),ui.set(i.id,!1)}bE(i,o.geometryIds,o.annotationUIDsMap,t)}function RE(i,t){let n=null,e=null;for(const d of i){const u=X.getGeometry(d);if(!u)continue;const h=u.data;if(h.contours?.[0]?.points?.length>=3){n=u,e=h;break}}if(!n||!e)return!1;const o=e.contours,{points:a}=o[0],[s]=a,r=W(),{length:c}=a,l=Math.ceil(c/25);for(let d=1;d<c;d+=l){const u=a[d];if(me(r,s,u),Zt(r,r),dt(t,r)>.1)return!1}return!0}function NE(i,t){const n=Array.from(i.values()).flat().map(o=>Array.from(o)).flat(),e=_g(n,3);for(const o of e){const a=xt(o);if(a?.metadata){if(!a.metadata.viewPlaneNormal)continue;const s=a.metadata.viewPlaneNormal,r=Math.abs(t[0]*s[0]+t[1]*s[1]+t[2]*s[2]);if(Math.abs(r-1)>.01)return!1}}return!0}function UE(i){return null}const vd={getUpdateFunction:UE,render:LE,removeRepresentation:OE};function Mo(i,t){const n=no(i,t);if(n?.length)return n[0]}function no(i,t){return Vt.getCurrentLabelmapImageIdsForViewport(i,t)}function kE(i,t){return Vt.getLabelmapImageIdsForImageId(i,t)}const nh=new Map,VE=({cfun:i,ofun:t,actor:n})=>{n.getProperty().setRGBTransferFunction(1,i),n.getProperty().setScalarOpacity(1,t)};async function FE({viewport:i,volumeInputs:t,segmentationId:n}){const e=i.getDefaultActor(),{actor:o}=e,{uid:a,callback:s}=e,r=i.getVolumeId();if(nh.get(a)?.added)return{uid:a,actor:o};const c=t,l=X.getVolume(c[0].volumeId);if(!l)throw new Error(`imageVolume with id: ${l.volumeId} does not exist`);const{volumeId:d}=c[0],u=await XI(d);if(!u)throw new Error(`segImageVolume with id: ${u.volumeId} does not exist`);const g=u.voxelManager.getCompleteScalarDataArray(),{imageData:f}=u,m=X.getVolume(r),p=m.voxelManager.getCompleteScalarDataArray(),I=2,C=new Float32Array(I*m.voxelManager.getScalarDataLength()),E=f.getDimensions();for(let M=0;M<E[2];++M)for(let P=0;P<E[1];++P)for(let T=0;T<E[0];++T){const x=T+E[0]*(P+E[1]*M);C[x*I+0]=p[x],C[x*I+1]=g[x]}i.removeActors([a]);const S=o.getMapper(),_=YI(S);o.setMapper(_),_.setBlendMode($o.LABELMAP_EDGE_PROJECTION_BLEND);const D=_.getInputData().getPointData().getArray(0);D.setData(C),D.setNumberOfComponents(2),o.getProperty().setColorMixPreset(1),o.getProperty().setForceNearestInterpolation(1,!0),o.getProperty().setIndependentComponents(!0),i.addActor({actor:o,uid:a,callback:s,referencedId:r,representationUID:`${n}-${tt.Labelmap}`}),nh.set(a,{added:!0,segmentationRepresentationUID:`${n}`,originalBlendMode:i.getBlendMode()}),o.set({preLoad:VE});function b(M){const{segmentationId:P}=M.detail,{representationData:T}=pt(P),{volumeId:x}=T.Labelmap;if(x!==u.volumeId)return;const O=X.getVolume(x).voxelManager,R=_.getInputData(),N=R.getPointData().getArray(0),k=N.getData(),B=2,V=f.getDimensions(),$=Array.from({length:V[2]},(H,G)=>G);for(const H of $)for(let G=0;G<V[1];++G)for(let Y=0;Y<V[0];++Y){const q=Y+V[0]*(G+V[1]*H);k[q*B+1]=O.getAtIndex(q)}N.setData(k),R.modified(),i.render()}return z.addEventListenerDebounced(w.SEGMENTATION_DATA_MODIFIED,b,200),z.addEventListener(w.SEGMENTATION_REPRESENTATION_REMOVED,async M=>{z.removeEventListener(w.SEGMENTATION_DATA_MODIFIED,b);const P=i.getActor(a),{element:T,id:x}=i;i.removeActors([a]);const A=await qI({volumeId:a,blendMode:$o.MAXIMUM_INTENSITY_BLEND,callback:({volumeActor:O})=>{P.callback&&P.callback({volumeActor:O,volumeId:d})}},T,x);i.addActor({actor:A,uid:a}),i.render()}),{uid:a,actor:o}}const{uuidv4:ym}=Rt;async function BE(i,t,n,e){const o=y(i),{renderingEngine:a,viewport:s}=o,{id:r}=s,c=!0,l=!1,d=!0;if(s instanceof ve){const h=GE(t,n);X.getVolume(h)||await WE(t);let g=e?.blendMode??$o.MAXIMUM_INTENSITY_BLEND,f=g===$o.LABELMAP_EDGE_PROJECTION_BLEND;if(f){const v=s.getVolumeId(),p=X.getVolume(v),C=X.getVolume(h).dimensions,E=p.dimensions;(C[0]!==E[0]||C[1]!==E[1]||C[2]!==E[2])&&(f=!1,g=$o.MAXIMUM_INTENSITY_BLEND,console.debug("Dimensions mismatch - falling back to regular volume addition"))}const m=[{volumeId:h,visibility:c,representationUID:`${n}-${tt.Labelmap}`,useIndependentComponents:f,blendMode:g}];if(!m[0].useIndependentComponents)await F0(a,m,[r],l,d);else return await FE({viewport:s,volumeInputs:m,segmentationId:n})}else{const h=no(s.id,n).map(g=>({imageId:g,representationUID:`${n}-${tt.Labelmap}-${g}`}));B0(a,h,[r])}Pe(n)}function GE(i,t){let{volumeId:n}=i;if(!n){n=ym();const e=pt(t);e.representationData.Labelmap={...e.representationData.Labelmap,volumeId:n},i.volumeId=n,gn(t)}return n}async function WE(i){const t=i;if(!(t.imageIds.length>0))throw new Error("cannot create labelmap, no imageIds found for the volume labelmap");return await Sg(i.volumeId||ym(),t.imageIds)}function $E(i,t){const n=y(i),{viewport:e}=n;e.removeActors([bC(e.id,t)])}function Ko(i){return Vt.getActiveSegmentation(i)}function HE(i,t){Vt.setActiveSegmentation(i,t)}function oo(i){return Ko(i)}function zE(i,t){HE(i,t)}const jE=Object.freeze(Object.defineProperty({__proto__:null,getActiveSegmentation:oo,setActiveSegmentation:zE},Symbol.toStringTag,{value:"Module"}));function $e(i){const t=pt(i);if(t){const n=Object.keys(t.segments).find(e=>t.segments[e].active);return n?Number(n):void 0}}const hc=255,ma=new Map;let gc=!1;function XE(i,t,n=!1){const e=At(i);if(ma.forEach((a,s)=>{s.includes(t)&&ma.delete(s)}),!e)return;const{viewport:o}=e;$E(o.element,t),n&&o.render()}async function YE(i,t){const{segmentationId:n,config:e}=t,o=pt(n);if(!o){console.warn("No segmentation found for segmentationId: ",n);return}let a=o.representationData[tt.Labelmap],s=fa(i.id,n);if(!a&&Rn()?.canComputeRequestedRepresentation(n,tt.Labelmap)&&!gc){gc=!0;const r=Rn();if(a=await Xl(n,tt.Labelmap,()=>r.computeLabelmapData(n,{viewport:i}),()=>{Vt.processLabelmapRepresentationAddition(i.id,n),setTimeout(()=>{Pe(n)},0)}),!a)throw new Error(`No labelmap data found for segmentationId ${n}.`);gc=!1}else!a&&!Rn()&&console.debug(`No labelmap data found for segmentationId ${n} and PolySeg add-on is not configured. Unable to convert from other representations to labelmap. Please register PolySeg using cornerstoneTools.init({ addons: { polySeg } }) to enable automatic conversion.`);if(a){if(i instanceof ae)s?.length||await ih(i,a,n,e),s=fa(i.id,n);else{if(!no(i.id,n)?.length)return;s||await ih(i,a,n,e),s=fa(i.id,n)}if(s?.length)for(const r of s)qE(i.id,r,t)}}function qE(i,t,n){const{segmentationId:e}=n,{cfun:o,ofun:a}=n.config,{colorLUTIndex:s}=n,c=oo(i)?.segmentationId===e,l=Xe.getStyle({viewportId:i,type:tt.Labelmap,segmentationId:e}),d=Xe.getRenderInactiveSegmentations(i),u=ts(s),h=Math.min(256,u.length),{outlineWidth:g,renderOutline:f,outlineOpacity:m,activeSegmentOutlineWidthDelta:v}=oh(l,c),p=Yl(i,{segmentationId:e,type:tt.Labelmap});for(let S=0;S<h;S++){const _=S,D=u[_],M=Xe.getStyle({viewportId:i,type:tt.Labelmap,segmentationId:e,segmentIndex:_}),{fillAlpha:P,outlineWidth:T,renderFill:x,renderOutline:A}=oh(l,c,M),{forceOpacityUpdate:O,forceColorUpdate:R}=KE(i,e,_,{fillAlpha:P,renderFill:x,renderOutline:A,segmentColor:D,outlineWidth:T,segmentsHidden:p,cfun:o,ofun:a});if(R&&o.addRGBPoint(_,D[0]/hc,D[1]/hc,D[2]/hc),O)if(x){const N=p.has(_)?0:D[3]/255*P;a.removePoint(_),a.addPointLong(_,N,.5,1)}else a.addPointLong(_,.01,.5,1)}a.setClamping(!1);const I=t.actor,{preLoad:C}=I.get?.("preLoad")||{preLoad:null};if(C?C({cfun:o,ofun:a,actor:I}):(I.getProperty().setRGBTransferFunction(0,o),I.getProperty().setScalarOpacity(0,a),I.getProperty().setInterpolationTypeToNearest()),f){I.getProperty().setUseLabelOutline(f),I.getProperty().setLabelOutlineOpacity(m);const S=$e(n.segmentationId),_=new Array(h-1);for(let D=1;D<h;D++){if(p.has(D)){_[D-1]=0;continue}_[D-1]=D===S?g+v:g}I.getProperty().setLabelOutlineThickness(_),I.modified(),I.getProperty().modified(),I.getMapper().modified()}else I.getProperty().setLabelOutlineThickness(new Array(h-1).fill(0));const E=c||d;I.setVisibility(E)}function oh(i,t,n){const o={...i,...n||{}},a=t?o.fillAlpha:o.fillAlphaInactive,s=t?o.outlineWidth:o.outlineWidthInactive,r=t?o.renderFill:o.renderFillInactive,c=t?o.renderOutline:o.renderOutlineInactive,l=t?o.outlineOpacity:o.outlineOpacityInactive,d=o.activeSegmentOutlineWidthDelta;return{fillAlpha:a,outlineWidth:s,renderFill:r,renderOutline:c,outlineOpacity:l,activeSegmentOutlineWidthDelta:d}}function KE(i,t,n,{fillAlpha:e,renderFill:o,renderOutline:a,segmentColor:s,outlineWidth:r,segmentsHidden:c,cfun:l,ofun:d}){const u=`${i}-${t}-${n}`,h=ma.get(u);if(!h)return ma.set(u,{fillAlpha:e,renderFill:o,renderOutline:a,outlineWidth:r,segmentColor:s.slice(),segmentsHidden:new Set(c),cfunMTime:l.getMTime(),ofunMTime:d.getMTime()}),{forceOpacityUpdate:!0,forceColorUpdate:!0};const{fillAlpha:g,renderFill:f,renderOutline:m,outlineWidth:v,segmentColor:p,segmentsHidden:I,cfunMTime:C,ofunMTime:E}=h,S=p[0]!==s[0]||p[1]!==s[1]||p[2]!==s[2],_=p[3]!==s[3]||g!==e||f!==o||m!==a||v!==r||I!==c;return(_||S)&&ma.set(u,{fillAlpha:e,renderFill:o,renderOutline:a,outlineWidth:r,segmentColor:s.slice(),segmentsHidden:new Set(c),cfunMTime:l.getMTime(),ofunMTime:d.getMTime()}),{forceOpacityUpdate:_,forceColorUpdate:S}}async function ih(i,t,n,e){return await BE(i.element,t,n,e)||void 0}function ZE(i){}const Id={getUpdateFunction:ZE,render:YE,removeRepresentation:XE},{CalibrationTypes:Lo}=fr,fc="px",ah="voxels",Am=[1,2,3,4],JE=["4,3","4,7"],el={0:"px",1:"percent",2:"dB",3:"cm",4:"seconds",5:"hertz",6:"dB/seconds",7:"cm/sec",8:"cm",9:"cm/s",12:"degrees"},mc="",QE=[Lo.ERMF,Lo.USER,Lo.ERROR,Lo.PROJECTION,Lo.CALIBRATED,Lo.UNKNOWN],nn=(i,t)=>{const{calibration:n,hasPixelSpacing:e,spacing:o=[1,1,1]}=i;let a=e?"mm":fc;const s=e?"mm":ah;let r=a+mc;const c=n?.scale||1;let l=c/(n?.columnPixelSpacing||o[0]),d=c/(n?.rowPixelSpacing||o[1]),u=c/o[2],h="";if(!n||!n.type&&!n.sequenceOfUltrasoundRegions)return{unit:a,areaUnit:r,scale:l,scaleY:d,scaleZ:u,volumeUnit:s};if(QE.includes(n?.type)&&(h=n.type),n.type===Lo.UNCALIBRATED)return{unit:fc,areaUnit:fc+mc,scale:l,scaleY:d,scaleZ:u,volumeUnit:ah};if(n.sequenceOfUltrasoundRegions){const g=n.sequenceOfUltrasoundRegions.find(f=>t.every(m=>m[0]>=f.regionLocationMinX0&&m[0]<=f.regionLocationMaxX1&&m[1]>=f.regionLocationMinY0&&m[1]<=f.regionLocationMaxY1)&&Am.includes(f.regionDataType));if(g&&g.physicalUnitsXDirection===g.physicalUnitsYDirection){const f=Math.abs(g.physicalDeltaX),m=Math.abs(g.physicalDeltaY);l=1/f,d=1/m,h="US Region",a=el[g.physicalUnitsXDirection]||"unknown",r=a+mc}}else n.scale&&(l=n.scale);return{unit:a+(h?` ${h}`:""),areaUnit:r+(h?` ${h}`:""),volumeUnit:s+(h?` ${h}`:""),scale:l,scaleY:d,scaleZ:u}},Zs=(i,t)=>{const[n]=t,{calibration:e}=i;let o=["raw"],a=[null],s="";if(!e||!e.type&&!e.sequenceOfUltrasoundRegions)return{units:o,values:a};if(e.sequenceOfUltrasoundRegions){const r=e.sequenceOfUltrasoundRegions.filter(m=>Am.includes(m.regionDataType)&&JE.includes(`${m.physicalUnitsXDirection},${m.physicalUnitsYDirection}`));if(!r?.length)return{units:o,values:a};const c=r.find(m=>n[0]>=m.regionLocationMinX0&&n[0]<=m.regionLocationMaxX1&&n[1]>=m.regionLocationMinY0&&n[1]<=m.regionLocationMaxY1);if(!c)return{units:o,values:a};const{referencePixelX0:l=0,referencePixelY0:d=0}=c,{physicalDeltaX:u,physicalDeltaY:h}=c,g=(n[1]-c.regionLocationMinY0-d)*h,f=(n[0]-c.regionLocationMinX0-l)*u;s="US Region",a=[f,g],o=[el[c.physicalUnitsXDirection],el[c.physicalUnitsYDirection]]}return{units:o,values:a,calibrationType:s}},wd=i=>i.calibration?.aspect||1,{isEqual:pc}=Rt,{EPSILON:tS}=Qo,eS=1-tS;function Cd(i,t,n){const{viewPlaneNormal:e}=t,o=i.filter(c=>{const{planeRestriction:l,referencedImageId:d}=c.metadata;let{viewPlaneNormal:u}=c.metadata;if(l){const{inPlaneVector1:g,inPlaneVector2:f}=l;return!(g&&!pc(0,dt(e,g))||f&&!pc(0,dt(e,f)))}if(!c.metadata.referencedImageId&&!u&&c.metadata.FrameOfReferenceUID){for(const g of c.data.handles.points){const f=me(W(),g,t.focalPoint),m=dt(f,e);if(!pc(m,0))return!1}return c.metadata.viewPlaneNormal=e,c.metadata.cameraFocalPoint=t.focalPoint,!0}if(!u&&d){const{imageOrientationPatient:g}=ye("imagePlaneModule",d),f=wt(g[0],g[1],g[2]),m=wt(g[3],g[4],g[5]);u=W(),be(u,f,m),c.metadata.viewPlaneNormal=u}const h=Math.abs(dt(e,u))>eS;return u&&h});if(!o.length)return[];const a=n/2,{focalPoint:s}=t,r=[];for(const c of o){const{data:l,metadata:d,isVisible:u}=c;if(!u)continue;const h=d.planeRestriction?.point||l.handles?.points?.[0]||l.contour?.polyline[0];if(!h){r.push(c);continue}const g=me(W(),s,h);Math.abs(dt(g,e))<a&&r.push(c)}return r}function kr(i,t,n,e){const o=W();be(o,t,i);const a=wt(...n),s=wt(...e),r=W();oe(r,a,s);const c=We(r);if(c<1e-4)return{worldWidth:0,worldHeight:0};const l=dt(r,o)/(c*We(o)),u=Math.sqrt(1-l*l)*c,h=l*c;return{worldWidth:u,worldHeight:h}}function ss(i,t,n={}){if(i instanceof ae){const e=i.getCamera(),{spacingInNormalDirection:o}=Pl(i,e);return Cd(t,e,o)}if(i instanceof Ie){const e=i.getCurrentImageId();if(!e)return[];const o=e.indexOf(":");n.imageURI=e.substring(o+1)}return t.filter(e=>e.isVisible?e.data.isCanvasAnnotation?!0:i.isReferenceViewable(e.metadata,n):!1)}function rs(i,t,n,e){const o=W();be(o,t,i);const a=wt(...n),s=wt(...e),r=W();oe(r,a,s);const c=We(r);if(c<1e-4)return{worldWidth:0,worldHeight:0};const l=dt(r,o)/(c*We(o)),u=Math.sqrt(1-l*l)*c,h=l*c;return{worldWidth:u,worldHeight:h}}function Ed(i,t,n,e,o=.25){const a=Sd(i,t,{targetVolumeId:n,stepSize:o});let s;for(const r of a){const c=i.getIntensityFromWorld(r),l=e(c,r);l&&(s=l)}return s}function Sd(i,t,{targetVolumeId:n,stepSize:e}){const o=i.getCamera(),{viewPlaneNormal:a}=o,{spacingInNormalDirection:s}=Pl(i,o,n),r=s*e||1,c=i.getBounds(),l=[];let d=[...t];for(;sh(d,c);)l.push([...d]),d[0]+=a[0]*r,d[1]+=a[1]*r,d[2]+=a[2]*r;for(d=[...t];sh(d,c);)l.push([...d]),d[0]-=a[0]*r,d[1]-=a[1]*r,d[2]-=a[2]*r;return l}const sh=function(i,t){const[n,e,o,a,s,r]=t,c=10;return i[0]>n+c&&i[0]<e-c&&i[1]>o+c&&i[1]<a-c&&i[2]>s+c&&i[2]<r-c},Om=(i,t,n,e,o,a,s,r)=>{const c=[wt(n,e,o),wt(a,e,o),wt(n,s,o),wt(a,s,o),wt(n,e,r),wt(a,e,r),wt(n,s,r),wt(a,s,r)],l=wt(t[0],t[1],t[2]),d=wt(i[0],i[1],i[2]),u=-dt(l,d);let h=null;for(const g of c){const f=dt(l,g)+u;if(h===null)h=Math.sign(f);else if(Math.sign(f)!==h)return!0}return!1},{EPSILON:nS}=Qo,oS=1-nS;function Vr(i,t){const{viewPlaneNormal:n}=t,e=i.filter(o=>{let a=o.metadata.viewPlaneNormal;if(!a){const{referencedImageId:r}=o.metadata,{imageOrientationPatient:c}=ye("imagePlaneModule",r),l=wt(c[0],c[1],c[2]),d=wt(c[3],c[4],c[5]);a=W(),be(a,l,d),o.metadata.viewPlaneNormal=a}const s=Math.abs(dt(n,a))>oS;return a&&s});return e.length?e:[]}const iS={filterAnnotationsWithinSlice:Cd,getWorldWidthAndHeightFromCorners:kr,getWorldWidthAndHeightFromTwoPoints:rs,filterAnnotationsForDisplay:ss,getPointInLineOfSightWithCriteria:Ed,isPlaneIntersectingAABB:Om,filterAnnotationsWithinSamePlane:Vr,getPointsInLineOfSight:Sd},aS=Object.freeze(Object.defineProperty({__proto__:null,default:iS,filterAnnotationsForDisplay:ss,filterAnnotationsWithinSamePlane:Vr,filterAnnotationsWithinSlice:Cd,getPointInLineOfSightWithCriteria:Ed,getPointsInLineOfSight:Sd,getWorldWidthAndHeightFromCorners:kr,getWorldWidthAndHeightFromTwoPoints:rs,isPlaneIntersectingAABB:Om},Symbol.toStringTag,{value:"Module"}));function _d(i){const t=typeof i;return i!==null&&(t==="object"||t==="function")}function zi(i,t,n){let e,o,a,s,r,c,l=0,d=!1,u=!1,h=!0;const g=!t&&t!==0&&typeof window.requestAnimationFrame=="function";if(typeof i!="function")throw new TypeError("Expected a function");t=Number(t)||0,_d(n)&&(d=!!n.leading,u="maxWait"in n,a=u?Math.max(Number(n.maxWait)||0,t):a,h="trailing"in n?!!n.trailing:h);function f(P){const T=e,x=o;return e=o=void 0,l=P,s=i.apply(x,T),s}function m(P,T){return g?window.requestAnimationFrame(P):setTimeout(P,T)}function v(P){if(g)return window.cancelAnimationFrame(P);clearTimeout(P)}function p(P){return l=P,r=m(E,t),d?f(P):s}function I(P){const T=P-c,x=P-l,A=t-T;return u?Math.min(A,a-x):A}function C(P){const T=P-c,x=P-l;return c===void 0||T>=t||T<0||u&&x>=a}function E(){const P=Date.now();if(C(P))return S(P);r=m(E,I(P))}function S(P){return r=void 0,h&&e?f(P):(e=o=void 0,s)}function _(){r!==void 0&&v(r),l=0,e=c=o=r=void 0}function D(){return r===void 0?s:S(Date.now())}function b(){return r!==void 0}function M(...P){const T=Date.now(),x=C(T);if(e=P,o=this,c=T,x){if(r===void 0)return p(c);if(u)return r=m(E,t),f(c)}return r===void 0&&(r=m(E,t)),s}return M.cancel=_,M.flush=D,M.pending=b,M}function Fe(i,t,n){let e=!0,o=!0;if(typeof i!="function")throw new TypeError("Expected a function");return _d(n)&&(e="leading"in n?!!n.leading:e,o="trailing"in n?!!n.trailing:o),zi(i,t,{leading:e,trailing:o,maxWait:t})}function sS(i){return i[0]?.length===3}function rS(i,t){if(!t||t.length===0||t.length===i.length)return i;const n=t[t.length-1]-t[0]+1,e=nc(t.map(a=>i[a][0])),o=nc(t.map(a=>i[a][1]));if(sS(i)){const a=nc(t.map(s=>i[s][2]));return Su(ia(e,n),ia(o,n),ia(a,n))}else return Su(ia(e,n),ia(o,n))}function cS(i,t){const n=[],[e,o]=t,a=o-e+1,s=Math.floor(a/i);let r=0,c=Math.round((a-1)/(s-1)*r)+e;for(;c<=o;)n.push(c),r++,c=Math.round((a-1)/(s-1)*r)+e;return n}function Js(i,t,n,e){const o=n-t+1,a=Math.floor(e/100*o)??1,s=Math.floor(o/a)??1;if(isNaN(o)||!o||!s||o/s<2)return i;const r=Math.max(0,t),c=Math.min(i.length-1,n),l=i.slice(0,r),d=i.slice(c+1,i.length),u=cS(s,[r,c]),h=rS(i,u);return[...l,...h,...d]}function Fr(i,t){return t?.autoGenerated?!1:i?.smoothing?.smoothOnAdd===!0||i?.smoothing?.smoothOnEdit===!0}function lS(i,t){return Fn(i,t)<.001}function dS(i,t){return Fn(i,t)===0}function uS(i,t){for(let n=0;n<i.length;n++)for(let e=0;e<t.length;e++)if(dS(i[n],t[e]))return[n,e]}function pi(i,t,n){return(i+t+n)%t}function rh(i,t,n,e){const[,o,a]=i,[,s,r]=t,c=a.length,l=r.length;let d=i[0],u=t[0];if(!a[d]||!r[u]||!a[o]||!r[s])return[void 0,void 0];for(;d!==o&&u!==s;){if(n(r[u],a[d]))return[d,u];d=pi(d,c,e),u=pi(u,l,e)}return[void 0,void 0]}function hS(i,t){const[n,e]=uS(i,t)||[],o=(c,l)=>lS(c,l)===!1,[a,s]=rh([pi(n,i.length,1),n,i],[pi(e,t.length,1),e,t],o,1),[r]=rh([pi(a,i.length,-1),a,i],[pi(s,t.length,-1),s,t],o,-1);return[a,r]}function Br(i,t,n){const{interpolation:e,smoothing:o}=i,a=t;if(e){const{knotsRatioPercentageOnAdd:s,knotsRatioPercentageOnEdit:r,smoothOnAdd:c=!1,smoothOnEdit:l=!1}=o,d=n?r:s;if(n?l:c){const[h,g]=n?hS(t,n):[0,t.length-1];return!t[h]||!t[g]?t:Js(t,h,g,d)}}return a}const ji=i=>{if(i.shiftKey)return i.ctrlKey?De.ShiftCtrl:i.altKey?De.ShiftAlt:i.metaKey?De.ShiftMeta:De.Shift;if(i.ctrlKey)return i.altKey?De.CtrlAlt:i.metaKey?De.CtrlMeta:De.Ctrl;if(i.altKey)return i.metaKey&&De.AltMeta||De.Alt;if(i.metaKey)return De.Meta};function Dd(i,t){const n=i[0],e=i[i.length-1],o=et();sn(o,e[0]-n[0],e[1]-n[1]),yn(o,o);const a=et(),s=et();sn(a,-o[1],o[0]),sn(s,o[1],-o[0]);const r=[(n[0]+e[0])/2,(n[1]+e[1])/2],c={dist:0,index:null};for(let u=0;u<i.length;u++){const h=i[u],g=Tl(h,r);g>c.dist&&(c.dist=g,c.index=u)}return[i[c.index],r].map(t.canvasToWorld)}function gS(i,t){const{viewport:n}=i,e=t.data.contour.polyline.map(n.worldToCanvas);return Dd(e,n)}const{addCanvasPointsToArray:bd,pointsAreWithinCloseContourProximity:Lm,getFirstLineSegmentIntersectionIndexes:Rm,getSubPixelSpacingAndXYDirections:fS}=Po;function mS(i,t,n){this.isDrawing=!0;const e=i.detail,{currentPoints:o,element:a}=e,s=o.canvas,r=y(a),{viewport:c}=r,l=ji(i.detail.event)===this.configuration.contourHoleAdditionModifierKey,{spacing:d,xDir:u,yDir:h}=fS(c,this.configuration.subPixelResolution)||{};!d||!u||!h||(this.drawData={canvasPoints:[s],polylineIndex:0,contourHoleProcessingEnabled:l,newAnnotation:!0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:d,xDir:u,yDir:h,movingTextBox:!1},U.isInteractingWithTool=!0,a.addEventListener(w.MOUSE_UP,this.mouseUpDrawCallback),a.addEventListener(w.MOUSE_DRAG,this.mouseDragDrawCallback),a.addEventListener(w.MOUSE_CLICK,this.mouseUpDrawCallback),a.addEventListener(w.TOUCH_END,this.mouseUpDrawCallback),a.addEventListener(w.TOUCH_DRAG,this.mouseDragDrawCallback),a.addEventListener(w.TOUCH_TAP,this.mouseUpDrawCallback),nt(a))}function pS(i){U.isInteractingWithTool=!1,i.removeEventListener(w.MOUSE_UP,this.mouseUpDrawCallback),i.removeEventListener(w.MOUSE_DRAG,this.mouseDragDrawCallback),i.removeEventListener(w.MOUSE_CLICK,this.mouseUpDrawCallback),i.removeEventListener(w.TOUCH_END,this.mouseUpDrawCallback),i.removeEventListener(w.TOUCH_DRAG,this.mouseDragDrawCallback),i.removeEventListener(w.TOUCH_TAP,this.mouseUpDrawCallback),ht(i)}function vS(i){const t=i.detail,{currentPoints:n,element:e}=t,o=n.world,a=n.canvas,s=y(e),{viewport:r}=s,{annotation:c,viewportIdsToRender:l,xDir:d,yDir:u,spacing:h,movingTextBox:g}=this.commonData,{polylineIndex:f,canvasPoints:m,newAnnotation:v}=this.drawData;this.createMemo(e,c,{newAnnotation:v});const p=m[m.length-1],I=r.canvasToWorld(p),C=W();oe(C,o,I);const E=Math.abs(dt(C,d)),S=Math.abs(dt(C,u));if(!(E<=h[0]&&S<=h[1])){if(g){this.isDrawing=!1;const{deltaPoints:_}=t,D=_.world,{textBox:b}=c.data.handles,{worldPosition:M}=b;M[0]+=D[0],M[1]+=D[1],M[2]+=D[2],b.hasMoved=!0}else{const _=this.findCrossingIndexDuringCreate(i);if(_!==void 0)this.applyCreateOnCross(i,_);else{const D=bd(e,m,a,this.commonData);this.drawData.polylineIndex=f+D}c.invalidated=!0}L(l),c.invalidated&&It(c,e,lt.HandlesUpdated)}}function IS(i){const{allowOpenContours:t}=this.configuration,{canvasPoints:n,contourHoleProcessingEnabled:e}=this.drawData,o=n[0],a=n[n.length-1],s=i.detail,{element:r}=s;this.doneEditMemo(),this.drawData.newAnnotation=!1,t&&!Lm(o,a,this.configuration.closeContourProximity)?this.completeDrawOpenContour(r,{contourHoleProcessingEnabled:e}):this.completeDrawClosedContour(r,{contourHoleProcessingEnabled:e})}function wS(i,t){this.removeCrossedLinesOnCompleteDraw();const{canvasPoints:n}=this.drawData,{contourHoleProcessingEnabled:e,minPointsToSave:o}=t??{};if(o&&n.length<o||this.haltDrawing(i,n))return!1;const{annotation:a,viewportIdsToRender:s}=this.commonData,r=y(i),{viewport:c,renderingEngine:l}=r;bd(i,n,n[0],this.commonData),n.pop();const d=Fr(this.configuration,a)?Br(this.configuration,n):n;this.updateContourPolyline(a,{points:d,closed:!0,targetWindingDirection:Ge.Clockwise},c);const{textBox:u}=a.data.handles;return u?.hasMoved||Cr(a,e),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,L(s),this.deactivateDraw(i),!0}function CS(){const{canvasPoints:i}=this.drawData,t=i.length,n=[i[0],i[t-1]],e=i.slice(0,-1).slice(1),o=Rm(e,n[0],n[1],!1);if(o){const a=o[1];a===1?this.drawData.canvasPoints=i.splice(1):this.drawData.canvasPoints=i.splice(0,a)}}function ES(i,t){const{canvasPoints:n}=this.drawData,{contourHoleProcessingEnabled:e}=t??{};if(this.haltDrawing(i,n))return!1;const{annotation:o,viewportIdsToRender:a}=this.commonData,s=y(i),{viewport:r,renderingEngine:c}=s,l=Fr(this.configuration,o)?Br(this.configuration,n):n;this.updateContourPolyline(o,{points:l,closed:!1},r);const{textBox:d}=o.data.handles,u=o.data.contour.polyline;return o.data.handles.points=[u[0],u[u.length-1]],o.data.isOpenUShapeContour&&(o.data.openUShapeContourVectorToPeak=Dd(n,r)),d.hasMoved||Cr(o,e),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,L(a),this.deactivateDraw(i),!0}function SS(i){const t=i.detail,{currentPoints:n,lastPoints:e}=t,o=n.canvas,a=e.canvas,{canvasPoints:s}=this.drawData,r=s.slice(0,-1),c=Rm(r,o,a,!1);return c===void 0?void 0:c[0]}function _S(i,t){const n=i.detail,{element:e}=n,{canvasPoints:o,contourHoleProcessingEnabled:a}=this.drawData,{annotation:s,viewportIdsToRender:r}=this.commonData;bd(e,o,o[t],this.commonData),o.pop();const c=o.slice(t),l=os(c);if(Pt(l,0)){o.splice(t+1);return}o.splice(0,t);const d={contourHoleProcessingEnabled:a,minPointsToSave:3};this.completeDrawClosedContour(e,d)&&this.activateClosedContourEdit(i,s,r)}function DS(i){const{allowOpenContours:t}=this.configuration,{canvasPoints:n,contourHoleProcessingEnabled:e}=this.drawData,o=n[0],a=n[n.length-1];t&&!Lm(o,a,this.configuration.closeContourProximity)?this.completeDrawOpenContour(i,{contourHoleProcessingEnabled:e}):this.completeDrawClosedContour(i,{contourHoleProcessingEnabled:e})}function bS(i,t){const n=Math.max(t*3,3);return i.length<n}function TS(i,t){const{subPixelResolution:n}=this.configuration;if(bS(t,n)){const{annotation:e,viewportIdsToRender:o}=this.commonData,a=y(i),{renderingEngine:s}=a;return ft(e.annotationUID),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,L(o),this.deactivateDraw(i),!0}return!1}function PS(i){i.activateDraw=mS.bind(i),i.deactivateDraw=pS.bind(i),i.applyCreateOnCross=_S.bind(i),i.findCrossingIndexDuringCreate=SS.bind(i),i.completeDrawOpenContour=ES.bind(i),i.removeCrossedLinesOnCompleteDraw=CS.bind(i),i.mouseDragDrawCallback=vS.bind(i),i.mouseUpDrawCallback=IS.bind(i),i.completeDrawClosedContour=wS.bind(i),i.cancelDrawing=DS.bind(i),i.haltDrawing=TS.bind(i)}const{addCanvasPointsToArray:MS,getFirstLineSegmentIntersectionIndexes:Zo}=Po;function xS(i,t){const n=i.detail,{element:e,currentPoints:o,lastPoints:a}=n,s=o.canvas,r=a.canvas,{editCanvasPoints:c,prevCanvasPoints:l}=this.editData,d=Zo(l,s,r,t);if(d)this.editData.startCrossingIndex=d[0],this.removePointsUpUntilFirstCrossing(t);else if(l.length>=2)if(c.length>this.configuration.checkCanvasEditFallbackProximity){const u=c[0],h=[];for(let m=0;m<l.length;m++){const v=l[m],p=jt(v,u);h.push({distance:p,index:m})}h.sort((m,v)=>m.distance-v.distance);const g=[h[0],h[1]],f=Math.min(g[0].index,g[1].index);this.editData.startCrossingIndex=f}else{const u=et();Ft(u,c[1],c[0]),yn(u,u);const h=6,g=[c[0][0]-u[0]*h,c[0][1]-u[1]*h],f=Zo(l,g,c[0],t);if(f){const m=[g];MS(e,m,c[0],this.commonData),c.unshift(...m),this.removePointsUpUntilFirstCrossing(t),this.editData.editIndex=c.length-1,this.editData.startCrossingIndex=f[0]}}}function yS(i){const{editCanvasPoints:t,prevCanvasPoints:n}=this.editData;let e=0;for(let o=0;o<t.length-1;o++){const a=[t[o],t[o+1]],s=!!Zo(n,a[0],a[1],i);if(e++,s)break}t.splice(0,e),this.editData.editIndex=t.length-1}function AS(i,t){const n=i.detail,{currentPoints:e,lastPoints:o}=n,a=e.canvas,s=o.canvas,{prevCanvasPoints:r}=this.editData;return!!Zo(r,a,s,t)}function OS(i){const{prevCanvasPoints:t,editCanvasPoints:n}=this.editData;for(let e=n.length-1;e>0;e--){const o=[n[e],n[e-1]],a=!!Zo(t,o[0],o[1],i);if(n.pop(),a)break}}function LS(){const{editCanvasPoints:i,prevCanvasPoints:t,startCrossingIndex:n}=this.editData;if(n===void 0)return;const e=i[i.length-1],o=[];for(let s=0;s<t.length;s++){const r=t[s],c=jt(r,e);o.push({distance:c,index:s})}o.sort((s,r)=>s.distance-r.distance);const a=i.slice(0,-1);for(let s=0;s<o.length;s++){const{index:r}=o[s],c=t[r],l=i[i.length-1];if(!Zo(a,c,l,!1))return r}return-1}function RS(i){const t=i.detail,{currentPoints:n,lastPoints:e}=t,o=n.canvas,a=e.canvas,{editCanvasPoints:s}=this.editData,r=s.slice(0,-2),c=Zo(r,o,a,!1);if(!c)return;const l=c[0],d=s.length-l;for(let u=0;u<d;u++)s.pop()}function NS(i){i.checkForFirstCrossing=xS.bind(i),i.removePointsUpUntilFirstCrossing=yS.bind(i),i.checkForSecondCrossing=AS.bind(i),i.findSnapIndex=LS.bind(i),i.removePointsAfterSecondCrossing=OS.bind(i),i.checkAndRemoveCrossesOnEditLine=RS.bind(i)}const{getSubPixelSpacingAndXYDirections:US,addCanvasPointsToArray:Nm,getArea:ch}=Po;function kS(i,t,n){this.isEditingClosed=!0;const e=i.detail,{currentPoints:o,element:a}=e,s=o.canvas,r=y(a);if(!r)return;const{viewport:c}=r,l=t.data.contour.polyline.map(c.worldToCanvas),{spacing:d,xDir:u,yDir:h}=US(c,this.configuration.subPixelResolution);this.editData={prevCanvasPoints:l,editCanvasPoints:[s],startCrossingIndex:void 0,editIndex:0,annotation:t},this.commonData={annotation:t,viewportIdsToRender:n,spacing:d,xDir:u,yDir:h,movingTextBox:!1},U.isInteractingWithTool=!0,a.addEventListener(w.MOUSE_UP,this.mouseUpClosedContourEditCallback),a.addEventListener(w.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),a.addEventListener(w.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),a.addEventListener(w.TOUCH_END,this.mouseUpClosedContourEditCallback),a.addEventListener(w.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),a.addEventListener(w.TOUCH_TAP,this.mouseUpClosedContourEditCallback),nt(a)}function VS(i){U.isInteractingWithTool=!1,i.removeEventListener(w.MOUSE_UP,this.mouseUpClosedContourEditCallback),i.removeEventListener(w.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),i.removeEventListener(w.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),i.removeEventListener(w.TOUCH_END,this.mouseUpClosedContourEditCallback),i.removeEventListener(w.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),i.removeEventListener(w.TOUCH_TAP,this.mouseUpClosedContourEditCallback),ht(i)}function FS(i){const t=i.detail,{currentPoints:n,element:e}=t,o=n.world,a=n.canvas,s=y(e),{viewport:r}=s,{viewportIdsToRender:c,xDir:l,yDir:d,spacing:u}=this.commonData,{editIndex:h,editCanvasPoints:g,startCrossingIndex:f,annotation:m}=this.editData;this.createMemo(e,m);const v=g[g.length-1],p=r.canvasToWorld(v),I=W();oe(I,o,p);const C=Math.abs(dt(I,l)),E=Math.abs(dt(I,d));if(C<=u[0]&&E<=u[1])return;f!==void 0&&this.checkAndRemoveCrossesOnEditLine(i);const S=Nm(e,g,a,this.commonData),_=h+S;if(this.editData.editIndex=_,f===void 0&&g.length>1&&this.checkForFirstCrossing(i,!0),this.editData.snapIndex=this.findSnapIndex(),this.editData.snapIndex===-1){this.finishEditAndStartNewEdit(i);return}this.editData.fusedCanvasPoints=this.fuseEditPointsWithClosedContour(i),f!==void 0&&this.checkForSecondCrossing(i,!0)&&(this.removePointsAfterSecondCrossing(!0),this.finishEditAndStartNewEdit(i)),L(c)}function BS(i){const t=i.detail,{element:n}=t,e=y(n),{viewport:o,renderingEngine:a}=e,{annotation:s,viewportIdsToRender:r}=this.commonData,{fusedCanvasPoints:c,editCanvasPoints:l}=this.editData;bn(s,{points:c,closed:!0,targetWindingDirection:Ge.Clockwise},o),s.autoGenerated&&(s.autoGenerated=!1),It(s,n);const d=l.pop();this.editData={prevCanvasPoints:c,editCanvasPoints:[d],startCrossingIndex:void 0,editIndex:0,snapIndex:void 0,annotation:s},L(r)}function GS(i){const{prevCanvasPoints:t,editCanvasPoints:n,startCrossingIndex:e,snapIndex:o}=this.editData;if(e===void 0||o===void 0)return;const a=i.detail,{element:s}=a,r=[...n];Nm(s,r,t[o],this.commonData),r.length>n.length&&r.pop();let c,l;e>o?(c=o,l=e):(c=e,l=o);const d=jt(t[c],r[0]),u=jt(t[c],r[r.length-1]),h=jt(t[l],r[0]),g=jt(t[l],r[r.length-1]),f=[];for(let S=0;S<c;S++){const _=t[S];f.push([_[0],_[1]])}let m=d+g,v=u+h;if(m<v)for(let S=0;S<r.length;S++){const _=r[S];f.push([_[0],_[1]])}else for(let S=r.length-1;S>=0;S--){const _=r[S];f.push([_[0],_[1]])}for(let S=l;S<t.length;S++){const _=t[S];f.push([_[0],_[1]])}const p=[];for(let S=c;S<l;S++){const _=t[S];p.push([_[0],_[1]])}if(m=h+u,v=g+d,m<v)for(let S=0;S<r.length;S++){const _=r[S];p.push([_[0],_[1]])}else for(let S=r.length-1;S>=0;S--){const _=r[S];p.push([_[0],_[1]])}const I=ch(f),C=ch(p);return I>C?f:p}function WS(i){const t=i.detail,{element:n}=t;this.completeClosedContourEdit(n)}function $S(i){const t=y(i),{viewport:n}=t,{annotation:e,viewportIdsToRender:o}=this.commonData;this.doneEditMemo();const{fusedCanvasPoints:a,prevCanvasPoints:s}=this.editData;if(a){const r=Fr(this.configuration,e)?Br(this.configuration,a,s):a,c=this.configuration?.decimate||{};bn(e,{points:r,closed:!0,targetWindingDirection:Ge.Clockwise},n,{decimate:{enabled:!!c.enabled,epsilon:c.epsilon}}),e.autoGenerated&&(e.autoGenerated=!1),It(e,i)}this.isEditingClosed=!1,this.editData=void 0,this.commonData=void 0,L(o),this.deactivateClosedContourEdit(i)}function HS(i){this.completeClosedContourEdit(i)}function zS(i){i.activateClosedContourEdit=kS.bind(i),i.deactivateClosedContourEdit=VS.bind(i),i.mouseDragClosedContourEditCallback=FS.bind(i),i.mouseUpClosedContourEditCallback=WS.bind(i),i.finishEditAndStartNewEdit=BS.bind(i),i.fuseEditPointsWithClosedContour=GS.bind(i),i.cancelClosedContourEdit=HS.bind(i),i.completeClosedContourEdit=$S.bind(i)}const{addCanvasPointsToArray:Um,getSubPixelSpacingAndXYDirections:jS}=Po;function XS(i,t,n){this.isEditingOpen=!0;const e=i.detail,{currentPoints:o,element:a}=e,s=o.canvas,r=y(a),{viewport:c}=r;this.doneEditMemo();const l=t.data.contour.polyline.map(c.worldToCanvas),{spacing:d,xDir:u,yDir:h}=jS(c,this.configuration.subPixelResolution);this.editData={prevCanvasPoints:l,editCanvasPoints:[s],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:d,xDir:u,yDir:h,movingTextBox:!1},U.isInteractingWithTool=!0,a.addEventListener(w.MOUSE_UP,this.mouseUpOpenContourEditCallback),a.addEventListener(w.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),a.addEventListener(w.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),a.addEventListener(w.TOUCH_END,this.mouseUpOpenContourEditCallback),a.addEventListener(w.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),a.addEventListener(w.TOUCH_TAP,this.mouseUpOpenContourEditCallback),nt(a)}function YS(i){U.isInteractingWithTool=!1,i.removeEventListener(w.MOUSE_UP,this.mouseUpOpenContourEditCallback),i.removeEventListener(w.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),i.removeEventListener(w.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),i.removeEventListener(w.TOUCH_END,this.mouseUpOpenContourEditCallback),i.removeEventListener(w.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),i.removeEventListener(w.TOUCH_TAP,this.mouseUpOpenContourEditCallback),ht(i)}function qS(i){const t=i.detail,{currentPoints:n,element:e}=t,o=n.world,a=n.canvas,s=y(e),{viewport:r}=s,{viewportIdsToRender:c,xDir:l,yDir:d,spacing:u}=this.commonData,{editIndex:h,editCanvasPoints:g,startCrossingIndex:f}=this.editData,m=g[g.length-1],v=r.canvasToWorld(m),p=W();this.createMemo(e,this.commonData.annotation),oe(p,o,v);const I=Math.abs(dt(p,l)),C=Math.abs(dt(p,d));if(I<=u[0]&&C<=u[1])return;f!==void 0&&this.checkAndRemoveCrossesOnEditLine(i);const E=Um(e,g,a,this.commonData),S=h+E;this.editData.editIndex=S,f===void 0&&g.length>1&&this.checkForFirstCrossing(i,!1),this.editData.snapIndex=this.findSnapIndex(),this.editData.fusedCanvasPoints=this.fuseEditPointsWithOpenContour(i),f!==void 0&&this.checkForSecondCrossing(i,!1)?(this.removePointsAfterSecondCrossing(!1),this.finishEditOpenOnSecondCrossing(i)):this.checkIfShouldOverwriteAnEnd(i)&&this.openContourEditOverwriteEnd(i),L(c)}function KS(i){const t=i.detail,{element:n}=t,e=y(n),{viewport:o}=e,{annotation:a,viewportIdsToRender:s}=this.commonData,r=this.fuseEditPointsForOpenContourEndEdit();bn(a,{points:r,closed:!1},o);const c=a.data.contour.polyline;a.data.handles.points=[c[0],c[c.length-1]],a.data.handles.activeHandleIndex=1,It(a,n),this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,this.doneEditMemo(),this.deactivateOpenContourEdit(n),this.activateOpenContourEndEdit(i,a,s,null)}function ZS(i){const t=i.detail,{currentPoints:n,lastPoints:e}=t,o=n.canvas,a=e.canvas,{snapIndex:s,prevCanvasPoints:r,startCrossingIndex:c}=this.editData;if(c===void 0||s===void 0)return!1;if(s===-1)return!0;if(s!==0&&s!==r.length-1)return!1;const l=o,d=a,u=r[s],h=et(),g=et();sn(h,l[0]-d[0],l[1]-d[1]),sn(g,l[0]-u[0],l[1]-u[1]);const f=Xn(h,g),m=Math.sqrt(h[0]*h[0]+h[1]*h[1]),v=Math.sqrt(g[0]*g[0]+g[1]*g[1]);return Math.acos(f/(m*v))<Math.PI/2}function JS(){const{snapIndex:i,prevCanvasPoints:t,editCanvasPoints:n,startCrossingIndex:e}=this.editData,o=[];if(i===0)for(let r=t.length-1;r>=e;r--){const c=t[r];o.push([c[0],c[1]])}else for(let r=0;r<e;r++){const c=t[r];o.push([c[0],c[1]])}const a=jt(t[e],n[0]),s=jt(t[e],n[n.length-1]);if(a<s)for(let r=0;r<n.length;r++){const c=n[r];o.push([c[0],c[1]])}else for(let r=n.length-1;r>=0;r--){const c=n[r];o.push([c[0],c[1]])}return o}function QS(i){const{prevCanvasPoints:t,editCanvasPoints:n,startCrossingIndex:e,snapIndex:o}=this.editData;if(e===void 0||o===void 0)return;const a=i.detail,{element:s}=a,r=[...n];Um(s,r,t[o],this.commonData),r.length>n.length&&r.pop();let c,l;e>o?(c=o,l=e):(c=e,l=o);const d=jt(t[c],r[0]),u=jt(t[c],r[r.length-1]),h=jt(t[l],r[0]),g=jt(t[l],r[r.length-1]),f=[];for(let p=0;p<c;p++){const I=t[p];f.push([I[0],I[1]])}const m=d+g,v=u+h;if(m<v)for(let p=0;p<r.length;p++){const I=r[p];f.push([I[0],I[1]])}else for(let p=r.length-1;p>=0;p--){const I=r[p];f.push([I[0],I[1]])}for(let p=l;p<t.length;p++){const I=t[p];f.push([I[0],I[1]])}return f}function t_(i){const t=i.detail,{element:n}=t,e=y(n),{viewport:o,renderingEngine:a}=e,{annotation:s,viewportIdsToRender:r}=this.commonData,{fusedCanvasPoints:c,editCanvasPoints:l}=this.editData;bn(s,{points:c,closed:!1},o);const d=s.data.contour.polyline;s.data.handles.points=[d[0],d[d.length-1]],It(s,n);const u=l.pop();this.editData={prevCanvasPoints:c,editCanvasPoints:[u],startCrossingIndex:void 0,editIndex:0},L(r)}function e_(i){const t=i.detail,{element:n}=t;this.completeOpenContourEdit(n)}function n_(i){const t=y(i),{viewport:n}=t,{annotation:e,viewportIdsToRender:o}=this.commonData;this.doneEditMemo();const{fusedCanvasPoints:a,prevCanvasPoints:s}=this.editData;if(a){const r=Fr(this.configuration)?Br(this.configuration,a,s):a,c=this.configuration?.decimate||{};bn(e,{points:r,closed:!1},n,{decimate:{enabled:!!c.enabled,epsilon:c.epsilon}});const l=e.data.contour.polyline;e.data.handles.points=[l[0],l[l.length-1]],e.data.isOpenUShapeContour&&(e.data.openUShapeContourVectorToPeak=Dd(a,n)),It(e,i)}this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,L(o),this.deactivateOpenContourEdit(i)}function o_(i){this.completeOpenContourEdit(i)}function i_(i){i.activateOpenContourEdit=XS.bind(i),i.deactivateOpenContourEdit=YS.bind(i),i.mouseDragOpenContourEditCallback=qS.bind(i),i.mouseUpOpenContourEditCallback=e_.bind(i),i.fuseEditPointsWithOpenContour=QS.bind(i),i.finishEditOpenOnSecondCrossing=t_.bind(i),i.checkIfShouldOverwriteAnEnd=ZS.bind(i),i.fuseEditPointsForOpenContourEndEdit=JS.bind(i),i.openContourEditOverwriteEnd=KS.bind(i),i.cancelOpenContourEdit=o_.bind(i),i.completeOpenContourEdit=n_.bind(i)}const{getSubPixelSpacingAndXYDirections:a_}=Po;function s_(i,t,n,e){this.isDrawing=!0;const o=i.detail,{element:a}=o,s=y(a),{viewport:r}=s,{spacing:c,xDir:l,yDir:d}=a_(r,this.configuration.subPixelResolution),u=t.data.contour.polyline.map(r.worldToCanvas);t.data.handles.activeHandleIndex===0&&u.reverse();let g=!1;e?.worldPosition&&(g=!0),this.drawData={canvasPoints:u,polylineIndex:u.length-1},this.commonData={annotation:t,viewportIdsToRender:n,spacing:c,xDir:l,yDir:d,movingTextBox:g},U.isInteractingWithTool=!0,a.addEventListener(w.MOUSE_UP,this.mouseUpDrawCallback),a.addEventListener(w.MOUSE_DRAG,this.mouseDragDrawCallback),a.addEventListener(w.MOUSE_CLICK,this.mouseUpDrawCallback),a.addEventListener(w.TOUCH_END,this.mouseUpDrawCallback),a.addEventListener(w.TOUCH_DRAG,this.mouseDragDrawCallback),a.addEventListener(w.TOUCH_TAP,this.mouseUpDrawCallback),nt(a)}function r_(i){i.activateOpenContourEndEdit=s_.bind(i)}function km(i){return(i.childAnnotationUIDs??[]).map(n=>xt(n).data.contour.polyline)}function cs(i,t){const n=km(i),e=[];return n.forEach(o=>{const a=o.length,s=new Array(a);for(let r=0;r<a;r++)s[r]=t.worldToCanvas(o[r]);e.push(s)}),e}const{pointsAreWithinCloseContourProximity:c_}=Po;function l_(i,t){const n={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:i.viewport.id,annotationUID:t.annotationUID},{lineWidth:e,lineDash:o,color:a,fillColor:s,fillOpacity:r}=this.getAnnotationStyle({annotation:t,styleSpecifier:n}),{closed:c}=t.data.contour;return{color:a,width:e,lineDash:o,fillColor:s,fillOpacity:r,closePath:c}}function d_(i,t,n){i?.viewport?.getImageData()&&(n.data.contour.closed?this.renderClosedContour(i,t,n):n.data.isOpenUShapeContour?(u_(i,n),this.renderOpenUShapedContour(i,t,n)):this.renderOpenContour(i,t,n))}function u_(i,t){t.data.openUShapeContourVectorToPeak||(t.data.openUShapeContourVectorToPeak=gS(i,t))}function h_(i,t,n){if(n.parentAnnotationUID)return;const{viewport:e}=i,o=this._getRenderingOptions(i,n),a=n.data.contour.polyline.map(l=>e.worldToCanvas(l)),s=cs(n,e),r=[a,...s];Jn(t,n.annotationUID,"1",r,o)}function g_(i,t,n){const{viewport:e}=i,o=this._getRenderingOptions(i,n),a=n.data.contour.polyline.map(c=>e.worldToCanvas(c));dn(t,n.annotationUID,"1",a,o);const r=n.data.handles.activeHandleIndex;if(this.configuration.alwaysRenderOpenContourHandles?.enabled===!0){const c=this.configuration.alwaysRenderOpenContourHandles.radius,l="0",d=[a[0],a[a.length-1]];r===0?d.shift():r===1&&d.pop(),$t(t,n.annotationUID,l,d,{color:o.color,handleRadius:c})}if(r!==null){const l=r===0?0:a.length-1,d=a[l];$t(t,n.annotationUID,"1",[d],{color:o.color})}}function f_(i,t,n){const{viewport:e}=i,{openUShapeContourVectorToPeak:o}=n.data,{polyline:a}=n.data.contour;if(this.renderOpenContour(i,t,n),!o)return;const s=e.worldToCanvas(a[0]),r=e.worldToCanvas(a[a.length-1]),c=[e.worldToCanvas(o[0]),e.worldToCanvas(o[1])],l=this._getRenderingOptions(i,n);dn(t,n.annotationUID,"first-to-last",[s,r],{color:l.color,width:l.width,closePath:!1,lineDash:"2,2"}),dn(t,n.annotationUID,"midpoint-to-open-contour",[c[0],c[1]],{color:l.color,width:l.width,closePath:!1,lineDash:"2,2"})}function m_(i,t,n){const e=this._getRenderingOptions(i,n),{allowOpenContours:o}=this.configuration,{canvasPoints:a}=this.drawData;if(e.closePath=!1,dn(t,n.annotationUID,"1",a,e),o){const s=a[0],r=a[a.length-1];c_(s,r,this.configuration.closeContourProximity)?dn(t,n.annotationUID,"2",[r,s],e):$t(t,n.annotationUID,"0",[s],{color:e.color,handleRadius:2})}}function p_(i,t,n){const{viewport:e}=i,{fusedCanvasPoints:o}=this.editData;if(o===void 0){this.renderClosedContour(i,t,n);return}const a=cs(n,e),s=[o,...a],r=this._getRenderingOptions(i,n),c="preview-1";n.parentAnnotationUID&&r.fillOpacity&&(r.fillOpacity=0),Jn(t,n.annotationUID,c,s,r)}function v_(i,t,n){const{fusedCanvasPoints:e}=this.editData;if(e===void 0){this.renderOpenContour(i,t,n);return}const o=this._getRenderingOptions(i,n);dn(t,n.annotationUID,"preview-1",e,o)}function I_(i,t,n){if(n.parentAnnotationUID)return;const{viewport:e}=i,o=this._getRenderingOptions(i,n),a=n.data.contour.polyline.map(f=>e.worldToCanvas(f)),s=cs(n,e),r="1",c=a[0],l=6,d=100,u=[];for(let f=0;f<d;f++){const m=f/d*2*Math.PI,v=c[0]+l*Math.cos(m),p=c[1]+l*Math.sin(m);u.push([v,p])}const h=[[c[0]-l*2,c[1]],[c[0]+l*2,c[1]],[c[0],c[1]-l*2],[c[0],c[1]+l*2]];Jn(t,n.annotationUID,r+"-crosshair_v",[h[0],h[1]],o),Jn(t,n.annotationUID,r+"-crosshair_h",[h[2],h[3]],o);const g=[u,...s];Jn(t,n.annotationUID,r,g,o)}function w_(i){i.renderContour=d_.bind(i),i.renderClosedContour=h_.bind(i),i.renderOpenContour=g_.bind(i),i.renderPointContourWithMarker=I_.bind(i),i.renderOpenUShapedContour=f_.bind(i),i.renderContourBeingDrawn=m_.bind(i),i.renderClosedContourBeingEdited=p_.bind(i),i.renderOpenContourBeingEdited=v_.bind(i),i._getRenderingOptions=l_.bind(i)}function qe(i){const t=C_(i),n=(t.top[1]+t.bottom[1])/2;return[t.right[0],n]}function C_(i){const t=[i[0],i[1]].sort(s),n=[i[0],i[1]].sort(r),e=t[t.length-1],o=n[0],a=n[n.length-1];return{top:o,bottom:a,right:e};function s(c,l){return c[0]<l[0]?-1:1}function r(c,l){return c[1]<l[1]?-1:1}}const E_=Object.freeze(Object.defineProperty({__proto__:null,getTextBoxCoordsCanvas:qe},Symbol.toStringTag,{value:"Module"}));function io(i,t){if(i instanceof ve){const n=To(t),e=X.getVolume(n);return!!e?.scaling&&Object.keys(e.scaling).length>0}else if(i instanceof Ie){const{preScale:n}=i.getImageData()||{};return!!n?.scaled}else return!1}const{DefaultHistoryMemo:hi}=Dg,Ca=class Ca{constructor(t,n){this.isPrimary=!1;const e=Ca.mergeDefaultProps(Ca.defaults,n),o=Be(e,t),{configuration:a={},supportedInteractionTypes:s,toolGroupId:r}=o;this.toolGroupId=r,this.supportedInteractionTypes=s||[],this.configuration=Object.assign({},a),this.mode=Ot.Disabled}static mergeDefaultProps(t={},n){return n?Be(t,n):t}get toolName(){return this.getToolName()}getToolName(){return this.constructor.toolName}applyActiveStrategy(t,n){const{strategies:e,activeStrategy:o}=this.configuration;return e[o]?.call(this,t,n)}applyActiveStrategyCallback(t,n,e,...o){const{strategies:a,activeStrategy:s}=this.configuration;if(!a[s])throw new Error(`applyActiveStrategyCallback: active strategy ${s} not found, check tool configuration or spellings`);return a[s][e]?.call(this,t,n,...o)}setConfiguration(t){this.configuration=Be(this.configuration,t)}setActiveStrategy(t){this.setConfiguration({activeStrategy:t})}getTargetImageData(t){if(t.startsWith("imageId:")){const n=t.split("imageId:")[1],e=Je(n);let o=Wc(e);return!o||!o.length||(o=o.filter(a=>a.getCurrentImageId()===n),!o||!o.length)?void 0:o[0].getImageData()}else if(t.startsWith("volumeId:")){const n=To(t),e=Ml(n);return!e||!e.length?void 0:e[0].getImageData()}else if(t.startsWith("videoId:")){const n=Je(t),e=Wc(n);return!e||!e.length?void 0:e[0].getImageData()}else throw new Error('getTargetIdImage: targetId must start with "imageId:" or "volumeId:"')}getTargetId(t){const n=t.getViewReferenceId?.();if(n)return n;throw new Error("getTargetId: viewport must have a getViewReferenceId method")}undo(){this.doneEditMemo(),hi.undo()}redo(){hi.redo()}static createZoomPanMemo(t){const n={pan:t.getPan(),zoom:t.getZoom()},e={restoreMemo:()=>{const o=t.getPan(),a=t.getZoom();t.setZoom(n.zoom),t.setPan(n.pan),t.render(),n.pan=o,n.zoom=a}};return hi.push(e),e}doneEditMemo(){this.memo?.commitMemo?.()&&hi.push(this.memo),this.memo=null}static startGroupRecording(){hi.startGroupRecording()}static endGroupRecording(){hi.endGroupRecording()}static calculateLengthInIndex(t,n,e=!1){const o=t?.scale||1,a=t?.scaleY||o,s=t?.scaleZ||o;let r=0;const c=n.length,l=e?0:1;let d=e?n[c-1]:n[0];for(let u=l;u<c;u++){const h=n[u],g=(h[0]-d[0])/o,f=(h[1]-d[1])/a,m=(h[2]-d[2])/s;r+=Math.sqrt(g*g+f*f+m*m),d=h}return r}static isInsideVolume(t,n){const{length:e}=n;for(let o=0;o<e;o++)if(!we(n[o],t))return!1;return!0}};Ca.defaults={configuration:{strategies:{},defaultStrategy:void 0,activeStrategy:void 0,strategyOptions:{}}};let de=Ca;de.toolName="BaseTool";function Vm(i){if(i){if(i.data&&i.highlighted)return vn.Highlighted;if(es(i.annotationUID))return vn.Selected;if(se(i.annotationUID))return vn.Locked;if(i.data&&i.autoGenerated)return vn.AutoGenerated}return vn.Default}function S_(i,t,n){const e=Ve("textBoxFontSize",i,t,n),o=Ve("textBoxFontFamily",i,t,n);return`${e}px ${o}`}const __=Object.freeze(Object.defineProperty({__proto__:null,getFont:S_,getState:Vm,style:Nl},Symbol.toStringTag,{value:"Module"}));class ao extends de{constructor(){super(...arguments),this.onImageSpacingCalibrated=t=>{const{element:n,imageId:e}=t.detail,o=Je(e),a=Dn();a.getFramesOfReference().forEach(r=>{const l=a.getAnnotations(r)[this.getToolName()];!l||!l.length||(l.forEach(d=>{if(!d.metadata?.referencedImageId)return;Je(d.metadata.referencedImageId)===o&&(d.invalidated=!0,d.data.cachedStats={})}),$i(n))})}}filterInteractableAnnotationsForElement(t,n){if(!n?.length)return[];const e=y(t),{viewport:o}=e;return ss(o,n)}static createAnnotation(...t){let n={annotationUID:null,highlighted:!0,invalidated:!0,isLocked:!1,isVisible:!0,metadata:{toolName:this.toolName},data:{handles:{points:new Array,activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},cachedStats:{},label:""}};for(const e of t)n=Be(n,e);return n}createAnnotation(t,n,...e){const o=t.detail,{currentPoints:a,element:s}=o,{world:r}=a,c=y(s),{viewport:l}=c,d=l.getCamera(),{viewPlaneNormal:u,viewUp:h,position:g}=d,f=this.getReferencedImageId(l,r,u,h),m=l.getViewReference({points:[r]});return ao.createAnnotation({metadata:{toolName:this.getToolName(),...m,referencedImageId:f,viewUp:h,cameraPosition:g},data:{handles:{points:n||[]}}},...e)}getReferencedImageId(t,n,e,o){const a=this.getTargetId(t);let s=a.split(/^[a-zA-Z]+:/)[1];if(t instanceof ve){const r=To(a),c=X.getVolume(r);s=qa(c,n,e)}return s}getStyle(t,n,e){return Ve(t,n,Vm(e),this.mode)}}ao.toolName="AnnotationDisplayTool";const{DefaultHistoryMemo:vc}=Dg,{PointsManager:D_}=Rt;class zt extends ao{static createAnnotationForViewport(t,...n){return this.createAnnotation({metadata:t.getViewReference()},...n)}static createAndAddAnnotation(t,...n){const e=this.createAnnotationForViewport(t,...n);mt(e,t.element),It(e,t.element)}constructor(t,n){super(t,n),this.mouseMoveCallback=(e,o)=>{if(!o)return!1;const{element:a,currentPoints:s}=e.detail,r=s.canvas;let c=!1;for(const l of o){if(se(l.annotationUID)||!re(l.annotationUID))continue;const{data:d}=l,u=d.handles?d.handles.activeHandleIndex:void 0,h=this._imagePointNearToolOrHandle(a,l,r,6),g=h&&!l.highlighted,f=!h&&l.highlighted;g||f?(l.highlighted=!l.highlighted,c=!0):d.handles&&d.handles.activeHandleIndex!==u&&(c=!0)}return c},this.isSuvScaled=zt.isSuvScaled,t.configuration?.getTextLines&&(this.configuration.getTextLines=t.configuration.getTextLines),t.configuration?.statsCalculator&&(this.configuration.statsCalculator=t.configuration.statsCalculator)}getHandleNearImagePoint(t,n,e,o){const a=y(t),{viewport:s}=a,{data:r}=n,{isCanvasAnnotation:c}=r,{points:l,textBox:d}=r.handles;if(d){const{worldBoundingBox:u}=d;if(u){const h={topLeft:s.worldToCanvas(u.topLeft),topRight:s.worldToCanvas(u.topRight),bottomLeft:s.worldToCanvas(u.bottomLeft),bottomRight:s.worldToCanvas(u.bottomRight)};if(e[0]>=h.topLeft[0]&&e[0]<=h.bottomRight[0]&&e[1]>=h.topLeft[1]&&e[1]<=h.bottomRight[1])return r.handles.activeHandleIndex=null,d}}for(let u=0;u<l?.length;u++){const h=l[u],g=c?h.slice(0,2):s.worldToCanvas(h);if(jt(e,g)<o===!0)return r.handles.activeHandleIndex=u,h}r.handles.activeHandleIndex=null}getLinkedTextBoxStyle(t,n){return{visibility:this.getStyle("textBoxVisibility",t,n),fontFamily:this.getStyle("textBoxFontFamily",t,n),fontSize:this.getStyle("textBoxFontSize",t,n),color:this.getStyle("textBoxColor",t,n),shadow:this.getStyle("textBoxShadow",t,n),background:this.getStyle("textBoxBackground",t,n),lineWidth:this.getStyle("textBoxLinkLineWidth",t,n),lineDash:this.getStyle("textBoxLinkLineDash",t,n),textBoxBorderRadius:this.getStyle("textBoxBorderRadius",t,n),textBoxMargin:this.getStyle("textBoxMargin",t,n),textBoxLinkLineColor:this.getStyle("textBoxLinkLineColor",t,n)}}static isSuvScaled(t,n,e){if(t instanceof ve){const a=To(n);return X.getVolume(a)?.scaling?.PT!==void 0}return typeof(e&&ye("scalingModule",e))?.suvbw=="number"}getAnnotationStyle(t){const{annotation:n,styleSpecifier:e}=t,o=m=>this.getStyle(m,e,n),{annotationUID:a}=n,s=re(a),r=se(a),c=o("lineWidth"),l=o("lineDash"),d=o("angleArcLineDash"),u=o("color"),h=o("markerSize"),g=o("shadow"),f=this.getLinkedTextBoxStyle(e,n);return{visibility:s,locked:r,color:u,lineWidth:c,lineDash:l,lineOpacity:1,fillColor:u,fillOpacity:0,shadow:g,textbox:f,markerSize:h,angleArcLineDash:d}}_imagePointNearToolOrHandle(t,n,e,o){if(this.getHandleNearImagePoint(t,n,e,o)||this.isPointNearTool(t,n,e,o,"mouse"))return!0}static createAnnotationState(t,n){const{data:e,annotationUID:o}=t,a={...e,cachedStats:{}};delete a.contour,delete a.spline;const s={annotationUID:o,data:structuredClone(a),deleting:n},r=e.contour;return r&&(s.data.contour={...r,polyline:null,pointsManager:D_.create3(r.polyline.length,r.polyline)}),s}static createAnnotationMemo(t,n,e){if(!n)return;const{newAnnotation:o,deleting:a=o?!1:void 0}=e||{},{annotationUID:s}=n,r=zt.createAnnotationState(n,a),c={restoreMemo:()=>{const l=zt.createAnnotationState(n,a),{viewport:d}=y(t)||{};if(d?.setViewReference(n.metadata),r.deleting===!0){if(r.deleting=!1,Object.assign(n.data,r.data),n.data.contour){const h=n.data;h.contour.polyline=r.data.contour.pointsManager.points,delete r.data.contour.pointsManager,h.segmentation&&Qn(n)}r.data=l.data,mt(n,t),cn(n.annotationUID,!0),d?.render();return}if(r.deleting===!1){r.deleting=!0,r.data=l.data,cn(n.annotationUID),ft(n.annotationUID),d?.render();return}const u=xt(s);if(!u){console.warn("No current annotation");return}Object.assign(u.data,r.data),u.data.contour&&(u.data.contour.polyline=r.data.contour.pointsManager.points),r.data=l.data,u.invalidated=!0,It(u,t,lt.History)},id:s,operationType:"annotation"};return vc.push(c),c}createMemo(t,n,e){this.memo||=zt.createAnnotationMemo(t,n,e)}startGroupRecording(){vc.startGroupRecording()}endGroupRecording(){vc.endGroupRecording()}static hydrateBase(t,n,e,o={}){if(!n)return null;const{viewport:a}=n,s=a.getFrameOfReferenceUID(),r=a.getCamera(),c=o.viewplaneNormal??r.viewPlaneNormal,l=o.viewUp??r.viewUp,d=o.toolInstance||new t;let u,h=c,g=l;if(o.referencedImageId)u=o.referencedImageId,h=void 0,g=void 0;else if(a instanceof Ie){const f=bg(e[0],a);f!==void 0&&(u=a.getImageIds()[f])}else if(a instanceof ve)u=d.getReferencedImageId(a,e[0],c,l);else throw new Error("Unsupported viewport type");return{FrameOfReferenceUID:s,referencedImageId:u,viewPlaneNormal:h,viewUp:g,instance:d,viewport:a}}}zt.toolName="AnnotationTool";class b_ extends zt{constructor(t,n){super(t,n)}static getContourSequence(t,n){const{data:e}=t,o=[];for(const r of e.contour.polyline)for(const c of r)o.push(c.toFixed(2));const{referencedImageId:a}=t.metadata,s=n.get("ImageSopInstanceReference",a);return{NumberOfContourPoints:o.length/3,ContourImageSequence:s,ContourGeometricType:"CLOSED_PLANAR",ContourData:o}}renderAnnotation(t,n){let e=!1;const{viewport:o}=t,{element:a}=o;if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),e;let s=Ct(this.getToolName(),a);if(!s?.length||(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length))return e;const r=this.getTargetId(o),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:t.viewport.id};for(let l=0;l<s.length;l++){const d=s[l];c.annotationUID=d.annotationUID;const u=this.getAnnotationStyle({annotation:d,styleSpecifier:c});if(!u.visibility)continue;const h=this.renderAnnotationInstance({enabledElement:t,targetId:r,annotation:d,annotationStyle:u,svgDrawingHelper:n});e||=h,d.invalidated=!1}return e}createAnnotation(t){const n=super.createAnnotation(t);return Object.assign(n.data,{contour:{polyline:[],closed:!1}}),Object.assign(n,{interpolationUID:"",autoGenerated:!1}),n}addAnnotation(t,n){return mt(t,n)}cancelAnnotation(t){}moveAnnotation(t,n){const{points:e}=t.data.handles;for(let o=0,a=e.length;o<a;o++){const s=e[o];s[0]+=n[0],s[1]+=n[1],s[2]+=n[2]}t.invalidated=!0,Ja(t).forEach(o=>this.moveAnnotation(o,n))}updateContourPolyline(t,n,e,o){const a=this.configuration?.decimate||{};bn(t,n,e,{decimate:{enabled:!!a.enabled,epsilon:a.epsilon},updateWindingDirection:o?.updateWindingDirection})}getPolylinePoints(t){return t.data.contour?.polyline??t.data.polyline}renderAnnotationInstance(t){const{enabledElement:n,annotationStyle:e,svgDrawingHelper:o}=t,a=t.annotation;if(a.parentAnnotationUID)return;const{annotationUID:s}=a,{viewport:r}=n,{worldToCanvas:c}=r,l=this.getPolylinePoints(a).map(p=>c(p)),{lineWidth:d,lineDash:u,color:h,fillColor:g,fillOpacity:f}=e,m=cs(a,r),v=[l,...m];return Jn(o,s,"contourPolyline",v,{color:h,lineDash:u,lineWidth:Math.max(.1,d),fillColor:g,fillOpacity:f}),!0}}class T_{constructor(){this.annotationUIDs=new Set,this._isVisible=!0,this.visibleFilter=this.unboundVisibleFilter.bind(this)}unboundVisibleFilter(t){return!this._isVisible||!this.annotationUIDs.has(t)}has(t){return this.annotationUIDs.has(t)}setVisible(t=!0,n,e){this._isVisible!==t&&(this._isVisible=t,this.annotationUIDs.forEach(o=>{const a=xt(o);if(!a){this.annotationUIDs.delete(o);return}if(a.isVisible===t||!t&&e?.(o)===!1)return;a.isVisible=t;const s={...n,annotation:a};gt(z,w.ANNOTATION_MODIFIED,s)}))}get isVisible(){return this._isVisible}findNearby(t,n){const e=[...this.annotationUIDs];if(e.length===0)return null;if(!t)return e[n===1?0:e.length-1];const o=e.indexOf(t);return o===-1||o+n<0||o+n>=e.length?null:e[o+n]}add(...t){t.forEach(n=>this.annotationUIDs.add(n))}remove(...t){t.forEach(n=>this.annotationUIDs.delete(n))}clear(){this.annotationUIDs.clear()}}const En={...Tw,...Sw,resetAnnotationManager:e1},j2=Object.freeze(Object.defineProperty({__proto__:null,AnnotationGroup:T_,FrameOfReferenceSpecificAnnotationManager:Ff,config:__,locking:HC,selection:YC,state:En,visibility:QC},Symbol.toStringTag,{value:"Module"})),lh="PlanarFreehandContourSegmentationTool";function Td(i,t=[]){const{viewport:n,sliceData:e,annotation:o}=i,a=new Map,{toolName:s,originalToolName:r}=o.metadata,c=r||s,l=(Ct(c,n.element)||[]).filter(d=>!d.metadata.originalToolName||d.metadata.originalToolName===c);if(c!==lh){const d=Ct(lh,n.element);d?.length&&d.forEach(u=>{const{metadata:h}=u;h.originalToolName===c&&h.originalToolName!==h.toolName&&l.push(u)})}if(!l?.length)return a;for(let d=0;d<e.numberOfSlices;d++){const u=l.filter(g=>g.metadata.sliceIndex===d);if(!u?.length)continue;const h=u.filter(g=>t.every(f=>{const v=(f.parentKey?f.parentKey(g):g)?.[f.key];return Array.isArray(v)?v.every((p,I)=>p===f.value[I]):v===f.value}));h.length&&a.set(d,h)}return a}function P_(i,t){const n=Td(i,t),e=[];if(!n?.size)return e;for(const o of n.values())o.forEach(a=>{e.push(a)});return e}function Fm(i,t,n){const e=Be({data:{},metadata:{}},n);return Object.assign(e,{highlighted:!1,invalidated:!0,autoGenerated:!0,annotationUID:void 0,cachedStats:{},childAnnotationUIDs:[],parentAnnotationUID:void 0}),Object.assign(e.data,{handles:{points:t.points||t||[],interpolationSources:t.sources,activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},contour:{...n.data.contour,polyline:i}}),e}function M_(i,t){const n=Td(t,[{key:"interpolationUID",value:t.interpolationUID}]),e=x_(n);if(!e){console.warn("No annotations found to interpolate",n);return}const o=y_(n,i.annotationUID),a=[];for(let s=e[0]+1;s<e[1];s++)if(A_(n,s)){const r=L_(s,e,n);(r?.[0]===o||r?.[1]===o)&&O_(r,a,s)}return{interpolationData:n,interpolationList:a}}function x_(i){let t=1/0,n=-1/0,e=!1;for(const[o,a]of i.entries())a.length&&(t=Math.min(o,t),n=Math.max(o,n),e=!0);if(e)return[t,n]}function y_(i,t){for(const[n,e]of i)for(let o=0;o<e.length;o++)if(e[o].annotationUID===t)return n}function A_(i,t){const n=i.get(t);return!n?.length||n.length===1&&n[0].autoGenerated}function O_(i,t,n){const[e]=i;t[e]||={pair:i,list:[]},t[e].list.push(n)}function L_(i,t,n){const e=[];let o=!0;for(let a=i-1;a>=t[0];a--){const s=n.get(a);if(s?.length){if(s[0].autoGenerated)continue;s.length>1&&(o=!1),e.push(a);break}}if(!(!o||!e.length)){for(let a=i+1;a<=t[1];a++){const s=n.get(a);if(s?.length){if(s[0].autoGenerated)continue;s.length>1&&(o=!1),e.push(a);break}}if(!(!o||e.length<2))return e}}const{PointsManager:dh}=Rt;function R_(i,t=12){const n=dh.create3(t);n.sources=[];const{sources:e}=n,{length:o,sources:a=[]}=i,s=5;if(o<s*3)return i.subselect(t);const r=Math.floor(Math.max(2*o/t,s*2));a.forEach(()=>e.push(dh.create3(t)));const c=N_(i,s),l=U_(c,t),d=[];if(l?.length>2){let u=-1;const h=r/3;l.forEach(m=>{const[v,,p]=m,I=Math.ceil((v+p)/2);p-u<h||(I-v>2*h?(gi(d,u,v,r,o),u=gi(d,v,I,r,o)):u=gi(d,u,I,r,o),p-u>h&&(u=gi(d,u,p,r,o)))});const g=d[0];nl(g+o-u,o)>2*h&&gi(d,u,g-h,r,o)}else{const u=Math.floor(o/t);gi(d,-1,o-u,u,o)}return d.forEach(u=>{const h=i.getPointArray(u);n.push(h),a.forEach((g,f)=>e[f].push(g.getPoint(u)))}),n}function N_(i,t=6){const{length:n}=i,e=W(),o=W(),a=new Float32Array(n);for(let s=0;s<n;s++){const r=i.getPoint(s),c=i.getPoint(s-t),l=i.getPoint((s+t)%n);me(e,r,c),me(o,l,r);const d=dt(e,o)/(ks(e)*ks(o));a[s]=d}return a}function U_(i,t){const{max:n,deviation:e}=k_(i),{length:o}=i;if(e<.01||o<t*3)return[];const a=[];let s=null,r,c=0;for(let l=0;l<o;l++){const d=i[l];d<n-e?s?(s[2]=l,d<r&&(r=d,c=l),s[1]=c):(r=d,c=l,s=[l,l,l]):s&&(a.push(s),s=null)}return s&&(a[0][0]===0?a[0][0]=s[0]:(s[1]=c,s[2]=o-1,a.push(s))),a}function gi(i,t,n,e,o){n<t&&(n+=o);const a=n-t,s=Math.ceil(a/e);if(s<=0)return i[i.length-1]!==n&&i.push(nl(n,o)),n;for(let r=1;r<=s;r++){const c=nl(t+r*a/s,o);i.push(c)}return i[i.length-1]}function nl(i,t){return(Math.round(i)+t)%t}function k_(i){const{length:t}=i;let n=0,e=1/0,o=-1/0,a=0;for(let r=0;r<t;r++){const c=i[r];n+=c,e=Math.min(e,c),o=Math.max(o,c)}const s=n/t;for(let r=0;r<t;r++){const c=i[r]-s;a+=c*c}return{mean:s,max:o,min:e,sumSq:a,deviation:Math.sqrt(a/t)}}function V_(i){const{parentAnnotationUID:t,annotationUID:n}=i;if(!t)return i.interpolationUID;const e=En.getAnnotation(t),{interpolationUID:o}=e,a=e.childAnnotationUIDs.indexOf(n);return i.interpolationUID=`${o}-${a}`,i.interpolationUID}const{PointsManager:ra}=Rt,uh=.2;function Ns(i){if(!i.annotation)return;const{isInterpolationUpdate:t,annotation:n}=i;queueMicrotask(()=>{try{t&&(n.isInterpolationUpdate=!0,n.autoGenerated=!1),F_(i)}finally{t&&(n.autoGenerated=!0)}})}function F_(i){const{annotation:t}=i;V_(t);const{interpolationData:n,interpolationList:e}=M_(t,i)||{};if(!n||!e)return;const o={toolName:t.metadata.toolName,toolType:t.metadata.toolName,viewport:i.viewport};for(let l=0;l<e.length;l++)e[l]&&B_(e[l].list,e[l].pair,n,o);const{id:a,renderingEngineId:s,element:r}=i.viewport,c={annotation:t,element:r,viewportId:a,renderingEngineId:s};e.length&&(gt(i.viewport.element,w.ANNOTATION_INTERPOLATION_PROCESS_COMPLETED,c),gt(z,w.ANNOTATION_INTERPOLATION_PROCESS_COMPLETED,c))}function B_(i,t,n,e){const o=n.get(t[0])[0],a=n.get(t[1])[0],s=Ih(o.data.contour.polyline),r=Ih(a.data.contour.polyline),{c1Interp:c,c2Interp:l}=z_(s,r);c.kIndex=t[0],l.kIndex=t[1],i.forEach(function(d){G_(c,l,d,t,n,s.x.length>r.x.length,e)})}function G_(i,t,n,e,o,a,s){const[r,c]=e,l=(n-r)/(c-r),d=o.get(r)[0],u=o.get(c)[0],h=H_(i,t,l,a),g=l>.5?u:d,f=R_(h);o.has(n)?$_(h,f,n,g,s):W_(h,f,n,g,s)}function W_(i,t,n,e,o){const a=i.points,{viewport:s}=o,r=Fm(a,t,e),c=s.getViewReference({sliceIndex:n});if(!c)throw new Error(`Can't find slice ${n}`);Object.assign(r.metadata,c),En.addAnnotation(r,s.element),e.onInterpolationComplete?.(r,e);const{parentAnnotationUID:l}=e;if(l){const d=En.getAnnotation(l),u=Bm(d,n,o);Rr(s,u,r)}}function Bm(i,t,n){const{viewport:e}=n,o=En.getAnnotations(i.metadata.toolName,e.element);for(let a=0;a<o.length;a++){const s=o[a];if(s.interpolationUID===i.interpolationUID&&s.metadata.sliceIndex===t)return s}}function $_(i,t,n,e,o){const a=Bm(e,n,o),s=i.points,r=Fm(s,t,a);Object.assign(a,{metadata:r.metadata,data:r.data})}function H_(i,t,n,e){const o=e?i.I:t.I,a=ra.fromXYZ(i),s=ra.fromXYZ(t),{length:r}=a,c=ra.create3(r),l=W(),d=W(),u=ra.create3(r);u.kIndex=i.kIndex;const h=ra.create3(r);h.kIndex=t.kIndex;for(let g=0;g<i.x.length;g++)if(o[g]){const f=a.getPoint(g),m=s.getPoint(g);u.push(f),h.push(m),me(l,m,f),c.push(Wt(d,f,l,n))}return c.sources=[u,h],c}function z_(i,t){const n=vh(i),e=vh(t),o=Math.max(Math.ceil(n[n.length-1]/uh),Math.ceil(e[e.length-1]/uh)),a=ph(n),s=ph(e),r=o+t.x.length,c=o+i.x.length,l=mh(r,a),d=mh(c,s),u=fh(r-2,i.x.length),h=fh(c-2,t.x.length),g=gh(l,u),f=gh(d,h),m=hh(i,g),v=hh(t,f);return X_(m,v),j_(m,v)}function j_(i,t){const n={x:[],y:[],z:[],I:[]},e={x:[],y:[],z:[],I:[]};for(let o=0;o<i.x.length;o++)(i.I[o]||t.I[o])&&(n.x.push(i.x[o]),n.y.push(i.y[o]),n.z.push(i.z[o]),n.I.push(i.I[o]),e.x.push(t.x[o]),e.y.push(t.y[o]),e.z.push(t.z[o]),e.I.push(t.I[o]));return{c1Interp:n,c2Interp:e}}function X_(i,t){const n=i.x.length,e={startingNode:0,totalSquaredXYLengths:1/0};for(let a=0;a<n;a++){let s=a,r=0;for(let c=0;c<n;c++)r+=(i.x[s]-t.x[c])**2+(i.y[s]-t.y[c])**2+(i.z[s]-t.z[c])**2,s++,s===n&&(s=0);r<e.totalSquaredXYLengths&&(e.totalSquaredXYLengths=r,e.startingNode=a)}const o=e.startingNode;Ss(i.x,o),Ss(i.y,o),Ss(i.z,o),Ss(i.I,o)}function Ss(i,t){t-=i.length*Math.floor(t/i.length);const n=i.splice(0,t);return i.push(...n),i}function hh(i,t){const n={x:[],y:[],z:[],I:[]};for(let e=0;e<i.x.length-1;e++){n.x.push(i.x[e]),n.y.push(i.y[e]),n.z.push(i.z[e]),n.I.push(!0);const o=(i.x[e+1]-i.x[e])/(t[e]+1),a=(i.y[e+1]-i.y[e])/(t[e]+1),s=(i.z[e+1]-i.z[e])/(t[e]+1);for(let r=0;r<t[e]-1;r++)n.x.push(n.x[n.x.length-1]+o),n.y.push(n.y[n.y.length-1]+a),n.z.push(n.z[n.z.length-1]+s),n.I.push(!1)}return n}function gh(i,t){const n=[];for(let s=0;s<i.length;++s)n[s]=s;n.sort(function(s,r){return i[s]<i[r]?-1:1});const e=[];for(let s=0;s<t.length;s++)e.push(t[n[s]]);const o=e.reduce(function(s,r,c){return r&&s.push(c),s},[]),a=[];for(let s=0;s<o.length-1;s++)a.push(o[s+1]-o[s]);return a}function fh(i,t){const n=new Array(i+t);return n.fill(!1,0,i),n.fill(!0,i,i+t),n}function mh(i,t){const n=1/(i-1),e=[n];for(let o=1;o<i-2;o++)e.push(e[e.length-1]+n);return e.concat(t)}function ph(i){const t=[];for(let n=0;n<i.length;n++)t.push(i[n]/i[i.length-1]);return t}function vh(i){const t=[0];for(let n=1;n<i.x.length;n++){const e=Math.sqrt((i.x[n]-i.x[n-1])**2+(i.y[n]-i.y[n-1])**2+(i.z[n]-i.z[n-1])**2);t.push(t[n-1]+e)}return t}function Ih(i){const t={x:[],y:[],z:[]};for(let n=0;n<i.length;n++)t.x[n]=i[n][0],t.y[n]=i[n][1],t.z[n]=i[n][2];return t.x.push(t.x[0]),t.y.push(t.y[0]),t.z.push(t.z[0]),t}function wh(i){const{annotation:t}=i,n=Td(i,[{key:"interpolationUID",value:i.interpolationUID}]),e=t.metadata.sliceIndex;let o=-1,a=i.sliceData.numberOfSlices;for(const[r,c]of n.entries())r===e||!c.find(d=>!d.autoGenerated)||(r<e?o=Math.max(r,o):a=Math.min(r,a));const s=[];for(const[r,c]of n.entries())r<=o||r>=a||r===e||c.forEach(l=>{l.autoGenerated&&(En.removeAnnotation(l.annotationUID),s.push(l))});if(s.length){const r={annotations:s,element:i.viewport.element,viewportId:i.viewport.id,renderingEngineId:i.viewport.getRenderingEngine().id};gt(i.viewport.element,w.INTERPOLATED_ANNOTATIONS_REMOVED,r)}if(o>=0&&a<i.sliceData.numberOfSlices){const r=n.get(a)[0],c={viewport:i.viewport,sliceData:{numberOfSlices:i.sliceData.numberOfSlices,imageIndex:r.metadata.sliceIndex},annotation:r,interpolationUID:r.interpolationUID};Ns(c)}}function Us(i){const t=pd(i);return t?.length?t.find(e=>e.getImageIds().some(o=>o===i.metadata.referencedImageId))??t[0]:void 0}const{uuidv4:Y_}=Rt,q_=[lt.HandlesUpdated,lt.InterpolationUpdated],an=class an{static addTool(t){this.toolNames.includes(t)||this.toolNames.push(t)}static removeTool(t){this.toolNames.includes(t)&&(this.toolNames=this.toolNames.filter(n=>n!==t))}static acceptAutoGenerated(t,n={}){const{toolNames:e,segmentationId:o,segmentIndex:a,sliceIndex:s}=n;for(const r of e||an.toolNames){const c=En.getAnnotations(r,t);if(c?.length)for(const l of c){const{interpolationUID:d,data:u,autoGenerated:h,metadata:g}=l;d&&(l.interpolationCompleted=!0),h&&(a&&a!==u.segmentation.segmentIndex||s!==void 0&&g&&s!==g.sliceIndex||o&&o!==u.segmentation.segmentationId||(Qn(l),l.autoGenerated=!1))}}}};an.toolNames=[],an.handleAnnotationCompleted=t=>{const n=t.detail.annotation;if(!n?.metadata)return;const{toolName:e,originalToolName:o}=n.metadata;if(!an.toolNames.includes(e)&&!an.toolNames.includes(o))return;const a=Us(n);if(!a){console.warn("Unable to find viewport for",n);return}const s=Ic(a),r={viewport:a,sliceData:s,annotation:n,interpolationUID:n.interpolationUID},c=!!n.interpolationUID;if(n.autoGenerated=!1,c){wh(r),Ns(r);return}const l=[{key:"segmentIndex",value:n.data.segmentation.segmentIndex,parentKey:g=>g.data.segmentation},{key:"viewPlaneNormal",value:n.metadata.viewPlaneNormal,parentKey:g=>g.metadata},{key:"viewUp",value:n.metadata.viewUp,parentKey:g=>g.metadata}];let d=P_(r,l);const{sliceIndex:u}=n.metadata,h=new Set;d.forEach(g=>{if(g.interpolationCompleted||g.metadata.sliceIndex===u){const{interpolationUID:f}=g;h.add(f)}}),d=d.filter(g=>!h.has(g.interpolationUID)),n.interpolationUID=d[0]?.interpolationUID||Y_(),r.interpolationUID=n.interpolationUID,Ns(r)},an.handleAnnotationUpdate=t=>{const n=t.detail.annotation,{changeType:e=lt.HandlesUpdated}=t.detail;if(!n?.metadata)return;const{toolName:o,originalToolName:a}=n.metadata;if(!an.toolNames.includes(o)&&!an.toolNames.includes(a)||!q_.includes(e))return;const s=Us(n);if(!s){console.warn("Unable to find matching viewport for annotation interpolation",n);return}n.autoGenerated&&(Qn(n),n.autoGenerated=!1);const r=Ic(s),c={viewport:s,sliceData:r,annotation:n,interpolationUID:n.interpolationUID,isInterpolationUpdate:e===lt.InterpolationUpdated};Ns(c)},an.handleAnnotationDelete=t=>{const n=t.detail.annotation;if(!n?.metadata)return;const{toolName:e}=n.metadata;if(!an.toolNames.includes(e)||n.autoGenerated)return;const o=Us(n);if(!o){console.warn("No viewport, can't delete interpolated results",n);return}const a=Ic(o),s={viewport:o,sliceData:a,annotation:n,interpolationUID:n.interpolationUID};n.autoGenerated=!1,wh(s)};let un=an;function Ic(i){return{numberOfSlices:i.getNumberOfSlices(),imageIndex:i.getCurrentImageIdIndex()}}function Gm(i){i.forEach(t=>{const n=_e(t);if(!n){console.warn(`ToolGroup not available for ${t}`);return}n.getViewportsInfo().forEach(o=>{const{renderingEngineId:a,viewportId:s}=o,r=te(a);if(!r){console.warn(`RenderingEngine not available for ${a}`);return}const c=r.getViewport(s);$i(c.element)})})}function Wm(i,t={}){const n=i.annotationUIDsMap,e=t.segmentIndices?.length?t.segmentIndices:Array.from(n.keys()),o=new Map;return e.forEach(a=>{const s=n.get(a);let r=Array.from(s);r=r.filter(l=>!xt(l).parentAnnotationUID);const c=r.map(l=>{const d=xt(l),u=d.childAnnotationUIDs?.length,h=u&&d.childAnnotationUIDs.map(m=>{const v=xt(m);return{polyline:v.data.contour.polyline,isClosed:v.data.contour.closed}}),g=u&&h.map(m=>m.isClosed),f=u&&h.map(m=>m.polyline);return{polyline:d.data.contour.polyline,isClosed:d.data.contour.closed,annotationUID:d.annotationUID,referencedImageId:d.metadata.referencedImageId,holesPolyline:f,holesUIDs:d.childAnnotationUIDs,holesClosed:g}});o.set(a,c)}),{segmentIndices:e,annotationUIDsInSegmentMap:o}}function Ch(i,t){if(!i||i.length===0)return[];if(!t)return[...i];const n=i[0],e=i[i.length-1];return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]?[...i]:[...i,n]}function K_(i,t){const{annotationUIDsInSegmentMap:n}=Wm(i);if(!n.has(t)){console.warn(`No contour information found for segmentIndex ${t}`);return}const e=new Map,o=n.get(t);for(const a of o){e.set(a.annotationUID,Ch(a.polyline,a.isClosed));for(let s=0;s<a.holesUIDs?.length;s++)e.set(a.holesUIDs[s],Ch(a.holesPolyline[s],a.holesClosed[s]))}return e}function ls(i,t){const n=td(i),e=pt(i);if(!e||!e.representationData.Contour)return;const o=e.representationData.Contour,{annotationUIDsMap:a}=o;if(!a||!a.get(t))return;const s=K_(o,t);if(!s)return;const r=Array.from(s?.keys()),c=new Map;for(const l of r){const d=xt(l),u=nd(n,d);c.set(l,en(s.get(l),u))}return c}function Z_(i,t,n={epsilon:.1}){const e=pt(i);if(!e){console.warn(`Invalid segmentation given ${i}`);return}if(!e.representationData.Contour){console.warn(`No contour representation found for segmentation ${i}`);return}const o=td(i);if(!o){console.warn("No viewport associated to the segmentation found");return}const a=ls(i,t);if(!a){console.warn(`Error extracting contour data from segment ${t} in segmentation ${i}`);return}const s=Array.from(a?.keys());for(const r of s){const c=xt(r);if(!c)continue;const l=a.get(r),d=Or(l,n.epsilon),u=nd(o,c);u&&(c.data.contour.polyline=d.map(h=>u.canvasToWorld(h)),Vl(c))}}function Gr(i){i&&(i.parentAnnotationUID&&Bi(i),ft(i.annotationUID),Sn(i))}function J_(i,t){const{viewPlaneNormal:n}=i.metadata,{viewPlaneNormal:e}=t.metadata,o=dt(n,e);if(!xa(1,Math.abs(o)))return!1;const{polyline:s}=i.data.contour,{polyline:r}=t.data.contour,c=dt(n,s[0]),l=dt(n,r[0]);return xa(c,l)}function $m(i,t,n){let e=-1;if(t.forEach((o,a)=>{e>=0||o.a==i.b&&(e=a)}),e>=0){const o=t[e];return t.splice(e,1),n.push(o.b),n[0]==o.b?{remainingLines:t,contourPoints:n,type:"CLOSED_PLANAR"}:$m(o,t,n)}return{remainingLines:t,contourPoints:n,type:"OPEN_PLANAR"}}function Pd(i){if(i.length==0)return[];const t=[],n=i.shift();t.push(n.a),t.push(n.b);const e=$m(n,i,t);if(e.remainingLines.length==0)return[{type:e.type,contourPoints:e.contourPoints}];{const o=Pd(e.remainingLines);return o.push({type:e.type,contourPoints:e.contourPoints}),o}}function Q_(i){return Pd(i)}const tD={findContours:Pd,findContoursFromReducedSet:Q_};function eD(i,t=!1){const n=i.getPoints(),e=i.getLines(),o=new Array(n.getNumberOfPoints()).fill(0).map((c,l)=>n.getPoint(l).slice()),a=new Array(e.getNumberOfCells()).fill(0).map((c,l)=>{const d=e.getCell(l*3).slice();return{a:d[0],b:d[1]}});if(t)return{points:o,lines:a};const s=[];for(const[c,l]of o.entries()){const d=s.findIndex(u=>u[0]===l[0]&&u[1]===l[1]&&u[2]===l[2]);if(d>=0)a.map(u=>(u.a===c&&(u.a=d),u.b===c&&(u.b=d),u));else{const u=s.length;s.push(l),a.map(h=>(h.a===c&&(h.a=u),h.b===c&&(h.b=u),h))}}const r=a.filter(c=>c.a!==c.b);return{points:s,lines:r}}const nD=(i,t)=>{const n=i[0],e=i[1];let o=!1;for(let a=0,s=t.length-1;a<t.length;s=a++){const r=t[a][0],c=t[a][1],l=t[s][0],d=t[s][1];c>e!=d>e&&n<(l-r)*(e-c)/(d-c)+r&&(o=!o)}return o};function oD(i,t,n){const e=[];i.contourPoints.forEach(a=>{e.push([n[a][0],n[a][1]])});let o=0;return t.contourPoints.forEach(a=>{nD([n[a][0],n[a][1]],e)||o++}),o===0}function iD(i,t,n=!0){const e=i.filter(r=>r.type!=="CLOSED_PLANAR"),o=i.filter(r=>r.type==="CLOSED_PLANAR"),a=[];let s=[];return o.forEach((r,c)=>{const l=[];o.forEach((d,u)=>{c!=u&&oD(r,d,t)&&l.push(u)}),l.length>0?a.push({contour:r,holes:l}):s.push(c)}),n&&(a.forEach(r=>{r.contour.type="CLOSEDPLANAR_XOR",e.push(r.contour),r.holes.forEach(c=>{o[c].type="CLOSEDPLANAR_XOR",e.push(o[c]),s=s.filter(l=>l!==c)})}),s.forEach(r=>{e.push(o[r])})),e}const aD={processContourHoles:iD};function sD(i,t){return ii(t,i)}function Md(i){const t=[],n=[];i.forEach((e,o)=>{Mr(e)&&n.push({polyline:e,originalIndex:o})});for(let e=0;e<n.length;e++){const o=n[e],a=Math.abs(ln(o.polyline)),s=[];for(let r=0;r<n.length;r++){if(e===r)continue;const c=n[r];Math.abs(ln(c.polyline))<a&&sD(c.polyline,o.polyline)&&s.push(c.originalIndex)}s.length>0&&t.push({contourIndex:o.originalIndex,holeIndexes:s.sort((r,c)=>r-c)})}return t.sort((e,o)=>e.contourIndex-o.contourIndex)}let Eh=!1;function Wr(){if(Eh)return;Eh=!0;const i=()=>new Worker(new URL("/radiology-ai-viewer/assets/computeWorker-B9Af7yv4.js",import.meta.url),{name:"compute",type:"module"}),t=ti(),o={maxWorkerInstances:1,autoTerminateOnIdle:MC().computeWorker?.autoTerminateOnIdle??{enabled:!0,idleTimeThreshold:2e3}};t.registerWorker("compute",i,o)}function $r(){return Vt.getState().segmentations}function rD(i){const{segmentationId:t,representation:n,config:e}=i,{type:o,data:a}=n,s=a?{...a}:{};if(!s)throw new Error("Segmentation representation data may not be undefined");o===tt.Contour&&cD(s);const r=lD(e?.segments,o,s);return delete e?.segments,{segmentationId:t,label:e?.label??null,cachedStats:e?.cachedStats??{},segments:r,representationData:{[o]:{...s}}}}function cD(i){i.geometryIds=i.geometryIds??[],i.annotationUIDsMap=i.annotationUIDsMap??new Map}function lD(i,t,n){const e={};return i?Object.entries(i).forEach(([o,a])=>{const{label:s,locked:r,cachedStats:c,active:l,...d}=a,u={segmentIndex:Number(o),label:s??`Segment ${o}`,locked:r??!1,cachedStats:c??{},active:l??!1,...d};e[o]=u}):t===tt.Contour?dD(e,n):t===tt.Surface?uD(e,n):e[1]=hD(),e}function dD(i,t){const{geometryIds:n}=t;n?.forEach(e=>{const o=X.getGeometry(e);if(o?.data){const{segmentIndex:a}=o.data;i[a]={segmentIndex:a}}})}function uD(i,t){const{geometryIds:n}=t;n?.forEach(e=>{const o=X.getGeometry(e);if(o?.data){const{segmentIndex:a}=o.data;i[a]={segmentIndex:a}}})}function hD(){return{segmentIndex:1,label:"Segment 1",locked:!1,cachedStats:{},active:!0}}function Hm(i,t){const n=Vt;i.forEach(e=>{const o=rD(e);n.addSegmentation(o),t||gn(o.segmentationId)})}const gD={[tt.Labelmap]:Id,[tt.Contour]:vd,[tt.Surface]:ql},Pi=new Map;function xd(i,t,n){const e=gD[n].getUpdateFunction(i);e&&zm(t,n,e)}function zm(i,t,n){Pi.has(i)||Pi.set(i,new Map);const e=Pi.get(i);e.has(t)&&yd(i,t);const o=mD(i,t,n);z.addEventListener(w.SEGMENTATION_DATA_MODIFIED,o),e.set(t,o)}function yd(i,t){const n=Pi.get(i);if(!n)return;const e=n.get(t);e&&(z.removeEventListener(w.SEGMENTATION_DATA_MODIFIED,e),n.delete(t))}function fD(i){const t=Pi.get(i);if(t){for(const n of t.values())z.removeEventListener(w.SEGMENTATION_DATA_MODIFIED,n);Pi.delete(i)}}function mD(i,t,n){const e=zi(o=>{const a=o.detail?.segmentationId,s=pt(a);a===i&&s?.representationData?.[t]&&(n(i),gn(i))},300);return(o=>{e(o)})}function Xi(i,t,n){return Xm(i,t,n)}function jm(i,t,n){return Xm(i,t,n)}function Xm(i,t,n){const{segmentationId:e,type:o}=t;return pD(i,e,o,n),Vt.removeSegmentationRepresentations(i,{segmentationId:e,type:o})}function Ym(){Vt.getAllViewportSegmentationRepresentations().forEach(({viewportId:t,representations:n})=>{n.forEach(({segmentationId:e,type:o})=>{Xi(t,{segmentationId:e,type:o})})}),Vt.resetState()}function qm(i,t,n){Xi(i,{segmentationId:t,type:tt.Labelmap},n)}function Km(i,t,n){Xi(i,{segmentationId:t,type:tt.Contour},n)}function Zm(i,t,n){Xi(i,{segmentationId:t,type:tt.Surface},n)}function pD(i,t,n,e){Ye(i,{segmentationId:t,type:n}).forEach(s=>{s.type===tt.Labelmap?Id.removeRepresentation(i,s.segmentationId,e):s.type===tt.Contour?vd.removeRepresentation(i,s.segmentationId,e):s.type===tt.Surface&&ql.removeRepresentation(i,s.segmentationId,e),yd(s.segmentationId,s.type)});const{viewport:a}=At(i)||{};a&&a.render()}function Ad(i){const t=Vt;t.getAllViewportSegmentationRepresentations().filter(({representations:e})=>e.some(o=>o.segmentationId===i)).map(({viewportId:e})=>e).forEach(e=>{jm(e,{segmentationId:i})}),t.removeSegmentation(i),Hl(i)}function Jm(){const i=Vt;i.getState().segmentations.map(e=>e.segmentationId).forEach(e=>{Ad(e)}),i.resetState()}function Qm(){return Vt.getNextColorLUTIndex()}const Qs=[[0,0,0,0],[221,84,84,255],[77,228,121,255],[166,70,235,255],[189,180,116,255],[109,182,196,255],[204,101,157,255],[123,211,94,255],[93,87,218,255],[225,128,80,255],[73,232,172,255],[181,119,186,255],[176,193,112,255],[105,153,200,255],[208,97,120,255],[90,215,101,255],[135,83,222,255],[229,178,76,255],[122,183,181,255],[190,115,171,255],[149,197,108,255],[100,118,205,255],[212,108,93,255],[86,219,141,255],[183,79,226,255],[233,233,72,255],[118,167,187,255],[194,111,146,255],[116,201,104,255],[115,96,209,255],[216,147,89,255],[82,223,188,255],[230,75,224,255],[163,184,121,255],[114,143,191,255],[198,107,114,255],[99,206,122,255],[153,92,213,255],[220,192,85,255],[78,215,227,255],[234,71,173,255],[141,188,117,255],[110,113,195,255],[202,128,103,255],[95,210,157,255],[195,88,217,255],[206,224,81,255],[74,166,231,255],[185,120,139,255],[113,192,113,255],[133,106,199,255],[207,162,98,255],[91,214,198,255],[221,84,198,255],[159,228,77,255],[70,111,235,255],[189,119,116,255],[109,196,138,255],[165,101,204,255],[211,201,94,255],[87,191,218,255],[225,80,153,255],[106,232,73,255],[124,119,186,255],[193,142,112,255],[105,200,168,255],[203,97,208,255],[184,215,90,255],[83,147,222,255],[229,76,101,255],[122,183,130,255],[146,115,190,255],[197,171,108,255],[100,205,205,255],[212,93,177,255],[141,219,86,255],[79,97,226,255],[233,99,72,255],[118,187,150,255],[173,111,194,255],[197,201,104,255],[96,171,209,255],[216,89,137,255],[94,223,82,255],[107,75,230,255],[184,153,121,255],[114,191,175,255],[198,107,191,255],[166,206,99,255],[92,132,213,255],[220,85,91,255],[78,227,115,255],[159,71,234,255],[188,176,117,255],[110,185,195,255],[202,103,161,255],[129,210,95,255],[88,88,217,255],[224,123,81,255],[74,231,166,255],[177,120,185,255],[179,192,113,255],[106,156,199,255],[207,98,125,255],[91,214,96,255],[130,84,221,255],[228,171,77,255],[70,235,221,255],[189,116,174,255],[153,196,109,255],[101,123,204,255],[211,104,94,255],[87,218,136,255],[177,80,225,255],[232,225,73,255],[119,169,186,255],[193,112,149,255],[121,200,105,255],[111,97,208,255],[215,142,90,255],[83,222,181,255],[229,76,229,255],[165,183,122,255],[115,146,190,255],[197,108,119,255],[100,205,118,255],[148,93,212,255],[219,186,86,255],[79,220,226,255],[233,72,179,255],[144,187,118,255],[111,118,194,255],[201,124,104,255],[96,209,153,255],[189,89,216,255],[211,223,82,255],[75,172,230,255],[184,121,142,255],[117,191,114,255],[130,107,198,255],[206,157,99,255],[92,213,193,255],[220,85,203,255],[165,227,78,255],[71,118,234,255],[188,117,117,255],[110,195,135,255],[161,103,202,255],[210,195,95,255],[88,195,217,255],[224,81,158,255],[113,231,74,255],[123,120,185,255],[192,139,113,255],[106,199,164,255],[198,98,207,255],[188,214,91,255],[84,153,221,255],[228,77,108,255],[70,235,84,255],[143,116,189,255],[196,167,109,255],[101,204,199,255],[211,94,182,255],[147,218,87,255],[80,104,225,255],[232,93,73,255],[119,186,147,255],[170,112,193,255],[200,200,105,255],[97,175,208,255],[215,90,142,255],[100,222,83,255],[101,76,229,255],[183,150,122,255],[115,190,171,255],[197,108,194,255],[170,205,100,255],[93,138,212,255],[219,86,97,255],[79,226,110,255],[153,72,233,255],[187,173,118,255],[111,187,194,255],[201,104,165,255],[134,209,96,255],[89,95,216,255],[223,117,82,255],[75,230,159,255],[174,121,184,255],[182,191,114,255],[107,160,198,255],[206,99,130,255],[92,213,92,255],[124,85,220,255],[227,165,78,255],[71,234,214,255],[188,117,176,255],[156,195,110,255],[103,128,202,255],[210,100,95,255],[88,217,131,255],[170,81,224,255],[231,218,74,255],[120,172,185,255],[192,113,153,255],[125,199,106,255],[107,98,207,255],[214,137,91,255],[84,221,175,255],[222,77,228,255],[194,235,70,255],[116,149,189,255],[196,109,123,255],[101,204,114,255],[143,94,211,255],[218,180,87,255],[80,225,225,255],[232,73,186,255],[147,186,119,255],[112,122,193,255],[200,121,105,255],[97,208,148,255],[184,90,215,255],[216,222,83,255],[76,178,229,255],[183,122,145,255],[121,190,115,255],[126,108,197,255],[205,153,100,255],[93,212,187,255],[219,86,208,255],[171,226,79,255],[72,126,233,255],[187,118,121,255],[111,194,132,255],[157,104,201,255],[209,190,96,255],[89,200,216,255],[223,82,164,255],[120,230,75,255],[121,121,184,255],[191,136,114,255],[107,198,160,255],[192,99,206,255],[193,213,92,255],[85,158,220,255],[227,78,115,255],[71,234,78,255],[141,117,188,255],[195,163,110,255],[103,202,194,255],[210,95,186,255],[153,217,88,255],[81,111,224,255]];function pa(i,t){const n=Vt,e=t??Qm();let o=[...i];if(Pt(o[0],[0,0,0,0])||(console.warn("addColorLUT: [0, 0, 0, 0] color is not provided for the background color (segmentIndex =0), automatically adding it"),o=[[0,0,0,0],...o]),o=o.map(a=>a.length===3?[a[0],a[1],a[2],255]:a),o.length<255){const a=Qs.slice(o.length);o=[...o,...a]}return n.addColorLUT(o,e),e}function vD(i){Vt.removeColorLUT(i)}function tp(i,t){return ep(i).map(a=>(t&&a.type===t,pt(a.segmentationId))).filter(a=>a!==void 0)}function ep(i){return Vt.getState().viewportSegRepresentations[i]}function np(i,t){return Vt.updateLabelmapSegmentationImageReferences(i,t)}function ID(i,t){return Vt.getStackSegmentationImageIdsForViewport(i,t)}function wD(){Vt.resetState()}const CD=Object.freeze(Object.defineProperty({__proto__:null,addColorLUT:pa,addSegmentations:Hm,destroy:wD,getColorLUT:ts,getCurrentLabelmapImageIdForViewport:Mo,getCurrentLabelmapImageIdsForViewport:no,getNextColorLUTIndex:Qm,getSegmentation:pt,getSegmentationRepresentation:zl,getSegmentationRepresentations:Ye,getSegmentationRepresentationsBySegmentationId:Nf,getSegmentations:$r,getStackSegmentationImageIdsForViewport:ID,getViewportIdsWithSegmentation:oi,getViewportSegmentationRepresentations:ep,getViewportSegmentations:tp,removeAllSegmentationRepresentations:Ym,removeAllSegmentations:Jm,removeColorLUT:vD,removeContourRepresentation:Km,removeLabelmapRepresentation:qm,removeSegmentation:Ad,removeSegmentationRepresentation:Xi,removeSurfaceRepresentation:Zm,updateLabelmapSegmentationImageReferences:np},Symbol.toStringTag,{value:"Module"}));function op(i){if("volumeId"in i){if(i=i,!X.getVolume(i.volumeId))throw new Error(`volumeId of ${i.volumeId} not found in cache, you should load and cache volume before adding segmentation`)}else if("imageIds"in i){if(i=i,!i.imageIds)throw new Error("The segmentationInput.representationData.imageIds is undefined, please provide a valid representationData.imageIds for stack data")}else throw new Error("The segmentationInput.representationData is undefined, please provide a valid representationData")}function ED(i){if(!i.representation.data)throw new Error("The segmentationInput.representationData.data is undefined, please provide a valid representationData.data");const t=i.representation.data;op(t)}function SD(i){op(i)}const _D=Object.freeze(Object.defineProperty({__proto__:null,validate:SD,validatePublic:ED},Symbol.toStringTag,{value:"Module"}));function ip(i){const t=X.getVolume(i);if(!t)return null;const n=t.referencedVolumeId;let e;if(n)e=X.getVolume(n);else{const o=t.imageIds,s=X.getImage(o[0]).referencedImageId;e=X.getVolumeContainingImageId(s)?.volume}return e}function DD({operationData:i}){const{volumeId:t}=i;if(!t){const c=new CustomEvent(ut.ERROR_EVENT,{detail:{type:"Segmentation",message:"No volume id found for the segmentation"},cancelable:!0});return z.dispatchEvent(c),null}const n=X.getVolume(t),e=ip(t);if(!n||!e)return null;const{imageData:o}=n,{voxelManager:a}=n,{voxelManager:s,imageData:r}=e;return{segmentationImageData:o,segmentationVoxelManager:a,segmentationScalarData:null,imageScalarData:null,imageVoxelManager:s,imageData:r}}function bD({operationData:i,viewport:t,strategy:n}){const{segmentationId:e}=i;let o,a,s,r,c,l;if(n.ensureSegmentationVolumeFor3DManipulation)n.ensureSegmentationVolumeFor3DManipulation({operationData:i,viewport:t}),a=i.segmentationVoxelManager,o=i.segmentationImageData,s=null;else{const d=Mo(t.id,e);if(!d)return null;const u=br(t.id,e);if(!u)return null;const h=X.getImage(d);o=u.actor.getMapper().getInputData(),a=h.voxelManager;const g=i.imageId,f=X.getImage(g);if(!f)return null;s=f.getPixelData?.()}if(n.ensureImageVolumeFor3DManipulation)n.ensureImageVolumeFor3DManipulation({operationData:i,viewport:t}),c=i.imageVoxelManager,r=i.imageScalarData,l=i.imageData;else{const d=t.getCurrentImageId();if(!d)return null;const u=X.getImage(d);l=u?null:t.getImageData(),r=u?.getPixelData()||l.getScalarData(),c=u?.voxelManager}return{segmentationImageData:o,segmentationScalarData:s,imageScalarData:r,segmentationVoxelManager:a,imageVoxelManager:c,imageData:l}}function Od({operationData:i,viewport:t,strategy:n}){return i?"volumeId"in i&&i.volumeId!=null||"referencedVolumeId"in i&&i.referencedVolumeId!=null?DD({operationData:i}):bD({operationData:i,viewport:t,strategy:n}):null}function Yi(i){const{representationData:t}=pt(i);let{volumeId:n}=t.Labelmap,e;if(n&&(e=X.getVolume(n),e))return e;const{imageIds:o}=t.Labelmap;if(n=X.generateVolumeId(o),!(!o||o.length===0||!ei(o)))return e=xl(n,o),e}const ap={[J.EnsureSegmentationVolumeFor3DManipulation]:i=>{const{operationData:t,viewport:n}=i,{segmentationId:e,imageIds:o}=t,a=n?n.getImageIds():o.map(c=>X.getImage(c).referencedImageId);if(!ei(a))throw new Error("Volume is not reconstructable for sphere manipulation");const r=Yi(e);r&&(t.segmentationVoxelManager=r.voxelManager,t.segmentationImageData=r.imageData)}};function Hr(i){if(!i?.length||!ei(i))return;const n=X.generateVolumeId(i);let e=X.getVolume(n);return e||(e=xl(n,i),e)}const sp={[J.EnsureImageVolumeFor3DManipulation]:i=>{const{operationData:t,viewport:n}=i;let e;if(n){if(e=n.getImageIds(),!ei(e))throw new Error("Volume is not reconstructable for sphere manipulation")}else e=pt(t.segmentationId).representationData.Labelmap.imageIds.map(r=>X.getImage(r).referencedImageId);const o=Hr(e);if(!o)throw new Error("Failed to create or get image volume");t.imageVoxelManager=o.voxelManager,t.imageData=o.imageData}},kn=(i,t)=>{gt(z,ut.WEB_WORKER_PROGRESS,{progress:t,type:i})},rp=(i,t)=>{const n=pt(i),{representationData:e}=n,{Labelmap:o}=e;if(!o)return console.debug("No labelmap found for segmentation",i),null;const a=o.volumeId,s=o.imageIds,r={segmentationId:i,volumeId:a,imageIds:s};let c=!1;if(s){const d=s.map(u=>X.getImage(u).referencedImageId);c=ei(d)}let l=t;return l?Array.isArray(l)||(l=[l,255]):l=[$e(i)],{operationData:r,segVolumeId:a,segImageIds:s,reconstructableVolume:c,indices:l}},cp=i=>Od({operationData:i,strategy:{ensureSegmentationVolumeFor3DManipulation:ap.ensureSegmentationVolumeFor3DManipulation,ensureImageVolumeFor3DManipulation:sp.ensureImageVolumeFor3DManipulation}}),lp=i=>{const t=[],n=[];for(const e of i){const o=X.getImage(e),a=o.getPixelData(),{origin:s,direction:r,spacing:c,dimensions:l}=Tg(o);t.push({scalarData:a,dimensions:l,spacing:c,origin:s,direction:r});const d=o.referencedImageId;if(d){const u=X.getImage(d);if(!u)continue;const h=u.getPixelData(),g=u.voxelManager,f=[u.rowPixelSpacing,u.columnPixelSpacing];n.push({scalarData:h,dimensions:g?g.dimensions:[u.columns,u.rows,1],spacing:f})}}return{segmentationInfo:t,imageInfo:n}},TD=(i,t)=>{let n;if(i){const r=X.getVolume(i).imageIds,c=X.getImage(r[0]);c&&(n=c.referencedImageId)}else t?.length&&(n=X.getImage(t[0]).referencedImageId);const e=X.getImage(n),o=ye("scalingModule",n),a={isPreScaled:!!e?.preScale?.scaled,isSuvScaled:typeof o?.suvbw=="number"};return{refImageId:n,modalityUnitOptions:a}},{Labelmap:PD}=tt;async function dp({segmentations:i}){Wr(),kn(Qe.GENERATE_CONTOUR_SETS,0);const{representationData:t,segments:n=[0,1],segmentationId:e}=i;let{volumeId:o}=t[PD];if(!o){const f=Yi(e);f&&(o=f.volumeId)}const a=X.getVolume(o);if(!a){console.warn(`No volume found for ${o}`);return}const c={scalarData:a.voxelManager.getCompleteScalarDataArray(),dimensions:a.dimensions,spacing:a.imageData.getSpacing(),origin:a.imageData.getOrigin(),direction:a.imageData.getDirection()},l=Array.isArray(n)?n.filter(f=>f!==null).map(f=>f.segmentIndex||f):Object.values(n).filter(f=>f!==null).map(f=>f.segmentIndex||f),d=await ti().executeTask("compute","generateContourSetsFromLabelmapVolume",{segmentation:c,indices:l,mode:"individual"}),u=a.imageIds.map(f=>{const m=X.getImage(f)?.referencedImageId;return m?X.getImage(m):void 0}),h=u.map(f=>Tg(f)),g=d.map(f=>{const m=n[f.segment.segmentIndex]||{};if(!f.sliceContours.length)return null;const v=f.sliceContours[0].polyData.points[0];let p;if(v){const I=h.findIndex(C=>{const{scanAxisNormal:E,origin:S}=C,_=po(E,S);return KI(v,_)});I!==-1&&(p=u[I].imageId)}return{label:m.label,color:m.color,metadata:{FrameOfReferenceUID:a.metadata.FrameOfReferenceUID,referencedImageId:p},sliceContours:f.sliceContours.map(I=>({contours:I.contours,polyData:I.polyData,FrameNumber:I.sliceIndex+1,sliceIndex:I.sliceIndex,FrameOfReferenceUID:a.metadata.FrameOfReferenceUID,referencedImageId:p}))}}).filter(f=>f!==null);return kn(Qe.GENERATE_CONTOUR_SETS,100),g}class up{constructor(){}static getContourSequence(t,n){const{data:e}=t,{projectionPoints:o,projectionPointsImageIds:a}=e.cachedStats;return o.map((s,r)=>{const c=MD(s),l=xD(a[r],n);return{NumberOfContourPoints:c.length/3,ContourImageSequence:l,ContourGeometricType:"CLOSED_PLANAR",ContourData:c}})}}up.toolName="RectangleROIStartEndThreshold";function MD(i){return[...i[0],...i[1],...i[3],...i[2]].flat().map(o=>o.toFixed(2))}function xD(i,t){const n=t.get("sopCommonModule",i);return{ReferencedSOPClassUID:n.sopClassUID,ReferencedSOPInstanceUID:n.sopInstanceUID}}function yD(i){if(!i?.data)throw new Error("Tool data is empty");if(!i.metadata||!i.metadata.referencedImageId)throw new Error("Tool data is not associated with any imageId")}const Ea=class Ea{constructor(){}static convert(t,n,e){yD(t);const{toolName:o}=t.metadata,a=Ea.TOOL_NAMES[o];if(!a)throw new Error(`Unknown tool type: ${o}, cannot convert to RTSSReport`);const s=a.getContourSequence(t,e),r=n.color?.slice(0,3)||[Math.floor(Math.random()*255),Math.floor(Math.random()*255),Math.floor(Math.random()*255)];return{ReferencedROINumber:n.segmentIndex,ROIDisplayColor:r,ContourSequence:Array.isArray(s)?s:[s]}}static register(t){Ea.TOOL_NAMES[t.toolName]=t}};Ea.TOOL_NAMES={};let Ri=Ea;Ri.register(up);function AD(i,t){un.acceptAutoGenerated(i,t)}const{isEqual:OD}=Rt;function ol(i,t){const{polyline:n}=i.data.contour,{points:e}=i.data.handles,{length:o}=e;if(t===o)return n.length;if(t<0&&(t=(t+o)%o),t===0)return 0;const a=e[t],s=n.findIndex(c=>OD(a,c));if(s!==-1)return s;let r=1/0;return n.reduce((c,l,d)=>{const u=ZI(l,a);return u<r?(r=u,d):c},-1)}function hp(i,t){if(!i||i.length===0)return[];if(t<=0)return[];const n=[];for(let e=0;e<i.length;e++){const o=i[e];if(!o||o.length<3)continue;Mr(o)&&Math.abs(ln(o))/100<t&&n.push(e)}return n}const LD=Object.freeze(Object.defineProperty({__proto__:null,AnnotationToPointData:Ri,acceptAutogeneratedInterpolations:AD,areCoplanarContours:J_,contourFinder:tD,detectContourHoles:aD,findContourHoles:Md,findHandlePolylineIndex:ol,findIslands:hp,generateContourSetsFromLabelmap:dp,getContourHolesDataCanvas:cs,getContourHolesDataWorld:km,getDeduplicatedVTKPolyDataPoints:eD,updateContourPolyline:bn},Symbol.toStringTag,{value:"Module"}));function RD(i,t){const n=pt(i);if(!n){console.warn(`Invalid segmentation given ${i}`);return}if(!n.representationData.Contour){console.warn(`No contour representation found for segmentation ${i}`);return}const e=ls(i,t);if(!e){console.warn(`Error extracting contour data from segment ${t} in segmentation ${i}`);return}const o=Array.from(e?.keys()),a=o.map(r=>e.get(r)),s=Md(a);s?.length>0&&s.forEach(r=>{r.holeIndexes.forEach(c=>{const l=xt(o[c]);Gr(l)})})}function ND(i,t,n={threshold:3}){const e=pt(i);if(!e){console.warn(`Invalid segmentation given ${i}`);return}if(!e.representationData.Contour){console.warn(`No contour representation found for segmentation ${i}`);return}const o=ls(i,t);if(!o){console.warn(`Error extracting contour data from segment ${t} in segmentation ${i}`);return}const a=Array.from(o?.keys()),s=a.map(c=>o.get(c)),r=hp(s,n.threshold);r?.length>0&&r.forEach(c=>{const l=xt(a[c]);Gr(l)})}function UD(i,t,n={knotsRatioPercentage:30}){const e=pt(i);if(!e){console.warn(`Invalid segmentation given ${i}`);return}if(!e.representationData.Contour){console.warn(`No contour representation found for segmentation ${i}`);return}const o=e.representationData.Contour,{annotationUIDsMap:a}=o;if(!a){console.warn(`No contours found for segmentation ${i}`);return}if(!a.has(t)){console.warn(`Error extracting contour data from segment ${t} in segmentation ${i}`);return}a.get(t).forEach(r=>{const c=xt(r);if(!c)return;const l=c.data.contour.polyline;if(!l||l.length<3)return;const d=Js(l,0,l.length-1,n.knotsRatioPercentage);c.data.contour.polyline=d})}function kD(i,t,n,e){const o=pt(i);if(!o){console.warn(`Invalid segmentation given ${i}`);return}if(!o.representationData.Contour){console.warn(`No contour representation found for segmentation ${i}`);return}const{annotationUIDsMap:a}=o?.representationData.Contour||{};if(!a){console.warn(`No annotation map found for segmentation ${i}`);return}const s=a?.get(t);if(!s){console.warn(`Segmentation index ${t} has no annotations in segmentation ${i}`);return}let r;if(n&&typeof e=="number"){const h=pt(n);if(!h){console.warn(`Target segmentation ${n} does not exist.`);return}if(!h.representationData.Contour){console.warn(`No contour representation found for target segmentation ${n}`);return}r=h.representationData.Contour.annotationUIDsMap.get(e),r||(r=new Set,h.representationData.Contour.annotationUIDsMap.set(e,r))}const c=ls(i,t);if(!c){console.warn(`Error extracting contour data from segment ${t} in segmentation ${i}`);return}const l=Array.from(c?.keys()),d=l.map(h=>c.get(h)),u=Md(d);u?.length>0&&u.forEach(h=>{h.holeIndexes.forEach(g=>{const f=xt(l[g]);Bi(f),n&&typeof e=="number"?r.add(f.annotationUID):s.add(f.annotationUID)})})}const VD=Object.freeze(Object.defineProperty({__proto__:null,convertContourHoles:kD,decimateContours:Z_,extractSegmentPolylines:ls,getAnnotationMapFromSegmentation:Wm,getAnnotationsUIDMapFromSegmentation:Ua,getViewportAssociatedToSegmentation:ed,getViewportWithMatchingViewPlaneNormal:nd,removeCompleteContourAnnotation:Gr,removeContourHoles:RD,removeContourIslands:ND,smoothContours:UD},Symbol.toStringTag,{value:"Module"}));function FD(i,t,n){const e=Ua(i.segmentationId);if(!e)return;const o=e.get(t);o&&o.forEach(a=>{Tr(a,n)})}function BD(i,t){const n=pt(i);if(!n)throw new Error(`No segmentation state found for ${i}`);const{segments:e}=n;return e[t].locked}function GD(i,t,n=!0){const e=pt(i);if(!e)throw new Error(`No segmentation state found for ${i}`);const{segments:o}=e;o[t].locked=n,e?.representationData?.Contour&&FD(e,t,n),gn(i)}function ai(i){const t=pt(i);if(!t)throw new Error(`No segmentation state found for ${i}`);const{segments:n}=t;return Object.keys(n).filter(o=>n[o].locked).map(o=>parseInt(o))}const WD=Object.freeze(Object.defineProperty({__proto__:null,getLockedSegmentIndices:ai,isSegmentIndexLocked:BD,setSegmentIndexLocked:GD},Symbol.toStringTag,{value:"Module"}));function $D(i,t){if(!i)throw new Error("addColorLUT: colorLUT is required");return pa(i,t)}function HD(i,t,n){if(!ts(n))throw new Error(`setColorLUT: could not find colorLUT with index ${n}`);const e=Ye(i,{segmentationId:t});if(!e)throw new Error(`viewport specific state for viewport ${i} does not exist`);e.forEach(o=>{o.colorLUTIndex=n}),An(i,t)}function Vn(i,t,n){const e=Ye(i,{segmentationId:t});if(!e||e.length===0)return null;const o=e[0],{colorLUTIndex:a}=o,s=ts(a);let r=s[n];if(!r){if(typeof n!="number")return console.warn(`Can't create colour for LUT index ${n}`),null;r=s[n]=[0,0,0,0]}return r}function gp(i,t,n,e){const o=Vn(i,t,n);for(let a=0;a<e.length;a++)o[a]=e[a];An(i,t)}const zD=Object.freeze(Object.defineProperty({__proto__:null,addColorLUT:$D,getSegmentIndexColor:Vn,setColorLUT:HD,setSegmentIndexColor:gp},Symbol.toStringTag,{value:"Module"}));function fp(i,t){return Vt.getSegmentationRepresentationVisibility(i,t)}function mp({segmentationId:i,segmentIndex:t,viewportId:n,autoGenerated:e=!1}){const o=Vn(n,i,t),a=fp(n,{segmentationId:i,type:tt.Contour}),r=Ko(n)?.segmentationId===i,c=Xe.getRenderInactiveSegmentations(n),d=Xe.getStyle({viewportId:n,segmentationId:i,type:tt.Contour,segmentIndex:t});let u=1,h,g=1,f=0,m=d.renderFill??!0,v=d.renderOutline??!0;e?(u=d.outlineWidthAutoGenerated??u,h=d.outlineDashAutoGenerated??h,g=d.outlineOpacity??g,f=d.fillAlphaAutoGenerated??f):r?(u=d.outlineWidth??u,h=d.outlineDash??h,g=d.outlineOpacity??g,f=d.fillAlpha??f):(u=d.outlineWidthInactive??u,h=d.outlineDashInactive??h,g=d.outlineOpacityInactive??g,f=d.fillAlphaInactive??f,m=d.renderFillInactive??m,v=d.renderOutlineInactive??v),$e(i)===t&&(u+=d.activeSegmentOutlineWidthDelta),u=v?u:0,f=m?f:0;const p=`rgba(${o[0]}, ${o[1]}, ${o[2]}, ${g})`,I=`rgb(${o[0]}, ${o[1]}, ${o[2]})`,E=!Yl(n,{segmentationId:i,type:tt.Contour}).has(t);return{color:p,fillColor:I,lineWidth:u,fillOpacity:f,lineDash:h,textbox:{color:p},visibility:r?a&&E:c}}const Qd=class Qd extends b_{constructor(t,n){super(t,n),this.configuration.interpolation?.enabled&&un.addTool(this.getToolName())}onSetToolConfiguration(){this.configuration.interpolation?.enabled?un.addTool(this.getToolName()):un.removeTool(this.getToolName())}isContourSegmentationTool(){return!0}createAnnotation(t){const n=t.detail,{element:e}=n,o=y(e);if(!o)return;const{viewport:a}=o,s=super.createAnnotation(t);if(!this.isContourSegmentationTool())return s;const r=Ko(a.id);if(!r)throw new Error("No active segmentation detected, create one before using scissors tool");if(!r.representationData.Contour)throw new Error("A contour segmentation must be active");const{segmentationId:c}=r,l=$e(c);return Be(s,{data:{segmentation:{segmentationId:c,segmentIndex:l}}})}addAnnotation(t,n){const e=super.addAnnotation(t,n);return this.isContourSegmentationTool()&&Qn(t),e}cancelAnnotation(t){this.isContourSegmentationTool()&&Sn(t),super.cancelAnnotation(t)}getAnnotationStyle(t){const n=super.getAnnotationStyle(t);if(!this.isContourSegmentationTool())return n;const e=this._getContourSegmentationStyle(t);return Be(n,e)}renderAnnotationInstance(t){const{annotation:n}=t,{invalidated:e}=n,o=super.renderAnnotationInstance(t);if(e&&this.isContourSegmentationTool()){const{segmentationId:a}=n.data.segmentation;Pe(a);const r=oi(a).map(c=>ne(c).id);Gm(r)}return o}filterInteractableAnnotationsForElement(t,n){if(!n||!n.length)return;const e=super.filterInteractableAnnotationsForElement(t,n);if(!e||!e.length)return;const o=y(t),{viewport:a}=o;return e.filter(s=>{const r=s?.data?.segmentation?.segmentationId;return r?!!Vt.getSegmentationRepresentation(a.id,{segmentationId:r,type:tt.Contour}):!0})}_getContourSegmentationStyle(t){const n=t.annotation,{segmentationId:e,segmentIndex:o}=n.data.segmentation,{viewportId:a}=t.styleSpecifier,s=Ye(a,{segmentationId:e});if(!s?.length)return{};s.length>1?s.find(v=>v.segmentationId===e&&v.type===tt.Contour):s[0];const{autoGenerated:r}=n,l=ai(e).includes(o),{color:d,fillColor:u,lineWidth:h,fillOpacity:g,lineDash:f,visibility:m}=mp({segmentationId:e,segmentIndex:o,viewportId:a,autoGenerated:r});return{color:d,fillColor:u,lineWidth:h,fillOpacity:g,lineDash:f,textbox:{color:d},visibility:m,locked:l}}};Qd.PreviewSegmentIndex=255;let Ba=Qd;function pp(i,t){const n=ye("generalSeriesModule",i);return so(n.modality,i,t)}function so(i,t,n){return i==="CT"?"HU":i==="PT"?jD(t,n):""}function jD(i,t){return t.isPreScaled?t.isSuvScaled?"SUV":ye("generalSeriesModule",i)?.modality==="PT"?ye("petSeriesModule",i)?.units||"unitless":"unknown":"raw"}const{pointCanProjectOnLine:Sh}=Po,{EPSILON:XD}=Qo,YD=1-XD,Sa=class Sa extends Ba{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{storePointData:!1,shadow:!0,preventHandleOutsideImage:!1,contourHoleAdditionModifierKey:De.Shift,alwaysRenderOpenContourHandles:{enabled:!1,radius:2},allowOpenContours:!0,closeContourProximity:10,checkCanvasEditFallbackProximity:6,makeClockWise:!0,subPixelResolution:4,smoothing:{smoothOnAdd:!1,smoothOnEdit:!1,knotsRatioPercentageOnAdd:40,knotsRatioPercentageOnEdit:40},interpolation:{enabled:!1,onInterpolationComplete:null},decimate:{enabled:!1,epsilon:.1},displayOnePointAsCrosshairs:!1,calculateStats:!0,getTextLines:qD,statsCalculator:Un}}){super(t,n),this.isDrawing=!1,this.isEditingClosed=!1,this.isEditingOpen=!1,this.addNewAnnotation=e=>{const o=e.detail,{element:a}=o,s=this.createAnnotation(e);this.addAnnotation(s,a);const r=Q(a,this.getToolName());return this.activateDraw(e,s,r),e.preventDefault(),L(r),s},this.handleSelectedCallback=(e,o,a)=>{const s=e.detail,{element:r}=s,c=Q(r,this.getToolName());this.activateOpenContourEndEdit(e,o,c,a)},this.toolSelectedCallback=(e,o)=>{const a=e.detail,{element:s}=a,r=Q(s,this.getToolName());o.data.contour.closed?this.activateClosedContourEdit(e,o,r):this.activateOpenContourEdit(e,o,r),e.preventDefault()},this.isPointNearTool=(e,o,a,s)=>{const r=y(e),{viewport:c}=r,{polyline:l}=o.data.contour;let d=c.worldToCanvas(l[0]);for(let g=1;g<l.length;g++){const f=d,m=c.worldToCanvas(l[g]);if(Sh(a,f,m,s))return!0;d=m}if(!o.data.contour.closed)return!1;const u=c.worldToCanvas(l[0]),h=c.worldToCanvas(l[l.length-1]);return Sh(a,u,h,s)},this.cancel=e=>{const o=this.isDrawing,a=this.isEditingOpen,s=this.isEditingClosed;o?this.cancelDrawing(e):a?this.cancelOpenContourEdit(e):s&&this.cancelClosedContourEdit(e)},this._calculateCachedStats=(e,o,a,s)=>{const{data:r}=e,{cachedStats:c}=r,{polyline:l,closed:d}=r.contour,u=Object.keys(c);for(let g=0;g<u.length;g++){const f=u[g],m=this.getTargetImageData(f);if(!m)continue;const{imageData:v,metadata:p}=m,I=l.map(j=>o.worldToCanvas(j)),C={isPreScaled:io(o,f),isSuvScaled:this.isSuvScaled(o,f,e.metadata.referencedImageId)},E=so(p.Modality,e.metadata.referencedImageId,C),S=r.contour.polyline,_=S.length,D=new Array(_);for(let j=0;j<_;j++)D[j]=o.worldToCanvas(S[j]);const{maxX:b,maxY:M,minX:P,minY:T}=bo(D),x=o.canvasToWorld([P,T]),A=xe(v,x),O=o.canvasToWorld([b,M]),R=xe(v,O),k=nn(m,[A,R]),B=I[0],V=o.canvasToWorld(B),$=o.canvasToWorld([B[0]+1,B[1]]),H=o.canvasToWorld([B[0],B[1]+1]),G=Te(V,$),Y=Te(V,H),q={targetId:f,viewport:o,canvasCoordinates:I,points:l,imageData:v,metadata:p,cachedStats:c,modalityUnit:E,calibratedScale:k,deltaInX:G,deltaInY:Y};d?this.updateClosedCachedStats(q):this.updateOpenCachedStats(q)}const h=e.invalidated;return e.invalidated=!1,h&&It(e,s.viewport.element,lt.StatsUpdated),c},this._renderStats=(e,o,a,s)=>{const{data:r}=e,c=this.getTargetId(o),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:a.viewport.id,annotationUID:e.annotationUID},d=this.getLinkedTextBoxStyle(l,e);if(!d.visibility)return;const u=this.configuration.getTextLines(r,c);if(!u||u.length===0)return;const h=r.contour.polyline.map(E=>o.worldToCanvas(E));if(!r.handles.textBox.hasMoved){const E=qe(h);r.handles.textBox.worldPosition=o.canvasToWorld(E)}const g=o.worldToCanvas(r.handles.textBox.worldPosition),m=Oe(s,e.annotationUID??"","1",u,g,h,{},d),{x:v,y:p,width:I,height:C}=m;r.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([v,p]),topRight:o.canvasToWorld([v+I,p]),bottomLeft:o.canvasToWorld([v,p+C]),bottomRight:o.canvasToWorld([v+I,p+C])}},PS(this),NS(this),zS(this),i_(this),r_(this),w_(this),this._throttledCalculateCachedStats=Fe(this._calculateCachedStats,100,{trailing:!0})}filterInteractableAnnotationsForElement(t,n){if(!n?.length)return[];const e=super.filterInteractableAnnotationsForElement(t,n);if(!e?.length)return[];const o=y(t),{viewport:a}=o;let s;if(a instanceof ae){const r=a.getCamera(),{spacingInNormalDirection:c}=Pl(a,r);s=this.filterAnnotationsWithinSlice(e,r,c)}else s=ss(a,n);return s}filterAnnotationsWithinSlice(t,n,e){const{viewPlaneNormal:o}=n,a=t.filter(l=>{let d=l.metadata.viewPlaneNormal;if(!l.metadata.referencedImageId&&!d&&l.metadata.FrameOfReferenceUID){for(const h of l.data.contour.polyline){const g=me(W(),h,n.focalPoint),f=dt(g,n.viewPlaneNormal);if(!Pt(f,0))return!1}return l.metadata.viewPlaneNormal=n.viewPlaneNormal,l.metadata.cameraFocalPoint=n.focalPoint,!0}if(!d){const{referencedImageId:h}=l.metadata,{imageOrientationPatient:g}=ye("imagePlaneModule",h),f=wt(g[0],g[1],g[2]),m=wt(g[3],g[4],g[5]);d=W(),be(d,f,m),l.metadata.viewPlaneNormal=d}const u=Math.abs(dt(o,d))>YD;return d&&u});if(!a.length)return[];const s=e/2,{focalPoint:r}=n,c=[];for(const l of a){const u=l.data.contour.polyline[0];if(!l.isVisible)continue;const h=W();me(h,r,u);const g=dt(h,o);Math.abs(g)<s&&c.push(l)}return c}isContourSegmentationTool(){return!1}createAnnotation(t){const n=t.detail.currentPoints.world,e=super.createAnnotation(t),o=s=>{s.data.handles.points.length=0};return Be(e,{data:{contour:{polyline:[[...n]]},label:"",cachedStats:{}},onInterpolationComplete:o})}getAnnotationStyle(t){return super.getAnnotationStyle(t)}renderAnnotationInstance(t){const{enabledElement:n,targetId:e,svgDrawingHelper:o}=t,a=t.annotation;let s=!1;const{viewport:r,renderingEngine:c}=n,l=this.isDrawing,d=this.isEditingOpen,u=this.isEditingClosed;if(!(l||d||u))this.configuration.displayOnePointAsCrosshairs&&a.data.contour.polyline.length===1?this.renderPointContourWithMarker(n,o,a):this.renderContour(n,o,a);else{const h=this.commonData.annotation.annotationUID;if(a.annotationUID===h)if(l)this.renderContourBeingDrawn(n,o,a);else if(u)this.renderClosedContourBeingEdited(n,o,a);else if(d)this.renderOpenContourBeingEdited(n,o,a);else throw new Error(`Unknown ${this.getToolName()} annotation rendering state`);else this.configuration.displayOnePointAsCrosshairs&&a.data.contour.polyline.length===1?this.renderPointContourWithMarker(n,o,a):this.renderContour(n,o,a);s=!0}if(this.configuration.calculateStats)return a.invalidated&&this._calculateStatsIfActive(a,e,r,c,n),this._renderStats(a,r,n,o),s}_calculateStatsIfActive(t,n,e,o,a){const s=this.commonData?.annotation.annotationUID;if(!(t.annotationUID===s&&!this.commonData?.movingTextBox)&&!this.commonData?.movingTextBox){const{data:r}=t;r.cachedStats[n]?.unit?t.invalidated&&this._throttledCalculateCachedStats(t,e,o,a):(r.cachedStats[n]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null,unit:null},this._calculateCachedStats(t,e,o,a))}}updateClosedCachedStats({viewport:t,points:n,imageData:e,metadata:o,cachedStats:a,targetId:s,modalityUnit:r,canvasCoordinates:c,calibratedScale:l,deltaInX:d,deltaInY:u}){const{scale:h,areaUnit:g,unit:f}=l,{voxelManager:m}=t.getImageData(),v=n.map(G=>e.worldToIndex(G));let p=Number.MAX_SAFE_INTEGER,I=Number.MIN_SAFE_INTEGER,C=Number.MAX_SAFE_INTEGER,E=Number.MIN_SAFE_INTEGER,S=Number.MAX_SAFE_INTEGER,_=Number.MIN_SAFE_INTEGER;for(let G=0;G<n.length;G++){const Y=v[G].map(Math.floor);p=Math.min(p,Y[0]),I=Math.max(I,Y[0]),C=Math.min(C,Y[1]),E=Math.max(E,Y[1]),S=Math.min(S,Y[2]),_=Math.max(_,Y[2])}let D=os(c)/h/h;D*=d*u;const b=Sa.calculateLengthInIndex(l,v,closed),M=.01*(I-p),P=.01*(E-C),T=.01*(_-S);p=Math.floor(p-M),I=Math.ceil(I+M),C=Math.floor(C-P),E=Math.ceil(E+P),S=Math.floor(S-T),_=Math.ceil(_+T);const x=[[p,I],[C,E],[S,_]],A=e.indexToWorld([I,E,_]),O=t.worldToCanvas(A);let R=0,N=[],k=0,B;m&&(B=m.forEach(this.configuration.statsCalculator.statsCallback,{imageData:e,isInObject:(G,Y)=>{let q=!0;const j=t.worldToCanvas(G);return j[1]!=R&&(k=0,R=j[1],N=um(c,j,[O[0],j[1]]),N.sort((function(K){return function(it,at){return it[K]===at[K]?0:it[K]<at[K]?-1:1}})(0))),N.length&&j[0]>N[0][0]&&(N.shift(),k++),k%2===0&&(q=!1),q},boundsIJK:x,returnPoints:this.configuration.storePointData}));const V=this.configuration.statsCalculator.getStatistics(),$={name:"area",value:D,unit:g,type:rn.Area},H={name:"perimeter",value:b,unit:f,type:rn.Linear};a[s]={Modality:o.Modality,area:D,perimeter:b,mean:V.mean?.value,max:V.max?.value,min:V.min?.value,stdDev:V.stdDev?.value,statsArray:[$,H,...V.array],pointsInShape:B,areaUnit:g,modalityUnit:r,unit:f}}updateOpenCachedStats({targetId:t,metadata:n,cachedStats:e,modalityUnit:o,calibratedScale:a,imageData:s,points:r}){const{unit:c}=a,l=r.map(h=>s.worldToIndex(h)),d=Sa.calculateLengthInIndex(a,l),u={name:"length",value:d,unit:c,type:rn.Linear};e[t]={Modality:n.Modality,length:d,modalityUnit:o,unit:c,statArray:[u]}}};Sa.toolName="PlanarFreehandROI";let il=Sa;function qD(i,t){const n=i.cachedStats[t],{area:e,mean:o,stdDev:a,length:s,perimeter:r,max:c,min:l,isEmptyArea:d,unit:u,areaUnit:h,modalityUnit:g}=n||{},f=[];if(le(e)){const m=d?"Area: Oblique not supported":`Area: ${_t(e)} ${h}`;f.push(m)}return le(o)&&f.push(`Mean: ${_t(o)} ${g}`),le(c)&&f.push(`Max: ${_t(c)} ${g}`),le(l)&&f.push(`Min: ${_t(l)} ${g}`),le(a)&&f.push(`Std Dev: ${_t(a)} ${g}`),le(r)&&f.push(`Perimeter: ${_t(r)} ${u}`),le(s)&&f.push(`${_t(s)} ${u}`),f}const hr=class hr extends il{constructor(t){const n=Be({configuration:{calculateStats:!1,allowOpenContours:!1}},t);super(n)}isContourSegmentationTool(){return!0}renderAnnotationInstance(t){const n=t.annotation,{invalidated:e}=n,o=super.renderAnnotationInstance(t);if(e){const{segmentationId:a}=n.data.segmentation;Pe(a)}return o}};hr.toolName="PlanarFreehandContourSegmentationTool",Ri.register(hr);let Ga=hr;const KD={[tt.Labelmap]:Id,[tt.Contour]:vd,[tt.Surface]:ql},_s=Ga.toolName;class ZD{constructor(){this._needsRender=new Set,this._pendingRenderQueue=[],this._animationFrameSet=!1,this._animationFrameHandle=null,this._getAllViewports=()=>Co().flatMap(n=>n.getViewports()),this._renderFlaggedSegmentations=()=>{if(this._throwIfDestroyed(),Array.from(this._needsRender).forEach(n=>{this._triggerRender(n)}),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null,this._pendingRenderQueue.length>0){const n=this._pendingRenderQueue.shift();n&&n.length>0&&this._setViewportsToBeRenderedNextFrame(n)}}}renderSegmentationsForViewport(t){const n=t?[t]:this._getViewportIdsForSegmentation();this._setViewportsToBeRenderedNextFrame(n)}renderSegmentation(t){const n=this._getViewportIdsForSegmentation(t);this._setViewportsToBeRenderedNextFrame(n)}_getViewportIdsForSegmentation(t){const n=this._getAllViewports(),e=[];for(const o of n){const a=o.id;t?Ye(a,{segmentationId:t})?.length>0&&e.push(a):Ye(a)?.length>0&&e.push(a)}return e}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setViewportsToBeRenderedNextFrame(t){if(this._animationFrameSet){this._pendingRenderQueue.push(t);return}t.forEach(n=>{this._needsRender.add(n)}),this._render()}_render(){this._needsRender.size>0&&this._animationFrameSet===!1&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedSegmentations),this._animationFrameSet=!0)}_triggerRender(t){const n=Ye(t);if(!n?.length)return;const{viewport:e}=At(t)||{};if(!e)return;const o=n.map(a=>{a.type===tt.Contour&&this._addPlanarFreeHandToolIfAbsent(e);const s=KD[a.type],c=pt(a.segmentationId).representationData[a.type]!==void 0;try{s.render(e,a).then(()=>{c||xd(e,a.segmentationId,a.type)})}catch(l){console.error(l)}return Promise.resolve({segmentationId:a.segmentationId,type:a.type})});Promise.allSettled(o).then(a=>{const s=a.filter(l=>l.status==="fulfilled").map(l=>l.value);function r(l){const{element:d,viewportId:u}=l.detail;d.removeEventListener(ut.IMAGE_RENDERED,r),s.forEach(h=>{const g={viewportId:u,segmentationId:h.segmentationId,type:h.type};gt(z,w.SEGMENTATION_RENDERED,{...g})})}e.element.addEventListener(ut.IMAGE_RENDERED,r),e.render()})}_addPlanarFreeHandToolIfAbsent(t){_s in U.tools||Jg(Ga);const n=ne(t.id);n.hasTool(_s)||(n.addTool(_s),n.setToolPassive(_s))}}function qi(i){vp.renderSegmentationsForViewport(i)}function zr(i){vp.renderSegmentation(i)}const vp=new ZD;function JD({modifiedSlicesToUse:i,representationData:t,type:n}){const e=X.getVolume(t[n].volumeId);if(!e){console.warn("segmentation not found in cache");return}const{imageData:o,vtkOpenGLTexture:a}=e;let s;if(i?.length>0)s=i;else{const r=o.getDimensions()[2];s=[...Array(r).keys()]}s.forEach(r=>{a.setUpdatedFrame(r)}),o.modified()}function QD({viewportIds:i,segmentationId:t}){i.forEach(n=>{let e=Ye(n,{segmentationId:t});e=e.filter(o=>o.type===tt.Labelmap),e.forEach(o=>{if(o.segmentationId!==t)return;const a=At(n);if(!a)return;const{viewport:s}=a;if(s instanceof ae)return;const r=fa(n,t);r?.length&&r.forEach((c,l)=>{const d=c.actor.getMapper().getInputData(),u=no(n,t),h=X.getImage(u[l]);d.modified(),Pg(d,h)})})})}const tb=function(i){const{segmentationId:t,modifiedSlicesToUse:n}=i.detail,{representationData:e}=pt(t),o=oi(t),a=o.some(c=>{const{viewport:l}=At(c);return l instanceof ae}),s=o.some(c=>{const{viewport:l}=At(c);return l instanceof Ie}),r=a&&s;o.forEach(c=>{const{viewport:l}=At(c);l instanceof ae&&JD({modifiedSlicesToUse:r?[]:n,representationData:e,type:tt.Labelmap}),l instanceof Ie&&QD({viewportIds:o,segmentationId:t})})},Ip=function(i){const{segmentationId:t}=i.detail,{representationData:n}=pt(t);n.Labelmap&&tb(i),zr(t)},wp=function(i){const{segmentationId:t}=i.detail;zr(t)},eb=function(i){if(!i)return;const t=y(i);if(!t)return;const{viewport:n}=t;n instanceof ve||(i.addEventListener(ut.PRE_STACK_NEW_IMAGE,Wa),i.addEventListener(ut.IMAGE_RENDERED,Wa))},nb=function(i){i.removeEventListener(ut.PRE_STACK_NEW_IMAGE,Wa),i.removeEventListener(ut.IMAGE_RENDERED,Wa)};function Wa(i){const t=i.detail,{viewportId:n,renderingEngineId:e}=t,{viewport:o}=Gt(n,e),a=Ye(n);if(!a?.length)return;const s=a.filter(l=>l.type===tt.Labelmap),r=o.getActors();s.forEach(l=>{const{segmentationId:d}=l;np(n,d)});const c=s.flatMap(l=>fa(n,l.segmentationId)).filter(l=>l!==void 0);c.length&&(c.forEach(l=>{s.find(u=>no(n,u.segmentationId)?.includes(l.referencedId))||o.removeActors([l.uid])}),s.forEach(l=>{const{segmentationId:d}=l,u=o.getCurrentImageId(),h=no(n,d);if(!h)return;let g=!1;const f=m=>{const v=X.getImage(m);if(!v){console.warn("No derived image found in the cache for segmentation representation",l);return}const p=r.find(I=>I.referencedId===m);if(p){const I=p.actor.getMapper().getInputData();I.setDerivedImage?I.setDerivedImage(v):Pg(I,v)}else{const{dimensions:I,spacing:C,direction:E}=o.getImageDataMetadata(v),S=X.getImage(u)||{imageId:u},{origin:_}=o.getImageDataMetadata(S),D=_,b=v.voxelManager.getConstructor(),M=v.voxelManager.getScalarData(),P=Zn.newInstance({name:"Pixels",numberOfComponents:1,values:new b(M)}),T=Mg.newInstance();T.setDimensions(I[0],I[1],1),T.setSpacing(C),T.setDirection(E),T.setOrigin(D),T.getPointData().setScalars(P),T.modified(),o.addImages([{imageId:m,representationUID:`${d}-${tt.Labelmap}-${v.imageId}`,callback:({imageActor:x})=>{x.getMapper().setInputData(T)}}]),g=!0;return}};h.forEach(f),g&&qi(n),o.render(),i.type===ut.IMAGE_RENDERED&&o.element.removeEventListener(ut.IMAGE_RENDERED,Wa)}))}const Cp={enable:eb,disable:nb};async function ob(i){const t=i.detail.annotation;if(!Hi(t))return;const n=ab(t),e=sb(n,t);if(!e.length){gt(z,w.ANNOTATION_CUT_MERGE_PROCESS_COMPLETED,{element:n.element,sourceAnnotation:t});return}const o=en(t.data.contour.polyline,n),a=Tm(n,o,e);if(!a.length){gt(z,w.ANNOTATION_CUT_MERGE_PROCESS_COMPLETED,{element:n.element,sourceAnnotation:t});return}if(a.length>1){Pm(n,t,o,a);return}const{targetAnnotation:s,targetPolyline:r,isContourHole:c}=a[0];if(c){const{contourHoleProcessingEnabled:l=!1}=i.detail;if(!l)return;Rr(n,s,t)}else ud(n,s,r,t,o)}function ib(i,t=!1){const n="PlanarFreehandContourSegmentationTool",e=ne(i.id,i.renderingEngineId);let o;return e?e.hasTool(n)?e.getToolOptions(n)||(o=`Tool ${n} must be in active/passive state in ${e.id} toolGroup`):o=`Tool ${n} not added to ${e.id} toolGroup`:o=`ToolGroup not found for viewport ${i.id}`,o&&!t&&console.warn(o),!o}function ab(i){const t=pd(i);return t.find(e=>ib(e,!0))??t[0]}function sb(i,t){const{annotationUID:n}=t;return Fi().filter(o=>o.annotationUID&&o.annotationUID!==n&&Hi(o)&&Vf(o,t)&&i.isReferenceViewable(o.metadata))}function rb(i){const t=i.detail.annotation;Sn(t)}function Ep(i){const t=i.detail.annotation;Hi(t)&&ob(i)}function tr(i){if(!i.detail.removed.length)return;Co().forEach(e=>{const a=e.getViewports().map(s=>s.id);L(a)})}function Sp(i){const{viewportId:t}=i.detail;L([t])}function _p(i){const t=i.detail.annotation;Hi(t)&&rb(i)}const Dp=function(i){$i(i.detail.element)},cb=function(i){i.addEventListener(ut.IMAGE_RENDERED,Dp)},lb=function(i){i.removeEventListener(ut.IMAGE_RENDERED,Dp)},bp={enable:cb,disable:lb},{Active:db}=Ot;function Ki(i,t,n){if(U.isInteractingWithTool)return!1;const{renderingEngineId:e,viewportId:o}=n.detail,a=ne(o,e);if(!a)return!1;let s;const r=Object.keys(a.toolOptions);for(let c=0;c<r.length;c++){const l=r[c],d=a.toolOptions[l],u=a.getToolInstance(l);if(d.mode===db&&typeof u[t]=="function"){s=a.getToolInstance(l);break}}s&&s[t](n)}const Tp=Ki.bind(null,"Mouse","mouseClickCallback"),Pp=Ki.bind(null,"Mouse","doubleClickCallback");function Mp(i,t,n,e="mouse"){const o=e==="touch"?36:6,a=[];return t.forEach(({tool:s,annotations:r})=>{for(const c of r){if(c.isLocked||!c.isVisible)continue;const l=s.getHandleNearImagePoint(i,c,n,o);if(l){a.push({tool:s,annotation:c,handle:l});break}}}),a}function ds(i,t){const n=[];for(let e=0;e<t.length;e++){const o=t[e];if(!o){console.warn("undefined tool in filterToolsWithAnnotationsForElement");continue}let a=Ct(o.constructor.toolName,i);a?.length&&(typeof o.filterInteractableAnnotationsForElement=="function"&&(a=o.filterInteractableAnnotationsForElement(i,a)),a?.length>0&&n.push({tool:o,annotations:a}))}return n}function Ld(i,t,n,e="mouse"){const o=e==="touch"?36:6,a=[];return t.forEach(({tool:s,annotations:r})=>{for(const c of r){if(c.isLocked||!c.isVisible)continue;if(s.isPointNearTool(i,c,n,o,e)){a.push({tool:s,annotation:c});break}}}),a}const{Active:ub}=Ot;function jr(i){const{renderingEngineId:t,viewportId:n,event:e}=i.detail,o=ji(e)||Gi.getModifierKey(),a=ne(n,t);if(!a)return null;const s=Object.keys(a.toolOptions),r=a.getDefaultMousePrimary(),c=i.detail.buttons??e?.buttons??r;for(let l=0;l<s.length;l++){const d=s[l],u=a.toolOptions[d],h=u.bindings.length&&u.bindings.some(g=>g.mouseButton===c&&g.modifierKey===o);if(u.mode===ub&&h)return a.getToolInstance(d)}}function Ni(i,t,n){const{renderingEngineId:e,viewportId:o}=i.detail,a=ne(o,e);if(!a)return[];const s=[],r=Object.keys(a.toolOptions);for(let c=0;c<r.length;c++){const l=r[c],d=a.toolOptions[l],u=n!=null&&d.bindings.length&&d.bindings.some(h=>h.mouseButton===n);if(t.includes(d.mode)&&(!n||u)){const h=a.getToolInstance(l);s.push(h)}}return s}function hb(i,t){const n=new Map,{renderingEngineId:e,viewportId:o}=i.detail,a=ne(o,e);if(!a)return n;const s=Object.keys(a.toolOptions),r=a.getDefaultMousePrimary(),c=i.detail.event,l=c?.buttons??r,d=ji(c)||Gi.getModifierKey();for(let u=0;u<s.length;u++){const h=s[u],g=a.getToolInstance(h),f=g.configuration?.actions??{},m=Object.values(f);if(!m?.length||!t.includes(g.mode))continue;const v=m.find(p=>p.bindings?.length&&p.bindings.some(I=>I.mouseButton===l&&I.modifierKey===d));v&&n.set(g,v)}return n}const{Active:gb,Passive:fb}=Ot;function mb(i){if(U.isInteractingWithTool)return!1;const t=i.detail,{element:n}=t,e=y(n),{canvas:o}=t.currentPoints;if(!e)return!1;const a=hb(i,[gb,fb]),s=Array.from(a.keys()),r=ds(n,s),c=Ld(n,r,o);if(c.length>0){const{tool:l,annotation:d}=c[0],u=a.get(l);return(typeof u.method=="string"?l[u.method]:u.method).call(l,i,d),!0}return!1}const{Active:pb,Passive:vb}=Ot;function xp(i){if(U.isInteractingWithTool)return;const t=jr(i);if(t&&typeof t.preMouseDownCallback=="function"&&t.preMouseDownCallback(i))return;const n=i.detail.event.buttons===1,e=Ni(i,[pb],i.detail.event.buttons),o=n?Ni(i,[vb]):void 0,a=[...e||[],...o||[]];if(mb(i))return;const r=i.detail,{element:c}=r,l=ds(c,a),d=r.currentPoints.canvas,u=Mp(c,l,d,"mouse"),h=!!i.detail.event.shiftKey;if(u.length>0){const{tool:f,annotation:m,handle:v}=_h(u);Dh(m.annotationUID,h),f.handleSelectedCallback(i,m,v,"Mouse");return}const g=Ld(c,l,d,"mouse");if(g.length>0){const{tool:f,annotation:m}=_h(g);Dh(m.annotationUID,h),f.toolSelectedCallback(i,m,"Mouse",d);return}t&&typeof t.postMouseDownCallback=="function"&&t.postMouseDownCallback(i)}function _h(i){if(i.length>1){const t=i.find(n=>{const e=!se(n.annotation.annotationUID),o=re(n.annotation.annotationUID);return e&&o});if(t)return t}return i[0]}function Dh(i,t=!1){t?es(i)?cn(i,!1):cn(i,!0,!0):cn(i,!0,!1)}function yp(i){if(U.isInteractingWithTool)return;const t=jr(i);if(t&&!U.isMultiPartToolActive&&t.addNewAnnotation){const n=t.addNewAnnotation(i,"mouse");cn(n.annotationUID)}}function Ap(i){if(U.isInteractingWithTool)return;const t=jr(i);!t||typeof t.mouseDragCallback!="function"||t.mouseDragCallback(i)}const{Active:Ib,Passive:wb}=Ot;function Op(i){if(U.isInteractingWithTool||U.isMultiPartToolActive)return;const t=Ni(i,[Ib,wb]),n=i.detail,{element:e}=n,o=ds(e,t),a=t.filter(r=>!o.some(l=>l.tool.getToolName()===r.getToolName()));let s=!1;for(const{tool:r,annotations:c}of o)typeof r.mouseMoveCallback=="function"&&(s=r.mouseMoveCallback(i,c)||s);a.forEach(r=>{typeof r.mouseMoveCallback=="function"&&r.mouseMoveCallback(i)}),s===!0&&$i(e)}const Lp=Ki.bind(null,"Mouse","mouseUpCallback");function Rp(i){if(U.isInteractingWithTool)return;i.detail.buttons=Nn.Wheel|(i.detail.event.buttons||0);const t=jr(i);if(t)return t.mouseWheelCallback(i)}const Cb=function(i){i.addEventListener(w.MOUSE_CLICK,Tp),i.addEventListener(w.MOUSE_DOWN,xp),i.addEventListener(w.MOUSE_DOWN_ACTIVATE,yp),i.addEventListener(w.MOUSE_DOUBLE_CLICK,Pp),i.addEventListener(w.MOUSE_DRAG,Ap),i.addEventListener(w.MOUSE_MOVE,Op),i.addEventListener(w.MOUSE_UP,Lp),i.addEventListener(w.MOUSE_WHEEL,Rp)},Eb=function(i){i.removeEventListener(w.MOUSE_CLICK,Tp),i.removeEventListener(w.MOUSE_DOWN,xp),i.removeEventListener(w.MOUSE_DOWN_ACTIVATE,yp),i.removeEventListener(w.MOUSE_DOUBLE_CLICK,Pp),i.removeEventListener(w.MOUSE_DRAG,Ap),i.removeEventListener(w.MOUSE_MOVE,Op),i.removeEventListener(w.MOUSE_UP,Lp),i.removeEventListener(w.MOUSE_WHEEL,Rp)},Np={enable:Cb,disable:Eb},{Active:Sb}=Ot;function Up(i){const{renderingEngineId:t,viewportId:n}=i.detail,e=Ww(),o=Gi.getModifierKey(),a=ne(n,t);if(!a)return null;const s=Object.keys(a.toolOptions),r=a.getDefaultMousePrimary();for(let c=0;c<s.length;c++){const l=s[c],d=a.toolOptions[l];if(d.mode!==Sb)continue;if(d.bindings.length&&d.bindings.some(h=>h.mouseButton===(e??r)&&h.modifierKey===o))return a.getToolInstance(l)}}function _b(i,t){const n=new Map,{renderingEngineId:e,viewportId:o}=i.detail,a=ne(o,e);if(!a)return n;const s=Object.keys(a.toolOptions),r=i.detail.key;for(let c=0;c<s.length;c++){const l=s[c],d=a.getToolInstance(l),u=d.configuration?.actions;if(!u)continue;const h=Object.values(u);if(!h?.length||!t.includes(d.mode))continue;const g=h.find(f=>f.bindings?.some(m=>m.key===r));g&&n.set(d,g)}return n}function kp(i){const t=Up(i);if(t){const{renderingEngineId:e,viewportId:o}=i.detail,a=ne(o,e),s=t.getToolName();Object.keys(a.toolOptions).includes(s)&&a.setViewportsCursorByToolName(s)}const n=_b(i,[Ot.Active]);if(n?.size){const{element:e}=i.detail;for(const[o,a]of[...n.entries()])(typeof a.method=="function"?a.method:o[a.method]).call(o,e,a,i)}}function Vp(i){const t=Up(i);if(!t)return;const{renderingEngineId:n,viewportId:e}=i.detail,o=ne(e,n);yf();const a=t.getToolName();Object.keys(o.toolOptions).includes(a)&&o.setViewportsCursorByToolName(a)}const Db=function(i){i.addEventListener(w.KEY_DOWN,kp),i.addEventListener(w.KEY_UP,Vp)},bb=function(i){i.removeEventListener(w.KEY_DOWN,kp),i.removeEventListener(w.KEY_UP,Vp)},Fp={enable:Db,disable:bb},{Active:Tb,Passive:Pb,Enabled:Mb}=Ot,Bp=function(i){Ni(i,[Tb,Pb,Mb]).forEach(n=>{n.onCameraModified&&n.onCameraModified(i)})},xb=function(i){i.addEventListener(ut.CAMERA_MODIFIED,Bp)},yb=function(i){i.removeEventListener(ut.CAMERA_MODIFIED,Bp)},Gp={enable:xb,disable:yb},{Active:Ab,Passive:Ob,Enabled:Lb}=Ot,Wp=function(i){Ni(i,[Ab,Ob,Lb]).forEach(n=>{n.onImageSpacingCalibrated&&n.onImageSpacingCalibrated(i)})},Rb=function(i){i.addEventListener(ut.IMAGE_SPACING_CALIBRATED,Wp)},Nb=function(i){i.removeEventListener(ut.IMAGE_SPACING_CALIBRATED,Wp)},$p={enable:Rb,disable:Nb},{Active:Ub}=Ot;function Rd(i){const{renderingEngineId:t,viewportId:n}=i.detail,e=i.detail.event,o=ne(n,t);if(!o)return null;const a=Object.keys(o.toolOptions),s=Object.keys(e.touches).length,r=ji(e)||Gi.getModifierKey(),c=o.getDefaultMousePrimary();for(let l=0;l<a.length;l++){const d=a[l],u=o.toolOptions[d],h=u.bindings.length&&u.bindings.some(g=>(g.numTouchPoints===s||s===1&&g.mouseButton===c)&&g.modifierKey===r);if(u.mode===Ub&&h)return o.getToolInstance(d)}}function bh(i,t,n){const{renderingEngineId:e,viewportId:o}=i.detail,a=ne(o,e);if(!a)return[];const s=[],r=Object.keys(a.toolOptions);for(let c=0;c<r.length;c++){const l=r[c],d=a.toolOptions[l],u=n!=null&&d.bindings.length&&d.bindings.some(h=>h.numTouchPoints===n);if(t.includes(d.mode)&&(!n||u)){const h=a.getToolInstance(l);s.push(h)}}return s}const{Active:kb,Passive:Vb}=Ot;function Hp(i){if(U.isInteractingWithTool)return;const t=Rd(i);if(t&&typeof t.preTouchStartCallback=="function"&&t.preTouchStartCallback(i))return;const n=Object.keys(i.detail.event.touches).length===1,e=bh(i,[kb],Object.keys(i.detail.event.touches).length),o=n?bh(i,[Vb]):void 0,a=[...e||[],...o||[],t],s=i.detail,{element:r}=s,c=ds(r,a),l=s.currentPoints.canvas,d=Mp(r,c,l,"touch"),u=!1;if(d.length>0){const{tool:g,annotation:f,handle:m}=Th(d);Ph(f.annotationUID,u),g.handleSelectedCallback(i,f,m,"Touch");return}const h=Ld(r,c,l,"touch");if(h.length>0){const{tool:g,annotation:f}=Th(h);Ph(f.annotationUID,u),g.toolSelectedCallback(i,f,"Touch",l);return}t&&typeof t.postTouchStartCallback=="function"&&t.postTouchStartCallback(i)}function Th(i){return i.length>1&&i.find(t=>!se(t.annotation.annotationUID)&&re(t.annotation.annotationUID))||i[0]}function Ph(i,t=!1){t?es(i)?cn(i,!1):cn(i,!0,!0):cn(i,!0,!1)}function zp(i){if(U.isInteractingWithTool)return;const t=Rd(i);if(t&&!U.isMultiPartToolActive&&t.addNewAnnotation){const n=t.addNewAnnotation(i,"touch");cn(n.annotationUID)}}function jp(i){if(U.isInteractingWithTool)return;const t=Rd(i);!t||typeof t.touchDragCallback!="function"||t.touchDragCallback(i)}const Xp=Ki.bind(null,"Touch","touchEndCallback"),Fb=Ki.bind(null,"Touch","touchTapCallback"),Yp=Ki.bind(null,"Touch","touchPressCallback"),Bb=function(i){i.addEventListener(w.TOUCH_START,Hp),i.addEventListener(w.TOUCH_START_ACTIVATE,zp),i.addEventListener(w.TOUCH_DRAG,jp),i.addEventListener(w.TOUCH_END,Xp),i.addEventListener(w.TOUCH_TAP,Fb),i.addEventListener(w.TOUCH_PRESS,Yp)},Gb=function(i){i.removeEventListener(w.TOUCH_START,Hp),i.removeEventListener(w.TOUCH_START_ACTIVATE,zp),i.removeEventListener(w.TOUCH_DRAG,jp),i.removeEventListener(w.TOUCH_END,Xp),i.removeEventListener(w.TOUCH_PRESS,Yp)},qp={enable:Bb,disable:Gb},Wb=function(){z.addEventListener(w.ANNOTATION_COMPLETED,un.handleAnnotationCompleted),z.addEventListener(w.ANNOTATION_MODIFIED,un.handleAnnotationUpdate),z.addEventListener(w.ANNOTATION_REMOVED,un.handleAnnotationDelete)},$b=function(){z.removeEventListener(w.ANNOTATION_COMPLETED,un.handleAnnotationCompleted),z.removeEventListener(w.ANNOTATION_MODIFIED,un.handleAnnotationUpdate),z.removeEventListener(w.ANNOTATION_REMOVED,un.handleAnnotationDelete)},Kp={enable:Wb,disable:$b},{Active:Hb,Passive:zb,Enabled:jb}=Ot,Zp=function(i){Ni(i,[Hb,zb,jb]).forEach(n=>{n.onResetCamera&&n.onResetCamera(i)})},Xb=function(i){i.addEventListener(ut.CAMERA_RESET,Zp)},Yb=function(i){i.removeEventListener(ut.CAMERA_RESET,Zp)},Jp={enable:Xb,disable:Yb};function Nd(i){const{element:t,viewportId:n}=i.detail,e=qb(n);Kb(t),Zb(e,t),dd.addViewportElement(n,t),lf.enable(t),Mf.enable(t),bf.enable(t),Gi.enable(t),Cp.enable(t),bp.enable(t),Gp.enable(t),$p.enable(t),Jp.enable(t),Np.enable(t),Fp.enable(t),qp.enable(t),U.enabledElements.push(t)}function qb(i){const t="http://www.w3.org/2000/svg",n=document.createElementNS(t,"svg"),e=`svg-layer-${i}`;n.classList.add("svg-layer"),n.setAttribute("id",e),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.style.width="100%",n.style.height="100%",n.style.pointerEvents="none",n.style.position="absolute";const o=document.createElementNS(t,"defs"),a=document.createElementNS(t,"filter"),s=document.createElementNS(t,"feOffset"),r=document.createElementNS(t,"feColorMatrix"),c=document.createElementNS(t,"feBlend");return a.setAttribute("id",`shadow-${e}`),a.setAttribute("filterUnits","userSpaceOnUse"),s.setAttribute("result","offOut"),s.setAttribute("in","SourceGraphic"),s.setAttribute("dx","0.5"),s.setAttribute("dy","0.5"),r.setAttribute("result","matrixOut"),r.setAttribute("in","offOut"),r.setAttribute("in2","matrix"),r.setAttribute("values","0.2 0 0 0 0 0 0.2 0 0 0 0 0 0.2 0 0 0 0 0 1 0"),c.setAttribute("in","SourceGraphic"),c.setAttribute("in2","matrixOut"),c.setAttribute("mode","normal"),a.appendChild(s),a.appendChild(r),a.appendChild(c),o.appendChild(a),n.appendChild(o),n}function Kb(i){const{viewportUid:t,renderingEngineUid:n}=i.dataset,e=`${t}:${n}`;U.svgNodeCache[e]={}}function Zb(i,t){t.querySelector("div.viewport-element").appendChild(i)}function Qp(i,t){const n=[];if(!t&&!i)throw new Error("At least one of renderingEngineId or viewportId should be given");for(let e=0;e<U.synchronizers.length;e++){const o=U.synchronizers[e],a=!o.isDisabled(),s=o.hasSourceViewport(t,i),r=o.hasTargetViewport(t,i);a&&(s||r)&&n.push(o)}return n}const Jb="viewport-element";function Ud(i){const{element:t,viewportId:n}=i.detail;eT(t),nT(t),dd.removeViewportElement(n,t),lf.disable(t),Mf.disable(t),bf.disable(t),Gi.disable(t),Cp.disable(t),bp.disable(t),Gp.disable(t),$p.disable(t),Jp.disable(t),Np.disable(t),Fp.disable(t),qp.disable(t),Qb(t),tT(t),oT(t)}const Qb=i=>{const t=y(i);if(!t)return;Qp(t.viewportId,t.renderingEngineId).forEach(e=>{e.remove(t)})},tT=i=>{const t=y(i);if(!t)return;const{renderingEngineId:n,viewportId:e}=t,o=ne(e,n);o&&o.removeViewports(n,e)};function eT(i){const{viewportUid:t,renderingEngineUid:n}=i.dataset,e=`${t}:${n}`;delete U.svgNodeCache[e]}function nT(i){const t=i.querySelector(`div.${Jb}`),n=t.querySelector("svg");n&&t.removeChild(n)}const oT=function(i){const t=U.enabledElements.findIndex(n=>n===i);t>-1&&U.enabledElements.splice(t,1)};function iT(i){const t=vm(i,[Ot.Active,Ot.Passive]),n=ds(i,t);for(const{tool:e}of n){const o=e.cancel(i);if(o)return o}}class tv{constructor(t,n,e,o){this._viewportOptions={},this._onEvent=a=>{if(this._ignoreFiredEvents===!0||!this._targetViewports.length)return;const s=this._eventSource==="element"?y(a.currentTarget):At(a.detail?.viewportId);if(!s)return;const{renderingEngineId:r,viewportId:c}=s;this._sourceViewports.find(l=>l.viewportId===c)&&this.fireEvent({renderingEngineId:r,viewportId:c},a)},this._enabled=!0,this._eventName=n,this._eventHandler=e,this._ignoreFiredEvents=!1,this._sourceViewports=[],this._targetViewports=[],this._options=o||{},this._eventSource=this._options.eventSource||"element",this._auxiliaryEvents=this._options.auxiliaryEvents||[],this.id=t}isDisabled(){return!this._enabled||!this._hasSourceElements()}setOptions(t,n={}){this._viewportOptions[t]=n}setEnabled(t){this._enabled=t}getOptions(t){return this._viewportOptions[t]}add(t){this.addTarget(t),this.addSource(t)}addSource(t){if(Ds(this._sourceViewports,t))return;const{renderingEngineId:n,viewportId:e}=t,o=te(n).getViewport(e);if(!o){console.warn(`Synchronizer.addSource: No viewport for ${n} ${e}`);return}(this._eventSource==="element"?o.element:z).addEventListener(this._eventName,this._onEvent.bind(this)),this._auxiliaryEvents.forEach(({name:s,source:r})=>{(r==="element"?o.element:z).addEventListener(s,this._onEvent.bind(this))}),this._updateDisableHandlers(),this._sourceViewports.push(t)}addTarget(t){Ds(this._targetViewports,t)||(this._targetViewports.push(t),this._updateDisableHandlers())}getSourceViewports(){return this._sourceViewports}getTargetViewports(){return this._targetViewports}destroy(){this._sourceViewports.forEach(t=>this.removeSource(t)),this._targetViewports.forEach(t=>this.removeTarget(t))}remove(t){this.removeTarget(t),this.removeSource(t)}removeSource(t){const n=Mh(this._sourceViewports,t);if(n===-1)return;const e=this._eventSource==="element"?this.getViewportElement(t):z;this._sourceViewports.splice(n,1),e.removeEventListener(this._eventName,this._eventHandler),this._auxiliaryEvents.forEach(({name:o,source:a})=>{(a==="element"?this.getViewportElement(t):z).removeEventListener(o,this._eventHandler)}),this._updateDisableHandlers()}removeTarget(t){const n=Mh(this._targetViewports,t);n!==-1&&(this._targetViewports.splice(n,1),this._updateDisableHandlers())}hasSourceViewport(t,n){return Ds(this._sourceViewports,{renderingEngineId:t,viewportId:n})}hasTargetViewport(t,n){return Ds(this._targetViewports,{renderingEngineId:t,viewportId:n})}fireEvent(t,n){if(this.isDisabled()||this._ignoreFiredEvents)return;this._ignoreFiredEvents=!0;const e=[];try{for(let o=0;o<this._targetViewports.length;o++){const a=this._targetViewports[o];if(t.viewportId===a.viewportId)continue;const r=this._eventHandler(this,t,a,n,this._options);r instanceof Promise&&e.push(r)}}catch(o){console.warn(`Synchronizer, for: ${this._eventName}`,o)}finally{e.length?Promise.allSettled(e).then(()=>{this._ignoreFiredEvents=!1}):this._ignoreFiredEvents=!1}}_hasSourceElements(){return this._sourceViewports.length!==0}_updateDisableHandlers(){const t=aT(this._sourceViewports,this._targetViewports),n=this.remove.bind(this),e=o=>{n(o.detail.element)};t.forEach(o=>{const a=this.getEventSource(o);a&&(a.removeEventListener(ut.ELEMENT_DISABLED,e),a.addEventListener(ut.ELEMENT_DISABLED,e))})}getEventSource(t){return this._eventSource==="element"?this.getViewportElement(t):z}getViewportElement(t){const{renderingEngineId:n,viewportId:e}=t,o=te(n);if(!o)return null;const a=o.getViewport(e);return a?a.element:null}}function aT(i,t){const n=[],e=i.concat(t);for(let o=0;o<e.length;o++){const a=e[o];n.some(s=>a.renderingEngineId===s.renderingEngineId&&a.viewportId===s.viewportId)||n.push(a)}return n}function Mh(i,t){return i.findIndex(n=>t.renderingEngineId===n.renderingEngineId&&t.viewportId===n.viewportId)}function Ds(i,t){return i.some(n=>n.renderingEngineId===t.renderingEngineId&&n.viewportId===t.viewportId)}function si(i,t,n,e){if(U.synchronizers.some(s=>s.id===i))throw new Error(`Synchronizer with id '${i}' already exists.`);const a=new tv(i,t,n,e);return U.synchronizers.push(a),a}function sT(){for(;U.synchronizers.length>0;)U.synchronizers.pop().destroy()}function rT(i){return U.synchronizers.find(t=>t.id===i)}function cT(){return U.synchronizers}function lT(i){const t=U.synchronizers.findIndex(n=>n.id===i);t>-1&&(U.synchronizers[t].destroy(),U.synchronizers.splice(t,1))}const dT=Object.freeze(Object.defineProperty({__proto__:null,createSynchronizer:si,destroy:sT,destroySynchronizer:lT,getAllSynchronizers:cT,getSynchronizer:rT,getSynchronizersForViewport:Qp},Symbol.toStringTag,{value:"Module"})),X2=Object.freeze(Object.defineProperty({__proto__:null,Synchronizer:tv,SynchronizerManager:dT,ToolGroupManager:Ew,addEnabledElement:Nd,addTool:Jg,cancelActiveManipulations:iT,hasTool:Pw,removeEnabledElement:Ud,removeTool:Mw,get state(){return U},svgNodeCache:vr},Symbol.toStringTag,{value:"Module"})),er=function(i){const{viewportId:t}=i.detail;qi(t)},ev=function(i){const{segmentationId:t}=i.detail;Fi().filter(e=>t===e?.data?.segmentation?.segmentationId).forEach(e=>{ft(e.annotationUID)})};let al=!1;function Y2(i={}){al||(xC(i),uT(),hT(),al=!0)}function q2(){nv(),ov(),zg(),Y0();const i=Dn(),t=Vt;i.restoreAnnotations({}),t.resetState(),al=!1}function uT(){nv();const i=ut.ELEMENT_ENABLED,t=ut.ELEMENT_DISABLED;z.addEventListener(i,Nd),z.addEventListener(t,Ud),Kp.enable()}function nv(){const i=ut.ELEMENT_ENABLED,t=ut.ELEMENT_DISABLED;z.removeEventListener(i,Nd),z.removeEventListener(t,Ud),Kp.disable()}function hT(){ov(),z.addEventListener(w.ANNOTATION_COMPLETED,Ep),z.addEventListener(w.ANNOTATION_MODIFIED,Sp),z.addEventListener(w.ANNOTATION_SELECTION_CHANGE,tr),z.addEventListener(w.ANNOTATION_SELECTION_CHANGE,tr),z.addEventListener(w.ANNOTATION_REMOVED,_p),z.addEventListener(w.SEGMENTATION_MODIFIED,wp),z.addEventListener(w.SEGMENTATION_DATA_MODIFIED,Ip),z.addEventListener(w.SEGMENTATION_REPRESENTATION_MODIFIED,er),z.addEventListener(w.SEGMENTATION_REPRESENTATION_ADDED,er),z.addEventListener(w.SEGMENTATION_REMOVED,ev)}function ov(){z.removeEventListener(w.ANNOTATION_COMPLETED,Ep),z.removeEventListener(w.ANNOTATION_MODIFIED,Sp),z.removeEventListener(w.ANNOTATION_SELECTION_CHANGE,tr),z.removeEventListener(w.ANNOTATION_SELECTION_CHANGE,tr),z.removeEventListener(w.ANNOTATION_REMOVED,_p),z.removeEventListener(w.SEGMENTATION_MODIFIED,wp),z.removeEventListener(w.SEGMENTATION_DATA_MODIFIED,Ip),z.removeEventListener(w.SEGMENTATION_REPRESENTATION_MODIFIED,er),z.removeEventListener(w.SEGMENTATION_REPRESENTATION_ADDED,er),z.removeEventListener(w.SEGMENTATION_REMOVED,ev)}const K2=Object.freeze(Object.defineProperty({__proto__:null,COLOR_LUT:Qs},Symbol.toStringTag,{value:"Module"})),Z2="4.14.4";function gT(i,t,n,e){const{camera:o}=e.detail,a=te(n.renderingEngineId);if(!a)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const s=a.getViewport(n.viewportId);s.setCamera(o),s.render()}const{CAMERA_MODIFIED:fT}=ut;function mT(i){return si(i,fT,gT)}function pT(i,t,n,e,o){const a=te(n.renderingEngineId);if(!a)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const s=a.getViewport(n.viewportId),c=a.getViewport(t.viewportId).getViewPresentation(o);s.setViewPresentation(c),s.render()}const{CAMERA_MODIFIED:vT}=ut;function IT(i,t){return si(i,vT,pT,{viewPresentation:t})}function wT(i,t,n,e,o){const a=e.detail,{volumeId:s,range:r,invertStateChanged:c,invert:l,colormap:d}=a,u=te(n.renderingEngineId);if(!u)throw new Error(`Rendering Engine does not exist: ${n.renderingEngineId}`);const h=u.getViewport(n.viewportId),g={voiRange:r};if(o?.syncInvertState&&c&&(g.invert=l),o?.syncColormap&&d&&(g.colormap=d),h instanceof ve)h._actors&&h._actors.size>1?h.setProperties(g,s):h.setProperties(g);else if(h instanceof Ie)h.setProperties(g);else throw new Error("Viewport type not supported.");h.render()}function CT(i,t){return t=Object.assign({syncInvertState:!0,syncColormap:!0},t),si(i,ut.VOI_MODIFIED,wT,{auxiliaryEvents:[{name:ut.COLORMAP_MODIFIED}],...t})}function ET(i,t,n){const e=te(n.renderingEngineId);if(!e)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const o=i.getOptions(n.viewportId),a=e.getViewport(n.viewportId),s=e.getViewport(t.viewportId);if(o?.syncZoom!==!1){const r=s.getZoom();a.setZoom(r)}if(o?.syncPan!==!1){const r=s.getPan();a.setPan(r)}a.render()}const{CAMERA_MODIFIED:ST}=ut;function _T(i){return si(i,ST,ET)}function DT(i,t){const{viewPlaneNormal:n}=i.getCamera(),{viewPlaneNormal:e}=t.getCamera(),o=dt(n,e);return Math.abs(o)>.9}const xh=(i,t)=>JI.get("spatialRegistrationModule",i,t);async function iv(i,t,n){const e=te(n.renderingEngineId);if(!e)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const o=e.getViewport(t.viewportId),a=i.getOptions(n.viewportId);if(a?.disabled)return;const s=e.getViewport(n.viewportId),r=o.getCurrentImageId(),l=ye("imagePlaneModule",r).imagePositionPatient,d=s.getImageIds();if(!DT(o,s))return;let u=xh(n.viewportId,t.viewportId);if(!u){const m=o.getFrameOfReferenceUID(),v=s.getFrameOfReferenceUID();if(m===v&&a?.useInitialPosition!==!1?u=So(mr()):(QI(o,s),u=xh(n.viewportId,t.viewportId)),!u)return}const h=Se(W(),l,u),g=bT(h,d);let f=g.index;s instanceof ae&&(f=d.length-g.index-1),g.index!==-1&&s.getCurrentImageIdIndex()!==g.index&&await xg(s.element,{imageIndex:f})}function bT(i,t){return t.reduce((n,e,o)=>{const{imagePositionPatient:a}=ye("imagePlaneModule",e),s=Te(a,i);return s<n.distance?{distance:s,index:o}:n},{distance:1/0,index:-1})}const{STACK_NEW_IMAGE:TT,VOLUME_NEW_IMAGE:J2}=ut;function av(i){return si(i,TT,iv,{auxiliaryEvents:[{name:"VOLUME_NEW_IMAGE"}]})}function PT(i,t,n){const e=te(n.renderingEngineId);if(!e)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const o=e.getViewport(n.viewportId),s=e.getViewport(t.viewportId).getSlabThickness?.();s&&(o.setSlabThickness?.(s),o.render())}const{CAMERA_MODIFIED:MT}=ut;function xT(i){return si(i,MT,PT)}const yT=av,Q2=Object.freeze(Object.defineProperty({__proto__:null,createCameraPositionSynchronizer:mT,createImageSliceSynchronizer:av,createPresentationViewSynchronizer:IT,createSlabThicknessSynchronizer:xT,createStackImageSynchronizer:yT,createVOISynchronizer:CT,createZoomPanSynchronizer:_T,imageSliceSyncCallback:iv},Symbol.toStringTag,{value:"Module"}));function AT(i,t,n=5){const e=y(i);if(!e)throw new Error("getAnnotationNearPoint: enabledElement not found");return sv(e,t,n)}function sv(i,t,n){const{renderingEngineId:e,viewportId:o}=i,a=ne(o,e);if(!a)return null;const{_toolInstances:s}=a;for(const r in s){const c=OT(s[r],i,t,n);if(c)return c}return null}function OT(i,t,n,e){const{viewport:o}=t,a=Ct(i.constructor.toolName,o?.element),s=o?.getCurrentImageId?.();if(a?.length){const{element:r}=t.viewport;for(const c of a){const l=c.metadata?.referencedImageId;if(!(s&&l&&s!==l||!i.isPointNearTool)&&(i.isPointNearTool(r,c,n,e,"")||i.getHandleNearImagePoint(r,c,n,e)))return c}}return null}const{calibratedPixelSpacingMetadataProvider:LT}=Rt;function RT(i,t,n){typeof n=="number"&&(n={type:t0.USER,scale:n}),LT.add(i,n),t.getStackViewports().forEach(o=>{o.getImageIds().includes(i)&&o.calibrateSpacing(i)})}function rv(i,t){const n=i.findIndex(([e,o])=>e===o);if(n===-1)throw new Error("3D bounding boxes not supported in an oblique plane");return i[n][0]-=t,i[n][1]+=t,i}const NT=Object.freeze(Object.defineProperty({__proto__:null,extend2DBoundingBoxInViewAxis:rv,getBoundingBoxAroundShape:Do,getBoundingBoxAroundShapeIJK:Do,getBoundingBoxAroundShapeWorld:lC},Symbol.toStringTag,{value:"Module"})),{transformWorldToIndex:wc}=Rt;function cv(i,t,n){const[e,o]=i,a=wt((e[0]+o[0])/2,(e[1]+o[1])/2,(e[2]+o[2])/2),s=Te(e,o)/2,{boundsIJK:r,topLeftWorld:c,bottomRightWorld:l}=kT(t,n,i,a,s);return{boundsIJK:r,centerWorld:a,radiusWorld:s,topLeftWorld:c,bottomRightWorld:l}}function lv(i,t){const n=t.getDirection(),e=wt(n[0],n[1],n[2]),o=wt(n[3],n[4],n[5]),a=wt(n[6],n[7],n[8]),s=yg(W(),a);return cv(i,t,{row:e,column:o,normal:s})}function UT(i,t,n){if(!n)throw new Error("viewport is required in order to calculate the sphere bounds");const e=n.getCamera(),o=wt(e.viewUp[0],e.viewUp[1],e.viewUp[2]),a=wt(e.viewPlaneNormal[0],e.viewPlaneNormal[1],e.viewPlaneNormal[2]),s=W();be(s,o,a);const r={row:s,normal:a,column:yg(W(),o)};return cv(i,t,r)}function kT(i,t,n,e,o){const a=i.getDimensions(),{row:s,column:r,normal:c}=t,l=W(),d=W();Wt(l,e,c,o),Wt(d,e,c,-o),Wt(l,l,r,-o),Wt(d,d,r,o),Wt(l,l,s,-o),Wt(d,d,s,o);const u=wc(i,l),h=wc(i,d),g=n.map(m=>wc(i,m));return{boundsIJK:Do([u,h,...g],a),topLeftWorld:l,bottomRightWorld:d}}function dv(i,t=5){return parseFloat(i[0]).toFixed(t)+","+parseFloat(i[1]).toFixed(t)+","+parseFloat(i[2]).toFixed(t)+","}class VT{static setStartRange(t,n,e=t.getCurrentImageIdIndex()){this.setRange(t,n,e)}static setEndRange(t,n,e=t.getCurrentImageIdIndex()){this.setRange(t,n,void 0,e)}static setRange(t,n,e,o){const{metadata:a}=n;e===void 0&&(e=a.sliceIndex<o?a.sliceIndex:0,o===void 0&&(o=t.getNumberOfSlices()-1));const s=t.getSliceIndexForImage(a.multiSliceReference);o===void 0&&(o=s>=e?s:t.getNumberOfSlices()-1),o=Math.max(e,o),a.sliceIndex=Math.min(e,o),a.referencedImageId=t.getCurrentImageId(a.sliceIndex),a.referencedImageURI=void 0,o===a.sliceIndex?a.multiSliceReference=void 0:o!==a.multiSliceReference?.sliceIndex&&(a.multiSliceReference={referencedImageId:t.getCurrentImageId(o),sliceIndex:o});const r={viewportId:t.id,renderingEngineId:t.renderingEngineId,changeType:lt.MetadataReferenceModified,annotation:n};gt(z,w.ANNOTATION_MODIFIED,r),this.setViewportFrameRange(t,a)}static setSingle(t,n,e=t.getCurrentImageIdIndex()){this.setRange(t,n,e,e)}static getFrameRange(t){const{metadata:n}=t,{sliceIndex:e,multiSliceReference:o}=n,a=o?.sliceIndex;return a?[e+1,a+1]:e+1}static getFrameRangeStr(t){const n=this.getFrameRange(t);return Array.isArray(n)?`${n[0]}-${n[1]}`:String(n)}static setViewportFrameRange(t,n){t.setFrameRange&&n.multiSliceReference?.sliceIndex&&t.setFrameRange(n.sliceIndex+1,n.multiSliceReference.sliceIndex+1)}}function uv(i,t,n){const{imageData:e}=i,{overwrite:o,boundsIJK:a,segmentationId:s}=n;if(!s)throw new Error("Segmentation ID is required to be passed inside thresholdVolumeByRange as options");const r=n?.overlapType||0,c=i.voxelManager,l=i.voxelManager.getScalarDataLength();if(o)for(let C=0;C<l;C++)c.setAtIndex(C,0);const{baseVolumeIdx:d,volumeInfoList:u}=Lf(i,t);let h,g,f;const m=(C,E,S)=>{const _=({value:O})=>{g=g+1,O>=f.lower&&O<=f.upper&&(h=h+1)},{imageData:D,dimensions:b,lower:M,upper:P}=C,T=Wl(D,b,E,S);g=0,h=0,f={lower:M,upper:P};let x=!1;const{voxelManager:A}=D.get("voxelManager");return A.forEach(_,{imageData:D,boundsIJK:T}),r===0?x=h>0:r==1&&(x=h===g),x},v=(C,E)=>{const{imageData:S,lower:_,upper:D}=C,b=S.get("voxelManager").voxelManager,M=b.toIndex(E),P=b.getAtIndex(M);return!(P<=_||P>=D)},p=({index:C,pointIJK:E,pointLPS:S})=>{let _=u.length>0;for(let D=0;D<u.length&&(u[D].volumeSize===l?_=v(u[D],E):_=m(u[D],u[d].spacing,S),!!_);D++);_&&c.setAtIndex(C,n.segmentIndex||1)};return i.voxelManager.forEach(p,{imageData:e,boundsIJK:a}),Pe(n.segmentationId),i}const{transformWorldToIndex:yh}=Rt,wi=class wi extends zt{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{storePointData:!1,shadow:!0,preventHandleOutsideImage:!1,calculateStats:!0,getTextLines:FT,statsCalculator:Un}}){super(t,n),this.addNewAnnotation=e=>{const o=e.detail,{currentPoints:a,element:s}=o,r=a.world,c=y(s),{viewport:l}=c;this.isDrawing=!0;const d=this.constructor.createAnnotationForViewport(l,{data:{handles:{points:[[...r],[...r],[...r],[...r]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},cachedStats:{}}});mt(d,s);const u=Q(s,this.getToolName());return this.editData={annotation:d,viewportIdsToRender:u,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(s),nt(s),e.preventDefault(),L(u),d},this.isPointNearTool=(e,o,a,s)=>{const r=y(e),{viewport:c}=r,{data:l}=o,{points:d}=l.handles,u=c.worldToCanvas(d[0]),h=c.worldToCanvas(d[3]),g=this._getRectangleImageCoordinates([u,h]),f=[a[0],a[1]],{left:m,top:v,width:p,height:I}=g;return rd([m,v,p,I],f)<=s},this.toolSelectedCallback=(e,o)=>{const a=e.detail,{element:s}=a;o.highlighted=!0;const r=Q(s,this.getToolName());this.editData={annotation:o,viewportIdsToRender:r,movingTextBox:!1},this._activateModify(s),nt(s);const c=y(s),{renderingEngine:l}=c;L(r),e.preventDefault()},this.handleSelectedCallback=(e,o,a)=>{const s=e.detail,{element:r}=s,{data:c}=o;o.highlighted=!0;let l=!1,d;a.worldPosition?l=!0:d=c.handles.points.findIndex(f=>f===a);const u=Q(r,this.getToolName());this.editData={annotation:o,viewportIdsToRender:u,handleIndex:d,movingTextBox:l},this._activateModify(r),nt(r);const h=y(r),{renderingEngine:g}=h;L(u),e.preventDefault()},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c,hasMoved:l}=this.editData,{data:d}=s;c&&!l||(d.handles.activeHandleIndex=null,this._deactivateModify(a),this._deactivateDraw(a),ht(a),this.doneEditMemo(),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(s.annotationUID),L(r),c&&Lt(s))},this._dragCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,handleIndex:c,movingTextBox:l,newAnnotation:d}=this.editData;this.createMemo(a,s,{newAnnotation:d});const{data:u}=s;if(l){const{deltaPoints:h}=o,g=h.world,{textBox:f}=u.handles,{worldPosition:m}=f;m[0]+=g[0],m[1]+=g[1],m[2]+=g[2],f.hasMoved=!0}else if(c===void 0){const{deltaPoints:h}=o,g=h.world,{points:f}=u.handles;f.forEach(m=>{m[0]+=g[0],m[1]+=g[1],m[2]+=g[2]}),s.invalidated=!0}else{const{currentPoints:h}=o,g=y(a),{worldToCanvas:f,canvasToWorld:m}=g.viewport,v=h.world,{points:p}=u.handles;p[c]=[...v];let I,C,E,S,_,D,b,M;switch(c){case 0:case 3:I=f(p[0]),S=f(p[3]),C=[S[0],I[1]],E=[I[0],S[1]],D=m(C),b=m(E),p[1]=D,p[2]=b;break;case 1:case 2:C=f(p[1]),E=f(p[2]),I=[E[0],C[1]],S=[C[0],E[1]],_=m(I),M=m(S),p[0]=_,p[3]=M;break}s.invalidated=!0}this.editData.hasMoved=!0,y(a),L(r),s.invalidated&&It(s,a,lt.HandlesUpdated)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),ht(e);const{annotation:o,viewportIdsToRender:a,newAnnotation:s}=this.editData,{data:r}=o;return o.highlighted=!1,r.handles.activeHandleIndex=null,L(a),s&&Lt(o),this.editData=null,o.annotationUID}},this._activateDraw=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_MOVE,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_MOVE,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this._activateModify=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e,{element:r}=s;let c=Ct(this.getToolName(),r);if(!c?.length||(c=this.filterInteractableAnnotationsForElement(r,c),!c?.length))return a;const l=this.getTargetId(s),d=s.getRenderingEngine(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let h=0;h<c.length;h++){const g=c[h],{annotationUID:f,data:m}=g,{points:v,activeHandleIndex:p}=m.handles,I=v.map(H=>s.worldToCanvas(H));u.annotationUID=f;const{color:C,lineWidth:E,lineDash:S}=this.getAnnotationStyle({annotation:g,styleSpecifier:u}),{viewPlaneNormal:_,viewUp:D}=s.getCamera();if(!m.cachedStats[l]||m.cachedStats[l].areaUnit==null)m.cachedStats[l]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(g,_,D,d,e);else if(g.invalidated&&(this._throttledCalculateCachedStats(g,_,D,d,e),s instanceof ae)){const{referencedImageId:H}=g.metadata;for(const G in m.cachedStats)G.startsWith("imageId")&&d.getStackViewports().find(j=>{const K=Je(H),it=j.hasImageURI(K),at=Je(j.getCurrentImageId());return it&&at!==K})&&delete m.cachedStats[G]}if(!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;let b;if(!re(f))continue;!se(f)&&!this.editData&&p!==null&&p!==void 0&&(b=[I[p]]);const M=!!Ve("showHandlesAlways",{});(b||M)&&$t(o,f,"0",M?I:b,{color:C});const P=`${f}-rect`;ld(o,f,"0",I,{color:C,lineDash:S,lineWidth:E},P),a=!0;const x=this.getLinkedTextBoxStyle(u,g);if(!x.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const A=this.configuration.getTextLines(m,l);if(!A||A.length===0)continue;if(!m.handles.textBox.hasMoved){const H=qe(I);m.handles.textBox.worldPosition=s.canvasToWorld(H)}const O=s.worldToCanvas(m.handles.textBox.worldPosition),N=Oe(o,f,"1",A,O,I,{},x),{x:k,y:B,width:V,height:$}=N;m.handles.textBox.worldBoundingBox={topLeft:s.canvasToWorld([k,B]),topRight:s.canvasToWorld([k+V,B]),bottomLeft:s.canvasToWorld([k,B+$]),bottomRight:s.canvasToWorld([k+V,B+$])}}return a},this._getRectangleImageCoordinates=e=>{const[o,a]=e;return{left:Math.min(o[0],a[0]),top:Math.min(o[1],a[1]),width:Math.abs(o[0]-a[0]),height:Math.abs(o[1]-a[1])}},this._calculateCachedStats=(e,o,a,s,r)=>{if(!this.configuration.calculateStats)return;const{data:c}=e,{viewport:l}=r,{element:d}=l,u=c.handles.points[0],h=c.handles.points[3],{cachedStats:g}=c,f=Object.keys(g);for(let v=0;v<f.length;v++){const p=f[v],I=this.getTargetImageData(p);if(!I)continue;const{dimensions:C,imageData:E,metadata:S,voxelManager:_}=I,D=yh(E,u);D[0]=Math.floor(D[0]),D[1]=Math.floor(D[1]),D[2]=Math.floor(D[2]);const b=yh(E,h);if(b[0]=Math.floor(b[0]),b[1]=Math.floor(b[1]),b[2]=Math.floor(b[2]),this._isInsideVolume(D,b,C)){this.isHandleOutsideImage=!1;const M=Math.min(D[0],b[0]),P=Math.max(D[0],b[0]),T=Math.min(D[1],b[1]),x=Math.max(D[1],b[1]),A=Math.min(D[2],b[2]),O=Math.max(D[2],b[2]),R=[[M,P],[T,x],[A,O]],{worldWidth:N,worldHeight:k}=kr(o,a,u,h),B=[D,b],{scale:V,areaUnit:$}=nn(I,B),H=Math.abs(N*k)/(V*V),G={isPreScaled:io(l,p),isSuvScaled:this.isSuvScaled(l,p,e.metadata.referencedImageId)},Y=so(S.Modality,e.metadata.referencedImageId,G);let q;_&&(q=_.forEach(this.configuration.statsCalculator.statsCallback,{boundsIJK:R,imageData:E,returnPoints:this.configuration.storePointData}));const j=this.configuration.statsCalculator.getStatistics();g[p]={Modality:S.Modality,area:H,mean:j.mean?.value,stdDev:j.stdDev?.value,max:j.max?.value,min:j.min?.value,statsArray:j.array,pointsInShape:q,areaUnit:$,modalityUnit:Y}}else this.isHandleOutsideImage=!0,g[p]={Modality:S.Modality}}const m=e.invalidated;return e.invalidated=!1,m&&It(e,d,lt.StatsUpdated),g},this._isInsideVolume=(e,o,a)=>we(e,a)&&we(o,a),this._throttledCalculateCachedStats=Fe(this._calculateCachedStats,100,{trailing:!0})}};wi.toolName="RectangleROI",wi.hydrate=(t,n,e)=>{const o=At(t);if(!o)return;const{FrameOfReferenceUID:a,referencedImageId:s,viewPlaneNormal:r,instance:c,viewport:l}=wi.hydrateBase(wi,o,n,e),{toolInstance:d,...u}=e||{},h={annotationUID:e?.annotationUID||Xt(),data:{handles:{points:n,activeHandleIndex:null},label:"",cachedStats:{}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:c.getToolName(),viewPlaneNormal:r,FrameOfReferenceUID:a,referencedImageId:s,...u}};mt(h,l.element),L([l.id])};let nr=wi;function FT(i,t){const n=i.cachedStats[t],{area:e,mean:o,max:a,stdDev:s,areaUnit:r,modalityUnit:c,min:l}=n;if(o==null)return;const d=[];return le(e)&&d.push(`Area: ${_t(e)} ${r}`),le(o)&&d.push(`Mean: ${_t(o)} ${c}`),le(a)&&d.push(`Max: ${_t(a)} ${c}`),le(l)&&d.push(`Min: ${_t(l)} ${c}`),le(s)&&d.push(`Std Dev: ${_t(s)} ${c}`),d}const{transformWorldToIndex:ca}=Rt;class hv extends nr{constructor(t={},n={configuration:{storePointData:!1,numSlicesToPropagate:10,calculatePointsInsideVolume:!0,getTextLines:BT,statsCalculator:Un,showTextBox:!1,throttleTimeout:100}}){super(t,n),this.addNewAnnotation=e=>{const o=e.detail,{currentPoints:a,element:s}=o,r=a.world,c=y(s),{viewport:l,renderingEngine:d}=c;this.isDrawing=!0;const u=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=u;let f,m,v;if(l instanceof Ie)throw new Error("Stack Viewport Not implemented");{const D=this.getTargetId(l);v=To(D),m=X.getVolume(v),f=qa(m,r,h)}const p=yl(m,h),I=this._getStartCoordinate(r,h),C=this._getEndCoordinate(r,p,h),E=l.getFrameOfReferenceUID(),S={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...h],enabledElement:c,viewUp:[...g],FrameOfReferenceUID:E,referencedImageId:f,toolName:this.getToolName(),volumeId:v,spacingInNormal:p},data:{label:"",startCoordinate:I,endCoordinate:C,cachedStats:{pointsInVolume:[],projectionPoints:[],projectionPointsImageIds:[f],statistics:[]},handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...r],[...r],[...r],[...r]],activeHandleIndex:null},labelmapUID:null}};this._computeProjectionPoints(S,m),mt(S,s);const _=Q(s,this.getToolName());return this.editData={annotation:S,viewportIdsToRender:_,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(s),nt(s),e.preventDefault(),L(_),S},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c,hasMoved:l}=this.editData,{data:d}=s;if(c&&!l)return;d.handles.activeHandleIndex=null,this._deactivateModify(a),this._deactivateDraw(a),ht(a);const{metadata:u}=s,{enabledElement:h}=u;this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(s.annotationUID);const g=this.getTargetId(h.viewport),f=X.getVolume(g.split(/volumeId:|\?/)[1]);this._computePointsInsideVolume(s,g,f,h),L(r),c?Lt(s):It(s,a)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e;let r=Ct(this.getToolName(),s.element);if(!r?.length)return a;r=Vr(r,s.getCamera());const c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let l=0;l<r.length;l++){const d=r[l],{annotationUID:u,data:h,metadata:g}=d,{startCoordinate:f,endCoordinate:m}=h,{points:v,activeHandleIndex:p}=h.handles,{enabledElement:I}=g,C=v.map($=>s.worldToCanvas($));c.annotationUID=u;const E=this.getStyle("lineWidth",c,d),S=this.getStyle("lineDash",c,d),_=this.getStyle("color",c,d),D=s.getCamera().focalPoint,b=s.getCamera().viewPlaneNormal;let M=f,P=m;if(Array.isArray(f)){M=this._getCoordinateForViewplaneNormal(M,b);const $=this._getIndexOfCoordinatesForViewplaneNormal(b);h.handles.points.forEach(H=>{H[$]=M}),h.startCoordinate=M}Array.isArray(m)&&(P=this._getCoordinateForViewplaneNormal(P,b),h.endCoordinate=P,h.endCoordinate=P);const T=Fo(M),x=Fo(P),A=this._getCoordinateForViewplaneNormal(D,b),O=Fo(A);if(O<Math.min(T,x)||O>Math.max(T,x))continue;const R=I.viewport?.volumeIds.values();for(const $ of R)d.invalidated&&d.metadata.volumeId===$&&this._throttledCalculateCachedStats(d,I);let N=!1;if((O===T||O===x)&&(N=!0),!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;let k;if(!re(u))continue;!se(u)&&!this.editData&&p!==null&&N&&(k=[C[p]]),k&&$t(o,u,"0",k,{color:_});let B=S;if(N||(B=2),is(o,u,"0",C[0],C[3],{color:_,lineDash:B,lineWidth:E}),a=!0,this.configuration.showTextBox){const $=this.getLinkedTextBoxStyle(c,d);if(!$.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const H=this.configuration.getTextLines(h,{metadata:g});if(!H||H.length===0)continue;if(!h.handles.textBox.hasMoved){const bt=qe(C);h.handles.textBox.worldPosition=s.canvasToWorld(bt)}const G=s.worldToCanvas(h.handles.textBox.worldPosition),q=Oe(o,u,"1",H,G,C,{},$),{x:j,y:K,width:it,height:at}=q;h.handles.textBox.worldBoundingBox={topLeft:s.canvasToWorld([j,K]),topRight:s.canvasToWorld([j+it,K]),bottomLeft:s.canvasToWorld([j,K+at]),bottomRight:s.canvasToWorld([j+it,K+at])}}}return a},this.configuration.calculatePointsInsideVolume?this._throttledCalculateCachedStats=Fe(this._calculateCachedStatsTool,this.configuration.throttleTimeout,{trailing:!0}):this._throttledCalculateCachedStats=zi(this._calculateCachedStatsTool,this.configuration.throttleTimeout)}_computeProjectionPoints(t,n){const{data:e,metadata:o}=t,{viewPlaneNormal:a,spacingInNormal:s}=o,{imageData:r}=n,{startCoordinate:c,endCoordinate:l}=e,{points:d}=e.handles,u=ca(r,d[0]),h=ca(r,d[0]),g=W();r.indexToWorldVec3(u,g);const f=W();r.indexToWorldVec3(h,f);const m=this._getIndexOfCoordinatesForViewplaneNormal(a);m==2?(g[2]=c,f[2]=l):m==0?(g[0]=c,f[0]=l):m==1&&(g[1]=c,f[1]=l);const v=W();oe(v,f,g);const p=We(v);Zt(v,v);const I=[];for(let C=0;C<p;C+=s)I.push(d.map(E=>{const S=W();return Wt(S,E,v,C),Array.from(S)}));e.cachedStats.projectionPoints=I}_computePointsInsideVolume(t,n,e,o){const{data:a,metadata:s}=t,{viewPlaneNormal:r,viewUp:c}=s,{viewport:l}=o,d=a.cachedStats.projectionPoints,u=[[]],h=this.getTargetImageData(n),g=a.handles.points[0],f=a.handles.points[3],{worldWidth:m,worldHeight:v}=kr(r,c,g,f),p=nn(h,a.habdles),I=Math.abs(m*v)/(p.scale*p.scale),C={isPreScaled:io(l,n),isSuvScaled:this.isSuvScaled(l,n,t.metadata.referencedImageId)},E=so(s.Modality,t.metadata.referencedImageId,C);for(let _=0;_<d.length;_++){if(!e)continue;const D=d[_][0],{dimensions:b,imageData:M,voxelManager:P}=e,T=ca(M,g),x=ca(M,D),A=this._getIndexOfCoordinatesForViewplaneNormal(r);T[0]=Math.floor(T[0]),T[1]=Math.floor(T[1]),T[2]=Math.floor(T[2]),T[A]=x[A];const O=ca(M,f);if(O[0]=Math.floor(O[0]),O[1]=Math.floor(O[1]),O[2]=Math.floor(O[2]),O[A]=x[A],this._isInsideVolume(T,O,b)){this.isHandleOutsideImage=!1;const R=Math.min(T[0],O[0]),N=Math.max(T[0],O[0]),k=Math.min(T[1],O[1]),B=Math.max(T[1],O[1]),V=Math.min(T[2],O[2]),$=Math.max(T[2],O[2]),H=[[R,N],[k,B],[V,$]],G=P.forEach(this.configuration.statsCalculator.statsCallback,{boundsIJK:H,imageData:M,returnPoints:this.configuration.storePointData});u.push(G)}}const S=this.configuration.statsCalculator.getStatistics();a.cachedStats.pointsInVolume=u,a.cachedStats.statistics={Modality:s.Modality,area:I,mean:S.mean?.value,stdDev:S.stdDev?.value,max:S.max?.value,statsArray:S.array,areaUnit:p.areaUnit,modalityUnit:E}}_calculateCachedStatsTool(t,n){const e=t.data,{viewport:o}=n,{cachedStats:a}=e,s=this.getTargetId(o),r=X.getVolume(s.split(/volumeId:|\?/)[1]);return this._computeProjectionPoints(t,r),this._computePointsInsideVolume(t,s,r,n),t.invalidated=!1,It(t,o.element),a}_getStartCoordinate(t,n){const e=t;return this._getCoordinateForViewplaneNormal(e,n)}_getEndCoordinate(t,n,e){const o=this.configuration.numSlicesToPropagate,a=W();return Wt(a,t,e,o*n),this._getCoordinateForViewplaneNormal(a,e)}_getIndexOfCoordinatesForViewplaneNormal(t){const n=[Math.abs(t[0]),Math.abs(t[1]),Math.abs(t[2])];return n.indexOf(Math.max(...n))}_getCoordinateForViewplaneNormal(t,n){const e=this._getIndexOfCoordinatesForViewplaneNormal(n);return t[e]}}function BT(i,t={}){const n=i.cachedStats.statistics,{area:e,mean:o,max:a,stdDev:s,areaUnit:r,modalityUnit:c}=n;if(o===void 0)return;const l=[];return l.push(`Area: ${_t(e)} ${r}`),l.push(`Mean: ${_t(o)} ${c}`),l.push(`Max: ${_t(a)} ${c}`),l.push(`Std Dev: ${_t(s)} ${c}`),l}hv.toolName="RectangleROIStartEndThreshold";class gv extends nr{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(t,n),this.addNewAnnotation=e=>{const o=e.detail,{currentPoints:a,element:s}=o,r=a.world,c=y(s),{viewport:l,renderingEngine:d}=c;this.isDrawing=!0;const u=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=u,f=this.getTargetId(l);let m,v;if(l instanceof Ie)m=f.split("imageId:")[1];else{v=To(f);const E=X.getVolume(v);m=qa(E,r,h)}const p=l.getFrameOfReferenceUID(),I={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...h],enabledElement:c,viewUp:[...g],FrameOfReferenceUID:p,referencedImageId:m,toolName:this.getToolName(),volumeId:v},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...r],[...r],[...r],[...r]],activeHandleIndex:null},segmentationId:null}};mt(I,s);const C=Q(s,this.getToolName());return this.editData={annotation:I,viewportIdsToRender:C,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(s),nt(s),e.preventDefault(),L(C),I},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e,{element:r}=s;let c=Ct(this.getToolName(),r);if(!c?.length||(c=this.filterInteractableAnnotationsForElement(r,c),!c?.length))return a;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let d=0;d<c.length;d++){const u=c[d],{annotationUID:h,data:g}=u,{points:f,activeHandleIndex:m}=g.handles,v=f.map(_=>s.worldToCanvas(_));l.annotationUID=h;const p=this.getStyle("lineWidth",l,u),I=this.getStyle("lineDash",l,u),C=this.getStyle("color",l,u);if(!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;It(u,r);let E;if(!re(h))continue;!se(h)&&!this.editData&&m!==null&&(E=[v[m]]),E&&$t(o,h,"0",E,{color:C}),is(o,h,"0",v[0],v[3],{color:C,lineDash:I,lineWidth:p}),a=!0}return a}}}gv.toolName="RectangleROIThreshold";function fv(i,t,n={}){const e=[];return i.forEach(a=>{const{data:s}=a,{points:r}=s.handles,{imageData:c,dimensions:l}=t;let d=r;if(s.cachedStats?.projectionPoints){const{projectionPoints:g}=s.cachedStats;d=[].concat(...g)}const u=d.map(g=>xe(c,g));let h=Do(u,l);n.numSlicesToProject&&!s.cachedStats?.projectionPoints&&(h=rv(h,n.numSlicesToProject)),e.push(h)}),e.length===1?e[0]:e.reduce((a,s)=>({iMin:Math.min(a.iMin,s.iMin),jMin:Math.min(a.jMin,s.jMin),kMin:Math.min(a.kMin,s.kMin),iMax:Math.max(a.iMax,s.iMax),jMax:Math.max(a.jMax,s.jMax),kMax:Math.max(a.kMax,s.kMax)}),{iMin:1/0,jMin:1/0,kMin:1/0,iMax:-1/0,jMax:-1/0,kMax:-1/0})}function GT(i,t,n,e){const o=i.map(r=>En.getAnnotation(r));WT(o);let a;for(let r=0;r<n.length;r++)(n[r].volume.voxelManager.getScalarDataLength()===t.voxelManager.getScalarDataLength()||r===0)&&(a=fv(o,n[r].volume,e));const s=uv(t,n,{...e,boundsIJK:a,segmentationId:e.segmentationId});return s.modified(),s}function WT(i){const t=[gv.toolName,hv.toolName];for(const n of i){const e=n.metadata.toolName;if(!t.includes(e))throw new Error("rectangleROIThresholdVolumeByRange only supports RectangleROIThreshold and RectangleROIStartEndThreshold annotations")}}function mv(i,t=1,n="mergedLabelmap"){i.forEach(({direction:l,dimensions:d,origin:u,spacing:h})=>{if(!Pt(d,i[0].dimensions)||!Pt(l,i[0].direction)||!Pt(h,i[0].spacing)||!Pt(u,i[0].origin))throw new Error("labelmaps must have the same size and shape")});const e=i[0],o=e.voxelManager.getConstructor(),a=new o(e.voxelManager.getScalarDataLength());i.forEach(l=>{const d=l.voxelManager,u=d.getScalarDataLength();for(let h=0;h<u;h++)d.getAtIndex(h)===t&&(a[h]=t)});const s={scalarData:a,metadata:e.metadata,spacing:e.spacing,origin:e.origin,direction:e.direction,dimensions:e.dimensions},r=X.getVolume(n);let c;return r?(c=r,c.voxelManager.setCompleteScalarDataArray(a)):c=Ag(n,s),c}async function $T(i){const{viewportId:t,renderingEngineId:n,options:e}=i;let{segmentationId:o}=i;const a=Gt(t,n);if(!a)throw new Error("element disabled");const{viewport:s}=a;if(!(s instanceof ae))throw new Error("Segmentation only supports VolumeViewport");const{uid:r}=s.getDefaultActor();if(o===void 0&&(o=`${r}-based-segmentation-${e?.volumeId??Xt().slice(0,8)}`),e){const c=structuredClone(e);await Ag(o,c)}else{const c=s.getVolumeId();pr(c,{volumeId:o})}return o}function kd(i,t,n={}){const e=n.onFlood,o=n.onBoundary,a=n.equals,s=n.filter,r=n.diagonals||!1,c=S(t),l=_(),d=[],u=[],h=new Set,g=n.bounds;for(d.push({currentArgs:t});d.length>0;)f(d.pop());return{flooded:u};function f(b){const M=b.currentArgs,P=b.previousArgs;m(M)||(v(M),p(M)?(I(M),E(M)):C(P))}function m(b){const[M,P,T=0]=b,x=M+32768+65536*(P+32768+65536*(T+32768));return h.has(x)}function v(b){const[M,P,T=0]=b,x=M+32768+65536*(P+32768+65536*(T+32768));h.add(x)}function p(b){const M=S(b);return a?a(M,c):M===c}function I(b){u.push(b),e&&e(...b)}function C(b){const[M,P,T=0]=b,x=M+32768+65536*(P+32768+65536*(T+32768));g?.set(x,b),o&&o(...b)}function E(b){for(let M=0;M<l.length;M+=1){const P=l[M],T=b.slice(0);for(let x=0;x<b.length;x+=1)T[x]+=P[x];s?.(T)!==!1&&(m(T)||d.push({currentArgs:T,previousArgs:b}))}}function S(b){return i(...b)}function _(){return D(t.length).filter(function(M){const P=HT(M);return P!==0&&(P===1||r)})}function D(b){const M=[],P=function(T){return T.split("").map(function(x){return parseInt(x,10)-1})};for(let T=0;T<Math.pow(3,b);T+=1){const x=zT(T.toString(3),"0",b);M.push(P(x))}return M}}function HT(i){let t=0;for(let n=0;n<i.length;n+=1)i[n]!==0&&(t+=1);return t}function zT(i,t,n){return(new Array(n+1).join(t)+i).slice(-n)}const jT={[J.OnInteractionStart]:i=>{const{segmentIndex:t,previewSegmentIndex:n,segmentationVoxelManager:e,centerIJK:o,viewPlaneNormal:a,segmentationImageData:s,configuration:r}=i;if(!r?.useCenterSegmentIndex){i.centerSegmentIndexInfo.segmentIndex=null,i.centerSegmentIndexInfo.hasSegmentIndex=!1,i.centerSegmentIndexInfo.hasPreviewIndex=!1;return}let c=!1,l=!1;const d=[...e.getBoundsIJK()];Math.abs(a[0])>.8?d[0]=[o[0],o[0]]:Math.abs(a[1])>.8?d[1]=[o[1],o[1]]:Math.abs(a[2])>.8&&(d[2]=[o[2],o[2]]);const u=({value:g})=>{c||=g===t,l||=g===n};if(e.forEach(u,{imageData:s,isInObject:i.isInObject,boundsIJK:d}),!c&&!l){i.centerSegmentIndexInfo.segmentIndex=null;return}const h=e.getAtIJKPoint(o);i.centerSegmentIndexInfo.segmentIndex=h,i.centerSegmentIndexInfo.hasSegmentIndex=c,i.centerSegmentIndexInfo.hasPreviewIndex=l}},XT={[J.Initialize]:i=>{const{operationName:t,centerIJK:n,segmentationVoxelManager:e,imageVoxelManager:o,configuration:a,segmentIndex:s,viewport:r}=i;if(!a?.threshold?.isDynamic||!n||!s||t===J.RejectPreview||t===J.OnInteractionEnd)return;const c=e.getBoundsIJK(),{range:l,dynamicRadius:d=0}=a.threshold,u=l?0:d,{viewPlaneNormal:h}=r.getCamera(),g=c.map((p,I)=>{const[C,E]=p;return[Math.max(C,n[I]-u),Math.min(E,n[I]+u)]});Math.abs(h[0])>.8?g[0]=[n[0],n[0]]:Math.abs(h[1])>.8?g[1]=[n[1],n[1]]:Math.abs(h[2])>.8&&(g[2]=[n[2],n[2]]);const f=l||[1/0,-1/0],m=u*u,v=({value:p,pointIJK:I})=>{if($c(n,I)>m)return;const E=Array.isArray(p)?ks(p):p;f[0]=Math.min(E,f[0]),f[1]=Math.max(E,f[1])};o.forEach(v,{boundsIJK:g}),a.threshold.range=f},[J.OnInteractionStart]:i=>{const{configuration:t}=i;t?.threshold?.isDynamic&&(t.threshold.range=null)},[J.ComputeInnerCircleRadius]:i=>{const{configuration:t,viewport:n}=i,e=t?.threshold;if(!e)return;const{dynamicRadius:o=0,isDynamic:a}=e;if(!a){e.dynamicRadiusInCanvas=0;return}if(o===0)return;const s=n.getImageData();if(!s)return;const{spacing:r}=s,c=[n.element.clientWidth/2,n.element.clientHeight/2],l=o*r[0],u=n.canvasToWorld(c).map(f=>f+l),h=n.worldToCanvas(u),g=Math.abs(c[0]-h[0]);e.dynamicRadiusInCanvas||(e.dynamicRadiusInCanvas=0),e.dynamicRadiusInCanvas=3+g}},YT={[J.Initialize]:i=>{i.segmentIndex=0}},{isEqual:Cc}=Rt,Ah={toIJK:i=>i,fromIJK:i=>i,type:"acquistion"},qT={toIJK:([i,t,n])=>[n,i,t],fromIJK:([i,t,n])=>[t,n,i],type:"jk"},KT={toIJK:([i,t,n])=>[i,n,t],fromIJK:([i,t,n])=>[i,n,t],type:"ik"};function pv(i,t){if(!(i instanceof ve))return{...Ah,boundsIJKPrime:t};const{viewPlaneNormal:n}=i.getCamera(),e=Cc(Math.abs(n[0]),1)&&qT||Cc(Math.abs(n[1]),1)&&KT||Cc(Math.abs(n[2]),1)&&Ah;return e?{...e,boundsIJKPrime:e.fromIJK(t)}:{toIJK:null,boundsIJKPrime:null,fromIJK:null,error:`Only mappings orthogonal to acquisition plane are permitted, but requested ${n}`}}const{RLEVoxelMap:ZT,VoxelManager:JT}=Rt,QT=65535;var Me;(function(i){i[i.SEGMENT=-1]="SEGMENT",i[i.ISLAND=-2]="ISLAND",i[i.INTERIOR=-3]="INTERIOR",i[i.EXTERIOR=-4]="EXTERIOR",i[i.INTERIOR_SMALL=-5]="INTERIOR_SMALL",i[i.INTERIOR_TEST=-6]="INTERIOR_TEST"})(Me||(Me={}));class Jo{constructor(t){this.fillInternalEdge=!1,this.maxInternalRemove=128,this.maxInternalRemove=t?.maxInternalRemove??this.maxInternalRemove,this.fillInternalEdge=t?.fillInternalEdge??this.fillInternalEdge}initialize(t,n,e){const o=!!n.sourceVoxelManager,a=o?n.sourceVoxelManager:n,s=o?n:JT.createRLEHistoryVoxelManager(a),{segmentIndex:r=1,previewSegmentIndex:c=1}=e,l=e.points||a.getPoints();if(!l?.length)return;const d=a.getBoundsIJK().map((E,S)=>[Math.min(E[0],...l.map(_=>_[S])),Math.max(E[1],...l.map(_=>_[S]))]);if(d.find(E=>E[0]<0||E[1]>QT))return;const{toIJK:u,fromIJK:h,boundsIJKPrime:g,error:f}=pv(t,d);if(f){console.warn("Not performing island removal for planes not orthogonal to acquisition plane",f);return}const[m,v,p]=h(a.dimensions),I=new ZT(m,v,p),C=(E,S,_)=>{const D=a.toIndex(u([E,S,_])),b=a.getAtIndex(D);if(b===c||b===r)return Me.SEGMENT};return I.fillFrom(C,g),I.normalizer={toIJK:u,fromIJK:h,boundsIJKPrime:g},this.segmentSet=I,this.previewVoxelManager=s,this.segmentIndex=r,this.previewSegmentIndex=c??r,this.selectedPoints=l,!0}floodFillSegmentIsland(){const{selectedPoints:t,segmentSet:n}=this;let e=0;const{fromIJK:o}=n.normalizer;return t.forEach(a=>{const s=o(a),r=n.toIndex(s),[c,l,d]=s;n.get(r)===Me.SEGMENT&&(e+=n.floodFill(c,l,d,Me.ISLAND))}),e}removeExternalIslands(){const{previewVoxelManager:t,segmentSet:n}=this,{toIJK:e}=n.normalizer,o=(a,s)=>{const[,r,c]=n.toIJK(a);if(s.value!==Me.ISLAND)for(let l=s.start;l<s.end;l++){const d=e([l,r,c]),u=t.getAtIJKPoint(d);t.setAtIJKPoint(d,u===void 0?0:null)}};n.forEach(o,{rowModified:!0})}removeInternalIslands(){const{segmentSet:t,previewVoxelManager:n,previewSegmentIndex:e}=this,{height:o,normalizer:a,width:s}=t,{toIJK:r}=a;return t.forEachRow((c,l)=>{let d;for(const u of[...l])if(u.value===Me.ISLAND){if(!d){if(this.fillInternalEdge&&u.start>0)for(let h=0;h<u.start;h++)t.set(c+h,Me.INTERIOR);d=u;continue}for(let h=d.end;h<u.start;h++)t.set(c+h,Me.INTERIOR);d=u}if(this.fillInternalEdge&&d?.end<s)for(let u=d.end;u<s;u++)t.set(c+u,Me.INTERIOR)}),t.forEach((c,l)=>{if(l.value!==Me.INTERIOR)return;const[,d,u]=t.toIJK(c),h=d>0?t.getRun(d-1,u):null,g=d+1<o?t.getRun(d+1,u):null,f=d===o-1,m=d===0,v=Jo.covers(l,h)||m&&this.fillInternalEdge,p=Jo.covers(l,g)||f&&this.fillInternalEdge;l.end-l.start>2&&(!v||!p)&&t.floodFill(l.start,d,u,Me.EXTERIOR,{singlePlane:!0})}),t.forEach((c,l)=>{if(l.value!==Me.INTERIOR)return;const[,d,u]=t.toIJK(c),f=t.floodFill(l.start,d,u,Me.INTERIOR_TEST)>this.maxInternalRemove?Me.EXTERIOR:Me.INTERIOR_SMALL;t.floodFill(l.start,d,u,f)}),t.forEach((c,l)=>{if(l.value===Me.INTERIOR_SMALL)for(let d=l.start;d<l.end;d++){const u=r(t.toIJK(c+d));n.setAtIJKPoint(u,e)}}),n.getArrayOfModifiedSlices()}static covers(t,n){if(!n)return!1;let{start:e}=t;const{end:o}=t;for(const a of n)if(e>=a.start&&e<a.end&&(e=a.end,e>=o))return!0;return!1}}const tP={[J.OnInteractionEnd]:i=>{const{previewSegmentIndex:t,segmentIndex:n,viewport:e,segmentationVoxelManager:o,activeStrategy:a,memo:s}=i;if(a!=="THRESHOLD_INSIDE_SPHERE_WITH_ISLAND_REMOVAL"||n===null)return;const r=new Jo,c=s?.voxelManager||o;if(!r.initialize(e,c,{previewSegmentIndex:t,segmentIndex:n}))return;r.floodFillSegmentIsland(),r.removeExternalIslands(),r.removeInternalIslands();const l=c.getArrayOfModifiedSlices();l&&Pe(i.segmentationId,l,t)}},eP={[J.Preview]:function(i){const{previewSegmentIndex:t,configuration:n,enabledElement:e}=i;if(!t||!n)return;this.onInteractionStart?.(e,i);const o=this.fill(e,i);return o&&this.onInteractionEnd?.(e,i),o},[J.Initialize]:i=>{const{segmentIndex:t,previewColor:n,previewSegmentIndex:e}=i;if(i.modified=!1,e==null||t==null)return;oi(i.segmentationId)?.forEach(a=>{gp(a,i.segmentationId,e,n)}),i.modified=!0},[J.AcceptPreview]:i=>{const{previewSegmentIndex:t,segmentationVoxelManager:n,memo:e,segmentIndex:o,centerSegmentIndexInfo:a}=i||{},{changedIndices:s}=a||{},r=e,c=({index:l})=>{const d=n.getAtIndex(l);s?.length>0?s.includes(l)&&r.voxelManager.setAtIndex(l,0):d===t&&r.voxelManager.setAtIndex(l,o)};n.forEach(c),Pe(i.segmentationId,n.getArrayOfModifiedSlices(),o),i.centerSegmentIndexInfo.changedIndices=[]},[J.RejectPreview]:i=>{i&&e0.undoIf(t=>{const n=t;if(!n?.voxelManager)return!1;const{segmentationVoxelManager:e}=n;let o=!1;const a=({value:s})=>{s===i.previewSegmentIndex&&(o=!0)};return e.forEach(a),o})}},nP={[J.Fill]:i=>{const{segmentsLocked:t,segmentationImageData:n,segmentationVoxelManager:e,brushStrategy:o,centerIJK:a}=i,s=o.createIsInThreshold?.(i),{setValue:r}=o,c=s?l=>{const{value:d,index:u}=l;t.includes(d)||!s(u)||r(i,l)}:l=>r(i,l);e.forEach(c,{imageData:n,isInObject:i.isInObject,boundsIJK:i.isInObjectBoundsIJK}),e.addPoint(a)}};function oP({operationData:i,existingValue:t,index:n}){const{previewSegmentIndex:e,memo:o,centerSegmentIndexInfo:a,previewOnHover:s,segmentIndex:r}=i,{hasPreviewIndex:c,hasSegmentIndex:l,segmentIndex:d}=a;if(d===0&&l&&c){if(t===r||s)return;if(t===e){o.voxelManager.setAtIndex(n,0);return}return}if(d===0&&l&&!c){if(t===0||t!==r)return;o.voxelManager.setAtIndex(n,e),a.changedIndices.push(n);return}if(d===0&&!l&&c){if(t===r||s)return;if(t===e){o.voxelManager.setAtIndex(n,0);return}return}if(d===0&&!l&&!c){if(t===r)return;if(t===e){o.voxelManager.setAtIndex(n,e);return}return}if(d===e&&l&&c){if(t===r)return;o.voxelManager.setAtIndex(n,e);return}if(d===e&&!l&&c){if(t===r)return;o.voxelManager.setAtIndex(n,e);return}if(d===r&&l&&c){if(t===r)return;o.voxelManager.setAtIndex(n,e);return}if(d===r&&l&&!c){if(t===r)return;o.voxelManager.setAtIndex(n,e);return}}const iP={[J.INTERNAL_setValue]:(i,{value:t,index:n})=>{const{segmentsLocked:e,previewSegmentIndex:o,memo:a,segmentationVoxelManager:s,centerSegmentIndexInfo:r,segmentIndex:c}=i,l=s.getAtIndex(n);if(!e.includes(t)&&!(!r&&l===c)&&!(r?.segmentIndex!==0&&l===c)){if(r?.segmentIndex===null){a.voxelManager.setAtIndex(n,o??c);return}if(!o){let d=c;r&&(d=r.segmentIndex),a.voxelManager.setAtIndex(n,d);return}oP({operationData:i,existingValue:l,index:n})}}},aP={[J.CreateIsInThreshold]:i=>{const{imageVoxelManager:t,segmentIndex:n,configuration:e}=i;if(!(!e||!n))return o=>{const a=t.getAtIndex(o),s=Array.isArray(a)?We(a):a,{threshold:r}=e||{};return r?.range?.length?r.range[0]<=s&&s<=r.range[1]:!0}}},Oh=10;function or(){return{maxIJKs:[]}}function vv(i,t){const{value:n}=t,{maxIJKs:e}=i,o=e.length;if(typeof n!="number"||o>=Oh&&n<e[0].value)return;const a={value:t.value,pointLPS:t.pointLPS?[t.pointLPS[0],t.pointLPS[1],t.pointLPS[2]]:void 0,pointIJK:t.pointIJK?[t.pointIJK[0],t.pointIJK[1],t.pointIJK[2]]:void 0};if(!o||n>=e[o-1].value)e.push(a);else for(let s=0;s<o;s++)if(n<=e[s].value){e.splice(s,0,a);break}o>=Oh&&e.splice(0,1)}function Iv(i,t,n){const{spacing:e,calibration:o}=n,{volumeUnit:a}=nn({calibration:o,hasPixelSpacing:!0},[]),s=e?e[0]*e[1]*e[2]:1;return t.volume={value:Array.isArray(t.count.value)?t.count.value.map(r=>r*s):t.count.value*s,unit:a,name:"volume",label:"Volume"},t.maxIJKs=i.maxIJKs.filter(r=>r.pointIJK!==void 0),t.array.push(t.volume),i.maxIJKs=[],t}const tu=class tu extends Un{static statsInit(t){super.statsInit(t),this.volumetricState=or()}static statsCallback(t){super.statsCallback(t),vv(this.volumetricState,t)}static getStatistics(t){const n={...t,unit:t?.unit||"none",calibration:t?.calibration,hasPixelSpacing:t?.hasPixelSpacing},e=super.getStatistics(n);return Iv(this.volumetricState,e,n)}};tu.volumetricState=or();let jo=tu;class Lh extends am{constructor(t){super(t),this.volumetricState=or()}statsInit(t){super.statsInit(t),this.volumetricState=or()}statsCallback(t){super.statsCallback(t),vv(this.volumetricState,t)}getStatistics(t){const n={...t,unit:t?.unit||"none",calibration:t?.calibration,hasPixelSpacing:t?.hasPixelSpacing},e=super.getStatistics(n);return Iv(this.volumetricState,e,n)}}const sP=Math.pow(3*1e3/(4*Math.PI),1/3);async function wv({segmentationId:i,segmentIndices:t,mode:n="collective"}){Wr(),kn(Qe.COMPUTE_STATISTICS,0);const e=rp(i,t);if(!e)return;const{operationData:o,segVolumeId:a,segImageIds:s,reconstructableVolume:r,indices:c}=e,{refImageId:l,modalityUnitOptions:d}=TD(a,s),u=pp(l,d);return r?await rP({operationData:o,indices:c,unit:u,mode:n}):await cP({segImageIds:s,indices:c,unit:u,mode:n})}async function rP({operationData:i,indices:t,unit:n,mode:e}){const o=cp(i),{segmentationVoxelManager:a,imageVoxelManager:s,segmentationImageData:r,imageData:c}=o;if(!a||!r)return;const l=r.getSpacing(),{boundsIJK:d}=a;if(!d)return jo.getStatistics({spacing:l});const h={scalarData:a.getCompleteScalarDataArray(),dimensions:r.getDimensions(),spacing:r.getSpacing(),origin:r.getOrigin(),direction:r.getDirection()},g={scalarData:s.getCompleteScalarDataArray(),dimensions:c.getDimensions(),spacing:c.getSpacing(),origin:c.getOrigin(),direction:c.getDirection()};if(!g.scalarData?.length)return;const f=await ti().executeTask("compute","calculateSegmentsStatisticsVolume",{segmentationInfo:h,imageInfo:g,indices:t,unit:n,mode:e});if(kn(Qe.COMPUTE_STATISTICS,100),e==="collective")return ir({stats:f,unit:n,spacing:l,segmentationImageData:r,imageVoxelManager:s});{const m={};return Object.entries(f).forEach(([v,p])=>{m[v]=ir({stats:p,unit:n,spacing:l,segmentationImageData:r,imageVoxelManager:s})}),m}}const Ec=(i,t)=>{if(!i.array)return;const n=i.array.findIndex(e=>e.name===t.name);n!==-1?i.array[n]=t:i.array.push(t)},ir=({stats:i,unit:t,spacing:n,segmentationImageData:e,imageVoxelManager:o})=>{if(i.mean.unit=t,i.max.unit=t,i.min.unit=t,t!=="SUV")return i;const a=n.map(s=>Math.max(1,Math.round(1.1*sP/s)));for(const s of i.maxIJKs){const r=lP(s,a,e,o,n);if(!r)continue;const{mean:c}=r;(!i.peakValue||i.peakValue.value<=c.value)&&(i.peakValue={name:"peakValue",label:"Peak Value",value:c.value,unit:t},i.peakPoint={name:"peakLPS",label:"Peak SUV Point",value:s.pointLPS?[...s.pointLPS]:null,unit:null},Ec(i,i.peakValue),Ec(i,i.peakPoint))}if(i.volume&&i.mean){const s=i.volume.value,r=i.mean.value;i.lesionGlycolysis={name:"lesionGlycolysis",label:"Lesion Glycolysis",value:s*r,unit:`${i.volume.unit}${t}`},Ec(i,i.lesionGlycolysis)}return i};async function cP({segImageIds:i,indices:t,unit:n,mode:e}){kn(Qe.COMPUTE_STATISTICS,0);const{segmentationInfo:o,imageInfo:a}=lp(i),s=await ti().executeTask("compute","calculateSegmentsStatisticsStack",{segmentationInfo:o,imageInfo:a,indices:t,mode:e});kn(Qe.COMPUTE_STATISTICS,100);const r=o[0].spacing,c=o[0],l=a[0].voxelManager;if(e==="collective")return ir({stats:s,unit:n,spacing:r,segmentationImageData:c,imageVoxelManager:l});{const d={};return Object.entries(s).forEach(([u,h])=>{d[u]=ir({stats:h,unit:n,spacing:r,segmentationImageData:c,imageVoxelManager:l})}),d}}function lP(i,t,n,e,o){const{pointIJK:a,pointLPS:s}=i;if(!a)return;const r=a.map((d,u)=>[d-t[u],d+t[u]]),c=(d,u)=>{const h=(u[0]-a[0])/t[0],g=(u[1]-a[1])/t[1],f=(u[2]-a[2])/t[2];return h*h+g*g+f*f<=1},l=({pointIJK:d,pointLPS:u})=>{const h=e.getAtIJKPoint(d);h!==void 0&&jo.statsCallback({value:h,pointLPS:u,pointIJK:d})};return jo.statsInit({storePointData:!1}),n0(n,{pointInShapeFn:c,callback:l,boundsIJK:r}),jo.getStatistics({spacing:o})}const dP={[J.GetStatistics]:function(i,t,n){const{indices:e}=n,{segmentationId:o,viewport:a}=t;wv({segmentationId:o,segmentIndices:e})}},uP={[J.CalculateCursorGeometry]:function(i,t){if(!t)return;const{configuration:n,activeStrategy:e,hoverData:o}=t,{viewport:a}=i,s=a.getCamera(),{brushSize:r}=n,c=wt(s.viewUp[0],s.viewUp[1],s.viewUp[2]),l=wt(s.viewPlaneNormal[0],s.viewPlaneNormal[1],s.viewPlaneNormal[2]),d=W();be(d,c,l);const{canvasToWorld:u}=a,{centerCanvas:h}=o,g=u([h[0],h[1]]),f=W(),m=W(),v=W(),p=W();for(let S=0;S<=2;S++)f[S]=g[S]-c[S]*r,m[S]=g[S]+c[S]*r,v[S]=g[S]-d[S]*r,p[S]=g[S]+d[S]*r;if(!o)return;const{brushCursor:I}=o,{data:C}=I;C.handles===void 0&&(C.handles={}),C.handles.points=[f,m,v,p];const E=n.strategies[e];typeof E?.computeInnerCircleRadius=="function"&&E.computeInnerCircleRadius({configuration:n,viewport:a}),C.invalidated=!1},[J.RenderCursor]:function(i,t,n){if(!t)return;const{configuration:e,hoverData:o}=t,{viewport:a}=i,{brushCursor:s}=o,r=s.metadata;if(!r)return;const c=r.brushCursorUID,l=s.data,{points:d}=l.handles,u=d.map(C=>a.worldToCanvas(C)),h=u[0],g=u[1],f=[Math.floor((h[0]+g[0])/2),Math.floor((h[1]+g[1])/2)],m=Math.abs(h[1]-Math.floor((h[1]+g[1])/2)),v=`rgb(${r.segmentColor?.slice(0,3)||[0,0,0]})`;if(!a.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");return}Ae(n,c,"0",f,m,{color:v,lineDash:this.centerSegmentIndexInfo.segmentIndex===0?[1,2]:null});const{dynamicRadiusInCanvas:I}=e?.threshold||{dynamicRadiusInCanvas:0};I&&Ae(n,c,"1",f,I,{color:v})}},St={determineSegmentIndex:jT,dynamicThreshold:XT,erase:YT,islandRemoval:tP,preview:eP,regionFill:nP,setValue:iP,threshold:aP,labelmapStatistics:dP,ensureSegmentationVolumeFor3DManipulation:ap,ensureImageVolumeFor3DManipulation:sp,circularCursor:uP},Uo=class Uo{constructor(t,...n){this._initialize=[],this._fill=[],this._onInteractionStart=[],this.fill=(a,s)=>{const r=this.initialize(a,s,J.Fill);if(!r)return;this._fill.forEach(d=>d(r));const{segmentationVoxelManager:c,segmentIndex:l}=r;return Pe(r.segmentationId,c.getArrayOfModifiedSlices(),l),r},this.onInteractionStart=(a,s)=>{const r=this.initialize(a,s);r&&this._onInteractionStart.forEach(c=>c.call(this,r))},this.addPreview=(a,s)=>{const r=this.initialize(a,s,J.AddPreview);if(r)return r},this.configurationName=t;const e=n.find(a=>a.hasOwnProperty(J.CalculateCursorGeometry)),o=n.find(a=>a.hasOwnProperty(J.RenderCursor));e||n.push({[J.CalculateCursorGeometry]:St.circularCursor.calculateCursorGeometry}),o||n.push({[J.RenderCursor]:St.circularCursor.renderCursor}),this.compositions=n,n.forEach(a=>{const s=typeof a=="function"?a():a;if(s)for(const r in s){if(!Uo.childFunctions[r])throw new Error(`Didn't find ${r} as a brush strategy`);Uo.childFunctions[r](this,s[r])}}),this.strategyFunction=(a,s)=>this.fill(a,s);for(const a of Object.keys(Uo.childFunctions))this.strategyFunction[a]=this[a]}initialize(t,n,e){const{viewport:o}=t,a=Od({operationData:n,viewport:o,strategy:this});if(!a)return null;const{imageVoxelManager:s,segmentationVoxelManager:r,segmentationImageData:c}=a,l=n.createMemo(n.segmentationId,r),d={operationName:e,...n,segmentIndex:n.segmentIndex,enabledElement:t,imageVoxelManager:s,segmentationVoxelManager:r,segmentationImageData:c,viewport:o,centerWorld:null,isInObject:null,isInObjectBoundsIJK:null,brushStrategy:this,memo:l};return this._initialize.forEach(u=>u(d)),d}};Uo.COMPOSITIONS=St,Uo.childFunctions={[J.OnInteractionStart]:fn(J.OnInteractionStart,J.Initialize),[J.OnInteractionEnd]:fn(J.OnInteractionEnd,J.Initialize),[J.Fill]:fn(J.Fill),[J.Initialize]:fn(J.Initialize),[J.CreateIsInThreshold]:fi(J.CreateIsInThreshold),[J.Interpolate]:fn(J.Interpolate,J.Initialize),[J.AcceptPreview]:fn(J.AcceptPreview,J.Initialize),[J.RejectPreview]:fn(J.RejectPreview,J.Initialize),[J.INTERNAL_setValue]:fi(J.INTERNAL_setValue),[J.Preview]:fi(J.Preview,!1),[J.ComputeInnerCircleRadius]:fn(J.ComputeInnerCircleRadius),[J.EnsureSegmentationVolumeFor3DManipulation]:fn(J.EnsureSegmentationVolumeFor3DManipulation),[J.EnsureImageVolumeFor3DManipulation]:fn(J.EnsureImageVolumeFor3DManipulation),[J.AddPreview]:fn(J.AddPreview),[J.GetStatistics]:fi(J.GetStatistics),[J.CalculateCursorGeometry]:fi(J.CalculateCursorGeometry,!0),[J.RenderCursor]:fi(J.RenderCursor,!0),compositions:null};let _n=Uo;function fn(i,t){const n=`_${i}`;return(e,o)=>{e[n]||=[],e[n].push(o),e[i]||=t?(a,s,...r)=>{const c=e[t](a,s,i);let l;return e[n].forEach(d=>{const u=d.call(e,c,...r);l||=u}),l}:(a,...s)=>{e[n].forEach(r=>r.call(e,a,...s))}}}function fi(i,t=!0){return(n,e)=>{if(n[i])throw new Error(`The singleton method ${i} already exists`);n[i]=t?e:(o,a,...s)=>(a.enabledElement=o,e.call(n,a,...s))}}function Cv(i,t){const{center:n,radius:e}=i,o=i.radius2||e*e;return(t[0]-n[0])*(t[0]-n[0])+(t[1]-n[1])*(t[1]-n[1])+(t[2]-n[2])*(t[2]-n[2])<=o}const{transformWorldToIndex:Rh,transformIndexToWorld:Nh,isEqual:hP}=Rt;function Ev(i){const[t,n,e,o]=i,a=[e[0],n[1]],s=[o[0],t[1]],r=[e[0],t[1]],c=[o[0],n[1]];return[a,s,r,c]}function gP(i,t,n,e){const o=wt(i[0],i[1],i[2]),a=W();Wt(a,o,t,e);const s=W();Wt(s,o,t,-e);const r=W();Wt(r,o,n,e);const c=W();return Wt(c,o,n,-e),[s,a,c,r]}function fP(i,t){if(!i.length||t<=0)return null;const n=t*t,e=i.map(a=>[a[0],a[1],a[2]]),o=[];for(let a=1;a<e.length;a++){const s=e[a-1],r=e[a],c=r[0]-s[0],l=r[1]-s[1],d=r[2]-s[2],u=c*c+l*l+d*d;o.push({start:s,vector:[c,l,d],lengthSquared:u})}return a=>{if(!a)return!1;for(const s of e){const r=a[0]-s[0],c=a[1]-s[1],l=a[2]-s[2];if(r*r+c*c+l*l<=n)return!0}for(const{start:s,vector:r,lengthSquared:c}of o){if(c===0){const E=a[0]-s[0],S=a[1]-s[1],_=a[2]-s[2];if(E*E+S*S+_*_<=n)return!0;continue}const l=a[0]-s[0],d=a[1]-s[1],u=a[2]-s[2],h=l*r[0]+d*r[1]+u*r[2],g=Math.max(0,Math.min(1,h/c)),f=s[0]+r[0]*g,m=s[1]+r[1]*g,v=s[2]+r[2]*g,p=a[0]-f,I=a[1]-m,C=a[2]-v;if(p*p+I*I+C*C<=n)return!0}return!1}}const Sv={[J.Initialize]:i=>{const{points:t,viewport:n,segmentationImageData:e,viewUp:o,viewPlaneNormal:a}=i;if(!t)return;const s=W();t.length>=2?(je(s,t[0],t[1]),hn(s,s,.5)):Og(s,t[0]),i.centerWorld=s,i.centerIJK=Rh(e,s);const r=t.length>=2?Te(t[0],t[1])/2:0,c=t.map(C=>n.worldToCanvas(C)),d=Ev(c).map(C=>n.canvasToWorld(C)),u=wt(o[0],o[1],o[2]);Zt(u,u);const h=wt(a[0],a[1],a[2]);Zt(h,h);const g=W();be(g,u,h),Zt(g,g);const m=(i.strokePointsWorld&&i.strokePointsWorld.length>0?i.strokePointsWorld:[i.centerWorld]).map(C=>xn(C)),p=m.flatMap(C=>gP(C,u,g,r)).map(C=>Rh(e,C)),I=Do(p,e.getDimensions());i.strokePointsWorld=m,i.isInObject=_v(d,{strokePointsWorld:m,segmentationImageData:e,radius:r}),i.isInObjectBoundsIJK=I}};function _v(i=[],t={}){if(!i||i.length!==4)throw new Error("createPointInEllipse: cornersInWorld must have 4 points");const[n,e,o,a]=i,s=W();je(s,n,e),hn(s,s,.5);const r=W();oe(r,a,n);const c=We(r)/2;Zt(r,r);const l=W();oe(l,o,n);const d=We(l)/2;Zt(l,l);const u=W();be(u,r,l),Zt(u,u);const h=t.radius??Math.max(c,d),g=fP(t.strokePointsWorld||[],h);if(hP(c,d)){const f=c,m={center:s,radius:f,radius2:f*f};return(v,p)=>{let I=v;return!I&&p&&t.segmentationImageData&&(I=Nh(t.segmentationImageData,p)),I?g?.(I)?!0:Cv(m,I):!1}}return(f,m)=>{let v=f;if(!v&&m&&t.segmentationImageData&&(v=Nh(t.segmentationImageData,m)),!v)return!1;if(g?.(v))return!0;const p=W();oe(p,v,s);const I=dt(p,u),C=W();Wt(C,p,u,-I);const E=W(),S=W();oe(S,s,n),oe(E,C,S);const _=dt(E,r),D=dt(E,l);return _*_/(c*c)+D*D/(d*d)<=1}}const Dv=new _n("Circle",St.regionFill,St.setValue,Sv,St.determineSegmentIndex,St.preview,St.labelmapStatistics),mP=new _n("CircleThreshold",St.regionFill,St.setValue,Sv,St.determineSegmentIndex,St.dynamicThreshold,St.threshold,St.preview,St.islandRemoval,St.labelmapStatistics),Xr=Dv.strategyFunction,pP=mP.strategyFunction;function vP(){throw new Error("Not yet implemented")}const{transformWorldToIndex:Uh}=Rt,IP={[J.Initialize]:i=>{const{points:t,viewport:n,segmentationImageData:e}=i;if(!t)return;const o=W();t.length>=2?(je(o,t[0],t[1]),hn(o,o,.5)):Og(o,t[0]),i.centerWorld=o,i.centerIJK=Uh(e,o);const a=UT(t.slice(0,2),e,n),s=t.map(m=>n.worldToCanvas(m)),c=Ev(s).map(m=>n.canvasToWorld(m)),l=t.length>=2?Te(t[0],t[1])/2:void 0,d=i.strokePointsWorld&&i.strokePointsWorld.length>0?i.strokePointsWorld:[i.centerWorld],u=a.boundsIJK,h=i.centerIJK,f=d.reduce((m,v)=>{if(!v)return m;const p=Uh(e,v),I=[p[0]-h[0],p[1]-h[1],p[2]-h[2]],C=[[u[0][0]+I[0],u[0][1]+I[0]],[u[1][0]+I[1],u[1][1]+I[1]],[u[2][0]+I[2],u[2][1]+I[2]]];return m?[[Math.min(m[0][0],C[0][0]),Math.max(m[0][1],C[0][1])],[Math.min(m[1][0],C[1][0]),Math.max(m[1][1],C[1][1])],[Math.min(m[2][0],C[2][0]),Math.max(m[2][1],C[2][1])]]:C},null)??a.boundsIJK;if(e){const m=e.getDimensions();i.isInObjectBoundsIJK=[[Math.max(0,Math.min(f[0][0],m[0]-1)),Math.max(0,Math.min(f[0][1],m[0]-1))],[Math.max(0,Math.min(f[1][0],m[1]-1)),Math.max(0,Math.min(f[1][1],m[1]-1))],[Math.max(0,Math.min(f[2][0],m[2]-1)),Math.max(0,Math.min(f[2][1],m[2]-1))]]}else i.isInObjectBoundsIJK=f;i.isInObject=_v(c,{strokePointsWorld:i.strokePointsWorld,segmentationImageData:e,radius:l})}},Yr=new _n("Sphere",St.regionFill,St.setValue,IP,St.determineSegmentIndex,St.preview,St.labelmapStatistics,St.ensureSegmentationVolumeFor3DManipulation),bv=Yr.strategyFunction,wP=new _n("SphereThreshold",...Yr.compositions,St.dynamicThreshold,St.threshold,St.ensureSegmentationVolumeFor3DManipulation,St.ensureImageVolumeFor3DManipulation),CP=new _n("SphereThreshold",...Yr.compositions,St.dynamicThreshold,St.threshold,St.islandRemoval,St.ensureSegmentationVolumeFor3DManipulation,St.ensureImageVolumeFor3DManipulation),EP=wP.strategyFunction,SP=CP.strategyFunction,_P=new _n("EraseSphere",St.erase,...Yr.compositions),Tv=_P.strategyFunction,DP=new _n("EraseCircle",St.erase,...Dv.compositions),Pv=DP.strategyFunction,{VoxelManager:sl,RLEVoxelMap:bP}=Rt;function rl(i,t){return xv(i,t)}function Mv(i){const{segmentationVoxelManager:t,undoVoxelManager:n,redoVoxelManager:e}=this,o=i===!1?e:n;o.forEach(({value:s,pointIJK:r})=>{t.setAtIJKPoint(r,s)});const a=o.getArrayOfModifiedSlices();Pe(this.segmentationId,a)}function xv(i,t){const n=sl.createRLEHistoryVoxelManager(t);return{segmentationId:i,restoreMemo:Mv,commitMemo:TP,segmentationVoxelManager:t,voxelManager:n,id:Xt(),operationType:"labelmap"}}function TP(){if(this.redoVoxelManager)return!0;if(!this.voxelManager.modifiedSlices.size)return!1;const{segmentationVoxelManager:i}=this,t=sl.createRLEHistoryVoxelManager(i);bP.copyMap(t.map,this.voxelManager.map);for(const e of this.voxelManager.modifiedSlices.keys())t.modifiedSlices.add(e);this.undoVoxelManager=t;const n=sl.createRLEVolumeVoxelManager({dimensions:this.segmentationVoxelManager.dimensions});return this.redoVoxelManager=n,t.forEach(({index:e,pointIJK:o,value:a})=>{const s=i.getAtIJKPoint(o);s!==a&&n.setAtIndex(e,s)}),!0}const PP=Object.freeze(Object.defineProperty({__proto__:null,createLabelmapMemo:rl,createRleMemo:xv,restoreMemo:Mv},Symbol.toStringTag,{value:"Module"})),{transformWorldToIndex:yv}=Rt,Av={[J.Initialize]:i=>{const{points:t,viewport:n,segmentationImageData:e}=i;if(!t)return;const o=wt(0,0,0);t.forEach(r=>{je(o,o,r)}),hn(o,o,1/t.length),i.centerWorld=o,i.centerIJK=yv(e,o);const{boundsIJK:a,pointInShapeFn:s}=MP(n,t,e);i.isInObject=s,i.isInObjectBoundsIJK=a}};function MP(i,t,n){let e=t.map(C=>yv(n,C));e=e.map(C=>C.map(E=>Math.round(E)));const o=Do(e,n.getDimensions()),[a,s,r,c]=t,l=W(),d=W();oe(l,s,a),oe(d,c,a);const u=We(l),h=We(d);Zt(l,l),Zt(d,d);const g=W();be(g,l,d),Zt(g,g);const f=n.getDirection(),m=n.getSpacing(),{viewPlaneNormal:v}=i.getCamera(),p=yl({direction:f,spacing:m},v);return{boundsIJK:o,pointInShapeFn:C=>{const E=W();oe(E,C,a);const S=dt(E,l),_=dt(E,d),D=Math.abs(dt(E,g));return S>=-p&&S<=u+p&&_>=-p&&_<=h+p&&D<=p}}}const xP=new _n("Rectangle",St.regionFill,St.setValue,Av,St.determineSegmentIndex,St.preview,St.labelmapStatistics),yP=new _n("RectangleThreshold",St.regionFill,St.setValue,Av,St.determineSegmentIndex,St.dynamicThreshold,St.threshold,St.preview,St.islandRemoval,St.labelmapStatistics),Vd=xP.strategyFunction,AP=yP.strategyFunction,OP=Object.freeze(Object.defineProperty({__proto__:null,fillInsideCircle:Xr,fillInsideRectangle:Vd,fillOutsideCircle:vP,thresholdInsideRectangle:AP},Symbol.toStringTag,{value:"Module"})),_a=class _a extends de{constructor(t,n){super(t,n),this.memoMap=new Map,this.acceptedMemoIds=new Map,this.centerSegmentIndexInfo={segmentIndex:null,hasSegmentIndex:!1,hasPreviewIndex:!1,changedIndices:[]}}_historyRedoHandler(t){const{id:n,operationType:e}=t.detail;if(e==="labelmap"){if(this.acceptedMemoIds.has(n)){this._hoverData=null;const o=this.acceptedMemoIds.get(n),a=o?.element,s=this.getOperationData(a);s.segmentIndex=o?.segmentIndex,a&&this.applyActiveStrategyCallback(y(a),s,J.AcceptPreview)}this._previewData.isDrag=!0}}get _previewData(){return _a.previewData}hasPreviewData(){return!!this._previewData.preview}shouldResolvePreviewRequests(){return(this.mode==="Active"||this.mode==="Enabled")&&this.hasPreviewData()}createMemo(t,n){const e=n.id;if(this.memo&&this.memo.segmentationVoxelManager===n)return this.memo;let o=this.memoMap.get(e);return o?o.redoVoxelManager&&(o=rl(t,n),this.memoMap.set(e,o)):(o=rl(t,n),this.memoMap.set(e,o)),this.memo=o,o}createEditData(t){const n=y(t),{viewport:e}=n,o=Ko(e.id);if(!o){const l=new CustomEvent(ut.ERROR_EVENT,{detail:{type:"Segmentation",message:"No active segmentation detected, create a segmentation representation before using the brush tool"},cancelable:!0});return z.dispatchEvent(l),null}const{segmentationId:a}=o,s=ai(a),{representationData:r}=pt(a);return this.getEditData({viewport:e,representationData:r,segmentsLocked:s,segmentationId:a})}getEditData({viewport:t,representationData:n,segmentsLocked:e,segmentationId:o}){if(t instanceof ve){const{volumeId:a}=n[tt.Labelmap],s=t.getActors();if(t instanceof Ie){const u=new CustomEvent(ut.ERROR_EVENT,{detail:{type:"Segmentation",message:"Cannot perform brush operation on the selected viewport"},cancelable:!0});return z.dispatchEvent(u),null}const c=s.map(u=>X.getVolume(u.referencedId)),l=X.getVolume(a),d=c.find(u=>Pt(u.dimensions,l.dimensions))?.volumeId||c[0]?.volumeId;return{volumeId:a,referencedVolumeId:this.configuration.threshold?.volumeId??d,segmentsLocked:e}}else{const a=Mo(t.id,o);return a?{imageId:a,segmentsLocked:e}:void 0}}createHoverData(t,n){const e=y(t),{viewport:o}=e,a=o.getCamera(),{viewPlaneNormal:s,viewUp:r}=a,c=[o.id],{segmentIndex:l,segmentationId:d,segmentColor:u}=this.getActiveSegmentationData(o)||{};return{brushCursor:{metadata:{viewPlaneNormal:[...s],viewUp:[...r],FrameOfReferenceUID:o.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:u},data:{}},centerCanvas:n,segmentIndex:l,viewport:o,segmentationId:d,segmentColor:u,viewportIdsToRender:c}}getActiveSegmentationData(t){const n=t.id,e=Ko(n);if(!e)return;const{segmentationId:o}=e,a=$e(o);if(!a)return;const s=Vn(n,o,a);return{segmentIndex:a,segmentationId:o,segmentColor:s}}getOperationData(t){const n=this._editData||this.createEditData(t),{segmentIndex:e,segmentationId:o,brushCursor:a}=this._hoverData||this.createHoverData(t),{data:s,metadata:r={}}=a||{},{viewPlaneNormal:c,viewUp:l}=r,d=this.configuration.preview?.previewColors?.[e],{viewport:u}=y(t),h=Vn(u.id,o,e);if(!d&&!h)return;let g=null,f=null;return this.configuration.preview?.enabled&&(g=d||LP(...h),f=255),{...n,points:s?.handles?.points,segmentIndex:e,viewPlaneNormal:c,previewOnHover:!this._previewData.isDrag,toolGroupId:this.toolGroupId,segmentationId:o,viewUp:l,centerSegmentIndexInfo:this.centerSegmentIndexInfo,activeStrategy:this.configuration.activeStrategy,configuration:this.configuration,previewColor:g,previewSegmentIndex:f,createMemo:this.createMemo.bind(this),hoverData:this._hoverData}}addPreview(t=this._previewData.element,n){const{_previewData:e}=this,o=n?.acceptReject;o===!0?this.acceptPreview(t):o===!1&&this.rejectPreview(t);const a=y(t),s=this.applyActiveStrategyCallback(a,this.getOperationData(t),J.AddPreview);return e.isDrag=!0,s?.modified&&(e.preview=s,e.element=t),s}rejectPreview(t=this._previewData.element){if(!t)return;this.doneEditMemo();const n=y(t);this.applyActiveStrategyCallback(n,this.getOperationData(t),J.RejectPreview),this._previewData.preview=null,this._previewData.isDrag=!1}acceptPreview(t=this._previewData.element){if(!t)return;const n=this.getOperationData(t);this.memo&&this.memo.id&&this.acceptedMemoIds.set(this.memo.id,{element:t,segmentIndex:n.segmentIndex});const e=y(t);this.applyActiveStrategyCallback(e,n,J.AcceptPreview),this.doneEditMemo(),this._previewData.preview=null,this._previewData.isDrag=!1}static viewportContoursToLabelmap(t,n){const e=n?.removeContours??!0,o=Fi(),a=ss(t,o);if(!a?.length)return;const s=a.filter(v=>v.data.contour?.polyline?.length);if(!s.length)return;const c=new _a({},{configuration:{strategies:{FILL_INSIDE_CIRCLE:Xr},activeStrategy:"FILL_INSIDE_CIRCLE"}}).addPreview(t.element),{memo:l,segmentationId:d}=c,u=l?.voxelManager,h=u.sourceVoxelManager||u,{dimensions:g}=u,f=t.getDefaultActor().actor.getMapper().getInputData();for(const v of s){const p=[[1/0,-1/0],[1/0,-1/0],[1/0,-1/0]],{polyline:I}=v.data.contour;for(const T of I)f.worldToIndex(T).forEach((A,O)=>{p[O][0]=Math.min(p[O][0],A),p[O][1]=Math.max(p[O][1],A)});p.forEach((T,x)=>{T[0]=Math.round(Math.max(0,T[0])),T[1]=Math.round(Math.min(g[x]-1,T[1]))});const C=$e(d),E=v.data.handles?.[0]||I[0],S=f.worldToIndex(E).map(Math.round),_=h.getAtIJKPoint(S)||0;let D=!1,b=!1;for(const T of I){const x=f.worldToIndex(T).map(Math.round),A=h.getAtIJKPoint(x);A===_?D=!0:A>=0&&(b=!0)}const P=D&&b?_:_===0?C:0;for(let T=p[0][0];T<=p[0][1];T++)for(let x=p[1][0];x<=p[1][1];x++)for(let A=p[2][0];A<=p[2][1];A++){const O=f.indexToWorld([T,x,A]);sd(O,I)&&u.setAtIJK(T,x,A,P)}e&&ft(v.annotationUID)}const m=u.getArrayOfModifiedSlices();Pe(d,m)}};_a.previewData={preview:null,element:null,timerStart:0,timer:null,startPoint:[NaN,NaN],isDrag:!1};let Ui=_a;function LP(i,t,n,e,o=.4){return[Math.round(i+(255-i)*o),Math.round(t+(255-t)*o),Math.round(n+(255-n)*o),e]}class ki extends Ui{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE_CIRCLE:Xr,ERASE_INSIDE_CIRCLE:Pv,FILL_INSIDE_SPHERE:bv,ERASE_INSIDE_SPHERE:Tv,THRESHOLD_INSIDE_CIRCLE:pP,THRESHOLD_INSIDE_SPHERE:EP,THRESHOLD_INSIDE_SPHERE_WITH_ISLAND_REMOVAL:SP},defaultStrategy:"FILL_INSIDE_CIRCLE",activeStrategy:"FILL_INSIDE_CIRCLE",brushSize:25,useCenterSegmentIndex:!1,preview:{enabled:!1,previewColors:{0:[255,255,255,128]},previewTimeMs:250,previewMoveDistance:8,dragMoveDistance:4,dragTimeMs:500},actions:{[J.AcceptPreview]:{method:J.AcceptPreview,bindings:[{key:"Enter"}]},[J.RejectPreview]:{method:J.RejectPreview,bindings:[{key:"Escape"}]},[J.Interpolate]:{method:J.Interpolate,bindings:[{key:"i"}],configuration:{useBallStructuringElement:!0,noUseDistanceTransform:!0,noUseExtrapolation:!0}},interpolateExtrapolation:{method:J.Interpolate,bindings:[{key:"e"}],configuration:{}}}}}){super(t,n),this._lastDragInfo=null,this.onSetToolPassive=e=>{this.disableCursor()},this.onSetToolEnabled=()=>{this.disableCursor()},this.onSetToolDisabled=e=>{this.disableCursor()},this.preMouseDownCallback=e=>{const o=e.detail,{element:a,currentPoints:s}=o,r=y(a),{viewport:c}=r;this._editData=this.createEditData(a),this._activateDraw(a),nt(a),e.preventDefault(),this._previewData.isDrag=!1,this._previewData.timerStart=Date.now();const l=In(s.canvas),d=c.canvasToWorld([l[0],l[1]]);this._lastDragInfo={canvas:l,world:xn(d)};const u=this._hoverData||this.createHoverData(a);L(u.viewportIdsToRender);const h=this.getOperationData(a);return h?(this.applyActiveStrategyCallback(r,h,J.OnInteractionStart),!0):!1},this.mouseMoveCallback=e=>{if(this.isPrimary&&this.mode===Ot.Active){if(this.updateCursor(e),!this.configuration.preview.enabled)return;const{previewTimeMs:o,previewMoveDistance:a,dragMoveDistance:s}=this.configuration.preview,{currentPoints:r,element:c}=e.detail,{canvas:l}=r,{startPoint:d,timer:u,timerStart:h,isDrag:g}=this._previewData;if(g)return;const f=jt(l,d),m=Date.now()-h;if((f>a||m>o&&f>s)&&(u&&(window.clearTimeout(u),this._previewData.timer=null),g||this.rejectPreview(c)),!this._previewData.timer){const v=window.setTimeout(this.previewCallback,250);Object.assign(this._previewData,{timerStart:Date.now(),timer:v,startPoint:l,element:c})}}},this.previewCallback=()=>{if(this._previewData.isDrag){this._previewData.timer=null;return}this._previewData.timer=null;const e=this.getOperationData(this._previewData.element),o=y(this._previewData.element);if(!o)return;const{viewport:a}=o,s=this.configuration.activeStrategy,r=Od({operationData:e,viewport:a,strategy:s});if(!e)return;const c=this.createMemo(e.segmentationId,r.segmentationVoxelManager);this._previewData.preview=this.applyActiveStrategyCallback(y(this._previewData.element),{...e,...r,memo:c},J.Preview)},this._dragCallback=e=>{const o=e.detail,{element:a,currentPoints:s}=o,r=y(a),{viewport:c}=r;this.updateCursor(e);const{viewportIdsToRender:l}=this._hoverData;L(l);const d=jt(s.canvas,this._previewData.startPoint),{dragTimeMs:u,dragMoveDistance:h}=this.configuration.preview;if(!this._previewData.isDrag&&Date.now()-this._previewData.timerStart<u&&d<h)return;if(this._previewData.timer&&(window.clearTimeout(this._previewData.timer),this._previewData.timer=null),!this._lastDragInfo){const p=this._previewData.startPoint,I=c.canvasToWorld([p[0],p[1]]);this._lastDragInfo={canvas:In(p),world:xn(I)}}const g=s.canvas,f=c.canvasToWorld([g[0],g[1]]);this._hoverData=this.createHoverData(a,g),this._calculateCursor(a,g);const m=this.getOperationData(a);if(!m)return;m.strokePointsWorld=[xn(this._lastDragInfo.world),xn(f)],this._previewData.preview=this.applyActiveStrategy(r,m);const v=In(g);this._lastDragInfo={canvas:v,world:xn(f)},this._previewData.element=a,this._previewData.timerStart=Date.now()+u,this._previewData.isDrag=!0,this._previewData.startPoint=v},this._endCallback=e=>{const o=e.detail,{element:a}=o,s=y(a),r=this.getOperationData(a);r&&(!this._previewData.preview&&!this._previewData.isDrag&&this.applyActiveStrategy(s,r),this.doneEditMemo(),this._deactivateDraw(a),ht(a),this.updateCursor(e),this._editData=null,this._lastDragInfo=null,this.applyActiveStrategyCallback(s,r,J.OnInteractionEnd),this._previewData.isDrag||this.acceptPreview(a))},this._activateDraw=e=>{e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback)}}disableCursor(){this._hoverData=void 0,this.rejectPreview()}updateCursor(t){const n=t.detail,{element:e}=n,{currentPoints:o}=n,a=o.canvas;this._hoverData=this.createHoverData(e,a),this._calculateCursor(e,a),this._hoverData&&(ki.activeCursorTool=this,L(this._hoverData.viewportIdsToRender))}_calculateCursor(t,n){const e=y(t);this.applyActiveStrategyCallback(e,this.getOperationData(t),J.CalculateCursorGeometry)}getStatistics(t,n){if(!t)return;const e=y(t);return this.applyActiveStrategyCallback(e,this.getOperationData(t),J.GetStatistics,n)}rejectPreview(t=this._previewData.element){if(!t)return;this.doneEditMemo();const n=y(t);n&&(this.applyActiveStrategyCallback(n,this.getOperationData(t),J.RejectPreview),this._previewData.preview=null,this._previewData.isDrag=!1)}acceptPreview(t=this._previewData.element){t&&super.acceptPreview(t)}interpolate(t,n){if(!t)return;const e=y(t);this._previewData.preview=this.applyActiveStrategyCallback(e,this.getOperationData(t),J.Interpolate,n.configuration),this._previewData.isDrag=!0}invalidateBrushCursor(){if(this._hoverData===void 0)return;const{data:t}=this._hoverData.brushCursor,{viewport:n}=this._hoverData;t.invalidated=!0;const{segmentColor:e}=this.getActiveSegmentationData(n)||{};this._hoverData.brushCursor.metadata.segmentColor=e}renderAnnotation(t,n){if(!this._hoverData||ki.activeCursorTool!==this)return;const{viewport:e}=t;if(!this._hoverData.viewportIdsToRender.includes(e.id))return;if(this._hoverData.brushCursor.data.invalidated===!0){const{centerCanvas:s}=this._hoverData,{element:r}=e;this._calculateCursor(r,s)}this.applyActiveStrategyCallback(t,this.getOperationData(e.element),J.RenderCursor,n)}}ki.toolName="Brush";function Zi(i,t){const n=_e(i);if(n===void 0)return[];const e=n._toolInstances;return Object.keys(e).length?t&&e[t]?[e[t]]:Object.values(e).filter(a=>a instanceof ki):[]}function RP(i,t,n){const e=_e(i);if(e===void 0)return;Zi(i,n).forEach(s=>{const r=s.configuration.minRadius,c=s.configuration.maxRadius;let l=r?Math.max(t,r):t;l=c?Math.min(l,c):l,s.configuration.brushSize=l,s.invalidateBrushCursor()});const a=e.getViewportIds();L(a)}function NP(i,t){const n=_e(i);if(n===void 0)return;const e=n._toolInstances;if(!Object.keys(e).length)return;const a=Zi(i,t)[0];if(a)return a.configuration.brushSize}function UP(i,t){const n=_e(i);if(n===void 0||(Zi(i).forEach(s=>{s.configuration.activeStrategy.toLowerCase().includes("threshold")&&(s.configuration={...s.configuration,threshold:{...s.configuration.threshold,...t}})}),!n.getViewportsInfo().length))return;const a=n.getViewportIds();L(a)}function kP(i){const t=_e(i);if(t===void 0)return;const n=t._toolInstances;if(!Object.keys(n).length)return;const o=Zi(i)[0];if(o)return o.configuration.threshold.range}const Da=class Da{static statsInit(t){const{storePointData:n,indices:e,mode:o}=t;this.mode=o,this.indices=e,this.calculators.clear(),this.mode==="individual"?e.forEach(a=>{this.calculators.set(a,new Lh({storePointData:n}))}):this.calculators.set(e,new Lh({storePointData:n}))}static statsCallback(t){const{segmentIndex:n,...e}=t;if(!n)throw new Error("Segment index is required for stats calculation");const o=this.mode==="individual"?this.calculators.get(n):this.calculators.get(this.indices);if(!o)throw new Error(`No calculator found for segment ${n}`);o.statsCallback(e)}static getStatistics(t){if(this.mode==="individual"){const e={};return this.calculators.forEach((o,a)=>{e[a]=o.getStatistics(t)}),e}return this.calculators.get(this.indices).getStatistics(t)}};Da.calculators=new Map,Da.indices=[],Da.mode="collective";let cl=Da;function VP(i,t,n,e,o){if(!o)throw new Error("Segmentation ID is required to be passed inside thresholdSegmentationByRange");const{baseVolumeIdx:a,volumeInfoList:s}=Lf(i,n),{voxelManager:r}=s[a],c=r,l=i.voxelManager.getScalarDataLength(),d=i.voxelManager;return s.forEach(u=>{const{volumeSize:h}=u;h===l?BP(d,c,t,u):FP(d,c,t,u,s,a,e)}),Pe(o),i}function FP(i,t,n,e,o,a,s){const{imageData:r,lower:c,upper:l,dimensions:d}=e;let u,h,g;const f=i.getScalarDataLength();for(let m=0;m<f;m++)if(f.getAtIndex(m)===n){const v=Wl(r,d,o[a].spacing,o[a].imageData.getPoint(m)),p=({value:C})=>{u=u+1,C>=g.lower&&C<=g.upper&&(h=h+1)};u=0,h=0,g={lower:c,upper:l};let I=!1;i.forEach(p,{imageData:r,boundsIJK:v}),I=s===0?h>0:h===u,i.setAtIndex(m,I?n:0)}return{total:u,range:g,overlaps:h}}function BP(i,t,n,e){const{lower:o,upper:a}=e,s=i.getScalarDataLength();for(let r=0;r<s;r++)if(i.getAtIndex[r]===n){const c=t.getAtIndex(r);i.setAtIndex(r,c>=o&&c<=a?n:0)}}function kh(i,t,n){const e=n.toIJK(i),o=n.toIJK(t),a=W(),{testIJK:s}=n,r=me(W(),e,o),c=Math.round(Math.max(...r.map(Math.abs)));if(c<2)return!0;const l=hn(W(),r,1/c);for(let d=1;d<c;d++)if(Wt(a,o,l,d),!s(a))return!1;return!0}function GP({dimensions:i,imageData:t,voxelManager:n,segmentIndex:e,containedSegmentIndices:o}){const a=i[0],s=a*i[1];return{testCenter:(r,c)=>{const l=je(W(),r,c).map(v=>v/2),d=t.worldToIndex(l).map(Math.round),[u,h,g]=d,f=u+h*a+g*s,m=n.getAtIndex(f);return m===e||o?.has(m)},toIJK:r=>t.worldToIndex(r),testIJK:r=>{const[c,l,d]=r,u=Math.round(c)+Math.round(l)*a+Math.round(d)*s,h=n.getAtIndex(u);return h===e||o?.has(h)}}}function WP(i,t,n){const e=X.getVolume(i);if(!e){console.warn(`No volume found for ${i}`);return}return GP({dimensions:e.dimensions,imageData:e.imageData,voxelManager:e.voxelManager,segmentIndex:t,containedSegmentIndices:n})}const la=.01;function $P(i,t,n){const{sliceContours:e}=i,{segmentIndex:o,containedSegmentIndices:a}=n;let s;const r=WP(t,o,a);for(const c of e){const l=HP(c,r,s);l&&(s=l)}return s&&Object.assign(s,n),s}function HP(i,t,n={maxMajor:0,maxMinor:0}){const{points:e}=i.polyData,{maxMinor:o,maxMajor:a}=n;let s=a*a,r=o*o,c;for(let v=0;v<e.length;v++)for(let p=v+1;p<e.length;p++){const I=e[v],C=e[p],E=$c(I,C);E<s||E-la<s+la&&c||t.testCenter(I,C)&&kh(I,C,t)&&(s=E-la,c=[v,p],r=0)}if(!c)return;s=Math.sqrt(s+la);const l=e[c[0]],d=e[c[1]],u=me(W(),l,d);hn(u,u,1/s);let h;for(let v=0;v<e.length;v++)for(let p=v+1;p<e.length;p++){const I=e[v],C=e[p],E=$c(I,C);if(E<=r)continue;const S=me(W(),I,C);Math.abs(dt(S,u))/Math.sqrt(E)>la||t.testCenter(I,C)&&kh(I,C,t)&&(r=E,h=[v,p])}if(!h)return;r=Math.sqrt(r);const g=e[h[0]],f=e[h[1]];return{majorAxis:[l,d],minorAxis:[g,f],maxMajor:s,maxMinor:r,...i}}async function Ov(i){const t=await dp({segmentations:i});if(!t?.length||!t[0].sliceContours.length)return;const{segments:n=[null,{label:"Unspecified",color:null,containedSegmentIndices:null}]}=i,e=Yi(i.segmentationId);if(!e)return;const o=n.findIndex(a=>!!a);if(o!==-1)return n[o].segmentIndex=o,$P(t[0],e.volumeId,n[o])}function Lv(i,t){const{majorAxis:n,minorAxis:e,label:o="",sliceIndex:a}=i,[s,r]=n,[c,l]=e,d=[s,r,c,l];return{highlighted:!0,invalidated:!0,metadata:{toolName:"Bidirectional",...t.getViewReference({sliceIndex:a})},data:{handles:{points:d,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:o,cachedStats:{}},isLocked:!1,isVisible:!0}}const jn=class jn extends zt{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:zP}}){super(t,n),this.isPointNearTool=(e,o,a,s)=>{const r=y(e),{viewport:c}=r,{data:l}=o,{points:d}=l.handles;let u=c.worldToCanvas(d[0]),h=c.worldToCanvas(d[1]),g={start:{x:u[0],y:u[1]},end:{x:h[0],y:h[1]}},f=fe([g.start.x,g.start.y],[g.end.x,g.end.y],[a[0],a[1]]);return f<=s||(u=c.worldToCanvas(d[2]),h=c.worldToCanvas(d[3]),g={start:{x:u[0],y:u[1]},end:{x:h[0],y:h[1]}},f=fe([g.start.x,g.start.y],[g.end.x,g.end.y],[a[0],a[1]]),f<=s)},this.toolSelectedCallback=(e,o)=>{const a=e.detail,{element:s}=a;o.highlighted=!0;const r=Q(s,this.getToolName());this.editData={annotation:o,viewportIdsToRender:r,movingTextBox:!1},this._activateModify(s);const c=y(s),{renderingEngine:l}=c;L(r),nt(s),e.preventDefault()},this.handleSelectedCallback=(e,o,a)=>{const s=e.detail,{element:r}=s,c=o.data;o.highlighted=!0;let l=!1,d;a.worldPosition?l=!0:d=c.handles.points.findIndex(f=>f===a);const u=Q(r,this.getToolName());nt(r),this.editData={annotation:o,viewportIdsToRender:u,handleIndex:d,movingTextBox:l},this._activateModify(r);const h=y(r),{renderingEngine:g}=h;L(u),e.preventDefault()},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c,hasMoved:l}=this.editData,{data:d}=s;if(c&&!l)return;this.doneEditMemo(),d.handles.activeHandleIndex=null,this._deactivateModify(a),this._deactivateDraw(a),ht(a);const{renderingEngine:u}=y(a);if(this.editData.handleIndex!==void 0){const{points:h}=d.handles,g=Te(h[0],h[1]);if(Te(h[2],h[3])>g){const m=[[...h[2]],[...h[3]]],v=[...h[0]],p=[...h[1]],I=et();sn(I,m[1][0]-m[0][0],m[1][1]-m[1][0]);const C=et();sn(C,-I[1],I[0]);const E=et();sn(E,p[0]-v[0],p[1]-v[0]);let S;Xn(E,C)>0?S=[v,p]:S=[p,v],d.handles.points=[m[0],m[1],S[0],S[1]]}}this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(s.annotationUID),L(r),c&&Lt(s),this.editData=null,this.isDrawing=!1},this._dragDrawCallback=e=>{this.isDrawing=!0;const o=e.detail,{currentPoints:a,element:s}=o,r=y(s),{viewport:c}=r,{worldToCanvas:l}=c,{annotation:d,viewportIdsToRender:u,handleIndex:h,newAnnotation:g}=this.editData;this.createMemo(s,d,{newAnnotation:g});const{data:f}=d,m=a.world;f.handles.points[h]=[...m];const v=f.handles.points.map(l),p={longLineSegment:{start:{x:v[0][0],y:v[0][1]},end:{x:v[1][0],y:v[1][1]}},shortLineSegment:{start:{x:v[2][0],y:v[2][1]},end:{x:v[3][0],y:v[3][1]}}},C=jt(v[0],v[1])/3,E=p.longLineSegment.start.x-p.longLineSegment.end.x,S=p.longLineSegment.start.y-p.longLineSegment.end.y,_=Math.sqrt(E*E+S*S),D=E/_,b=S/_,M=(p.longLineSegment.start.x+p.longLineSegment.end.x)/2,P=(p.longLineSegment.start.y+p.longLineSegment.end.y)/2,T=M+C*b,x=P-C*D,A=M-C*b,O=P+C*D;f.handles.points[2]=c.canvasToWorld([T,x]),f.handles.points[3]=c.canvasToWorld([A,O]),d.invalidated=!0,L(u),It(d,s,lt.HandlesUpdated),this.editData.hasMoved=!0},this._dragModifyCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,handleIndex:c,movingTextBox:l,newAnnotation:d}=this.editData;this.createMemo(a,s,{newAnnotation:d});const{data:u}=s;if(l){const{deltaPoints:h}=o,g=h.world,{textBox:f}=u.handles,{worldPosition:m}=f;m[0]+=g[0],m[1]+=g[1],m[2]+=g[2],f.hasMoved=!0}else if(c===void 0){const{deltaPoints:h}=o,g=h.world;u.handles.points.forEach(m=>{m[0]+=g[0],m[1]+=g[1],m[2]+=g[2]}),s.invalidated=!0}else this._dragModifyHandle(e),s.invalidated=!0;L(r),s.invalidated&&It(s,a,lt.HandlesUpdated)},this._dragModifyHandle=e=>{const o=e.detail,{currentPoints:a,element:s}=o,r=y(s),{viewport:c}=r,{annotation:l,handleIndex:d}=this.editData,{data:u}=l,h=a.world,g=[c.worldToCanvas(u.handles.points[0]),c.worldToCanvas(u.handles.points[1]),c.worldToCanvas(u.handles.points[2]),c.worldToCanvas(u.handles.points[3])],f={start:{x:g[0][0],y:g[0][1]},end:{x:g[1][0],y:g[1][1]}},m={start:{x:g[2][0],y:g[2][1]},end:{x:g[3][0],y:g[3][1]}},v=[...h],p=c.worldToCanvas(v);if(d===0||d===1){const C=g[d===0?1:0],E=sn(et(),p[0]-C[0],p[1]-C[1]),S=sn(et(),g[d][0]-C[0],g[d][1]-C[1]);yn(E,E),yn(S,S);const _={start:{x:C[0],y:C[1]},end:{x:p[0],y:p[1]}};if(this._movingLongAxisWouldPutItThroughShortAxis(_,m))return;const D=C,b=this._getSignedAngle(S,E);let M=g[2][0],P=g[2][1],T=g[3][0],x=g[3][1];M-=D[0],P-=D[1],T-=D[0],x-=D[1];const A=M*Math.cos(b)-P*Math.sin(b),O=M*Math.sin(b)+P*Math.cos(b),R=T*Math.cos(b)-x*Math.sin(b),N=T*Math.sin(b)+x*Math.cos(b);M=A+D[0],P=O+D[1],T=R+D[0],x=N+D[1];const k=c.canvasToWorld([M,P]),B=c.canvasToWorld([T,x]);u.handles.points[d]=v,u.handles.points[2]=k,u.handles.points[3]=B}else{const I=d===2?3:2,C={longLineSegment:{start:f.start,end:f.end},shortLineSegment:{start:m.start,end:m.end}},E=Ft(et(),[C.longLineSegment.end.x,C.longLineSegment.end.y],[C.longLineSegment.start.x,C.longLineSegment.start.y]),S=yn(et(),E),_=Ft(et(),[p[0],p[1]],[g[d][0],g[d][1]]),D=Gc(_),b=this._getSignedAngle(S,_),M=Math.cos(b)*D,P=ua(et(),[g[I][0],g[I][1]],S,M);if(this._movingLongAxisWouldPutItThroughShortAxis({start:{x:p[0],y:p[1]},end:{x:P[0],y:P[1]}},{start:{x:C.longLineSegment.start.x,y:C.longLineSegment.start.y},end:{x:C.longLineSegment.end.x,y:C.longLineSegment.end.y}})||!js([p[0],p[1]],[P[0],P[1]],[f.start.x,f.start.y],[f.end.x,f.end.y]))return;u.handles.points[I]=c.canvasToWorld(P),u.handles.points[d]=v}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),ht(e);const{annotation:o,viewportIdsToRender:a,newAnnotation:s}=this.editData,{data:r}=o;return o.highlighted=!1,r.handles.activeHandleIndex=null,L(a),s&&Lt(o),this.editData=null,o.annotationUID}},this._activateDraw=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(w.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragDrawCallback)},this._deactivateDraw=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(w.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragDrawCallback)},this._activateModify=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,o)=>{let a=!0;const{viewport:s}=e,{element:r}=s;let c=Ct(this.getToolName(),r);if(!c?.length||(c=this.filterInteractableAnnotationsForElement(r,c),!c?.length))return a;const l=this.getTargetId(s),d=s.getRenderingEngine(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let h=0;h<c.length;h++){const g=c[h],{annotationUID:f,data:m}=g,{points:v,activeHandleIndex:p}=m.handles,I=v.map(Y=>s.worldToCanvas(Y));u.annotationUID=f;const{color:C,lineWidth:E,lineDash:S,shadow:_}=this.getAnnotationStyle({annotation:g,styleSpecifier:u});if(!m.cachedStats[l]||m.cachedStats[l].unit==null?(m.cachedStats[l]={length:null,width:null,unit:null},this._calculateCachedStats(g,d,e)):g.invalidated&&this._throttledCalculateCachedStats(g,d,e),!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;let D;if(!re(f))continue;!se(f)&&!this.editData&&p!==null&&(D=[I[p]]);const b=!!Ve("showHandlesAlways",{});(D||b)&&$t(o,f,"0",b?I:D,{color:C});const M=`${f}-line-1`,P=`${f}-line-2`;Et(o,f,"0",I[0],I[1],{color:C,lineDash:S,lineWidth:E,shadow:_},M),Et(o,f,"1",I[2],I[3],{color:C,lineDash:S,lineWidth:E,shadow:_},P),a=!0;const A=this.getLinkedTextBoxStyle(u,g);if(!A.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const O=this.configuration.getTextLines(m,l);if(!O||O.length===0)continue;let R;m.handles.textBox.hasMoved||(R=qe(I),m.handles.textBox.worldPosition=s.canvasToWorld(R));const N=s.worldToCanvas(m.handles.textBox.worldPosition),B=Oe(o,f,"1",O,N,I,{},A),{x:V,y:$,width:H,height:G}=B;m.handles.textBox.worldBoundingBox={topLeft:s.canvasToWorld([V,$]),topRight:s.canvasToWorld([V+H,$]),bottomLeft:s.canvasToWorld([V,$+G]),bottomRight:s.canvasToWorld([V+H,$+G])}}return a},this._movingLongAxisWouldPutItThroughShortAxis=(e,o)=>{const a=et();sn(a,o.end.x-o.start.x,o.end.y-o.start.y),yn(a,a);const s={start:{x:o.start.x-a[0]*10,y:o.start.y-a[1]*10},end:{x:o.end.x+a[0]*10,y:o.end.y+a[1]*10}};return!js([s.start.x,s.start.y],[s.end.x,s.end.y],[e.start.x,e.start.y],[e.end.x,e.end.y])},this._calculateCachedStats=(e,o,a)=>{const{data:s}=e,{element:r}=a.viewport;s.handles.points[0],s.handles.points[1],s.handles.points[2],s.handles.points[3];const{cachedStats:c}=s,l=Object.keys(c);for(let u=0;u<l.length;u++){const h=l[u],g=this.getTargetImageData(h);if(!g)continue;const{imageData:f,dimensions:m}=g,v=s.handles.points.map(P=>f.worldToIndex(P)),p=v.slice(0,2),I=v.slice(2,4),C=nn(g,v),E=jn.calculateLengthInIndex(C,p),S=jn.calculateLengthInIndex(C,I),{unit:_}=C,D=E>S?E:S,b=E>S?S:E,M=_;this.isHandleOutsideImage=!jn.isInsideVolume(m,v),c[h]={length:D,width:b,unit:_,widthUnit:M,statsArray:[{value:D,name:"height",unit:_,type:rn.Linear},{value:b,name:"width",unit:_,type:rn.Linear}]}}const d=e.invalidated;return e.invalidated=!1,d&&It(e,r,lt.StatsUpdated),c},this._getSignedAngle=(e,o)=>Math.atan2(e[0]*o[1]-e[1]*o[0],e[0]*o[0]+e[1]*o[1]),this._throttledCalculateCachedStats=Fe(this._calculateCachedStats,100,{trailing:!0})}addNewAnnotation(t){const n=t.detail,{currentPoints:e,element:o}=n,a=e.world;this.isDrawing=!0;const s=this.createAnnotation(t,[[...a],[...a],[...a],[...a]]);mt(s,o);const r=Q(o,this.getToolName());return this.editData={annotation:s,viewportIdsToRender:r,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),nt(o),t.preventDefault(),L(r),s}};jn.toolName="Bidirectional",jn.hydrate=(t,n,e)=>{const o=At(t);if(!o)return;const{FrameOfReferenceUID:a,referencedImageId:s,viewPlaneNormal:r,instance:c,viewport:l}=jn.hydrateBase(jn,o,n[0],e),[d,u]=n,[h,g]=d,[f,m]=u,v=[h,g,f,m],{toolInstance:p,...I}=e||{},C={annotationUID:e?.annotationUID||Xt(),data:{handles:{points:v,activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},cachedStats:{}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:c.getToolName(),viewPlaneNormal:r,FrameOfReferenceUID:a,referencedImageId:s,...I}};return mt(C,l.element),L([l.id]),C};let ar=jn;function zP(i,t){const{cachedStats:n,label:e}=i,{length:o,width:a,unit:s}=n[t],r=[];return e&&r.push(e),o===void 0||r.push(`L: ${_t(o)} ${s||s}`,`W: ${_t(a)} ${s}`),r}async function jP(i,t){console.warn("Deprecation Alert: There is a new getSegmentLargestBidirectional function that handles volume, stack and individual segment cases properly. This function is deprecated and will be removed in a future version.");const{data:n}=t,e=y(i),o=(n.getSegment||XP)(e,n);if(!o)return;const a=e.viewport.getFrameOfReferenceUID(),s=$r(),{segmentIndex:r,segmentationId:c}=o,l=En.getAnnotations(this.toolName||ar.toolName,a);let d=!1;const u=l.filter(g=>{const f=g.data.segment;return f?(f.segmentationId===c&&f.segmentIndex===r&&(d=!0,g.data.segment=f),!0):!1});d||u.push({data:{segment:o}});let h;if(u.forEach(async g=>{const f=[],m=g.data.segment,{segmentIndex:v,segmentationId:p}=m;f[v]=m,En.removeAnnotation(g.annotationUID);const I=await Ov({...s.find(S=>S.segmentationId===p),segments:f});if(!I)return;const C=Lv(I,e.viewport);C.annotationUID=g.annotationUID,C.data.segment=m;const E=En.addAnnotation(C,a);if(m.segmentIndex===o.segmentIndex&&m.segmentationId===o.segmentationId){h=I;const{style:S}=o;S&&Nl.setAnnotationStyles(E,S)}}),h){const{sliceIndex:g}=h,f=e.viewport.getImageIds();xg(i,{imageIndex:f.length-1-g}),e.viewport.render()}else console.warn("No bidirectional found");return h}function XP(i,t){const n=$r();if(!n.length)return;const e=t.segmentationId||n[0].segmentationId,o=t.segmentIndex??$e(e);if(!o)return;const a=t.segmentData?.get(o);return{label:`Segment ${o}`,segmentIndex:o,segmentationId:e,...a}}function Rv(i){const t=_e(i);if(t===void 0)return;Zi(i).forEach(s=>{s.invalidateBrushCursor()});const e=t.getViewportsInfo();if(!Object.keys(e).map(s=>e[s]).length)return;const a=t.getViewportIds();L(a)}function Fd(i,t,n={}){const e=pt(i),o=e.representationData,a=n?.representationType??Object.keys(o)[0];if(!a)throw new Error(`Segmentation ${i} does not have any representations`);switch(a){case tt.Labelmap:return YP(e,t,n);case tt.Contour:return qP(e,t,n);default:return}}function YP(i,t,{viewport:n}){const e=i.representationData.Labelmap;if(n instanceof ve){const{volumeId:g}=e,f=X.getVolume(g);return f?f.imageData.getScalarValueFromWorld(t):void 0}const o=no(n.id,i.segmentationId);if(o.length>1){console.warn("Segment selection for labelmaps with multiple imageIds in stack viewports is not supported yet.");return}const a=o[0];if(!X.getImage(a))return;const c=br(n.id,i.segmentationId)?.actor.getMapper().getInputData(),l=xe(c,t),d=c.getDimensions();return(c.voxelManager||Al.createScalarVolumeVoxelManager({dimensions:d,scalarData:c.getPointData().getScalars().getData()})).getAtIJKPoint(l)}function qP(i,t,{viewport:n}){const e=i.representationData.Contour,o=Array.from(e.annotationUIDsMap.keys()),{viewPlaneNormal:a}=n.getCamera();for(const s of o){const r=e.annotationUIDsMap.get(s);if(r)for(const c of r){const l=xt(c);if(!l)continue;const{polyline:d}=l.data.contour;if(Pt(a,l.metadata.viewPlaneNormal)&&sd(t,d))return Number(s)}}}function Nv(i,t,{viewport:n,searchRadius:e}){const a=pt(i).representationData.Labelmap;if(n instanceof ve){const{volumeId:m}=a,v=X.getVolume(m);if(!v)return;const p=v.voxelManager,I=v.imageData,C=xe(I,t),E=p.getAtIJK(C[0],C[1],C[2]),S=n.worldToCanvas(t);return ZP(S,E,n,I,e)?E:void 0}const s=Mo(n.id,i);if(!X.getImage(s))return;const l=br(n.id,i)?.actor.getMapper().getInputData(),d=xe(l,t),u=l.getDimensions(),h=l.voxelManager||Al.createScalarVolumeVoxelManager({dimensions:u,scalarData:l.getPointData().getScalars().getData()}),g=h.getAtIJKPoint(d);return KP(d,u,h,g)?g:void 0}function Uv(i,t,n=1){const e=Array.from({length:2*n+1},(o,a)=>a-n);for(const o of e)for(const a of e)for(const s of e){if(o===0&&a===0&&s===0)continue;const r=i(o,a,s);if(r!==void 0&&t!==r)return!0}return!1}function KP(i,t,n,e,o){return Uv((s,r,c)=>{const l=[i[0]+s,i[1]+r,i[2]+c];return n.getAtIJK(l[0],l[1],l[2])},e,o)}function ZP(i,t,n,e,o){return Uv((s,r)=>{const c=[i[0]+s,i[1]+r],l=n.canvasToWorld(c),d=e.get("voxelManager").voxelManager,u=xe(e,l);return d.getAtIJK(u[0],u[1],u[2])},t,o)}function kv(i){const t=pt(i),{annotationUIDsMap:n}=t.representationData.Contour;for(const[e,o]of n.entries())if(Array.from(o).find(s=>xt(s).highlighted))return e}const JP=`
const MAX_STRENGTH = 65535f;

// Workgroup size - X*Y*Z must be multiple of 32 for better performance
override workGroupSizeX = 1u;
override workGroupSizeY = 1u;
override workGroupSizeZ = 1u;

// Compare the current voxel to neighbors using a 9x9x9 window
override windowSize = 9i;

struct Params {
  size: vec3u,
  iteration: u32,
}

// New structure to track bounds of modified voxels
struct Bounds {
  minX: atomic<i32>,
  minY: atomic<i32>,
  minZ: atomic<i32>,
  maxX: atomic<i32>,
  maxY: atomic<i32>,
  maxZ: atomic<i32>,
}

@group(0) @binding(0) var<uniform> params: Params;
@group(0) @binding(1) var<storage> volumePixelData: array<f32>;
@group(0) @binding(2) var<storage, read_write> labelmap: array<u32>;
@group(0) @binding(3) var<storage, read_write> strengthData: array<f32>;
@group(0) @binding(4) var<storage> prevLabelmap: array<u32>;
@group(0) @binding(5) var<storage> prevStrengthData: array<f32>;
@group(0) @binding(6) var<storage, read_write> updatedVoxelsCounter: array<atomic<u32>>;
@group(0) @binding(7) var<storage, read_write> modifiedBounds: Bounds;

fn getPixelIndex(ijkPos: vec3u) -> u32 {
  let numPixelsPerSlice = params.size.x * params.size.y;
  return ijkPos.x + ijkPos.y * params.size.x + ijkPos.z * numPixelsPerSlice;
}

fn updateBounds(position: vec3i) {
  // Atomically update min bounds (use min operation)
  let oldMinX = atomicMin(&modifiedBounds.minX, position.x);
  let oldMinY = atomicMin(&modifiedBounds.minY, position.y);
  let oldMinZ = atomicMin(&modifiedBounds.minZ, position.z);

  // Atomically update max bounds (use max operation)
  let oldMaxX = atomicMax(&modifiedBounds.maxX, position.x);
  let oldMaxY = atomicMax(&modifiedBounds.maxY, position.y);
  let oldMaxZ = atomicMax(&modifiedBounds.maxZ, position.z);
}

@compute @workgroup_size(workGroupSizeX, workGroupSizeY, workGroupSizeZ)
fn main(
  @builtin(global_invocation_id) globalId: vec3u,
) {
  // Make sure it will not get out of bounds for volume with sizes that
  // are not multiple of workGroupSize
  if (
    globalId.x >= params.size.x ||
    globalId.y >= params.size.y ||
    globalId.z >= params.size.z
  ) {
    return;
  }

  // Initialize bounds for the first iteration
  if (params.iteration == 0 && globalId.x == 0 && globalId.y == 0 && globalId.z == 0) {
    // Initialize to opposite extremes to ensure any update will improve the bounds
    atomicStore(&modifiedBounds.minX, i32(params.size.x));
    atomicStore(&modifiedBounds.minY, i32(params.size.y));
    atomicStore(&modifiedBounds.minZ, i32(params.size.z));
    atomicStore(&modifiedBounds.maxX, -1);
    atomicStore(&modifiedBounds.maxY, -1);
    atomicStore(&modifiedBounds.maxZ, -1);
  }

  let currentCoord = vec3i(globalId);
  let currentPixelIndex = getPixelIndex(globalId);

  let numPixels = arrayLength(&volumePixelData);
  let currentPixelValue = volumePixelData[currentPixelIndex];

  if (params.iteration == 0) {
    // All non-zero initial labels are given maximum strength
    strengthData[currentPixelIndex] = select(MAX_STRENGTH, 0., labelmap[currentPixelIndex] == 0);

    // Update bounds for non-zero initial labels
    if (labelmap[currentPixelIndex] != 0) {
      updateBounds(currentCoord);
    }
    return;
  }

  // It should at least copy the values from previous state
  var newLabel = prevLabelmap[currentPixelIndex];
  var newStrength = prevStrengthData[currentPixelIndex];

  let window = i32(ceil(f32(windowSize - 1) * .5));
  let minWindow = -1i * window;
  let maxWindow = 1i * window;

  for (var k = minWindow; k <= maxWindow; k++) {
    for (var j = minWindow; j <= maxWindow; j++) {
      for (var i = minWindow; i <= maxWindow; i++) {
        // Skip current voxel
        if (i == 0 && j == 0 && k == 0) {
          continue;
        }

        let neighborCoord = currentCoord + vec3i(i, j, k);

        //  Boundary conditions. Do not grow outside of the volume
        if (
          neighborCoord.x < 0i || neighborCoord.x >= i32(params.size.x) ||
          neighborCoord.y < 0i || neighborCoord.y >= i32(params.size.y) ||
          neighborCoord.z < 0i || neighborCoord.z >= i32(params.size.z)
        ) {
          continue;
        }

        let neighborIndex = getPixelIndex(vec3u(neighborCoord));
        let neighborPixelValue = volumePixelData[neighborIndex];
        let prevNeighborStrength = prevStrengthData[neighborIndex];
        let strengthCost = abs(neighborPixelValue - currentPixelValue);
        let takeoverStrength = prevNeighborStrength - strengthCost;

        if (takeoverStrength > newStrength) {
          newLabel = prevLabelmap[neighborIndex];
          newStrength = takeoverStrength;
        }
      }
    }
  }

  if (labelmap[currentPixelIndex] != newLabel) {
    atomicAdd(&updatedVoxelsCounter[params.iteration], 1u);

    // Update bounds for modified voxels
    updateBounds(currentCoord);
  }

  labelmap[currentPixelIndex] = newLabel;
  strengthData[currentPixelIndex] = newStrength;
}
`,QP=1024*1024*1024,Vh=1.99*QP,Sc={windowSize:3,maxProcessingTime:3e4,inspection:{numCyclesInterval:5,numCyclesBelowThreshold:3,threshold:1e-4}};async function qr(i,t,n=Sc){const e=[8,8,4],{windowSize:o,maxProcessingTime:a}=Object.assign({},Sc,n),s=Object.assign({},Sc.inspection,n.inspection),r=X.getVolume(i),c=X.getVolume(t),[l,d,u]=r.dimensions;if(c.dimensions[0]!==l||c.dimensions[1]!==d||c.dimensions[2]!==u)throw new Error("Volume and labelmap must have the same size");let h=Math.floor(Math.sqrt(d**2+l**2+u**2)/2);h=Math.min(h,500);const g=c.voxelManager.getCompleteScalarDataArray();let f=r.voxelManager.getCompleteScalarDataArray();f instanceof Float32Array||(f=new Float32Array(f));const m={maxStorageBufferBindingSize:Vh,maxBufferSize:Vh},p=await(await navigator.gpu?.requestAdapter()).requestDevice({requiredLimits:m}),I=f.byteLength,C=h*Uint32Array.BYTES_PER_ELEMENT,E=6*Int32Array.BYTES_PER_ELEMENT,S=p.createShaderModule({code:JP}),_=3,D=new Uint32Array([l,d,u,0]),b=p.createBuffer({size:D.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),M=p.createBuffer({size:I,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});p.queue.writeBuffer(M,0,f);const P=[0,1].map(()=>p.createBuffer({size:I,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}));p.queue.writeBuffer(P[0],0,new Uint32Array(g));const T=[0,1].map(()=>p.createBuffer({size:I,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST})),x=p.createBuffer({size:C,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),A=p.createBuffer({size:E,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),O=new Int32Array([l,d,u,-1,-1,-1]);p.queue.writeBuffer(A,0,O);const R=p.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:6,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:7,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}]}),N=[0,1].map(Dt=>{const ue=P[Dt],ee=T[Dt],Kt=P[(Dt+1)%2],ie=T[(Dt+1)%2];return p.createBindGroup({layout:R,entries:[{binding:0,resource:{buffer:b}},{binding:1,resource:{buffer:M}},{binding:2,resource:{buffer:ue}},{binding:3,resource:{buffer:ee}},{binding:4,resource:{buffer:Kt}},{binding:5,resource:{buffer:ie}},{binding:6,resource:{buffer:x}},{binding:7,resource:{buffer:A}}]})}),k=p.createComputePipeline({layout:p.createPipelineLayout({bindGroupLayouts:[R]}),compute:{module:S,entryPoint:"main",constants:{workGroupSizeX:e[0],workGroupSizeY:e[1],workGroupSizeZ:e[2],windowSize:o}}}),B=[Math.ceil(l/e[0]),Math.ceil(d/e[1]),Math.ceil(u/e[2])],V=p.createBuffer({size:C,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),$=a?performance.now()+a:0;let H=s.numCyclesInterval,G=0;for(let Dt=0;Dt<h;Dt++){D[_]=Dt,p.queue.writeBuffer(b,0,D);const ue=p.createCommandEncoder(),ee=ue.beginComputePass();if(ee.setPipeline(k),ee.setBindGroup(0,N[Dt%2]),ee.dispatchWorkgroups(B[0],B[1],B[2]),ee.end(),ue.copyBufferToBuffer(x,Dt*Uint32Array.BYTES_PER_ELEMENT,V,Dt*Uint32Array.BYTES_PER_ELEMENT,Uint32Array.BYTES_PER_ELEMENT),p.queue.submit([ue.finish()]),Dt>0&&!(Dt%H)){await V.mapAsync(GPUMapMode.READ,0,C);const ie=V.getMappedRange(0,C),he=new Uint32Array(ie.slice(0))[Dt]/f.length;if(V.unmap(),Dt>=1&&he<s.threshold){if(H=1,G++,G===s.numCyclesBelowThreshold)break}else H=s.numCyclesInterval}if($&&performance.now()>$){console.warn(`Exceeded processing time limit (${a})ms`);break}}const Y=p.createCommandEncoder(),q=(h+1)%2,j=p.createBuffer({size:I,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),K=p.createBuffer({size:E,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST});Y.copyBufferToBuffer(P[q],0,j,0,I),Y.copyBufferToBuffer(A,0,K,0,E),p.queue.submit([Y.finish()]),await j.mapAsync(GPUMapMode.READ,0,I);const it=j.getMappedRange(0,I),at=new Uint32Array(it);g.set(at),j.unmap(),await K.mapAsync(GPUMapMode.READ,0,E);const bt=K.getMappedRange(0,E),Bt=new Int32Array(bt.slice(0));K.unmap();const Yt=Bt[0],qt=Bt[1],Nt=Bt[2],Tt=Bt[3],Jt=Bt[4],yt=Bt[5];c.voxelManager.setCompleteScalarDataArray(g),c.voxelManager.clearBounds(),c.voxelManager.setBounds([[Yt,Tt],[qt,Jt],[Nt,yt]])}const{transformWorldToIndex:$a}=Rt,tM=254,eM=255,nM=.1,oM=.8;function iM(i,t){const{topLeftWorld:n,bottomRightWorld:e}=t,o=$a(i.imageData,n),a=$a(i.imageData,e);return{...t,topLeftIJK:o,bottomRightIJK:a}}function aM(i,t){const n=i.imageData.getDirection(),e=wt(n[3],n[4],n[5]),{center:o,radius:a}=t,s=i.imageData,r=Wt(W(),o,e,-a),c=Wt(W(),o,e,a),l=lv([c,r],s);return iM(i,l)}function sM(i,t,n){const e=i.imageData,o=n.getCamera(),{ijkVecRowDir:a,ijkVecColDir:s}=Ol(e,o);if([a,s].some(d=>!Pt(Math.abs(d[0]),1)&&!Pt(Math.abs(d[1]),1)&&!Pt(Math.abs(d[2]),1))){console.warn("Oblique view is not supported!");return}const{boundsIJK:c}=aM(i,t),l={minX:c[0][0],maxX:c[0][1]+1,minY:c[1][0],maxY:c[1][1]+1,minZ:c[2][0],maxZ:c[2][1]+1};return Lg(i.volumeId,l,{targetBuffer:{type:"Float32Array"}})}function rM(i,t,n,e){const o=i.voxelManager.getCompleteScalarDataArray(),a=n.center,[s,r,c]=i.dimensions,l=s*r,d=$a(i.imageData,a),u=o[d[2]*l+d[1]*s+d[0]],h=e.positiveSeedValue??tM,g=e.positiveSeedVariance??nM,f=Math.abs(u*g),m=u-f,v=u+f,p=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]],I=d[2]*l+d[1]*s+d[0];t.voxelManager.setAtIndex(I,h);const C=[d];for(;C.length;){const E=C.shift(),[S,_,D]=E;for(let b=0,M=p.length;b<M;b++){const P=p[b],T=S+P[0],x=_+P[1],A=D+P[2];if(T<0||T>=s||x<0||x>=r||A<0||A>=c)continue;const O=A*l+x*s+T,R=o[O];t.voxelManager.getAtIndex(O)===h||R<m||R>v||(t.voxelManager.setAtIndex(O,h),C.push([T,x,A]))}}}function cM(i,t,n,e,o){const a=i.voxelManager.getCompleteScalarDataArray(),[s,r,c]=t.dimensions,l=s*r,{worldVecRowDir:d,worldVecSliceDir:u}=Ol(t.imageData,e.getCamera()),h=$a(i.imageData,n.center),g=a[h[2]*s*r+h[1]*s+h[0]],f=o.negativeSeedVariance??oM,m=o?.negativeSeedValue??eM,v=Math.abs(g*f),p=g-v,I=g+v,C=360,E=2*Math.PI/C,S=o0(i0(),u,E),_=xn(d);for(let D=0;D<C;D++){const b=Wt(W(),n.center,_,n.radius),M=$a(t.imageData,b),[P,T,x]=M;if(a0(_,_,S),P<0||P>=s||T<0||T>=r||x<0||x>=c)continue;const A=P+T*s+x*l,O=a[A];(O<p||O>I)&&t.voxelManager.setAtIndex(A,m)}}async function lM(i,t,n,e){const o=await pr(i.volumeId);return rM(i,o,t,e),cM(i,o,t,n,e),o}async function Vv(i,t,n,e){const o=X.getVolume(i),a=sM(o,t,n),s=await lM(a,t,n,e);return await qr(a.volumeId,s.volumeId),s}const dM=254,uM=255,hM=[-1/0,-995],gM=[0,1900];function fM(i,t,n){const{negativeSeedValue:e=uM,negativePixelRange:o=hM}=n,a=i.voxelManager.getCompleteScalarDataArray(),[s,r,c]=t.dimensions,l=Math.floor(c/2),d=new Array(s*r).fill(!1),u=l*s*r,h=(f,m)=>{const v=[[f,m]];for(;v.length;){const[p,I]=v.shift(),C=I*s+p;if(p<0||p>=s||I<0||I>=r||d[C])continue;d[C]=!0;const E=u+C,S=a[E];S<o[0]||S>o[1]||(t.voxelManager.setAtIndex(E,e),v.push([p-1,I]),v.push([p+1,I]),v.push([p,I-1]),v.push([p,I+1]))}},g=(f,m,v,p)=>{for(let I=f;I!==m;I+=v){const C=p*s+I,E=u+C,S=a[E];if(S<o[0]||S>o[1])break;d[C]||h(I,p)}};for(let f=0;f<r;f++)g(0,s-1,1,f),g(s-1,0,-1,f)}function mM(i,t,n){const{positiveSeedValue:e=dM,positivePixelRange:o=gM}=n,a=i.voxelManager.getCompleteScalarDataArray();t.voxelManager.getCompleteScalarDataArray();const[s,r,c]=t.dimensions,l=Math.floor(c/2),d=Math.max(l-3,0),u=Math.max(d+5,c),h=s*r;for(let g=d;g<u;g++){const f=g*h;for(let m=0;m<r;m++){const v=m*s;for(let p=0;p<s;p++){const I=f+v+p,C=a[I];C>=o[0]&&C<=o[1]&&t.voxelManager.setAtIndex(I,e)}}}}async function pM(i,t){const n=pr(i.volumeId);return mM(i,n,t),fM(i,n,t),n}async function Fv(i,t,n){const{boundingBox:e}=t,{ijkTopLeft:o,ijkBottomRight:a}=e,s={minX:o[0],maxX:a[0],minY:o[1],maxY:a[1],minZ:o[2],maxZ:a[2]},r=Lg(i,s,{targetBuffer:{type:"Float32Array"}}),c=await pM(r,n);return await qr(r.volumeId,c.volumeId),c}const vM=254,IM=255,wM=1,Bv=1.8,CM=3.2,ll=30,EM=70,SM=50,{transformWorldToIndex:_M}=Rt,ha=1e5;function Gv(i,t,n){const{dimensions:e,imageData:o}=i,[a,s,r]=e,c=i.voxelManager,l=c.getCompleteScalarDataArray(),d=a*s,u=n?.initialNeighborhoodRadius??wM,h=n?.positiveStdDevMultiplier??Bv,g=n?.negativeStdDevMultiplier??CM,f=n?.negativeSeedMargin??ll,m=n?.negativeSeedsTargetPatches??EM,v=_M(o,t).map(Math.round),p=c.toIndex(v);if(v[0]<0||v[0]>=a||v[1]<0||v[1]>=s||v[2]<0||v[2]>=r)return console.warn("Click position is outside volume bounds."),null;const I=s0(l,e,v,u);I.count===0&&(I.mean=l[p],I.stdDev=0);const C=I.mean-h*I.stdDev,E=I.mean+h*I.stdDev,S=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]];let _=1/0,D=1/0,b=1/0,M=-1/0,P=-1/0,T=-1/0;const x=new Set,A=[],O=l[p];if(O>=C&&O<=E)x.add(p),A.push(v),_=M=v[0],D=P=v[1],b=T=v[2];else return console.warn("Clicked voxel intensity is outside the calculated positive range. No positive seeds generated."),{positiveSeedIndices:new Set,negativeSeedIndices:new Set};let R=0;for(;R<A.length&&x.size<ha;){const[Nt,Tt,Jt]=A[R++];_=Math.min(Nt,_),D=Math.min(Tt,D),b=Math.min(Jt,b),M=Math.max(Nt,M),P=Math.max(Tt,P),T=Math.max(Jt,T);for(let yt=0;yt<S.length;yt++){const[Dt,ue,ee]=S[yt],Kt=Nt+Dt,ie=Tt+ue,He=Jt+ee;if(Kt<0||Kt>=a||ie<0||ie>=s||He<0||He>=r)continue;const he=He*d+ie*a+Kt;if(x.has(he))continue;const xo=l[he];xo>=C&&xo<=E&&(x.add(he),x.size<ha&&A.push([Kt,ie,He]))}}if(x.size>=ha&&console.debug(`Reached maximum number of positive seeds (${ha}). Stopping BFS.`),x.size===0)return console.warn("No positive seeds found after BFS."),{positiveSeedIndices:new Set,negativeSeedIndices:new Set};let N=0,k=0;x.forEach(Nt=>{const Tt=l[Nt];N+=Tt,k+=Tt*Tt});const B=x.size,V=N/B,$=k/B-V*V,H=Math.sqrt(Math.max(0,$)),G=g*H,Y=Math.max(0,_-f),q=Math.max(0,D-f),j=Math.max(0,b-f),K=Math.min(a-1,M+f),it=Math.min(s-1,P+f),at=Math.min(r-1,T+f),bt=new Set;let Bt=0,Yt=0;const qt=m*SM;for(;Yt<m&&Bt<qt;){Bt++;const Nt=Math.floor(Math.random()*(K-Y+1)+Y),Tt=Math.floor(Math.random()*(it-q+1)+q),Jt=Math.floor(Math.random()*(at-j+1)+j),yt=Jt*d+Tt*a+Nt;if(x.has(yt)||bt.has(yt))continue;const Dt=l[yt];if(Math.abs(Dt-V)>G){let ue=!1;for(let ee=-1;ee<=1;ee++){const Kt=Tt+ee;if(!(Kt<0||Kt>=s))for(let ie=-1;ie<=1;ie++){const He=Nt+ie;if(He<0||He>=a)continue;const he=Jt*d+Kt*a+He;x.has(he)||bt.has(he)||(bt.add(he),ue=!0)}}ue&&Yt++}}return bt.size===0&&console.warn("Could not find any negative seeds. GrowCut might fail or produce poor results."),console.debug("positiveSeedIndices",x.size),console.debug("negativeSeedIndices",bt.size),{positiveSeedIndices:x,negativeSeedIndices:bt}}async function Wv({referencedVolumeId:i,worldPosition:t,options:n}){const e=X.getVolume(i),o=pr(i);o.voxelManager.forEach(({index:d,value:u})=>{u!==0&&o.voxelManager.setAtIndex(d,0)});const a=n.seeds??Gv(e,t,n),s=n?.positiveSeedValue??vM,r=n?.negativeSeedValue??IM;if(!a)return null;const{positiveSeedIndices:c,negativeSeedIndices:l}=a;return c.size<10||c.size>ha||l.size<10?(console.warn("Not enough seeds found. GrowCut might fail or produce poor results."),o):(c.forEach(d=>{o.voxelManager.setAtIndex(d,s)}),l.forEach(d=>{o.voxelManager.setAtIndex(d,r)}),await qr(i,o.volumeId,n),o)}const DM=Object.freeze(Object.defineProperty({__proto__:null,run:qr,runGrowCutForBoundingBox:Fv,runGrowCutForSphere:Vv,runOneClickGrowCut:Wv},Symbol.toStringTag,{value:"Module"}));function Ha(i,t){const n=pt(i);typeof t=="string"&&(console.warn("segmentIndex is a string, converting to number"),t=Number(t)),Object.values(n.segments).forEach(o=>{o.active=!1}),n.segments[t]||(n.segments[t]={segmentIndex:t,label:"",locked:!1,cachedStats:{},active:!1}),n.segments[t].active!==!0&&(n.segments[t].active=!0,gn(i));const e=oi(i);e.forEach(o=>{Ye(o,{segmentationId:i}).forEach(s=>{s.segments[t]||(s.segments[t]={visible:!0})})}),e.forEach(o=>{const a=ne(o);Rv(a.id)})}const bM=Object.freeze(Object.defineProperty({__proto__:null,getActiveSegmentIndex:$e,setActiveSegmentIndex:Ha},Symbol.toStringTag,{value:"Module"}));function TM(i,t){const{segmentationId:n,config:e}=t,o={colorLUTIndex:PM(e),...e};Vt.addSegmentationRepresentation(i,n,t.type,o);const{viewport:a}=At(i)||{};if(a&&xd(a,n,t.type),!$e(n)){let s=1;const r=Vt.getSegmentation(n);if(r){const c=Object.keys(r.segments);c.length>0&&(s=c.map(l=>Number(l)).sort()[0]),Ha(n,s)}}t.type===tt.Contour&&L([i]),t.type===tt.Surface&&Pe(n),gn(n)}function PM(i){const{colorLUTOrIndex:t}=i||{};return t===void 0?pa(JSON.parse(JSON.stringify(Qs))):typeof t=="number"?t:Array.isArray(t)&&t.every(e=>Array.isArray(e)&&e.length===4)?pa(t):pa(JSON.parse(JSON.stringify(Qs)))}function Ji(i,t){t.map(n=>TM(i,n))}function Bd(i,t){return Ji(i,t.map(n=>({...n,type:tt.Contour})))}function MM(i){const t={};for(const[n,e]of Object.entries(i))t[n]=Bd(n,e);return t}function $v(i,t){return Ji(i,t.map(n=>({...n,type:tt.Labelmap})))}function xM(i){for(const[t,n]of Object.entries(i))$v(t,n.map(e=>({...e,type:tt.Labelmap})))}function Hv(i,t){return Ji(i,t.map(n=>({...n,type:tt.Surface})))}function yM(i){const t={};for(const[n,e]of Object.entries(i))t[n]=Hv(n,e);return t}async function AM({segmentationId:i,viewportId:t,imageIds:n,options:e}){const o=pt(i);if(e?.removeOriginal){const a=o.representationData.Labelmap;X.getVolume(a.volumeId)&&X.removeVolumeLoadObject(a.volumeId),o.representationData.Labelmap={imageIds:n}}else o.representationData.Labelmap={...o.representationData.Labelmap,imageIds:n};await Ji(t,[{segmentationId:i,type:tt.Labelmap}]),z.addEventListenerOnce(w.SEGMENTATION_RENDERED,()=>Pe(i))}async function OM({volumeId:i}){return{imageIds:X.getVolume(i).imageIds}}function LM({segmentationId:i,options:t}){const n=pt(i);if(!n)return;const{volumeId:e}=n.representationData.Labelmap,o=X.getVolume(e);return AM({segmentationId:i,viewportId:t.viewportId,imageIds:o.imageIds,options:t})}async function zv(i){return Rf(i)}async function RM({segmentationId:i,segmentIndices:t,mode:n="individual"}){Wr(),kn(Qe.COMPUTE_LARGEST_BIDIRECTIONAL,0);const e=rp(i,t);if(!e)return;const{operationData:o,segImageIds:a,reconstructableVolume:s,indices:r}=e,c=s?await NM({operationData:o,indices:r,mode:n}):await UM({segImageIds:a,indices:r,mode:n});return kn(Qe.COMPUTE_LARGEST_BIDIRECTIONAL,100),c}async function NM({operationData:i,indices:t,mode:n}){const e=cp(i),{segmentationVoxelManager:o,segmentationImageData:a}=e,r={scalarData:o.getCompleteScalarDataArray(),dimensions:a.getDimensions(),spacing:a.getSpacing(),origin:a.getOrigin(),direction:a.getDirection()};return await ti().executeTask("compute","getSegmentLargestBidirectionalInternal",{segmentationInfo:r,indices:t,mode:n})}async function UM({segImageIds:i,indices:t,mode:n}){const{segmentationInfo:e}=lp(i);return await ti().executeTask("compute","getSegmentLargestBidirectionalInternal",{segmentationInfo:e,indices:t,mode:n,isStack:!0})}function kM(i){const t=pt(i);if(!t)return null;let n;const e=t.representationData.Labelmap;if("imageIds"in e){const{imageIds:o}=e,a=X.getImage(o[0]),s=X.getVolumeContainingImageId(a.referencedImageId);if(s?.volume)return s.volume;n=o.map(r=>X.getImage(r).referencedImageId)}else if("volumeId"in e){const{volumeId:o,referencedVolumeId:a}=e;if(a){const r=X.getVolume(a);if(r)return r}const s=X.getVolume(o);s&&(n=s.imageIds.map(r=>X.getImage(r).referencedImageId))}return Hr(n)}async function VM({segmentationIds:i,segmentIndex:t}){Wr(),kn(Qe.COMPUTE_STATISTICS,0);const n=pt(i[0]),{imageIds:e}=n.representationData.Labelmap;if(!ei(e))throw new Error("Invalid volume - TMTV cannot be calculated");return await FM({segmentationIds:i,segmentIndex:t})}async function FM({segmentationIds:i,segmentIndex:t}){const n=i.map(m=>Yi(m)),e=mv(n,t);if(!e)throw new Error("Invalid volume - TMTV cannot be calculated");const{imageData:o,dimensions:a,direction:s,origin:r,voxelManager:c}=e,l=o.getSpacing(),u={scalarData:c.getCompleteScalarDataArray(),dimensions:a,spacing:l,origin:r,direction:s},h=kM(i[0]),g={dimensions:h.dimensions,spacing:h.spacing,origin:h.origin,direction:h.direction,scalarData:h.voxelManager.getCompleteScalarDataArray()};if(g.scalarData.length===0||u.scalarData.length===0)return{[t]:{name:"TMTV",value:0}};const f=await ti().executeTask("compute","computeMetabolicStats",{segmentationInfo:u,imageInfo:g});return kn(Qe.COMPUTE_STATISTICS,100),f}const BM=Object.freeze(Object.defineProperty({__proto__:null,IslandRemoval:Jo,LabelmapMemo:PP,SegmentStatsCalculator:cl,VolumetricCalculator:jo,computeMetabolicStats:VM,computeStackLabelmapFromVolume:OM,computeVolumeLabelmapFromStack:zv,contourAndFindLargestBidirectional:Ov,createBidirectionalToolData:Lv,createLabelmapVolumeForViewport:$T,createMergedLabelmapForIndex:mv,floodFill:kd,getBrushSizeForToolGroup:NP,getBrushThresholdForToolGroup:kP,getBrushToolInstances:Zi,getHoveredContourSegmentationAnnotation:kv,getOrCreateImageVolume:Hr,getOrCreateSegmentationVolume:Yi,getReferenceVolumeForSegmentationVolume:ip,getSegmentIndexAtLabelmapBorder:Nv,getSegmentIndexAtWorldPoint:Fd,getSegmentLargestBidirectional:RM,getStatistics:wv,getUniqueSegmentIndices:xm,growCut:DM,invalidateBrushCursor:Rv,rectangleROIThresholdVolumeByRange:GT,segmentContourAction:jP,setBrushSizeForToolGroup:RP,setBrushThresholdForToolGroup:UP,thresholdSegmentationByRange:VP,thresholdVolumeByRange:uv,triggerSegmentationRender:qi,triggerSegmentationRenderBySegmentationId:zr,validateLabelmap:_D},Symbol.toStringTag,{value:"Module"}));function GM(i){let t="";const n=i[0]<0?"R":"L",e=i[1]<0?"A":"P",o=i[2]<0?"F":"H",a=[Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2])],s=1e-4;for(let r=0;r<3;r++)if(a[0]>s&&a[0]>a[1]&&a[0]>a[2])t+=n,a[0]=0;else if(a[1]>s&&a[1]>a[0]&&a[1]>a[2])t+=e,a[1]=0;else if(a[2]>s&&a[2]>a[0]&&a[2]>a[1])t+=o,a[2]=0;else if(a[0]>s&&a[1]>s&&a[0]===a[1])t+=n+e,a[0]=0,a[1]=0;else if(a[0]>s&&a[2]>s&&a[0]===a[2])t+=n+o,a[0]=0,a[2]=0;else if(a[1]>s&&a[2]>s&&a[1]===a[2])t+=e+o,a[1]=0,a[2]=0;else break;return t}function WM(i){let t=i.replace("H","f");return t=t.replace("F","h"),t=t.replace("R","l"),t=t.replace("L","r"),t=t.replace("A","p"),t=t.replace("P","a"),t=t.toUpperCase(),t}const $M=Object.freeze(Object.defineProperty({__proto__:null,getOrientationStringLPS:GM,invertOrientationStringLPS:WM},Symbol.toStringTag,{value:"Module"}));var Mi;(function(i){i.CLIP_STOPPED="CORNERSTONE_CINE_TOOL_STOPPED",i.CLIP_STARTED="CORNERSTONE_CINE_TOOL_STARTED"})(Mi||(Mi={}));const Gd={};function jv(i,t){const n=y(i),{viewportId:e}=n;Gd[e]=t}function Wd(i){const t=y(i),{viewportId:n}=t;return Gd[n]}function HM(i){return Gd[i]}const{ViewportStatus:Xv}=fr,{triggerEvent:_c}=Rt,Yv=!0,dl=new Map;function zM(i,t){let n,e;if(i===void 0)throw new Error("playClip: element must not be undefined");const o=y(i);if(!o)throw new Error("playClip: element must be a valid Cornerstone enabled element");t||(t={}),t.dynamicCineEnabled=t.dynamicCineEnabled??!0;const{viewport:a}=o,s=ZM(a,t);let r=Wd(i);const c=t.dynamicCineEnabled;if(c&&Kv(i),r?ul(i,{stopDynamicCine:!c,viewportId:a.id}):(r={intervalId:void 0,framesPerSecond:30,lastFrameTimeStamp:void 0,ignoreFrameTimeVector:!1,usingFrameTimeVector:!1,frameTimeVector:t.frameTimeVector??void 0,speed:t.frameTimeVectorSpeedMultiplier??1,reverse:t.reverse??!1,loop:t.loop??!0,bounce:t.bounce??!1},jv(i,r)),r.dynamicCineEnabled=t.dynamicCineEnabled,(t.framesPerSecond<0||t.framesPerSecond>0)&&(r.framesPerSecond=Number(t.framesPerSecond),r.reverse=r.framesPerSecond<0,r.ignoreFrameTimeVector=!0),r.ignoreFrameTimeVector!==!0&&r.frameTimeVector&&r.frameTimeVector.length===s.numScrollSteps&&s.frameTimeVectorEnabled){const{timeouts:u,isTimeVarying:h}=jM(r.frameTimeVector,r.speed);n=u,e=h}t.bounce!==void 0&&(r.bounce=t.bounce);const l=()=>{const{numScrollSteps:u,currentStepIndex:h}=s;let g=h+(r.reverse?-1:1);if(g<0||g>=u)if(r.bounce)r.reverse=!r.reverse,g=h+(r.reverse?-1:1),g=Math.max(0,Math.min(u-1,g));else if(r.loop)g=r.reverse?u-1:0;else{ul(i,{stopDynamicCine:!c,viewportId:a.id}),_c(i,Mi.CLIP_STOPPED,{element:i});return}const m=g-h;if(m)try{s.scroll(m)}catch(v){console.warn("Play clip not scrolling",v),Zv(r),_c(i,Mi.CLIP_STOPPED,{element:i})}};if(c){const u=$d(a);u&&dl.set(u.volumeId,i)}s.play?r.framesPerSecond=s.play(t.framesPerSecond):n&&n.length>0&&e?(r.usingFrameTimeVector=!0,r.intervalId=window.setTimeout(function u(){r.intervalId=window.setTimeout(u,n[s.currentStepIndex]),l()},0)):(r.usingFrameTimeVector=!1,r.intervalId=window.setInterval(l,1e3/Math.abs(r.framesPerSecond)));const d={element:i};_c(i,Mi.CLIP_STARTED,d)}function qv(i,t={}){ul(i,{stopDynamicCine:!0,...t})}function ul(i,t={stopDynamicCine:!0,viewportId:void 0}){const{stopDynamicCine:n,viewportId:e}=t,o=y(i);let a;const s=o?.viewport;if(o){const{viewport:r}=o;a=Wd(r.element)}else if(e)a=HM(e);else return;a&&Zv(a),s instanceof Rg?s.pause():n&&s instanceof ve&&Kv(i)}function Kv(i){const{viewport:t}=y(i);if(t instanceof ae){const n=$d(t);if(n?.isDynamicVolume()){const e=dl.get(n.volumeId);dl.delete(n.volumeId),e&&e!==i&&qv(e)}}}function jM(i,t){let n,e,o,a=0;const s=i.length,r=[];let c=!1;for((typeof t!="number"||t<=0)&&(t=1),n=1;n<s;n++)o=Number(i[n])/t|0,r.push(o),n===1?e=o:o!==e&&(c=!0),a+=o;return r.length>0&&(c?o=a/r.length|0:o=r[0],r.push(o)),{timeouts:r,isTimeVarying:c}}function Zv(i){const t=i.intervalId;typeof t<"u"&&(i.intervalId=void 0,i.usingFrameTimeVector?clearTimeout(t):clearInterval(t))}function $d(i){if(!(i instanceof ae))return;const t=i.getAllVolumeIds();if(!t?.length)return;const e=t.find(o=>X.getVolume(o)?.isDynamicVolume())??t[0];return X.getVolume(e)}function XM(i,t){const n=i.getImageIds();return{get numScrollSteps(){return n.length},get currentStepIndex(){return i.getTargetImageIdIndex()},get frameTimeVectorEnabled(){return!0},waitForRenderedCount:0,scroll(e){if(this.waitForRenderedCount<=t&&i.viewportStatus!==Xv.RENDERED){this.waitForRenderedCount++;return}this.waitForRenderedCount=0,ya(i,{delta:e,debounceLoading:Yv})}}}function YM(i,t){return{get numScrollSteps(){return i.getNumberOfSlices()},get currentStepIndex(){return i.getSliceIndex()},get frameTimeVectorEnabled(){return!0},waitForRenderedCount:0,scroll(n){if(this.waitForRenderedCount<=t&&i.viewportStatus!==Xv.RENDERED){this.waitForRenderedCount++;return}this.waitForRenderedCount=0,ya(i,{delta:n,debounceLoading:Yv})},play(n){return n&&i.setPlaybackRate(n/24),i.play(),i.getFrameRate()}}}function qM(i,t){const{volumeId:n}=t,e={viewPlaneNormal:W(),scrollInfo:null},o=()=>{const a=i.getCamera();if(!e.scrollInfo||!c0(a.viewPlaneNormal,e.viewPlaneNormal)){const r=r0(i,n);e.viewPlaneNormal=a.viewPlaneNormal,e.scrollInfo=r}return e.scrollInfo};return{get numScrollSteps(){return o().numScrollSteps},get currentStepIndex(){return o().currentStepIndex},get frameTimeVectorEnabled(){const a=i.getCamera(),s=t.direction.slice(6,9).map(c=>-c),r=dt(s,a.viewPlaneNormal);return xa(r,1)},scroll(a){o().currentStepIndex+=a,ya(i,{delta:a})}}}function KM(i){return{get numScrollSteps(){return i.numDimensionGroups},get currentStepIndex(){return i.dimensionGroupNumber-1},get frameTimeVectorEnabled(){return!1},scroll(t){i.scroll(t)}}}function ZM(i,t){if(i instanceof Ie)return XM(i,t.waitForRendered??30);if(i instanceof ae){const n=$d(i);return t.dynamicCineEnabled&&n?.isDynamicVolume()?KM(n):qM(i,n)}if(i instanceof Rg)return YM(i,t.waitForRendered??30);throw new Error("Unknown viewport type")}const JM=Object.freeze(Object.defineProperty({__proto__:null,Events:Mi,addToolState:jv,getToolState:Wd,playClip:zM,stopClip:qv},Symbol.toStringTag,{value:"Module"}));function QM(i,t){const n=t?.knotsRatioPercentage||30;return!i?.data?.contour?.polyline?.length||n<=0}function tx(i,t){const n=mr(),e=je(W(),t,i),o=Math.abs(i[0])>.1?wt(-i[1],i[0],0):wt(0,-i[2],i[1]);return d0(n,t,e,o),n}function bs(i,t=Math.floor(Math.random()*(i.length-1))){if(t===0)return 0;const n=[...i],{length:e}=i;for(let o=0;o<e;o++)i[o]=n[(o+t+e)%e];return t}function Jv(i,t){if(QM(i,t))return!1;const{viewPlaneNormal:n}=i.metadata,{closed:e,polyline:o}=i.data.contour,a=tx(n,i.data.contour.polyline[0]),s=i.data.contour.polyline.map(d=>{const u=Se(W(),d,a);return[u[0],u[1]]});let r=e?bs(s):0,c=Js(s,0,s.length-1,t?.knotsRatioPercentage||30);if(c===s)return!1;bs(c,-r);for(let d=1;d<t?.loop;d++)r=e?bs(c):0,c=Js(c,0,c.length-1,t?.knotsRatioPercentage||30),bs(c,-r);const l=l0(mr(),a);return i.data.contour.polyline=c.map(d=>Se([0,0,0],[...d,0],l)),!0}const ex={smoothAnnotation:Jv},nx=Object.freeze(Object.defineProperty({__proto__:null,default:ex,smoothAnnotation:Jv},Symbol.toStringTag,{value:"Module"})),{isEqual:Ts}=Rt,ox=wt(1,0,0),ix=wt(0,1,0),ax=wt(0,0,1),Fh=[ox,ix,ax];function sx(i){const t=oe(W(),i[0],i[1]),n=oe(W(),i[0],i[2]),e=Bh(t,Fh),o=Bh(n,Fh);return[...e,...o].every(s=>Ts(s,0)||Ts(s,90)||Ts(s,180)||Ts(s,270))}function Bh(i,t){return t.map(n=>u0(i,n)*180/Math.PI)}const rx=Object.freeze(Object.defineProperty({__proto__:null,getBoundsIJKFromRectangleAnnotations:fv,isAxisAlignedRectangle:sx},Symbol.toStringTag,{value:"Module"})),Qv={};function tI(i,t){const n=y(i),{viewportId:e}=n;Qv[e]=t}function Qi(i){const t=y(i),{viewportId:n}=t;return Qv[n]}const Xo=h0.Prefetch,cx=0;function lx(i,t){i=Math.round(i)||0,t=Math.round(t)||0;const n=[];let e=t-i+1;if(e<=0)return n;for(;e--;)n[e]=t--;return n}function dx(i,t){let n=0,e=i.length-1;return i.forEach((o,a)=>{o<t?n=Math.max(a,n):o>t&&(e=Math.min(a,e))}),{low:n,high:e}}function ta(i){const t=y(i);if(!t)return null;const{viewport:n}=t;return n instanceof Ie?{currentImageIdIndex:n.getCurrentImageIdIndex(),imageIds:n.getImageIds()}:null}function Kr(i){return function(t){const n=t.detail;let e;try{e=ta(i)}catch{return}if(!e||!e.imageIds||e.imageIds.length===0)return;const a=e.imageIds.indexOf(n.imageId);if(a<0)return;const s=Qi(i);!s||!s.indicesToRequest||!s.indicesToRequest.length||s.indicesToRequest.push(a)}}const ux=i=>{const t=new Set(i.imageIds);return n=>n.type!==Xo||!t.has(n.additionalDetails.imageId)},{imageRetrieveMetadataProvider:hx}=Rt;let va={maxImagesToPrefetch:1/0,preserveExistingPool:!0},hl;const gx=10;function eI(i){const t=Qi(i);if(!t)return;const n=t||{},e=ta(i);if(!e?.imageIds?.length){console.warn("CornerstoneTools.stackPrefetch: No images in stack.");return}const{currentImageIdIndex:o}=e;if(n.enabled=n.enabled&&(n.indicesToRequest?.length??0)>0,n.enabled===!1)return;function a(m){const v=n.indicesToRequest.indexOf(m);v>-1&&n.indicesToRequest.splice(v,1)}if(t.indicesToRequest.sort((m,v)=>m-v),n.indicesToRequest.slice().forEach(function(m){const v=e.imageIds[m];if(!v)return;(Math.abs(o-m)<6?X.getImageLoadObject(v):X.isLoaded(v))&&a(m)}),!n.indicesToRequest.length)return;va.preserveExistingPool||Aa.clearRequestStack(Xo);const r=dx(n.indicesToRequest,e.currentImageIdIndex);let c,l;function d(m){console.log("prefetch done: %s",m);const v=e.imageIds.indexOf(m);if(a(v),n.indicesToRequest.length===0){const p={element:i,lastPrefetchedImageId:m};gt(z,w.STACK_PREFETCH_COMPLETE,p)}}let u=r.low,h=r.high;const g=[];for(;u>=0||h<n.indicesToRequest.length;){const m=e.currentImageIdIndex,v=m-n.indicesToRequest[u]>va.maxImagesToPrefetch,p=n.indicesToRequest[h]-m>va.maxImagesToPrefetch,I=!v&&u>=0,C=!p&&h<n.indicesToRequest.length;if(!C&&!I)break;I&&(l=n.indicesToRequest[u--],c=e.imageIds[l],g.push(c)),C&&(l=n.indicesToRequest[h++],c=e.imageIds[l],g.push(c))}const f=(m,v)=>{const{retrieveOptions:p={}}=ye(hx.IMAGE_RETRIEVE_CONFIGURATION,m,"stack")||{};return v.retrieveOptions={...v.retrieveOptions,...p.default||Object.values(p)?.[0]||{}},Ng(m,v).then(()=>d(m))};g.forEach(m=>{const v={requestType:Xo};Aa.addRequest(f.bind(null,m,v),Xo,{imageId:m},cx)})}function gl(i){clearTimeout(hl),hl=setTimeout(function(){const t=i.target;try{eI(t)}catch{return}},gx)}function fx(i){const t=ta(i);if(!t||!t.imageIds||t.imageIds.length===0){console.warn("CornerstoneTools.stackPrefetch: No images in stack.");return}const n={indicesToRequest:lx(0,t.imageIds.length-1),enabled:!0,direction:1},e=n.indicesToRequest.indexOf(t.currentImageIdIndex);n.indicesToRequest.splice(e,1),tI(i,n),eI(i),i.removeEventListener(ut.STACK_NEW_IMAGE,gl),i.addEventListener(ut.STACK_NEW_IMAGE,gl);const o=Kr(i);z.removeEventListener(ut.IMAGE_CACHE_IMAGE_REMOVED,o),z.addEventListener(ut.IMAGE_CACHE_IMAGE_REMOVED,o)}function mx(i){clearTimeout(hl),i.removeEventListener(ut.STACK_NEW_IMAGE,gl);const t=Kr(i);z.removeEventListener(ut.IMAGE_CACHE_IMAGE_REMOVED,t);const n=Qi(i);n&&n.indicesToRequest.length&&(n.enabled=!1,Aa.clearRequestStack(Xo))}function px(){return va}function vx(i){va=i}const Ix={enable:fx,disable:mx,getConfiguration:px,setConfiguration:vx},{imageRetrieveMetadataProvider:wx}=Rt;let za={maxImagesToPrefetch:1/0,minBefore:2,maxAfter:2,directionExtraImages:10,preserveExistingPool:!1},fl;const Cx=5,nI={},Ex=(i,t=0)=>{const n=ta(i);if(!n)return;if(!n.imageIds?.length){console.warn("CornerstoneTools.stackPrefetch: No images in stack.");return}zd(i),nI[i]=t,Hd(i,t),i.removeEventListener(ut.STACK_NEW_IMAGE,ml),i.addEventListener(ut.STACK_NEW_IMAGE,ml);const e=Kr(i);z.removeEventListener(ut.IMAGE_CACHE_IMAGE_REMOVED,e),z.addEventListener(ut.IMAGE_CACHE_IMAGE_REMOVED,e)};function Hd(i,t=0){const n=ta(i);if(!n)return;if(!n?.imageIds?.length){console.warn("CornerstoneTools.stackPrefetch: No images in stack.");return}const e=Qi(i);if(!e)return;const o=e||{};if(o.enabled=o.enabled&&(o.indicesToRequest?.length??0)>0,o.enabled===!1)return;function a(d){const u=o.indicesToRequest.indexOf(d);u>-1&&o.indicesToRequest.splice(u,1)}const s=o.indicesToRequest.slice(),{currentImageIdIndex:r}=n;if(s.forEach(d=>{const u=n.imageIds[d];if(!u)return;(Math.abs(r-d)<6?X.getImageLoadObject(u):X.isLoaded(u))&&a(d)}),!o.indicesToRequest.length)return;za.preserveExistingPool||Aa.filterRequests(ux(n));function c(d){const u=n.imageIds.indexOf(d);a(u);const h=X.getCachedImageBasedOnImageURI(d),{stats:g}=o,f=h?.image?.decodeTimeInMS||0;if(f){g.imageIds.set(d,f),g.decodeTimeInMS+=f;const m=h?.image?.loadTimeInMS||0;g.loadTimeInMS+=m}if(!o.indicesToRequest.length&&h?.sizeInBytes){const{sizeInBytes:m}=h,v=X.getMaxCacheSize()/4/m;if(!o.cacheFill)g.initialTime=Date.now()-g.start,g.initialSize=g.imageIds.size,zd(i,v),Hd(i,t);else if(g.imageIds.size){g.fillTime=Date.now()-g.start;const{size:p}=g.imageIds;g.fillSize=p}}if(o.indicesToRequest.length===0){const m={element:i,lastPrefetchedImageId:d};gt(z,w.STACK_PREFETCH_COMPLETE,m)}}const l=(d,u)=>{const{retrieveOptions:h={}}=ye(wx.IMAGE_RETRIEVE_CONFIGURATION,d,"stack")||{};return u.retrieveOptions={...u.retrieveOptions,...h.default||Object.values(h)?.[0]||{}},Ng(d,u).then(()=>c(d))};o.indicesToRequest.forEach(d=>{const u=n.imageIds[d],h={requestType:Xo};Aa.addRequest(l.bind(null,u,h),Xo,{imageId:u},t)})}function ml(i){clearTimeout(fl),fl=setTimeout(function(){const t=i.target;try{zd(t),Hd(t,nI[t])}catch{return}},Cx)}const Sx=i=>i<0?-1:1,zd=(i,t)=>{const n=ta(i);if(!n)return;if(!n.imageIds?.length){console.warn("CornerstoneTools.stackPrefetch: No images in stack.");return}const{currentImageIdIndex:e}=n;let{maxAfter:o=2,minBefore:a=2}=za;const{directionExtraImages:s=10}=za,r=Qi(i)||{indicesToRequest:[],currentImageIdIndex:e,stackCount:0,enabled:!0,direction:1,stats:{start:Date.now(),imageIds:new Map,decodeTimeInMS:0,loadTimeInMS:0,totalBytes:0}},c=e-r.currentImageIdIndex;if(r.direction=Sx(c),r.currentImageIdIndex=e,r.enabled=!0,r.stackCount<100&&(r.stackCount+=s),Math.abs(c)>o||!c)if(r.stackCount=0,t){const h=e/n.imageIds.length;a=Math.ceil(t*h),o=Math.ceil(t*(1-h)),r.cacheFill=!0}else r.cacheFill=!1;else c<0?(a+=r.stackCount,o=0):(o+=r.stackCount,a=0);const l=Math.max(0,e-a),d=Math.min(n.imageIds.length-1,e+o),u=[];for(let h=e+1;h<=d;h++)u.push(h);for(let h=e-1;h>=l;h--)u.push(h);r.indicesToRequest=u,tI(i,r)};function _x(i){clearTimeout(fl),i.removeEventListener(ut.STACK_NEW_IMAGE,ml);const t=Kr(i);z.removeEventListener(ut.IMAGE_CACHE_IMAGE_REMOVED,t);const n=Qi(i);n&&(n.enabled=!1)}function Dx(){return za}function bx(i){za=i}const Tx={enable:Ex,disable:_x,getConfiguration:Dx,setConfiguration:bx},Px=Object.freeze(Object.defineProperty({__proto__:null,isViewportPreScaled:io},Symbol.toStringTag,{value:"Module"}));function Mx(i,t){let n;const e=t.dimensionGroupNumbers||t.frameNumbers||Array.from({length:i.numDimensionGroups},(o,a)=>a+1);if(t.frameNumbers&&console.warn("Warning: frameNumbers parameter is deprecated. Please use dimensionGroupNumbers instead."),!t.maskVolumeId&&!t.worldCoordinate)throw new Error("You should provide either maskVolumeId or imageCoordinate");if(t.maskVolumeId&&t.worldCoordinate)throw new Error("You can only use one of maskVolumeId or imageCoordinate");if(t.maskVolumeId){const o=X.getVolume(t.maskVolumeId);if(!o)throw new Error("Segmentation volume not found");const[a,s]=yx(e,i,o);return[a,s]}return t.worldCoordinate?xx(e,t.worldCoordinate,i):n}function xx(i,t,n){const{dimensions:e,imageData:o}=n,a=o.worldToIndex(t);if(a[0]=Math.floor(a[0]),a[1]=Math.floor(a[1]),a[2]=Math.floor(a[2]),!we(a,e))throw new Error("outside bounds");const s=e[0],r=e[0]*e[1],c=[];return i.forEach(l=>{const d=a[2]*r+a[1]*s+a[0];c.push(n.voxelManager.getAtIndexAndDimensionGroup(d,l))}),c}function yx(i,t,n){const{imageData:e}=n,o=n.voxelManager,a=o.getScalarDataLength(),s=[];s.length=a;let r=0;for(let h=0,g=a;h<g;h++)o.getAtIndex(h)!==0&&(s[r++]=h);s.length=r;const c=[],l=t.voxelManager.getScalarDataLength()===a&&JSON.stringify(t.spacing)===JSON.stringify(n.spacing),d=[];if(l){for(let h=0;h<s.length;h++){const g=[],f=s[h];for(let m=0;m<i.length;m++)g.push(t.voxelManager.getAtIndexAndDimensionGroup(f,i[m]));c.push(g),d.push(o.toIJK(f))}return[c,d]}const u=({pointLPS:h,value:g,pointIJK:f})=>{if(g===0)return;const m=Wl(t.imageData,t.dimensions,t.spacing,h);let v=0;const p=new Map;i.forEach(E=>p.set(E,0));const I=({index:E})=>{for(let S=0;S<i.length;S++){const _=t.voxelManager.getAtIndexAndDimensionGroup(E,i[S]),D=i[S];p.set(D,p.get(D)+_)}v++};t.voxelManager.forEach(I,{imageData:t.imageData,boundsIJK:m});const C=[];p.forEach(E=>{C.push(E/v)}),d.push(f),c.push(C)};return n.voxelManager.forEach(u,{imageData:e}),[c,d]}function oI(i,t){const n=i.getScalarDataLength(),e=new Float32Array(n);for(const o of t){const a=i.getDimensionGroupScalarData(o);for(let s=0;s<n;s++)e[s]+=a[s]}return e}function Ax(i,t){const n=oI(i,t),e=t.length;for(let o=0;o<n.length;o++)n[o]/=e;return n}const iI={[Qr.SUM]:(i,t,n)=>{const e=oI(i,t);for(let o=0;o<e.length;o++)n(o,e[o])},[Qr.AVERAGE]:(i,t,n)=>{const e=Ax(i,t);for(let o=0;o<e.length;o++)n(o,e[o])},[Qr.SUBTRACT]:(i,t,n)=>{if(t.length!==2)throw new Error("Please provide only 2 dimension groups for subtraction.");const e=i.getScalarDataLength(),o=i.getDimensionGroupScalarData(t[0]),a=i.getDimensionGroupScalarData(t[1]);for(let s=0;s<e;s++){const r=o[s]-a[s];n(s,r)}}};function Ox(i,t,n){const{dimensionGroupNumbers:e,frameNumbers:o}=n;o&&console.warn("Warning: frameNumbers parameter is deprecated. Please use dimensionGroupNumbers instead.");const a=e||o||Array.from({length:i.numDimensionGroups},(d,u)=>u+1);if(a.length<=1)throw new Error("Please provide two or more dimension groups");const s=i.voxelManager,r=s.getScalarDataLength(),c=iI[t];if(!c)throw new Error(`Unsupported operation: ${t}`);const l=new Float32Array(r);return c(s,a,(d,u)=>{l[d]=u}),l}function Lx(i,t,n){const{dimensionGroupNumbers:e,frameNumbers:o,targetVolume:a}=n;if(!a)throw new Error("A target volume must be provided");o&&console.warn("Warning: frameNumbers parameter is deprecated. Please use dimensionGroupNumbers instead.");const s=e||o||Array.from({length:i.numDimensionGroups},(d,u)=>u+1);if(s.length<=1)throw new Error("Please provide two or more dimension groups");const r=i.voxelManager,c=a.voxelManager,l=iI[t];if(!l)throw new Error(`Unsupported operation: ${t}`);l(r,s,(d,u)=>{c.setAtIndex(d,u)}),c.resetModifiedSlices();for(let d=0;d<a.dimensions[2];d++)c.modifiedSlices.add(d)}const Rx=Object.freeze(Object.defineProperty({__proto__:null,generateImageFromTimeData:Ox,getDataInTime:Mx,updateVolumeFromTimeData:Lx},Symbol.toStringTag,{value:"Module"}));function aI(i,t){const n=t*3;if(n<i.length)return wt(i[n],i[n+1],i[n+2])}function sI(i){const t=i.getLines().getData();let n=0;const e=new Map;for(;n<t.length;){const r=t[n++],c=[];for(let l=0;l<r;l++)c.push(t[n+l]);e.set(c[0],c),n+=r}const o=[],a=r=>{for(const[c,l]of r.entries())if(l!==void 0)return c;return-1};let s=a(e);for(;s!==-1;){const r=[s];for(;e.has(s);){const c=e.get(s)[1];e.has(c)&&r.push(c),e.delete(s),s=c}o.push(r),s=a(e)}return o.length?o:void 0}function rI(i){const t=sI(i);if(!t)return;const n=i.getPoints().getData();return t.map(e=>e.map(o=>aI(n,o)))}const Nx=Object.freeze(Object.defineProperty({__proto__:null,getPoint:aI,getPolyDataPointIndexes:sI,getPolyDataPoints:rI},Symbol.toStringTag,{value:"Module"}));var Ze;(function(i){i.Top="top",i.Left="left",i.Bottom="bottom",i.Right="right"})(Ze||(Ze={}));const Ux=Object.freeze(Object.defineProperty({__proto__:null,get ColorbarRangeTextPosition(){return Ze}},Symbol.toStringTag,{value:"Module"})),qn=i=>i&&i.upper>i.lower,sr=i=>!!i&&i.width>0&&i.height>0,ja=(i,t)=>!!i&&!!t&&i.lower===t.lower&&i.upper===t.upper,cI=(i,t)=>!!i&&!!t&&i.width===t.width&&i.height===t.height,kx=(i,t,n)=>[i[0]*(1-n)+t[0]*n,i[1]*(1-n)+t[1]*n,i[2]*(1-n)+t[2]*n],{clamp:Vx}=Rt;class jd{constructor(t){jd.validateProps(t);const{colormap:n,size:e={width:20,height:100},imageRange:o={lower:0,upper:1},voiRange:a={lower:0,upper:1},container:s,showFullPixelValueRange:r=!1}=t;this._colormap=n,this._imageRange=o,this._voiRange=a,this._showFullImageRange=r,this._canvas=this._createRootElement(e),s&&this.appendTo(s)}get colormap(){return this._colormap}set colormap(t){this._colormap=t,this.render()}get size(){const{width:t,height:n}=this._canvas;return{width:t,height:n}}set size(t){const{_canvas:n}=this;!sr(t)||cI(n,t)||(this._setCanvasSize(n,t),this.render())}get imageRange(){return{...this._imageRange}}set imageRange(t){!qn(t)||ja(t,this._imageRange)||(this._imageRange=t,this.render())}get voiRange(){return{...this._voiRange}}set voiRange(t){!qn(t)||ja(t,this._voiRange)||(this._voiRange=t,this.render())}get showFullImageRange(){return this._showFullImageRange}set showFullImageRange(t){t!==this._showFullImageRange&&(this._showFullImageRange=t,this.render())}appendTo(t){t.appendChild(this._canvas),this.render()}dispose(){const{_canvas:t}=this,{parentElement:n}=t;n?.removeChild(t)}static validateProps(t){const{size:n,imageRange:e,voiRange:o}=t;if(n&&!sr(n))throw new Error('Invalid "size"');if(e&&!qn(e))throw new Error('Invalid "imageRange"');if(o&&!qn(o))throw new Error('Invalid "voiRange"')}_setCanvasSize(t,n){const{width:e,height:o}=n;t.width=e,t.height=o,Object.assign(t.style,{width:`${e}px`,height:`${o}px`})}_createRootElement(t){const n=document.createElement("canvas");return Object.assign(n.style,{position:"absolute",top:"0",left:"0",pointerEvents:"none",boxSizing:"border-box"}),this._setCanvasSize(n,t),n}render(){if(!this._canvas.isConnected)return;const{_colormap:t}=this,{RGBPoints:n}=t,e=n.length/4,o=v=>{const p=4*v;if(!(v<0||v>=e))return{index:v,position:n[p],color:[n[p+1],n[p+2],n[p+3]]}},{width:a,height:s}=this._canvas,r=this._canvas.getContext("2d");if(!r)return;const c=a>s,l=c?a:s,{_voiRange:d}=this,u=this._showFullImageRange?this._imageRange:{...d};let h,g=o(0);const f=(u.upper-u.lower)/(l-1);let m=u.lower;for(let v=0;v<l;v++){const p=(m-d.lower)/Math.abs(d.upper-d.lower);if(g)for(let E=g.index;E<e&&!(p<=g.position);E++)h=g,g=o(E+1);let I;if(!h)I=[...g.color];else if(!g)I=[...h.color];else{const E=(p-h.position)/(g.position-h.position);I=kx(h.color,g.color,E)}const C=I.map(E=>Vx(Math.round(E*255),0,255));r.fillStyle=`rgb(${C[0]}, ${C[1]}, ${C[2]})`,c?r.fillRect(v,0,1,s):r.fillRect(0,s-v-1,a,1),m+=f}}}const Oo={FONT:"10px Arial",COLOR:"white",TICK_SIZE:5,TICK_WIDTH:1,TICK_LABEL_MARGIN:3,MAX_NUM_TICKS:8,TICKS_STEPS:[1,2.5,5,10]};class Xd{constructor(t){Xd.validateProps(t);const{top:n=0,left:e=0,size:o={width:20,height:100},imageRange:a={lower:0,upper:1},voiRange:s={lower:0,upper:1},ticks:r,container:c,showFullPixelValueRange:l=!1}=t,{style:d,position:u}=r??{};this._imageRange=a,this._voiRange=s,this._font=d?.font??Oo.FONT,this._color=d?.color??Oo.COLOR,this._tickSize=d?.tickSize??Oo.TICK_SIZE,this._tickWidth=d?.tickWidth??Oo.TICK_WIDTH,this._labelMargin=d?.labelMargin??Oo.TICK_LABEL_MARGIN,this._maxNumTicks=d?.maxNumTicks??Oo.MAX_NUM_TICKS,this._rangeTextPosition=u??Ze.Right,this._showFullPixelValueRange=l,this._canvas=this._createCanvasElement(o,n,e),c&&this.appendTo(c)}get size(){const{width:t,height:n}=this._canvas;return{width:t,height:n}}set size(t){const{_canvas:n}=this;!sr(t)||cI(n,t)||(this._setCanvasSize(n,t),this.render())}get top(){return Number.parseInt(this._canvas.style.top)}set top(t){const{_canvas:n}=this,e=this.top;t!==e&&(n.style.top=`${t}px`,this.render())}get left(){return Number.parseInt(this._canvas.style.left)}set left(t){const{_canvas:n}=this,e=this.left;t!==e&&(n.style.left=`${t}px`,this.render())}get imageRange(){return{...this._imageRange}}set imageRange(t){!qn(t)||ja(t,this._imageRange)||(this._imageRange=t,this.render())}get voiRange(){return{...this._voiRange}}set voiRange(t){!qn(t)||ja(t,this._voiRange)||(this._voiRange=t,this.render())}get tickSize(){return this._tickSize}set tickSize(t){t!==this._tickSize&&(this._tickSize=t,this.render())}get tickWidth(){return this._tickWidth}set tickWidth(t){t!==this._tickWidth&&(this._tickWidth=t,this.render())}get color(){return this._color}set color(t){t!==this._color&&(this._color=t,this.render())}get showFullPixelValueRange(){return this._showFullPixelValueRange}set showFullPixelValueRange(t){t!==this._showFullPixelValueRange&&(this._showFullPixelValueRange=t,this.render())}get visible(){return this._canvas.style.display==="block"}set visible(t){t!==this.visible&&(this._canvas.style.display=t?"block":"none",t&&this.render())}appendTo(t){t.appendChild(this._canvas),this.render()}static validateProps(t){const{size:n,imageRange:e,voiRange:o}=t;if(n&&!sr(n))throw new Error('Invalid "size"');if(e&&!qn(e))throw new Error('Invalid "imageRange"');if(o&&!qn(o))throw new Error('Invalid "voiRange"')}_setCanvasSize(t,n){const{width:e,height:o}=n;t.width=e,t.height=o,Object.assign(t.style,{width:`${e}px`,height:`${o}px`})}_createCanvasElement(t,n,e){const o=document.createElement("canvas");return Object.assign(o.style,{display:"none",position:"absolute",boxSizing:"border-box",top:`${n}px`,left:`${e}px`}),this._setCanvasSize(o,t),o}_getTicks(t){const{lower:n,upper:e}=t,a=(e-n)/(this._maxNumTicks-1),s=Math.pow(10,-Math.floor(Math.log10(Math.abs(a)))),r=a*s,l=Oo.TICKS_STEPS.find(f=>f>=r)/s,d=Math.ceil(e/l)*l,u=Math.floor(n/l)*l,h=Math.round((d-u)/l)+1,g=[];for(let f=0;f<h;f++)g.push(u+f*l);return{scaleMin:u,scaleMax:d,step:l,ticks:g}}_getLeftTickInfo({position:t,labelMeasure:n}){const{width:e}=this._canvas,a=[e-this.tickSize-n.width-this._labelMargin,t],s={start:[e-this._tickSize,t],end:[e,t]};return{labelPoint:a,tickPoints:s}}_getRightTickInfo({position:t}){const n=[this._tickSize+this._labelMargin,t],e={start:[0,t],end:[this._tickSize,t]};return{labelPoint:n,tickPoints:e}}_getTopTickInfo({position:t,labelMeasure:n}){const{height:e}=this._canvas,o=e-this.tickSize-this._labelMargin,a=[t,o],s={start:[t,e-this._tickSize],end:[t,e]};return{labelPoint:a,tickPoints:s}}_getBottomTickInfo({position:t,labelMeasure:n}){const e=[t,this._tickSize+this._labelMargin],o={start:[t,0],end:[t,this._tickSize]};return{labelPoint:e,tickPoints:o}}render(){const{_canvas:t}=this;if(!t.isConnected||!this.visible)return;const{width:n,height:e}=t,o=n>=e,a=o?n:e,s=t.getContext("2d"),{_voiRange:r}=this,c=this._showFullPixelValueRange?this._imageRange:{...r},l=c.upper-c.lower,{ticks:d}=this._getTicks(c);s.clearRect(0,0,n,e),s.font=this._font,s.textBaseline=o?"top":"middle",s.textAlign=o?"center":"left",s.fillStyle=this._color,s.strokeStyle=this._color,s.lineWidth=this.tickWidth,d.forEach(u=>{let h=Math.round(a*((u-c.lower)/l));if(o||(h=e-h),h<0||h>a)return;const g=u.toString(),f=s.measureText(g);let m;o?this._rangeTextPosition===Ze.Top?m=this._getTopTickInfo({position:h,labelMeasure:f}):m=this._getBottomTickInfo({position:h,labelMeasure:f}):this._rangeTextPosition===Ze.Left?m=this._getLeftTickInfo({position:h,labelMeasure:f}):m=this._getRightTickInfo({position:h});const{labelPoint:v,tickPoints:p}=m,{start:I,end:C}=p;return s.beginPath(),s.moveTo(I[0],I[1]),s.lineTo(C[0],C[1]),s.fillText(g,v[0],v[1]),s.stroke(),h})}}function Fx(i,t,n){return(i>=t?[Ze.Top,Ze.Bottom]:[Ze.Left,Ze.Right]).includes(n)}class Bx{constructor({id:t,container:n}){this._containerResizeCallback=e=>{let o,a;const{contentRect:s,contentBoxSize:r}=e[0];s?(o=s.width,a=s.height):r?.length&&(o=r[0].inlineSize,a=r[0].blockSize),this._containerSize={width:o,height:a},this.onContainerResize()},this._id=t,this._containerSize={width:0,height:0},this._rootElement=this.createRootElement(t),this._containerResizeObserver=new ResizeObserver(this._containerResizeCallback),n&&this.appendTo(n)}get id(){return this._id}get rootElement(){return this._rootElement}appendTo(t){const{_rootElement:n,_containerResizeObserver:e}=this,{parentElement:o}=n;!t||t===o||(o&&e.unobserve(o),t.appendChild(n),e.observe(t))}destroy(){const{_rootElement:t,_containerResizeObserver:n}=this,{parentElement:e}=t;e?.removeChild(t),n.disconnect()}get containerSize(){return{...this._containerSize}}createRootElement(t){const n=document.createElement("div");return n.id=t,n.classList.add("widget"),Object.assign(n.style,{width:"100%",height:"100%"}),n}onContainerResize(){}}const da={MULTIPLIER:1,RANGE_TEXT_POSITION:Ze.Right,TICKS_BAR_SIZE:50};class Xa extends Bx{constructor(t){super(t),this._isMouseOver=!1,this._isInteracting=!1,this._mouseOverCallback=n=>{this._isMouseOver=!0,this.showTicks(),n.stopPropagation()},this._mouseOutCallback=n=>{this._isMouseOver=!1,this.hideTicks(),n.stopPropagation()},this._mouseDownCallback=n=>{this._isInteracting=!0,this.showTicks(),this._addVOIEventListeners(n),n.stopPropagation()},this._mouseDragCallback=(n,e)=>{const o=this.getVOIMultipliers(),a=this._getPointsFromMouseEvent(n),{points:s,voiRange:r}=e,c=Kn(et(),a.local,s.local),l=c[0]*o[0],d=c[1]*o[1];if(!l&&!d)return;const{lower:u,upper:h}=r;let{windowWidth:g,windowCenter:f}=Ug(u,h);g=Math.max(g+l,1),f+=d;const m=Ll(g,f);this.voiRange=m,n.stopPropagation(),n.preventDefault()},this._mouseUpCallback=n=>{this._isInteracting=!1,this.hideTicks(),this._removeVOIEventListeners(),n.stopPropagation()},this._eventListenersManager=new g0,this._colormaps=Xa.getColormapsMap(t),this._activeColormapName=Xa.getInitialColormapName(t),this._canvas=this._createCanvas(t),this._ticksBar=this._createTicksBar(t),this._rangeTextPosition=t.ticks?.position??da.RANGE_TEXT_POSITION,this._canvas.appendTo(this.rootElement),this._ticksBar.appendTo(this.rootElement),this._addRootElementEventListeners()}get activeColormapName(){return this._activeColormapName}set activeColormapName(t){if(t===this._activeColormapName)return;const n=this._colormaps.get(t);if(!n){console.warn(`Invalid colormap name (${t})`);return}this._activeColormapName=t,this._canvas.colormap=n}get imageRange(){return this._canvas.imageRange}set imageRange(t){this._canvas.imageRange=t,this._ticksBar.imageRange=t}get voiRange(){return this._canvas.voiRange}set voiRange(t){const{voiRange:n}=this._canvas;!qn(t)||ja(t,n)||(this._canvas.voiRange=t,this._ticksBar.voiRange=t,this.onVoiChange(t))}get showFullImageRange(){return this._canvas.showFullImageRange}set showFullImageRange(t){this._canvas.showFullImageRange=t,this._ticksBar.showFullPixelValueRange=t}destroy(){super.destroy(),this._eventListenersManager.reset()}createRootElement(){const t=document.createElement("div");return Object.assign(t.style,{position:"relative",fontSize:"0",width:"100%",height:"100%"}),t}onContainerResize(){super.onContainerResize(),this.updateTicksBar(),this._canvas.size=this.containerSize}getVOIMultipliers(){return[da.MULTIPLIER,da.MULTIPLIER]}onVoiChange(t){}showTicks(){this.updateTicksBar(),this._ticksBar.visible=!0}hideTicks(){this._isInteracting||this._isMouseOver||(this._ticksBar.visible=!1)}static getColormapsMap(t){const{colormaps:n}=t;return n.reduce((e,o)=>e.set(o.Name,o),new Map)}static getInitialColormapName(t){const{activeColormapName:n,colormaps:e}=t;return!!n&&e.some(a=>a.Name===n)?n:e[0].Name}_createCanvas(t){const{imageRange:n,voiRange:e,showFullPixelValueRange:o}=t,a=this._colormaps.get(this._activeColormapName);return new jd({colormap:a,imageRange:n,voiRange:e,showFullPixelValueRange:o})}_createTicksBar(t){const n=t.ticks;return new Xd({imageRange:t.imageRange,voiRange:t.voiRange,ticks:n,showFullPixelValueRange:t.showFullPixelValueRange})}_getPointsFromMouseEvent(t){const{rootElement:n}=this,e=[t.clientX,t.clientY],o=[t.pageX,t.pageY],a=n.getBoundingClientRect(),s=[o[0]-a.left-window.pageXOffset,o[1]-a.top-window.pageYOffset];return{client:e,page:o,local:s}}updateTicksBar(){const{width:t,height:n}=this.containerSize;if(t===0&&n===0)return;const{_ticksBar:e,_rangeTextPosition:o}=this,a=t>=n,s=a?t:da.TICKS_BAR_SIZE,r=a?da.TICKS_BAR_SIZE:n;if(!Fx(t,n,o))throw new Error("Invalid rangeTextPosition value for the current colobar orientation");let c,l;e.size={width:s,height:r},a?(l=0,c=o===Ze.Top?-r:n):(c=0,l=o===Ze.Left?-s:t),e.top=c,e.left=l}_addRootElementEventListeners(){const{_eventListenersManager:t}=this,{rootElement:n}=this;t.addEventListener(n,"mouseover",this._mouseOverCallback),t.addEventListener(n,"mouseout",this._mouseOutCallback),t.addEventListener(n,"mousedown",this._mouseDownCallback)}_addVOIEventListeners(t){const{_eventListenersManager:n}=this,e=this._getPointsFromMouseEvent(t),o={...this._canvas.voiRange},a={points:e,voiRange:o};this._removeVOIEventListeners(),n.addEventListener(document,"voi.mouseup",this._mouseUpCallback),n.addEventListener(document,"voi.mousemove",s=>this._mouseDragCallback(s,a))}_removeVOIEventListeners(){const{_eventListenersManager:t}=this;t.removeEventListener(document,"voi.mouseup"),t.removeEventListener(document,"voi.mousemove")}}const Dc=4;function Gx(i,t,n){if(f0(i,t)==="PT"){const{clientWidth:o,clientHeight:a}=i.element,s=5/Math.max(o,a),r=io(i,t),{fixedPTWindowWidth:c=!0}=n??{},l=c?0:s;return r?[l,s]:[l,Dc]}return[Dc,Dc]}const{Events:co}=fr,Ps={lower:-1e3,upper:1e3};class vi extends Xa{constructor(t){const{element:n,volumeId:e}=t,o=vi._getImageRange(n,e),a=vi._getVOIRange(n,e);super({...t,imageRange:o,voiRange:a}),this.autoHideTicks=()=>{if(this._hideTicksTimeoutId)return;const s=this._hideTicksTime-Date.now();s<=0?this.hideTicks():this._hideTicksTimeoutId=window.setTimeout(()=>{this._hideTicksTimeoutId=0,this.autoHideTicks()},s)},this._stackNewImageCallback=()=>{this.imageRange=vi._getImageRange(this._element)},this._imageVolumeModifiedCallback=s=>{const{volumeId:r}=s.detail;if(r!==this._volumeId)return;const{_element:c}=this;this.imageRange=vi._getImageRange(c,r)},this._viewportVOIModifiedCallback=s=>{const{viewportId:r,volumeId:c,range:l,colormap:d}=s.detail,{viewport:u}=this.enabledElement;r!==u.id||c!==this._volumeId||(this.voiRange=l,d&&(this.activeColormapName=d.name),this.showAndAutoHideTicks())},this._viewportColormapModifiedCallback=s=>{const{viewportId:r,colormap:c,volumeId:l}=s.detail,{viewport:d}=this.enabledElement;r!==d.id||l!==this._volumeId||(this.activeColormapName=c.name)},this._element=n,this._volumeId=e,this._addCornerstoneEventListener()}get element(){return this._element}get enabledElement(){return y(this._element)}getVOIMultipliers(){const{viewport:t}=this.enabledElement;return Gx(t,this._volumeId)}onVoiChange(t){super.onVoiChange(t);const{viewport:n}=this.enabledElement;if(n instanceof Ie)n.setProperties({voiRange:t}),n.render();else if(n instanceof ae){const{_volumeId:e}=this,o=Ml(e);n.setProperties({voiRange:t},e),o.forEach(a=>a.render())}}static _getImageRange(t,n){const e=y(t),{viewport:o}=e,a=o.getImageActor(n);if(!a)return Ps;const r=a.getMapper().getInputData().getPointData().getScalars();let c;if(r)c=r.getRange();else{if(!n)throw new Error("volumeId is required when scalarData is not available");const l=X.getVolume(n),[d,u]=l.voxelManager.getRange();c=[d,u]}return c[0]===0&&c[1]===0?Ps:{lower:c[0],upper:c[1]}}static _getVOIRange(t,n){const e=y(t),{viewport:o}=e,a=o.getImageActor(n);if(!a)return Ps;const s=a.getProperty().getRGBTransferFunction(0).getRange();return s[0]===0&&s[1]===0?Ps:{lower:s[0],upper:s[1]}}showAndAutoHideTicks(t=1e3){this._hideTicksTime=Date.now()+t,this.showTicks(),this.autoHideTicks()}_addCornerstoneEventListener(){const{_element:t}=this;z.addEventListener(co.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedCallback),t.addEventListener(co.STACK_NEW_IMAGE,this._stackNewImageCallback),t.addEventListener(co.VOI_MODIFIED,this._viewportVOIModifiedCallback),t.addEventListener(co.COLORMAP_MODIFIED,this._viewportColormapModifiedCallback)}destroy(){super.destroy();const{_element:t}=this;z.removeEventListener(co.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedCallback),t.removeEventListener(co.STACK_NEW_IMAGE,this._stackNewImageCallback),t.removeEventListener(co.VOI_MODIFIED,this._viewportVOIModifiedCallback),t.removeEventListener(co.COLORMAP_MODIFIED,this._viewportColormapModifiedCallback)}}const Wx=Object.freeze(Object.defineProperty({__proto__:null,Colorbar:Xa,Enums:Ux,ViewportColorbar:vi},Symbol.toStringTag,{value:"Module"}));function lI(i,t,n,e,o){const a=[];let s=0;const r=i.scalarData;let c,l,d;if(i.color)for(l=0;l<o;l++)for(d=0;d<e;d++){c=((l+n)*i.columns+(d+t))*4;const u=r[c],h=r[c+1],g=r[c+2];a[s++]=.2126*u+.7152*h+.0722*g}else for(l=0;l<o;l++)for(d=0;d<e;d++)c=(l+n)*i.columns+(d+t),a[s++]=r[c];return a}function dI(i,t,n){const e=i.length;let o=n,a=t,s=0;if(e<2)return{min:o,max:a,mean:(t+n)/2};for(let r=0;r<e;r++){const c=i[r];o=Math.min(o,c),a=Math.max(a,c),s+=c}return{min:o,max:a,mean:s/e}}function uI(i){if(i instanceof ae)return $x(i);if(i instanceof Ie)return Hx(i);throw new Error("Viewport not supported")}function $x(i){const{scalarData:t,width:n,height:e}=kg(i),{min:o,max:a}=Vg(t);return{scalarData:t,minPixelValue:o,maxPixelValue:a,width:n,height:e,rows:n,columns:e}}function Hx(i){const t=i.getImageData(),{scalarData:n}=t,{min:e,max:o}=Vg(n),a=t.dimensions[0],s=t.dimensions[1],{rows:r,columns:c,color:l}=i.getCornerstoneImage();return{scalarData:n,width:a,height:s,minPixelValue:e,maxPixelValue:o,rows:r,columns:c,color:l}}const zx=Object.freeze(Object.defineProperty({__proto__:null,calculateMinMaxMean:dI,extractWindowLevelRegionToolData:uI,getLuminanceFromRegion:lI},Symbol.toStringTag,{value:"Module"})),jx=Object.freeze(Object.defineProperty({__proto__:null,colorbar:Wx,windowLevel:zx},Symbol.toStringTag,{value:"Module"})),{transformWorldToIndex:pl}=Rt;function Xx(i,t,n,e){const{boundsIJK:o,centerWorld:a,radiusWorld:s}=Yx(t,i,e),r={center:a,radius:s},c=i.getDimensions();Al.createScalarVolumeVoxelManager({dimensions:c,scalarData:i.getPointData().getScalars().getData()}).forEach(n,{boundsIJK:o,isInObject:d=>Cv(r,d),imageData:i})}function Yx(i,t,n){const[e,o]=i,a=wt((e[0]+o[0])/2,(e[1]+o[1])/2,(e[2]+o[2])/2),s=Te(e,o)/2;let r;if(!n){const c=pl(t,a),l=t.getSpacing(),d=Math.min(...l),u=Math.ceil(s/d);return r=[[c[0]-u,c[0]+u],[c[1]-u,c[1]+u],[c[2]-u,c[2]+u]],{boundsIJK:r,centerWorld:a,radiusWorld:s}}return r=qx(t,n,i,a,s),{boundsIJK:r,centerWorld:a,radiusWorld:s}}function qx(i,t,n,e,o){const[a,s]=n,r=i.getDimensions(),c=t.getCamera(),l=wt(c.viewUp[0],c.viewUp[1],c.viewUp[2]),d=wt(c.viewPlaneNormal[0],c.viewPlaneNormal[1],c.viewPlaneNormal[2]),u=W();be(u,l,d);const h=W(),g=W();Wt(h,s,d,o),Wt(g,a,d,-o),Wt(h,h,u,-o),Wt(g,g,u,o);const f=[pl(i,h),pl(i,g)];return Do(f,r)}function hI(i){if(!Array.isArray(i)||i.length!==9)throw new Error("Matrix must be an array of 9 numbers");if(!i.every(t=>typeof t=="number"&&!isNaN(t)))throw new Error("Matrix must contain only valid numbers")}function gI(i){hI(i);const t=[[i[0],i[1],i[2]],[i[3],i[4],i[5]],[i[6],i[7],i[8]]],n=t[0][0]*(t[1][1]*t[2][2]-t[1][2]*t[2][1])-t[0][1]*(t[1][0]*t[2][2]-t[1][2]*t[2][0])+t[0][2]*(t[1][0]*t[2][1]-t[1][1]*t[2][0]);if(Math.abs(n)<1e-10)throw new Error("Matrix is not invertible (determinant is zero)");const e=[[t[1][1]*t[2][2]-t[1][2]*t[2][1],-(t[0][1]*t[2][2]-t[0][2]*t[2][1]),t[0][1]*t[1][2]-t[0][2]*t[1][1]],[-(t[1][0]*t[2][2]-t[1][2]*t[2][0]),t[0][0]*t[2][2]-t[0][2]*t[2][0],-(t[0][0]*t[1][2]-t[0][2]*t[1][0])],[t[1][0]*t[2][1]-t[1][1]*t[2][0],-(t[0][0]*t[2][1]-t[0][1]*t[2][0]),t[0][0]*t[1][1]-t[0][1]*t[1][0]]],o=[];for(let a=0;a<3;a++)for(let s=0;s<3;s++)o.push(e[a][s]/n);return o}function bc(i){const t=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);return i.map(n=>n/t)}function Kx(i){hI(i);const t=i.slice(0,3),n=i.slice(3,6),e=i.slice(6,9),o=bc(t),a=bc(n),s=bc(e),r={x:[1,0,0],y:[0,1,0],z:[0,0,1]},c=1e-10,l=o.every((u,h)=>Math.abs(u-r.x[h])<c)&&a.every((u,h)=>Math.abs(u-r.y[h])<c)&&s.every((u,h)=>Math.abs(u-r.z[h])<c),d=l?[...r.x,...r.y,...r.z]:gI([...o,...a,...s]);return{isStandard:l,rotationMatrix:d}}function Zx(i,t,n){const e=i[0]-t[0],o=i[1]-t[1],a=i[2]-t[2];return[n[0]*e+n[1]*o+n[2]*a+t[0],n[3]*e+n[4]*o+n[5]*a+t[1],n[6]*e+n[7]*o+n[8]*a+t[2]]}function Jx(i,t,n){const e=[];for(let o=0;o<n.length;o+=3){const a=n.slice(o,o+3),s=Zx(a,t,i);e.push(...s)}return e}const Qx=Object.freeze(Object.defineProperty({__proto__:null,checkStandardBasis:Kx,inverse3x3Matrix:gI,rotatePoints:Jx},Symbol.toStringTag,{value:"Module"}));function fI(i,t,n){i.data.label=n,It(i,t,lt.LabelChange)}function ty(i,t){const{data:n}=i,{points:e}=n.handles,{focalPoint:o,viewPlaneNormal:a}=t.getCamera(),s=dt(me(W(),e[0],o),a);return e.forEach(r=>{je(r,r,hn(W(),[-a[0],-a[1],-a[2]],s))}),t instanceof Ie&&(i.metadata.referencedImageId=t.getCurrentImageId()),i}function ey(i,t,n){const e=t*n,o=i.length/e;if(![1,3,4].includes(o))throw new Error("Buffer must be 1, 3, or 4 channels per pixel");const a=Array.from({length:n},()=>new Array(t).fill(!1));for(let v=0;v<n;v++)for(let p=0;p<t;p++){const C=(v*t+p)*o;let E=!1;for(let S=0;S<Math.min(3,o);S++)if(i[C+S]>0){E=!0;break}a[v][p]=E}const s=Array.from({length:n},()=>new Array(t).fill(0));let r=0;const c={};for(let v=0;v<n;v++)for(let p=0;p<t;p++)if(a[v][p]&&s[v][p]===0){r++;const I=(S,_)=>S<0||S>=t||_<0||_>=n?!1:a[_][S]&&s[_][S]===0;let C=0;kd(I,[p,v],{onFlood:(S,_)=>{s[_][S]=r,C++},diagonals:!1}),c[r]=C}if(r===0)return[];const l=Object.keys(c).reduce((v,p)=>c[v]>c[p]?v:p);function d(v,p){if(s[p][v]!==+l)return!1;for(const[I,C]of[[1,0],[-1,0],[0,1],[0,-1]]){const E=v+I,S=p+C;if(E<0||E>=t||S<0||S>=n||s[S][E]!==+l)return!0}return!1}let u=null;t:for(let v=0;v<n;v++)for(let p=0;p<t;p++)if(d(p,v)){u=[p,v];break t}if(!u)return[];const h=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]],g=[];let f=u,m=[u[0]-1,u[1]];do{g.push([f[0],f[1]]);const v=m[0]-f[0],p=m[1]-f[1];let I=h.findIndex(E=>E[0]===v&&E[1]===p);I<0&&(I=0);let C=null;for(let E=1;E<=8;E++){const[S,_]=h[(I+E)%8],D=f[0]+S,b=f[1]+_;if(D>=0&&D<t&&b>=0&&b<n&&d(D,b)){C=[D,b];const[M,P]=h[(I+E-1+8)%8];m=[f[0]+M,f[1]+P];break}}if(!C)break;f=C}while(f[0]!==u[0]||f[1]!==u[1]);return g}function ny(i){const t=Or(i,2),n=gm(t);return{simplified:t,hull:n}}function oy(i,t=7){if(!i.length)throw new Error("Convex hull is empty");const n=i.length,e=p=>(p+1)%n,o=(p,I)=>{const C=[];for(let E=p;C.push(E),E!==I;E=e(E));return C};let a=0,s=0;for(let p=1;p<n;p++)i[p][0]<i[a][0]&&(a=p),i[p][0]>i[s][0]&&(s=p);const r=i[a],c=i[s],l=o(a,s),d=o(s,a),u=Math.min(...i.map(p=>p[1])),h=l.some(p=>i[p][1]===u)?l:d,g=Math.min(...h.map(p=>i[p][1]));let f=h.map(p=>i[p]).filter(p=>Math.abs(p[1]-g)<=t);f.length<2&&(f=h.map(p=>i[p]).sort((p,I)=>p[1]-I[1]).slice(0,2));const m=f.reduce((p,I)=>I[0]<p[0]?I:p,f[0]),v=f.reduce((p,I)=>I[0]>p[0]?I:p,f[0]);return{P1:m,P2:r,P3:c,P4:v}}function iy(i,t,n,e,o,a={}){const{maxDist:s=15,slack:r=2}=a,c={P1:{dx:-1,dy:-1},P2:{dx:-1,dy:1},P3:{dx:1,dy:1},P4:{dx:1,dy:-1}};function l(d,{dx:u,dy:h},g=5){const f=u<0?d[0]-s:d[0]-r,m=u<0?d[0]+r:d[0]+s,v=h<0?d[1]-s:d[1]-r,p=h<0?d[1]+r:d[1]+s;let I=d;for(const[C,E]of o){if(C<f||C>m||E<v||E>p)continue;const S=Math.round(C),_=Math.round(E);if(S<0||S>=t||_<0||_>=n)continue;const D=(S-I[0])*u,b=(_-I[0])*h;i[_*t+S]>g&&(D>0||b>0)&&(I=[C,E])}return I}return{P1:l(e.P1,c.P1),P2:l(e.P2,c.P2),P3:l(e.P3,c.P3),P4:l(e.P4,c.P4)}}function ay(i,t,n,e,o){const a=oy(e);return iy(i,t,n,a,o,{maxDist:20})}function Gh(i,t){return Math.atan2(t[1]-i[1],t[0]-i[0])}function sy(i){const{P1:t,P2:n,P3:e,P4:o}=i,a=js(t,n,o,e,!0);if(!a)throw new Error("Fan edges appear parallel  no apex found");const s=a;let r=Gh(s,t)*(180/Math.PI),c=Gh(s,o)*(180/Math.PI);if(c<=r){const m=r;r=c,c=m}const l=Math.hypot(t[0]-s[0],t[1]-s[1]),d=Math.hypot(o[0]-s[0],o[1]-s[1]),u=Math.hypot(n[0]-s[0],n[1]-s[1]),h=Math.hypot(e[0]-s[0],e[1]-s[1]),g=Math.min(l,d),f=Math.max(u,h);return{center:s,startAngle:r,endAngle:c,innerRadius:g,outerRadius:f}}function ga(i,t,n,e,o={}){const{strokeStyle:a="#f00",lineWidth:s=2,quality:r=.92}=o,c=document.createElement("canvas");c.width=t,c.height=n;const l=c.getContext("2d"),d=t*n,u=i.length/d,h=l.createImageData(t,n),g=h.data;for(let f=0;f<d;f++){const m=f*u,v=f*4;if(u===1){const p=i[m];g[v]=p,g[v+1]=p,g[v+2]=p,g[v+3]=255}else g[v]=i[m],g[v+1]=i[m+1],g[v+2]=i[m+2],g[v+3]=u===4?i[m+3]:255}if(l.putImageData(h,0,0),e.length>0){l.strokeStyle=a,l.lineWidth=s,l.beginPath(),l.moveTo(e[0][0]+.5,e[0][1]+.5);for(let f=1;f<e.length;f++)l.lineTo(e[f][0]+.5,e[f][1]+.5);l.closePath(),l.stroke()}return c.toDataURL("image/jpeg",r)}function Yd(i){const t=X.getImage(i);if(!t)return;const n=t.width,e=t.height;return{pixelData:t.getPixelData(),width:n,height:e}}function mI(i,t){const n=document.createElement("a");n.href=i,n.download=t,document.body.appendChild(n),n.style.display="none",n.click(),n.remove()}function ry(i,t,n,e,o={}){const{center:a,startAngle:s,endAngle:r,innerRadius:c,outerRadius:l}=e,{strokeStyle:d="#0ff",lineWidth:u=2,quality:h=.92}=o,g=s*Math.PI/180,f=r*Math.PI/180,m=document.createElement("canvas");m.width=t,m.height=n;const v=m.getContext("2d"),p=t*n,I=i.length/p,C=v.createImageData(t,n),E=C.data;for(let S=0;S<p;S++){const _=S*4;if(I===1){const D=i[S];E[_]=D,E[_+1]=D,E[_+2]=D,E[_+3]=255}else{const D=S*I;E[_]=i[D],E[_+1]=i[D+1],E[_+2]=i[D+2],E[_+3]=I===4?i[D+3]:255}}v.putImageData(C,0,0),v.beginPath();for(let S=g;S<=f;S+=.01){const _=a[0]+c*Math.cos(S),D=a[1]+c*Math.sin(S);S===g?v.moveTo(_,D):v.lineTo(_,D)}for(let S=f;S>=g;S-=.01){const _=a[0]+l*Math.cos(S),D=a[1]+l*Math.sin(S);v.lineTo(_,D)}return v.closePath(),v.strokeStyle=d,v.lineWidth=u,v.stroke(),m.toDataURL("image/jpeg",h)}function cy(i,t=5){const{contour:n,simplified:e,hull:o,refined:a,fanGeometry:s}=qd(i),{pixelData:r,width:c,height:l}=Yd(i)||{};if(!r)return;let d;t===1?d=ga(r,c,l,n):t===2?d=ga(r,c,l,e):t===3?d=ga(r,c,l,o):t===4?d=ga(r,c,l,[a.P1,a.P2,a.P3,a.P4]):d=ry(r,c,l,s,{strokeStyle:"#f00",lineWidth:3,quality:.95}),mI(d,"contour.jpg")}function qd(i){const{pixelData:t,width:n,height:e}=Yd(i)||{};if(!t)return;const o=ey(t,n,e),{simplified:a,hull:s}=ny(o),r=ay(t,n,e,s,a),c=sy({P1:r.P1,P2:r.P2,P3:r.P3,P4:r.P4});return{contour:o,simplified:a,hull:s,refined:r,fanGeometry:c}}const ly=Object.freeze(Object.defineProperty({__proto__:null,calculateFanGeometry:qd,default:mI,downloadFanJpeg:cy,exportContourJpeg:ga,getPixelData:Yd},Symbol.toStringTag,{value:"Module"})),dy=_t,tO=Object.freeze(Object.defineProperty({__proto__:null,AnnotationMultiSlice:VT,IslandRemoval:Jo,annotationHydration:LC,boundingBox:NT,calibrateImageSpacing:RT,cine:JM,contourSegmentation:_E,contours:LD,debounce:zi,drawing:E_,dynamicVolume:Rx,geometricSurfaceUtils:Qx,getAnnotationNearPoint:AT,getAnnotationNearPointOnEnabledElement:sv,getCalibratedAspect:wd,getCalibratedLengthUnitsAndScale:nn,getCalibratedProbeUnitsAndValue:Zs,getClosestImageIdForStackViewport:Kl,getOrCreateImageVolume:Hr,getPixelValueUnits:so,getPixelValueUnitsImageId:pp,getSphereBoundsInfo:lv,getViewportForAnnotation:Us,isObject:_d,math:O1,moveAnnotationToViewPlane:ty,normalizeViewportPlane:pv,orientation:$M,planar:aS,planarFreehandROITool:nx,pointInSurroundingSphereCallback:Xx,pointToString:dv,polyDataUtils:Nx,rectangleROITool:rx,roundNumber:dy,segmentation:BM,setAnnotationLabel:fI,stackContextPrefetch:Tx,stackPrefetch:Ix,throttle:Fe,touch:Zw,triggerAnnotationRender:$i,triggerAnnotationRenderForToolGroupIds:Gm,triggerAnnotationRenderForViewportIds:L,triggerEvent:gt,usFanExtraction:ly,viewport:Px,viewportFilters:tE,voi:jx},Symbol.toStringTag,{value:"Module"})),eO=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));function pI(i,t){const n=Vt;i.forEach(e=>{n.updateSegmentation(e.segmentationId,e.payload),t||gn(e.segmentationId)})}function uy(i,t,n){Vt.setSegmentationRepresentationVisibility(i,t,n)}function hy(i,t,n){const e=Ye(i,t);e&&e.forEach(o=>{uy(i,{segmentationId:o.segmentationId,type:o.type},n)})}function gy(i,t){return fp(i,t)}function fy(i,t,n,e){const o=Ye(i,t);o&&(o.forEach(a=>{!a.segments||!a.segments[n]||(a.segments[n].visible=e)}),zr(t.segmentationId),An(i,t.segmentationId))}function my(i,t,n){return!vI(i,t).has(n)}function vI(i,t){const n=zl(i,t);return n?Object.entries(n.segments).reduce((o,[a,s])=>(s.visible||o.add(Number(a)),o),new Set):new Set}const py=Object.freeze(Object.defineProperty({__proto__:null,getHiddenSegmentIndices:vI,getSegmentIndexVisibility:my,getSegmentationRepresentationVisibility:gy,setSegmentIndexVisibility:fy,setSegmentationRepresentationVisibility:hy},Symbol.toStringTag,{value:"Module"}));function vy(i){return Xe.getStyle(i)}function Iy(i,t,n){Xe.setStyle(i,t,n),!i.viewportId&&!i.segmentationId&&$r().forEach(o=>{qi(o.segmentationId)}),An(i.viewportId,i.segmentationId,i.type)}function wy(i,t){Xe.setRenderInactiveSegmentations(i,t),qi(i),tp(i).forEach(e=>{An(i,e.segmentationId)})}function Cy(i){return Xe.getRenderInactiveSegmentations(i)}function Ey(){Xe.resetToGlobalStyle(),qi()}function Sy(i){return Xe.hasCustomStyle(i)}const _y=Object.freeze(Object.defineProperty({__proto__:null,getRenderInactiveSegmentations:Cy,getStyle:vy,hasCustomStyle:Sy,resetToGlobalStyle:Ey,setRenderInactiveSegmentations:wy,setStyle:Iy},Symbol.toStringTag,{value:"Module"})),Dy=Object.freeze(Object.defineProperty({__proto__:null,color:zD,style:_y,visibility:py},Symbol.toStringTag,{value:"Module"}));async function by(i){const t=SC(i);return gn(i.segmentationId),t}function II(i,t){const n=pt(i);if(n.representationData.Labelmap){const{representationData:e}=n,o=e.Labelmap;("imageIds"in o||"volumeId"in o)&&("imageIds"in o?o.imageIds.map(s=>X.getImage(s)):[X.getVolume(o.volumeId)]).forEach(s=>{if(!s)return;const{voxelManager:r}=s;r.forEach(({value:c,index:l})=>{c===t&&r.setAtIndex(l,0)})}),Pe(i)}else throw new Error("Invalid segmentation type, only labelmap is supported right now")}function Ty(i,t){const n=Ua(i);if(!n)return;const e=n.get(t);e&&e.forEach(o=>{const a=xt(o);Hi(a)&&Gr(a)})}function Py(i,t,n={setNextSegmentAsActive:!0}){const e=pt(i);if(e?.representationData.Contour)Ty(i,t);else if(e?.representationData.Labelmap)II(i,t);else throw new Error("Invalid segmentation type");const o=$e(i)===t,{segments:a}=e;delete a[t];const s={...a};if(pI([{segmentationId:i,payload:{segments:s}}]),o&&n.setNextSegmentAsActive){const c=Object.keys(a).map(Number).sort((h,g)=>h-g),l=c.indexOf(t),d=c[l+1],u=c[l-1];d!==void 0?Ha(i,d):u!==void 0&&Ha(i,u)}oi(i).forEach(c=>{Ye(c,{segmentationId:i}).forEach(d=>{delete d.segments[t]})})}function My(i){const t=Vt,n=pt(i);return t.getLabelmapImageIds(n.representationData)}const xy={clearSegmentValue:II,convertStackToVolumeLabelmap:by,computeVolumeLabelmapFromStack:zv,convertVolumeToStackLabelmap:LM},nO=Object.freeze(Object.defineProperty({__proto__:null,activeSegmentation:jE,addContourRepresentationToViewport:Bd,addContourRepresentationToViewportMap:MM,addDefaultSegmentationListener:xd,addLabelmapRepresentationToViewport:$v,addLabelmapRepresentationToViewportMap:xM,addRepresentationData:jl,addSegmentationListener:zm,addSegmentationRepresentations:Ji,addSegmentations:Hm,addSurfaceRepresentationToViewport:Hv,addSurfaceRepresentationToViewportMap:yM,config:Dy,defaultSegmentationStateManager:Vt,getActiveSegmentation:Ko,getCurrentLabelmapImageIdsForViewport:no,getLabelmapImageIds:My,getLabelmapImageIdsForImageId:kE,helpers:xy,removeAllSegmentationListeners:fD,removeAllSegmentationRepresentations:Ym,removeAllSegmentations:Jm,removeContourRepresentation:Km,removeLabelmapRepresentation:qm,removeSegment:Py,removeSegmentation:Ad,removeSegmentationListener:yd,removeSegmentationRepresentation:Xi,removeSegmentationRepresentations:jm,removeSurfaceRepresentation:Zm,segmentIndex:bM,segmentLocking:WD,segmentationStyle:Xe,state:CD,strategies:OP,triggerSegmentationEvents:fC,updateSegmentations:pI,utilities:VD},Symbol.toStringTag,{value:"Module"}));class Kd{constructor(t){this._controlPoints=[],this._invalidated=!1,this._length=0,this._controlPoints=[],this._resolution=t?.resolution??20,this._fixedResolution=t?.fixedResolution??!1,this._closed=t?.closed??!1,this._invalidated=!0}get controlPoints(){return this._controlPoints}get numControlPoints(){return this._controlPoints.length}get resolution(){return this._resolution}set resolution(t){this._fixedResolution||this._resolution===t||(this._resolution=t,this.invalidated=!0)}get fixedResolution(){return this._fixedResolution}get closed(){return this._closed}set closed(t){this._closed!==t&&(this._closed=t,this.invalidated=!0)}get aabb(){return this._update(),this._aabb}get length(){return this._update(),this._length}get invalidated(){return this._invalidated}set invalidated(t){this._invalidated=t}hasTangentPoints(){return!1}addControlPoint(t){this._controlPoints.push([t[0],t[1]]),this.invalidated=!0}addControlPoints(t){t.forEach(n=>this.addControlPoint(n))}addControlPointAtU(t){const n=this._getLineSegmentAt(t),{start:e,end:o}=n.points,a=Math.floor(t),s=this._curveSegments[a],r=t-Math.floor(a),c=[e[0]+r*(o[0]-e[0]),e[1]+r*(o[1]-e[1])],l=this._controlPoints.indexOf(s.controlPoints.p1)+1;return this._controlPoints.splice(l,0,c),this.invalidated=!0,{index:l,point:c}}deleteControlPointByIndex(t){const n=this._closed?3:1;return t>=0&&t<this._controlPoints.length&&this._controlPoints.length>n?(this._controlPoints.splice(t,1),this.invalidated=!0,!0):!1}clearControlPoints(){this._controlPoints=[],this.invalidated=!0}setControlPoints(t){this.clearControlPoints(),this.addControlPoints(t)}updateControlPoint(t,n){if(t<0||t>=this._controlPoints.length)throw new Error("Index out of bounds");this._controlPoints[t]=[...n],this.invalidated=!0}getControlPoints(){return this._controlPoints.map(t=>[t[0],t[1]])}getClosestControlPoint(t){const n=this._controlPoints;let e=1/0,o=-1;for(let a=0,s=n.length;a<s;a++){const r=n[a],c=t[0]-r[0],l=t[1]-r[1],d=c*c+l*l;d<e&&(e=d,o=a)}return{index:o,point:o===-1?void 0:[...n[o]],distance:Math.sqrt(e)}}getClosestControlPointWithinDistance(t,n){const e=this.getClosestControlPoint(t);return e.distance<=n?e:void 0}getClosestPoint(t){this._update();const n=this._getCurveSegmmentsDistanceSquaredInfo(t);if(!n.length)return;n.sort((u,h)=>u.distanceSquared-h.distanceSquared);let e,o=-1,a=1/0,s,r;for(let u=0;u<n.length;u++){const h=n[u];if(h.distanceSquared>a)continue;const{curveSegmentIndex:g,curveSegment:f}=h,{lineSegments:m}=f;for(let v=0;v<m.length;v++){const p=m[v],{point:I,distanceSquared:C}=zs(p.points.start,p.points.end,t);C<a&&(r=p,o=g,s=h.curveSegment,e=I,a=C)}}const l=(r.previousLineSegmentsLength+Fn(r.points.start,e))/s.length,d=o+l;return{point:e,uValue:d,distance:Math.sqrt(a)}}getClosestPointOnControlPointLines(t){const n=[...this._controlPoints];if(this._closed&&n.push(this._controlPoints[0]),!n.length)return;let e,o=1/0,a=n[0];for(let s=1,r=n.length;s<r;s++){const c=n[s],{point:l,distanceSquared:d}=zs(a,c,t);d<o&&(e=l,o=d),a=c}return{point:e,distance:Math.sqrt(o)}}getPolylinePoints(){return this._update(),this._convertCurveSegmentsToPolyline(this._curveSegments)}getPreviewPolylinePoints(t,n){if(this._closed)return[];this._update();const o=this.getClosestControlPointWithinDistance(t,n)?.index===0,a=this.getPreviewCurveSegments(t,o);return a?.length?this._convertCurveSegmentsToPolyline(a):[]}isPointNearCurve(t,n){this._update();const e=this._getCurveSegmmentsWithinDistance(t,n),o=n*n;for(let a=0;a<e.length;a++){const{lineSegments:s}=e[a];for(let r=0;r<s.length;r++){const c=s[r];if(ns(c.points.start,c.points.end,t)<=o)return!0}}return!1}containsPoint(t){if(this._update(),this._controlPoints.length<3)return!1;const e=[...this._curveSegments],o=this._getClosingCurveSegmentWithStraightLineSegment();o&&e.push(o);let a=0;for(let s=0;s<e.length;s++){const r=e[s],{aabb:c}=r;if(!(t[0]<=c.maxX&&t[1]>=c.minY&&t[1]<c.maxY))continue;const{lineSegments:d}=r;for(let u=0;u<d.length;u++){const h=d[u],{aabb:g}=h;if(t[0]<=g.maxX&&t[1]>=g.minY&&t[1]<g.maxY){const{start:m,end:v}=h.points,p=m[0]===v[0],I=(t[1]-m[1])*(v[0]-m[0])/(v[1]-m[1])+m[0];a+=p||t[0]<=I?1:0}}}return a%2===1}_update(){if(!this._invalidated)return;const t=this.getSplineCurves();let n=0,e=1/0,o=1/0,a=-1/0,s=-1/0;for(let r=0,c=t.length;r<c;r++){const{aabb:l,length:d}=t[r];e=e<=l.minX?e:l.minX,o=o<=l.minY?o:l.minY,a=a>=l.maxX?a:l.maxX,s=s>=l.maxY?s:l.maxY,n+=d}this._curveSegments=t,this._aabb={minX:e,minY:o,maxX:a,maxY:s},this._length=n,this._invalidated=!1}_convertCurveSegmentsToPolyline(t){this._update();const n=[];return t.forEach(({lineSegments:e},o)=>{e.forEach((a,s)=>{o===0&&s===0&&n.push([...a.points.start]),n.push([...a.points.end])})}),n}_getCurveSegmmentsDistanceSquaredInfo(t){this._update();const n=[],{_curveSegments:e}=this;for(let o=0;o<e.length;o++){const a=e[o],s=Hs(a.aabb,t);n.push({curveSegmentIndex:o,curveSegment:a,distanceSquared:s})}return n}_getCurveSegmmentsWithinDistance(t,n){this._update();const e=n*n;if(Hs(this.aabb,t)>e)return[];const o=this._getCurveSegmmentsDistanceSquaredInfo(t),a=[];for(let s=0,r=o.length;s<r;s++){const{curveSegment:c,distanceSquared:l}=o[s];l<=e&&a.push(c)}return a}_getLineSegmentAt(t){this._update();const n=Math.floor(t),e=t-n,o=this._curveSegments[n],{lineSegments:a}=o,s=o.length*e;for(let r=0;r<a.length;r++){const c=a[r],l=c.previousLineSegmentsLength+c.length;if(s>=c.previousLineSegmentsLength&&s<=l)return c}}_getClosingCurveSegmentWithStraightLineSegment(){if(this.closed)return;const t=this._controlPoints,n=t[0],e=t[t.length-1],o={points:{start:[...n],end:[...e]},aabb:{minX:Math.min(n[0],e[0]),minY:Math.min(n[1],e[1]),maxX:Math.max(n[0],e[0]),maxY:Math.max(n[1],e[1])}};return{aabb:{minX:o.aabb.minX,minY:o.aabb.minY,maxX:o.aabb.maxX,maxY:o.aabb.maxY},lineSegments:[o]}}}const yy=1e-8;class Zd extends Kd{getPreviewCurveSegments(t,n){const e=this._getNumCurveSegments()+1,o=Math.max(0,e-2),a=n?e:e-1,s=this.getTransformMatrix(),r=[...this.controlPoints],c=[];n||r.push(t);for(let l=o;l<=a;l++){const d=this._getCurveSegment(l,s,r,n);c.push(d)}return c}getSplineCurves(){const t=this._getNumCurveSegments(),n=new Array(t);if(t<=0)return[];const e=this.getTransformMatrix();let o=0;for(let a=0;a<t;a++){const s=this._getCurveSegment(a,e);s.previousCurveSegmentsLength=o,n[a]=s,o+=s.length}return n}_getNumCurveSegments(t=this.controlPoints,n=this.closed){return n?t.length:Math.max(0,t.length-1)}_getPoint(t,n,e=this.controlPoints,o=this.closed){const a=this._getNumCurveSegments(e,o),s=Math.floor(t);let r=s%a;const c=t-s;if(r<0||r>=a)if(this.closed)r=(a+r)%a;else return;const{p0:d,p1:u,p2:h,p3:g}=this._getCurveSegmentPoints(r,e,o),f=c*c,m=f*c,v=tc(1,c,f,m),p=m0(p0(),v,n);return[fu(p,tc(d[0],u[0],h[0],g[0])),fu(p,tc(d[1],u[1],h[1],g[1]))]}_getCurveSegmentPoints(t,n=this.controlPoints,e=this.closed){const o=this._getNumCurveSegments(n,e),a=t,s=a-1,r=e?(a+1)%o:a+1,c=r+1,l=n[a],d=n[r];let u,h;return s>=0?u=n[s]:u=e?n[n.length-1]:qc(d,l),c<n.length?h=n[c]:h=e?n[0]:qc(l,d),{p0:u,p1:l,p2:d,p3:h}}_getLineSegments(t,n,e=this.controlPoints,o=this.closed){const a=this._getNumCurveSegments(e,o),s=this.resolution+1,r=1/s,c=t;let l=c+1;!o&&t===a-1&&(l-=yy);const d=[];let u,h,g=0;for(let f=0,m=c;f<=s;f++,m+=r){m=m>l?l:m;const v=this._getPoint(m,n,e,o);if(!f){u=v;continue}h=v;const p=h[0]-u[0],I=h[1]-u[1],C=Math.sqrt(p**2+I**2),E={minX:u[0]<=h[0]?u[0]:h[0],maxX:u[0]>=h[0]?u[0]:h[0],minY:u[1]<=h[1]?u[1]:h[1],maxY:u[1]>=h[1]?u[1]:h[1]};d.push({points:{start:u,end:h},aabb:E,length:C,previousLineSegmentsLength:g}),u=h,g+=C}return d}_getCurveSegment(t,n=this.getTransformMatrix(),e=this.controlPoints,o=this.closed){const{p0:a,p1:s,p2:r,p3:c}=this._getCurveSegmentPoints(t,e,o),l=this._getLineSegments(t,n,e,o);let d=0,u=1/0,h=1/0,g=-1/0,f=-1/0;return l.forEach(({aabb:m,length:v})=>{u=Math.min(u,m.minX),h=Math.min(h,m.minY),g=Math.max(g,m.maxX),f=Math.max(f,m.maxY),d+=v}),{controlPoints:{p0:a,p1:s,p2:r,p3:c},aabb:{minX:u,minY:h,maxX:g,maxY:f},length:d,previousCurveSegmentsLength:0,lineSegments:l}}}const Ay=v0(mr(),I0(1,4,1,0,-3,0,3,0,3,-6,3,0,-1,3,-3,1),1/6);class wI extends Zd{getTransformMatrix(){return Ay}}class Ya extends Zd{constructor(t){super(t),this._scale=t?.scale??.5,this._fixedScale=t?.fixedScale??!1}get scale(){return this._scale}set scale(t){this._fixedScale||this._scale===t||(this._scale=t,this.invalidated=!0)}get fixedScale(){return this._fixedScale}getTransformMatrix(){const{scale:t}=this,n=2*t;return[0,1,0,0,-t,0,t,0,n,t-3,3-n,-t,-t,2-t,t-2,t]}}class CI extends Ya{constructor(){super({scale:.5,fixedScale:!0})}}class EI extends Ya{constructor(){super({resolution:0,fixedResolution:!0,scale:0,fixedScale:!0})}}class SI extends Kd{getSplineCurves(){return[]}getLineSegments(){return[]}getPreviewCurveSegments(t,n){return[]}}const Oy=[1,0,0,-2,2,0,1,-2,1];class Ly extends SI{hasTangentPoints(){return!0}getTransformMatrix(){return Oy}}const oO=Object.freeze(Object.defineProperty({__proto__:null,BSpline:wI,CardinalSpline:Ya,CatmullRomSpline:CI,CubicSpline:Zd,LinearSpline:EI,QuadraticBezier:Ly,QuadraticSpline:SI,Spline:Kd},Symbol.toStringTag,{value:"Module"}));class Ry extends de{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{limitToViewport:!1,ignoreX:!1,ignoreY:!1,ignoreZ:!1}}){super(t,n)}touchDragCallback(t){this._dragCallback(t)}mouseDragCallback(t){this._dragCallback(t)}_checkImageInViewport(t,n){const{canvas:e}=t,o=window.devicePixelRatio,a=0,s=e.width/o,r=0,c=e.height/o,l=t.getDefaultActor(),d=t.getRenderer();let u;l&&w0(l)?u=l.actor.getMapper().getInputData().getBounds():u=d.computeVisiblePropBounds();const[h,g]=t.worldToCanvas([u[0],u[2],u[4]]),[f,m]=t.worldToCanvas([u[1],u[3],u[5]]);if(t.getZoom()<=1){if(h+n[0]<a&&n[0]<0||f+n[0]>s&&n[0]>0||g+n[1]<r&&n[1]<0||m+n[1]>c&&n[1]>0)return!1}else if(h+n[0]>a&&n[0]>0||f+n[0]<s&&n[0]<0||g+n[1]>r&&n[1]>0||m+n[1]<c&&n[1]<0)return!1;return!0}_dragCallback(t){const{element:n,deltaPoints:e}=t.detail,o=y(n),a=e.world,s=e.canvas;if(a[0]===0&&a[1]===0&&a[2]===0)return;this.configuration.ignoreX&&(a[0]=0),this.configuration.ignoreY&&(a[1]=0),this.configuration.ignoreZ&&(a[2]=0);const r=o.viewport,c=r.getCamera(),{focalPoint:l,position:d}=c;if(this.configuration.limitToViewport&&!this._checkImageInViewport(r,s))return;const u=[d[0]-a[0],d[1]-a[1],d[2]-a[2]],h=[l[0]-a[0],l[1]-a[1],l[2]-a[2]];r.setCamera({focalPoint:h,position:u}),r.render()}}Ry.toolName="Pan";class Ny extends de{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{rotateIncrementDegrees:2,rotateSampleDistanceFactor:2}}){super(t,n),this._resizeObservers=new Map,this._hasResolutionChanged=!1,this.preMouseDownCallback=e=>{const o=e.detail,{element:a}=o,s=y(a),{viewport:r}=s,d=r.getDefaultActor().actor.getMapper();if(!("getSampleDistance"in d||"getCurrentSampleDistance"in d))return!0;const h=d.getSampleDistance();if(!this._hasResolutionChanged){const{rotateSampleDistanceFactor:g}=this.configuration;d.setSampleDistance(h*g),this._hasResolutionChanged=!0,this.cleanUp!==null&&document.removeEventListener("mouseup",this.cleanUp),this.cleanUp=()=>{d.setSampleDistance(h),r.render(),this._hasResolutionChanged=!1},document.addEventListener("mouseup",this.cleanUp,{once:!0})}return!0},this._getViewportsInfo=()=>_e(this.toolGroupId).viewportsInfo,this.onSetToolActive=()=>{const e=()=>{this._getViewportsInfo().forEach(({viewportId:a,renderingEngineId:s})=>{if(!this._resizeObservers.has(a)){const{viewport:r}=Gt(a,s)||{viewport:null};if(!r)return;const{element:c}=r,l=new ResizeObserver(()=>{const d=Gt(a,s);if(!d)return;const{viewport:u}=d,h=u.getViewPresentation();u.resetCamera(),u.setViewPresentation(h),u.render()});l.observe(c),this._resizeObservers.set(a,l)}})};e(),this._viewportAddedListener=o=>{o.detail.toolGroupId===this.toolGroupId&&e()},z.addEventListener(w.TOOLGROUP_VIEWPORT_ADDED,this._viewportAddedListener)},this.onSetToolDisabled=()=>{this._resizeObservers.forEach((e,o)=>{e.disconnect(),this._resizeObservers.delete(o)}),this._viewportAddedListener&&(z.removeEventListener(w.TOOLGROUP_VIEWPORT_ADDED,this._viewportAddedListener),this._viewportAddedListener=null)},this.rotateCamera=(e,o,a,s)=>{const r=e.getVtkActiveCamera(),c=r.getViewUp(),l=r.getFocalPoint(),d=r.getPosition(),u=[0,0,0],h=[0,0,0],g=[0,0,0],f=So(new Float32Array(16));Ai(f,f,o),Yo(f,f,s,a),Ai(f,f,[-o[0],-o[1],-o[2]]),Se(u,d,f),Se(h,l,f),So(f),Yo(f,f,s,a),Se(g,c,f),e.setCamera({position:u,viewUp:g,focalPoint:h})},this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(t){const{element:n,currentPoints:e,lastPoints:o}=t.detail,a=e.canvas,s=o.canvas,{rotateIncrementDegrees:r}=this.configuration,c=y(n),{viewport:l}=c,d=l.getCamera(),u=n.clientWidth,h=n.clientHeight,g=[a[0]/u,a[1]/h],f=[s[0]/u,s[1]/h],m=[u*.5,h*.5],v=l.canvasToWorld(m),I=(1+Math.abs([.5,.5][0]))**2,C=[f[0],0,0],E=[g[0],0,0],S=C[0]**2,_=E[0]**2,D=S>I?0:Math.sqrt(I-S),b=_>I?0:Math.sqrt(I-_),M=[C[0],0,D];st.normalize(M);const P=[E[0],0,b];st.normalize(P);const T=st.dot(M,P);if(Math.abs(T)>1e-4){const x=-2*Math.acos(st.clampValue(T,-1,1))*Math.sign(g[0]-f[0])*r,A=d.viewUp,O=d.viewPlaneNormal,R=[0,0,0],N=[0,0,0];st.cross(A,O,R),st.normalize(R),st.cross(O,R,N),st.normalize(N),st.normalize(A),this.rotateCamera(l,v,N,x);const k=(f[1]-g[1])*r;this.rotateCamera(l,v,R,k),l.render()}}}Ny.toolName="TrackballRotate";function Uy(i,t){t.classHierarchy.push("vtkSphereSource"),i.requestData=(n,e)=>{let o=e[0];const a=o?o.getPoints().getDataType():t.pointType;o=o?.initialize()||Eo.newInstance();let s=0,{thetaResolution:r}=t,c=t.startTheta<t.endTheta?t.startTheta:t.endTheta;c*=Math.PI/180;let l=t.endTheta>t.startTheta?t.endTheta:t.startTheta;l*=Math.PI/180;let d=t.startPhi<t.endPhi?t.startPhi:t.endPhi;d*=Math.PI/180;let u=t.endPhi>t.startPhi?t.endPhi:t.startPhi;u*=Math.PI/180,Math.abs(c-l)<2*Math.PI&&++r;const h=(l-c)/t.thetaResolution,g=t.startPhi<=0?1:0,f=t.phiResolution+(t.endPhi>=180?-1:0),m=t.phiResolution*r+2,v=t.phiResolution*2*t.thetaResolution;let p=0,I=Mt.newTypedArray(a,m*3),C=new Float32Array(m*3),E=0,S=new Uint32Array(v*5);t.startPhi<=0&&(I[p*3+0]=t.center[0],I[p*3+1]=t.center[1],I[p*3+2]=t.center[2]+t.radius,C[p*3+0]=0,C[p*3+1]=0,C[p*3+2]=1,p++,s++),t.endPhi>=180&&(I[p*3+0]=t.center[0],I[p*3+1]=t.center[1],I[p*3+2]=t.center[2]-t.radius,C[p*3+0]=0,C[p*3+1]=0,C[p*3+2]=-1,p++,s++);const _=t.phiResolution-s,D=(u-d)/(t.phiResolution-1);for(let P=0;P<r;P++){const T=c+P*h;for(let x=g;x<f;x++){const A=d+x*D,O=t.radius*Math.sin(A);C[p*3+0]=O*Math.cos(T),C[p*3+1]=O*Math.sin(T),C[p*3+2]=t.radius*Math.cos(A),I[p*3+0]=C[p*3+0]+t.center[0],I[p*3+1]=C[p*3+1]+t.center[1],I[p*3+2]=C[p*3+2]+t.center[2];let R=Math.sqrt(C[p*3+0]*C[p*3+0]+C[p*3+1]*C[p*3+1]+C[p*3+2]*C[p*3+2]);R=R===0?1:R,C[p*3+0]/=R,C[p*3+1]/=R,C[p*3+2]/=R,p++}}const b=_*r;if(Math.abs(c-l)<2*Math.PI&&--r,t.startPhi<=0)for(let P=0;P<r;P++)S[E++]=3,S[E++]=_*P+s,S[E++]=_*(P+1)%b+s,S[E++]=0;if(t.endPhi>=180){const P=_-1+s;for(let T=0;T<r;T++)S[E++]=3,S[E++]=_*T+P,S[E++]=s-1,S[E++]=_*(T+1)%b+P}for(let P=0;P<r;P++)for(let T=0;T<_-1;T++){const x=_*P+T+s,A=x+1,O=(_*(P+1)+T)%b+s+1;t.latLongTessellation?(S[E++]=4,S[E++]=x,S[E++]=A,S[E++]=O,S[E++]=O-1):(S[E++]=3,S[E++]=x,S[E++]=A,S[E++]=O,S[E++]=3,S[E++]=x,S[E++]=O,S[E++]=O-1)}I=I.subarray(0,p*3),o.getPoints().setData(I,3),C=C.subarray(0,p*3);const M=Zn.newInstance({name:"Normals",values:C,numberOfComponents:3});o.getPointData().setNormals(M),S=S.subarray(0,E),o.getPolys().setData(S,1),e[0]=o}}const ky={radius:.5,latLongTessellation:!1,thetaResolution:8,startTheta:0,endTheta:360,phiResolution:8,startPhi:0,endPhi:180,center:[0,0,0],pointType:"Float64Array"};function _I(i,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(t,ky,n),Mt.obj(i,t),Mt.setGet(i,t,["radius","latLongTessellation","thetaResolution","startTheta","endTheta","phiResolution","startPhi","endPhi"]),Mt.setGetArray(i,t,["center"],3),Mt.algo(i,t,0,1),Uy(i,t)}const Vy=Mt.newInstance(_I,"vtkSphereSource");var Fy={newInstance:Vy,extend:_I};const on={XMIN:0,XMAX:1,YMIN:2,YMAX:3,ZMIN:4,ZMAX:5},rt={XMIN:0,XMAX:1,YMIN:2,YMAX:3,ZMIN:4,ZMAX:5,XMIN_YMIN_ZMIN:6,XMIN_YMIN_ZMAX:7,XMIN_YMAX_ZMIN:8,XMIN_YMAX_ZMAX:9,XMAX_YMIN_ZMIN:10,XMAX_YMIN_ZMAX:11,XMAX_YMAX_ZMIN:12,XMAX_YMAX_ZMAX:13};class By extends de{constructor(t={},n={configuration:{showCornerSpheres:!0,showHandles:!0,showClippingPlanes:!0,mobile:{enabled:!1,opacity:.8},initialCropFactor:.08,sphereColors:{SAGITTAL:[1,1,0],CORONAL:[0,1,0],AXIAL:[1,0,0],CORNERS:[0,0,1]},sphereRadius:8,grabSpherePixelDistance:20,rotateIncrementDegrees:2,rotateSampleDistanceFactor:2}}){super(t,n),this._resizeObservers=new Map,this._hasResolutionChanged=!1,this.originalClippingPlanes=[],this.draggingSphereIndex=null,this.toolCenter=[0,0,0],this.cornerDragOffset=null,this.faceDragOffset=null,this.sphereStates=[],this.edgeLines={},this.onSetToolConfiguration=()=>{console.debug("Setting tool settoolconfiguration : volumeCropping")},this.onSetToolEnabled=()=>{console.debug("Setting tool enabled: volumeCropping")},this.onCameraModified=e=>{const{element:o}=e.currentTarget?{element:e.currentTarget}:e.detail,a=y(o);this._updateClippingPlanes(a.viewport),a.viewport.render()},this.preMouseDownCallback=e=>{const o=e.detail,{element:a}=o,s=y(a),{viewport:r}=s,d=r.getDefaultActor().actor.getMapper(),u=[e.detail.currentPoints.canvas[0],e.detail.currentPoints.canvas[1]];this.draggingSphereIndex=null,this.cornerDragOffset=null,this.faceDragOffset=null;for(let f=0;f<this.sphereStates.length;++f){const m=r.worldToCanvas(this.sphereStates[f].point);if(Math.sqrt(Math.pow(u[0]-m[0],2)+Math.pow(u[1]-m[1],2))<this.configuration.grabSpherePixelDistance){this.draggingSphereIndex=f,a.style.cursor="grabbing";const p=this.sphereStates[f],I=r.canvasToWorld(u);if(p.isCorner)this.cornerDragOffset=[p.point[0]-I[0],p.point[1]-I[1],p.point[2]-I[2]],this.faceDragOffset=null;else{const C={x:0,y:1,z:2}[p.axis];this.faceDragOffset=p.point[C]-I[C],this.cornerDragOffset=null}return!0}}if(!("getSampleDistance"in d||"getCurrentSampleDistance"in d))return!0;const g=d.getSampleDistance();if(!this._hasResolutionChanged){const{rotateSampleDistanceFactor:f}=this.configuration;d.setSampleDistance(g*f),this._hasResolutionChanged=!0,this.cleanUp!==null&&document.removeEventListener("mouseup",this.cleanUp),this.cleanUp=()=>{if(d.setSampleDistance(g),e.target.style.cursor="",this.draggingSphereIndex!==null){const m=this.sphereStates[this.draggingSphereIndex],[v]=this._getViewportsInfo(),I=te(v.renderingEngineId).getViewport(v.viewportId);m.isCorner&&(this._updateCornerSpheres(),this._updateFaceSpheresFromCorners(),this._updateClippingPlanesFromFaceSpheres(I))}this.draggingSphereIndex=null,this.cornerDragOffset=null,this.faceDragOffset=null,r.render(),this._hasResolutionChanged=!1},document.addEventListener("mouseup",this.cleanUp,{once:!0})}return!0},this._onMouseMoveSphere=e=>{if(this.draggingSphereIndex===null)return!1;const o=this.sphereStates[this.draggingSphereIndex];if(!o)return!1;const{viewport:a,world:s}=this._getViewportAndWorldCoords(e);if(!a||!s)return!1;if(o.isCorner){const r=this._calculateNewCornerPosition(s);this._updateSpherePosition(o,r);const c=this._parseCornerKey(o.uid);this._updateRelatedCorners(o,r,c),this._updateFaceSpheresFromCorners(),this._updateCornerSpheres()}else{const r={x:0,y:1,z:2}[o.axis];let c=s[r];this.faceDragOffset!==null&&(c+=this.faceDragOffset),o.point[r]=c,o.sphereSource.setCenter(...o.point),o.sphereSource.modified(),this._updateCornerSpheresFromFaces(),this._updateFaceSpheresFromCorners(),this._updateCornerSpheres()}return this._updateClippingPlanesFromFaceSpheres(a),a.render(),this._triggerToolChangedEvent(o),!0},this._onControlToolChange=e=>{const o=this._getViewport();if(!e.detail.toolCenter)gt(z,w.VOLUMECROPPING_TOOL_CHANGED,{originalClippingPlanes:this.originalClippingPlanes,viewportId:o.id,renderingEngineId:o.renderingEngineId,seriesInstanceUID:this.seriesInstanceUID});else{if(e.detail.seriesInstanceUID!==this.seriesInstanceUID)return;const a=e.detail.handleType==="min",s=a?e.detail.toolCenterMin:e.detail.toolCenterMax,r=a?[[1,0,0],[0,1,0],[0,0,1]]:[[-1,0,0],[0,-1,0],[0,0,-1]],c=a?[on.XMIN,on.YMIN,on.ZMIN]:[on.XMAX,on.YMAX,on.ZMAX],l=a?[rt.XMIN,rt.YMIN,rt.ZMIN]:[rt.XMAX,rt.YMAX,rt.ZMAX],d=["x","y","z"],u=[ec.SAGITTAL,ec.CORONAL,ec.AXIAL];for(let h=0;h<3;++h){const g=[0,0,0];g[h]=s[h];const f=Wn.newInstance({origin:g,normal:r[h]});this.originalClippingPlanes[c[h]].origin=f.getOrigin(),this.sphereStates[l[h]].point[h]=f.getOrigin()[h],this.sphereStates[l[h]].sphereSource.setCenter(...this.sphereStates[l[h]].point),this.sphereStates[l[h]].sphereSource.modified();const v=(this.sphereStates.find((I,C)=>I.axis===d[h]&&C!==l[h]).point[h]+f.getOrigin()[h])/2;this.sphereStates.forEach(I=>{!I.isCorner&&I.axis!==d[h]&&!e.detail.viewportOrientation.includes(u[h])&&(I.point[h]=v,I.sphereSource.setCenter(I.point),I.sphereActor.getProperty().setColor(I.color),I.sphereSource.modified())});const p=o.getDefaultActor()?.actor;if(p){const C=p.getMapper().getClippingPlanes();C&&C[c[h]].setOrigin(f.getOrigin())}}this._updateCornerSpheres(),o.render()}},this._getViewportsInfo=()=>_e(this.toolGroupId).viewportsInfo,this._initialize3DViewports=e=>{if(!e||!e.length||!e[0]){console.warn("VolumeCroppingTool: No viewportsInfo available for initialization of volumecroppingtool.");return}const o=this._getViewport(),a=o.getActors();if(!a||a.length===0){console.warn("VolumeCroppingTool: No volume actors found in the viewport.");return}const s=a[0].actor.getMapper().getInputData();if(!s){console.warn("VolumeCroppingTool: No image data found for volume actor.");return}this.seriesInstanceUID=s.seriesInstanceUID||"unknown";const r=s.getBounds(),c=this.configuration.initialCropFactor||.1,l=r[1]-r[0],d=r[3]-r[2],u=r[5]-r[4],h=r[0]+c*l,g=r[1]-c*l,f=r[2]+c*d,m=r[3]-c*d,v=r[4]+c*u,p=r[5]-c*u,I=[],C=Wn.newInstance({origin:[h,0,0],normal:[1,0,0]}),E=Wn.newInstance({origin:[g,0,0],normal:[-1,0,0]}),S=Wn.newInstance({origin:[0,f,0],normal:[0,1,0]}),_=Wn.newInstance({origin:[0,m,0],normal:[0,-1,0]}),D=Wn.newInstance({origin:[0,0,v],normal:[0,0,1]}),b=Wn.newInstance({origin:[0,0,p],normal:[0,0,-1]}),M=o.getDefaultActor().actor.getMapper();I.push(C),I.push(E),I.push(S),I.push(_),I.push(D),I.push(b);const P=I.map(H=>({origin:[...H.getOrigin()],normal:[...H.getNormal()]}));this.originalClippingPlanes=P;const T=[h,(m+f)/2,(p+v)/2],x=[g,(m+f)/2,(p+v)/2],A=[(g+h)/2,f,(p+v)/2],O=[(g+h)/2,m,(p+v)/2],R=[(g+h)/2,(m+f)/2,v],N=[(g+h)/2,(m+f)/2,p],k=this._calculateAdaptiveSphereRadius(Math.sqrt(l*l+d*d+u*u));this._addSphere(o,T,"x","min",null,k),this._addSphere(o,x,"x","max",null,k),this._addSphere(o,A,"y","min",null,k),this._addSphere(o,O,"y","max",null,k),this._addSphere(o,R,"z","min",null,k),this._addSphere(o,N,"z","max",null,k);const B=[[h,f,v],[h,f,p],[h,m,v],[h,m,p],[g,f,v],[g,f,p],[g,m,v],[g,m,p]],V=["XMIN_YMIN_ZMIN","XMIN_YMIN_ZMAX","XMIN_YMAX_ZMIN","XMIN_YMAX_ZMAX","XMAX_YMIN_ZMIN","XMAX_YMIN_ZMAX","XMAX_YMAX_ZMIN","XMAX_YMAX_ZMAX"];for(let H=0;H<B.length;H++)this._addSphere(o,B[H],"corner",null,V[H],k);[["XMIN_YMIN_ZMIN","XMAX_YMIN_ZMIN"],["XMIN_YMIN_ZMAX","XMAX_YMIN_ZMAX"],["XMIN_YMAX_ZMIN","XMAX_YMAX_ZMIN"],["XMIN_YMAX_ZMAX","XMAX_YMAX_ZMAX"],["XMIN_YMIN_ZMIN","XMIN_YMAX_ZMIN"],["XMIN_YMIN_ZMAX","XMIN_YMAX_ZMAX"],["XMAX_YMIN_ZMIN","XMAX_YMAX_ZMIN"],["XMAX_YMIN_ZMAX","XMAX_YMAX_ZMAX"],["XMIN_YMIN_ZMIN","XMIN_YMIN_ZMAX"],["XMIN_YMAX_ZMIN","XMIN_YMAX_ZMAX"],["XMAX_YMIN_ZMIN","XMAX_YMIN_ZMAX"],["XMAX_YMAX_ZMIN","XMAX_YMAX_ZMAX"]].forEach(([H,G],Y)=>{const q=this.sphereStates.find(K=>K.uid===`corner_${H}`),j=this.sphereStates.find(K=>K.uid===`corner_${G}`);if(q&&j){const K=`edge_${H}_${G}`,{actor:it,source:at}=this._addLine3DBetweenPoints(o,q.point,j.point,[.7,.7,.7],K);this.edgeLines[K]={actor:it,source:at,key1:H,key2:G}}}),M.addClippingPlane(C),M.addClippingPlane(E),M.addClippingPlane(S),M.addClippingPlane(_),M.addClippingPlane(D),M.addClippingPlane(b),z.addEventListener(w.VOLUMECROPPINGCONTROL_TOOL_CHANGED,H=>{this._onControlToolChange(H)}),o.render()},this._getViewportAndWorldCoords=e=>{const o=this._getViewport(),a=e.detail.currentPoints.canvas[0],s=e.detail.currentPoints.canvas[1],r=o.canvasToWorld([a,s]);return{viewport:o,world:r}},this._getViewport=()=>{const[e]=this._getViewportsInfo();return te(e.renderingEngineId).getViewport(e.viewportId)},this._handleCornerSphereMovement=(e,o,a)=>{const s=this._calculateNewCornerPosition(o);this._updateSpherePosition(e,s);const r=this._parseCornerKey(e.uid);this._updateRelatedCorners(e,s,r),this._updateAfterCornerMovement(a)},this._handleFaceSphereMovement=(e,o,a)=>{const s={x:0,y:1,z:2}[e.axis];let r=o[s];this.faceDragOffset!==null&&(r+=this.faceDragOffset),e.point[s]=r,e.sphereSource.setCenter(...e.point),e.sphereSource.modified(),this._updateAfterFaceMovement(a)},this._calculateNewCornerPosition=e=>{let o=[e[0],e[1],e[2]];return this.cornerDragOffset&&(o=[e[0]+this.cornerDragOffset[0],e[1]+this.cornerDragOffset[1],e[2]+this.cornerDragOffset[2]]),o},this._parseCornerKey=e=>{const o=e.replace("corner_","");return{isXMin:o.includes("XMIN"),isXMax:o.includes("XMAX"),isYMin:o.includes("YMIN"),isYMax:o.includes("YMAX"),isZMin:o.includes("ZMIN"),isZMax:o.includes("ZMAX")}},this._updateSpherePosition=(e,o)=>{e.point=o,e.sphereSource.setCenter(...o),e.sphereSource.modified()},this._updateRelatedCorners=(e,o,a)=>{this.sphereStates.forEach(s=>{if(!s.isCorner||s===e)return;const r=s.uid.replace("corner_","");this._shouldUpdateCorner(r,a)&&this._updateCornerCoordinates(s,o,r,a)})},this._shouldUpdateCorner=(e,o)=>o.isXMin&&e.includes("XMIN")||o.isXMax&&e.includes("XMAX")||o.isYMin&&e.includes("YMIN")||o.isYMax&&e.includes("YMAX")||o.isZMin&&e.includes("ZMIN")||o.isZMax&&e.includes("ZMAX"),this._updateCornerCoordinates=(e,o,a,s)=>{(s.isXMin&&a.includes("XMIN")||s.isXMax&&a.includes("XMAX"))&&(e.point[0]=o[0]),(s.isYMin&&a.includes("YMIN")||s.isYMax&&a.includes("YMAX"))&&(e.point[1]=o[1]),(s.isZMin&&a.includes("ZMIN")||s.isZMax&&a.includes("ZMAX"))&&(e.point[2]=o[2]),e.sphereSource.setCenter(...e.point),e.sphereSource.modified()},this._updateAfterCornerMovement=e=>{this._updateFaceSpheresFromCorners(),this._updateCornerSpheres(),this._updateClippingPlanesFromFaceSpheres(e)},this._updateAfterFaceMovement=e=>{this._updateCornerSpheresFromFaces(),this._updateClippingPlanesFromFaceSpheres(e)},this._triggerToolChangedEvent=e=>{gt(z,w.VOLUMECROPPING_TOOL_CHANGED,{toolCenter:e.point,axis:e.isCorner?"corner":e.axis,draggingSphereIndex:this.draggingSphereIndex,seriesInstanceUID:this.seriesInstanceUID})},this._onNewVolume=()=>{const e=this._getViewportsInfo();this.originalClippingPlanes=[],this.sphereStates=[],this.edgeLines={},this._initialize3DViewports(e)},this._rotateCamera=(e,o,a,s)=>{const r=e.getVtkActiveCamera(),c=r.getViewUp(),l=r.getFocalPoint(),d=r.getPosition(),u=[0,0,0],h=[0,0,0],g=[0,0,0],f=So(new Float32Array(16));Ai(f,f,o),Yo(f,f,s,a),Ai(f,f,[-o[0],-o[1],-o[2]]),Se(u,d,f),Se(h,l,f),So(f),Yo(f,f,s,a),Se(g,c,f),e.setCamera({position:u,viewUp:g,focalPoint:h})},this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}onSetToolActive(){if(this.sphereStates&&this.sphereStates.length>0)this.configuration.showHandles?(this.setHandlesVisible(!1),this.setClippingPlanesVisible(!1)):(this.setHandlesVisible(!0),this.setClippingPlanesVisible(!0));else{const t=this._getViewportsInfo(),n=()=>{t.forEach(({viewportId:e,renderingEngineId:o})=>{if(!this._resizeObservers.has(e)){const{viewport:a}=Gt(e,o)||{viewport:null};if(!a)return;const{element:s}=a,r=new ResizeObserver(()=>{const c=Gt(e,o);if(!c)return;const{viewport:l}=c,d=l.getViewPresentation();l.resetCamera(),l.setViewPresentation(d),l.render()});r.observe(s),this._resizeObservers.set(e,r)}})};n(),this._viewportAddedListener=e=>{e.detail.toolGroupId===this.toolGroupId&&n()},z.addEventListener(w.TOOLGROUP_VIEWPORT_ADDED,this._viewportAddedListener),this._unsubscribeToViewportNewVolumeSet(t),this._subscribeToViewportNewVolumeSet(t),this._initialize3DViewports(t),this.sphereStates&&this.sphereStates.length>0?this.setHandlesVisible(!0):(this.originalClippingPlanes=[],this._initialize3DViewports(t))}}onSetToolDisabled(){this._resizeObservers.forEach((n,e)=>{n.disconnect(),this._resizeObservers.delete(e)}),this._viewportAddedListener&&(z.removeEventListener(w.TOOLGROUP_VIEWPORT_ADDED,this._viewportAddedListener),this._viewportAddedListener=null);const t=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(t)}setHandlesVisible(t){this.configuration.showHandles=t,t&&(this.sphereStates[rt.XMIN].point[0]=this.originalClippingPlanes[on.XMIN].origin[0],this.sphereStates[rt.XMAX].point[0]=this.originalClippingPlanes[on.XMAX].origin[0],this.sphereStates[rt.YMIN].point[1]=this.originalClippingPlanes[on.YMIN].origin[1],this.sphereStates[rt.YMAX].point[1]=this.originalClippingPlanes[on.YMAX].origin[1],this.sphereStates[rt.ZMIN].point[2]=this.originalClippingPlanes[on.ZMIN].origin[2],this.sphereStates[rt.ZMAX].point[2]=this.originalClippingPlanes[on.ZMAX].origin[2],[rt.XMIN,rt.XMAX,rt.YMIN,rt.YMAX,rt.ZMIN,rt.ZMAX].forEach(s=>{const r=this.sphereStates[s];r.sphereSource.setCenter(...r.point),r.sphereSource.modified()}),this._updateCornerSpheres()),this._updateHandlesVisibility();const n=this._getViewportsInfo(),[e]=n;te(e.renderingEngineId).getViewport(e.viewportId).render()}getHandlesVisible(){return this.configuration.showHandles}getClippingPlanesVisible(){return this.configuration.showClippingPlanes}setClippingPlanesVisible(t){this.configuration.showClippingPlanes=t;const n=this._getViewport();this._updateClippingPlanes(n),n.render()}_dragCallback(t){const{element:n,currentPoints:e,lastPoints:o}=t.detail;if(this.draggingSphereIndex!==null)this._onMouseMoveSphere(t);else{const a=e.canvas,s=o.canvas,{rotateIncrementDegrees:r}=this.configuration,c=y(n),{viewport:l}=c,d=l.getCamera(),u=n.clientWidth,h=n.clientHeight,g=[a[0]/u,a[1]/h],f=[s[0]/u,s[1]/h],m=[u*.5,h*.5],v=l.canvasToWorld(m),I=(1+Math.abs([.5,.5][0]))**2,C=[f[0],0,0],E=[g[0],0,0],S=C[0]**2,_=E[0]**2,D=S>I?0:Math.sqrt(I-S),b=_>I?0:Math.sqrt(I-_),M=[C[0],0,D];st.normalize(M);const P=[E[0],0,b];st.normalize(P);const T=st.dot(M,P);if(Math.abs(T)>1e-4){const x=-2*Math.acos(st.clampValue(T,-1,1))*Math.sign(g[0]-f[0])*r,A=d.viewUp,O=d.viewPlaneNormal,R=[0,0,0],N=[0,0,0];st.cross(A,O,R),st.normalize(R),st.cross(O,R,N),st.normalize(N),st.normalize(A),this._rotateCamera(l,v,N,x);const k=(f[1]-g[1])*r;this._rotateCamera(l,v,R,k)}l.render()}}_updateClippingPlanes(t){const n=t.getDefaultActor();if(!n||!n.actor){t._missingActorWarned||(console.warn("VolumeCroppingTool._updateClippingPlanes: No default actor found in viewport."),t._missingActorWarned=!0);return}const e=n.actor,o=e.getMapper(),a=e.getMatrix();if(!this.configuration.showClippingPlanes){o.removeAllClippingPlanes();return}const s=mu();C0(s,a);const r=mu();E0(r,s),S0(r,r);const c=this.originalClippingPlanes;if(!c||!c.length)return;o.removeAllClippingPlanes();const l=[],d=[];for(let u=0;u<c.length;++u){const h=c[u],g=W();Se(g,new Float32Array(h.origin),a);const f=[g[0],g[1],g[2]],m=W();_0(m,new Float32Array(h.normal),r),Zt(m,m);const v=[m[0],m[1],m[2]];l.push(f),d.push(v)}for(let u=0;u<l.length;++u){const h=Wn.newInstance({origin:l[u],normal:d[u]});o.addClippingPlane(h)}}_updateHandlesVisibility(){this.sphereStates.forEach(t=>{t.sphereActor&&t.sphereActor.setVisibility(this.configuration.showHandles)}),Object.values(this.edgeLines).forEach(({actor:t})=>{t&&t.setVisibility(this.configuration.showHandles)})}_addLine3DBetweenPoints(t,n,e,o=[.7,.7,.7],a=""){if(n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2])return{actor:null,source:null};const s=Fg.newInstance();s.setNumberOfPoints(2),s.setPoint(0,n[0],n[1],n[2]),s.setPoint(1,e[0],e[1],e[2]);const r=Bc.newInstance({values:[2,0,1]}),c=Eo.newInstance();c.setPoints(s),c.setLines(r);const l=xi.newInstance();l.setInputData(c);const d=yi.newInstance();return d.setMapper(l),d.getProperty().setColor(...o),d.getProperty().setLineWidth(.5),d.getProperty().setOpacity(1),d.getProperty().setInterpolationToFlat(),d.getProperty().setAmbient(1),d.getProperty().setDiffuse(0),d.getProperty().setSpecular(0),d.setVisibility(this.configuration.showHandles),t.addActor({actor:d,uid:a}),{actor:d,source:c}}_addSphere(t,n,e,o,a=null,s){const r=a?`corner_${a}`:`${e}_${o}`;if(this.sphereStates.find(p=>p.uid===r))return;const l=Fy.newInstance();l.setCenter(n),l.setRadius(s);const d=xi.newInstance();d.setInputConnection(l.getOutputPort());const u=yi.newInstance();u.setMapper(d);let h=[0,1,0];const g=this.configuration.sphereColors||{};a?h=g.CORNERS||[0,0,1]:e==="z"?h=g.AXIAL||[1,0,0]:e==="x"?h=g.SAGITTAL||[1,1,0]:e==="y"&&(h=g.CORONAL||[0,1,0]);const f=this.sphereStates.findIndex(p=>p.uid===r);f===-1?this.sphereStates.push({point:n.slice(),axis:e,uid:r,sphereSource:l,sphereActor:u,isCorner:!!a,color:h}):(this.sphereStates[f].point=n.slice(),this.sphereStates[f].sphereSource=l),!t.getActors().find(p=>p.uid===r)&&(u.getProperty().setColor(h),u.setVisibility(this.configuration.showHandles),t.addActor({actor:u,uid:r}))}_calculateAdaptiveSphereRadius(t){this.configuration.sphereRadius!==void 0&&this.configuration.sphereRadius;const n=this.configuration.sphereRadiusScale||.01,e=t*n,o=this.configuration.minSphereRadius||2,a=this.configuration.maxSphereRadius||50;return Math.max(o,Math.min(a,e))}_updateClippingPlanesFromFaceSpheres(t){const n=t.getDefaultActor().actor.getMapper();this.originalClippingPlanes[0].origin=[...this.sphereStates[rt.XMIN].point],this.originalClippingPlanes[1].origin=[...this.sphereStates[rt.XMAX].point],this.originalClippingPlanes[2].origin=[...this.sphereStates[rt.YMIN].point],this.originalClippingPlanes[3].origin=[...this.sphereStates[rt.YMAX].point],this.originalClippingPlanes[4].origin=[...this.sphereStates[rt.ZMIN].point],this.originalClippingPlanes[5].origin=[...this.sphereStates[rt.ZMAX].point],n.removeAllClippingPlanes();for(let e=0;e<6;++e){const o=this.originalClippingPlanes[e].origin,a=this.originalClippingPlanes[e].normal,s=Wn.newInstance({origin:o,normal:a});n.addClippingPlane(s)}}_updateCornerSpheresFromFaces(){const t=this.sphereStates[rt.XMIN].point[0],n=this.sphereStates[rt.XMAX].point[0],e=this.sphereStates[rt.YMIN].point[1],o=this.sphereStates[rt.YMAX].point[1],a=this.sphereStates[rt.ZMIN].point[2],s=this.sphereStates[rt.ZMAX].point[2],r=[{key:"XMIN_YMIN_ZMIN",pos:[t,e,a]},{key:"XMIN_YMIN_ZMAX",pos:[t,e,s]},{key:"XMIN_YMAX_ZMIN",pos:[t,o,a]},{key:"XMIN_YMAX_ZMAX",pos:[t,o,s]},{key:"XMAX_YMIN_ZMIN",pos:[n,e,a]},{key:"XMAX_YMIN_ZMAX",pos:[n,e,s]},{key:"XMAX_YMAX_ZMIN",pos:[n,o,a]},{key:"XMAX_YMAX_ZMAX",pos:[n,o,s]}];for(const c of r){const l=this.sphereStates.find(d=>d.uid===`corner_${c.key}`);l&&(l.point[0]=c.pos[0],l.point[1]=c.pos[1],l.point[2]=c.pos[2],l.sphereSource.setCenter(...l.point),l.sphereSource.modified())}}_updateFaceSpheresFromCorners(){const t=[this.sphereStates[rt.XMIN_YMIN_ZMIN].point,this.sphereStates[rt.XMIN_YMIN_ZMAX].point,this.sphereStates[rt.XMIN_YMAX_ZMIN].point,this.sphereStates[rt.XMIN_YMAX_ZMAX].point,this.sphereStates[rt.XMAX_YMIN_ZMIN].point,this.sphereStates[rt.XMAX_YMIN_ZMAX].point,this.sphereStates[rt.XMAX_YMAX_ZMIN].point,this.sphereStates[rt.XMAX_YMAX_ZMAX].point],n=t.map(u=>u[0]),e=t.map(u=>u[1]),o=t.map(u=>u[2]),a=Math.min(...n),s=Math.max(...n),r=Math.min(...e),c=Math.max(...e),l=Math.min(...o),d=Math.max(...o);this.sphereStates[rt.XMIN].point=[a,(r+c)/2,(l+d)/2],this.sphereStates[rt.XMAX].point=[s,(r+c)/2,(l+d)/2],this.sphereStates[rt.YMIN].point=[(a+s)/2,r,(l+d)/2],this.sphereStates[rt.YMAX].point=[(a+s)/2,c,(l+d)/2],this.sphereStates[rt.ZMIN].point=[(a+s)/2,(r+c)/2,l],this.sphereStates[rt.ZMAX].point=[(a+s)/2,(r+c)/2,d],[rt.XMIN,rt.XMAX,rt.YMIN,rt.YMAX,rt.ZMIN,rt.ZMAX].forEach(u=>{const h=this.sphereStates[u];h.sphereSource.setCenter(...h.point),h.sphereSource.modified()})}_updateCornerSpheres(){const t=this.sphereStates[rt.XMIN].point[0],n=this.sphereStates[rt.XMAX].point[0],e=this.sphereStates[rt.YMIN].point[1],o=this.sphereStates[rt.YMAX].point[1],a=this.sphereStates[rt.ZMIN].point[2],s=this.sphereStates[rt.ZMAX].point[2],r=[{key:"XMIN_YMIN_ZMIN",pos:[t,e,a]},{key:"XMIN_YMIN_ZMAX",pos:[t,e,s]},{key:"XMIN_YMAX_ZMIN",pos:[t,o,a]},{key:"XMIN_YMAX_ZMAX",pos:[t,o,s]},{key:"XMAX_YMIN_ZMIN",pos:[n,e,a]},{key:"XMAX_YMIN_ZMAX",pos:[n,e,s]},{key:"XMAX_YMAX_ZMIN",pos:[n,o,a]},{key:"XMAX_YMAX_ZMAX",pos:[n,o,s]}];for(const c of r){const l=this.sphereStates.find(d=>d.uid===`corner_${c.key}`);l&&(l.point[0]=c.pos[0],l.point[1]=c.pos[1],l.point[2]=c.pos[2],l.sphereSource.setCenter(...l.point),l.sphereSource.modified())}Object.values(this.edgeLines).forEach(({source:c,key1:l,key2:d})=>{const u=this.sphereStates.find(g=>g.uid===`corner_${l}`),h=this.sphereStates.find(g=>g.uid===`corner_${d}`);if(u&&h){const g=c.getPoints();g.setPoint(0,u.point[0],u.point[1],u.point[2]),g.setPoint(1,h.point[0],h.point[1],h.point[2]),g.modified(),c.modified()}})}_unsubscribeToViewportNewVolumeSet(t){t.forEach(({viewportId:n,renderingEngineId:e})=>{const{viewport:o}=Gt(n,e),{element:a}=o;a.removeEventListener(ut.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)})}_subscribeToViewportNewVolumeSet(t){t.forEach(({viewportId:n,renderingEngineId:e})=>{const{viewport:o}=Gt(n,e),{element:a}=o;a.addEventListener(ut.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)})}}By.toolName="VolumeCropping";function Gy(){return"rgb(0, 200, 0)"}function Wy(){return!0}const Tc={DRAG:1};class $y extends zt{constructor(t={},n={supportedInteractionTypes:["Mouse"],configuration:{viewportIndicators:!1,viewportIndicatorsConfig:{radius:5,x:null,y:null},extendReferenceLines:!0,initialCropFactor:.2,mobile:{enabled:!1,opacity:.8},lineColors:{AXIAL:[1,0,0],CORONAL:[0,1,0],SAGITTAL:[1,1,0],UNKNOWN:[0,0,1]},lineWidth:1.5,lineWidthActive:2.5}}){super(t,n),this._virtualAnnotations=[],this.sphereStates=[],this.draggingSphereIndex=null,this.toolCenter=[0,0,0],this.toolCenterMin=[0,0,0],this.toolCenterMax=[0,0,0],this.initializeViewport=({renderingEngineId:o,viewportId:a})=>{if(!o||!a){console.warn("VolumeCroppingControlTool: Missing renderingEngineId or viewportId");return}const s=Gt(a,o);if(!s)return;const{viewport:r}=s;this._updateToolCentersFromViewport(r);const{element:c}=r,{position:l,focalPoint:d,viewPlaneNormal:u}=r.getCamera();let h=this._getAnnotations(s);h=this.filterInteractableAnnotationsForElement(c,h),h?.length&&ft(h[0].annotationUID);const g=this._getOrientationFromNormal(r.getCamera().viewPlaneNormal),f={highlighted:!1,metadata:{cameraPosition:[...l],cameraFocalPoint:[...d],toolName:this.getToolName()},data:{handles:{toolCenter:this.toolCenter,toolCenterMin:this.toolCenterMin,toolCenterMax:this.toolCenterMax},activeOperation:null,activeViewportIds:[],viewportId:a,referenceLines:[],orientation:g}};return mt(f,c),{normal:u,point:r.canvasToWorld([100,100])}},this._getViewportsInfo=()=>_e(this.toolGroupId).viewportsInfo,this.resetCroppingSpheres=()=>{const o=this._getViewportsInfo();for(const a of o){const{viewportId:s,renderingEngineId:r}=a,c=Gt(s,r),l=c.viewport;l.resetCamera({resetPan:!0,resetZoom:!0,resetToCenter:!0,resetRotation:!0,suppressEvents:!0}),l.resetSlabThickness();const{element:m}=l;let v=this._getAnnotations(c);v=this.filterInteractableAnnotationsForElement(m,v),v.length&&ft(v[0].annotationUID),l.render()}this._computeToolCenter(o)},this.computeToolCenter=()=>{this._getViewportsInfo()},this._computeToolCenter=o=>{if(!o||!o[0]){console.warn("  _computeToolCenter : No valid viewportsInfo for computeToolCenter.");return}const a=["AXIAL","CORONAL","SAGITTAL"],s=o.map(u=>{if(u.renderingEngineId){const g=te(u.renderingEngineId).getViewport(u.viewportId);if(g&&g.getCamera){const f=this._getOrientationFromNormal(g.getCamera().viewPlaneNormal);if(f)return f}}return null}).filter(Boolean),r=a.find(u=>!s.includes(u)),c=[],l=[],d=o.filter(u=>{let h=null;if(u.renderingEngineId){const f=te(u.renderingEngineId).getViewport(u.viewportId);f&&f.getCamera&&(h=this._getOrientationFromNormal(f.getCamera().viewPlaneNormal))}return h&&a.includes(h)});if(d.forEach(u=>{const{normal:h,point:g}=this.initializeViewport(u);c.push(h),l.push(g)}),d.length===2&&r){const u=[0,0,0];be(u,c[0],c[1]),Zt(u,u);const h=[(l[0][0]+l[1][0])/2,(l[0][1]+l[1][1])/2,(l[0][2]+l[1][2])/2],f={highlighted:!1,metadata:{cameraPosition:[...h],cameraFocalPoint:[...h],toolName:this.getToolName()},data:{handles:{activeOperation:null,toolCenter:this.toolCenter,toolCenterMin:this.toolCenterMin,toolCenterMax:this.toolCenterMax},activeViewportIds:[],viewportId:r,referenceLines:[],orientation:null},isVirtual:!0,virtualNormal:u};this._virtualAnnotations=[f]}else if(d.length===1){let u=null;const h=d[0];if(h.renderingEngineId){const I=te(h.renderingEngineId).getViewport(h.viewportId);I&&I.getCamera&&(u=this._getOrientationFromNormal(I.getCamera().viewPlaneNormal))}const g=l[0],f={AXIAL:[0,0,1],CORONAL:[0,1,0],SAGITTAL:[1,0,0]},v=a.filter(p=>p!==u).map(p=>{const I=f[p];return{highlighted:!1,metadata:{cameraPosition:[...g],cameraFocalPoint:[...g],toolName:this.getToolName()},data:{handles:{activeOperation:null,toolCenter:this.toolCenter,toolCenterMin:this.toolCenterMin,toolCenterMax:this.toolCenterMax},activeViewportIds:[],viewportId:p,referenceLines:[],orientation:p},isVirtual:!0,virtualNormal:I}});this._virtualAnnotations=v}o&&o.length&&L(o.map(({viewportId:u})=>u))},this.cancel=()=>{console.log("Not implemented yet")},this.isPointNearTool=(o,a,s,r)=>!!this._pointNearTool(o,a,s,6),this.toolSelectedCallback=(o,a,s)=>{const r=o.detail,{element:c}=r;a.highlighted=!0,this._activateModify(c),nt(c),o.preventDefault()},this.onResetCamera=o=>{this.resetCroppingSpheres()},this.mouseMoveCallback=(o,a)=>{if(!a)return;const{element:s,currentPoints:r}=o.detail,c=r.canvas;let l=!1;for(let d=0;d<a.length;d++){const u=a[d];if(se(u.annotationUID))continue;const{data:h,highlighted:g}=u;if(!h.handles)continue;h.handles.activeOperation,h.activeViewportIds&&h.activeViewportIds.length>0&&[...h.activeViewportIds],h.activeViewportIds=[];let f=!1;f=this._pointNearTool(s,u,c,6),(f&&!g||!f&&g)&&(u.highlighted=!g,l=!0)}return l},this.filterInteractableAnnotationsForElement=(o,a)=>{if(!a||!a.length)return[];const s=y(o);let r=null;return s.viewport&&s.viewport.getCamera&&(r=this._getOrientationFromNormal(s.viewport.getCamera().viewPlaneNormal)),a.filter(l=>!!(l.isVirtual||l.data.orientation&&r&&l.data.orientation===r))},this.renderAnnotation=(o,a)=>{function s(x,A,O,R){const N=A[0]-x[0],k=A[1]-x[1],B=R[0]-O[0],V=R[1]-O[1],$=-B*k+N*V;if(Math.abs($)<1e-8)return null;const H=(-k*(x[0]-O[0])+N*(x[1]-O[1]))/$,G=(B*(x[1]-O[1])-V*(x[0]-O[0]))/$;return H>=0&&H<=1&&G>=0&&G<=1?[x[0]+G*N,x[1]+G*k]:null}const r=this._getViewportsInfo();if(!r||r.length===0)return!1;let c=!1;const{viewport:l,renderingEngine:d}=o,{element:u}=l;let h=this._getAnnotations(o);this._virtualAnnotations&&this._virtualAnnotations.length&&(h=h.concat(this._virtualAnnotations));const g=l.getCamera(),m=this.filterInteractableAnnotationsForElement(u,h)[0];if(!m||!m.data)return c;const v=m.annotationUID,{clientWidth:p,clientHeight:I}=l.canvas,C=Math.sqrt(p*p+I*I),E=m.data,S=h,_=l.worldToCanvas(this.toolCenterMin),D=l.worldToCanvas(this.toolCenterMax),b=[],M=[0,0,p,I];S.forEach(x=>{const A=x.data,O="isVirtual"in x&&x.isVirtual===!0;A.handles.toolCenter=this.toolCenter;let R,N,k,B,V,$,H;if(O){const yt=r.filter(Dt=>Dt.viewportId!==A.viewportId);if(yt.length===2){const Dt=d.getViewport(yt[0].viewportId),ue=d.getViewport(yt[1].viewportId),ee=Dt.getCamera().viewPlaneNormal,Kt=ue.getCamera().viewPlaneNormal,ie=W();be(ie,ee,Kt),Zt(ie,ie),N={viewPlaneNormal:ie,position:A.handles.toolCenter,focalPoint:A.handles.toolCenter,viewUp:[0,1,0]},k=l.canvas.clientWidth,B=l.canvas.clientHeight,V=Math.sqrt(k*k+B*B),$=[k*.5,B*.5],H=A.handles.toolCenter,R={id:A.viewportId,canvas:l.canvas,canvasToWorld:()=>A.handles.toolCenter}}else N={viewPlaneNormal:x.virtualNormal??[0,0,1],position:A.handles.toolCenter,focalPoint:A.handles.toolCenter,viewUp:[0,1,0]},k=l.canvas.clientWidth,B=l.canvas.clientHeight,V=Math.sqrt(k*k+B*B),$=[k*.5,B*.5],H=A.handles.toolCenter,R={id:A.viewportId,canvas:l.canvas,canvasToWorld:()=>A.handles.toolCenter}}else R=d.getViewport(A.viewportId),N=R.getCamera(),k=R.canvas.clientWidth,B=R.canvas.clientHeight,V=Math.sqrt(k*k+B*B),$=[k*.5,B*.5],H=R.canvasToWorld($);const G=this._getReferenceLineControllable(R.id),Y=[0,0,0];st.cross(g.viewPlaneNormal,N.viewPlaneNormal,Y),st.normalize(Y),st.multiplyScalar(Y,V);const q=[0,0,0];st.add(H,Y,q);const j=[0,0,0];st.subtract(H,Y,j);const K=l.worldToCanvas(q),it=l.worldToCanvas([H[0]??0,H[1]??0,H[2]??0]),at=et();Ft(at,K,it),yn(at,at);const bt=et();uo(bt,at,C*100);const Bt=G?In(_):In(it),Yt=et(),qt=et();Re(Yt,Bt,bt),Ft(qt,Bt,bt),Wo(Yt,qt,M),b.push([R,Yt,qt,"min"]);const Nt=G?In(D):In(it),Tt=et(),Jt=et();Re(Tt,Nt,bt),Ft(Jt,Nt,bt),Wo(Tt,Jt,M),b.push([R,Tt,Jt,"max"])}),E.referenceLines=b;const P=this._getReferenceLineColor(l.id),T=P!==void 0?P:"rgb(200, 200, 200)";if(b.forEach((x,A)=>{const O=[];for(let j=0;j<b.length;++j){if(j===A)continue;const K=b[j],it=s(x[1],x[2],K[1],K[2]);it&&O.push({with:K[3],point:it})}const R=x[0];let N=null;if(R&&R.id){const j=h.find(K=>K.data.viewportId===R.id);if(j&&j.data.orientation)N=String(j.data.orientation).toUpperCase();else{const K=R.id.toUpperCase();K.includes("AXIAL")?N="AXIAL":K.includes("CORONAL")?N="CORONAL":K.includes("SAGITTAL")&&(N="SAGITTAL")}}const k=this.configuration.lineColors||{},B=k[N]||k.unknown||[1,0,0],V=Array.isArray(B)?`rgb(${B.map(j=>Math.round(j*255)).join(",")})`:B,$=this._getReferenceLineControllable(R.id),H=E.activeViewportIds.find(j=>j===R.id);let G=this.configuration.lineWidth??1.5;E.handles.activeOperation!==null&&E.handles.activeOperation===Tc.DRAG&&H&&(G=this.configuration.activeLineWidth??2.5);const q=`${A}`;if($&&(O.length===2&&Et(a,v,q,O[0].point,O[1].point,{color:V,lineWidth:G}),this.configuration.extendReferenceLines&&O.length===2&&this.configuration.extendReferenceLines&&O.length===2)){const j=O.map(K=>({...K,distance:jt(x[1],K.point)})).sort((K,it)=>K.distance-it.distance);Et(a,v,q+"_dashed_before",x[1],j[0].point,{color:V,lineWidth:G,lineDash:[4,4]}),Et(a,v,q+"_dashed_after",j[1].point,x[2],{color:V,lineWidth:G,lineDash:[4,4]})}}),c=!0,this.configuration.viewportIndicators){const{viewportIndicatorsConfig:x}=this.configuration,A=x?.xOffset||.95,O=x?.yOffset||.05,R=[p*A,I*O],N=x?.circleRadius||C*.01;Ae(a,v,"0",R,N,{color:T,fill:T})}return c},this._getAnnotations=o=>{const{viewport:a}=o,s=Ct(this.getToolName(),a.element)||[],r=this._getViewportsInfo().map(({viewportId:l})=>l);return s.filter(l=>{const{data:d}=l;return r.includes(d.viewportId)})},this._onSphereMoved=o=>{if(o.detail.originalClippingPlanes)this._syncWithVolumeCroppingTool(o.detail.originalClippingPlanes);else{if(o.detail.seriesInstanceUID!==this.seriesInstanceUID)return;const{draggingSphereIndex:a,toolCenter:s}=o.detail,r=[...this.toolCenterMin],c=[...this.toolCenterMax];if(a>=0&&a<=5){const l=Math.floor(a/2),d=a%2===0;(d?r:c)[l]=s[l],this.setToolCenter(r,"min"),this.setToolCenter(c,"max");return}if(a>=6&&a<=13){const l=a;l<10?r[0]=s[0]:c[0]=s[0],[6,7,10,11].includes(l)?r[1]=s[1]:c[1]=s[1],l%2===0?r[2]=s[2]:c[2]=s[2],this.setToolCenter(r,"min"),this.setToolCenter(c,"max")}}},this._onNewVolume=()=>{const o=this._getViewportsInfo();if(o&&o.length>0){const{viewportId:a,renderingEngineId:s}=o[0],c=te(s).getViewport(a),l=c.getActors();if(l.length>0){const d=l[0].actor.getMapper().getInputData();d&&(this.seriesInstanceUID=d.seriesInstanceUID,this._updateToolCentersFromViewport(c),(Ct(this.getToolName(),a)||[]).forEach(h=>{h.data&&h.data.handles&&(h.data.handles.toolCenter=[...this.toolCenter])}))}}this._computeToolCenter(o),gt(z,w.VOLUMECROPPINGCONTROL_TOOL_CHANGED,{toolGroupId:this.toolGroupId,viewportsInfo:o,seriesInstanceUID:this.seriesInstanceUID})},this._getAnnotationsForViewportsWithDifferentCameras=(o,a)=>{const{viewportId:s,renderingEngine:r,viewport:c}=o,l=a.filter(f=>f.data.viewportId!==s);if(!l||!l.length)return[];const d=c.getCamera(),{viewPlaneNormal:u,position:h}=d;return l.filter(f=>{const{viewportId:m}=f.data,p=r.getViewport(m).getCamera();return!(Pt(p.viewPlaneNormal,u,.01)&&Pt(p.position,h,1))})},this._filterViewportWithSameOrientation=(o,a,s)=>{const{renderingEngine:r}=o,{data:c}=a,l=r.getViewport(c.viewportId),d=s.filter(f=>{const{data:m}=f,v=r.getViewport(m.viewportId);return this._getReferenceLineControllable(v.id)===!0});if(!d||!d.length)return[];const u=l.getCamera(),h=u.viewPlaneNormal;return st.normalize(h),d.filter(f=>{const{viewportId:m}=f.data,p=r.getViewport(m).getCamera(),I=p.viewPlaneNormal;return st.normalize(I),Pt(h,I,.01)&&Pt(u.viewUp,p.viewUp,.01)})},this._activateModify=o=>{U.isInteractingWithTool=!this.configuration.mobile?.enabled,o.addEventListener(w.MOUSE_UP,this._endCallback),o.addEventListener(w.MOUSE_DRAG,this._dragCallback),o.addEventListener(w.MOUSE_CLICK,this._endCallback),o.addEventListener(w.TOUCH_END,this._endCallback),o.addEventListener(w.TOUCH_DRAG,this._dragCallback),o.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateModify=o=>{U.isInteractingWithTool=!1,o.removeEventListener(w.MOUSE_UP,this._endCallback),o.removeEventListener(w.MOUSE_DRAG,this._dragCallback),o.removeEventListener(w.MOUSE_CLICK,this._endCallback),o.removeEventListener(w.TOUCH_END,this._endCallback),o.removeEventListener(w.TOUCH_DRAG,this._dragCallback),o.removeEventListener(w.TOUCH_TAP,this._endCallback)},this._endCallback=o=>{const a=o.detail,{element:s}=a;this.editData.annotation.data.handles.activeOperation=null,this.editData.annotation.data.activeViewportIds=[],this._deactivateModify(s),ht(s),this.editData=null;const c=Q(s,this.getToolName(),!1);L(c)},this._dragCallback=o=>{const a=o.detail,s=a.deltaPoints.world;if(Math.abs(s[0])<.001&&Math.abs(s[1])<.001&&Math.abs(s[2])<.001)return;const{element:r}=a,c=y(r),{viewport:l}=c;if(l.type===Rl.VOLUME_3D)return;const d=this._getAnnotations(c),h=this.filterInteractableAnnotationsForElement(r,d)[0];if(!h)return;const{handles:g}=h.data;if(g.activeOperation===Tc.DRAG){g.activeType==="min"?(this.toolCenterMin[0]+=s[0],this.toolCenterMin[1]+=s[1],this.toolCenterMin[2]+=s[2]):g.activeType==="max"?(this.toolCenterMax[0]+=s[0],this.toolCenterMax[1]+=s[1],this.toolCenterMax[2]+=s[2]):(this.toolCenter[0]+=s[0],this.toolCenter[1]+=s[1],this.toolCenter[2]+=s[2]);const f=this._getViewportsInfo();L(f.map(({viewportId:m})=>m)),gt(z,w.VOLUMECROPPINGCONTROL_TOOL_CHANGED,{toolGroupId:this.toolGroupId,toolCenter:this.toolCenter,toolCenterMin:this.toolCenterMin,toolCenterMax:this.toolCenterMax,handleType:g.activeType,viewportOrientation:[],seriesInstanceUID:this.seriesInstanceUID})}},this._getReferenceLineColor=t.configuration?.getReferenceLineColor||Gy,this._getReferenceLineControllable=t.configuration?.getReferenceLineControllable||Wy;const e=_e(this.toolGroupId)?.viewportsInfo;if(z.addEventListener(w.VOLUMECROPPING_TOOL_CHANGED,this._onSphereMoved),e&&e.length>0){const{viewportId:o,renderingEngineId:a}=e[0];Gt(o,a);const c=te(a).getViewport(o).getActors();if(!c||!c.length){console.warn(`VolumeCroppingControlTool: No volume actors found in viewport ${o}.`);return}const l=c[0].actor.getMapper().getInputData();if(l){const d=l.getDimensions(),u=l.getSpacing(),h=l.getOrigin();this.seriesInstanceUID=l.seriesInstanceUID||"unknown";const g=this.configuration.initialCropFactor??.2;this.toolCenter=[h[0]+g*(d[0]-1)*u[0],h[1]+g*(d[1]-1)*u[1],h[2]+g*(d[2]-1)*u[2]];const f=1-g;this.toolCenterMin=[h[0]+g*(d[0]-1)*u[0],h[1]+g*(d[1]-1)*u[1],h[2]+g*(d[2]-1)*u[2]],this.toolCenterMax=[h[0]+f*(d[0]-1)*u[0],h[1]+f*(d[1]-1)*u[1],h[2]+f*(d[2]-1)*u[2]]}}}_updateToolCentersFromViewport(t){const n=t.getActors();if(!n||!n.length)return;const e=n[0].actor.getMapper().getInputData();if(!e)return;this.seriesInstanceUID=e.seriesInstanceUID||"unknown";const o=e.getDimensions(),a=e.getSpacing(),s=e.getOrigin(),r=this.configuration.initialCropFactor??.2,c=r/2,l=1-r/2;this.toolCenter=[s[0]+(c+l)/2*(o[0]-1)*a[0],s[1]+(c+l)/2*(o[1]-1)*a[1],s[2]+(c+l)/2*(o[2]-1)*a[2]],this.toolCenterMin=[s[0]+c*(o[0]-1)*a[0],s[1]+c*(o[1]-1)*a[1],s[2]+c*(o[2]-1)*a[2]],this.toolCenterMax=[s[0]+l*(o[0]-1)*a[0],s[1]+l*(o[1]-1)*a[1],s[2]+l*(o[2]-1)*a[2]]}onSetToolInactive(){console.debug(`VolumeCroppingControlTool: onSetToolInactive called for tool ${this.getToolName()}`)}onSetToolActive(){const t=this._getViewportsInfo();let n=!1;for(const e of t){const o=Gt(e.viewportId,e.renderingEngineId),a=this._getAnnotations(o);if(a&&a.length>0){n=!0;break}}if(!n)this._unsubscribeToViewportNewVolumeSet(t),this._subscribeToViewportNewVolumeSet(t),this._computeToolCenter(t),gt(z,w.VOLUMECROPPINGCONTROL_TOOL_CHANGED,{toolGroupId:this.toolGroupId,viewportsInfo:t,seriesInstanceUID:this.seriesInstanceUID});else for(const e of t){const o=Gt(e.viewportId,e.renderingEngineId);if(!o)continue;const a=this._getAnnotations(o);a&&a.length>0&&a.forEach(s=>{ft(s.annotationUID)}),o.viewport.render()}}onSetToolEnabled(){console.debug(`VolumeCroppingControlTool: onSetToolEnabled called for tool ${this.getToolName()}`),this._getViewportsInfo()}onSetToolDisabled(){console.debug(`VolumeCroppingControlTool: onSetToolDisabled called for tool ${this.getToolName()}`);const t=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(t),t.forEach(({renderingEngineId:n,viewportId:e})=>{const o=Gt(e,n);if(!o)return;const a=this._getAnnotations(o);a?.length&&a.forEach(s=>{ft(s.annotationUID)})})}_getOrientationFromNormal(t){if(!t)return null;const n={AXIAL:[0,0,1],CORONAL:[0,1,0],SAGITTAL:[1,0,0]},e=.01;for(const[o,a]of Object.entries(n))if(Math.abs(t[0]-a[0])<e&&Math.abs(t[1]-a[1])<e&&Math.abs(t[2]-a[2])<e||Math.abs(t[0]+a[0])<e&&Math.abs(t[1]+a[1])<e&&Math.abs(t[2]+a[2])<e)return o;return null}_syncWithVolumeCroppingTool(t){const n=t;if(n.length>=6){this.toolCenterMin=[n[0].origin[0],n[2].origin[1],n[4].origin[2]],this.toolCenterMax=[n[1].origin[0],n[3].origin[1],n[5].origin[2]],this.toolCenter=[(this.toolCenterMin[0]+this.toolCenterMax[0])/2,(this.toolCenterMin[1]+this.toolCenterMax[1])/2,(this.toolCenterMin[2]+this.toolCenterMax[2])/2];const e=this._getViewportsInfo();e.forEach(({viewportId:o,renderingEngineId:a})=>{const s=Gt(o,a);s&&this._getAnnotations(s).forEach(c=>{if(c.data&&c.data.handles&&c.data.orientation){const l=c.data.orientation;l==="AXIAL"?(c.data.handles.toolCenterMin=[n[0].origin[0],n[2].origin[1],c.data.handles.toolCenterMin[2]],c.data.handles.toolCenterMax=[n[1].origin[0],n[3].origin[1],c.data.handles.toolCenterMax[2]]):l==="CORONAL"?(c.data.handles.toolCenterMin=[n[0].origin[0],c.data.handles.toolCenterMin[1],n[4].origin[2]],c.data.handles.toolCenterMax=[n[1].origin[0],c.data.handles.toolCenterMax[1],n[5].origin[2]]):l==="SAGITTAL"&&(c.data.handles.toolCenterMin=[c.data.handles.toolCenterMin[0],n[2].origin[1],n[4].origin[2]],c.data.handles.toolCenterMax=[c.data.handles.toolCenterMax[0],n[3].origin[1],n[5].origin[2]]),c.data.handles.toolCenter=[(c.data.handles.toolCenterMin[0]+c.data.handles.toolCenterMax[0])/2,(c.data.handles.toolCenterMin[1]+c.data.handles.toolCenterMax[1])/2,(c.data.handles.toolCenterMin[2]+c.data.handles.toolCenterMax[2])/2]}})}),this._virtualAnnotations&&this._virtualAnnotations.length>0&&this._virtualAnnotations.forEach(o=>{if(o.data&&o.data.handles&&o.data.orientation){const a=o.data.orientation.toUpperCase();a==="AXIAL"?(o.data.handles.toolCenterMin=[n[0].origin[0],n[2].origin[1],o.data.handles.toolCenterMin[2]],o.data.handles.toolCenterMax=[n[1].origin[0],n[3].origin[1],o.data.handles.toolCenterMax[2]]):a==="CORONAL"?(o.data.handles.toolCenterMin=[n[0].origin[0],o.data.handles.toolCenterMin[1],n[4].origin[2]],o.data.handles.toolCenterMax=[n[1].origin[0],o.data.handles.toolCenterMax[1],n[5].origin[2]]):a==="SAGITTAL"&&(o.data.handles.toolCenterMin=[o.data.handles.toolCenterMin[0],n[2].origin[1],n[4].origin[2]],o.data.handles.toolCenterMax=[o.data.handles.toolCenterMax[0],n[3].origin[1],n[5].origin[2]]),o.data.handles.toolCenter=[(o.data.handles.toolCenterMin[0]+o.data.handles.toolCenterMax[0])/2,(o.data.handles.toolCenterMin[1]+o.data.handles.toolCenterMax[1])/2,(o.data.handles.toolCenterMin[2]+o.data.handles.toolCenterMax[2])/2]}}),L(e.map(({viewportId:o})=>o))}}setToolCenter(t,n){n==="min"?this.toolCenterMin=[...t]:n==="max"&&(this.toolCenterMax=[...t]);const e=this._getViewportsInfo();L(e.map(({viewportId:o})=>o))}addNewAnnotation(t){const n=t.detail,{element:e}=n,o=y(e),{viewport:a}=o,s=this._getAnnotations(o),r=this.filterInteractableAnnotationsForElement(a.element,s);if(!r||r.length===0||!r[0])return null;const{data:c}=r[0],l=[],d=c.referenceLines||[];for(let u=0;u<d.length;++u){const h=d[u][0];this._getReferenceLineControllable(h.id)&&(l.push(h.id),u++)}return c.activeViewportIds=[...l],c.handles.activeOperation=Tc.DRAG,t.preventDefault(),nt(e),this._activateModify(e),r[0]}handleSelectedCallback(t,n,e,o){this.toolSelectedCallback(t,n,o)}_unsubscribeToViewportNewVolumeSet(t){t.forEach(({viewportId:n,renderingEngineId:e})=>{const{viewport:o}=Gt(n,e),{element:a}=o;a.removeEventListener(ut.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)})}_subscribeToViewportNewVolumeSet(t){t.forEach(({viewportId:n,renderingEngineId:e})=>{const{viewport:o}=Gt(n,e),{element:a}=o;a.addEventListener(ut.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)})}_applyDeltaShiftToSelectedViewportCameras(t,n,e){n.forEach(o=>{this._applyDeltaShiftToViewportCamera(t,o,e)})}_applyDeltaShiftToViewportCamera(t,n,e){const{data:o}=n,a=t.getViewport(o.viewportId),s=a.getCamera(),r=s.viewPlaneNormal,c=st.dot(e,r),l=[...r];if(st.multiplyScalar(l,c),Math.abs(l[0])>.001||Math.abs(l[1])>.001||Math.abs(l[2])>.001){const d=[0,0,0],u=[0,0,0];st.add(s.focalPoint,l,d),st.add(s.position,l,u),a.setCamera({focalPoint:d,position:u}),a.render()}}_pointNearTool(t,n,e,o){const{data:a}=n,s=a.referenceLines,r=[];if(s)for(let c=0;c<s.length;++c){const l=s[c][0],d=s[c][1],u=s[c][2],h=s[c][3];fe(d,u,[e[0],e[1]])<=o&&(r.push(l.id),a.handles.activeOperation=1,a.handles.activeType=h)}return a.activeViewportIds=[...r],this.editData={annotation:n},a.handles.activeOperation===1}}$y.toolName="VolumeCroppingControl";const Pc=4,Wh=1024,Hy="PT";class zy extends de{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"]}){super(t,n),this._getImageDynamicRangeFromMiddleSlice=(e,o)=>{const a=Math.floor(o[2]/2),s=o[0]*o[1];let r,c;e instanceof Float32Array?(r=4,c=Float32Array):e instanceof Uint8Array?(r=1,c=Uint8Array):e instanceof Uint16Array?(r=2,c=Uint16Array):e instanceof Int16Array&&(r=2,c=Int16Array);const l=e.buffer,d=a*s*r,u=new c(l,d,s),{max:h,min:g}=this._getMinMax(u,s);return h-g}}touchDragCallback(t){this.mouseDragCallback(t)}mouseDragCallback(t){const{element:n,deltaPoints:e}=t.detail,o=y(n),{viewport:a}=o;let s,r,c,l,d,u,h=!1;const g=a.getProperties();if(a instanceof ae){s=a.getVolumeId(),u=Ml(s),{lower:r,upper:c}=g.voiRange;const f=X.getVolume(s);if(!f)throw new Error("Volume not found "+s);l=f.metadata.Modality,h=f.scaling&&Object.keys(f.scaling).length>0}else if(g.voiRange){l=a.modality,{lower:r,upper:c}=g.voiRange;const{preScale:f={scaled:!1}}=a.getImageData?.()||{};h=f.scaled&&f.scalingParameters?.suvbw!==void 0}else throw new Error("Viewport is not a valid type");if(l===Hy&&h?d=this.getPTScaledNewRange({deltaPointsCanvas:e.canvas,lower:r,upper:c,clientHeight:n.clientHeight,isPreScaled:h,viewport:a,volumeId:s}):d=this.getNewRange({viewport:a,deltaPointsCanvas:e.canvas,volumeId:s,lower:r,upper:c}),!(d.lower>=d.upper)&&(a.setProperties({voiRange:d}),a.render(),a instanceof ae)){u.forEach(f=>{a!==f&&f.render()});return}}getPTScaledNewRange({deltaPointsCanvas:t,lower:n,upper:e,clientHeight:o,viewport:a,volumeId:s,isPreScaled:r}){let c=Pc;r?c=5/o:c=this._getMultiplierFromDynamicRange(a,s)||Pc;const d=t[1]*c;return e-=d,e=r?Math.max(e,.1):e,{lower:n,upper:e}}getNewRange({viewport:t,deltaPointsCanvas:n,volumeId:e,lower:o,upper:a}){const s=this._getMultiplierFromDynamicRange(t,e)||Pc,r=n[0]*s,c=n[1]*s;let{windowWidth:l,windowCenter:d}=Ug(o,a);l+=r,d+=c,l=Math.max(l,1);const u=t.getProperties().VOILUTFunction;return Ll(l,d,u)}_getMultiplierFromDynamicRange(t,n){let e;if(n){const a=X.getVolume(n),{voxelManager:s}=t.getImageData(),c=s.getMiddleSliceData().reduce((h,g)=>[Math.min(h[0],g),Math.max(h[1],g)],[1/0,-1/0]),l=a?.metadata?.BitsStored,d=l?2**l:1/0,u=c[1]-c[0];e=Number.isFinite(u)?Math.min(u,d):d}else e=this._getImageDynamicRangeFromViewport(t);const o=e/Wh;return Number.isFinite(o)?o>1?Math.round(o):o:Wh}_getImageDynamicRangeFromViewport(t){const{imageData:n,voxelManager:e}=t.getImageData();if(e?.getRange){const r=e.getRange();return r[1]-r[0]}const o=n.getDimensions();if(n.getRange){const r=n.getRange();return r[1]-r[0]}let a;if(n.getScalarData?a=n.getScalarData():a=n.getPointData().getScalars().getData(),o[2]!==1)return this._getImageDynamicRangeFromMiddleSlice(a,o);let s;if(a.getRange)s=a.getRange();else{const{min:r,max:c}=this._getMinMax(a,a.length);s=[r,c]}return s[1]-s[0]}_getMinMax(t,n){let e=1/0,o=-1/0;for(let a=0;a<n;a++){const s=t[a];s<e&&(e=s),s>o&&(o=s)}return{max:o,min:e}}}zy.toolName="WindowLevel";class jy extends zt{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{minWindowWidth:10}}){super(t,n),this.addNewAnnotation=e=>{const o=e.detail,{currentPoints:a,element:s}=o,r=a.world,c=y(s),{viewport:l}=c;this.isDrawing=!0;const d=l.getCamera(),{viewPlaneNormal:u,viewUp:h}=d,g=this.getReferencedImageId(l,r,u,h),f=l.getFrameOfReferenceUID(),m={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...u],viewUp:[...h],FrameOfReferenceUID:f,referencedImageId:g},data:{handles:{points:[[...r],[...r],[...r],[...r]]},cachedStats:{}}};mt(m,s);const v=Q(s,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:v},this._activateDraw(s),nt(s),e.preventDefault(),L(v),m},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r}=this.editData;this._deactivateDraw(a),ht(a),this.editData=null,this.isDrawing=!1,ft(s.annotationUID),L(r),Lt(s),this.applyWindowLevelRegion(s,a)},this._dragCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r}=this.editData,{data:c}=s,{currentPoints:l}=o,d=y(a),{worldToCanvas:u,canvasToWorld:h}=d.viewport,g=l.world,{points:f}=c.handles,m=3;f[m]=[...g];const v=u(f[0]),p=u(f[3]),I=[p[0],v[1]],C=[v[0],p[1]],E=h(I),S=h(C);f[1]=E,f[2]=S,s.invalidated=!0,L(r)},this._activateDraw=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_MOVE,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_MOVE,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e,{element:r}=s;let c=Ct(this.getToolName(),r);if(!c?.length||(c=this.filterInteractableAnnotationsForElement(r,c),!c?.length))return a;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let d=0;d<c.length;d++){const u=c[d],{annotationUID:h,data:g}=u,{points:f}=g.handles,m=f.map(S=>s.worldToCanvas(S));l.annotationUID=h;const{color:v,lineWidth:p,lineDash:I}=this.getAnnotationStyle({annotation:u,styleSpecifier:l});if(!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;const C=`${h}-rect`;is(o,h,"0",m[0],m[3],{color:v,lineDash:I,lineWidth:p},C),a=!0}return a},this.applyWindowLevelRegion=(e,o)=>{const a=y(o),{viewport:s}=a,r=uI(s),{data:c}=e,{points:l}=c.handles,d=l.map(D=>s.worldToCanvas(D)),u=d[0],h=d[3];let g=Math.min(u[0],h[0]),f=Math.min(u[1],h[1]),m=Math.abs(u[0]-h[0]),v=Math.abs(u[1]-h[1]);g=pu(g,0,r.width),f=pu(f,0,r.height),m=Math.floor(Math.min(m,Math.abs(r.width-g))),v=Math.floor(Math.min(v,Math.abs(r.height-f)));const p=lI(r,Math.round(g),Math.round(f),m,v),I=dI(p,r.minPixelValue,r.maxPixelValue);this.configuration.minWindowWidth===void 0&&(this.configuration.minWindowWidth=10);const C=Math.max(Math.abs(I.max-I.min),this.configuration.minWindowWidth),E=I.mean,S=s.getProperties().VOILUTFunction,_=Ll(C,E,S);s.setProperties({voiRange:_}),s.render()},this.cancel=()=>null,this.isPointNearTool=()=>null,this.toolSelectedCallback=()=>null,this.handleSelectedCallback=()=>null,this._activateModify=()=>null,this._deactivateModify=()=>null}}jy.toolName="WindowLevelRegion";class Xy extends de{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1}}){super(t,n),this.deltaY=1}mouseWheelCallback(t){this._scroll(t)}mouseDragCallback(t){this._dragCallback(t)}touchDragCallback(t){this._dragCallback(t)}_dragCallback(t){this._scrollDrag(t)}_scrollDrag(t){const{deltaPoints:n,viewportId:e,renderingEngineId:o}=t.detail,{viewport:a}=Gt(e,o),{debounceIfNotLoaded:s,invert:r,loop:c}=this.configuration,l=n.canvas[1];let d;a instanceof ae&&(d=a.getVolumeId());const u=this._getPixelPerImage(a),h=l+this.deltaY;if(u)if(Math.abs(h)>=u){const g=Math.round(h/u);ya(a,{delta:r?-g:g,volumeId:d,debounceLoading:s,loop:c}),this.deltaY=h%u}else this.deltaY=h}_scroll(t){const{wheel:n,element:e}=t.detail,{direction:o}=n,{invert:a}=this.configuration,{viewport:s}=y(e),r=o*(a?-1:1);ya(s,{delta:r,debounceLoading:this.configuration.debounceIfNotLoaded,loop:this.configuration.loop,volumeId:s instanceof ve?s.getVolumeId():void 0,scrollSlabs:this.configuration.scrollSlabs})}_getPixelPerImage(t){const{element:n}=t,e=t.getNumberOfSlices();return Math.max(2,n.offsetHeight/Math.max(e,8))}}Xy.toolName="StackScroll";class Yy extends de{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"]}){super(t,n),this.mouseWheelCallback=e=>{const{element:o,wheel:a}=e.detail,s=y(o),{viewport:r}=s,{invert:c}=this.configuration,l=a.direction*10*(c?-1:1);this.setAngle(r,l)},this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(t){const{element:n,currentPoints:e,startPoints:o}=t.detail,a=e.world,s=o.world,r=y(n),{viewport:c}=r,l=c.getCamera(),d=n.clientWidth,u=n.clientHeight,h=[d*.5,u*.5],g=c.canvasToWorld(h);let f=Ti([s,g],[g,a]);const{viewPlaneNormal:m}=l,v=me(W(),g,s),p=me(W(),g,a),I=be(W(),v,p);dt(m,I)>0&&(f=-f),!Number.isNaN(f)&&this.setAngle(c,f)}setAngle(t,n){const{viewPlaneNormal:e,viewUp:o}=t.getCamera();if(t instanceof ve){const a=(n+360)%360*Math.PI/180,s=So(new Float32Array(16));Yo(s,s,a,e);const r=Se(W(),o,s);t.setCamera({viewUp:r})}else{const{rotation:a}=t.getViewPresentation();t.setViewPresentation({rotation:(a+n+360)%360})}t.render()}}Yy.toolName="PlanarRotate";class qy extends de{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{zoomToCenter:!1,minZoomScale:.001,maxZoomScale:3e3,pinchToZoom:!0,pan:!0,invert:!1}}){super(t,n),this.preMouseDownCallback=e=>{const o=e.detail,{element:a,currentPoints:s}=o,r=s.world,l=y(a).viewport.getCamera(),{focalPoint:d}=l;this.initialMousePosWorld=r;let u=wt(d[0]-r[0],d[1]-r[1],d[2]-r[2]);return u=Zt(W(),u),this.dirVec=u,!1},this.preTouchStartCallback=e=>{if(!this.configuration.pinchToZoom)return this.preMouseDownCallback(e)},this._dragParallelProjection=(e,o,a,s=!1)=>{const{element:r,deltaPoints:c}=e.detail,l=s?e.detail.deltaDistance.canvas:c.canvas[1],d=[r.clientWidth,r.clientHeight],{parallelScale:u,focalPoint:h,position:g}=a,f=5/d[1],m=l*f*(this.configuration.invert?-1:1),v=(1-m)*u;let p=h,I=g;if(!this.configuration.zoomToCenter){const D=Te(h,this.initialMousePosWorld);I=Wt(W(),g,this.dirVec,-D*m),p=Wt(W(),h,this.dirVec,-D*m)}const C=o.getImageData();let E=[1,1,1],S=v,_=!1;if(C){E=C.spacing;const{dimensions:D}=C,b=D[0]*E[0],M=D[1]*E[1],P=d[0]/d[1],T=D0().rendering?.useLegacyCameraFOV?1.1:1,x=o.options?.displayArea,A=x?.imageArea?.[0]??T,O=x?.imageArea?.[1]??T,R=b*A,N=M*O,k=R/N;let B;k>P?B=R/P*.5:B=N*.5;const{minZoomScale:V,maxZoomScale:$}=this.configuration,H=B/$,G=B/V;v<H?(S=H,_=!0):v>G&&(S=G,_=!0)}o.setCamera({parallelScale:S,focalPoint:_?h:p,position:_?g:I})},this._dragPerspectiveProjection=(e,o,a,s=!1)=>{const{element:r,deltaPoints:c}=e.detail,l=s?e.detail.deltaDistance.canvas:c.canvas[1],d=[r.clientWidth,r.clientHeight],{position:u,focalPoint:h,viewPlaneNormal:g}=a,f=st.distance2BetweenPoints(u,h),m=Math.sqrt(f)/d[1],v=[-g[0],-g[1],-g[2]],p=this.configuration.invert?l/m:l*m;let I=p*v[0];u[0]+=I,h[0]+=I,I=p*v[1],u[1]+=I,h[1]+=I,I=p*v[2],u[2]+=I,h[2]+=I,o.setCamera({position:u,focalPoint:h})},this.initialMousePosWorld=[0,0,0],this.dirVec=[0,0,0],this.configuration.pinchToZoom?this.touchDragCallback=this._pinchCallback.bind(this):this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}mouseWheelCallback(t){this._zoom(t)}_pinchCallback(t){if(t.detail.currentPointsList.length>1){const{element:e,currentPoints:o}=t.detail,a=y(e),{viewport:s}=a,r=s.getCamera(),c=o.world,{focalPoint:l}=r;this.initialMousePosWorld=c;let d=wt(l[0]-c[0],l[1]-c[1],l[2]-c[2]);d=Zt(W(),d),this.dirVec=d,r.parallelProjection?this._dragParallelProjection(t,s,r,!0):this._dragPerspectiveProjection(t,s,r,!0),s.render()}this.configuration.pan&&this._panCallback(t)}_dragCallback(t){const{element:n}=t.detail,e=y(n),{viewport:o}=e,a=o.getCamera();a.parallelProjection?this._dragParallelProjection(t,o,a):this._dragPerspectiveProjection(t,o,a),o.render()}_zoom(t){const{element:n,points:e}=t.detail,o=y(n),{viewport:a}=o;a.getCamera();const r=t.detail.wheel.direction,c={detail:{element:n,eventName:w.MOUSE_WHEEL,renderingEngineId:o.renderingEngineId,viewportId:a.id,camera:{},deltaPoints:{page:e.page,client:e.client,world:e.world,canvas:[0,-r*5]},startPoints:e,lastPoints:e,currentPoints:e}};a.type===Rl.STACK&&this.preMouseDownCallback(c),this._dragCallback(c)}_panCallback(t){const{element:n,deltaPoints:e}=t.detail,o=y(n),a=e.world,s=o.viewport.getCamera(),{focalPoint:r,position:c}=s,l=[c[0]-a[0],c[1]-a[1],c[2]-a[2]],d=[r[0]-a[0],r[1]-a[1],r[2]-a[2]];o.viewport.setCamera({focalPoint:d,position:l}),o.viewport.render()}}qy.toolName="Zoom";class Ky extends de{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{targetViewportIds:[]}}){super(t,n)}mouseClickCallback(t){const{element:n,currentPoints:e}=t.detail,o=y(n),{viewport:a,renderingEngine:s}=o,r=a.getVolumeId();if(!r)throw new Error("MIPJumpToClickTool: targetId is not a volumeId, you should only use MIPJumpToClickTool with a volumeId as the targetId");let c=-1/0;const l=(f,m)=>{if(f>c)return c=f,m},d=Ed(a,e.world,r,l);if(!d||!d.length)return;const{targetViewportIds:u,toolGroupId:h}=this.configuration;s.getViewports().filter(f=>{if(u?.indexOf(f.id)>=0)return!0;const m=ne(f.id,s.id);return!!(h&&h===m?.id)}).forEach(f=>{f instanceof ae?f.jumpToWorld(d):console.warn("Cannot jump to specified world coordinates for a viewport that is not a VolumeViewport")})}}Ky.toolName="MIPJumpToClickTool";const{RENDERING_DEFAULTS:Mc}=Qo;function Zy(){return"rgb(0, 200, 0)"}function Jy(){return!0}function Qy(){return!0}function tA(){return!0}const mn={DRAG:1,ROTATE:2,SLAB:3};class eA extends zt{constructor(t={},n={supportedInteractionTypes:["Mouse"],configuration:{shadow:!0,viewportIndicators:!1,viewportIndicatorsConfig:{radius:5,x:null,y:null},autoPan:{enabled:!1,panSize:10},handleRadius:3,enableHDPIHandles:!1,referenceLinesCenterGapRadius:20,referenceLinesCenterGapRatio:null,filterActorUIDsToSetSlabThickness:[],slabThicknessBlendMode:$o.MAXIMUM_INTENSITY_BLEND,centerPoint:{enabled:!1,color:"rgba(255, 255, 0, 0.5)",size:2},mobile:{enabled:!1,opacity:.8,handleRadius:9,referenceLinesCenterGapRatio:.05}}}){super(t,n),this.toolCenter=[0,0,0],this.initializeViewport=({renderingEngineId:e,viewportId:o})=>{const a=Gt(o,e);if(!a)return;const{FrameOfReferenceUID:s,viewport:r}=a,{element:c}=r,{position:l,focalPoint:d,viewPlaneNormal:u}=r.getCamera();let h=this._getAnnotations(a);h=this.filterInteractableAnnotationsForElement(c,h),h?.length&&ft(h[0].annotationUID);const g={highlighted:!1,metadata:{cameraPosition:[...l],cameraFocalPoint:[...d],FrameOfReferenceUID:s,toolName:this.getToolName()},data:{handles:{rotationPoints:[],slabThicknessPoints:[],toolCenter:this.toolCenter},activeOperation:null,activeViewportIds:[],viewportId:o}};return mt(g,c),{normal:u,point:r.canvasToWorld([r.canvas.clientWidth/2,r.canvas.clientHeight/2])}},this._getViewportsInfo=()=>_e(this.toolGroupId).viewportsInfo,this.resetCrosshairs=()=>{const e=this._getViewportsInfo();for(const o of e){const{viewportId:a,renderingEngineId:s}=o,r=Gt(a,s),c=r.viewport;c.resetCamera({resetPan:!0,resetZoom:!0,resetToCenter:!0,resetRotation:!0,suppressEvents:!0}),c.resetSlabThickness();const{element:f}=c;let m=this._getAnnotations(r);m=this.filterInteractableAnnotationsForElement(f,m),m.length&&ft(m[0].annotationUID),c.render()}this._computeToolCenter(e)},this.computeToolCenter=()=>{const e=this._getViewportsInfo();this._computeToolCenter(e)},this._computeToolCenter=e=>{if(!e.length||e.length===1){console.warn("For crosshairs to operate, at least two viewports must be given.");return}const[o,a,s]=e,{normal:r,point:c}=this.initializeViewport(o),{normal:l,point:d}=this.initializeViewport(a);let u=[0,0,0],h=W();s?{normal:u,point:h}=this.initializeViewport(s):(je(h,c,d),hn(h,h,.5),be(u,r,l));const g=po(r,c),f=po(l,d),m=po(u,h),v=b0(g,f,m);this.setToolCenter(v)},this.addNewAnnotation=e=>{const o=e.detail,{element:a}=o,{currentPoints:s}=o,r=s.world,c=y(a),{viewport:l}=c;this._jump(c,r);const d=this._getAnnotations(c),u=this.filterInteractableAnnotationsForElement(l.element,d),{data:h}=u[0],{rotationPoints:g}=h.handles,f=[];for(let m=0;m<g.length-1;++m){const v=g[m][1],p=this._getReferenceLineControllable(v.id),I=this._getReferenceLineDraggableRotatable(v.id);!p||!I||(f.push(v.id),m++)}return h.activeViewportIds=[...f],h.handles.activeOperation=mn.DRAG,e.preventDefault(),nt(a),this._activateModify(a),u[0]},this.cancel=()=>{console.log("Not implemented yet")},this.handleSelectedCallback=(e,o)=>{const a=e.detail,{element:s}=a;o.highlighted=!0,this._activateModify(s),nt(s),e.preventDefault()},this.isPointNearTool=(e,o,a,s)=>!!this._pointNearTool(e,o,a,6),this.toolSelectedCallback=(e,o,a)=>{const s=e.detail,{element:r}=s;o.highlighted=!0,this._activateModify(r),nt(r),e.preventDefault()},this.onCameraModified=e=>{const o=e.detail,{element:a}=o,s=y(a),{renderingEngine:r}=s,c=s.viewport,l=this._getAnnotations(s),u=this.filterInteractableAnnotationsForElement(a,l)[0];if(!u)return;const h=c.getCamera(),g=u.metadata.cameraPosition,f=[0,0,0];st.subtract(h.position,g,f);const m=u.metadata.cameraFocalPoint,v=[0,0,0];st.subtract(h.focalPoint,m,v),u.metadata.cameraPosition=[...h.position],u.metadata.cameraFocalPoint=[...h.focalPoint];const p=this._getReferenceLineControllable(c.id),I=this._getReferenceLineDraggableRotatable(c.id);if(!Pt(h.position,g,.001)&&p&&I){let S=!1;Pt(f,v,.001)||(S=!0);const D=Math.abs(st.dot(f,h.viewPlaneNormal))<.01;!S&&!D&&(this.toolCenter[0]+=f[0],this.toolCenter[1]+=f[1],this.toolCenter[2]+=f[2],gt(z,w.CROSSHAIR_TOOL_CENTER_CHANGED,{toolGroupId:this.toolGroupId,toolCenter:this.toolCenter}))}this.configuration.autoPan?.enabled&&ne(c.id,r.id).getViewportIds().filter(D=>D!==c.id).forEach(D=>{this._autoPanViewportIfNecessary(D,r)});const E=Q(a,this.getToolName(),!1);L(E)},this.onResetCamera=e=>{this.resetCrosshairs()},this.mouseMoveCallback=(e,o)=>{const{element:a,currentPoints:s}=e.detail,r=s.canvas;let c=!1;for(let l=0;l<o.length;l++){const d=o[l];if(se(d.annotationUID))continue;const{data:u,highlighted:h}=d;if(!u.handles)continue;const g=u.handles.activeOperation,f=u.activeViewportIds&&u.activeViewportIds.length>0?[...u.activeViewportIds]:[];u.activeViewportIds=[],u.handles.activeOperation=null;const m=this.getHandleNearImagePoint(a,d,r,6);let v=!1;m?v=!0:v=this._pointNearTool(a,d,r,6),v&&!h||!v&&h?(d.highlighted=!h,c=!0):(u.handles.activeOperation!==g||!this._areViewportIdArraysEqual(u.activeViewportIds,f))&&(c=!0)}return c},this.filterInteractableAnnotationsForElement=(e,o)=>{if(!o||!o.length)return[];const a=y(e),{viewportId:s}=a;return o.filter(c=>c.data.viewportId===s)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s,renderingEngine:r}=e,{element:c}=s,l=this._getAnnotations(e),d=s.getCamera(),h=this.filterInteractableAnnotationsForElement(c,l)[0];if(!l?.length||!h?.data)return a;const g=h.annotationUID,{clientWidth:f,clientHeight:m}=s.canvas,v=Math.sqrt(f*f+m*m),p=Math.min(f,m),I=h.data,C=s.worldToCanvas(this.toolCenter),E=this._filterAnnotationsByUniqueViewportOrientations(e,l),S=[],_=[0,0,f,m];E.forEach(T=>{const{data:x}=T;x.handles.toolCenter=this.toolCenter;const A=r.getViewport(x.viewportId),O=A.getCamera(),R=this._getReferenceLineControllable(A.id),N=this._getReferenceLineDraggableRotatable(A.id),k=this._getReferenceLineSlabThicknessControlsOn(A.id),{clientWidth:B,clientHeight:V}=A.canvas,$=Math.sqrt(B*B+V*V),H=[B*.5,V*.5],G=A.canvasToWorld(H),Y=[0,0,0];st.cross(d.viewPlaneNormal,O.viewPlaneNormal,Y),st.normalize(Y),st.multiplyScalar(Y,$);const q=[0,0,0];st.add(G,Y,q);const j=[0,0,0];st.subtract(G,Y,j);const K=s.worldToCanvas(q),it=s.worldToCanvas(G),at=et();Ft(at,K,it),yn(at,at);const bt=et();uo(bt,at,v*100);const Bt=et();uo(Bt,at,p*.4);const Yt=et();uo(Yt,at,p*.2);const qt=et(),Nt=this.configuration.mobile,{referenceLinesCenterGapRatio:Tt}=Nt?.enabled?Nt:this.configuration,Jt=Tt>0?p*Tt:this.configuration.referenceLinesCenterGapRadius;uo(qt,at,E.length===2?Jt:0);const yt=et(),Dt=et(),ue=et(),ee=et();let Kt=In(C);(!N||!R)&&(Kt=In(it)),Re(yt,Kt,qt),Re(Dt,Kt,bt),Ft(ue,Kt,qt),Ft(ee,Kt,bt),Wo(yt,Dt,_),Wo(ue,ee,_);const ie=et();Ft(ie,C,Bt);const He=et();Re(He,C,Bt);let he=In(C);!N&&k&&(he=In(it));let xo=[...this.toolCenter];!N&&k&&(xo=[...G]);const ea=[0,0,0];st.subtract(q,j,ea),st.normalize(ea);const{viewPlaneNormal:Zr}=d,{matrix:na}=pn.buildFromDegree().rotate(90,Zr),us=[0,0,0];Se(us,ea,na);const hs=A.getSlabThickness(),gs=[...us];st.multiplyScalar(gs,hs);const oa=[0,0,0];st.add(xo,gs,oa);const Jr=s.worldToCanvas(oa),Ke=et();Ft(Ke,he,Jr);const yo=et();Ft(yo,he,bt),Re(yo,yo,Ke);const Ao=et();Re(Ao,he,bt),Re(Ao,Ao,Ke),Wo(yo,Ao,_);const F=et();Re(F,he,bt),Ft(F,F,Ke);const Z=et();Ft(Z,he,bt),Ft(Z,Z,Ke),Wo(F,Z,_);const ct=et(),Ht=et(),Tn=et(),Pn=et();Ft(ct,he,Yt),Re(ct,ct,Ke),Re(Ht,he,Yt),Re(Ht,Ht,Ke),Ft(Tn,he,Yt),Ft(Tn,Tn,Ke),Re(Pn,he,Yt),Ft(Pn,Pn,Ke),S.push([A,yt,Dt,ue,ee,yo,Ao,F,Z,ie,He,ct,Ht,Tn,Pn])});const D=[],b=[],M=this._getReferenceLineColor(s.id),P=M!==void 0?M:"rgb(200, 200, 200)";if(S.forEach((T,x)=>{const A=T[0],O=this._getReferenceLineColor(A.id),R=this._getReferenceLineControllable(A.id),N=this._getReferenceLineDraggableRotatable(A.id)||this.configuration.mobile?.enabled,k=this._getReferenceLineSlabThicknessControlsOn(A.id)||this.configuration.mobile?.enabled,B=I.activeViewportIds.find(Y=>Y===A.id);let V=O!==void 0?O:"rgb(200, 200, 200)",$=1;const H=I.handles.activeOperation!==null&&I.handles.activeOperation===mn.DRAG&&B;H&&($=2.5);let G=`${x}`;if(R&&N?(G=`${x}One`,Et(o,g,G,T[1],T[2],{color:V,lineWidth:$}),G=`${x}Two`,Et(o,g,G,T[3],T[4],{color:V,lineWidth:$})):Et(o,g,G,T[2],T[4],{color:V,lineWidth:$}),R){V=O!==void 0?O:"rgb(200, 200, 200)";const Y=I.handles.activeOperation===mn.ROTATE,q=[T[9],T[10]],j=[s.canvasToWorld(T[9]),A,T[1],T[2]],K=[s.canvasToWorld(T[10]),A,T[3],T[4]];D.push(j,K);const it=I.handles.activeOperation===mn.SLAB,at=[T[11],T[12],T[13],T[14]],bt=[s.canvasToWorld(T[11]),A,T[5],T[6]],Bt=[s.canvasToWorld(T[12]),A,T[5],T[6]],Yt=[s.canvasToWorld(T[13]),A,T[7],T[8]],qt=[s.canvasToWorld(T[14]),A,T[7],T[8]];b.push(bt,Bt,Yt,qt);let Nt=this.configuration.handleRadius*(this.configuration.enableHDPIHandles?window.devicePixelRatio:1),Tt=1;if(this.configuration.mobile?.enabled&&(Nt=this.configuration.mobile.handleRadius,Tt=this.configuration.mobile.opacity),(H||this.configuration.mobile?.enabled)&&!Y&&!it&&N&&k){let yt=`${x}One`;$t(o,g,yt,q,{color:V,handleRadius:Nt,opacity:Tt,type:"circle"}),yt=`${x}Two`,$t(o,g,yt,at,{color:V,handleRadius:Nt,opacity:Tt,type:"rect"})}else if(H&&!Y&&!it&&N){const yt=`${x}`;$t(o,g,yt,q,{color:V,handleRadius:Nt,opacity:Tt,type:"circle"})}else if(B&&!Y&&!it&&k){const yt=`${x}`;$t(o,g,yt,at,{color:V,handleRadius:Nt,opacity:Tt,type:"rect"})}else if(Y&&N){const yt=`${x}`,Dt=this.configuration.handleRadius*(this.configuration.enableHDPIHandles?window.devicePixelRatio:1);$t(o,g,yt,q,{color:V,handleRadius:Dt,fill:V,type:"circle"})}else if(it&&B&&k){const yt=this.configuration.handleRadius*(this.configuration.enableHDPIHandles?window.devicePixelRatio:1);$t(o,g,G,at,{color:V,handleRadius:yt,fill:V,type:"rect"})}A.getSlabThickness()>.5&&k&&(G=`${x}STOne`,Et(o,g,G,T[5],T[6],{color:V,width:1,lineDash:[2,3]}),G=`${x}STTwo`,Et(o,g,G,T[7],T[8],{color:V,width:T,lineDash:[2,3]}))}}),a=!0,I.handles.rotationPoints=D,I.handles.slabThicknessPoints=b,this.configuration.viewportIndicators){const{viewportIndicatorsConfig:T}=this.configuration,x=T?.xOffset||.95,A=T?.yOffset||.05,O=[f*x,m*A],R=T?.circleRadius||v*.01;Ae(o,g,"0",O,R,{color:P,fill:P})}if(this.configuration.centerPoint?.enabled){const O=this.configuration.centerPoint.color||"rgba(255, 255, 0, 0.5)",R=Math.min(this.configuration.centerPoint.size||2,5);Ae(o,g,"centerPoint",C,R,{color:O,fill:O})}return a},this._getAnnotations=e=>{const{viewport:o}=e,a=Ct(this.getToolName(),o.element)||[],s=this._getViewportsInfo().map(({viewportId:c})=>c);return a.filter(c=>{const{data:l}=c;return s.includes(l.viewportId)})},this._onNewVolume=()=>{const e=this._getViewportsInfo();this._computeToolCenter(e)},this._areViewportIdArraysEqual=(e,o)=>e.length!==o.length?!1:(e.forEach(a=>{let s=!1;for(let r=0;r<o.length;++r)if(a===o[r]){s=!0;break}if(s===!1)return!1}),!0),this._getAnnotationsForViewportsWithDifferentCameras=(e,o)=>{const{viewportId:a,renderingEngine:s,viewport:r}=e,c=o.filter(g=>g.data.viewportId!==a);if(!c||!c.length)return[];const l=r.getCamera(),{viewPlaneNormal:d,position:u}=l;return c.filter(g=>{const{viewportId:f}=g.data,v=s.getViewport(f).getCamera();return!(Pt(v.viewPlaneNormal,d,.01)&&Pt(v.position,u,1))})},this._filterViewportWithSameOrientation=(e,o,a)=>{const{renderingEngine:s}=e,{data:r}=o,c=s.getViewport(r.viewportId),l=a.filter(g=>{const{data:f}=g,m=s.getViewport(f.viewportId);return this._getReferenceLineControllable(m.id)===!0});if(!l||!l.length)return[];const d=c.getCamera(),u=d.viewPlaneNormal;return st.normalize(u),l.filter(g=>{const{viewportId:f}=g.data,v=s.getViewport(f).getCamera(),p=v.viewPlaneNormal;return st.normalize(p),Pt(u,p,.01)&&Pt(d.viewUp,v.viewUp,.01)})},this._filterAnnotationsByUniqueViewportOrientations=(e,o)=>{const{renderingEngine:a,viewport:s}=e,c=s.getCamera().viewPlaneNormal;st.normalize(c);const l=o.filter(g=>{const{data:f}=g,m=a.getViewport(f.viewportId),v=this._getReferenceLineControllable(m.id);return s!==m&&v===!0}),d=[];for(let g=0;g<l.length;++g){const f=l[g],{viewportId:m}=f.data,p=a.getViewport(m).getCamera(),I=p.viewPlaneNormal;if(st.normalize(I),Pt(c,I,.01)||ms(c,I,.01))continue;let C=!1;for(let E=0;E<d.length;++E){const S=d[E],{viewportId:_}=S.data,b=a.getViewport(_).getCamera();Pt(b.viewPlaneNormal,p.viewPlaneNormal,.01)&&Pt(b.position,p.position,1)&&(C=!0)}C||d.push(f)}const u=o.filter(g=>{const{data:f}=g,m=a.getViewport(f.viewportId),v=this._getReferenceLineControllable(m.id);return s!==m&&v!==!0});for(let g=0;g<u.length;++g){const f=u[g],{viewportId:m}=f.data,p=a.getViewport(m).getCamera(),I=p.viewPlaneNormal;if(st.normalize(I),Pt(c,I,.01)||ms(c,I,.01))continue;let C=!1;for(let E=0;E<d.length;++E){const S=d[E],{viewportId:_}=S.data,b=a.getViewport(_).getCamera();Pt(b.viewPlaneNormal,p.viewPlaneNormal,.01)&&Pt(b.position,p.position,1)&&(C=!0)}C||d.push(f)}const h=this._getAnnotationsForViewportsWithDifferentCameras(e,o);for(let g=0;g<h.length;++g){const f=h[g];if(d.some(E=>E===f))continue;const{viewportId:m}=f.data,p=a.getViewport(m).getCamera(),I=p.viewPlaneNormal;if(st.normalize(I),Pt(c,I,.01)||ms(c,I,.01))continue;let C=!1;for(let E=0;E<d.length;++E){const S=d[E],{viewportId:_}=S.data,b=a.getViewport(_).getCamera();Pt(b.viewPlaneNormal,p.viewPlaneNormal,.01)&&Pt(b.position,p.position,1)&&(C=!0)}C||d.push(f)}return d},this._checkIfViewportsRenderingSameScene=(e,o)=>{const a=e.getAllVolumeIds(),s=o.getAllVolumeIds();return a.length===s.length&&a.every(r=>s.includes(r))},this._jump=(e,o)=>{U.isInteractingWithTool=!0;const{viewport:a,renderingEngine:s}=e,r=this._getAnnotations(e),c=[0,0,0];st.subtract(o,this.toolCenter,c);const d=this._getAnnotationsForViewportsWithDifferentCameras(e,r).filter(u=>{const{data:h}=u,g=s.getViewport(h.viewportId),f=this._checkIfViewportsRenderingSameScene(a,g);return this._getReferenceLineControllable(g.id)&&this._getReferenceLineDraggableRotatable(g.id)&&f});return d.length===0?(U.isInteractingWithTool=!1,!1):(this._applyDeltaShiftToSelectedViewportCameras(s,d,c),U.isInteractingWithTool=!1,!0)},this._activateModify=e=>{U.isInteractingWithTool=!this.configuration.mobile?.enabled,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this._endCallback=e=>{const o=e.detail,{element:a}=o;this.editData.annotation.data.handles.activeOperation=null,this.editData.annotation.data.activeViewportIds=[],this._deactivateModify(a),ht(a),this.editData=null;const r=Q(a,this.getToolName(),!1);L(r)},this._dragCallback=e=>{const o=e.detail,a=o.deltaPoints.world;if(Math.abs(a[0])<.001&&Math.abs(a[1])<.001&&Math.abs(a[2])<.001)return;const{element:s}=o,r=y(s),{renderingEngine:c,viewport:l}=r,d=this._getAnnotations(r),h=this.filterInteractableAnnotationsForElement(s,d)[0];if(!h)return;const{handles:g}=h.data,{currentPoints:f}=e.detail,m=f.canvas;if(g.activeOperation===mn.DRAG){const p=this._getAnnotationsForViewportsWithDifferentCameras(r,d).filter(I=>{const{data:C}=I,E=c.getViewport(C.viewportId),S=this._getReferenceLineControllable(E.id),_=this._getReferenceLineDraggableRotatable(E.id);return S===!0&&_===!0&&h.data.activeViewportIds.find(D=>D===E.id)});this._applyDeltaShiftToSelectedViewportCameras(c,p,a)}else if(g.activeOperation===mn.ROTATE){const p=this._getAnnotationsForViewportsWithDifferentCameras(r,d).filter(x=>{const{data:A}=x,O=c.getViewport(A.viewportId),R=this._getReferenceLineControllable(O.id),N=this._getReferenceLineDraggableRotatable(O.id);return R===!0&&N===!0}),I=et(),C=et(),E=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]],S=l.worldToCanvas(E),_=o.currentPoints.canvas,D=et();Kn(D,_,o.deltaPoints.canvas),Kn(I,D,S),Kn(C,_,S);let b=T0(I,C);this._isClockWise(S,D,_)&&(b*=-1),b=Math.round(b*100)/100;const M=l.getCamera().viewPlaneNormal,{matrix:P}=pn.buildFromRadian().translate(E[0],E[1],E[2]).rotate(b,M).translate(-E[0],-E[1],-E[2]),T=[];p.forEach(x=>{const{data:A}=x;A.handles.toolCenter=E;const O=c.getViewport(A.viewportId),R=O.getCamera(),{viewUp:N,position:k,focalPoint:B}=R;N[0]+=k[0],N[1]+=k[1],N[2]+=k[2],Se(B,B,P),Se(k,k,P),Se(N,N,P),N[0]-=k[0],N[1]-=k[1],N[2]-=k[2],O.setCamera({position:k,viewUp:N,focalPoint:B}),T.push(O.id)}),c.renderViewports(T)}else if(g.activeOperation===mn.SLAB){const p=this._getAnnotationsForViewportsWithDifferentCameras(r,d).filter(E=>{const{data:S}=E,_=c.getViewport(S.viewportId),D=this._getReferenceLineControllable(_.id),b=this._getReferenceLineSlabThicknessControlsOn(_.id);return D===!0&&b===!0&&h.data.activeViewportIds.find(M=>M===_.id)});if(p.length===0)return;const I=this._filterViewportWithSameOrientation(r,p[0],d),C=[];C.push(l.id),I.forEach(E=>{const{data:S}=E,_=c.getViewport(S.viewportId),b=_.getCamera().viewPlaneNormal,M=st.dot(a,b),P=[...b];if(st.multiplyScalar(P,M),Math.abs(P[0])>.001||Math.abs(P[1])>.001||Math.abs(P[2])>.001){const T=Math.sqrt(P[0]*P[0]+P[1]*P[1]+P[2]*P[2]),x=o.lastPoints.world,A=[0,0,0],O=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]];if(!this._getReferenceLineDraggableRotatable(_.id)){const{rotationPoints:q}=this.editData.annotation.data.handles,j=q.filter(K=>K[1].uid===_.id);if(j.length===2){const K=l.canvasToWorld(j[0][3]),it=l.canvasToWorld(j[1][3]);st.add(K,it,O),st.multiplyScalar(O,.5)}}st.subtract(x,O,A);const N=st.dot(A,b),k=[...b];st.multiplyScalar(k,N);const B=[k[0],k[1],k[2]];Zt(B,B);const V=[P[0],P[1],P[2]];Zt(V,V);let $=_.getSlabThickness();ms(B,V,.001)?$-=T:$+=T,$=Math.abs($),$=Math.max(Mc.MINIMUM_SLAB_THICKNESS,$),this._pointNearReferenceLine(h,m,6,_)&&($=Mc.MINIMUM_SLAB_THICKNESS),ne(_.id,c.id).getToolInstance(this.getToolName()).setSlabThickness(_,$),C.push(_.id)}}),c.renderViewports(C)}},this._pointNearReferenceLine=(e,o,a,s)=>{const{data:r}=e,{rotationPoints:c}=r.handles;for(let l=0;l<c.length-1;++l){const d=c[l][1];if(d.id!==s.id||!this._getReferenceLineControllable(d.id))continue;const h={start:{x:c[l][2][0],y:c[l][2][1]},end:{x:c[l][3][0],y:c[l][3][1]}},g=fe([h.start.x,h.start.y],[h.end.x,h.end.y],[o[0],o[1]]),f={start:{x:c[l+1][2][0],y:c[l+1][2][1]},end:{x:c[l+1][3][0],y:c[l+1][3][1]}},m=fe([f.start.x,f.start.y],[f.end.x,f.end.y],[o[0],o[1]]);if(g<=a||m<=a)return!0;l++}return!1},this._getReferenceLineColor=t.configuration?.getReferenceLineColor||Zy,this._getReferenceLineControllable=t.configuration?.getReferenceLineControllable||Jy,this._getReferenceLineDraggableRotatable=t.configuration?.getReferenceLineDraggableRotatable||Qy,this._getReferenceLineSlabThicknessControlsOn=t.configuration?.getReferenceLineSlabThicknessControlsOn||tA}onSetToolActive(){const t=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(t),this._subscribeToViewportNewVolumeSet(t),this._computeToolCenter(t)}onSetToolPassive(){const t=this._getViewportsInfo();this._computeToolCenter(t)}onSetToolEnabled(){const t=this._getViewportsInfo();this._computeToolCenter(t)}onSetToolDisabled(){const t=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(t),t.forEach(({renderingEngineId:n,viewportId:e})=>{const o=Gt(e,n);if(!o)return;const a=this._getAnnotations(o);a?.length&&a.forEach(s=>{ft(s.annotationUID)})})}setToolCenter(t,n=!1){this._getViewportsInfo().map(({renderingEngineId:o,viewportId:a})=>{const r=te(o).getViewport(a),c=r.getCamera(),{focalPoint:l,position:d,viewPlaneNormal:u}=c,h=[t[0]-l[0],t[1]-l[1],t[2]-l[2]],g=h[0]*u[0]+h[1]*u[1]+h[2]*u[2],f=[g*u[0],g*u[1],g*u[2]],m=[l[0]+f[0],l[1]+f[1],l[2]+f[2]],v=[d[0]+f[0],d[1]+f[1],d[2]+f[2]];r.setCamera({focalPoint:m,position:v}),r.render()}),this.toolCenter=t,n||gt(z,w.CROSSHAIR_TOOL_CENTER_CHANGED,{toolGroupId:this.toolGroupId,toolCenter:this.toolCenter})}getHandleNearImagePoint(t,n,e,o){const a=y(t),{viewport:s}=a;let r=this._getRotationHandleNearImagePoint(s,n,e,o);if(r!==null||(r=this._getSlabThicknessHandleNearImagePoint(s,n,e,o),r!==null))return r}_unsubscribeToViewportNewVolumeSet(t){t.forEach(({viewportId:n,renderingEngineId:e})=>{const{viewport:o}=Gt(n,e),{element:a}=o;a.removeEventListener(ut.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)})}_subscribeToViewportNewVolumeSet(t){t.forEach(({viewportId:n,renderingEngineId:e})=>{const{viewport:o}=Gt(n,e),{element:a}=o;a.addEventListener(ut.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)})}_autoPanViewportIfNecessary(t,n){const e=n.getViewport(t),{clientWidth:o,clientHeight:a}=e.canvas,s=e.worldToCanvas(this.toolCenter),r=this.configuration.autoPan.panSize,c=[s[0],s[1]];if(s[0]<0?c[0]=r:s[0]>o&&(c[0]=o-r),s[1]<0?c[1]=r:s[1]>a&&(c[1]=a-r),c[0]===s[0]&&c[1]===s[1])return;const l=e.canvasToWorld(c),d=[l[0]-this.toolCenter[0],l[1]-this.toolCenter[1],l[2]-this.toolCenter[2]],u=e.getCamera(),{focalPoint:h,position:g}=u,f=[g[0]-d[0],g[1]-d[1],g[2]-d[2]],m=[h[0]-d[0],h[1]-d[1],h[2]-d[2]];e.setCamera({focalPoint:m,position:f}),e.render()}setSlabThickness(t,n){let e;const{filterActorUIDsToSetSlabThickness:o}=this.configuration;o&&o.length>0&&(e=o);let a=this.configuration.slabThicknessBlendMode;n===Mc.MINIMUM_SLAB_THICKNESS&&(a=$o.COMPOSITE),t.setBlendMode(a,e,!1),t.setSlabThickness(n,e)}_isClockWise(t,n,e){return(n[0]-t[0])*(e[1]-t[1])-(n[1]-t[1])*(e[0]-t[0])>0}_applyDeltaShiftToSelectedViewportCameras(t,n,e){n.forEach(o=>{this._applyDeltaShiftToViewportCamera(t,o,e)})}_applyDeltaShiftToViewportCamera(t,n,e){const{data:o}=n,a=t.getViewport(o.viewportId),s=a.getCamera(),r=s.viewPlaneNormal,c=st.dot(e,r),l=[...r];if(st.multiplyScalar(l,c),Math.abs(l[0])>.001||Math.abs(l[1])>.001||Math.abs(l[2])>.001){const d=[0,0,0],u=[0,0,0];st.add(s.focalPoint,l,d),st.add(s.position,l,u),a.setCamera({focalPoint:d,position:u}),a.render()}}_getRotationHandleNearImagePoint(t,n,e,o){const{data:a}=n,{rotationPoints:s}=a.handles;for(let r=0;r<s.length;r++){const c=s[r][0],l=s[r][1];if(!this._getReferenceLineControllable(l.id)||!this._getReferenceLineDraggableRotatable(l.id))continue;const h=t.worldToCanvas(c);if(jt(e,h)<o)return a.handles.activeOperation=mn.ROTATE,this.editData={annotation:n},c}return null}_getSlabThicknessHandleNearImagePoint(t,n,e,o){const{data:a}=n,{slabThicknessPoints:s}=a.handles;for(let r=0;r<s.length;r++){const c=s[r][0],l=s[r][1];if(!this._getReferenceLineControllable(l.id)||!this._getReferenceLineSlabThicknessControlsOn(l.id))continue;const h=t.worldToCanvas(c);if(jt(e,h)<o)return a.handles.activeOperation=mn.SLAB,a.activeViewportIds=[l.id],this.editData={annotation:n},c}return null}_pointNearTool(t,n,e,o){const a=y(t),{viewport:s}=a,{clientWidth:r,clientHeight:c}=s.canvas,l=Math.sqrt(r*r+c*c),{data:d}=n,{rotationPoints:u}=d.handles,{slabThicknessPoints:h}=d.handles,g=[];for(let f=0;f<u.length-1;++f){const m=u[f][1],v=this._getReferenceLineControllable(m.id),p=this._getReferenceLineDraggableRotatable(m.id);if(!v||!p)continue;const I={start:{x:u[f][2][0],y:u[f][2][1]},end:{x:u[f][3][0],y:u[f][3][1]}},C=fe([I.start.x,I.start.y],[I.end.x,I.end.y],[e[0],e[1]]),E={start:{x:u[f+1][2][0],y:u[f+1][2][1]},end:{x:u[f+1][3][0],y:u[f+1][3][1]}},S=fe([E.start.x,E.start.y],[E.end.x,E.end.y],[e[0],e[1]]);(C<=o||S<=o)&&(g.push(m.id),d.handles.activeOperation=mn.DRAG),f++}for(let f=0;f<h.length-1;++f){const m=h[f][1];if(g.find(A=>A===m.id))continue;const v=this._getReferenceLineControllable(m.id),p=this._getReferenceLineSlabThicknessControlsOn(m.id);if(!v||!p)continue;const I=h[f][2],C=h[f][3],E=et();Re(E,I,C),uo(E,E,.5);const S=et();Ft(S,I,E),yn(S,S);const _=et();uo(_,S,l*.05);const D=et(),b=et();Re(D,E,_),Ft(b,E,_);const M={start:{x:D[0],y:D[1]},end:{x:I[0],y:I[1]}},P=fe([M.start.x,M.start.y],[M.end.x,M.end.y],[e[0],e[1]]),T={start:{x:b[0],y:b[1]},end:{x:C[0],y:C[1]}},x=fe([T.start.x,T.start.y],[T.end.x,T.end.y],[e[0],e[1]]);(P<=o||x<=o)&&(g.push(m.id),d.handles.activeOperation=null),f++}return d.activeViewportIds=[...g],this.editData={annotation:n},d.handles.activeOperation===mn.DRAG}}eA.toolName="Crosshairs";const Ms="magnify-viewport";class nA extends de{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{magnifySize:10,magnifyWidth:250,magnifyHeight:250}}){super(t,n),this._hasBeenRemoved=!1,this.preMouseDownCallback=e=>{const o=e.detail,{element:a,currentPoints:s}=o,r=y(a),{viewport:c,renderingEngine:l}=r;if(!(c instanceof Ie))throw new Error("MagnifyTool only works on StackViewports");const d=this._getReferencedImageId(c);if(!d)throw new Error("MagnifyTool: No referenced image id found, reconstructed planes not supported yet");const u=Q(a,this.getToolName());return this.editData={referencedImageId:d,viewportIdsToRender:u,enabledElement:r,renderingEngine:l,currentPoints:s},this._createMagnificationViewport(),this._activateDraw(a),nt(a),e.preventDefault(),L(u),!0},this.preTouchStartCallback=e=>{this.preMouseDownCallback(e)},this._createMagnificationViewport=()=>{const{enabledElement:e,referencedImageId:o,viewportIdsToRender:a,renderingEngine:s,currentPoints:r}=this.editData,{viewport:c}=e,{element:l}=c,d=c.getProperties(),{rotation:u}=c.getViewPresentation(),{canvas:h,world:g}=r;let f;if(f=l.querySelector(".magnifyTool"),f===null){const v=document.createElement("div");v.classList.add("magnifyTool"),v.style.display="block",v.style.width=`${this.configuration.magnifyWidth}px`,v.style.height=`${this.configuration.magnifyHeight}px`,v.style.position="absolute",f=v,l.querySelector(".viewport-element").appendChild(v);const I={viewportId:Ms,type:Rl.STACK,element:f};s.enableElement(I)}f.style.top=`${h[1]-this.configuration.magnifyHeight/2}px`,f.style.left=`${h[0]-this.configuration.magnifyWidth/2}px`;const m=s.getViewport(Ms);m.setStack([o]).then(()=>{if(this._hasBeenRemoved)return;m.setProperties(d),m.setViewPresentation({rotation:u});const{parallelScale:v}=c.getCamera(),{focalPoint:p,position:I,viewPlaneNormal:C}=m.getCamera(),E=Math.sqrt(Math.pow(p[0]-I[0],2)+Math.pow(p[1]-I[1],2)+Math.pow(p[2]-I[2],2)),S=[g[0],g[1],g[2]],_=[S[0]+E*C[0],S[1]+E*C[1],S[2]+E*C[2]];m.setCamera({parallelScale:v*(1/this.configuration.magnifySize),focalPoint:S,position:_}),m.render()}),f.style.display="block",L(a)},this._cancelCallback=e=>{e.preventDefault(),e.stopPropagation(),this._dragEndCallback(e)},this._dragCallback=e=>{const o=e.detail,{deltaPoints:a,element:s,currentPoints:r}=o,c=a.world,l=r.canvas,d=y(s),{renderingEngine:u}=d,h=u.getViewport(Ms),g=s.querySelector(".magnifyTool");if(!g)return;g.style.top=`${l[1]-this.configuration.magnifyHeight/2}px`,g.style.left=`${l[0]-this.configuration.magnifyWidth/2}px`;const{focalPoint:f,position:m}=h.getCamera(),v=[m[0]+c[0],m[1]+c[1],m[2]+c[2]],p=[f[0]+c[0],f[1]+c[1],f[2]+c[2]];h.setCamera({focalPoint:p,position:v}),h.render()},this._dragEndCallback=e=>{let{element:o}=e.detail;if(o===void 0){const{enabledElement:l}=this.editData,{viewport:d}=l;o=d.element}const a=y(o),{renderingEngine:s}=a;s.disableElement(Ms);const r=o.querySelector(".viewport-element"),c=r.querySelector(".magnifyTool");r.removeChild(c),this._deactivateDraw(o),ht(o),this._hasBeenRemoved=!0},this._activateDraw=e=>{U.isInteractingWithTool=!0,this._hasBeenRemoved=!1,e.addEventListener(w.MOUSE_UP,this._dragEndCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._dragEndCallback),e.addEventListener("contextmenu",this._cancelCallback),e.addEventListener(w.TOUCH_END,this._dragEndCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._dragEndCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._dragEndCallback),e.removeEventListener("contextmenu",this._cancelCallback),e.removeEventListener(w.TOUCH_END,this._dragEndCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback)}}_getReferencedImageId(t){const n=this.getTargetId(t);let e;return t instanceof Ie&&(e=n.split("imageId:")[1]),e}}nA.toolName="Magnify";const oA="advancedMagnifyTool",iA=125,{Events:lo}=fr,$h=i=>!!i.representationUID;var vl;(function(i){i.ShowZoomFactorsList="showZoomFactorsList"})(vl||(vl={}));const aA="AdvancedMagnify",sA=1-P0,eu=class eu extends zt{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,magnifyingGlass:{radius:125,zoomFactor:3,zoomFactorList:[1.5,2,2.5,3,3.5,4,4.5,5],autoPan:{enabled:!0,padding:10}},actions:{showZoomFactorsList:{method:"showZoomFactorsList",bindings:[{mouseButton:Nn.Secondary,modifierKey:De.Shift}]}}}}){super(t,n),this.addNewAnnotation=e=>{const o=e.detail,{currentPoints:a,element:s}=o,r=y(s),{viewport:c,renderingEngine:l}=r,d=a.world,u=a.canvas,{magnifyingGlass:h}=this.configuration,{radius:g,zoomFactor:f,autoPan:m}=h,v=this._getWorldHandlePoints(c,u,g),p=c.getCamera(),{viewPlaneNormal:I,viewUp:C}=p,E=this.getReferencedImageId(c,d,I,C),S=Xt(),_=Xt(),D=c.getFrameOfReferenceUID(),b={annotationUID:S,highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...I],viewUp:[...C],FrameOfReferenceUID:D,referencedImageId:E},data:{sourceViewportId:c.id,magnifyViewportId:_,zoomFactor:f,isCanvasAnnotation:!1,handles:{points:v,activeHandleIndex:null}}};this.magnifyViewportManager.createViewport(b,{magnifyViewportId:_,sourceEnabledElement:r,position:u,radius:g,zoomFactor:f,autoPan:{enabled:m.enabled,padding:m.padding,callback:P=>{const T=b.data.handles.points,{world:x}=P.delta;for(let A=0,O=T.length;A<O;A++){const R=T[A];R[0]+=x[0],R[1]+=x[1],R[2]+=x[2]}b.invalidated=!0}}}),mt(b,s);const M=Q(s,this.getToolName());return e.preventDefault(),L(M),b},this.onSetToolDisabled=()=>{this.magnifyViewportManager.dispose(),Fi().forEach(o=>{o.metadata.toolName===this.getToolName()&&ft(o.annotationUID)})},this.isPointNearTool=(e,o,a,s)=>{const{viewport:r}=y(e),{points:c}=o.data.handles,{radius:l,center:d}=this._getCanvasCircleData(r,c),u=wo([d,a]);return Math.abs(u-l)<s*2},this.toolSelectedCallback=(e,o)=>{const a=e.detail,{element:s}=a;o.highlighted=!0;const r=Q(s,this.getToolName());this.editData={annotation:o,viewportIdsToRender:r},nt(s),this._activateModify(s),L(r),e.preventDefault()},this.handleSelectedCallback=(e,o,a)=>{const s=e.detail,{element:r}=s,{data:c}=o;o.highlighted=!0;const{points:l}=c.handles,d=l.findIndex(h=>h===a),u=Q(r,this.getToolName());this.editData={annotation:o,viewportIdsToRender:u,handleIndex:d},this._activateModify(r),nt(r),L(u),e.preventDefault()},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c}=this.editData,{data:l}=s;l.handles.activeHandleIndex=null,this._deactivateModify(a),ht(a),this.editData=null,this.isDrawing=!1,L(r),c&&Lt(s)},this._dragDrawCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{viewport:s}=y(a),{deltaPoints:r}=o,c=r?.canvas??[0,0,0],{annotation:l,viewportIdsToRender:d}=this.editData,{points:u}=l.data.handles,h=this._getWorldDeltaFromCanvasDelta(s,u,c);this._applyWorldDelta(u,h),l.invalidated=!0,this.editData.hasMoved=!0,L(d)},this._dragModifyCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,handleIndex:c}=this.editData,{data:l}=s;if(c===void 0){const{deltaPoints:d}=o,u=d.canvas??[0,0,0],h=l.handles.points,g=this._getWorldDeltaFromCanvasDelta(y(a).viewport,h,u);this._applyWorldDelta(h,g),s.invalidated=!0}else this._dragHandle(e),s.invalidated=!0;L(r)},this._dragHandle=e=>{const o=e.detail,{element:a}=o,{viewport:s}=y(a),{annotation:r}=this.editData,{data:c}=r,{points:l}=c.handles,{center:d}=this._getCanvasCircleData(s,l),{currentPoints:u}=o,h=u.canvas,g=wo([d,h]),m=this._getCanvasHandlePoints(d,g).map(v=>s.canvasToWorld(v));l[0]=m[0],l[1]=m[1],l[2]=m[2],l[3]=m[3]},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateModify(e),ht(e);const{annotation:o,viewportIdsToRender:a,newAnnotation:s}=this.editData,{data:r}=o;return o.highlighted=!1,r.handles.activeHandleIndex=null,L(a),s&&Lt(o),this.editData=null,o.annotationUID},this._activateModify=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e,{element:r}=s;let c=Ct(this.getToolName(),r);if(!c?.length)return a;c=c?.filter(u=>u.data.sourceViewportId===s.id);const l=this.filterInteractableAnnotationsForElement(r,c);if(!l?.length)return a;const d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let u=0;u<l.length;u++){const h=l[u],{annotationUID:g,data:f}=h,{magnifyViewportId:m,zoomFactor:v,handles:p}=f,{points:I,activeHandleIndex:C}=p,{center:E,radius:S,canvasPoints:_}=this._getCanvasCircleData(s,I);d.annotationUID=g,this.getStyle("lineWidth",d,h),this.getStyle("lineDash",d,h);const D=this.getStyle("color",d,h);if(!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;let b;if(!re(g))continue;if(!se(g)&&!this.editData&&C!==null){const x=_[C];b=[[x[0],x[1],0]]}b&&$t(o,g,"0",b,{color:D});const M=`${g}-advancedMagnify`;Ae(o,g,"0",E,S,{color:D,lineWidth:5},M);const T=this.magnifyViewportManager.getViewport(m);T.position=E,T.radius=S,T.zoomFactor=v,T.update(),a=!0}return a},this._getWorldHandlePoints=(e,o,a)=>this._getCanvasHandlePoints(o,a).map(r=>e.canvasToWorld(r)),this._getCanvasCircleData=(e,o)=>{const a=o.map(u=>e.worldToCanvas(u)),s=a[0],r=a[2],c=a[3],l=Math.abs(r[1]-s[1])*.5,d=[c[0]+l,s[1]+l];return{canvasPoints:a,center:d,radius:l}},this._getCanvasHandlePoints=(e,o)=>[[e[0],e[1]-o,0],[e[0]+o,e[1],0],[e[0],e[1]+o,0],[e[0]-o,e[1],0]],this.magnifyViewportManager=Ii.getInstance()}showZoomFactorsList(t,n){const{element:e,currentPoints:o}=t.detail,a=y(e),{viewport:s}=a,{canvas:r}=o,c=e.querySelector(":scope .viewport-element"),l=n.data.zoomFactor,d=()=>u.parentElement.removeChild(u),u=this._getZoomFactorsListDropdown(l,h=>{h!==void 0&&(n.data.zoomFactor=Number.parseFloat(h),n.invalidated=!0),d(),s.render()});Object.assign(u.style,{left:`${r[0]}px`,top:`${r[1]}px`}),c.appendChild(u),u.focus()}_getZoomFactorsListDropdown(t,n){const{zoomFactorList:e}=this.configuration.magnifyingGlass,o=document.createElement("select");return o.size=5,Object.assign(o.style,{width:"50px",position:"absolute"}),["mousedown","mouseup","mousemove","click"].forEach(a=>{o.addEventListener(a,s=>s.stopPropagation())}),o.addEventListener("change",a=>{a.stopPropagation(),n(o.value)}),o.addEventListener("keydown",a=>{((a.keyCode??a.which===27)||a.key?.toLowerCase()==="escape")&&(a.stopPropagation(),n())}),e.forEach(a=>{const s=document.createElement("option");s.label=a,s.title=`Zoom factor ${a.toFixed(1)}`,s.value=a,s.defaultSelected=a===t,o.add(s)}),o}_getWorldDeltaFromCanvasDelta(t,n,e){if(!e)return[0,0,0];const o=n[0],a=t.worldToCanvas(o),s=t.canvasToWorld([a[0]+e[0],a[1]+e[1]]);return[s[0]-o[0],s[1]-o[1],s[2]-o[2]]}_applyWorldDelta(t,n){if(n)for(let e=0,o=t.length;e<o;e++){const a=t[e];a[0]+=n[0],a[1]+=n[1],a[2]+=n[2]}}};eu.Actions=vl;let rr=eu;class Ii{constructor(){this.createViewport=(t,n)=>{const{magnifyViewportId:e,sourceEnabledElement:o,position:a,radius:s,zoomFactor:r,autoPan:c}=n,{viewport:l}=o,{element:d}=l,u=new rA({magnifyViewportId:e,sourceEnabledElement:o,radius:s,position:a,zoomFactor:r,autoPan:c});return this._addSourceElementEventListener(d),this._magnifyViewportsMap.set(u.viewportId,{annotation:t,magnifyViewport:u,magnifyViewportInfo:n}),u},this._annotationRemovedCallback=t=>{const{annotation:n}=t.detail;n.metadata.toolName===aA&&this.destroyViewport(n.data.magnifyViewportId)},this._newStackImageCallback=t=>{const{viewportId:n,imageId:e}=t.detail,o=this._getMagnifyViewportsMapEntriesBySourceViewportId(n),{viewport:a}=At(n);a.stackActorReInitialized&&this._reset(n),o.forEach(({annotation:s})=>{s.metadata.referencedImageId=e,s.invalidated=!0})},this._newVolumeImageCallback=t=>{const{renderingEngineId:n,viewportId:e}=t.detail,a=te(n).getViewport(e),{viewPlaneNormal:s}=a.getCamera();this._getMagnifyViewportsMapEntriesBySourceViewportId(e).forEach(({annotation:c})=>{const{viewPlaneNormal:l}=c.metadata;if(!(Math.abs(dt(l,s))>sA))return;const{handles:u}=c.data,h=a.canvasToWorld([0,0]),g=me(W(),h,u.points[0]),f=dt(g,s),m=hn(W(),s,f);for(let v=0,p=u.points.length;v<p;v++){const I=u.points[v];I[0]+=m[0],I[1]+=m[1],I[2]+=m[2]}c.invalidated=!0})},this._magnifyViewportsMap=new Map,this._initialize()}static getInstance(){return Ii._singleton=Ii._singleton??new Ii,Ii._singleton}getViewport(t){return this._magnifyViewportsMap.get(t)?.magnifyViewport}dispose(){this._removeEventListeners(),this._destroyViewports()}destroyViewport(t){const n=this._magnifyViewportsMap.get(t);if(n){const{magnifyViewport:e}=n,{viewport:o}=e.sourceEnabledElement,{element:a}=o;this._removeSourceElementEventListener(a),e.dispose(),this._magnifyViewportsMap.delete(t)}}_destroyViewports(){Array.from(this._magnifyViewportsMap.keys()).forEach(n=>this.destroyViewport(n))}_getMagnifyViewportsMapEntriesBySourceViewportId(t){return Array.from(this._magnifyViewportsMap.values()).filter(({magnifyViewport:e})=>{const{viewport:o}=e.sourceEnabledElement;return o.id===t})}_reset(t){this._getMagnifyViewportsMapEntriesBySourceViewportId(t).forEach(({magnifyViewport:e,annotation:o,magnifyViewportInfo:a})=>{this.destroyViewport(e.viewportId);const s=At(t);this.createViewport(o,{...a,sourceEnabledElement:{...s}})})}_addEventListeners(){z.addEventListener(w.ANNOTATION_REMOVED,this._annotationRemovedCallback)}_removeEventListeners(){z.removeEventListener(w.ANNOTATION_REMOVED,this._annotationRemovedCallback)}_addSourceElementEventListener(t){t.addEventListener(lo.STACK_NEW_IMAGE,this._newStackImageCallback);const n=o=>{const{viewportId:a}=o.detail;this._reset(a)};t.addEventListener(lo.VIEWPORT_NEW_IMAGE_SET,n);const e=o=>{const{viewportId:a}=o.detail;this._reset(a)};t.addEventListener(lo.VOLUME_VIEWPORT_NEW_VOLUME,e),t.addEventListener(lo.VOLUME_NEW_IMAGE,this._newVolumeImageCallback),t.newStackHandler=n,t.newVolumeHandler=e}_removeSourceElementEventListener(t){t.removeEventListener(lo.STACK_NEW_IMAGE,this._newStackImageCallback),t.removeEventListener(lo.VOLUME_NEW_IMAGE,this._newVolumeImageCallback),t.removeEventListener(lo.VIEWPORT_NEW_IMAGE_SET,t.newStackHandler),t.removeEventListener(lo.VOLUME_VIEWPORT_NEW_VOLUME,t.newVolumeHandler),delete t.newStackHandler,delete t.newVolumeHandler}_initialize(){this._addEventListeners()}}class rA{constructor({magnifyViewportId:t,sourceEnabledElement:n,radius:e=iA,position:o=[0,0],zoomFactor:a,autoPan:s}){this._enabledElement=null,this._sourceToolGroup=null,this._magnifyToolGroup=null,this._isViewportReady=!1,this._radius=0,this._resized=!1,this._canAutoPan=!1,this._viewportId=t??Xt(),this._sourceEnabledElement=n,this._autoPan=s,this.radius=e,this.position=o,this.zoomFactor=a,this.visible=!0,this._browserMouseDownCallback=this._browserMouseDownCallback.bind(this),this._browserMouseUpCallback=this._browserMouseUpCallback.bind(this),this._handleToolModeChanged=this._handleToolModeChanged.bind(this),this._mouseDragCallback=this._mouseDragCallback.bind(this),this._resizeViewportAsync=zi(this._resizeViewport.bind(this),1),this._initialize()}get sourceEnabledElement(){return this._sourceEnabledElement}get viewportId(){return this._viewportId}get radius(){return this._radius}set radius(t){Math.abs(this._radius-t)>1e-5&&(this._radius=t,this._resized=!0)}update(){const{radius:t,position:n,visible:e}=this,{viewport:o}=this._enabledElement,{element:a}=o,s=2*t,[r,c]=n;this._resized&&(this._resizeViewportAsync(),this._resized=!1),Object.assign(a.style,{display:e?"block":"hidden",width:`${s}px`,height:`${s}px`,left:`${-t}px`,top:`${-t}px`,transform:`translate(${r}px, ${c}px)`}),this._isViewportReady&&(this._syncViewports(),o.render())}dispose(){const{viewport:t}=this._enabledElement,{element:n}=t,e=t.getRenderingEngine();this._removeEventListeners(n),e.disableElement(t.id),n.parentNode&&n.parentNode.removeChild(n)}_handleToolModeChanged(t){const{_magnifyToolGroup:n}=this,{toolGroupId:e,toolName:o,mode:a,toolBindingsOptions:s}=t.detail;if(this._sourceToolGroup?.id===e)switch(a){case Ot.Active:n.setToolActive(o,s);break;case Ot.Passive:n.setToolPassive(o);break;case Ot.Enabled:n.setToolEnabled(o);break;case Ot.Disabled:n.setToolDisabled(o);break;default:throw new Error(`Unknow tool mode (${a})`)}}_inheritBorderRadius(t){const n=t.querySelector(".viewport-element"),e=t.querySelector(".cornerstone-canvas");n.style.borderRadius="inherit",e.style.borderRadius="inherit"}_createViewportNode(){const t=document.createElement("div"),{radius:n}=this,e=n*2;return t.classList.add(oA),Object.assign(t.style,{display:"block",width:`${e}px`,height:`${e}px`,position:"absolute",overflow:"hidden",borderRadius:"50%",boxSizing:"border-box",left:`${-n}px`,top:`${-n}px`,transform:"translate(-1000px, -1000px)"}),t}_convertZoomFactorToParallelScale(t,n,e){const{parallelScale:o}=t.getCamera(),a=n.canvas.offsetWidth/t.canvas.offsetWidth;return o*(1/e)*a}_isStackViewport(t){return"setStack"in t}_isVolumeViewport(t){return"addVolumes"in t}_cloneToolGroups(t,n){const e=t.getActors(),o=`${n.id}-toolGroup`,a=ne(t.id,t.renderingEngineId),s=a.clone(o,r=>{const c=a.getToolInstance(r);return c instanceof zt&&!(c instanceof rr)});return s.addViewport(n.id,n.renderingEngineId),e.filter($h).forEach(r=>{Ji(this.viewportId,[{segmentationId:r.referencedId,type:tt.Labelmap}])}),{sourceToolGroup:a,magnifyToolGroup:s}}_cloneStack(t,n){const e=t.getImageIds();n.setStack(e).then(()=>{this._isViewportReady=!0,this.update()})}_cloneVolumes(t,n){const o=t.getActors().filter(a=>!$h(a)).map(a=>({volumeId:a.referencedId}));return n.setVolumes(o).then(()=>{this._isViewportReady=!0,this.update()}),n}_cloneViewport(t,n){const{viewportId:e}=this,o=t.getRenderingEngine(),{options:a}=t,s={element:n,viewportId:e,type:t.type,defaultOptions:{...a}};o.enableElement(s);const r=o.getViewport(e);this._isStackViewport(t)?this._cloneStack(t,r):this._isVolumeViewport(t)&&this._cloneVolumes(t,r),this._inheritBorderRadius(n);const c=this._cloneToolGroups(t,r);this._sourceToolGroup=c.sourceToolGroup,this._magnifyToolGroup=c.magnifyToolGroup}_cancelMouseEventCallback(t){t.stopPropagation(),t.preventDefault()}_browserMouseUpCallback(t){const{element:n}=this._enabledElement.viewport;document.removeEventListener("mouseup",this._browserMouseUpCallback),n.addEventListener("mouseup",this._cancelMouseEventCallback),n.addEventListener("mousemove",this._cancelMouseEventCallback)}_browserMouseDownCallback(t){const{element:n}=this._enabledElement.viewport;this._canAutoPan=!!t.target?.closest(".advancedMagnifyTool"),document.addEventListener("mouseup",this._browserMouseUpCallback),n.removeEventListener("mouseup",this._cancelMouseEventCallback),n.removeEventListener("mousemove",this._cancelMouseEventCallback)}_mouseDragCallback(t){if(!U.isInteractingWithTool)return;const{_autoPan:n}=this;if(!n.enabled||!this._canAutoPan)return;const{currentPoints:e}=t.detail,{viewport:o}=this._enabledElement,{canvasToWorld:a}=o,{canvas:s}=e,{radius:r}=this,c=[r,r],l=Fn(c,s),d=r-n.padding;if(l<=d)return;const u=l-d,h=Kn(et(),s,c);yn(h,h),uo(h,h,u);const g=Re(et(),this.position,h),f=a(this.position),m=a(g),v=me(W(),m,f),p={points:{currentPosition:{canvas:this.position,world:f},newPosition:{canvas:g,world:m}},delta:{canvas:h,world:v}};n.callback(p)}_addBrowserEventListeners(t){document.addEventListener("mousedown",this._browserMouseDownCallback,!0),t.addEventListener("mousedown",this._cancelMouseEventCallback),t.addEventListener("mouseup",this._cancelMouseEventCallback),t.addEventListener("mousemove",this._cancelMouseEventCallback),t.addEventListener("dblclick",this._cancelMouseEventCallback)}_removeBrowserEventListeners(t){document.removeEventListener("mousedown",this._browserMouseDownCallback,!0),document.removeEventListener("mouseup",this._browserMouseUpCallback),t.removeEventListener("mousedown",this._cancelMouseEventCallback),t.removeEventListener("mouseup",this._cancelMouseEventCallback),t.removeEventListener("mousemove",this._cancelMouseEventCallback),t.removeEventListener("dblclick",this._cancelMouseEventCallback)}_addEventListeners(t){z.addEventListener(w.TOOL_MODE_CHANGED,this._handleToolModeChanged),t.addEventListener(w.MOUSE_MOVE,this._mouseDragCallback),t.addEventListener(w.MOUSE_DRAG,this._mouseDragCallback),this._addBrowserEventListeners(t)}_removeEventListeners(t){z.removeEventListener(w.TOOL_MODE_CHANGED,this._handleToolModeChanged),t.addEventListener(w.MOUSE_MOVE,this._mouseDragCallback),t.addEventListener(w.MOUSE_DRAG,this._mouseDragCallback),this._removeBrowserEventListeners(t)}_initialize(){const{_sourceEnabledElement:t}=this,{viewport:n}=t,{canvas:e}=n,o=this._createViewportNode();e.parentNode.appendChild(o),this._addEventListeners(o),this._cloneViewport(n,o),this._enabledElement=y(o)}_syncViewportsCameras(t,n){const e=t.canvasToWorld(this.position),o=this._convertZoomFactorToParallelScale(t,n,this.zoomFactor),{focalPoint:a,position:s,viewPlaneNormal:r}=n.getCamera(),c=Math.sqrt(Math.pow(a[0]-s[0],2)+Math.pow(a[1]-s[1],2)+Math.pow(a[2]-s[2],2)),l=[e[0],e[1],e[2]],d=[l[0]+c*r[0],l[1]+c*r[1],l[2]+c*r[2]];n.setCamera({parallelScale:o,focalPoint:l,position:d})}_syncStackViewports(t,n){n.setImageIdIndex(t.getCurrentImageIdIndex())}_syncViewports(){const{viewport:t}=this._sourceEnabledElement,{viewport:n}=this._enabledElement,e=t.getProperties();n.getImageData()&&(n.setProperties(e),this._syncViewportsCameras(t,n),this._isStackViewport(t)&&this._syncStackViewports(t,n),this._syncViewportsCameras(t,n),n.render())}_resizeViewport(){const{viewport:t}=this._enabledElement;t.getRenderingEngine().resize()}}rr.toolName="AdvancedMagnify";const{EPSILON:xc}=Qo;class cA extends ao{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceViewportId:"",enforceSameFrameOfReference:!0,showFullDimension:!1}}){super(t,n),this.editData=null,this._init=()=>{const o=Co()[0];if(!o)return;let a=o.getViewports();a=Lr(a,this.getToolName());const s=o.getViewport(this.configuration.sourceViewportId);if(!s?.getImageData())return;const{element:r}=s,{viewUp:c,viewPlaneNormal:l}=s.getCamera(),d=Hc(s);let u=this.editData?.annotation;const h=s.getFrameOfReferenceUID();if(u)this.editData.annotation.data.handles.points=d;else{const g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...l],viewUp:[...c],FrameOfReferenceUID:h,referencedImageId:null},data:{handles:{points:d}}};mt(g,r),u=g}this.editData={sourceViewportId:s.id,renderingEngine:o,annotation:u},L(a.filter(g=>g.id!==s.id).map(g=>g.id))},this.onSetToolEnabled=()=>{this._init()},this.onSetToolConfiguration=()=>{this._init()},this.onCameraModified=e=>{this._init()},this.renderAnnotation=(e,o)=>{const{viewport:a}=e;if(!this.editData)return!1;const{annotation:s,sourceViewportId:r}=this.editData;let c=!1;const{viewport:l}=At(r)||{};if(!l||l.id===a.id||!s||!s?.data?.handles?.points||this.configuration.enforceSameFrameOfReference&&l.getFrameOfReferenceUID()!==a.getFrameOfReferenceUID())return c;const d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},u=s.data.handles.points[0],h=s.data.handles.points[1],g=s.data.handles.points[2],f=s.data.handles.points[3],{focalPoint:m,viewPlaneNormal:v,viewUp:p}=a.getCamera(),{viewPlaneNormal:I}=l.getCamera();if(this.isParallel(v,I))return c;const C=po(v,m),E=[u,g,h,f],S=[u,h,g,f];let _=E,D=oe(W(),E[0],E[1]);D=Zt(W(),D);let b=oe(W(),E[2],E[0]);b=Zt(W(),b);const M=be(W(),D,b);if(this.isParallel(M,v))return c;this.isPerpendicular(D,v)&&(_=S);const P=Vs(_[0],_[1],C),T=Vs(_[2],_[3],C),{annotationUID:x}=s;d.annotationUID=x;const A=this.getStyle("lineWidth",d,s),O=this.getStyle("lineDash",d,s),R=this.getStyle("color",d,s),N=this.getStyle("shadow",d,s);let k=[P,T].map($=>a.worldToCanvas($));if(this.configuration.showFullDimension&&(k=this.handleFullDimension(a,P,v,p,T,k)),k.length<2)return c;const B=`${x}-line`;return Et(o,x,"1",k[0],k[1],{color:R,width:A,lineDash:O,shadow:N},B),c=!0,c},this.isPerpendicular=(e,o)=>{const a=dt(e,o);return Math.abs(a)<xc}}handleFullDimension(t,n,e,o,a,s){t.getRenderingEngine();const r=this.getTargetId(t),c=this.getTargetImageData(r),l=this.getReferencedImageId(t,n,e,o);if(l&&c)try{const{imageData:d,dimensions:u}=c,[h,g,f,m]=[d.indexToWorld([0,0,0]),d.indexToWorld([u[0]-1,0,0]),d.indexToWorld([u[0]-1,u[1]-1,0]),d.indexToWorld([0,u[1]-1,0])].map(I=>vu(l,I)),[v,p]=[n,a].map(I=>vu(l,I));s=[[h,g],[g,f],[m,f],[h,m]].map(([I,C])=>this.intersectInfiniteLines(I,C,v,p)).filter(I=>I&&this.isInBound(I,u)).map(I=>{const C=M0(l,I);return t.worldToCanvas(C)})}catch(d){console.log(d)}return s}intersectInfiniteLines(t,n,e,o){const[a,s]=t,[r,c]=n,[l,d]=e,[u,h]=o,g=c-s,f=a-r,m=r*s-a*c,v=h-d,p=l-u,I=u*d-l*h;if(Math.abs(g*p-v*f)<xc)return;const C=(f*I-p*m)/(g*p-v*f),E=(v*m-g*I)/(g*p-v*f);return[C,E]}isParallel(t,n){return Math.abs(dt(t,n))>1-xc}isInBound(t,n){return t[0]>=0&&t[0]<=n[0]&&t[1]>=0&&t[1]<=n[1]}}cA.toolName="ReferenceLines";const{EPSILON:Hh}=Qo;class lA extends ao{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceImageIds:[]}}){super(t,n),this.onSetToolEnabled=()=>{this._init()},this.onSetToolActive=()=>{this._init()},this._init=()=>{const e=this.configuration.sourceImageIds;if(!e?.length){console.warn("OverlayGridTool: No sourceImageIds provided in configuration");return}const o=ye("imagePlaneModule",e[0]);if(!o){console.warn("OverlayGridTool: No imagePlaneModule found for sourceImageIds");return}const{frameOfReferenceUID:a}=o,s=_e(this.toolGroupId).viewportsInfo;if(!s?.length){console.warn("OverlayGridTool: No viewports found");return}if(!Ct(this.getToolName(),a)?.length){const c=e.map(d=>this.calculateImageIdPointSets(d)),l={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),FrameOfReferenceUID:a,referencedImageId:null},data:{viewportData:new Map,pointSets:c}};mt(l,a)}L(s.map(({viewportId:c})=>c))},this.calculateImageIdPointSets=e=>{const{imagePositionPatient:o,rows:a,columns:s,rowCosines:r,columnCosines:c,rowPixelSpacing:l,columnPixelSpacing:d}=ye("imagePlaneModule",e),u=[...o],h=[...o],g=[...o],f=[...o];return Wt(h,o,c,s*d),Wt(g,o,r,a*l),Wt(f,g,c,s*d),{pointSet1:[u,g,h,f],pointSet2:[u,h,g,f]}},this.renderAnnotation=(e,o)=>{const a=this.configuration.sourceImageIds;let s=!1;if(!a?.length)return s;const{viewport:r,FrameOfReferenceUID:c}=e;if(r.getImageIds().length<2)return s;const d=Ct(this.getToolName(),c);if(!d?.length)return s;const u=d[0],{annotationUID:h}=u,{focalPoint:g,viewPlaneNormal:f}=r.getCamera(),m={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},v=this.getImageIdNormal(a[0]);if(this.isParallel(f,v))return s;const p=po(f,g),I=u.data.pointSets,C=u.data.viewportData;for(let E=0;E<a.length;E++){const{pointSet1:S,pointSet2:_}=I[E],D=C.get(r.id)||this.initializeViewportData(C,r.id);if(!D.pointSetsToUse[E]){let k=S,B=oe(W(),S[0],S[1]);B=Zt(W(),B),this.isPerpendicular(B,f)&&(k=_),D.pointSetsToUse[E]=k,D.lineStartsWorld[E]=Vs(k[0],k[1],p),D.lineEndsWorld[E]=Vs(k[2],k[3],p)}const b=D.lineStartsWorld[E],M=D.lineEndsWorld[E];m.annotationUID=h;const P=this.getStyle("lineWidth",m,u),T=this.getStyle("lineDash",m,u),x=this.getStyle("color",m,u),A=this.getStyle("shadow",m,u),O=[b,M].map(k=>r.worldToCanvas(k)),R=`${h}-line`,N=`${E}`;Et(o,h,N,O[0],O[1],{color:x,width:P,lineDash:T,shadow:A},R)}return s=!0,s},this.initializeViewportData=(e,o)=>(e.set(o,{pointSetsToUse:[],lineStartsWorld:[],lineEndsWorld:[]}),e.get(o)),this.isPerpendicular=(e,o)=>{const a=dt(e,o);return Math.abs(a)<Hh}}isParallel(t,n){return Math.abs(dt(t,n))>1-Hh}getImageIdNormal(t){const{imageOrientationPatient:n}=ye("imagePlaneModule",t),e=wt(n[0],n[1],n[2]),o=wt(n[3],n[4],n[5]);return be(W(),e,o)}}lA.toolName="OverlayGrid";class dA extends ao{constructor(t={},n={configuration:{opacity:.5}}){super(t,n),this._init=()=>{const e=_e(this.toolGroupId).viewportsInfo;if(!e?.length){console.warn(this.getToolName()+"Tool: No viewports found");return}const o=te(e[0].renderingEngineId)?.getViewport(e[0].viewportId);if(!o)return;const a=o.getFrameOfReferenceUID();if(!Ct(this.getToolName(),a)?.length){const r=new Map;uA(r,e);const c={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),FrameOfReferenceUID:a,referencedImageId:null},data:{actorsWorldPointsMap:r}};mt(c,a)}L(e.map(({viewportId:r})=>r))},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this._init()},this.renderAnnotation=(e,o)=>{const{viewport:a,FrameOfReferenceUID:s}=e;let r=!1;const c=Ct(this.getToolName(),s);if(!c?.length)return r;const l=c[0],{annotationUID:d}=l,u=l.data.actorsWorldPointsMap;DI(u,a);const h=a.getActors(),g=bI(a);return h.forEach(f=>{if(!f?.clippingFilter)return;const m=u.get(f.uid);if(!m||!m.get(g))return;let v=1;const{worldPointsSet:p,color:I}=m.get(g);for(let C=0;C<p.length;C++){const S=p[C].map(b=>a.worldToCanvas(b)),_={color:I,fillColor:I,fillOpacity:this.configuration.opacity,closePath:!0,lineWidth:2},D=f.uid+"#"+v;Jn(o,d,D,S,_),v++}}),r=!0,r}}}function uA(i,t){t.forEach(({viewportId:n,renderingEngineId:e})=>{const o=te(e)?.getViewport(n);DI(i,o)})}function DI(i,t){const n=t.getActors(),e=bI(t);n.forEach(o=>{if(!o?.clippingFilter)return;let a=i.get(o.uid);if(a||(a=new Map,i.set(o.uid,a)),!a.get(e)){const s=o.clippingFilter.getOutputData(),r=rI(s);if(!r)return;const c=o.actor.getProperty().getColor(),l=hA(c);a.set(e,{worldPointsSet:r,color:l})}})}function bI(i){const{viewPlaneNormal:t}=i.getCamera(),n=i.getCurrentImageIdIndex();return`${i.id}-${dv(t)}-${n}`}function hA(i){function t(n){let e=Math.floor(n*255).toString(16);return e.length===1&&(e="0"+e),e}return"#"+t(i[0])+t(i[1])+t(i[2])}dA.toolName="SegmentationIntersection";class gA extends ao{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,displayThreshold:5,positionSync:!0,disableCursor:!1}}){super(t,n),this.isDrawing=!1,this.isHandleOutsideImage=!1,this._elementWithCursor=null,this._currentCursorWorldPosition=null,this._currentCanvasPosition=null,this._disableCursorEnabled=!1,this.mouseMoveCallback=e=>{const{detail:o}=e,{element:a,currentPoints:s}=o;this._currentCursorWorldPosition=s.world,this._currentCanvasPosition=s.canvas,this._elementWithCursor=a;const r=this.getActiveAnnotation(a);return r===null?(this.createInitialAnnotation(s.world,a),!1):(this.updateAnnotationPosition(a,r),!1)},this.createInitialAnnotation=(e,o)=>{const a=y(o);if(!a)throw new Error("No enabled element found");const{viewport:s,renderingEngine:r}=a;this.isDrawing=!0;const c=s.getCamera(),{viewPlaneNormal:l,viewUp:d}=c;if(!l||!d)throw new Error("Camera not found");const u=this.getReferencedImageId(s,e,l,d),h=s.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...l],viewUp:[...d],FrameOfReferenceUID:h,referencedImageId:u},data:{label:"",handles:{points:[[...e]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}};if(Ct(this.getToolName(),o).length>0)return null;if(mt(g,o)===null)return;const v=Q(o,this.getToolName(),!1);L(v)},this.onCameraModified=e=>{const o=e.detail,{element:a,previousCamera:s,camera:r}=o,l=y(a).viewport;if(a!==this._elementWithCursor)return;const d=s.focalPoint,u=r.viewPlaneNormal,h=r.focalPoint,g=[0,0,0];if(st.subtract(h,d,g),g.reduce((v,p)=>v+p,0)===0)return;const f=st.dot(g,u);if(Math.abs(f)<.01||!this._currentCanvasPosition)return;const m=l.canvasToWorld(this._currentCanvasPosition);this._currentCursorWorldPosition=m,this.updateAnnotationPosition(a,this.getActiveAnnotation(a))},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s,FrameOfReferenceUID:r}=e,c=this._elementWithCursor===s.element;this.configuration.positionSync&&!c&&this.updateViewportImage(s);const{element:l}=s;let d=Ct(this.getToolName(),l);if(!d?.length||(d=this.filterInteractableAnnotationsForElement(l,d),!d?.length))return a;const u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let h=0;h<d.length;h++){const g=d[h],{annotationUID:f,data:m}=g,{handles:v}=m,{points:p}=v;if(!f)return a;u.annotationUID=f;const I=parseFloat(this.getStyle("lineWidth",u,g)),C=I,E=this.getStyle("lineDash",u,g),S=this.getStyle("color",u,g);if(p[0].some(x=>isNaN(x)))return a;const _=p.map(x=>s.worldToCanvas(x));if(!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;if(!re(f))continue;const D={upper:"upper",right:"right",lower:"lower",left:"left"},[b,M]=_[0],P=c?20:7,T=c?5:7;Et(o,f,D.upper,[b,M-(P/2+T)],[b,M-P/2],{color:S,lineDash:E,lineWidth:C}),Et(o,f,D.lower,[b,M+(P/2+T)],[b,M+P/2],{color:S,lineDash:E,lineWidth:C}),Et(o,f,D.right,[b+(P/2+T),M],[b+P/2,M],{color:S,lineDash:E,lineWidth:C}),Et(o,f,D.left,[b-(P/2+T),M],[b-P/2,M],{color:S,lineDash:E,lineWidth:C}),a=!0}return a},this._disableCursorEnabled=this.configuration.disableCursor}onSetToolActive(){if(this._disableCursorEnabled=this.configuration.disableCursor,!this._disableCursorEnabled)return;const t=_e(this.toolGroupId).viewportsInfo;if(!t)return;t.map(e=>Gt(e.viewportId,e.renderingEngineId)).forEach(e=>{e&&nt(e.viewport.element)})}onSetToolDisabled(){if(!this._disableCursorEnabled)return;const t=_e(this.toolGroupId).viewportsInfo;if(!t)return;t.map(e=>Gt(e.viewportId,e.renderingEngineId)).forEach(e=>{e&&ht(e.viewport.element)})}getActiveAnnotation(t){const n=Ct(this.getToolName(),t);return n.length?n[0]:null}updateAnnotationPosition(t,n){const e=this._currentCursorWorldPosition;if(!e||!n.data?.handles?.points)return;n.data.handles.points=[[...e]],n.invalidated=!0;const o=Q(t,this.getToolName(),!1);y(t)&&L(o)}filterInteractableAnnotationsForElement(t,n){if(!(n instanceof Array)||n.length===0)return[];const e=n[0],o=y(t)?.viewport;if(!o)return[];const a=o.getCamera(),{viewPlaneNormal:s,focalPoint:r}=a;if(!s||!r)return[];const c=e.data?.handles?.points;if(!(c instanceof Array)||c.length!==1)return[];const l=c[0],d=po(s,r);return Iu(d,l)<this.configuration.displayThreshold?[e]:[]}updateViewportImage(t){const n=this._currentCursorWorldPosition;if(!(!n||n.some(e=>isNaN(e)))){if(t instanceof Ie){const e=bg(n,t);if(e===null)return;e!==t.getCurrentImageIdIndex()&&t.setImageIdIndex(e)}else if(t instanceof ae){const{focalPoint:e,viewPlaneNormal:o}=t.getCamera();if(!e||!o)return;const a=po(o,e),s=Iu(a,n,!0);if(Math.abs(s)<.5)return;const r=Zt(W(),wt(...o)),c=hn(W(),r,s),l=je(W(),wt(...e),c);{t.setCamera({focalPoint:l});const d=t.getRenderingEngine();d&&d.renderViewport(t.id)}}}}}gA.toolName="ReferenceCursors";const zh=[];class fA extends ao{constructor(t={},n={configuration:{viewportId:"",scaleLocation:"bottom"}}){super(t,n),this.editData=null,this._init=()=>{const o=Co()[0];if(!o)return;const a=_e(this.toolGroupId).viewportsInfo;if(!a)return;const s=a.map(f=>Gt(f.viewportId,f.renderingEngineId));let{viewport:r}=s[0];const{FrameOfReferenceUID:c}=s[0];if(this.configuration.viewportId&&s.forEach(f=>{f.viewport.id==this.configuration.viewportId&&(r=f.viewport)}),!r)return;const{viewUp:l,viewPlaneNormal:d}=r.getCamera(),u=Hc(r);let h=this.editData?.annotation;const g=Ct(this.getToolName(),r.element);g.length&&(h=g.filter(f=>f.data?.viewportId==r.id)[0]),s.forEach(f=>{const{viewport:m}=f;if(!zh.includes(m.id)){const v={metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...l],FrameOfReferenceUID:c,referencedImageId:null},data:{handles:{points:Hc(m)},viewportId:m.id}};zh.push(m.id),mt(v,m.element),h=v}}),this.editData?.annotation&&this.editData.annotation.data.viewportId==r.id&&(this.editData.annotation.data.handles.points=u,this.editData.annotation.data.viewportId=r.id),this.editData={viewport:r,renderingEngine:o,annotation:h}},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this.configuration.viewportId=e.detail.viewportId,this._init()},this.computeScaleSize=(e,o,a)=>{const s=[16e3,8e3,4e3,2e3,1e3,500,250,100,50,25,10,5,2];let r;return a=="top"||a=="bottom"?r=s.filter(c=>c<e*.6&&c>e*.2):r=s.filter(c=>c<o*.6&&c>o*.2),r[0]},this.computeEndScaleTicks=(e,o)=>{const a={bottom:[[0,-10],[0,-10]],top:[[0,10],[0,10]],left:[[0,0],[10,0]],right:[[0,0],[-10,0]]},s=[[e[1][0]+a[o][0][0],e[1][1]+a[o][0][0]],[e[1][0]+a[o][1][0],e[1][1]+a[o][1][1]]],r=[[e[0][0]+a[o][0][0],e[0][1]+a[o][0][0]],[e[0][0]+a[o][1][0],e[0][1]+a[o][1][1]]];return{endTick1:s,endTick2:r}},this.computeInnerScaleTicks=(e,o,a,s,r)=>{let c;o=="bottom"||o=="top"?c=r[0][0]-s[0][0]:(o=="left"||o=="right")&&(c=r[0][1]-s[0][1]);const l=[],d=[],u=[];let h=e;e>=50&&(h=e/10);const g=c/h;for(let f=0;f<h-1;f++){const m={bottom:[[g*(f+1),0],[g*(f+1),5]],top:[[g*(f+1),0],[g*(f+1),-5]],left:[[0,g*(f+1)],[-5,g*(f+1)]],right:[[0,g*(f+1)],[5,g*(f+1)]]};l.push(`${a}-tick${f}`),d.push(`tick${f}`),(f+1)%5==0?u.push([[s[0][0]+m[o][0][0],s[0][1]+m[o][0][1]],[s[1][0]+m[o][0][0],s[1][1]+m[o][0][1]]]):u.push([[s[0][0]+m[o][0][0],s[0][1]+m[o][0][1]],[s[1][0]+m[o][1][0],s[1][1]+m[o][1][1]]])}return{tickIds:l,tickUIDs:d,tickCoordinates:u}},this.computeWorldScaleCoordinates=(e,o,a)=>{let s,r=oe(W(),a[0],a[1]);r=Zt(W(),r);let c=oe(W(),a[2],a[0]);c=Zt(W(),c);const l={bottom:[a[1],a[2]],top:[a[0],a[3]],right:[a[2],a[3]],left:[a[0],a[1]]},d=je(W(),l[o][0],l[o][0]).map(h=>h/2),u=e/2/Math.sqrt(Math.pow(r[0],2)+Math.pow(r[1],2)+Math.pow(r[2],2));return o=="top"||o=="bottom"?s=[oe(W(),d,c.map(h=>h*u)),je(W(),d,c.map(h=>h*u))]:(o=="left"||o=="right")&&(s=[je(W(),d,r.map(h=>h*u)),oe(W(),d,r.map(h=>h*u))]),s},this.computeCanvasScaleCoordinates=(e,o,a,s,r)=>{let c;if(r=="top"||r=="bottom"){const l=o[0][0]-o[1][0];c=[[e.width/2-l/2,a.height],[e.width/2+l/2,a.height]]}else if(r=="left"||r=="right"){const l=o[0][1]-o[1][1];c=[[s.width,e.height/2-l/2],[s.width,e.height/2+l/2]]}return c},this.computeScaleBounds=(e,o,a,s)=>{const r=o*Math.min(1e3,e.width),c=a*Math.min(1e3,e.height),l={bottom:[-c,-r],top:[c,r],left:[c,r],right:[-c,-r]},d={bottom:[e.height,e.width],top:[0,e.width],left:[e.height,0],right:[e.height,e.width]};return{height:d[s][0]+l[s][0],width:d[s][1]+l[s][1]}}}renderAnnotation(t,n){if(!this.editData||!this.editData.viewport)return;const e=this.configuration.scaleLocation,{viewport:o}=t,s=Ct(this.getToolName(),o.element).filter(K=>K.data?.viewportId==o.id)[0],r=t.viewport.canvas,c=!1;if(!o||!s)return c;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:t.viewport.id},d={width:r.width/window.devicePixelRatio||1,height:r.height/window.devicePixelRatio||1},u=s.data.handles.points[0],h=s.data.handles.points[1],g=s.data.handles.points[2],f=s.data.handles.points[3],m=[u,g,h,f],v=Te(g,f),p=Te(u,g),I=this.computeScaleBounds(d,.05,.05,e),C=this.computeScaleBounds(d,.05,.05,e),E=this.computeScaleSize(v,p,e),S=this.computeWorldScaleCoordinates(E,e,m).map(K=>o.worldToCanvas(K)),_=this.computeCanvasScaleCoordinates(d,S,C,I,e),D=this.computeEndScaleTicks(_,e),{annotationUID:b}=s;l.annotationUID=b;const M=this.getStyle("lineWidth",l,s),P=this.getStyle("lineDash",l,s),T=this.getStyle("color",l,s),x=this.getStyle("shadow",l,s),A=`${b}-scaleline`;Et(n,b,"1",_[0],_[1],{color:T,width:M,lineDash:P,shadow:x},A);const R=`${b}-left`;Et(n,b,"2",D.endTick1[0],D.endTick1[1],{color:T,width:M,lineDash:P,shadow:x},R);const k=`${b}-right`;Et(n,b,"3",D.endTick2[0],D.endTick2[1],{color:T,width:M,lineDash:P,shadow:x},k);const V={bottom:[-10,-42],top:[-12,-35],left:[-40,-20],right:[-50,-20]},$=[_[0][0]+V[e][0],_[0][1]+V[e][1]],H=this._getTextLines(E),{tickIds:G,tickUIDs:Y,tickCoordinates:q}=this.computeInnerScaleTicks(E,e,b,D.endTick1,D.endTick2);for(let K=0;K<Y.length;K++)Et(n,b,Y[K],q[K][0],q[K][1],{color:T,width:M,lineDash:P,shadow:x},G[K]);return eo(n,b,"text0",H,[$[0],$[1]],{fontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",fontSize:"14px",lineDash:"2,3",lineWidth:"1",shadow:!0,color:T}),c}_getTextLines(t){let n,e;return t>=50?(n=t/10,e=" cm"):(n=t,e=" mm"),[n.toString().concat(e)]}}fA.toolName="ScaleOverlay";const TI=(i,t,n)=>{if(!t?.data?.contour?.polyline?.length)return;const{polyline:e}=t.data.contour,{length:o}=e;let a=1/0;for(let s=0;s<o;s++){const r=i.worldToCanvas(e[s]),c=Fn(r,n);a=Math.min(a,c)}if(!(a===1/0||isNaN(a)))return a},nu=class nu{constructor(){this.toolInfo={toolSize:null,radius:null,maxToolSize:null}}renderShape(t,n,e){Ae(t,"SculptorTool","0",n,this.toolInfo.toolSize,e)}configureToolSize(t){const n=this.toolInfo;if(n.toolSize&&n.maxToolSize)return;const o=t.detail.element,s=Math.min(o.clientWidth,o.clientHeight)/24;n.toolSize=s,n.radius=null,n.maxToolSize=s}updateToolSize(t,n,e){const o=this.toolInfo,a=TI(n,e,t);a>0&&(o.toolSize=Math.min(o.maxToolSize,a),this.computeWorldRadius(n,!0))}getMaxSpacing(t){return Math.max(this.toolInfo.toolSize/4,t)}computeWorldRadius(t,n=!1){if(!this.toolInfo.radius||n){const e=t.canvasToWorld([0,0]),o=t.canvasToWorld([this.toolInfo.toolSize,0]);this.toolInfo.radius=We(me(W(),e,o))}return this.toolInfo.radius}getEdge(t,n,e,o){const a=je(W(),n,e||n);hn(a,a,.5);const s=t.worldToCanvas(a),r=Kn(et(),s,o),c=Math.atan2(r[1],r[0]),l=this.interpolatePoint(t,c,o),d=t.worldToCanvas(l);return{point:l,angle:c,canvasPoint:d}}interpolatePoint(t,n,e){const[o,a]=e,s=this.toolInfo.toolSize,r=Math.cos(n)*s,c=Math.sin(n)*s,l=[o+r,a+c];return t.canvasToWorld(l)}isInCursor(t,n){return Te(t,n)<this.toolInfo.radius}};nu.shapeName="Circle";let Ia=nu;const{isEqual:mA}=Rt;class pA extends de{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{minSpacing:1,referencedToolNames:["PlanarFreehandROI","PlanarFreehandContourSegmentationTool"],toolShape:"circle",referencedToolName:"PlanarFreehandROI"}}){super(t,n),this.registeredShapes=new Map,this.isActive=!1,this.commonData={activeAnnotationUID:null,viewportIdsToRender:[],isEditingOpenContour:!1,canvasLocation:void 0,external:!0,closed:!1},this.preMouseDownCallback=e=>{const o=e.detail,{element:a}=o;if(this.configureToolSize(e),this.selectFreehandTool(o),this.commonData.activeAnnotationUID!==null)return this.isActive=!0,nt(a),this.activateModify(a),!0},this.mouseMoveCallback=e=>{this.mode===Ot.Active?(this.configureToolSize(e),this.updateCursor(e)):this.commonData.canvasLocation=void 0},this.endCallback=e=>{const o=e.detail,{element:a}=o;this.isActive=!1,this.deactivateModify(a),ht(a);const s=this.getToolInstance(a);s.doneEditMemo?.();const c=this.filterSculptableAnnotationsForElement(a).find(l=>l.annotationUID===this.commonData.activeAnnotationUID);s.configuration.calculateStats&&(c.invalidated=!0),It(c,a,lt.HandlesUpdated)},this.dragCallback=e=>{const o=e.detail,a=o.element;this.updateCursor(e);const s=this.filterSculptableAnnotationsForElement(a),r=s.find(l=>l.annotationUID===this.commonData.activeAnnotationUID);if(!s?.length||!this.isActive)return;const c=r.data.contour.polyline;this.sculpt(o,c)},this.registerShapes(Ia.shapeName,Ia),this.setToolShape(this.configuration.toolShape)}registerShapes(t,n){const e=new n;this.registeredShapes.set(t,e)}sculpt(t,n){const e=this.configuration,o=t.element,a=y(o),{viewport:s}=a,r=this.registeredShapes.get(this.selectedShape);this.sculptData={mousePoint:t.currentPoints.world,mouseCanvasPoint:t.currentPoints.canvas,points:n,maxSpacing:r.getMaxSpacing(e.minSpacing),element:o,contours:[{annotationUID:this.commonData.activeAnnotationUID,points:n}]};const c=this.intersect(s,r);if(!c.length)return;const l=this.getContourSelections(c,n.length),{closed:d}=this.commonData;for(const u of l){const h=new Array,g=u[u.length-1];let f=d?g.relIndex:0,m;for(const v of u)v.isEnter?(yc(h,n,f,v.index),m=v):this.interpolatePoints(s,m,v,n,h),f=v.index;if(l.length>1&&ln(h.map(s.worldToCanvas))<0){console.warn("Skipping internal area");continue}!d&&f<n.length-1&&yc(h,n,f),n.splice(0,n.length),yc(n,h);return}}intersect(t,n){const{contours:e,mousePoint:o,mouseCanvasPoint:a}=this.sculptData,{closed:s}=this.commonData;n.computeWorldRadius(t);const r=new Array;for(const c of e){const{annotationUID:l,points:d}=c;let u=!1;const{length:h}=d;for(let g=0;g<=h;g++){const f=g%h,m=d[f],v=n.isInCursor(m,o);if(g===0){if(u=v,!s&&v){const I=n.getEdge(t,m,null,a);r.push({annotationUID:l,isEnter:v,index:g,point:I.point,angle:I.angle})}continue}if(f===0&&!s){if(u){const I=n.getEdge(t,d[h-1],null,a);r.push({annotationUID:l,isEnter:!1,index:h-1,point:I.point,angle:I.angle})}continue}if(u===v)continue;u=v;const p=n.getEdge(t,m,d[g-1],a);r.push({annotationUID:l,isEnter:v,index:g,point:p.point,angle:p.angle})}}return r}interpolatePoints(t,n,e,o,a){const{external:s,closed:r}=this.commonData,c=o[n.index%o.length],l=o[e.index%o.length],d=me(W(),l,c);if(mA(We(d),0))return;const u=this.registeredShapes.get(this.selectedShape),h=(n.angle+2*Math.PI)%(Math.PI*2),g=(e.angle+2*Math.PI)%(Math.PI*2);let f=g<h?g+2*Math.PI:g;const m=g>h?g-2*Math.PI:g;(s&&!r&&Math.abs(m-h)<Math.abs(f-h)||s&&r)&&(f=m);const v=Math.ceil(Math.abs(h-f)/.25);for(let p=0;p<=v;p++){const I=(h*(v-p)+p*f)/v;a.push(u.interpolatePoint(t,I,this.sculptData.mouseCanvasPoint))}}getContourSelections(t,n){const e=new Array,o=t.length/2;if(!o||t.length%2)return e;let a=Number.NEGATIVE_INFINITY;for(let s=0;s<o;s++){const r=this.findNext(t,a);if(!r){console.error("Couldnt' find an entry");continue}const c=this.findNext(t,r.angle,!1);if(!c){console.error("Couldn't find an exit for",r);continue}c.relIndex||=c.index<r.index?c.index+n:c.index,e.push([r,c])}e.sort((s,r)=>s[0].index-r[0].index);for(let s=0;s<e.length-1;){const r=e[s],c=this.findMergeable(e,r,s);c?r.push(...c):s++}return e.length>1&&console.warn("************* More than 1 result",e),e}findMergeable(t,n,e){const o=n[n.length-1];for(let a=e+1;a<t.length;a++){const[s]=t[a];if(s.index>=o.relIndex){const r=t[a];return t.splice(a,1),r}}}findNext(t,n,e=!0){if(t.length===1){const[r]=t;return t.splice(0,1),r}let o,a;for(let r=0;r<t.length;r++){const c=t[r];if(c.isEnter==e){const l=(c.angle-n+2*Math.PI)%(2*Math.PI);(!o||l<a)&&(o={i:r,intersection:c},a=l)}}if(!o){console.warn("Couldn't find an exit point for entry",JSON.stringify(t));return}t.splice(o.i,1);const{intersection:s}=o;return s}interpolatePointsWithinMaxSpacing(t,n,e,o){const{element:a}=this.sculptData,s=y(a),{viewport:r}=s,c=vA(t+1,n.length),l=r.worldToCanvas(n[t]),d=r.worldToCanvas(n[c]);Fn(l,d)>o&&e.push(t)}updateCursor(t){const n=t.detail,e=n.element,o=y(e),{viewport:a}=o;this.commonData.viewportIdsToRender=[a.id];const s=this.filterSculptableAnnotationsForElement(e);if(!s?.length)return;const r=s.find(c=>c.annotationUID===this.commonData.activeAnnotationUID);if(this.commonData.canvasLocation=n.currentPoints.canvas,this.isActive)r.highlighted=!0;else{const c=this.registeredShapes.get(this.selectedShape),l=n.currentPoints.canvas;c.updateToolSize(l,a,r)}L(this.commonData.viewportIdsToRender)}getToolInstance(t){const n=y(t),{renderingEngineId:e,viewportId:o}=n;return ne(o,e).getToolInstance(this.configuration.referencedToolName)}filterSculptableAnnotationsForElement(t){const{configuration:n}=this,e=[],o=this.getToolInstance(t);return n.referencedToolNames.forEach(a=>{const s=Ct(a,t);s&&e.push(...s)}),o.filterInteractableAnnotationsForElement(t,e)}configureToolSize(t){this.registeredShapes.get(this.selectedShape).configureToolSize(t)}selectFreehandTool(t){const n=this.getClosestFreehandToolOnElement(t);if(n===void 0)return;const e=xt(n);if(this.commonData.activeAnnotationUID=n,this.commonData.closed=e.data.contour.closed,this.commonData.external=!0,this.commonData.closed){const{element:o}=t,a=y(o),{viewport:s}=a,r=e.data.contour.polyline.map(l=>s.worldToCanvas(l)),c=t.currentPoints.canvas;this.commonData.external=!ke(r,c,{closed:!0})}}getClosestFreehandToolOnElement(t){const{element:n}=t,e=y(n),{viewport:o}=e,a=this.configuration,s=this.filterSculptableAnnotationsForElement(n);if(!s?.length)return;const r=t.currentPoints.canvas,c={distance:1/0,toolIndex:void 0,annotationUID:void 0};for(let l=0;l<s?.length;l++){if(s[l].isLocked||!s[l].isVisible)continue;const d=TI(o,s[l],r);d!==-1&&d<c.distance&&(c.distance=d,c.toolIndex=l,c.annotationUID=s[l].annotationUID)}return this.commonData.isEditingOpenContour=!s[c.toolIndex].data.contour.closed,a.referencedToolName=s[c.toolIndex].metadata.toolName,c.annotationUID}activateModify(t){const n=xt(this.commonData.activeAnnotationUID);this.getToolInstance(t).createMemo?.(t,n),t.addEventListener(w.MOUSE_UP,this.endCallback),t.addEventListener(w.MOUSE_CLICK,this.endCallback),t.addEventListener(w.MOUSE_DRAG,this.dragCallback),t.addEventListener(w.TOUCH_TAP,this.endCallback),t.addEventListener(w.TOUCH_END,this.endCallback),t.addEventListener(w.TOUCH_DRAG,this.dragCallback)}deactivateModify(t){t.removeEventListener(w.MOUSE_UP,this.endCallback),t.removeEventListener(w.MOUSE_CLICK,this.endCallback),t.removeEventListener(w.MOUSE_DRAG,this.dragCallback),t.removeEventListener(w.TOUCH_TAP,this.endCallback),t.removeEventListener(w.TOUCH_END,this.endCallback),t.removeEventListener(w.TOUCH_DRAG,this.dragCallback)}setToolShape(t){this.selectedShape=this.registeredShapes.get(t)??Ia.shapeName}renderAnnotation(t,n){const{viewport:e}=t,{element:o}=e,a=this.commonData.viewportIdsToRender;if(!this.commonData.canvasLocation||this.mode!==Ot.Active||!a.includes(e.id)||!this.filterSculptableAnnotationsForElement(o)?.length)return;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:t.viewport.id};let c=Ve("color",r,vn.Default,this.mode);this.isActive&&(c=Ve("color",r,vn.Highlighted,this.mode)),this.registeredShapes.get(this.selectedShape).renderShape(n,this.commonData.canvasLocation,{color:c})}}function yc(i,t,n=0,e=t.length){e<n&&(e=e+t.length);for(let o=n;o<e;o++)i.push(t[o%t.length])}const vA=(i,t)=>(i+t)%t;pA.toolName="SculptorTool";const IA={Z:[0,0,1]};class wA extends de{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{direction:IA.Z,rotateIncrementDegrees:30}}){super(t,n)}mouseWheelCallback(t){const{element:n,wheel:e}=t.detail,o=y(n),{viewport:a}=o,{direction:s,rotateIncrementDegrees:r}=this.configuration,c=a.getCamera(),{viewUp:l,position:d,focalPoint:u}=c,{direction:h}=e,[g,f,m]=u,[v,p,I]=s,C=h*(r*Math.PI)/180,E=[0,0,0],S=[0,0,0],_=[0,0,0],D=So(new Float32Array(16));Ai(D,D,[g,f,m]),Yo(D,D,C,[v,p,I]),Ai(D,D,[-g,-f,-m]),Se(E,d,D),Se(S,u,D),So(D),Yo(D,D,C,[v,p,I]),Se(_,l,D),a.setCamera({position:E,viewUp:_,focalPoint:S}),a.render()}}wA.toolName="VolumeRotateMouseWheel";const ba=class ba extends zt{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,getTextCallback:CA,changeTextCallback:EA,preventHandleOutsideImage:!1}}){super(t,n),this.isPointNearTool=(e,o,a,s)=>{const r=y(e),{viewport:c}=r,{annotationUID:l}=o,d=o.data.handles.points[0],u=c.worldToCanvas(d);if(jt(a,u)<s)return!0;const g=e.querySelector("svg");if(!g)return!1;const f=g.querySelector(`g[data-annotation-uid="${l}"]`);if(!f)return!1;const m=f,v=m.getBBox(),p=m.getAttribute("transform");let I=0,C=0;if(p){const D=p.match(/translate\(([-\d.]+)\s+([-\d.]+)\)/);D&&(I=parseFloat(D[1]),C=parseFloat(D[2]))}const E=v.x+I,S=v.y+C;return a[0]>=E&&a[0]<=E+v.width&&a[1]>=S&&a[1]<=S+v.height},this.addNewAnnotation=e=>{const o=e.detail,{currentPoints:a,element:s}=o,r=a.world;nt(s),this.isDrawing=!0;const c=this.createAnnotation(e,[[...r],[...r]]);mt(c,s);const l=Q(s,this.getToolName());return this.editData={annotation:c,newAnnotation:!0,viewportIdsToRender:l,offset:[0,0,0]},e.preventDefault(),L(l),this.configuration.getTextCallback(d=>{if(!d){ft(c.annotationUID),L(l),this.isDrawing=!1;return}ht(s),c.data.label=d,Lt(c),L(l)}),this.createMemo(s,c,{newAnnotation:!0}),c},this.toolSelectedCallback=(e,o)=>{const a=e.detail,{element:s,currentPoints:r}=a;o.highlighted=!0;const c=Q(s,this.getToolName());let l=[0,0,0];if(r&&r.world){const d=r.world,u=o.data.handles.points[0];l=[u[0]-d[0],u[1]-d[1],u[2]-d[2]]}this.editData={annotation:o,viewportIdsToRender:c,offset:l},this._activateModify(s),nt(s),L(c),e.preventDefault()},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c}=this.editData;this._deactivateDraw(a),this._deactivateModify(a),ht(a),c&&this.createMemo(a,s,{newAnnotation:c}),this.editData=null,this.isDrawing=!1,this.doneEditMemo(),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(s.annotationUID),L(r),c&&Lt(s)},this._dragCallback=e=>{const o=e.detail,{currentPoints:a,element:s}=o,r=a.world,{annotation:c,viewportIdsToRender:l,offset:d}=this.editData;d?c.data.handles.points[0]=[r[0]+d[0],r[1]+d[1],r[2]+d[2]]:c.data.handles.points[0]=[...r],c.invalidated=!0,L(l),It(c,s,lt.LabelChange)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateModify(e),ht(e);const{annotation:o,viewportIdsToRender:a,newAnnotation:s}=this.editData,{data:r}=o;return o.highlighted=!1,r.handles.activeHandleIndex=null,L(a),s&&Lt(o),this.editData=null,o.annotationUID}},this._activateModify=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_END,this._endCallback)},this._activateDraw=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_MOVE,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_MOVE,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e,{element:r}=s;let c=Ct(this.getToolName(),r);if(!c?.length)return a;c=this.filterInteractableAnnotationsForElement(r,c);const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let d=0;d<c.length;d++){const u=c[d],{annotationUID:h,data:g}=u,f=g.handles.points[0];l.annotationUID=h;const m=s.worldToCanvas(f);if(a=!0,!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;if(!re(h)||!g.label)continue;const v=this.getLinkedTextBoxStyle(l,u);eo(o,h,"1",[g.label],m,{...v,padding:0})}return a}}handleSelectedCallback(t,n,e,o){}_doneChangingTextCallback(t,n,e){n.data.label=e;const o=Q(t,this.getToolName());L(o),It(n,t)}_isInsideVolume(t,n,e){return we(t,e)&&we(n,e)}};ba.toolName="Label",ba.hydrate=(t,n,e,o)=>{const a=At(t);if(!a)return;const{viewport:s}=a,r=s.getFrameOfReferenceUID(),{viewPlaneNormal:c,viewUp:l}=s.getCamera(),d=new ba,u=d.getReferencedImageId(s,n,c,l),h={annotationUID:o?.annotationUID||Xt(),data:{label:e,handles:{points:[n]}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:d.getToolName(),viewPlaneNormal:c,FrameOfReferenceUID:r,referencedImageId:u,...o}};mt(h,s.element),L([s.id])};let Il=ba;function CA(i){return i(prompt("Enter your annotation:"))}function EA(i,t,n){return n(prompt("Enter your annotation:"))}Il.toolName="Label";const ho=class ho extends zt{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:SA,actions:{undo:{method:"undo",bindings:[{key:"z"}]},redo:{method:"redo",bindings:[{key:"y"}]}}}}){super(t,n),this.addNewAnnotation=e=>{const o=e.detail,{currentPoints:a,element:s}=o,r=a.world;nt(s),this.isDrawing=!0;const c=this.createAnnotation(e,[[...r],[...r]]);mt(c,s);const l=Q(s,this.getToolName());return this.editData={annotation:c,viewportIdsToRender:l,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(s),e.preventDefault(),L(l),c},this.isPointNearTool=(e,o,a,s)=>{const r=y(e),{viewport:c}=r,{data:l}=o,[d,u]=l.handles.points,h=c.worldToCanvas(d),g=c.worldToCanvas(u),f={start:{x:h[0],y:h[1]},end:{x:g[0],y:g[1]}};return fe([f.start.x,f.start.y],[f.end.x,f.end.y],[a[0],a[1]])<=s},this.toolSelectedCallback=(e,o)=>{const a=e.detail,{element:s}=a;o.highlighted=!0;const r=Q(s,this.getToolName());this.editData={annotation:o,viewportIdsToRender:r,movingTextBox:!1},this._activateModify(s),nt(s),L(r),e.preventDefault()},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c,hasMoved:l}=this.editData,{data:d}=s;c&&!l||(d.handles.activeHandleIndex=null,this._deactivateModify(a),this._deactivateDraw(a),ht(a),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(s.annotationUID),L(r),this.doneEditMemo(),c&&Lt(s),this.editData=null,this.isDrawing=!1)},this._dragCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,handleIndex:c,movingTextBox:l,newAnnotation:d}=this.editData,{data:u}=s;if(this.createMemo(a,s,{newAnnotation:d}),l){const{deltaPoints:h}=o,g=h.world,{textBox:f}=u.handles,{worldPosition:m}=f;m[0]+=g[0],m[1]+=g[1],m[2]+=g[2],f.hasMoved=!0}else if(c===void 0){const{deltaPoints:h}=o,g=h.world;u.handles.points.forEach(m=>{m[0]+=g[0],m[1]+=g[1],m[2]+=g[2]}),s.invalidated=!0}else{const{currentPoints:h}=o,g=h.world;u.handles.points[c]=[...g],s.invalidated=!0}this.editData.hasMoved=!0,L(r),s.invalidated&&It(s,a,lt.HandlesUpdated)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),ht(e);const{annotation:o,viewportIdsToRender:a,newAnnotation:s}=this.editData,{data:r}=o;return o.highlighted=!1,r.handles.activeHandleIndex=null,L(a),s&&Lt(o),this.editData=null,o.annotationUID}},this._activateModify=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_MOVE,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_MOVE,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e,{element:r}=s;let c=Ct(this.getToolName(),r);if(!c?.length||(c=this.filterInteractableAnnotationsForElement(r,c),!c?.length))return a;const l=this.getTargetId(s),d=s.getRenderingEngine(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let h=0;h<c.length;h++){const g=c[h],{annotationUID:f,data:m}=g,{points:v,activeHandleIndex:p}=m.handles;u.annotationUID=f;const{color:I,lineWidth:C,lineDash:E,shadow:S}=this.getAnnotationStyle({annotation:g,styleSpecifier:u}),_=v.map($=>s.worldToCanvas($));if(!m.cachedStats[l]||m.cachedStats[l].unit==null?(m.cachedStats[l]={length:null,unit:null},this._calculateCachedStats(g,d,e)):g.invalidated&&this._throttledCalculateCachedStats(g,d,e),!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;let D;if(!re(f))continue;!se(f)&&!this.editData&&p!==null&&(D=[_[p]]);const b=!!Ve("showHandlesAlways",{});(D||b)&&$t(o,f,"0",_,{color:I,lineDash:E,lineWidth:C});const M=`${f}-line`;if(Et(o,f,"1",_[0],_[1],{color:I,width:C,lineDash:E,shadow:S},M),a=!0,!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;const T=this.getLinkedTextBoxStyle(u,g);if(!T.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const x=this.configuration.getTextLines(m,l);if(!m.handles.textBox.hasMoved){const $=qe(_);m.handles.textBox.worldPosition=s.canvasToWorld($)}const A=s.worldToCanvas(m.handles.textBox.worldPosition),R=Oe(o,f,"1",x,A,_,{},T),{x:N,y:k,width:B,height:V}=R;m.handles.textBox.worldBoundingBox={topLeft:s.canvasToWorld([N,k]),topRight:s.canvasToWorld([N+B,k]),bottomLeft:s.canvasToWorld([N,k+V]),bottomRight:s.canvasToWorld([N+B,k+V])}}return a},this._throttledCalculateCachedStats=Fe(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(t,n,e){const o=t.detail,{element:a}=o,{data:s}=n;n.highlighted=!0;let r=!1,c;e.worldPosition?r=!0:c=s.handles.points.findIndex(d=>d===e);const l=Q(a,this.getToolName());this.editData={annotation:n,viewportIdsToRender:l,handleIndex:c,movingTextBox:r},this._activateModify(a),nt(a),L(l),t.preventDefault()}_calculateCachedStats(t,n,e){const o=t.data,{element:a}=e.viewport,{cachedStats:s}=o,r=Object.keys(s);for(let l=0;l<r.length;l++){const d=r[l],u=this.getTargetImageData(d);if(!u)continue;const{imageData:h,dimensions:g}=u,f=o.handles.points.map(C=>h.worldToIndex(C)),m=nn(u,f),{unit:v}=m,p=ho.calculateLengthInIndex(m,f);this.isHandleOutsideImage=!ho.isInsideVolume(g,f);const I={name:"length",value:p,unit:v,type:rn.Linear};s[d]={length:p,unit:v,statsArray:[I]}}const c=t.invalidated;return t.invalidated=!1,c&&It(t,a,lt.StatsUpdated),s}};ho.toolName="Length",ho.hydrate=(t,n,e)=>{const o=At(t);if(!o)return;const{FrameOfReferenceUID:a,referencedImageId:s,viewPlaneNormal:r,instance:c,viewport:l}=ho.hydrateBase(ho,o,n,e),{toolInstance:d,...u}=e||{},h={annotationUID:e?.annotationUID||Xt(),data:{handles:{points:n}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:c.getToolName(),viewPlaneNormal:r,FrameOfReferenceUID:a,referencedImageId:s,...u}};mt(h,l.element),L([l.id])};let jh=ho;function SA(i,t){const n=i.cachedStats[t],{length:e,unit:o}=n;return e==null||isNaN(e)?void 0:[`${_t(e)} ${o}`]}const{transformWorldToIndex:Xh}=Rt,ou=class ou extends zt{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:_A}}){super(t,n),this.addNewAnnotation=e=>{const o=e.detail,{currentPoints:a,element:s}=o,r=a.world;nt(s),this.isDrawing=!0;const c=this.createAnnotation(e,[[...r],[...r]]);mt(c,s);const l=Q(s,this.getToolName());return this.editData={annotation:c,viewportIdsToRender:l,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(s),e.preventDefault(),L(l),c},this.isPointNearTool=(e,o,a,s)=>{const r=y(e),{viewport:c}=r,{data:l}=o,[d,u]=l.handles.points,h=c.worldToCanvas(d),g=c.worldToCanvas(u),f={start:{x:h[0],y:h[1]},end:{x:g[0],y:g[1]}};return fe([f.start.x,f.start.y],[f.end.x,f.end.y],[a[0],a[1]])<=s},this.toolSelectedCallback=(e,o)=>{const a=e.detail,{element:s}=a;o.highlighted=!0;const r=Q(s,this.getToolName());this.editData={annotation:o,viewportIdsToRender:r,movingTextBox:!1},this._activateModify(s),nt(s),y(s),L(r),e.preventDefault()},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c,hasMoved:l}=this.editData,{data:d}=s;if(c&&!l)return;d.handles.activeHandleIndex=null,this._deactivateModify(a),this._deactivateDraw(a),ht(a);const u=y(a),{renderingEngine:h}=u;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(s.annotationUID),L(r),this.doneEditMemo(),c&&Lt(s),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,handleIndex:c,movingTextBox:l,newAnnotation:d}=this.editData,{data:u}=s;if(this.createMemo(a,s,{newAnnotation:d}),l){const{deltaPoints:f}=o,m=f.world,{textBox:v}=u.handles,{worldPosition:p}=v;p[0]+=m[0],p[1]+=m[1],p[2]+=m[2],v.hasMoved=!0}else if(c===void 0){const{deltaPoints:f}=o,m=f.world;u.handles.points.forEach(p=>{p[0]+=m[0],p[1]+=m[1],p[2]+=m[2]}),s.invalidated=!0}else{const{currentPoints:f}=o,m=f.world;u.handles.points[c]=[...m],s.invalidated=!0}this.editData.hasMoved=!0;const h=y(a),{renderingEngine:g}=h;L(r)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),ht(e);const{annotation:o,viewportIdsToRender:a,newAnnotation:s}=this.editData,{data:r}=o;return o.highlighted=!1,r.handles.activeHandleIndex=null,y(e),L(a),s&&Lt(o),this.editData=null,o.annotationUID}},this._activateModify=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_MOVE,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_MOVE,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e,{element:r}=s;let c=Ct(this.getToolName(),r);if(!c?.length||(c=this.filterInteractableAnnotationsForElement(r,c),!c?.length))return a;const l=this.getTargetId(s),d=s.getRenderingEngine(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let h=0;h<c.length;h++){const g=c[h],{annotationUID:f,data:m}=g,{points:v,activeHandleIndex:p}=m.handles;u.annotationUID=f;const{color:I,lineWidth:C,lineDash:E,shadow:S}=this.getAnnotationStyle({annotation:g,styleSpecifier:u}),_=v.map(V=>s.worldToCanvas(V));let D;if(!m.cachedStats[l]||m.cachedStats[l].unit==null?(m.cachedStats[l]={length:null,unit:null},this._calculateCachedStats(g,d,e)):g.invalidated&&this._throttledCalculateCachedStats(g,d,e),!re(f))continue;!se(f)&&!this.editData&&p!==null&&(D=[_[p]]);const b=!!Ve("showHandlesAlways",{});if((D||b)&&$t(o,f,"0",_,{color:I,lineDash:E,lineWidth:C}),mm(o,f,"0",_[0],_[1],{color:I,width:C,lineDash:E}),a=!0,!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;const P=this.getLinkedTextBoxStyle(u,g);if(!P.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const T=this.configuration.getTextLines(m,l);if(!m.handles.textBox.hasMoved){const V=qe(_);m.handles.textBox.worldPosition=s.canvasToWorld(V)}const x=s.worldToCanvas(m.handles.textBox.worldPosition),O=Oe(o,f,"1",T,x,_,{},P),{x:R,y:N,width:k,height:B}=O;m.handles.textBox.worldBoundingBox={topLeft:s.canvasToWorld([R,N]),topRight:s.canvasToWorld([R+k,N]),bottomLeft:s.canvasToWorld([R,N+B]),bottomRight:s.canvasToWorld([R+k,N+B])}}return a},this._throttledCalculateCachedStats=Fe(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(t,n,e){const o=t.detail,{element:a}=o,{data:s}=n;n.highlighted=!0;let r=!1,c;e.worldPosition?r=!0:c=s.handles.points.findIndex(h=>h===e);const l=Q(a,this.getToolName());this.editData={annotation:n,viewportIdsToRender:l,handleIndex:c,movingTextBox:r},this._activateModify(a),nt(a);const d=y(a),{renderingEngine:u}=d;L(l),t.preventDefault()}_calculateHeight(t,n){const e=n[0]-t[0],o=n[1]-t[1],a=n[2]-t[2];if(e==0)return o!=0?Math.abs(a):0;if(o==0)return Math.abs(a);if(a==0)return Math.abs(o)}_calculateCachedStats(t,n,e){const o=t.data,{element:a}=e.viewport,s=o.handles.points[0],r=o.handles.points[1],{cachedStats:c}=o,l=Object.keys(c);for(let u=0;u<l.length;u++){const h=l[u],g=this.getTargetImageData(h);if(!g)continue;const{imageData:f,dimensions:m}=g,v=Xh(f,s),p=Xh(f,r),I=[v,p],{scale:C,unit:E}=nn(g,I),S=this._calculateHeight(s,r)/C,_=this._isInsideVolume(v,p,m);this.isHandleOutsideImage=_,c[h]={height:S,unit:E}}const d=t.invalidated;return t.invalidated=!1,d&&It(t,a,lt.StatsUpdated),c}_isInsideVolume(t,n,e){return we(t,e)&&we(n,e)}};ou.toolName="Height";let Yh=ou;function _A(i,t){const n=i.cachedStats[t],{height:e,unit:o}=n;return e==null||isNaN(e)?void 0:[`${_t(e)} ${o}`]}const{transformWorldToIndex:DA}=Rt,go=class go extends zt{constructor(t={},n){super(t,zt.mergeDefaultProps(go.probeDefaults,n)),this.addNewAnnotation=e=>{const o=e.detail,{currentPoints:a,element:s}=o,r=a.world,c=y(s),{viewport:l}=c;this.isDrawing=!0;const d=this.constructor.createAnnotationForViewport(l,{data:{handles:{points:[[...r]]}}});mt(d,s);const u=Q(s,this.getToolName());return this.editData={annotation:d,newAnnotation:!0,viewportIdsToRender:u},this._activateModify(s),nt(s),e.preventDefault(),L(u),d},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c}=this.editData,{viewportId:l,renderingEngine:d}=y(a);this.eventDispatchDetail={viewportId:l,renderingEngineId:d.id},this._deactivateModify(a),ht(a),c&&this.createMemo(a,s,{newAnnotation:c}),this.editData=null,this.isDrawing=!1,this.doneEditMemo(),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(s.annotationUID),L(r),c&&Lt(s)},this._dragCallback=e=>{this.isDrawing=!0;const o=e.detail,{currentPoints:a,element:s}=o,r=a.world,{annotation:c,viewportIdsToRender:l,newAnnotation:d}=this.editData,{data:u}=c;this.createMemo(s,c,{newAnnotation:d}),u.handles.points[0]=[...r],c.invalidated=!0,L(l)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateModify(e),ht(e);const{annotation:o,viewportIdsToRender:a,newAnnotation:s}=this.editData,{data:r}=o;return o.highlighted=!1,r.handles.activeHandleIndex=null,L(a),s&&Lt(o),this.editData=null,o.annotationUID}},this._activateModify=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e,{element:r}=s;let c=Ct(this.getToolName(),r);if(!c?.length||(c=this.filterInteractableAnnotationsForElement(r,c),!c?.length))return a;const l=this.getTargetId(s),d=s.getRenderingEngine(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let h=0;h<c.length;h++){const g=c[h],f=g.annotationUID,m=g.data,v=m.handles.points[0],p=s.worldToCanvas(v);u.annotationUID=f;const{color:I,lineWidth:C}=this.getAnnotationStyle({annotation:g,styleSpecifier:u});if(m.cachedStats||(m.cachedStats={}),!m.cachedStats[l]||m.cachedStats[l].value===null)m.cachedStats[l]={Modality:null,index:null,value:null},this._calculateCachedStats(g,d,e,lt.StatsUpdated);else if(g.invalidated&&(this._calculateCachedStats(g,d,e),s instanceof ae)){const{referencedImageId:D}=g.metadata;for(const b in m.cachedStats)b.startsWith("imageId")&&d.getStackViewports().find(T=>{const x=Je(D),A=T.hasImageURI(x),O=Je(T.getCurrentImageId());return A&&O!==x})&&delete m.cachedStats[b]}if(!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;if(!re(f))continue;$t(o,f,"0",[p],{color:I,lineWidth:C,handleRadius:this.configuration.handleRadius}),a=!0;const S=this.getLinkedTextBoxStyle(u,g);if(!S.visibility)continue;const _=this.configuration.getTextLines(m,l);if(_){const D=[p[0]+this.configuration.textCanvasOffset.x,p[1]+this.configuration.textCanvasOffset.y];eo(o,f,"0",_,[D[0],D[1]],S)}}return a}}isPointNearTool(t,n,e,o){const a=y(t),{viewport:s}=a,{data:r}=n,c=r.handles.points[0],l=s.worldToCanvas(c);return jt(e,l)<o}toolSelectedCallback(){}getHandleNearImagePoint(t,n,e,o){const a=y(t),{viewport:s}=a,{data:r}=n,c=r.handles.points[0],l=s.worldToCanvas(c);if(jt(e,l)<o===!0)return c}handleSelectedCallback(t,n){const e=t.detail,{element:o}=e;n.highlighted=!0;const a=Q(o,this.getToolName());this.editData={annotation:n,viewportIdsToRender:a},this._activateModify(o),nt(o),L(a),t.preventDefault()}_calculateCachedStats(t,n,e,o=lt.StatsUpdated){const a=t.data,{renderingEngineId:s,viewport:r}=e,{element:c}=r,l=a.handles.points[0],{cachedStats:d}=a,u=Object.keys(d);for(let g=0;g<u.length;g++){const f=u[g],m={isPreScaled:io(r,f),isSuvScaled:this.isSuvScaled(r,f,t.metadata.referencedImageId)},v=this.getTargetImageData(f);if(!v)continue;const{dimensions:p,imageData:I,metadata:C,voxelManager:E}=v,S=C.Modality;let _=DA(I,l);if(_=x0(_,_),we(_,p)){this.isHandleOutsideImage=!1;let D=E.getAtIJKPoint(_);if(f.startsWith("imageId:")){const M=f.split("imageId:")[1],P=Je(M),x=Wc(P)[0];_[2]=x.getCurrentImageIdIndex()}let b;if(S==="US"){const M=Zs(v,[_]),P=M.values.every(T=>T!==null);D=P?M.values:D,b=P?M.units:"raw"}else b=so(S,t.metadata.referencedImageId,m);d[f]={index:_,value:D,Modality:S,modalityUnit:b},t.invalidated=!0}else this.isHandleOutsideImage=!0,d[f]={index:_,Modality:S}}const h=t.invalidated;return t.invalidated=!1,h&&It(t,c,o),d}};go.toolName="Probe",go.probeDefaults={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:bA,handleRadius:"6",textCanvasOffset:{x:6,y:-6}}},go.hydrate=(t,n,e)=>{const o=At(t);if(!o)return;const{FrameOfReferenceUID:a,referencedImageId:s,viewPlaneNormal:r,viewUp:c,instance:l,viewport:d}=go.hydrateBase(go,o,n,e),{toolInstance:u,...h}=e||{},g={annotationUID:e?.annotationUID||Xt(),data:{handles:{points:n}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:l.getToolName(),viewPlaneNormal:r,FrameOfReferenceUID:a,referencedImageId:s,...h}};mt(g,d.element),L([d.id])};let wl=go;function bA(i,t){const n=i.cachedStats[t],{index:e,value:o,modalityUnit:a}=n;if(o===void 0||!e)return;const s=[];if(s.push(`(${e[0]}, ${e[1]}, ${e[2]})`),o instanceof Array&&a instanceof Array)for(let r=0;r<o.length;r++)s.push(`${_t(o[r])} ${a[r]}`);else s.push(`${_t(o)} ${a}`);return s}const iu=class iu extends wl{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:TA}}){super(t,n),this.postMouseDownCallback=e=>{const o=e.detail,{currentPoints:a,element:s}=o,r=a.world,c=y(s),{viewport:l,renderingEngine:d}=c;this.isDrawing=!0;const u=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=u,f=this.getReferencedImageId(l,r,h,g),m={invalidated:!0,highlighted:!0,isVisible:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:f},data:{label:"",handles:{points:[[...r]]},cachedStats:{}}},v=Q(s,this.getToolName());return this.editData={annotation:m,newAnnotation:!0,viewportIdsToRender:v},this._activateModify(s),nt(s),e.preventDefault(),L(v),m},this.postTouchStartCallback=e=>this.postMouseDownCallback(e),this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e;if(!this.editData||!this.filterInteractableAnnotationsForElement(s.element,[this.editData.annotation])?.length)return a;const c=this.getTargetId(s),l=s.getRenderingEngine(),d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},u=this.editData.annotation,h=u.annotationUID,g=u.data,f=g.handles.points[0],m=s.worldToCanvas(f);d.annotationUID=h;const{color:v}=this.getAnnotationStyle({annotation:u,styleSpecifier:d});if(!g.cachedStats[c]||g.cachedStats[c].value===null?(g.cachedStats[c]={Modality:null,index:null,value:null},this._calculateCachedStats(u,l,e)):u.invalidated&&this._calculateCachedStats(u,l,e),!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;$t(o,h,"0",[m],{color:v}),a=!0;const I=this.configuration.getTextLines(g,c);if(I){const C=[m[0]+6,m[1]-6];eo(o,h,"0",I,[C[0],C[1]],this.getLinkedTextBoxStyle(d,u))}return a}}};iu.toolName="DragProbe";let qh=iu;function TA(i,t){const n=i.cachedStats[t],{index:e,value:o,modalityUnit:a}=n;if(o===void 0)return;const s=[];return s.push(`(${e[0]}, ${e[1]}, ${e[2]})`),s.push(`${o.toFixed(2)} ${a}`),s}const{transformWorldToIndex:Kh}=Rt,Ci=class Ci extends zt{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,storePointData:!1,centerPointRadius:0,calculateStats:!0,getTextLines:PA,statsCalculator:Un}}){super(t,n),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const o=e.detail,{currentPoints:a,element:s}=o,r=a.world;this.isDrawing=!0;const c=this.createAnnotation(e,[[...r],[...r],[...r],[...r]]);mt(c,s);const l=Q(s,this.getToolName());return this.editData={annotation:c,viewportIdsToRender:l,centerWorld:r,newAnnotation:!0,hasMoved:!1},this._activateDraw(s),nt(s),e.preventDefault(),L(l),c},this.isPointNearTool=(e,o,a,s)=>{const r=y(e),{viewport:c}=r,{data:l}=o,{points:d}=l.handles,u=d.map(b=>c.worldToCanvas(b)),[h,g,f,m]=u,v=Math.hypot(f[0]-m[0],f[1]-m[1]),p=Math.hypot(g[0]-h[0],g[1]-h[1]),I=Math.atan2(f[1]-m[1],f[0]-m[0]),C=[(f[0]+m[0])/2,(g[1]+h[1])/2],E={center:C,xRadius:(v-s)/2,yRadius:(p-s)/2,angle:I},S={center:C,xRadius:(v+s)/2,yRadius:(p+s)/2,angle:I},_=this._pointInEllipseCanvas(E,a);return!!(this._pointInEllipseCanvas(S,a)&&!_)},this.toolSelectedCallback=(e,o)=>{const a=e.detail,{element:s}=a;o.highlighted=!0;const r=Q(s,this.getToolName());this.editData={annotation:o,viewportIdsToRender:r,movingTextBox:!1},nt(s),this._activateModify(s);const c=y(s),{renderingEngine:l}=c;L(r),e.preventDefault()},this.handleSelectedCallback=(e,o,a)=>{const s=e.detail,{element:r}=s,{data:c}=o;o.highlighted=!0;let l=!1,d,u,h,g,f,m;if(a.worldPosition)l=!0;else{const{points:p}=c.handles,{viewport:I}=y(r),{worldToCanvas:C,canvasToWorld:E}=I;d=p.findIndex(_=>_===a);const S=p.map(C);m=S[d],g=Math.abs(S[2][0]-S[3][0]),f=Math.abs(S[0][1]-S[1][1]),u=[(S[2][0]+S[3][0])/2,(S[0][1]+S[1][1])/2],h=E(u)}const v=Q(r,this.getToolName());this.editData={annotation:o,viewportIdsToRender:v,handleIndex:d,canvasWidth:g,canvasHeight:f,centerWorld:h,originalHandleCanvas:m,movingTextBox:l},this._activateModify(r),nt(r),L(v),e.preventDefault()},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c,hasMoved:l}=this.editData,{data:d}=s;c&&!l||(this.doneEditMemo(),s.highlighted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(a),this._deactivateDraw(a),ht(a),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(s.annotationUID),L(r),c&&Lt(s))},this._dragDrawCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{currentPoints:s}=o,r=s.canvas,c=y(a),{viewport:l}=c,{canvasToWorld:d}=l,{annotation:u,viewportIdsToRender:h,centerWorld:g,newAnnotation:f}=this.editData;this.createMemo(a,u,{newAnnotation:f});const m=l.worldToCanvas(g),{data:v}=u,p=Math.abs(r[0]-m[0]),I=Math.abs(r[1]-m[1]),C=[m[0],m[1]-I],E=[m[0],m[1]+I],S=[m[0]-p,m[1]],_=[m[0]+p,m[1]];v.handles.points=[d(C),d(E),d(S),d(_)],u.invalidated=!0,this.editData.hasMoved=!0,L(h),It(u,a,lt.HandlesUpdated)},this._dragModifyCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,handleIndex:c,movingTextBox:l,newAnnotation:d}=this.editData;this.createMemo(a,s,{newAnnotation:d});const{data:u}=s;if(l){const{deltaPoints:f}=o,m=f.world,{textBox:v}=u.handles,{worldPosition:p}=v;p[0]+=m[0],p[1]+=m[1],p[2]+=m[2],v.hasMoved=!0}else if(c===void 0){const{deltaPoints:f}=o,m=f.world;u.handles.points.forEach(p=>{p[0]+=m[0],p[1]+=m[1],p[2]+=m[2]}),s.invalidated=!0}else this._dragHandle(e),s.invalidated=!0;const h=y(a),{renderingEngine:g}=h;L(r),s.invalidated&&It(s,a,lt.HandlesUpdated)},this._dragHandle=e=>{const o=e.detail,{element:a}=o,{viewport:s}=y(a),{canvasToWorld:r,worldToCanvas:c}=s,{annotation:l,canvasWidth:d,canvasHeight:u,handleIndex:h,centerWorld:g,originalHandleCanvas:f}=this.editData,m=s.worldToCanvas(g),{data:v}=l,{points:p}=v.handles,{currentPoints:I}=o,C=I.canvas;if(h===0||h===1){const E=Math.abs(C[1]-m[1]),S=[m[0],m[1]-E],_=[m[0],m[1]+E];p[0]=r(S),p[1]=r(_);const D=C[0]-f[0],b=d/2+D,M=[m[0]-b,m[1]],P=[m[0]+b,m[1]];p[2]=r(M),p[3]=r(P)}else{const E=Math.abs(C[0]-m[0]),S=[m[0]-E,m[1]],_=[m[0]+E,m[1]];p[2]=r(S),p[3]=r(_);const D=C[1]-f[1],b=u/2+D,M=[m[0],m[1]-b],P=[m[0],m[1]+b];p[0]=r(M),p[1]=r(P)}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),ht(e);const{annotation:o,viewportIdsToRender:a,newAnnotation:s}=this.editData,{data:r}=o;return o.highlighted=!1,r.handles.activeHandleIndex=null,L(a),s&&Lt(o),this.editData=null,o.annotationUID}},this._activateModify=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(w.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(w.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e,{element:r}=s;let c=Ct(this.getToolName(),r);if(!c?.length||(c=this.filterInteractableAnnotationsForElement(r,c),!c?.length))return a;const l=this.getTargetId(s),d=s.getRenderingEngine(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let h=0;h<c.length;h++){const g=c[h],{annotationUID:f,data:m}=g,{handles:v}=m,{points:p,activeHandleIndex:I}=v;u.annotationUID=f;const{color:C,lineWidth:E,lineDash:S}=this.getAnnotationStyle({annotation:g,styleSpecifier:u}),_=p.map(Y=>s.worldToCanvas(Y)),D=Kc(_),{centerPointRadius:b}=this.configuration;if(!m.cachedStats[l]||m.cachedStats[l].areaUnit==null)m.cachedStats[l]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(g,s,d);else if(g.invalidated&&(this._throttledCalculateCachedStats(g,s,d,e),s instanceof ae)){const{referencedImageId:Y}=g.metadata;for(const q in m.cachedStats)q.startsWith("imageId")&&d.getStackViewports().find(it=>{const at=Je(Y),bt=it.hasImageURI(at),Bt=Je(it.getCurrentImageId());return bt&&Bt!==at})&&delete m.cachedStats[q]}if(!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;let M;if(!re(f))continue;!se(f)&&!this.editData&&I!==null&&(M=[_[I]]);const P=!!Ve("showHandlesAlways",{});(M||P)&&$t(o,f,"0",P?_:M,{color:C});const T=`${f}-ellipse`,x="0";if(cd(o,f,x,_,{color:C,lineDash:S,lineWidth:E},T),b>0&&Math.min(Math.abs(D[0][0]-D[1][0])/2,Math.abs(D[0][1]-D[1][1])/2)>3*b){const q=this._getCanvasEllipseCenter(_);Ae(o,f,`${x}-center`,q,b,{color:C,lineDash:S,lineWidth:E})}a=!0;const A=this.getLinkedTextBoxStyle(u,g);if(!A.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const O=this.configuration.getTextLines(m,l);if(!O||O.length===0)continue;let R;m.handles.textBox.hasMoved||(R=qe(D),m.handles.textBox.worldPosition=s.canvasToWorld(R));const N=s.worldToCanvas(m.handles.textBox.worldPosition),B=Oe(o,f,"1",O,N,_,{},A),{x:V,y:$,width:H,height:G}=B;m.handles.textBox.worldBoundingBox={topLeft:s.canvasToWorld([V,$]),topRight:s.canvasToWorld([V+H,$]),bottomLeft:s.canvasToWorld([V,$+G]),bottomRight:s.canvasToWorld([V+H,$+G])}}return a},this._calculateCachedStats=(e,o,a)=>{if(!this.configuration.calculateStats)return;const s=e.data,{element:r}=o,{points:c}=s.handles,l=c.map(S=>o.worldToCanvas(S)),{viewPlaneNormal:d,viewUp:u}=o.getCamera(),[h,g]=Kc(l),f=o.canvasToWorld(h),m=o.canvasToWorld(g),{cachedStats:v}=s,p=Object.keys(v),I=f,C=m;for(let S=0;S<p.length;S++){const _=p[S],D=this.getTargetImageData(_);if(!D)continue;const{dimensions:b,imageData:M,metadata:P,voxelManager:T}=D,x=Kh(M,I);x[0]=Math.floor(x[0]),x[1]=Math.floor(x[1]),x[2]=Math.floor(x[2]);const A=Kh(M,C);if(A[0]=Math.floor(A[0]),A[1]=Math.floor(A[1]),A[2]=Math.floor(A[2]),this._isInsideVolume(x,A,b)){const O=Math.min(x[0],A[0]),R=Math.max(x[0],A[0]),N=Math.min(x[1],A[1]),k=Math.max(x[1],A[1]),B=Math.min(x[2],A[2]),V=Math.max(x[2],A[2]),$=[[O,R],[N,k],[B,V]],H=[(f[0]+m[0])/2,(f[1]+m[1])/2,(f[2]+m[2])/2],G=Math.abs(f[0]-m[0])/2,Y=Math.abs(f[1]-m[1])/2,q=Math.abs(f[2]-m[2])/2,j={center:H,xRadius:G<_i/2?0:G,yRadius:Y<_i/2?0:Y,zRadius:q<_i/2?0:q},{worldWidth:K,worldHeight:it}=rs(d,u,I,C),at=K===0&&it===0,bt=[x,A],{scale:Bt,areaUnit:Yt}=nn(D,bt),qt=wd(D),Nt=Math.abs(Math.PI*(K/Bt/2)*(it/qt/Bt/2)),Tt={isPreScaled:io(o,_),isSuvScaled:this.isSuvScaled(o,_,e.metadata.referencedImageId)},Jt=so(P.Modality,e.metadata.referencedImageId,Tt);let yt;T&&(yt=T.forEach(this.configuration.statsCalculator.statsCallback,{isInObject:ue=>Pr(j,ue,{fast:!0}),boundsIJK:$,imageData:M,returnPoints:this.configuration.storePointData}));const Dt=this.configuration.statsCalculator.getStatistics();v[_]={Modality:P.Modality,area:Nt,mean:Dt.mean?.value,max:Dt.max?.value,min:Dt.min?.value,stdDev:Dt.stdDev?.value,statsArray:Dt.array,pointsInShape:yt,isEmptyArea:at,areaUnit:Yt,modalityUnit:Jt}}else this.isHandleOutsideImage=!0,v[_]={Modality:P.Modality}}const E=e.invalidated;return e.invalidated=!1,E&&It(e,r,lt.StatsUpdated),v},this._isInsideVolume=(e,o,a)=>we(e,a)&&we(o,a),this._throttledCalculateCachedStats=Fe(this._calculateCachedStats,100,{trailing:!0})}_pointInEllipseCanvas(t,n){const{xRadius:e,yRadius:o,center:a,angle:s}=t,r=y0(et(),n,a,-s);if(e<=0||o<=0)return!1;const c=[r[0]-a[0],r[1]-a[1]];return c[0]*c[0]/(e*e)+c[1]*c[1]/(o*o)<=1}_getCanvasEllipseCenter(t){const[n,e,o,a]=t,s=[o[0],e[1]],r=[a[0],n[1]];return[(s[0]+r[0])/2,(s[1]+r[1])/2]}};Ci.toolName="EllipticalROI",Ci.hydrate=(t,n,e)=>{const o=At(t);if(!o)return;const{FrameOfReferenceUID:a,referencedImageId:s,viewPlaneNormal:r,instance:c,viewport:l}=Ci.hydrateBase(Ci,o,n,e),{toolInstance:d,...u}=e||{},h={annotationUID:e?.annotationUID||Xt(),data:{handles:{points:n,activeHandleIndex:null},label:"",cachedStats:{}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:c.getToolName(),viewPlaneNormal:r,FrameOfReferenceUID:a,referencedImageId:s,...u}};mt(h,l.element),L([l.id])};let Zh=Ci;function PA(i,t){const n=i.cachedStats[t],{area:e,mean:o,stdDev:a,max:s,isEmptyArea:r,areaUnit:c,modalityUnit:l,min:d}=n,u=[];if(le(e)){const h=r?"Area: Oblique not supported":`Area: ${_t(e)} ${c}`;u.push(h)}return le(o)&&u.push(`Mean: ${_t(o)} ${l}`),le(s)&&u.push(`Max: ${_t(s)} ${l}`),le(d)&&u.push(`Min: ${_t(d)} ${l}`),le(a)&&u.push(`Std Dev: ${_t(a)} ${l}`),u}const{transformWorldToIndex:Jh}=Rt,ko=class ko extends zt{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,storePointData:!1,centerPointRadius:0,calculateStats:!0,getTextLines:MA,statsCalculator:Un,simplified:!0}}){super(t,n),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const o=e.detail,{currentPoints:a,element:s}=o,r=a.world;this.isDrawing=!0;let c;this.configuration.simplified?c=[[...r],[...r]]:c=[[...r],[...r],[...r],[...r],[...r]];const l=this.createAnnotation(e,c);mt(l,s);const d=Q(s,this.getToolName());return this.editData={annotation:l,viewportIdsToRender:d,newAnnotation:!0,hasMoved:!1},this._activateDraw(s),nt(s),e.preventDefault(),L(d),l},this.isPointNearTool=(e,o,a,s)=>{const r=y(e),{viewport:c}=r,{points:l}=o.data.handles,d=l.map(f=>c.worldToCanvas(f)),u=d[0],h=wo([u,d[1]]),g=wo([u,a]);return Math.abs(g-h)<s/2},this.toolSelectedCallback=(e,o)=>{const a=e.detail,{element:s}=a;o.highlighted=!0;const r=Q(s,this.getToolName());this.editData={annotation:o,viewportIdsToRender:r,movingTextBox:!1},nt(s),this._activateModify(s),L(r),e.preventDefault()},this.handleSelectedCallback=(e,o,a)=>{const s=e.detail,{element:r}=s,{data:c}=o;o.highlighted=!0;let l=!1,d;if(a.worldPosition)l=!0;else{const{points:h}=c.handles;d=h.findIndex(g=>g===a)}const u=Q(r,this.getToolName());this.editData={annotation:o,viewportIdsToRender:u,handleIndex:d,movingTextBox:l},this._activateModify(r),nt(r),L(u),e.preventDefault()},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c,hasMoved:l}=this.editData,{data:d}=s;c&&!l||(this.doneEditMemo(),s.highlighted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(a),this._deactivateDraw(a),ht(a),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(s.annotationUID),L(r),c&&Lt(s))},this._dragDrawCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a,currentPoints:s}=o,{world:r,canvas:c}=s,l=y(a),{viewport:d}=l,{canvasToWorld:u}=d,{annotation:h,viewportIdsToRender:g,newAnnotation:f}=this.editData;this.createMemo(a,h,{newAnnotation:f});const{data:m}=h,v=m.handles.points[0],p=d.worldToCanvas(v);if(this.configuration.simplified)m.handles.points[1]=r;else{const I=jt(p,c);m.handles.points[0]=[...v],m.handles.points[1]=u([p[0],p[1]-I]),m.handles.points[2]=u([p[0],p[1]+I]),m.handles.points[3]=u([p[0]-I,p[1]]),m.handles.points[4]=u([p[0]+I,p[1]])}h.invalidated=!0,this.editData.hasMoved=!0,L(g),It(h,a,lt.HandlesUpdated)},this._dragModifyCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,handleIndex:c,movingTextBox:l,newAnnotation:d}=this.editData;this.createMemo(a,s,{newAnnotation:d});const{data:u}=s;if(l){const{deltaPoints:h}=o,g=h.world,{textBox:f}=u.handles,{worldPosition:m}=f;m[0]+=g[0],m[1]+=g[1],m[2]+=g[2],f.hasMoved=!0}else if(c===void 0){const{deltaPoints:h}=o,g=h.world;u.handles.points.forEach(m=>{m[0]+=g[0],m[1]+=g[1],m[2]+=g[2]}),s.invalidated=!0}else this._dragHandle(e),s.invalidated=!0;L(r),s.invalidated&&It(s,a,lt.HandlesUpdated)},this._dragHandle=e=>{const o=e.detail,{element:a}=o,s=y(a),{canvasToWorld:r,worldToCanvas:c}=s.viewport,{annotation:l,handleIndex:d}=this.editData,{data:u}=l,{points:h}=u.handles,{currentPoints:g,deltaPoints:f}=o;if(d===0){const m=f.world;h.forEach(v=>{je(v,v,m)})}else{const m=h[0],v=c(m),p=g.canvas,I=jt(v,p);h[1]=r([v[0],v[1]-I]),h[2]=r([v[0],v[1]+I]),h[3]=r([v[0]-I,v[1]]),h[4]=r([v[0]+I,v[1]])}l.invalidated=!0},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),ht(e);const{annotation:o,viewportIdsToRender:a,newAnnotation:s}=this.editData;return o.highlighted=!1,o.data.handles.activeHandleIndex=null,L(a),s&&Lt(o),this.editData=null,o.annotationUID}},this._activateModify=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(w.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(w.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e,{element:r}=s;let c=Ct(this.getToolName(),r);if(!c?.length||(c=this.filterInteractableAnnotationsForElement(r,c),!c?.length))return a;const l=this.getTargetId(s),d=s.getRenderingEngine(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let h=0;h<c.length;h++){const g=c[h],{annotationUID:f,data:m}=g,{handles:v}=m,{points:p,activeHandleIndex:I}=v;u.annotationUID=f;const{color:C,lineWidth:E,lineDash:S}=this.getAnnotationStyle({annotation:g,styleSpecifier:u}),_=p.map(R=>s.worldToCanvas(R)),D=_[0],b=wo([D,_[1]]),M=Go([D,_[1]]),{centerPointRadius:P}=this.configuration;if(!m.cachedStats[l]||m.cachedStats[l].areaUnit==null)m.cachedStats[l]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null,radius:null,radiusUnit:null,perimeter:null},this._calculateCachedStats(g,s,d,e);else if(g.invalidated&&(this._throttledCalculateCachedStats(g,s,d,e),s instanceof ae)){const{referencedImageId:R}=g.metadata;for(const N in m.cachedStats)N.startsWith("imageId")&&d.getStackViewports().find(V=>{const $=Je(R),H=V.hasImageURI($),G=Je(V.getCurrentImageId());return H&&G!==$})&&delete m.cachedStats[N]}if(!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;let T;if(!re(f))continue;!se(f)&&!this.editData&&I!==null&&(this.configuration.simplified?T=[_[I]]:T=_);const x=!!Ve("showHandlesAlways",{});(T||x)&&$t(o,f,"0",x?_:T,{color:C});const A=`${f}-circle`,O="0";if(Ae(o,f,O,D,b,{color:C,lineDash:S,lineWidth:E},A),P>0&&b>3*P&&Ae(o,f,`${O}-center`,D,P,{color:C,lineDash:S,lineWidth:E}),a=!0,this.configuration.calculateStats){const R=this.getLinkedTextBoxStyle(u,g);if(!R.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const N=this.configuration.getTextLines(m,l);if(!N||N.length===0)continue;let k;m.handles.textBox.hasMoved||(k=qe(M),m.handles.textBox.worldPosition=s.canvasToWorld(k));const B=s.worldToCanvas(m.handles.textBox.worldPosition),$=Oe(o,f,"1",N,B,[D,_[1]],{},R),{x:H,y:G,width:Y,height:q}=$;m.handles.textBox.worldBoundingBox={topLeft:s.canvasToWorld([H,G]),topRight:s.canvasToWorld([H+Y,G]),bottomLeft:s.canvasToWorld([H,G+q]),bottomRight:s.canvasToWorld([H+Y,G+q])}}}return a},this._calculateCachedStats=(e,o,a,s)=>{if(!this.configuration.calculateStats)return;const{data:r}=e,{element:c}=o,l=e.invalidated,{points:d}=r.handles,u=d.map(E=>o.worldToCanvas(E)),h=u[0],g=u[1],[f,m]=Go([h,g]),v=o.canvasToWorld(f),p=o.canvasToWorld(m),{cachedStats:I}=r,C=Object.keys(I);for(let E=0;E<C.length;E++){const S=C[E],_=this.getTargetImageData(S);if(!_)continue;const{dimensions:D,imageData:b,metadata:M,voxelManager:P}=_,T=d.map(j=>b.worldToIndex(j)),x=nn(_,T),A=ko.calculateLengthInIndex(x,T),O=Math.PI*A*A,R=2*Math.PI*A,N=A===0,{unit:k,areaUnit:B}=x,V={name:"area",value:O,unit:B,type:rn.Area},$={name:"circumference",value:R,unit:k,type:rn.Linear},H={name:"radius",value:A,unit:k,type:rn.Linear},G=[V,H,$];I[S]={Modality:M.Modality,area:O,isEmptyArea:N,areaUnit:B,radius:A,radiusUnit:k,perimeter:R,statsArray:G};const Y=Jh(b,v),q=Jh(b,p);if(this.isHandleOutsideImage=!de.isInsideVolume(D,[Y,q]),!this.isHandleOutsideImage){const j=Math.min(Y[0],q[0]),K=Math.max(Y[0],q[0]),it=Math.min(Y[1],q[1]),at=Math.max(Y[1],q[1]),bt=Math.min(Y[2],q[2]),Bt=Math.max(Y[2],q[2]),Yt=[[j,K],[it,at],[bt,Bt]],qt=d[0],Nt=Math.abs(v[0]-p[0])/2,Tt=Math.abs(v[1]-p[1])/2,Jt=Math.abs(v[2]-p[2])/2,yt={center:qt,xRadius:Nt<_i/2?0:Nt,yRadius:Tt<_i/2?0:Tt,zRadius:Jt<_i/2?0:Jt},Dt={isPreScaled:io(o,S),isSuvScaled:this.isSuvScaled(o,S,e.metadata.referencedImageId)},ue=so(M.Modality,e.metadata.referencedImageId,Dt);let ee;P&&(ee=P.forEach(this.configuration.statsCalculator.statsCallback,{isInObject:ie=>Pr(yt,ie,{fast:!0}),boundsIJK:Yt,imageData:b,returnPoints:this.configuration.storePointData}));const Kt=this.configuration.statsCalculator.getStatistics();I[S]={...I[S],Modality:M.Modality,mean:Kt.mean?.value,max:Kt.max?.value,min:Kt.min?.value,pointsInShape:ee,stdDev:Kt.stdDev?.value,modalityUnit:ue,statsArray:[...G,...Kt.array]}}}return e.invalidated=!1,l&&It(e,c,lt.StatsUpdated),I},this._throttledCalculateCachedStats=Fe(this._calculateCachedStats,100,{trailing:!0})}};ko.toolName="CircleROI",ko.hydrate=(t,n,e)=>{const o=At(t);if(!o)return;const{FrameOfReferenceUID:a,referencedImageId:s,viewPlaneNormal:r,instance:c,viewport:l}=ko.hydrateBase(ko,o,n,e),{toolInstance:d,...u}=e||{},h={annotationUID:e?.annotationUID||Xt(),data:{handles:{points:n,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:c.getToolName(),viewPlaneNormal:r,FrameOfReferenceUID:a,referencedImageId:s,...u}};mt(h,l.element),L([l.id])};let cr=ko;function MA(i,t){const n=i.cachedStats[t],{radius:e,radiusUnit:o,area:a,mean:s,stdDev:r,max:c,min:l,isEmptyArea:d,areaUnit:u,modalityUnit:h}=n,g=[];if(le(e)){const f=d?"Radius: Oblique not supported":`Radius: ${_t(e)} ${o}`;g.push(f)}if(le(a)){const f=d?"Area: Oblique not supported":`Area: ${_t(a)} ${u}`;g.push(f)}return le(s)&&g.push(`Mean: ${_t(s)} ${h}`),le(c)&&g.push(`Max: ${_t(c)} ${h}`),le(l)&&g.push(`Min: ${_t(l)} ${h}`),le(r)&&g.push(`Std Dev: ${_t(r)} ${h}`),g}const xs=5,au=class au extends zt{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,degrees:[45,135,225,315],diameters:[10,30,60]}}){super(t,n),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const o=e.detail,{currentPoints:a,element:s}=o,r=a.world,c=y(s),{viewport:l,renderingEngine:d}=c;this.isDrawing=!0;const u=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=u,f=this.getReferencedImageId(l,r,h,g),m=l.getFrameOfReferenceUID(),v={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:m,referencedImageId:f,...l.getViewReference({points:[r]})},data:{label:"",handles:{points:[[...r]]}}};mt(v,s);const p=Q(s,this.getToolName());return this.editData={annotation:v,viewportIdsToRender:p,newAnnotation:!0},this._activateDraw(s),nt(s),e.preventDefault(),L(p),v},this.isPointNearTool=(e,o,a,s)=>{const r=y(e),{viewport:c}=r,{data:l}=o,{points:d}=l.handles,u=c.worldToCanvas(d[0]),h=wo([u,a]);return Math.abs(h)<s},this.toolSelectedCallback=(e,o)=>{const a=e.detail,{element:s}=a;o.highlighted=!0;const r=Q(s,this.getToolName());this.editData={annotation:o,viewportIdsToRender:r},nt(s),this._activateModify(s);const c=y(s),{renderingEngine:l}=c;L(r),e.preventDefault()},this.handleSelectedCallback=(e,o)=>{const a=e.detail,{element:s}=a;o.highlighted=!0;const r=Q(s,this.getToolName());this.editData={annotation:o,viewportIdsToRender:r},this._activateModify(s),nt(s);const c=y(s),{renderingEngine:l}=c;L(r),e.preventDefault()},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c,hasMoved:l}=this.editData,{data:d}=s;if(c&&!l)return;s.highlighted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(a),this._deactivateDraw(a),ht(a);const{renderingEngine:u}=y(a);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(s.annotationUID),L(r),c&&Lt(s)},this._dragDrawCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{currentPoints:s}=o,r=s.canvas,c=y(a),{renderingEngine:l,viewport:d}=c,{canvasToWorld:u}=d,{annotation:h,viewportIdsToRender:g}=this.editData,{data:f}=h;f.handles.points=[u(r),u(r)],h.invalidated=!0,this.editData.hasMoved=!0,L(g)},this._dragModifyCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r}=this.editData,{data:c}=s,{deltaPoints:l}=o,d=l.world;c.handles.points.forEach(f=>{f[0]+=d[0],f[1]+=d[1],f[2]+=d[2]}),s.invalidated=!0;const h=y(a),{renderingEngine:g}=h;L(r)},this._dragHandle=e=>{const o=e.detail,{element:a}=o,s=y(a),{canvasToWorld:r,worldToCanvas:c}=s.viewport,{annotation:l}=this.editData,{data:d}=l,{points:u}=d.handles,h=u.map(C=>c(C)),{currentPoints:g}=o,f=g.canvas,m=f[0]-h[0][0],v=f[1]-h[0][1],p=f,I=[h[1][0]+m,h[1][1]+v];u[0]=r(p),u[1]=r(I)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),ht(e);const{annotation:o,viewportIdsToRender:a,newAnnotation:s}=this.editData,{data:r}=o;o.highlighted=!1,r.handles.activeHandleIndex=null;const{renderingEngine:c}=y(e);return L(a),s&&Lt(o),this.editData=null,o.annotationUID}},this._activateModify=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(w.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(w.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e,{element:r}=s;let c=Ct(this.getToolName(),r);if(!c?.length||(c=this.filterInteractableAnnotationsForElement(r,c),!c?.length))return a;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let d=0;d<c.length;d++){const u=c[d],{annotationUID:h,data:g}=u,{handles:f}=g,{points:m}=f;l.annotationUID=h;const{color:v,lineWidth:p,lineDash:I}=this.getAnnotationStyle({annotation:u,styleSpecifier:l}),E=m.map(T=>s.worldToCanvas(T))[0];if(!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;if(!re(h))continue;let S=`${h}-crosshair-vertical`,_=[E[0],E[1]+xs],D=[E[0],E[1]-xs];Et(o,h,S,_,D,{color:v,lineDash:I,lineWidth:p}),S=`${h}-crosshair-horizontal`,_=[E[0]+xs,E[1]],D=[E[0]-xs,E[1]],Et(o,h,S,_,D,{color:v,lineDash:I,lineWidth:p});const b=this.configuration.diameters.map(T=>this.worldMeasureToCanvas(T,s));for(let T=0;T<b.length;T++){const x=`${h}-circle-${T}`,A=`${h}-circle-${T}`;Ae(o,h,A,E,b[T]/2,{color:v,lineDash:I,lineWidth:p},x)}const M=T=>T*Math.PI/180,P=this.configuration.degrees.map(T=>M(T));for(let T=0;T<P.length;T++){const x=`${h}-line-${T}`,A=[Math.cos(P[T])*b[0]/2+E[0],Math.sin(P[T])*b[0]/2+E[1]],O=[Math.cos(P[T])*b[2]/2+E[0],Math.sin(P[T])*b[2]/2+E[1]];Et(o,h,x,A,O,{color:v,lineDash:I,lineWidth:p})}a=!0}return a}}worldMeasureToCanvas(t,n){const e=n.canvasToWorld([n.canvas.width/2,n.canvas.height/2]),{viewUp:o}=n.getCamera(),a=Wt(W(),e,o,t),s=n.worldToCanvas(e),r=n.worldToCanvas(a);return Math.sqrt(Math.pow(r[0]-s[0],2)+Math.pow(r[1]-s[1],2))}};au.toolName="ETDRSGrid";let Qh=au;const tg=3,eg=10,xA={resolution:20,controlPointAdditionDistance:6,controlPointDeletionDistance:6,showControlPointsConnectors:!1,controlPointAdditionEnabled:!0,controlPointDeletionEnabled:!0};var zn;(function(i){i.Cardinal="CARDINAL",i.Linear="LINEAR",i.CatmullRom="CATMULLROM",i.BSpline="BSPLINE"})(zn||(zn={}));var wa;(function(i){i.AddControlPoint="addControlPoint",i.DeleteControlPoint="deleteControlPoint"})(wa||(wa={}));const yA=["CatmullRomSplineROI","LinearSplineROI","BSplineROI","CardinalSplineROI"],fo=class fo extends Ba{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,calculateStats:!0,simplifiedSpline:!1,getTextLines:AA,contourHoleAdditionModifierKey:De.Shift,decimate:{enabled:!1,epsilon:.1},spline:{configuration:{[zn.Cardinal]:{Class:Ya,scale:.5},[zn.CatmullRom]:{Class:CI},[zn.Linear]:{Class:EI},[zn.BSpline]:{Class:wI,controlPointAdditionEnabled:!1,controlPointDeletionEnabled:!1,showControlPointsConnectors:!0}},type:zn.CatmullRom,drawPreviewEnabled:!0,enableTwoPointPreview:!1,lastControlPointDeletionKeys:["Backspace","Delete"]},actions:{[wa.AddControlPoint]:{method:"addControlPointCallback",bindings:[{mouseButton:Nn.Primary,modifierKey:De.Shift}]},[wa.DeleteControlPoint]:{method:"deleteControlPointCallback",bindings:[{mouseButton:Nn.Primary,modifierKey:De.Ctrl}]}}}}){super(t,n),this.splineToolNames=["CatmullRomSplineROI","LinearSplineROI","BSplineROI","CardinalSplineROI"],this.isHandleOutsideImage=!1,this.fireChangeOnUpdate=null,this.isPointNearTool=(e,o,a,s)=>{const{instance:r}=o.data.spline;return r.isPointNearCurve(a,s)},this.toolSelectedCallback=(e,o)=>{const a=e.detail,{element:s}=a;o.highlighted=!0;const r=Q(s,this.getToolName());this.editData={annotation:o,viewportIdsToRender:r,movingTextBox:!1},this._activateModify(s),L(r),e.preventDefault()},this.handleSelectedCallback=(e,o,a)=>{const s=e.detail,{element:r}=s,{data:c}=o;o.highlighted=!0;let l=!1,d;if(a.worldPosition)l=!0;else{const{points:h}=c.handles;d=h.findIndex(g=>g===a)}const u=Q(r,this.getToolName());this.editData={annotation:o,viewportIdsToRender:u,handleIndex:d,movingTextBox:l},this._activateModify(r),L(u),e.preventDefault()},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c,contourHoleProcessingEnabled:l}=this.editData,{data:d}=s;s.autoGenerated=!1,d.handles.activeHandleIndex=null,this._deactivateModify(a),this._deactivateDraw(a);const u=y(a),h=this.getTargetImageData(this.getTargetId(u.viewport)),{imageData:g,dimensions:f}=h;this.isHandleOutsideImage=d.handles.points.map(v=>xe(g,v)).some(v=>!we(v,f)),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(s.annotationUID);const m=c?lt.Completed:lt.HandlesUpdated;this.fireChangeOnUpdate?(this.fireChangeOnUpdate.annotationUID=s.annotationUID,this.fireChangeOnUpdate.changeType=m):this.fireChangeOnUpdate={annotationUID:s.annotationUID,changeType:m,contourHoleProcessingEnabled:l},L(r),this.doneEditMemo(),this.editData=null,this.isDrawing=!1},this._keyDownCallback=e=>{const o=e.detail,{element:a}=o,s=o.key??"",{lastControlPointDeletionKeys:r}=this.configuration.spline;if(!r.includes(s))return;const{annotation:l}=this.editData,{data:d}=l;if(d.handles.points.length===tg){this.cancel(a);return}else{const u=d.handles.points.length-1;this._deleteControlPointByIndex(a,l,u)}e.preventDefault()},this._mouseMoveCallback=e=>{const{drawPreviewEnabled:o}=this.configuration.spline;if(!o)return;const{element:a}=e.detail,{renderingEngine:s}=y(a),r=Q(a,this.getToolName());this.editData.lastCanvasPoint=e.detail.currentPoints.canvas,L(r),e.preventDefault()},this._mouseDownCallback=e=>{const o=e.type===w.MOUSE_DOUBLE_CLICK,{annotation:a,viewportIdsToRender:s}=this.editData,{data:r}=a;if(r.contour.closed)return;this.doneEditMemo();const c=e.detail,{currentPoints:l,element:d}=c,{canvas:u,world:h}=l;let g=r.handles.points.length>=2&&o,f=!0;if(r.handles.points.length&&this.createMemo(d,a,{newAnnotation:r.handles.points.length===1}),r.handles.points.length>=3){this.createMemo(d,a);const{instance:m}=r.spline;m.getClosestControlPointWithinDistance(u,eg)?.index===0&&(f=!1,g=!0)}f&&r.handles.points.push(h),r.contour.closed=r.contour.closed||g,a.invalidated=!0,L(s),r.contour.closed&&this._endCallback(e),e.preventDefault()},this._dragCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,handleIndex:c,movingTextBox:l,newAnnotation:d}=this.editData,{data:u}=s;if(this.createMemo(a,s,{newAnnotation:d}),l){const{deltaPoints:f}=o,m=f.world,{textBox:v}=u.handles,{worldPosition:p}=v;p[0]+=m[0],p[1]+=m[1],p[2]+=m[2],v.hasMoved=!0}else if(c===void 0){const{deltaPoints:f}=o,m=f.world;this.moveAnnotation(s,m)}else{const{currentPoints:f}=o,m=f.world;u.handles.points[c]=[...m],s.invalidated=!0}this.editData.hasMoved=!0;const h=y(a),{renderingEngine:g}=h;L(r)},this.triggerAnnotationCompleted=(e,o)=>{const a=w.ANNOTATION_COMPLETED,s={annotation:e,changeType:lt.Completed,contourHoleProcessingEnabled:o};gt(z,a,s)},this.triggerAnnotationModified=(e,o,a=lt.StatsUpdated)=>{const{viewportId:s,renderingEngineId:r}=o,c=w.ANNOTATION_MODIFIED;gt(z,c,{annotation:e,viewportId:s,renderingEngineId:r,changeType:a})},this.triggerChangeEvent=(e,o,a=lt.StatsUpdated,s)=>{a===lt.Completed?this.triggerAnnotationCompleted(e,s):this.triggerAnnotationModified(e,o,a)},this._activateModify=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.KEY_DOWN,this._keyDownCallback),e.addEventListener(w.MOUSE_MOVE,this._mouseMoveCallback),e.addEventListener(w.MOUSE_DOWN,this._mouseDownCallback),e.addEventListener(w.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.addEventListener(w.TOUCH_TAP,this._mouseDownCallback)},this._deactivateDraw=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.KEY_DOWN,this._keyDownCallback),e.removeEventListener(w.MOUSE_MOVE,this._mouseMoveCallback),e.removeEventListener(w.MOUSE_DOWN,this._mouseDownCallback),e.removeEventListener(w.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.removeEventListener(w.TOUCH_TAP,this._mouseDownCallback)},this._renderStats=(e,o,a,s)=>{const r=e.data,c=this.getTargetId(o);if(!r.spline.instance.closed||!s.visibility)return;const l=this.configuration.getTextLines(r,c);if(!l||l.length===0)return;const d=r.handles.points.map(I=>o.worldToCanvas(I));if(!r.handles.textBox.hasMoved){const I=qe(d);r.handles.textBox.worldPosition=o.canvasToWorld(I)}const u=o.worldToCanvas(r.handles.textBox.worldPosition),g=Oe(a,e.annotationUID??"","textBox",l,u,d,{},s),{x:f,y:m,width:v,height:p}=g;r.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([f,m]),topRight:o.canvasToWorld([f+v,m]),bottomLeft:o.canvasToWorld([f,m+p]),bottomRight:o.canvasToWorld([f+v,m+p])}},this.addControlPointCallback=(e,o)=>{const{data:a}=o,s=a.spline.type,r=this._getSplineConfig(s),c=r.controlPointAdditionDistance;if(r.controlPointAdditionEnabled===!1)return;const l=e.detail,{element:d}=l,u=y(d),{renderingEngine:h,viewport:g}=u,{canvasToWorld:f}=g,{instance:m}=a.spline,v=e.detail.currentPoints.canvas,p=m.getClosestPoint(v);if(p.distance>c)return;const{index:I,point:C}=m.addControlPointAtU(p.uValue);a.handles.points.splice(I,0,f(C)),o.invalidated=!0;const E=Q(d,this.getToolName());L(E)},this.deleteControlPointCallback=(e,o)=>{const a=o.data.spline.type,s=this._getSplineConfig(a),r=s.controlPointDeletionDistance;if(s.controlPointDeletionEnabled===!1)return;const c=e.detail,{element:l,currentPoints:d}=c,{canvas:u}=d,{instance:h}=o.data.spline,g=h.getClosestControlPointWithinDistance(u,r);g&&this._deleteControlPointByIndex(l,o,g.index)},this._calculateCachedStats=(e,o)=>{if(!this.configuration.calculateStats)return;const a=e.data;if(!a.contour.closed)return;const s=y(o);if(!s)return;const{viewport:r}=s,{cachedStats:c}=a,{polyline:l}=a.contour,d=Object.keys(c);for(let h=0;h<d.length;h++){const g=d[h],f=this.getTargetImageData(g);if(!f)continue;const{metadata:m}=f,v=l.map(T=>r.worldToCanvas(T)),p=v[0],I=r.canvasToWorld(p),C=r.canvasToWorld([p[0]+1,p[1]]),E=r.canvasToWorld([p[0],p[1]+1]),S=Te(I,C),_=Te(I,E),{imageData:D}=f,{scale:b,areaUnit:M}=nn(f,()=>{const{maxX:T,maxY:x,minX:A,minY:O}=bo(v),R=r.canvasToWorld([A,O]),N=xe(D,R),k=r.canvasToWorld([T,x]),B=xe(D,k);return[N,B]});let P=os(v)/b/b;P*=S*_,c[g]={Modality:m.Modality,area:P,areaUnit:M}}const u=e.invalidated;return e.invalidated=!1,u&&this.triggerAnnotationModified(e,s,lt.StatsUpdated),c},this._throttledCalculateCachedStats=Fe(this._calculateCachedStats,100,{trailing:!0}),this.annotationCompletedBinded=this.annotationCompleted.bind(this)}annotationCompleted(t){const{sourceAnnotation:n}=t.detail;!this.splineToolNames.includes(n?.metadata?.toolName)||!this.configuration.simplifiedSpline||!this.isContourSegmentationTool()||Ql(n)}initializeListeners(){z.addEventListener(w.ANNOTATION_COMPLETED,this.annotationCompletedBinded)}removeListeners(){z.removeEventListener(w.ANNOTATION_COMPLETED,this.annotationCompletedBinded)}onSetToolEnabled(){this.initializeListeners()}onSetToolActive(){this.initializeListeners()}onSetToolDisabled(){this.removeListeners()}addNewAnnotation(t){const n=t.detail,{currentPoints:e,element:o}=n,{canvas:a}=e,s=ji(t.detail.event)===this.configuration.contourHoleAdditionModifierKey,r=this.createAnnotation(t);this.isDrawing=!0,this.addAnnotation(r,o);const c=Q(o,this.getToolName());return this.editData={annotation:r,viewportIdsToRender:c,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,lastCanvasPoint:a,contourHoleProcessingEnabled:s},this._activateDraw(o),t.preventDefault(),L(c),r}cancel(t){if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(t),this._deactivateModify(t);const{annotation:n,viewportIdsToRender:e,newAnnotation:o}=this.editData;o&&ft(n.annotationUID),super.cancelAnnotation(n);const a=y(t),{renderingEngine:s}=a;return L(e),this.editData=null,n.annotationUID}isContourSegmentationTool(){return!1}renderAnnotationInstance(t){const{enabledElement:n,targetId:e,svgDrawingHelper:o,annotationStyle:a}=t,{viewport:s}=n,{worldToCanvas:r}=s,{element:c}=s,l=t.annotation,{annotationUID:d,data:u,highlighted:h}=l,{handles:g}=u,{points:f,activeHandleIndex:m}=g,v=this.editData?.newAnnotation,{lineWidth:p,lineDash:I,color:C,locked:E}=a,S=f.map(O=>r(O)),{drawPreviewEnabled:_}=this.configuration.spline,D=l.data.spline.type,b=this._getSplineConfig(D),M=l.data.spline.instance,P=Ja(l);if(P.findIndex(O=>!O)!==-1)throw new Error(`Can't find annotation for child ${l.childAnnotationUIDs.join()}`);[l,...P].filter(O=>this._isSplineROIAnnotation(O)).forEach(O=>{const N=this._updateSplineInstance(c,O).getPolylinePoints();this.updateContourPolyline(O,{points:N,closed:u.contour.closed,targetWindingDirection:Ge.Clockwise},s,{updateWindingDirection:u.contour.closed})}),super.renderAnnotationInstance(t),!u.cachedStats[e]||u.cachedStats[e].areaUnit==null?(u.cachedStats[e]={Modality:null,area:null,areaUnit:null},this._calculateCachedStats(l,c)):l.invalidated&&this._throttledCalculateCachedStats(l,c);let A;if(!E&&!this.editData&&m!==null&&(A=[S[m]]),(A||v||h)&&$t(o,d,"0",S,{color:C,lineWidth:p,handleRadius:"3"}),_&&M.numControlPoints>=1&&this.editData?.lastCanvasPoint&&!M.closed){const{lastCanvasPoint:O}=this.editData,{enableTwoPointPreview:R}=this.configuration.spline;if(M.numControlPoints===1&&R){const k=[S[0],O];dn(o,d,"previewSplineChange",k,{color:"#9EA0CA",lineDash:I,lineWidth:1})}else if(M.numControlPoints>1){const N=M.getPreviewPolylinePoints(O,eg);dn(o,d,"previewSplineChange",N,{color:"#9EA0CA",lineDash:I,lineWidth:1})}}if(b.showControlPointsConnectors){const O=[...S];M.closed&&O.push(S[0]),dn(o,d,"controlPointsConnectors",O,{color:"rgba(255, 255, 255, 0.5)",lineWidth:1})}return this._renderStats(l,s,o,a.textbox),this.fireChangeOnUpdate?.annotationUID===d&&(this.triggerChangeEvent(l,n,this.fireChangeOnUpdate.changeType,this.fireChangeOnUpdate.contourHoleProcessingEnabled),this.fireChangeOnUpdate=null),l.invalidated=!1,!0}createInterpolatedSplineControl(t){if(t.data.handles.points?.length)return;const{polyline:n}=t.data.contour;if(!n||!n.length)return;t.data.handles.points=[];const{points:e}=t.data.handles,o=Math.max(10,Math.floor(n.length/20));for(let a=0;a<n.length-o;a+=o)e.push(n[a]);e.push(n[n.length-1])}isSplineAnnotation(t){return yA.includes(t?.metadata?.toolName)}createSplineObjectFromType(t,n){const e=this._getSplineConfig(n),o=new e.Class;t.data.spline={type:e.type,instance:o,resolution:e.resolution}}createAnnotation(t){const n=super.createAnnotation(t),{world:e}=t.detail.currentPoints,{type:o}=this.configuration.spline,a=this._getSplineConfig(o),s=new a.Class,r=()=>({type:a.type,instance:s,resolution:a.resolution});let c;return this.configuration.interpolation?.enabled&&(c=l=>{l.data.spline||=r(),this.createInterpolatedSplineControl(l)}),Be(n,{data:{handles:{points:[[...e]]},spline:r(),cachedStats:{}},onInterpolationComplete:c})}_deleteControlPointByIndex(t,n,e){const o=y(t),{points:a}=n.data.handles;a.length===3?ft(n.annotationUID):a.splice(e,1);const{renderingEngine:s}=o,r=Q(t,this.getToolName());n.invalidated=!0,L(r)}_isSplineROIAnnotation(t){return!!t.data?.spline}_getSplineConfig(t){const{configuration:n}=this,e=n.spline.configuration;return Object.assign({type:t},xA,e[t])}_updateSplineInstance(t,n){const e=y(t),{viewport:o}=e,{worldToCanvas:a}=o,{data:s}=n,{type:r,instance:c}=n.data.spline,l=this._getSplineConfig(r),u=s.handles.points.map(a),h=l.resolution!==void 0?parseInt(l.resolution):void 0,g=l.scale!==void 0?parseFloat(l.scale):void 0;return c.setControlPoints(u),c.closed=!!s.contour.closed,!c.fixedResolution&&h!==void 0&&c.resolution!==h&&(c.resolution=h,n.invalidated=!0),c instanceof Ya&&!c.fixedScale&&g!==void 0&&c.scale!==g&&(c.scale=g,n.invalidated=!0),c}};fo.toolName="SplineROI",fo.SplineTypes=zn,fo.Actions=wa,fo.hydrate=(t,n,e)=>{const o=At(t);if(!o)return;if(n.length<tg){console.warn("Spline requires at least 3 control points");return}const{FrameOfReferenceUID:a,referencedImageId:s,viewPlaneNormal:r,viewUp:c,instance:l,viewport:d}=fo.hydrateBase(fo,o,n,e),u=e?.splineType||zn.CatmullRom,g=l._getSplineConfig(u).Class,f=new g,{toolInstance:m,...v}=e||{},p={annotationUID:e?.annotationUID||Xt(),data:{handles:{points:n},label:"",cachedStats:{},spline:{type:u,instance:f},contour:{closed:!0}},highlighted:!1,autoGenerated:!1,invalidated:!0,isLocked:!1,isVisible:!0,metadata:{toolName:l.getToolName(),viewPlaneNormal:r,FrameOfReferenceUID:a,referencedImageId:s,...v}};mt(p,d.element),L([d.id])};let Cl=fo;function AA(i,t){const n=i.cachedStats[t],{area:e,isEmptyArea:o,areaUnit:a}=n,s=[];if(e){const r=o?"Area: Oblique not supported":`Area: ${_t(e)} ${a}`;s.push(r)}return s}const su=class su extends Cl{constructor(t){const n=Be({configuration:{calculateStats:!1}},t);super(n),this.annotationCutMergeCompletedBinded=this.annotationCutMergeCompleted.bind(this)}isContourSegmentationTool(){return!0}initializeListeners(){z.addEventListener(w.ANNOTATION_CUT_MERGE_PROCESS_COMPLETED,this.annotationCutMergeCompletedBinded)}removeListeners(){z.removeEventListener(w.ANNOTATION_CUT_MERGE_PROCESS_COMPLETED,this.annotationCutMergeCompletedBinded)}annotationCutMergeCompleted(t){const{sourceAnnotation:n}=t.detail;this.toolName!==n?.metadata?.toolName||!this.splineToolNames.includes(n?.metadata?.toolName)||!this.configuration.simplifiedSpline||Ql(n)}};su.toolName="SplineContourSegmentationTool";let ng=su;class OA{constructor({numBits:t,getPriority:n,areEqual:e}){this._bucketCount=1<<t,this._mask=this._bucketCount-1,this._size=0,this._currentBucketIndex=0,this._buckets=this._buildArray(this._bucketCount),this._getPriority=typeof n<"u"?n:o=>o,this._areEqual=typeof e=="function"?e:(o,a)=>o===a}push(t){const n=this._getBucketIndex(t),e=this._buckets[n],o={value:t,next:e};this._buckets[n]=o,this._size++}pop(){if(this._size===0)throw new Error("Cannot pop because the queue is empty.");for(;this._buckets[this._currentBucketIndex]===null;)this._currentBucketIndex=(this._currentBucketIndex+1)%this._bucketCount;const t=this._buckets[this._currentBucketIndex];return this._buckets[this._currentBucketIndex]=t.next,this._size--,t.value}remove(t){if(!t)return!1;const n=this._getBucketIndex(t),e=this._buckets[n];let o=e,a;for(;o!==null&&!this._areEqual(t,o.value);)a=o,o=o.next;return o===null?!1:(o===e?this._buckets[n]=o.next:a.next=o.next,this._size--,!0)}isEmpty(){return this._size===0}_getBucketIndex(t){return this._getPriority(t)&this._mask}_buildArray(t){const n=new Array(t);return n.fill(null),n}}const Ac=4294967295,LA=2/(3*Math.PI);class lr{constructor(t,n,e){this._getPointIndex=(a,s)=>{const{width:r}=this;return a*r+s},this._getPointCoordinate=a=>{const s=a%this.width,r=Math.floor(a/this.width);return[s,r]},this._getPointCost=a=>Math.round(this.searchGranularity*this.costs[a]);const o=t.length;this.searchGranularityBits=8,this.searchGranularity=1<<this.searchGranularityBits,this.width=n,this.height=e,this.grayscalePixelData=t,this.laplace=null,this.gradXNew=null,this.gradYNew=null,this.laplace=this._computeLaplace(),this.gradMagnitude=this._computeGradient(),this.gradXNew=this._computeGradientX(),this.gradYNew=this._computeGradientY(),this.visited=new Array(o),this.parents=new Uint32Array(o),this.costs=new Float32Array(o)}startSearch(t){const n=this._getPointIndex(t[1],t[0]);this.startPoint=null,this.visited.fill(!1),this.parents.fill(Ac),this.costs.fill(1/0),this.priorityQueueNew=new OA({numBits:this.searchGranularityBits,getPriority:this._getPointCost}),this.startPoint=t,this.costs[n]=0,this.priorityQueueNew.push(n)}findMinNearby(t,n=2){const[e,o]=t,{costs:a}=this,s=[Math.max(0,e-n),Math.min(e+n+1,this.width)],r=[Math.max(0,o-n),Math.min(o+n+1,this.height)];let c=a[this._getPointIndex(o,e)]*.8,l=t;for(let d=s[0];d<s[1];d++)for(let u=r[0];u<r[1];u++){const h=1-(Math.abs(d-t[0])+Math.abs(u-t[1]))/n/2,f=a[this._getPointIndex(u,d)]*.8+h*.2;f<c&&(l=[d,u],c=f)}return l}findPathToPoint(t){if(!this.startPoint)throw new Error("There is no search in progress");const{startPoint:n,_getPointIndex:e,_getPointCoordinate:o}=this,a=e(n[1],n[0]),s=e(t[1],t[0]),{visited:r,parents:c,costs:l,priorityQueueNew:d}=this;if(s===a)return[];for(;!d.isEmpty()&&c[s]===Ac;){const g=d.pop();if(r[g])continue;const f=o(g),m=this._getNeighborPoints(f);r[g]=!0;for(let v=0,p=m.length;v<p;v++){const I=m[v],C=e(I[1],I[0]),E=this._getWeightedDistance(f,I),S=l[g]+E;S<l[C]&&(l[C]!==1/0&&d.remove(C),l[C]=S,c[C]=g,d.push(C))}}const u=[];let h=s;for(;h!==Ac;)u.push(o(h)),h=c[h];return u.reverse()}_getDeltaX(t,n){const{grayscalePixelData:e,width:o}=this;let a=this._getPointIndex(n,t);return t+1===o&&a--,e[a+1]-e[a]}_getDeltaY(t,n){const{grayscalePixelData:e,width:o,height:a}=this;let s=this._getPointIndex(n,t);return n+1===a&&(s-=o),e[s]-e[s+o]}_getGradientMagnitude(t,n){const e=this._getDeltaX(t,n),o=this._getDeltaY(t,n);return Math.sqrt(e*e+o*o)}_getLaplace(t,n){const{grayscalePixelData:e,_getPointIndex:o}=this,a=e[o(n-2,t)],s=e[o(n-1,t-1)],r=e[o(n-1,t)],c=e[o(n-1,t+1)],l=e[o(n,t-2)],d=e[o(n,t-1)],u=e[o(n,t)],h=e[o(n,t+1)],g=e[o(n,t+2)],f=e[o(n+1,t-1)],m=e[o(n+1,t)],v=e[o(n+1,t+1)],p=e[o(n+2,t)];let I=a;return I+=s+2*r+c,I+=l+2*d-16*u+2*h+g,I+=f+2*m+v,I+=p,I}_computeGradient(){const{width:t,height:n}=this,e=new Float32Array(t*n);let o=0,a=0,s=0,r=0;for(r=0;r<n-1;r++){for(s=0;s<t-1;s++)e[o]=this._getGradientMagnitude(s,r),a=Math.max(e[o],a),o++;e[o]=e[o-1],o++}for(let c=e.length;o<c;o++)e[o]=e[o-t];for(let c=0,l=e.length;c<l;c++)e[c]=1-e[c]/a;return e}_computeLaplace(){const{width:t,height:n,_getPointIndex:e}=this,o=new Float32Array(t*n);o.fill(1,0,e(2,0));for(let a=2;a<n-2;a++){o[e(a,0)]=1,o[e(a,1)]=1;for(let s=2;s<t-2;s++)o[e(a,s)]=this._getLaplace(s,a)>.33?0:1;o[e(a,t-2)]=1,o[e(a,t-1)]=1}return o.fill(1,e(n-2,0)),o}_computeGradientX(){const{width:t,height:n}=this,e=new Float32Array(t*n);let o=0;for(let a=0;a<n;a++)for(let s=0;s<t;s++)e[o++]=this._getDeltaX(s,a);return e}_computeGradientY(){const{width:t,height:n}=this,e=new Float32Array(t*n);let o=0;for(let a=0;a<n;a++)for(let s=0;s<t;s++)e[o++]=this._getDeltaY(s,a);return e}_getGradientUnitVector(t,n){const{gradXNew:e,gradYNew:o,_getPointIndex:a}=this,s=e[a(n,t)],r=o[a(n,t)];let c=Math.sqrt(s*s+r*r);return c=Math.max(c,1e-100),[s/c,r/c]}_getGradientDirection(t,n,e,o){const a=this._getGradientUnitVector(t,n),s=this._getGradientUnitVector(e,o);let r=a[1]*(e-t)-a[0]*(o-n),c=s[1]*(e-t)-s[0]*(o-n);r<0&&(r=-r,c=-c),t!==e&&n!==o&&(r*=Math.SQRT1_2,c*=Math.SQRT1_2),c=Math.min(Math.max(c,-1),1);const l=LA*(Math.acos(Math.min(r,1))+Math.acos(c));return isNaN(l)||!isFinite(l)?(console.warn("Found non-direction:",t,n,e,o,r,c,l),1):l}getCost(t,n){return this._getWeightedDistance(t,n)}_getWeightedDistance(t,n){const{_getPointIndex:e,width:o,height:a}=this,[s,r]=t,[c,l]=n;if(c<0||c>=o||l<0||l>=a)return 1;if(s<0||r<0||s>=o||r>=a)return 0;const d=e(l,c);let u=this.gradMagnitude[d];(s===c||r===l)&&(u*=Math.SQRT1_2);const h=this.laplace[d],g=this._getGradientDirection(s,r,c,l);return .43*u+.43*h+.11*g}_getNeighborPoints(t){const{width:n,height:e}=this,o=[],a=Math.max(t[0]-1,0),s=Math.max(t[1]-1,0),r=Math.min(t[0]+1,n-1),c=Math.min(t[1]+1,e-1);for(let l=s;l<=c;l++)for(let d=a;d<=r;d++)(d!==t[0]||l!==t[1])&&o.push([d,l]);return o}static createInstanceFromRawPixelData(t,n,e,o){const a=t.length,s=new Float32Array(a),{lower:r,upper:c}=o,l=c-r;for(let d=0,u=t.length;d<u;d++)s[d]=Math.max(0,Math.min(1,(t[d]-r)/l));return new lr(s,n,e)}}class Hn{constructor(t,n){this.pointArray=t?t.slice():[],this._controlPointIndexes=n?n.slice():[]}getPoint(t){return this.pointArray[t]}getLastPoint(){return this.pointArray[this.pointArray.length-1]}isControlPoint(t){const n=this.pointArray.indexOf(t);if(n!==-1)return this._controlPointIndexes.indexOf(n)!==-1;throw new Error("Error: isControlPoint called with not in list point.")}addPoint(t){this.pointArray.push(t)}addControlPoint(t){const n=this.pointArray.indexOf(t);if(n!==-1)this._controlPointIndexes.push(n);else throw new Error("Cannot mark a non registered point as control point.")}getControlPoints(){return this._controlPointIndexes.map(t=>this.pointArray[t])}getNumControlPoints(){return this._controlPointIndexes.length}removeLastControlPoint(){this._controlPointIndexes.length&&this._controlPointIndexes.pop()}getLastControlPoint(){if(this._controlPointIndexes.length)return this.pointArray[this._controlPointIndexes[this._controlPointIndexes.length-1]]}removeLastPoints(t){this.pointArray.splice(this.pointArray.length-t,t)}addPoints(t){this.pointArray=this.pointArray.concat(t)}prependPath(t){const n=t.pointArray.length,e=[];this.pointArray=t.pointArray.concat(this.pointArray);for(let o=0;o<this._controlPointIndexes.length;++o)e[o]=this._controlPointIndexes[o]+n;this._controlPointIndexes=t._controlPointIndexes.concat(e)}appendPath(t){this.addPoints(t.pointArray),t._controlPointIndexes.forEach(n=>this._controlPointIndexes.push(n))}}const RA=10**2,ru=class ru extends Ba{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{getTextLines:NA,calculateStats:!0,preventHandleOutsideImage:!1,contourHoleAdditionModifierKey:De.Shift,snapHandleNearby:2,interpolation:{enabled:!1,nearestEdge:2,showInterpolationPolyline:!1},decimate:{enabled:!1,epsilon:.1},actions:{cancelInProgress:{method:"cancelInProgress",bindings:[{key:"Escape"}]}}}}){super(t,n),this.isHandleOutsideImage=!1,this.isPointNearTool=(e,o,a,s)=>{const r=y(e),{viewport:c}=r,l=s*s,d=o.data.contour.polyline.map(h=>c.worldToCanvas(h));let u=d[d.length-1];for(let h=0;h<d.length;h++){const g=d[h];if(ns(u,g,a)<=l)return!0;u=g}return!1},this.toolSelectedCallback=(e,o)=>{const a=e.detail,{element:s}=a;o.highlighted=!0;const r=Q(s,this.getToolName());this.editData={annotation:o,viewportIdsToRender:r,movingTextBox:!1};const c=y(s),{renderingEngine:l}=c;this._activateModify(s),L(r),e.preventDefault()},this.handleSelectedCallback=(e,o,a)=>{const s=e.detail,{element:r}=s,{data:c}=o;o.highlighted=!0;let l=!1,d;if(a.worldPosition)l=!0;else{const{points:f}=c.handles;d=f.findIndex(m=>m===a)}const u=Q(r,this.getToolName());this.editData={annotation:o,viewportIdsToRender:u,handleIndex:d,movingTextBox:l},this._activateModify(r);const h=y(r),{renderingEngine:g}=h;L(u),e.preventDefault()},this._endCallback=(e,o=!1)=>{const a=e.detail,{element:s}=a,{annotation:r,viewportIdsToRender:c,newAnnotation:l,contourHoleProcessingEnabled:d}=this.editData,{data:u}=r;this.doneEditMemo(),u.handles.activeHandleIndex=null,this._deactivateModify(s),this._deactivateDraw(s);const h=y(s);if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage||o){ft(r.annotationUID),this.clearEditData(),L(c);return}L(c);const g=l?lt.Completed:lt.HandlesUpdated;this.triggerChangeEvent(r,h,g,d),this.clearEditData()},this.triggerChangeEvent=(e,o,a=lt.StatsUpdated,s=!1)=>{a===lt.Completed?Cr(e,s):It(e,o.viewport.element,a)},this._mouseDownCallback=e=>{const o=e.type===w.MOUSE_DOUBLE_CLICK,{annotation:a,viewportIdsToRender:s,worldToSlice:r,sliceToWorld:c,newAnnotation:l}=this.editData;if(this.editData.closed)return;const d=e.detail,{element:u}=d,{currentPoints:h}=d,{canvas:g,world:f}=h;let m=f;const v=y(u),{viewport:p,renderingEngine:I}=v,C=this.editData.currentPath.getControlPoints();let E=C.length>=2&&o;if(this.doneEditMemo(),this.createMemo(u,a,{newAnnotation:l&&C.length===1}),C.length>=2){const D={index:-1,distSquared:1/0};for(let b=0,M=C.length;b<M;b++){const P=C[b],T=c(P),x=p.worldToCanvas(T),A=to(g,x);A<=RA&&A<D.distSquared&&(D.distSquared=A,D.index=b)}D.index===0&&(E=!0)}const{snapHandleNearby:S}=this.configuration;if(S&&!this.editData.closed){const D=new Hn,b=this.scissors.findMinNearby(r(f),1),M=this.scissors.findPathToPoint(b);D.addPoints(M),D.prependPath(this.editData.confirmedPath),m=c(b),this.editData.currentPath=D}this.editData.closed=this.editData.closed||E,this.editData.confirmedPath=this.editData.currentPath;const _=this.editData.currentPath.getLastPoint();this.editData.confirmedPath.addControlPoint(_),a.data.handles.points.push(c(_)),this.scissors.startSearch(r(m)),a.invalidated=!0,L(s),this.editData.closed&&(this.updateAnnotation(this.editData.confirmedPath),this._endCallback(e)),e.preventDefault()},this._mouseMoveCallback=e=>{const{element:o,currentPoints:a}=e.detail,{world:s,canvas:r}=a,{renderingEngine:c}=y(o),l=Q(o,this.getToolName());this.editData.lastCanvasPoint=r;const{width:d,height:u}=this.scissors,{worldToSlice:h}=this.editData,g=h(s);if(g[0]<0||g[1]<0||g[0]>=d||g[1]>=u)return;const f=this.scissors.findPathToPoint(g),m=new Hn;m.addPoints(f),m.prependPath(this.editData.confirmedPath),this.editData.currentPath=m,L(l),e.preventDefault()},this._dragCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,movingTextBox:c,handleIndex:l,newAnnotation:d}=this.editData;this.createMemo(a,s,{newAnnotation:d});const{data:u}=s;if(c){const{deltaPoints:f}=o,m=f.world,{textBox:v}=u.handles,{worldPosition:p}=v;p[0]+=m[0],p[1]+=m[1],p[2]+=m[2],v.hasMoved=!0}else if(l===void 0)console.warn("Drag annotation not implemented");else{const{currentPoints:f}=o,m=f.world;this.editHandle(m,a,s,l)}this.editData.hasMoved=!0;const h=y(a),{renderingEngine:g}=h;L(r)},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e);const{annotation:o,viewportIdsToRender:a,newAnnotation:s}=this.editData;return s&&ft(o.annotationUID),L(a),this.doneEditMemo(),this.scissors=null,o.annotationUID},this._activateModify=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_MOVE,this._mouseMoveCallback),e.addEventListener(w.MOUSE_DOWN,this._mouseDownCallback),e.addEventListener(w.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.addEventListener(w.TOUCH_TAP,this._mouseDownCallback)},this._deactivateDraw=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_MOVE,this._mouseMoveCallback),e.removeEventListener(w.MOUSE_DOWN,this._mouseDownCallback),e.removeEventListener(w.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.removeEventListener(w.TOUCH_TAP,this._mouseDownCallback)},this._calculateCachedStats=(e,o)=>{if(!this.configuration.calculateStats)return;const a=e.data;if(!a.contour.closed)return;const s=y(o),{viewport:r,renderingEngine:c}=s,{cachedStats:l}=a,{polyline:d}=a.contour,u=Object.keys(l);for(let g=0;g<u.length;g++){const f=u[g],m=this.getTargetImageData(f);if(!m)continue;const{metadata:v}=m,p=d.map(x=>r.worldToCanvas(x)),I=p[0],C=r.canvasToWorld(I),E=r.canvasToWorld([I[0]+1,I[1]]),S=r.canvasToWorld([I[0],I[1]+1]),_=Te(C,E),D=Te(C,S),{imageData:b}=m,{scale:M,areaUnit:P}=nn(m,()=>{const{maxX:x,maxY:A,minX:O,minY:R}=bo(p),N=r.canvasToWorld([O,R]),k=xe(b,N),B=r.canvasToWorld([x,A]),V=xe(b,B);return[k,V]});let T=os(p)/M/M;T*=_*D,l[f]={Modality:v.Modality,area:T,areaUnit:P}}const h=e.invalidated;return e.invalidated=!1,h&&this.triggerAnnotationModified(e,s,lt.StatsUpdated),l},this._renderStats=(e,o,a,s)=>{const r=e.data,c=this.getTargetId(o);if(!r.contour.closed||!s.visibility)return;const l=this.configuration.getTextLines(r,c);if(!l||l.length===0)return;const d=r.handles.points.map(I=>o.worldToCanvas(I));if(!r.handles.textBox.hasMoved){const I=qe(d);r.handles.textBox.worldPosition=o.canvasToWorld(I)}const u=o.worldToCanvas(r.handles.textBox.worldPosition),g=Oe(a,e.annotationUID??"","textBox",l,u,d,{},s),{x:f,y:m,width:v,height:p}=g;r.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([f,m]),topRight:o.canvasToWorld([f+v,m]),bottomLeft:o.canvasToWorld([f,m+p]),bottomRight:o.canvasToWorld([f+v,m+p])}},this.triggerAnnotationModified=(e,o,a=lt.StatsUpdated)=>{const{viewportId:s,renderingEngineId:r}=o,c=w.ANNOTATION_MODIFIED;gt(z,c,{annotation:e,viewportId:s,renderingEngineId:r,changeType:a})},this._throttledCalculateCachedStats=Fe(this._calculateCachedStats,100,{trailing:!0})}setupBaseEditData(t,n,e,o,a){const s=y(n),{viewport:r}=s;this.isDrawing=!0;const c=r.getImageData(),{imageData:l}=c;let d,u,h,g,f;if(!(r instanceof ae))h=c.dimensions[0],g=c.dimensions[1],d=D=>{const b=xe(l,D);return[b[0],b[1]]},u=D=>wu(l,[D[0],D[1],0]),f=c.scalarData;else if(r instanceof ae){const D=kg(r),{sliceToIndexMatrix:b,indexToSliceMatrix:M}=D;d=P=>{const T=xe(l,P),x=Se([0,0,0],T,M);return[x[0],x[1]]},u=P=>{const T=Se([0,0,0],[P[0],P[1],0],b);return wu(l,T)},f=D.scalarData,h=D.width,g=D.height}else throw new Error("Viewport not supported");f=A0(f,h,g);const{voiRange:m}=r.getProperties(),v=d(t);this.scissors=lr.createInstanceFromRawPixelData(f,h,g,m),o&&(this.scissorsNext=lr.createInstanceFromRawPixelData(f,h,g,m),this.scissorsNext.startSearch(d(o))),this.scissors.startSearch(v);const p=!o,I=new Hn,C=new Hn,E=p?void 0:new Hn;I.addPoint(v),I.addControlPoint(v);const S=Q(n,this.getToolName()),_=r.worldToCanvas(t);this.editData={annotation:e,viewportIdsToRender:S,newAnnotation:p,hasMoved:!1,lastCanvasPoint:_,confirmedPath:I,currentPath:C,confirmedPathNext:E,closed:!1,handleIndex:this.editData?.handleIndex??e.handles?.activeHandleIndex,worldToSlice:d,sliceToWorld:u,contourHoleProcessingEnabled:a}}addNewAnnotation(t){const n=t.detail,{currentPoints:e,element:o}=n,{world:a}=e,s=this.createAnnotation(t),r=ji(t.detail.event)===this.configuration.contourHoleAdditionModifierKey;return this.setupBaseEditData(a,o,s,void 0,r),this.addAnnotation(s,o),this._activateDraw(o),t.preventDefault(),L(this.editData.viewportIdsToRender),s}clearEditData(){this.editData=null,this.scissors=null,this.scissorsNext=null,this.isDrawing=!1}editHandle(t,n,e,o){const{data:a}=e,{points:s}=a.handles,{length:r}=s,c=s[(o-1+r)%r],l=s[(o+1)%r];if(!this.editData?.confirmedPathNext){this.setupBaseEditData(c,n,e,l);const{polyline:C}=a.contour,E=new Hn,S=new Hn,{worldToSlice:_}=this.editData,D=ol(e,o-1),b=ol(e,o+1);if(b===-1||D===-1)throw new Error(`Can't find handle index ${b===-1&&l} ${D===-1&&c}`);o===0?S.addPoints(C.slice(b+1,D).map(_)):(E.addPoints(C.slice(0,D+1).map(_)),S.addPoints(C.slice(b,C.length).map(_))),this.editData.confirmedPath=E,this.editData.confirmedPathNext=S}const{editData:d,scissors:u}=this,{worldToSlice:h,sliceToWorld:g}=d,{activeHandleIndex:f}=a.handles;if(f==null)a.handles.activeHandleIndex=o;else if(f!==o)throw new Error(`Trying to edit a different handle than the one currently being edited ${o}!==${a.handles.activeHandleIndex}`);const m=h(t);if(m[0]<0||m[0]>=u.width||m[1]<0||m[1]>=u.height)return;s[o]=g(m);const v=u.findPathToPoint(m),p=this.scissorsNext.findPathToPoint(m),I=new Hn;I.prependPath(d.confirmedPath),o!==0&&I.addPoints(v),I.addPoints(p.reverse()),I.appendPath(d.confirmedPathNext),o===0&&I.addPoints(v),d.currentPath=I,e.invalidated=!0,d.hasMoved=!0,d.closed=!0}renderAnnotation(t,n){return this.updateAnnotation(this.editData?.currentPath),super.renderAnnotation(t,n)}isContourSegmentationTool(){return!1}createAnnotation(t){const n=super.createAnnotation(t),{world:e}=t.detail.currentPoints;return Be(n,{data:{handles:{points:[[...e]]}}})}cancelInProgress(t,n,e){if(!this.editData){this.undo();return}this._endCallback(e,!0)}renderAnnotationInstance(t){const{annotation:n,enabledElement:e,svgDrawingHelper:o,annotationStyle:a,targetId:s}=t,{viewport:r}=e,{element:c}=r,{worldToCanvas:l}=r,{annotationUID:d,data:u,highlighted:h}=n,{handles:g}=u,f=this.editData?.newAnnotation,{lineWidth:m,lineDash:v,color:p}=a;if(h||f&&n.annotationUID===this.editData?.annotation?.annotationUID){const C=g.points.map(l);$t(o,d,"0",C,{color:p,lineDash:v,lineWidth:m})}return super.renderAnnotationInstance(t),!u.cachedStats[s]||u.cachedStats[s]?.areaUnit===null?(u.cachedStats[s]={Modality:null,area:null,areaUnit:null},this._calculateCachedStats(n,c)):n.invalidated&&this._throttledCalculateCachedStats(n,c),this._renderStats(n,r,o,a.textbox),!0}updateAnnotation(t){if(!this.editData||!t)return;const{annotation:n,sliceToWorld:e,worldToSlice:o,closed:a,newAnnotation:s}=this.editData;let{pointArray:r}=t;r.length>1&&(r=[...r,r[0]]);const c=s&&a?Ge.Clockwise:void 0;this.updateContourPolyline(n,{points:r,closed:a,targetWindingDirection:c},{canvasToWorld:e,worldToCanvas:o})}};ru.toolName="LivewireContour";let El=ru;function NA(i,t){const n=i.cachedStats[t],{area:e,areaUnit:o}=n,a=[];if(e){const s=`Area: ${_t(e)} ${o}`;a.push(s)}return a}const gr=class gr extends El{updateInterpolatedAnnotation(t,n){this.editData||!t.invalidated||!t.data.handles.interpolationSources||(t.data.contour.originalPolyline=t.data.contour.polyline,queueMicrotask(()=>{if(!t.data.handles.interpolationSources)return;const{points:e}=t.data.handles,{element:o}=n.viewport;this.setupBaseEditData(e[0],o,t);const{length:a}=e,{scissors:s}=this,{nearestEdge:r,repeatInterpolation:c}=this.configuration.interpolation;t.data.handles.originalPoints=e;const{worldToSlice:l,sliceToWorld:d}=this.editData,u=[];if(r){let g=l(e[e.length-1]);e.forEach((f,m)=>{const v=l(f);g=v,u.push(v),s.startSearch(g),s.findPathToPoint(v),s.findPathToPoint(l(e[(m+3)%e.length]));const p=s.findMinNearby(v,r);Pt(v,p)||(u[m]=p,g=p,e[m]=d(p))})}const h=new Hn;for(let g=0;g<a;g++){s.startSearch(l(e[g]));const f=s.findPathToPoint(l(e[(g+1)%a]));h.addPoints(f)}this.updateAnnotation(h),this.scissors=null,this.scissorsNext=null,this.editData=null,t.data.handles.interpolationSources=null,c&&It(t,n.viewport.element,lt.InterpolationUpdated)}))}renderAnnotationInstance(t){const{enabledElement:n,svgDrawingHelper:e}=t,o=t.annotation,{annotationUID:a}=o,{viewport:s}=n,{worldToCanvas:r}=s,{showInterpolationPolyline:c}=this.configuration.interpolation||{};this.updateInterpolatedAnnotation?.(o,n);const{originalPolyline:l}=o.data.contour,d=super.renderAnnotationInstance(t);if(c&&l&&o.autoGenerated){const u=l.map(r);u.push(u[0]),dn(e,a,"interpolationContour-0",u,{color:"#70ffff",lineWidth:1,fillOpacity:0})}return d}isContourSegmentationTool(){return!0}};gr.toolName="LivewireContourSegmentationTool",Ri.register(gr);let og=gr;const Vo=class Vo extends zt{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,getTextCallback:UA,changeTextCallback:kA,preventHandleOutsideImage:!1,arrowFirst:!0,arrowHeadStyle:"legacy"}}){super(t,n),this.addNewAnnotation=e=>{this.startGroupRecording();const o=e.detail,{currentPoints:a,element:s}=o,r=a.world;nt(s),this.isDrawing=!0;const{arrowFirst:c}=this.configuration,l=this.createAnnotation(e,[[...r],[...r]],{data:{handles:{arrowFirst:c}}});mt(l,s);const d=Q(s,this.getToolName());return this.editData={annotation:l,viewportIdsToRender:d,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(s),e.preventDefault(),L(d),l},this.isPointNearTool=(e,o,a,s)=>{const r=y(e),{viewport:c}=r,{data:l}=o,[d,u]=l.handles.points,h=c.worldToCanvas(d),g=c.worldToCanvas(u),f={start:{x:h[0],y:h[1]},end:{x:g[0],y:g[1]}};return fe([f.start.x,f.start.y],[f.end.x,f.end.y],[a[0],a[1]])<=s},this.toolSelectedCallback=(e,o)=>{const a=e.detail,{element:s}=a;o.highlighted=!0;const r=Q(s,this.getToolName());this.editData={annotation:o,viewportIdsToRender:r,movingTextBox:!1},this._activateModify(s),nt(s);const c=y(s),{renderingEngine:l}=c;L(r),e.preventDefault()},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c,hasMoved:l,movingTextBox:d}=this.editData,{data:u}=s;c&&!l||(u.handles.activeHandleIndex=null,this._deactivateModify(a),this._deactivateDraw(a),ht(a),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(s.annotationUID),c?this.configuration.getTextCallback(h=>{if(!h){ft(s.annotationUID),L(r),this.editData=null,this.isDrawing=!1;return}s.data.label=h,It(s,a,lt.HandlesUpdated),Lt(s),this.createMemo(a,s,{newAnnotation:!!this.memo}),fI(s,a,h),this.endGroupRecording(),this.doneEditMemo(),L(r)}):d||It(s,a,lt.HandlesUpdated),this.doneEditMemo(),this.editData=null,this.isDrawing=!1)},this._dragCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,handleIndex:c,movingTextBox:l,newAnnotation:d}=this.editData;this.createMemo(a,s,{newAnnotation:d});const{data:u}=s;if(l){const{deltaPoints:h}=o,g=h.world,{textBox:f}=u.handles,{worldPosition:m}=f;m[0]+=g[0],m[1]+=g[1],m[2]+=g[2],f.hasMoved=!0}else if(c===void 0){const{deltaPoints:h}=o,g=h.world;u.handles.points.forEach(m=>{m[0]+=g[0],m[1]+=g[1],m[2]+=g[2]}),s.invalidated=!0}else{const{currentPoints:h}=o,g=h.world;u.handles.points[c]=[...g],s.invalidated=!0}this.editData.hasMoved=!0,L(r),s.invalidated&&It(s,a,lt.HandlesUpdated)},this.touchTapCallback=e=>{e.detail.taps==2&&this.doubleClickCallback(e)},this.doubleClickCallback=e=>{const o=e.detail,{element:a}=o;let s=Ct(this.getToolName(),a);if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return;const r=s.find(l=>this.isPointNearTool(a,l,o.currentPoints.canvas,6));if(!r)return;const c=r;this.configuration.changeTextCallback(r,e.detail,this._doneChangingTextCallback.bind(this,a,c)),this.editData=null,this.isDrawing=!1,e.stopImmediatePropagation(),e.preventDefault()},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),ht(e);const{annotation:o,viewportIdsToRender:a,newAnnotation:s}=this.editData,{data:r}=o;return o.highlighted=!1,r.handles.activeHandleIndex=null,L(a),s&&Lt(o),this.editData=null,o.annotationUID}},this._activateModify=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_END,this._endCallback)},this._activateDraw=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_MOVE,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_MOVE,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e,{element:r}=s;let c=Ct(this.getToolName(),r);if(!c?.length||(c=this.filterInteractableAnnotationsForElement(r,c),!c?.length))return a;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let d=0;d<c.length;d++){const u=c[d],{annotationUID:h,data:g}=u,{handles:f,label:m}=g,{points:v,activeHandleIndex:p}=f;l.annotationUID=h;const{color:I,lineWidth:C,lineDash:E,markerSize:S}=this.getAnnotationStyle({annotation:u,styleSpecifier:l}),_=v.map(B=>s.worldToCanvas(B));let D;if(!se(h)&&!this.editData&&p!==null&&(D=[_[p]]),!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;if(!re(h))continue;const b=!!Ve("showHandlesAlways",{});(D||b)&&$t(o,h,"0",_,{color:I,lineWidth:C});const M="1";if(this.configuration.arrowFirst?Ys(o,h,M,_[1],_[0],{color:I,width:C,lineDash:E,viaMarker:this.configuration.arrowHeadStyle!=="legacy",markerSize:S}):Ys(o,h,M,_[0],_[1],{color:I,width:C,lineDash:E,viaMarker:this.configuration.arrowHeadStyle!=="legacy",markerSize:S}),a=!0,!m)continue;const P=this.getLinkedTextBoxStyle(l,u);if(!P.visibility){g.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}if(!g.handles.textBox.hasMoved){const B=_[1];g.handles.textBox.worldPosition=s.canvasToWorld(B)}const T=s.worldToCanvas(g.handles.textBox.worldPosition),A=Oe(o,h,"1",[m],T,_,{},P),{x:O,y:R,width:N,height:k}=A;g.handles.textBox.worldBoundingBox={topLeft:s.canvasToWorld([O,R]),topRight:s.canvasToWorld([O+N,R]),bottomLeft:s.canvasToWorld([O,R+k]),bottomRight:s.canvasToWorld([O+N,R+k])}}return a}}handleSelectedCallback(t,n,e){const o=t.detail,{element:a}=o,{data:s}=n;n.highlighted=!0;let r=!1,c;e.worldPosition?r=!0:c=s.handles.points.findIndex(h=>h===e);const l=Q(a,this.getToolName());this.editData={annotation:n,viewportIdsToRender:l,handleIndex:c,movingTextBox:r},this._activateModify(a),nt(a);const d=y(a),{renderingEngine:u}=d;L(l),t.preventDefault()}_doneChangingTextCallback(t,n,e){n.data.label=e;const o=Q(t,this.getToolName());L(o),It(n,t)}_isInsideVolume(t,n,e){return we(t,e)&&we(n,e)}};Vo.toolName="ArrowAnnotate",Vo.hydrate=(t,n,e,o)=>{const a=At(t);if(!a)return;const{FrameOfReferenceUID:s,referencedImageId:r,viewPlaneNormal:c,instance:l,viewport:d}=Vo.hydrateBase(Vo,a,n,o),{toolInstance:u,...h}=o||{},g=Vo.createAnnotation({annotationUID:o?.annotationUID||Xt(),data:{label:e||"",handles:{points:n}},autoGenerated:!1,metadata:{toolName:l.getToolName(),viewPlaneNormal:c,FrameOfReferenceUID:s,referencedImageId:r,...h}});mt(g,d.element),L([d.id])};let ig=Vo;function UA(i){return i(prompt("Enter your annotation:"))}function kA(i,t,n){return n(prompt("Enter your annotation:"))}const Ei=class Ei extends zt{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,showAngleArc:!1,arcOffset:5,preventHandleOutsideImage:!1,getTextLines:VA}}){super(t,n),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const o=e.detail,{currentPoints:a,element:s}=o,r=a.world;nt(s),this.isDrawing=!0;const c=this.createAnnotation(e,[[...r],[...r]]);mt(c,s);const l=Q(s,this.getToolName());return this.editData={annotation:c,viewportIdsToRender:l,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(s),e.preventDefault(),L(l),c},this.isPointNearTool=(e,o,a,s)=>{const r=y(e),{viewport:c}=r,{data:l}=o,[d,u,h]=l.handles.points,g=c.worldToCanvas(d),f=c.worldToCanvas(u),m={start:{x:g[0],y:g[1]},end:{x:f[0],y:f[1]}};if(fe([m.start.x,m.start.y],[m.end.x,m.end.y],[a[0],a[1]])<=s)return!0;if(!h)return!1;const p=c.worldToCanvas(h),I={start:{x:f[0],y:f[1]},end:{x:p[0],y:p[1]}};return fe([I.start.x,I.start.y],[I.end.x,I.end.y],[a[0],a[1]])<=s},this.toolSelectedCallback=(e,o)=>{const a=e.detail,{element:s}=a;o.highlighted=!0;const r=Q(s,this.getToolName());this.editData={annotation:o,viewportIdsToRender:r,movingTextBox:!1},this._activateModify(s),nt(s);const c=y(s),{renderingEngine:l}=c;L(r),e.preventDefault()},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c,hasMoved:l}=this.editData,{data:d}=s;if(c&&!l)return;if(this.angleStartedNotYetCompleted&&d.handles.points.length===2){this.editData.handleIndex=2;return}this.angleStartedNotYetCompleted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(a),this._deactivateDraw(a),ht(a);const u=y(a),{renderingEngine:h}=u;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(s.annotationUID),L(r),this.doneEditMemo(),c&&Lt(s),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,handleIndex:c,movingTextBox:l,newAnnotation:d}=this.editData,{data:u}=s;if(this.createMemo(a,s,{newAnnotation:d}),l){const{deltaPoints:f}=o,m=f.world,{textBox:v}=u.handles,{worldPosition:p}=v;p[0]+=m[0],p[1]+=m[1],p[2]+=m[2],v.hasMoved=!0}else if(c===void 0){const{deltaPoints:f}=o,m=f.world;u.handles.points.forEach(p=>{p[0]+=m[0],p[1]+=m[1],p[2]+=m[2]}),s.invalidated=!0}else{const{currentPoints:f}=o,m=f.world;u.handles.points[c]=[...m],s.invalidated=!0}this.editData.hasMoved=!0;const h=y(a),{renderingEngine:g}=h;L(r),s.invalidated&&It(s,a,lt.HandlesUpdated)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),ht(e);const{annotation:o,viewportIdsToRender:a,newAnnotation:s}=this.editData,{data:r}=o;return o.highlighted=!1,r.handles.activeHandleIndex=null,L(a),s&&Lt(o),this.editData=null,this.angleStartedNotYetCompleted=!1,o.annotationUID}},this._activateModify=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback)},this._activateDraw=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_MOVE,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_MOVE,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e,{element:r}=s;let c=Ct(this.getToolName(),r);if(!c?.length||(c=this.filterInteractableAnnotationsForElement(r,c),!c?.length))return a;const l=this.getTargetId(s),d=s.getRenderingEngine(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let h=0;h<c.length;h++){const g=c[h],{annotationUID:f,data:m}=g,{points:v,activeHandleIndex:p}=m.handles;u.annotationUID=f;const{color:I,lineWidth:C,lineDash:E,angleArcLineDash:S}=this.getAnnotationStyle({annotation:g,styleSpecifier:u}),_=v.map(V=>s.worldToCanvas(V));!m.cachedStats[l]||m.cachedStats[l].angle==null?(m.cachedStats[l]={angle:null},this._calculateCachedStats(g,d,e)):g.invalidated&&this._throttledCalculateCachedStats(g,d,e);let D;if(!se(g.annotationUID)&&!this.editData&&p!==null&&(D=[_[p]]),!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;if(!re(f))continue;const b=!!Ve("showHandlesAlways",{});(D||b)&&$t(o,f,"0",_,{color:I,lineDash:E,lineWidth:C});let M="1";if(Et(o,f,M,_[0],_[1],{color:I,width:C,lineDash:E}),a=!0,_.length!==3)return a;if(M="2",Et(o,f,M,_[1],_[2],{color:I,width:C,lineDash:E}),this.configuration.showAngleArc){const V=_[1],$=this.configuration.arcOffset,H=Math.min(fe([V[0],V[1]],[_[0][0],_[0][1]],[_[2][0],_[2][1]]),fe([V[0],V[1]],[_[2][0],_[2][1]],[_[0][0],_[0][1]]))/$,G=[];let Y=Math.atan2(_[0][1]-V[1],_[0][0]-V[0]),q=Math.atan2(_[2][1]-V[1],_[2][0]-V[0]);if(q<Y&&(q+=2*Math.PI),q-Y>Math.PI){const it=Y;Y=q,q=it+2*Math.PI}const K=32;for(let it=0;it<=K;it++){const at=Y+it/K*(q-Y);G.push([V[0]+H*Math.cos(at),V[1]+H*Math.sin(at)])}Jn(o,f,"3",G,{color:I,width:C,lineDash:S})}if(!m.cachedStats[l]?.angle)continue;const P=this.getLinkedTextBoxStyle(u,g);if(!P.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const T=this.configuration.getTextLines(m,l);if(!m.handles.textBox.hasMoved){const V=_[1];m.handles.textBox.worldPosition=s.canvasToWorld(V)}const x=s.worldToCanvas(m.handles.textBox.worldPosition),O=Oe(o,f,"1",T,x,_,{},P),{x:R,y:N,width:k,height:B}=O;m.handles.textBox.worldBoundingBox={topLeft:s.canvasToWorld([R,N]),topRight:s.canvasToWorld([R+k,N]),bottomLeft:s.canvasToWorld([R,N+B]),bottomRight:s.canvasToWorld([R+k,N+B])}}return a},this._throttledCalculateCachedStats=Fe(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(t,n,e){const o=t.detail,{element:a}=o,{data:s}=n;n.highlighted=!0;let r=!1,c;e.worldPosition?r=!0:c=s.handles.points.findIndex(h=>h===e);const l=Q(a,this.getToolName());this.editData={annotation:n,viewportIdsToRender:l,handleIndex:c,movingTextBox:r},this._activateModify(a),nt(a);const d=y(a),{renderingEngine:u}=d;L(l),t.preventDefault()}_calculateCachedStats(t,n,e){const o=t.data,{element:a}=e.viewport;if(o.handles.points.length!==3)return;const s=o.handles.points[0],r=o.handles.points[1],c=o.handles.points[2],{cachedStats:l}=o,d=Object.keys(l);for(let h=0;h<d.length;h++){const g=d[h],f=Ti([s,r],[r,c]),{dimensions:m,imageData:v}=this.getTargetImageData(g);this.isHandleOutsideImage=[s,r,c].map(p=>xe(v,p)).some(p=>!we(p,m)),l[g]={angle:isNaN(f)?"Incomplete Angle":f}}const u=t.invalidated;return t.invalidated=!1,u&&It(t,a,lt.StatsUpdated),l}};Ei.toolName="Angle",Ei.hydrate=(t,n,e)=>{const o=At(t);if(!o)return;const{FrameOfReferenceUID:a,referencedImageId:s,viewPlaneNormal:r,instance:c,viewport:l}=Ei.hydrateBase(Ei,o,n,e),{toolInstance:d,...u}=e||{},h={annotationUID:e?.annotationUID||Xt(),data:{handles:{points:n}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:c.getToolName(),viewPlaneNormal:r,FrameOfReferenceUID:a,referencedImageId:s,...u}};mt(h,l.element),L([l.id])};let ag=Ei;function VA(i,t){const n=i.cachedStats[t],{angle:e}=n;return e===void 0?void 0:isNaN(e)?[`${e}`]:[`${_t(e)} `]}const FA=(...i)=>{const t=i[0].length===2?[0,0]:[0,0,0],n=i.length;for(const e of i)t[0]+=e[0]/n,t[1]+=e[1]/n,t.length===3&&(t[2]+=e[2]/n);return t},$n=FA,cu=class cu extends zt{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:BA,showArcLines:!1}}){super(t,n),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const o=e.detail,{currentPoints:a,element:s}=o,r=a.world;nt(s),this.isDrawing=!0;const c=this.createAnnotation(e,[[...r],[...r]]);mt(c,s);const l=Q(s,this.getToolName());return this.editData={annotation:c,viewportIdsToRender:l,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(s),e.preventDefault(),L(l),c},this.isPointNearTool=(e,o,a,s)=>{const r=y(e),{viewport:c}=r,{data:l}=o,{distanceToPoint:d,distanceToPoint2:u}=this.distanceToLines({viewport:c,points:l.handles.points,canvasCoords:a,proximity:s});return d<=s||u<=s},this.toolSelectedCallback=(e,o,a,s,r=6)=>{const c=e.detail,{element:l}=c;o.highlighted=!0;const d=Q(l,this.getToolName()),u=y(l),{renderingEngine:h,viewport:g}=u,{isNearFirstLine:f,isNearSecondLine:m}=this.distanceToLines({viewport:g,points:o.data.handles.points,canvasCoords:s,proximity:r});this.editData={annotation:o,viewportIdsToRender:d,movingTextBox:!1,isNearFirstLine:f,isNearSecondLine:m},this._activateModify(l),nt(l),L(d),e.preventDefault()},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c,hasMoved:l}=this.editData,{data:d}=s;if(c&&!l)return;if(this.doneEditMemo(),this.angleStartedNotYetCompleted&&d.handles.points.length<4){ht(a),this.editData.handleIndex=d.handles.points.length;return}this.angleStartedNotYetCompleted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(a),this._deactivateDraw(a),ht(a);const u=y(a),{renderingEngine:h}=u;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(s.annotationUID),L(r),c&&Lt(s),this.editData=null,this.isDrawing=!1},this._mouseDownCallback=e=>{const{annotation:o,handleIndex:a}=this.editData,s=e.detail,{element:r,currentPoints:c}=s,l=c.world,{data:d}=o;if(a===1){d.handles.points[1]=l,this.editData.hasMoved=d.handles.points[1][0]!==d.handles.points[0][0]||d.handles.points[1][1]!==d.handles.points[0][0];return}if(a===3){d.handles.points[3]=l,this.editData.hasMoved=d.handles.points[3][0]!==d.handles.points[2][0]||d.handles.points[3][1]!==d.handles.points[2][0],this.angleStartedNotYetCompleted=!1;return}this.editData.hasMoved=!1,nt(r),d.handles.points[2]=d.handles.points[3]=l,this.editData.handleIndex=d.handles.points.length-1},this._dragCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,handleIndex:c,movingTextBox:l,isNearFirstLine:d,isNearSecondLine:u,newAnnotation:h}=this.editData;this.createMemo(a,s,{newAnnotation:h});const{data:g}=s;if(l){const{deltaPoints:v}=o,p=v.world,{textBox:I}=g.handles,{worldPosition:C}=I;C[0]+=p[0],C[1]+=p[1],C[2]+=p[2],I.hasMoved=!0}else if(c===void 0&&(d||u)){const{deltaPoints:v}=o,p=v.world,I=g.handles.points;d?[I[0],I[1]].forEach(E=>{E[0]+=p[0],E[1]+=p[1],E[2]+=p[2]}):u&&[I[2],I[3]].forEach(E=>{E[0]+=p[0],E[1]+=p[1],E[2]+=p[2]}),s.invalidated=!0}else{const{currentPoints:v}=o,p=v.world;g.handles.points[c]=[...p],s.invalidated=!0}this.editData.hasMoved=!0;const f=y(a),{renderingEngine:m}=f;L(r),s.invalidated&&It(s,a,lt.HandlesUpdated)},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),ht(e);const{annotation:o,viewportIdsToRender:a,newAnnotation:s}=this.editData,{data:r}=o;r.handles.points.length<4&&ft(o.annotationUID),o.highlighted=!1,r.handles.activeHandleIndex=null;const c=y(e),{renderingEngine:l}=c;return L(a),s&&Lt(o),this.editData=null,this.angleStartedNotYetCompleted=!1,o.annotationUID},this._activateModify=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback),e.addEventListener(w.TOUCH_START,this._mouseDownCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_START,this._mouseDownCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_MOVE,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.MOUSE_DOWN,this._mouseDownCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback),e.addEventListener(w.TOUCH_START,this._mouseDownCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_MOVE,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.MOUSE_DOWN,this._mouseDownCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_START,this._mouseDownCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e,{element:r}=s;let c=Ct(this.getToolName(),r);if(!c?.length||(c=this.filterInteractableAnnotationsForElement(r,c),!c?.length))return a;const l=this.getTargetId(s),d=s.getRenderingEngine(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let h=0;h<c.length;h++){const g=c[h],{annotationUID:f,data:m}=g,{points:v,activeHandleIndex:p}=m.handles;u.annotationUID=f;const{color:I,lineWidth:C,lineDash:E}=this.getAnnotationStyle({annotation:g,styleSpecifier:u}),S=v.map(at=>s.worldToCanvas(at));!m.cachedStats[l]||m.cachedStats[l].angle==null?(m.cachedStats[l]={angle:null,arc1Angle:null,arc2Angle:null,points:{world:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null},canvas:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null}}},this._calculateCachedStats(g,d,e)):g.invalidated&&this._throttledCalculateCachedStats(g,d,e);let _;if(!se(f)&&!this.editData&&p!==null&&(_=[S[p]]),!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;if(!re(f))continue;const D=!!Ve("showHandlesAlways",{});(_||D)&&$t(o,f,"0",S,{color:I,lineDash:E,lineWidth:C});const b=[S[0],S[1]],M=[S[2],S[3]];let P="line1";if(Et(o,f,P,b[0],b[1],{color:I,width:C,lineDash:E}),a=!0,S.length<4)return a;P="line2",Et(o,f,P,M[0],M[1],{color:I,width:C,lineDash:E}),P="linkLine";const T=$n(b[0],b[1]),x=$n(M[0],M[1]);Et(o,f,P,T,x,{color:I,lineWidth:"1",lineDash:"1,4"});const{arc1Start:A,arc1End:O,arc2End:R,arc2Start:N}=m.cachedStats[l].points.canvas,{arc1Angle:k,arc2Angle:B}=m.cachedStats[l];if(this.configuration.showArcLines&&(P="arc1",Et(o,f,P,A,O,{color:I,lineWidth:"1"}),P="arc2",Et(o,f,P,N,R,{color:I,lineWidth:"1"})),!m.cachedStats[l]?.angle)continue;const V=this.getLinkedTextBoxStyle(u,g);if(!V.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const $=this.configuration.getTextLines(m,l);if(!m.handles.textBox.hasMoved){const at=qe(S);m.handles.textBox.worldPosition=s.canvasToWorld(at)}const H=s.worldToCanvas(m.handles.textBox.worldPosition),Y=Oe(o,f,"cobbAngleText",$,H,S,{},V),{x:q,y:j,width:K,height:it}=Y;if(m.handles.textBox.worldBoundingBox={topLeft:s.canvasToWorld([q,j]),topRight:s.canvasToWorld([q+K,j]),bottomLeft:s.canvasToWorld([q,j+it]),bottomRight:s.canvasToWorld([q+K,j+it])},this.configuration.showArcLines){const at="arcAngle1",bt=[`${k.toFixed(2)} `],Bt=$n(A,O);eo(o,f,at,bt,Bt,{...V,padding:3});const Yt="arcAngle2",qt=[`${B.toFixed(2)} `],Nt=$n(N,R);eo(o,f,Yt,qt,Nt,{...V,padding:3})}}return a},this.distanceToLines=({viewport:e,points:o,canvasCoords:a,proximity:s})=>{const[r,c,l,d]=o,u=e.worldToCanvas(r),h=e.worldToCanvas(c),g=e.worldToCanvas(l),f=e.worldToCanvas(d),m={start:{x:u[0],y:u[1]},end:{x:h[0],y:h[1]}},v={start:{x:g[0],y:g[1]},end:{x:f[0],y:f[1]}},p=fe([m.start.x,m.start.y],[m.end.x,m.end.y],[a[0],a[1]]),I=fe([v.start.x,v.start.y],[v.end.x,v.end.y],[a[0],a[1]]);let C=!1,E=!1;return p<=s?C=!0:I<=s&&(E=!0),{distanceToPoint:p,distanceToPoint2:I,isNearFirstLine:C,isNearSecondLine:E}},this.getArcsStartEndPoints=({firstLine:e,secondLine:o,mid1:a,mid2:s})=>{const r=[a,s],c=Ti(e,r),l=Ti(o,r),d=c>90?1:0,u=l>90?0:1,h=$n(r[0],r[1]),g=Math.sqrt((r[1][0]-r[0][0])**2+(r[1][1]-r[0][1])**2),f=.1,m=$n(e[0],e[1]),v=$n(o[0],o[1]),p=[e[d][0]-m[0],e[d][1]-m[1]],I=Math.sqrt(p[0]**2+p[1]**2),C=[p[0]/I,p[1]/I],E=[m[0]+C[0]*g*f,m[1]+C[1]*g*f],S=[h[0]-a[0],h[1]-a[1]],_=Math.sqrt(S[0]**2+S[1]**2),D=[S[0]/_,S[1]/_],b=[a[0]+D[0]*g*f,a[1]+D[1]*g*f],M=[o[u][0]-v[0],o[u][1]-v[1]],P=Math.sqrt(M[0]**2+M[1]**2),T=[M[0]/P,M[1]/P],x=[v[0]+T[0]*g*f,v[1]+T[1]*g*f],A=[h[0]-s[0],h[1]-s[1]],O=Math.sqrt(A[0]**2+A[1]**2),R=[A[0]/O,A[1]/O],N=[s[0]+R[0]*g*f,s[1]+R[1]*g*f];return{arc1Start:E,arc1End:b,arc2Start:x,arc2End:N,arc1Angle:c>90?180-c:c,arc2Angle:l>90?180-l:l}},this._throttledCalculateCachedStats=Fe(this._calculateCachedStats,25,{trailing:!0})}handleSelectedCallback(t,n,e,o="mouse"){const a=t.detail,{element:s}=a,{data:r}=n;n.highlighted=!0;let c=!1,l;e.worldPosition?c=!0:l=r.handles.points.findIndex(u=>u===e);const d=Q(s,this.getToolName());this.editData={annotation:n,viewportIdsToRender:d,handleIndex:l,movingTextBox:c},this._activateModify(s),nt(s),L(d),t.preventDefault()}_calculateCachedStats(t,n,e){const o=t.data;if(o.handles.points.length!==4)return;const a=[null,null],s=[null,null];let r=Number.MAX_VALUE;for(let b=0;b<2;b+=1)for(let M=2;M<4;M+=1){const P=Te(o.handles.points[b],o.handles.points[M]);P<r&&(r=P,a[1]=o.handles.points[b],a[0]=o.handles.points[(b+1)%2],s[0]=o.handles.points[M],s[1]=o.handles.points[2+(M-1)%2])}const{viewport:c}=e,{element:l}=c,d=o.handles.points.map(b=>c.worldToCanvas(b)),u=[d[0],d[1]],h=[d[2],d[3]],g=$n(u[0],u[1]),f=$n(h[0],h[1]),{arc1Start:m,arc1End:v,arc2End:p,arc2Start:I,arc1Angle:C,arc2Angle:E}=this.getArcsStartEndPoints({firstLine:u,secondLine:h,mid1:g,mid2:f}),{cachedStats:S}=o,_=Object.keys(S);for(let b=0;b<_.length;b++){const M=_[b];S[M]={angle:Ti(a,s),arc1Angle:C,arc2Angle:E,points:{canvas:{arc1Start:m,arc1End:v,arc2End:p,arc2Start:I},world:{arc1Start:c.canvasToWorld(m),arc1End:c.canvasToWorld(v),arc2End:c.canvasToWorld(p),arc2Start:c.canvasToWorld(I)}}}}const D=t.invalidated;return t.invalidated=!1,D&&It(t,l,lt.StatsUpdated),S}};cu.toolName="CobbAngle";let sg=cu;function BA(i,t){const n=i.cachedStats[t],{angle:e}=n;return e===void 0?void 0:[`${e.toFixed(2)} `]}const{transformWorldToIndex:rg}=Rt,lu=class lu extends zt{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:GA,displayBothAxesDistances:!1}}){super(t,n),this.addNewAnnotation=e=>{if(this.startedDrawing)return;this.startedDrawing=!0;const o=e.detail,{currentPoints:a,element:s}=o,r=a.world,c=y(s),{viewport:l}=c;if(!(l instanceof Ie))throw new Error("UltrasoundDirectionalTool can only be used on a StackViewport");nt(s),this.isDrawing=!0;const d=this.createAnnotation(e,[[...r],[...r]]);mt(d,s);const u=Q(s,this.getToolName());return this.editData={annotation:d,viewportIdsToRender:u,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(s),e.preventDefault(),L(u),d},this.isPointNearTool=(e,o,a,s)=>{const r=y(e),{viewport:c}=r,{data:l}=o,[d,u]=l.handles.points,h=c.worldToCanvas(d),g=c.worldToCanvas(u),f={start:{x:h[0],y:h[1]},end:{x:g[0],y:g[1]}};return fe([f.start.x,f.start.y],[f.end.x,f.end.y],[a[0],a[1]])<=s},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c,hasMoved:l}=this.editData,{data:d}=s;if(c&&!l)return;if(this.startedDrawing&&d.handles.points.length===1){this.editData.handleIndex=1;return}this.startedDrawing=!1,d.handles.activeHandleIndex=null,this._deactivateModify(a),this._deactivateDraw(a),ht(a);const u=y(a),{renderingEngine:h}=u;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(s.annotationUID),L(r),c&&Lt(s),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,handleIndex:c,movingTextBox:l}=this.editData,{data:d}=s;if(l){const{deltaPoints:g}=o,f=g.world,{textBox:m}=d.handles,{worldPosition:v}=m;v[0]+=f[0],v[1]+=f[1],v[2]+=f[2],m.hasMoved=!0}else if(c===void 0){const{deltaPoints:g}=o,f=g.world;d.handles.points.forEach(v=>{v[0]+=f[0],v[1]+=f[1],v[2]+=f[2]}),s.invalidated=!0}else{const{currentPoints:g}=o,f=g.world;d.handles.points[c]=[...f],s.invalidated=!0}this.editData.hasMoved=!0;const u=y(a),{renderingEngine:h}=u;L(r)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),ht(e);const{annotation:o,viewportIdsToRender:a,newAnnotation:s}=this.editData,{data:r}=o;return o.highlighted=!1,r.handles.activeHandleIndex=null,L(a),s&&Lt(o),this.editData=null,this.startedDrawing=!1,o.annotationUID}},this._activateModify=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback)},this._activateDraw=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_MOVE,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_MOVE,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e,{element:r}=s;let c=Ct(this.getToolName(),r);if(!c?.length||(c=this.filterInteractableAnnotationsForElement(r,c),!c?.length))return a;const l=this.getTargetId(s),d=s.getRenderingEngine(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let h=0;h<c.length;h++){const g=c[h],{annotationUID:f,data:m}=g,{points:v}=m.handles;u.annotationUID=f;const p=this.getStyle("color",u,g),I=v.map(O=>s.worldToCanvas(O));if(!m.cachedStats[l]||m.cachedStats[l].xValues==null?(m.cachedStats[l]={xValues:[0,0],yValues:[0,0],isHorizontal:!1,units:[""],isUnitless:!1},this._calculateCachedStats(g,d,e)):g.invalidated&&this._throttledCalculateCachedStats(g,d,e),!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;let C="0";if(Xs(o,f,C,I[0],{color:p},0),a=!0,I.length!==2)return a;if(C="1",Xs(o,f,C,I[1],{color:p},1),m.cachedStats[l].isUnitless){const O=`${f}-line-1`;Et(o,f,"1",I[0],I[1],{color:p,width:1,shadow:this.configuration.shadow},O)}else{const O=I[0],R=I[1],N=R[1]-O[1],k=R[0]-O[0],B=m.cachedStats[l].isHorizontal;let V=[0,0];B?V=[O[0]+k,O[1]]:V=[O[0],O[1]+N];let $=`${f}-line-1`,H="1";Et(o,f,H,I[0],V,{color:p,width:1,shadow:this.configuration.shadow},$),$=`${f}-line-2`,H="2",Et(o,f,H,I[1],V,{color:p,width:1,lineDash:[1,1],shadow:this.configuration.shadow},$)}const S=this.getLinkedTextBoxStyle(u,g);if(!S.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const _=this.configuration.getTextLines(m,l,this.configuration);if(!m.handles.textBox.hasMoved){const O=I[1];m.handles.textBox.worldPosition=s.canvasToWorld(O)}const D=s.worldToCanvas(m.handles.textBox.worldPosition),M=Oe(o,f,"1",_,D,I,{},S),{x:P,y:T,width:x,height:A}=M;m.handles.textBox.worldBoundingBox={topLeft:s.canvasToWorld([P,T]),topRight:s.canvasToWorld([P+x,T]),bottomLeft:s.canvasToWorld([P,T+A]),bottomRight:s.canvasToWorld([P+x,T+A])}}return a},this._throttledCalculateCachedStats=Fe(this._calculateCachedStats,100,{trailing:!0})}toolSelectedCallback(t,n,e,o){}handleSelectedCallback(t,n,e){const o=t.detail,{element:a}=o,{data:s}=n;n.highlighted=!0;const r=Q(a,this.getToolName());let c;e.worldPosition||(c=s.handles.points.findIndex(u=>u===e)),this.editData={handleIndex:c,annotation:n,viewportIdsToRender:r},this._activateModify(a),nt(a);const l=y(a),{renderingEngine:d}=l;L(r),t.preventDefault()}_calculateCachedStats(t,n,e){const o=t.data,{element:a}=e.viewport;if(o.handles.points.length!==2)return;const{cachedStats:s}=o,r=Object.keys(s);for(let l=0;l<r.length;l++){const d=r[l],u=this.getTargetImageData(d);if(!u)continue;const{imageData:h}=u,g=o.handles.points[0],f=o.handles.points[1],m=rg(h,g),v=rg(h,f),{values:p,units:I}=Zs(u,[m]),{values:C,units:E}=Zs(u,[v]);let S,_,D,b,M=!1;if(I[0]!==E[0]||I[1]!==E[1]||I[0]==="raw"&&E[0]==="raw"){const P=Fn(g,f);S=[P,0],_=[P,0],D=["px"],M=!0}else{const P=e.viewport.worldToCanvas(g),T=e.viewport.worldToCanvas(f),x=T[1]-P[1],A=T[0]-P[0];b=Math.abs(A)>Math.abs(x),S=[p[0],C[0]],_=[p[1],C[1]],D=[I[0],I[1]]}s[d]={xValues:S,yValues:_,isHorizontal:b,units:D,isUnitless:M}}const c=t.invalidated;return t.invalidated=!1,c&&It(t,a,lt.StatsUpdated),s}};lu.toolName="UltrasoundDirectionalTool";let cg=lu;function GA(i,t,n){const e=i.cachedStats[t],{xValues:o,yValues:a,units:s,isUnitless:r,isHorizontal:c}=e;if(r)return[`${_t(o[0])} px`];if(n.displayBothAxesDistances){const l=Math.abs(o[1]-o[0]),d=Math.abs(a[1]-a[0]);return[`${_t(l)} ${s[0]}`,`${_t(d)} ${s[1]}`]}if(c){const l=Math.abs(o[1]-o[0]);return[`${_t(l)} ${s[0]}`]}else{const l=Math.abs(a[1]-a[0]);return[`${_t(l)} ${s[1]}`]}}function WA(i){return(i%360+360)%360}function Sl(i,t){const n=t[0]-i[0],e=t[1]-i[1],o=Math.atan2(e,n)*(180/Math.PI);return WA(o)}function dr(i,t){const n=Sl(i,t[0]),e=Sl(i,t[1]);return n<e?[n,e]:[e,n]}function _l(i){if(!i.length)return[];i.sort((n,e)=>n[0]-e[0]);const t=[i[0].slice()];for(let n=1;n<i.length;n++){const e=t[t.length-1],o=i[n];o[0]<=e[1]?e[1]=Math.max(e[1],o[1]):t.push(o.slice())}return t}function lg(i,t){const[n,e]=t;if(e<=n)return[];const o=i.map(([d,u])=>[Math.max(d,n),Math.min(u,e)]).filter(([d,u])=>u>d);if(o.length===0)return[[n,e]];o.sort((d,u)=>d[0]-u[0]);const a=[];let[s,r]=o[0];for(let d=1;d<o.length;d++){const[u,h]=o[d];u<=r?r=Math.max(r,h):(a.push([s,r]),[s,r]=[u,h])}a.push([s,r]);const c=[];let l=n;for(const[d,u]of a)d>l&&c.push([l,d]),l=Math.max(l,u);return l<e&&c.push([l,e]),c}function PI(i,t){const n=[];for(const e of t){const o=Math.max(i[0],e[0]),a=Math.min(i[1],e[1]);o<a&&n.push([o,a])}return n}function $A(i,t,n){const e=t.map(d=>dr(i,d)),o=_l(e),a=o.reduce((d,[u,h])=>d+(h-u),0);if(a===0)return 0;const s=[];for(const d of n){const u=dr(i,d),h=PI(u,o);s.push(...h)}const l=_l(s).reduce((d,[u,h])=>d+(h-u),0)/a*100;return Math.min(100,Math.max(0,l))}const{transformIndexToWorld:dg}=Rt,Qt=class Qt extends zt{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:HA,center:null,innerRadius:null,outerRadius:null,startAngle:null,endAngle:null,bLineColor:"rgb(60, 255, 60)",pleuraColor:"rgb(0, 4, 255)",drawDepthGuide:!0,depth_ratio:.5,depthGuideColor:"rgb(0, 255, 255)",depthGuideThickness:4,depthGuideDashLength:20,depthGuideDashGap:16,depthGuideOpacity:.2,fanOpacity:.1,showFanAnnotations:!0,updatePercentageCallback:null,actions:{undo:{method:"undo",bindings:[{key:"z"}]},redo:{method:"redo",bindings:[{key:"y"}]}}}}){super(t,n),this.pleuraAnnotations=[],this.bLineAnnotations=[],this.addNewAnnotation=e=>{const o=e.detail,{currentPoints:a,element:s}=o,r=a.world,c=y(s),{viewport:l}=c;nt(s),this.isDrawing=!0;const{viewPlaneNormal:d,viewUp:u,position:h}=l.getCamera(),g=this.getReferencedImageId(l,r,d,u),f={highlighted:!0,invalidated:!0,metadata:{...l.getViewReference({points:[r]}),toolName:this.getToolName(),referencedImageId:g,viewUp:u,cameraPosition:h},data:{handles:{points:[[...r],[...r]],activeHandleIndex:null},annotationType:this.getActiveAnnotationType(),label:""}};mt(f,s);const m=Q(s,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(s),e.preventDefault(),L(m),f},this.isPointNearTool=(e,o,a,s)=>{const r=y(e),{viewport:c}=r,{data:l}=o,[d,u]=l.handles.points,h=c.worldToCanvas(d),g=c.worldToCanvas(u),f={start:{x:h[0],y:h[1]},end:{x:g[0],y:g[1]}};return fe([f.start.x,f.start.y],[f.end.x,f.end.y],[a[0],a[1]])<=s},this.toolSelectedCallback=(e,o)=>{const a=e.detail,{element:s}=a;o.highlighted=!0;const r=Q(s,this.getToolName());this.editData={annotation:o,viewportIdsToRender:r,movingTextBox:!1},this._activateModify(s),nt(s),L(r),e.preventDefault()},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c,hasMoved:l}=this.editData,{data:d}=s;c&&!l||(d.handles.activeHandleIndex=null,this._deactivateModify(a),this._deactivateDraw(a),ht(a),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(s.annotationUID),L(r),this.doneEditMemo(),c&&Lt(s),this.editData=null,this.isDrawing=!1)},this._dragCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{viewport:s}=y(a)||{};if(!s)return;const{annotation:r,viewportIdsToRender:c,handleIndex:l,movingTextBox:d,newAnnotation:u}=this.editData,{data:h}=r;if(this.createMemo(a,r,{newAnnotation:u}),d){const{deltaPoints:g}=o,f=g.world,{textBox:m}=h.handles,{worldPosition:v}=m;v[0]+=f[0],v[1]+=f[1],v[2]+=f[2],m.hasMoved=!0}else if(l===void 0){const{deltaPoints:g}=o,f=g.world,m=h.handles.points;m.every(p=>{const I=[p[0]+f[0],p[1]+f[1],p[2]+f[2]];return this.isInsideFanShape(s,I)})&&(m.forEach(p=>{p[0]+=f[0],p[1]+=f[1],p[2]+=f[2]}),r.invalidated=!0)}else{const{currentPoints:g}=o,f=g.world;this.isInsideFanShape(s,f)&&(h.handles.points[l]=[...f],r.invalidated=!0)}this.editData.hasMoved=!0,L(c),r.invalidated&&It(r,a,lt.HandlesUpdated)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),ht(e);const{annotation:o,viewportIdsToRender:a,newAnnotation:s}=this.editData,{data:r}=o;return o.highlighted=!1,r.handles.activeHandleIndex=null,L(a),s&&Lt(o),this.editData=null,o.annotationUID}},this._activateModify=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_MOVE,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_MOVE,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e,{element:r}=s;if(!this.getFanShapeGeometryParameters(s))return;const{imageData:c}=s.getImageData()||{};if(!c)return a;this.configuration.drawDepthGuide&&this.drawDepthGuide(o,s);let l=Ct(this.getToolName(),r);if(!l?.length||(l=this.filterInteractableAnnotationsForElement(r,l),!l?.length))return a;this.getTargetId(s),s.getRenderingEngine();const d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},u=s.worldToCanvas(dg(c,this.configuration.center)),h=this.getIndexToCanvasRatio(s),g=this.configuration.innerRadius*h,f=this.configuration.outerRadius*h,m=s.getCurrentImageId(),v=l.filter(D=>D.data.annotationType===Qt.USPleuraBLineAnnotationType.PLEURA&&D.metadata.referencedImageId===m).map(D=>{const b=D.data.handles.points.map(P=>s.worldToCanvas(P));return dr(u,b)}),p=_l(v),I=[],C=[],E=D=>{const{annotationUID:b,data:M}=D,{points:P,activeHandleIndex:T}=M.handles;d.annotationUID=b;const{color:x,lineWidth:A,lineDash:O,shadow:R}=this.getAnnotationStyle({annotation:D,styleSpecifier:d}),N=P.map($=>s.worldToCanvas($));if(!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;let k;if(!re(b))return;!se(b)&&!this.editData&&T!==null&&(k=[N[T]]),k&&$t(o,b,"0",N,{color:this.getColorForLineType(D),fill:this.getColorForLineType(D),lineDash:O,lineWidth:A});const B=`${b}-line`;if(Et(o,b,"1",N[0],N[1],{color:this.getColorForLineType(D),width:A,lineDash:O,shadow:R},B),this.configuration.showFanAnnotations){const $=dr(u,N);let H=0;D.data.annotationType===Qt.USPleuraBLineAnnotationType.BLINE?lg(C,$).forEach(Y=>{PI(Y,p).forEach(j=>{H++;const K=H,it=`${b}-fan-${K}`,at=`2-${K}`;tl(o,b,at,u,g,f,j[0],j[1],{color:"transparent",fill:this.getColorForLineType(D),fillOpacity:this.configuration.fanOpacity,width:A,lineDash:O,shadow:R},it,10),C.push(j)})}):D.data.annotationType===Qt.USPleuraBLineAnnotationType.PLEURA&&lg(I,$).forEach((Y,q)=>{H++;const j=H,K=`${b}-fan-${j}`,it=`2-${j}`;tl(o,b,it,u,g,f,Y[0],Y[1],{color:"transparent",fill:this.getColorForLineType(D),fillOpacity:this.configuration.fanOpacity,width:A,lineDash:O,shadow:R},K,5),I.push(Y)})}};return l.filter(D=>D.data.annotationType===Qt.USPleuraBLineAnnotationType.PLEURA&&D.metadata.referencedImageId===m).forEach(D=>{if(!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;E(D)}),l.filter(D=>D.data.annotationType===Qt.USPleuraBLineAnnotationType.BLINE&&D.metadata.referencedImageId===m).forEach(D=>{if(!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;E(D)}),a=!0,this.configuration.updatePercentageCallback&&s&&this.configuration.updatePercentageCallback(this.calculateBLinePleuraPercentage(s)),a},this.activeAnnotationType=Qt.USPleuraBLineAnnotationType.BLINE}static filterAnnotations(t,n=()=>!0){const e=Ct(Qt.toolName,t);return e?.length?e.filter(a=>{const s=a.metadata.referencedImageId;return n(s)}):[]}static countAnnotations(t,n=()=>!0){const e=Ct(Qt.toolName,t),{viewport:o}=y(t),a=o.getImageIds(),s=c=>{const l=a.findIndex(d=>d===c);return l===-1?0:l};if(!e?.length)return;const r=new Map;return e.forEach(c=>{const l=c.metadata.referencedImageId;if(!n(l))return;const{annotationType:d}=c.data;let u;r.has(l)?u=r.get(l):u={frame:s(l),bLine:0,pleura:0},d===Qt.USPleuraBLineAnnotationType.PLEURA?u.pleura++:d===Qt.USPleuraBLineAnnotationType.BLINE&&u.bLine++,r.set(l,u)}),r}static deleteAnnotations(t,n=()=>!1){const e=Ct(Qt.toolName,t);e?.length&&e.forEach(o=>{n(o.metadata.referencedImageId)&&ft(o.annotationUID)})}setActiveAnnotationType(t){this.activeAnnotationType=t}getActiveAnnotationType(){return this.activeAnnotationType}deleteLastAnnotationType(t,n){let e;const o=Ct(Qt.toolName,t);if(n===Qt.USPleuraBLineAnnotationType.PLEURA?e=o.filter(a=>a.data.annotationType===Qt.USPleuraBLineAnnotationType.PLEURA):n===Qt.USPleuraBLineAnnotationType.BLINE&&(e=o.filter(a=>a.data.annotationType===Qt.USPleuraBLineAnnotationType.BLINE)),e?.length>0){const a=e.pop();ft(a.annotationUID)}}handleSelectedCallback(t,n,e){const o=t.detail,{element:a}=o,{data:s}=n;n.highlighted=!0;let r=!1,c;e.worldPosition?r=!0:c=s.handles.points.findIndex(d=>d===e);const l=Q(a,this.getToolName());this.editData={annotation:n,viewportIdsToRender:l,handleIndex:c,movingTextBox:r},this._activateModify(a),nt(a),L(l),t.preventDefault()}isInsideFanShape(t,n){if(!this.getFanShapeGeometryParameters(t))return!1;const{imageData:e}=t.getImageData()||{};if(e){const o=t.worldToCanvas(e.indexToWorld(this.configuration.center)),a=t.worldToCanvas(n),s=Sl(o,a);return s>=this.configuration.startAngle&&s<=this.configuration.endAngle}}updateFanGeometryConfiguration(t){t&&(this.isFanShapeGeometryParametersValid(t)&&(this.configuration.center=[t.center[0],t.center[1],0]),this.configuration.innerRadius=t.innerRadius,this.configuration.outerRadius=t.outerRadius,this.configuration.startAngle=t.startAngle,this.configuration.endAngle=t.endAngle)}deriveFanGeometryFromViewport(t){const n=t.getCurrentImageId(),{fanGeometry:e}=qd(n)||{};e&&this.updateFanGeometryConfiguration(e)}isFanShapeGeometryParametersValid(t){return t||(t=this.configuration),t?.center&&t?.innerRadius>0&&t?.outerRadius&&t?.startAngle>0&&t?.startAngle<360&&t?.endAngle>0&&t?.endAngle<360}getFanShapeGeometryParameters(t){if(this.isFanShapeGeometryParametersValid())return!0;if(!this.isFanShapeGeometryParametersValid()){const n=t.getCurrentImageId(),e=ye("ultrasoundFanShapeGeometry",n);this.updateFanGeometryConfiguration(e)}return this.isFanShapeGeometryParametersValid()||this.deriveFanGeometryFromViewport(t),this.isFanShapeGeometryParametersValid()}calculateBLinePleuraPercentage(t){if(!this.getFanShapeGeometryParameters(t))return;const{imageData:n}=t.getImageData()||{};if(!n)return;const{element:e}=t,o=t.worldToCanvas(n.indexToWorld(this.configuration.center)),a=t.getCurrentImageId(),s=Ct(this.getToolName(),e)||[],r=s.filter(l=>l.data.annotationType===Qt.USPleuraBLineAnnotationType.PLEURA&&l.metadata.referencedImageId===a).map(l=>l.data.handles.points.map(u=>t.worldToCanvas(u))),c=s.filter(l=>l.data.annotationType===Qt.USPleuraBLineAnnotationType.BLINE&&l.metadata.referencedImageId===a).map(l=>l.data.handles.points.map(u=>t.worldToCanvas(u)));return $A(o,r,c)}getColorForLineType(t){const{annotationType:n}=t.data,{bLineColor:e,pleuraColor:o}=this.configuration;return n===Qt.USPleuraBLineAnnotationType.BLINE?e:n===Qt.USPleuraBLineAnnotationType.PLEURA?o:e}getIndexToCanvasRatio(t){const{imageData:n}=t.getImageData()||{},e=t.worldToCanvas(n.indexToWorld([1,0,0])),o=t.worldToCanvas(n.indexToWorld([2,0,0])),a=[o[0]-e[0],o[1]-e[1]];return Math.sqrt(a[0]*a[0]+a[1]*a[1])}drawDepthGuide(t,n){if(!this.getFanShapeGeometryParameters(n))return;const{imageData:e}=n.getImageData()||{};if(!e)return;const o=f=>f*180/Math.PI,a=f=>f*Math.PI/180,s=f=>n.worldToCanvas(dg(e,f)),r=this.configuration.innerRadius+this.configuration.depth_ratio*(this.configuration.outerRadius-this.configuration.innerRadius),c=this.configuration.startAngle,d=this.configuration.endAngle-c,u=a(d)*r;let h=Math.round(u/(this.configuration.depthGuideDashLength+this.configuration.depthGuideDashGap));h<=0&&(h=Math.max(15,Math.round(d/5)));const g=d/h;for(let f=0;f<h;f++){const m=a(c+f*g),v=a(c+f*g+o(this.configuration.depthGuideDashLength)/r),p=[this.configuration.center[0]+r*Math.cos(m),this.configuration.center[1]+r*Math.sin(m),0],I=[this.configuration.center[0]+r*Math.cos(v),this.configuration.center[1]+r*Math.sin(v),0];Et(t,n.id,`depthGuide-${f}`,s(p),s(I),{color:this.configuration.depthGuideColor,lineWidth:this.configuration.depthGuideThickness,strokeOpacity:this.configuration.depthGuideOpacity})}}_isInsideVolume(t,n,e){return we(t,e)&&we(n,e)}};Qt.toolName="UltrasoundPleuraBLineTool",Qt.USPleuraBLineAnnotationType={BLINE:"bLine",PLEURA:"pleura"},Qt.hydrate=(t,n,e)=>{const o=At(t);if(!o)return;const{FrameOfReferenceUID:a,referencedImageId:s,viewPlaneNormal:r,instance:c,viewport:l}=Qt.hydrateBase(Qt,o,n,e),{toolInstance:d,...u}=e||{},h={annotationUID:e?.annotationUID||Xt(),data:{handles:{points:n}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:c.getToolName(),viewPlaneNormal:r,FrameOfReferenceUID:a,referencedImageId:s,...u}};mt(h,l.element),L([l.id])};let ug=Qt;function HA(i,t){return[""]}const Ta=class Ta extends zt{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{getTextCallback:zA,changeTextCallback:jA,canvasPosition:[10,10],canvasSize:10,handleRadius:"6",seriesLevel:!1,isPoint:!1}}){super(t,n),this.addNewAnnotation=e=>{const o=e.detail,{element:a,currentPoints:s}=o,r=y(a),{viewport:c}=r,l=s.world,d=this.constructor.createAnnotationForViewport(c,{data:{handles:{points:[[...l]]},seriesLevel:this.configuration.seriesLevel,isPoint:this.configuration.isPoint}});mt(d,a);const u=Q(a,this.getToolName());return e.preventDefault(),L(u),this.configuration.getTextCallback(h=>{if(!h){ft(d.annotationUID),L(u),this.isDrawing=!1;return}d.data.label=h,Lt(d),L(u)}),this.createMemo(a,d,{newAnnotation:!0}),d},this.isPointNearTool=(e,o,a,s)=>{const r=y(e),{viewport:c}=r,{data:l}=o;if(!l?.isPoint)return!1;const{canvasPosition:d,canvasSize:u}=this.configuration;return d?.length?Math.abs(a[0]-d[0]+u/2)<=u/2&&Math.abs(a[1]-d[1]+u/2)<=u/2:!1},this.toolSelectedCallback=(e,o)=>{o.highlighted=!0,e.preventDefault()},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c}=this.editData,{viewportId:l,renderingEngine:d}=y(a);this.eventDispatchDetail={viewportId:l,renderingEngineId:d.id},this._deactivateModify(a),ht(a),c&&this.createMemo(a,s,{newAnnotation:c}),this.editData=null,this.isDrawing=!1,this.doneEditMemo(),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(s.annotationUID),L(r),c&&Lt(s)},this.doubleClickCallback=e=>{const o=e.detail,{element:a}=o;let s=Ct(this.getToolName(),a);if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return;const r=s.find(l=>this.isPointNearTool(a,l,o.currentPoints.canvas,6));if(!r)return;const c=r;this.createMemo(a,c),this.configuration.changeTextCallback(r,e.detail,this._doneChangingTextCallback.bind(this,a,c)),this.isDrawing=!1,this.doneEditMemo(),e.stopImmediatePropagation(),e.preventDefault()},this._dragCallback=e=>{this.isDrawing=!0;const o=e.detail,{currentPoints:a,element:s}=o,r=a.world,{annotation:c,viewportIdsToRender:l,newAnnotation:d}=this.editData,{data:u}=c;this.createMemo(s,c,{newAnnotation:d}),u.handles.points[0]=[...r],c.invalidated=!0,L(l)},this._activateModify=e=>{U.isInteractingWithTool=!0,e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{U.isInteractingWithTool=!1,e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e,{element:r}=s;let c=Ct(this.getToolName(),r);if(!c?.length||(c=this.filterInteractableAnnotationsForElement(r,c),!c?.length))return a;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let d=0;d<c.length;d++){const u=c[d],{annotationUID:h,data:g}=u;l.annotationUID=h;const{color:f,lineWidth:m}=this.getAnnotationStyle({annotation:u,styleSpecifier:l}),{canvasPosition:v,canvasSize:p}=this.configuration,I="1";if(g?.isPoint){const C=g.handles.points[0],E=s.worldToCanvas(C);$t(o,h,I,[E],{color:f,lineWidth:m,handleRadius:this.configuration.handleRadius})}else v?.length&&Ys(o,h,I,v.map(C=>C+p),v,{color:f,width:1});if(a=!0,!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a}return a}}handleSelectedCallback(t,n){const e=t.detail,{element:o}=e;n.highlighted=!0;const a=Q(o,this.getToolName());this.editData={annotation:n,viewportIdsToRender:a},this._activateModify(o),nt(o),L(a),t.preventDefault()}static setPoint(t,n=!t.data.isPoint,e){t.data.isPoint=n,It(t,e)}_doneChangingTextCallback(t,n,e){n.data.label=e;const o=Q(t,this.getToolName());L(o),It(n,t)}cancel(t){if(this.isDrawing){this.isDrawing=!1,this._deactivateModify(t),ht(t);const{annotation:n,viewportIdsToRender:e,newAnnotation:o}=this.editData,{data:a}=n;return n.highlighted=!1,a.handles.activeHandleIndex=null,L(e),o&&Lt(n),this.editData=null,n.annotationUID}}_isInsideVolume(t,n,e){return we(t,e)&&we(n,e)}};Ta.toolName="KeyImage",Ta.dataSeries={data:{seriesLevel:!0}},Ta.dataPoint={data:{isPoint:!0}};let hg=Ta;function zA(i){return i(prompt("Enter your annotation:"))}function jA(i,t,n){return n(prompt("Enter your annotation:"))}class XA extends de{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"]}){super(t,n),this.preMouseDownCallback=e=>this._deleteNearbyAnnotations(e,"mouse"),this.preTouchStartCallback=e=>this._deleteNearbyAnnotations(e,"touch")}_deleteNearbyAnnotations(t,n){const{renderingEngineId:e,viewportId:o,element:a,currentPoints:s}=t.detail,r=ne(o,e);if(!r)return!1;const c=r._toolInstances,l=[];for(const d in c){const u=c[d];if(typeof u.isPointNearTool!="function"||typeof u.filterInteractableAnnotationsForElement!="function")continue;const h=Ct(d,a),g=u.filterInteractableAnnotationsForElement(a,h);if(g)for(const f of g)u.isPointNearTool(a,f,s.canvas,10,n)&&l.push(f.annotationUID)}for(const d of l){cn(d);const u=xt(d);zt.createAnnotationMemo(a,u,{deleting:!0}),ft(d)}return t.preventDefault(),!0}}XA.toolName="Eraser";const{transformWorldToIndex:gg,transformIndexToWorld:YA}=Rt,Pa=class Pa extends de{constructor(t,n){const e=Be({configuration:{positiveStdDevMultiplier:Bv,shrinkExpandIncrement:.1,islandRemoval:{enabled:!1}}},n);super(t,e)}async preMouseDownCallback(t){const n=t.detail,{element:e,currentPoints:o}=n,{world:a}=o,s=y(e),{viewport:r,renderingEngine:c}=s,{viewUp:l}=r.getCamera(),{segmentationId:d,segmentIndex:u,labelmapVolumeId:h,referencedVolumeId:g}=await this.getLabelmapSegmentationData(r);if(!this._isOrthogonalView(r,g))throw new Error("Oblique view is not supported yet");return this.growCutData={metadata:{...r.getViewReference({points:[a]}),viewUp:l},segmentation:{segmentationId:d,segmentIndex:u,labelmapVolumeId:h,referencedVolumeId:g},viewportId:r.id,renderingEngineId:c.id},t.preventDefault(),!0}shrink(){this._runLastCommand({shrinkExpandAmount:-this.configuration.shrinkExpandIncrement})}expand(){this._runLastCommand({shrinkExpandAmount:this.configuration.shrinkExpandIncrement})}refresh(){this._runLastCommand()}async getGrowCutLabelmap(t){throw new Error("Not implemented")}async runGrowCut(){const{growCutData:t,configuration:n}=this,{segmentation:{segmentationId:e,segmentIndex:o,labelmapVolumeId:a}}=t,s=X.getVolume(a);let r=0;const c=async({shrinkExpandAmount:l=0}={})=>{l!==0&&(this.seeds=null),r+=l;const d=Math.max(.1,n.positiveStdDevMultiplier+r),u=l<0?Math.max(1,ll-Math.abs(r)*3):ll+r*3,h={...t,options:{...t.options||{},positiveSeedValue:o,negativeSeedValue:255,positiveStdDevMultiplier:d,negativeSeedMargin:u}},g=await this.getGrowCutLabelmap(h),{isPartialVolume:f}=n;(f?this.applyPartialGrowCutLabelmap:this.applyGrowCutLabelmap)(e,o,s,g),this._removeIslands(h)};await c(),Pa.lastGrowCutCommand=c,this.growCutData=null}applyPartialGrowCutLabelmap(t,n,e,o){const a=o.voxelManager.getCompleteScalarDataArray(),s=e.voxelManager,[r,c,l]=o.dimensions,[d,u]=e.dimensions,h=r*c,g=d*u;for(let f=0;f<l;f++)for(let m=0;m<c;m++){const v=[0,m,f],p=YA(o.imageData,v),I=gg(e.imageData,p),[C,E,S]=I,_=m*r+f*h,D=C+E*d+S*g;for(let b=0;b<r;b++){const M=a[_+b]===n?n:0;s.setAtIndex(D+b,M)}}Pe(t)}applyGrowCutLabelmap(t,n,e,o){const a=e.voxelManager;o.voxelManager.forEach(({value:r,index:c})=>{r===n&&a.setAtIndex(c,r)}),Pe(t)}_runLastCommand({shrinkExpandAmount:t=0}={}){const n=Pa.lastGrowCutCommand;n&&n({shrinkExpandAmount:t})}async getLabelmapSegmentationData(t){const n=oo(t.id);if(!n)throw new Error("No active segmentation found");const{segmentationId:e}=n,o=$e(e),{representationData:a}=pt(e),s=a[tt.Labelmap];let{volumeId:r,referencedVolumeId:c}=s;if(!r){const l=t.getImageIds();if(ei(l))r=Yi(e).volumeId;else{const d=t.getCurrentImageId(),u=X.getImage(d),h=Cu(d);c=this._createFakeVolume([u.imageId,h.imageId]).volumeId;const f=Mo(t.id,e),m=Cu(f);r=this._createFakeVolume([f,m.imageId]).volumeId}}if(!c){const{imageIds:l}=s,d=l.map(g=>X.getImage(g).referencedImageId),u=X.generateVolumeId(d),h=X.getVolume(u);c=h?h.volumeId:(await xl(u,d)).volumeId}return{segmentationId:e,segmentIndex:o,labelmapVolumeId:r,referencedVolumeId:c}}_createFakeVolume(t){const n=X.generateVolumeId(t),e=X.getVolume(n);if(e)return e;const o=O0(t,n),a=o.spacing;a[2]===0&&(a[2]=1);const s=new L0({volumeId:n,dataType:o.dataType,metadata:structuredClone(o.metadata),dimensions:o.dimensions,spacing:o.spacing,origin:o.origin,direction:o.direction,referencedVolumeId:o.referencedVolumeId,imageIds:o.imageIds,referencedImageIds:o.referencedImageIds});return X.putVolumeSync(n,s),s}_isOrthogonalView(t,n){const o=X.getVolume(n).imageData,a=t.getCamera(),{ijkVecColDir:s,ijkVecSliceDir:r}=Ol(o,a);return[s,r].every(c=>Pt(Math.abs(c[0]),1)||Pt(Math.abs(c[1]),1)||Pt(Math.abs(c[2]),1))}getRemoveIslandData(t){}_removeIslands(t){const{islandRemoval:n}=this.configuration;if(!n.enabled)return;const{segmentation:{segmentIndex:e,labelmapVolumeId:o},renderingEngineId:a,viewportId:s}=t,r=X.getVolume(o),c=this.getRemoveIslandData(t);if(!c)return;const[l,d]=r.dimensions,u=l*d,{worldIslandPoints:h=[],islandPointIndexes:g=[]}=c;let f=[...c?.ijkIslandPoints??[]];const v=te(a).getViewport(s),{voxelManager:p}=r,I=new Jo;f=f.concat(h.map(C=>gg(r.imageData,C))),f=f.concat(g.map(C=>{const E=C%l,S=Math.floor(C/l)%d,_=Math.floor(C/u);return[E,S,_]})),I.initialize(v,p,{points:f,previewSegmentIndex:e,segmentIndex:e}),I.floodFillSegmentIsland(),I.removeExternalIslands(),I.removeInternalIslands()}getSegmentStyle({segmentationId:t,viewportId:n,segmentIndex:e}){return mp({segmentationId:t,segmentIndex:e,viewportId:n})}};Pa.lastGrowCutCommand=null;let Vi=Pa;Vi.toolName="GrowCutBaseTool";const du=class du extends Vi{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{isPartialVolume:!0,positiveSeedVariance:.5,negativeSeedVariance:.9}}){super(t,n),this._dragCallback=e=>{const o=e.detail,{element:a,currentPoints:s}=o,{world:r}=s,c=y(a),{viewport:l}=c;this.growCutData.circleBorderPoint=r,L([l.id])},this._endCallback=async e=>{const o=e.detail,{element:a}=o,s=y(a),{viewport:r}=s;this.runGrowCut(),this._deactivateDraw(a),this.growCutData=null,ht(a),L([r.id])},this._deactivateDraw=e=>{e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback)}}async preMouseDownCallback(t){const n=t.detail,{element:e,currentPoints:o}=n,{world:a}=o,s=y(e),{viewport:r,renderingEngine:c}=s;return await super.preMouseDownCallback(t),Object.assign(this.growCutData,{circleCenterPoint:a,circleBorderPoint:a}),this._activateDraw(e),nt(e),L([r.id]),!0}async getGrowCutLabelmap(t){const{segmentation:{referencedVolumeId:n},renderingEngineId:e,viewportId:o,circleCenterPoint:a,circleBorderPoint:s,options:r}=t,l=te(e).getViewport(o),d=ks(me(W(),a,s));return Vv(n,{center:a,radius:d},l,r)}_activateDraw(t){t.addEventListener(w.MOUSE_UP,this._endCallback),t.addEventListener(w.MOUSE_DRAG,this._dragCallback),t.addEventListener(w.MOUSE_CLICK,this._endCallback)}renderAnnotation(t,n){if(!this.growCutData)return;const{viewport:e}=t,{segmentation:o,circleCenterPoint:a,circleBorderPoint:s}=this.growCutData,r=e.worldToCanvas(a),c=e.worldToCanvas(s),l=Kn(et(),c,r),d=R0(l);if(Pt(d,0))return;const u="growcut",h="0",{color:g}=this.getSegmentStyle({segmentationId:o.segmentationId,segmentIndex:o.segmentIndex,viewportId:e.id});Ae(n,u,h,r,d,{color:g})}};du.toolName="RegionSegment";let fg=du;const uu=class uu extends Vi{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{isPartialVolume:!1,positiveSeedVariance:.4,negativeSeedVariance:.9,subVolumePaddingPercentage:.1,islandRemoval:{enabled:!1}}}){super(t,n),this.mouseTimer=null,this.allowedToProceed=!1}mouseMoveCallback(t){if(this.mode!==Ot.Active)return;const n=t.detail,{currentPoints:e,element:o}=n,{world:a}=e;o.style.cursor="default",this.mouseTimer!==null&&(window.clearTimeout(this.mouseTimer),this.mouseTimer=null),this.mouseTimer=window.setTimeout(()=>{this.onMouseStable(t,a,o)},this.configuration.mouseStabilityDelay||500)}async onMouseStable(t,n,e){await super.preMouseDownCallback(t);const o=X.getVolume(this.growCutData.segmentation.referencedVolumeId),a=Gv(o,n,{})||{positiveSeedIndices:new Set,negativeSeedIndices:new Set},{positiveSeedIndices:s,negativeSeedIndices:r}=a;let c;s.size/r.size>20||r.size<30?(c="not-allowed",this.allowedToProceed=!1):(c="copy",this.allowedToProceed=!0);const l=y(e);e&&(e.style.cursor=c,requestAnimationFrame(()=>{e.style.cursor!==c&&(e.style.cursor=c)})),this.allowedToProceed&&(this.seeds=a),l&&l.viewport&&l.viewport.render()}async preMouseDownCallback(t){if(!this.allowedToProceed)return!1;const n=t.detail,{currentPoints:e,element:o}=n;y(o)&&(o.style.cursor="wait",requestAnimationFrame(()=>{o.style.cursor!=="wait"&&(o.style.cursor="wait")}));const{world:s}=e;return await super.preMouseDownCallback(t),this.growCutData=Be(this.growCutData,{worldPoint:s,islandRemoval:{worldIslandPoints:[s]}}),this.growCutData.worldPoint=s,this.growCutData.islandRemoval={worldIslandPoints:[s]},await this.runGrowCut(),o&&(o.style.cursor="default"),!0}getRemoveIslandData(t){const{worldPoint:n}=t;return{worldIslandPoints:[n]}}async getGrowCutLabelmap(t){const{segmentation:{referencedVolumeId:n},worldPoint:e,options:o}=t,{subVolumePaddingPercentage:a}=this.configuration,s={...o,subVolumePaddingPercentage:a,seeds:this.seeds};return Wv({referencedVolumeId:n,worldPosition:e,options:s})}};uu.toolName="RegionSegmentPlus";let mg=uu;const qA=[-1/0,-995],KA=[0,1900],ZA=[1e3,1900],{transformWorldToIndex:ys,transformIndexToWorld:Oc}=Rt;class JA extends Vi{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{isPartialVolume:!0,positivePixelRange:KA,negativePixelRange:qA,islandRemoval:{enabled:!0,islandPixelRange:ZA}}}){super(t,n),this._dragCallback=e=>{const o=e.detail,{element:a,currentPoints:s}=o,{world:r}=s,c=y(a),{viewport:l}=c,d=this._getHorizontalLineWorldPoints(c,r);this.growCutData.horizontalLines[1]=d,L([l.id])},this._endCallback=async e=>{const o=e.detail,{element:a}=o,s=y(a),{viewport:r}=s;await this.runGrowCut(),this._deactivateDraw(a),this.growCutData=null,ht(a),L([r.id])},this._deactivateDraw=e=>{e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback)}}async preMouseDownCallback(t){const n=t.detail,{element:e,currentPoints:o}=n,{world:a}=o,s=y(e),{viewport:r,renderingEngine:c}=s,l=this._getHorizontalLineWorldPoints(s,a);return await super.preMouseDownCallback(t),this.growCutData.horizontalLines=[l,l],this._activateDraw(e),nt(e),L([r.id]),!0}renderAnnotation(t,n){if(!this.growCutData)return;const{segmentation:e,horizontalLines:o}=this.growCutData;if(o.length!==2)return;const{viewport:a}=t,{segmentationId:s,segmentIndex:r}=e,[c,l]=o,[d,u]=c,[h,g]=l,f=[d,u,g,h].map(_=>a.worldToCanvas(_)),m="growCutRect",v="0",{color:p,fillColor:I,lineWidth:C,fillOpacity:E,lineDash:S}=this.getSegmentStyle({segmentationId:s,segmentIndex:r,viewportId:a.id});dn(n,m,v,f,{color:p,fillColor:I,fillOpacity:E,lineWidth:C,lineDash:S,closePath:!0})}async getGrowCutLabelmap(t){const{segmentation:{segmentIndex:n,referencedVolumeId:e},renderingEngineId:o,viewportId:a,horizontalLines:s}=t,c=te(o).getViewport(a),[l,d]=s,u=[l[0],l[1],d[1],d[0]],h=X.getVolume(e),{topLeft:g,bottomRight:f}=this._getWorldBoundingBoxFromProjectedSquare(c,u),m=ys(h.imageData,g),v=ys(h.imageData,f),p={boundingBox:{ijkTopLeft:m,ijkBottomRight:v}},I=this.configuration,C={positiveSeedValue:n,negativeSeedValue:255,negativePixelRange:I.negativePixelRange,positivePixelRange:I.positivePixelRange};return Fv(e,p,C)}getRemoveIslandData(){const{segmentation:{segmentIndex:t,referencedVolumeId:n,labelmapVolumeId:e}}=this.growCutData,o=X.getVolume(n),a=X.getVolume(e),s=o.voxelManager.getCompleteScalarDataArray(),r=a.voxelManager.getCompleteScalarDataArray(),{islandPixelRange:c}=this.configuration.islandRemoval,l=[];for(let d=0,u=r.length;d<u;d++){if(r[d]!==t)continue;const h=s[d];h>=c[0]&&h<=c[1]&&l.push(d)}return{islandPointIndexes:l}}_activateDraw(t){t.addEventListener(w.MOUSE_UP,this._endCallback),t.addEventListener(w.MOUSE_DRAG,this._dragCallback),t.addEventListener(w.MOUSE_CLICK,this._endCallback)}_projectWorldPointAcrossSlices(t,n,e){const o=this._getViewportVolume(t),{dimensions:a}=o,s=ys(o.imageData,n),r=e.findIndex(d=>Pt(Math.abs(d),1));if(r===-1)throw new Error("Non-orthogonal direction vector");const c=[...s],l=[...s];return c[r]=0,l[r]=a[r]-1,[c,l]}_getCuboidIJKEdgePointsFromProjectedWorldPoint(t,n){const{viewPlaneNormal:e}=t.getCamera();return this._projectWorldPointAcrossSlices(t,n,e)}_getWorldCuboidCornerPoints(t,n){const e=[],o=this._getViewportVolume(t);return n.forEach(a=>{const r=this._getCuboidIJKEdgePointsFromProjectedWorldPoint(t,a).map(c=>Oc(o.imageData,c));e.push(...r)}),e}_getWorldBoundingBoxFromProjectedSquare(t,n){const e=this._getWorldCuboidCornerPoints(t,n),o=[...e[0]],a=[...e[0]];return e.forEach(s=>{N0(o,o,s),U0(a,a,s)}),{topLeft:o,bottomRight:a}}_getViewportVolume(t){if(!(t instanceof ve))throw new Error("Viewport is not a BaseVolumeViewport");const n=t.getAllVolumeIds()[0];return X.getVolume(n)}_getHorizontalLineIJKPoints(t,n){const{viewport:e}=t,o=this._getViewportVolume(e),{dimensions:a}=o,s=ys(o.imageData,n),{viewUp:r,viewPlaneNormal:c}=e.getCamera(),d=be(W(),r,c).findIndex(g=>Pt(Math.abs(g),1)),u=[...s],h=[...s];return u[d]=0,h[d]=a[d]-1,[u,h]}_getHorizontalLineWorldPoints(t,n){const{viewport:e}=t,o=this._getViewportVolume(e),[a,s]=this._getHorizontalLineIJKPoints(t,n),r=Oc(o.imageData,a),c=Oc(o.imageData,s);return[r,c]}}JA.toolName="WholeBodySegment";function QA(i,t,n=!0){const e=Object.assign({},t,{segmentIndex:0});Vd(i,e)}function t2(i,t){QA(i,t,!0)}class e2 extends Ui{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:Vd,ERASE_INSIDE:t2},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(t,n),this.preMouseDownCallback=e=>{if(this.isDrawing===!0)return;const o=e.detail,{currentPoints:a,element:s}=o,r=a.world,c=y(s),{viewport:l}=c;this.isDrawing=!0;const d=l.getCamera(),{viewPlaneNormal:u,viewUp:h}=d,g=oo(l.id);if(!g)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:f}=g,m=$e(f),v=ai(f),p=Vn(l.id,f,m),{representationData:I}=pt(f),C=I[tt.Labelmap],E={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...u],viewUp:[...h],FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:p},data:{handles:{points:[[...r],[...r],[...r],[...r]],activeHandleIndex:null}}},S=Q(s,this.getToolName());if(this.editData={annotation:E,segmentIndex:m,segmentationId:f,segmentsLocked:v,segmentColor:p,viewportIdsToRender:S,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,volumeId:null,referencedVolumeId:null,imageId:null},l instanceof ve){const{volumeId:_}=C,D=X.getVolume(_);this.editData={...this.editData,volumeId:_,referencedVolumeId:D.referencedVolumeId}}else{const _=Mo(l.id,f);this.editData={...this.editData,imageId:_}}return this._activateDraw(s),nt(s),e.preventDefault(),L(S),!0},this._dragCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,handleIndex:c}=this.editData,{data:l}=s,{currentPoints:d}=o,u=y(a),{worldToCanvas:h,canvasToWorld:g}=u.viewport,f=d.world,{points:m}=l.handles;m[c]=[...f];let v,p,I,C,E,S,_,D;switch(c){case 0:case 3:v=h(m[0]),C=h(m[3]),p=[C[0],v[1]],I=[v[0],C[1]],S=g(p),_=g(I),m[1]=S,m[2]=_;break;case 1:case 2:p=h(m[1]),I=h(m[2]),v=[I[0],p[1]],C=[p[0],I[1]],E=g(v),D=g(C),m[0]=E,m[3]=D;break}s.invalidated=!0,this.editData.hasMoved=!0,L(r)},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,newAnnotation:r,hasMoved:c}=this.editData,{data:l}=s;if(r&&!c)return;l.handles.activeHandleIndex=null,this._deactivateDraw(a),ht(a);const d=y(a),u={...this.editData,points:l.handles.points,createMemo:this.createMemo.bind(this)};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(d,u),this.doneEditMemo()},this._activateDraw=e=>{e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_MOVE,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_MOVE,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,o)=>{let a=!1;if(!this.editData)return a;const{viewport:s}=e,{annotation:r}=this.editData,c=r.metadata,l=r.annotationUID,d=r.data,{points:u}=d.handles,h=u.map(m=>s.worldToCanvas(m)),g=`rgb(${c.segmentColor.slice(0,3)})`;return s.getRenderingEngine()?(is(o,l,"0",h[0],h[3],{color:g}),a=!0,a):(console.warn("Rendering Engine has been destroyed"),a)}}}e2.toolName="RectangleScissor";class n2 extends Ui{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:Xr,ERASE_INSIDE:Pv},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(t,n),this.preMouseDownCallback=e=>{if(this.isDrawing===!0)return;const o=e.detail,{currentPoints:a,element:s}=o,r=a.world,c=a.canvas,l=y(s),{viewport:d}=l;this.isDrawing=!0;const u=d.getCamera(),{viewPlaneNormal:h,viewUp:g}=u,f=oo(d.id);if(!f)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:m}=f,v=$e(m),p=ai(m),I=Vn(d.id,m,v),{representationData:C}=pt(m),E=C.Labelmap;if(!E)throw new Error("No labelmap data found for the active segmentation, create one before using scissors tool");const S={invalidated:!0,highlighted:!0,metadata:{viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:d.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:I},data:{handles:{points:[[...r],[...r],[...r],[...r]],activeHandleIndex:null},isDrawing:!0,cachedStats:{}}},_=[d.id];if(this.editData={annotation:S,centerCanvas:c,segmentIndex:v,segmentationId:m,segmentsLocked:p,segmentColor:I,viewportIdsToRender:_,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,volumeId:null,referencedVolumeId:null,imageId:null},d instanceof ve){const{volumeId:D}=E,b=X.getVolume(D);this.editData={...this.editData,volumeId:D,referencedVolumeId:b.referencedVolumeId}}else{const D=Mo(d.id,m);this.editData={...this.editData,imageId:D}}return this._activateDraw(s),nt(s),e.preventDefault(),L(_),!0},this._dragCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{currentPoints:s}=o,r=s.canvas,c=y(a),{renderingEngine:l,viewport:d}=c,{canvasToWorld:u}=d,{annotation:h,viewportIdsToRender:g,centerCanvas:f}=this.editData,{data:m}=h,v=Math.abs(r[0]-f[0]),p=Math.abs(r[1]-f[1]),I=Math.sqrt(v*v+p*p),C=[f[0],f[1]+I],E=[f[0],f[1]-I],S=[f[0]-I,f[1]],_=[f[0]+I,f[1]];m.handles.points=[u(C),u(E),u(S),u(_)],h.invalidated=!0,this.editData.hasMoved=!0,L(g)},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,newAnnotation:r,hasMoved:c}=this.editData,{data:l}=s,{viewPlaneNormal:d,viewUp:u}=s.metadata;if(r&&!c)return;l.handles.activeHandleIndex=null,this._deactivateDraw(a),ht(a);const h=y(a),g={...this.editData,points:l.handles.points,viewPlaneNormal:d,viewUp:u,createMemo:this.createMemo.bind(this)};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(h,g),this.doneEditMemo()},this._activateDraw=e=>{e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.MOUSE_MOVE,this._dragCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback),e.addEventListener(w.TOUCH_END,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.MOUSE_MOVE,this._dragCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,o)=>{let a=!1;if(!this.editData)return a;const{viewport:s}=e,{viewportIdsToRender:r}=this.editData;if(!r.includes(s.id))return a;const{annotation:c}=this.editData,l=c.metadata,d=c.annotationUID,u=c.data,{points:h}=u.handles,g=h.map(E=>s.worldToCanvas(E)),f=g[0],m=g[1],v=[Math.floor((f[0]+m[0])/2),Math.floor((f[1]+m[1])/2)],p=Math.abs(f[1]-Math.floor((f[1]+m[1])/2)),I=`rgb(${l.segmentColor.slice(0,3)})`;return s.getRenderingEngine()?(Ae(o,d,"0",v,p,{color:I}),a=!0,a):(console.warn("Rendering Engine has been destroyed"),a)}}}n2.toolName="CircleScissor";class o2 extends Ui{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:bv,ERASE_INSIDE:Tv},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(t,n),this.preMouseDownCallback=e=>{if(this.isDrawing===!0)return;this.doneEditMemo();const o=e.detail,{currentPoints:a,element:s}=o,r=a.world,c=a.canvas,l=y(s),{viewport:d}=l;this.isDrawing=!0;const u=d.getCamera(),{viewPlaneNormal:h,viewUp:g}=u,f=oo(d.id);if(!f)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:m}=f,v=$e(m),p=ai(m),I=Vn(d.id,m,v);this.isDrawing=!0;const C={metadata:{viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:d.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:I},data:{invalidated:!0,handles:{points:[[...r],[...r],[...r],[...r]],activeHandleIndex:null},cachedStats:{},highlighted:!0}},E=[d.id];this.editData={annotation:C,centerCanvas:c,segmentIndex:v,segmentationId:m,segmentsLocked:p,segmentColor:I,toolGroupId:this.toolGroupId,viewportIdsToRender:E,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,volumeId:null,referencedVolumeId:null,imageId:null};const{representationData:S}=pt(m),_=this.getEditData({viewport:d,representationData:S,segmentsLocked:p,segmentationId:m});return this.editData={...this.editData,..._},this._activateDraw(s),nt(s),e.preventDefault(),L(E),!0},this._dragCallback=e=>{this.isDrawing=!0;const o=e.detail,{element:a}=o,{currentPoints:s}=o,r=s.canvas,c=y(a),{renderingEngine:l,viewport:d}=c,{canvasToWorld:u}=d,{annotation:h,viewportIdsToRender:g,centerCanvas:f}=this.editData,{data:m}=h,v=Math.abs(r[0]-f[0]),p=Math.abs(r[1]-f[1]),I=Math.sqrt(v*v+p*p),C=[f[0],f[1]+I],E=[f[0],f[1]-I],S=[f[0]-I,f[1]],_=[f[0]+I,f[1]];m.handles.points=[u(C),u(E),u(S),u(_)],h.invalidated=!0,this.editData.hasMoved=!0,L(g)},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,newAnnotation:r,hasMoved:c,segmentIndex:l,segmentsLocked:d}=this.editData,{data:u}=s,{viewPlaneNormal:h,viewUp:g}=s.metadata;if(r&&!c)return;s.highlighted=!1,u.handles.activeHandleIndex=null,this._deactivateDraw(a),ht(a);const f=y(a),m={...this.editData,points:u.handles.points,segmentIndex:l,segmentsLocked:d,viewPlaneNormal:h,viewUp:g,createMemo:this.createMemo.bind(this)};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(f,m),this.doneEditMemo()},this._activateDraw=e=>{e.addEventListener(w.MOUSE_UP,this._endCallback),e.addEventListener(w.MOUSE_DRAG,this._dragCallback),e.addEventListener(w.MOUSE_CLICK,this._endCallback),e.addEventListener(w.MOUSE_MOVE,this._dragCallback),e.addEventListener(w.TOUCH_END,this._endCallback),e.addEventListener(w.TOUCH_TAP,this._endCallback),e.addEventListener(w.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{e.removeEventListener(w.MOUSE_UP,this._endCallback),e.removeEventListener(w.MOUSE_DRAG,this._dragCallback),e.removeEventListener(w.MOUSE_CLICK,this._endCallback),e.removeEventListener(w.MOUSE_MOVE,this._dragCallback),e.removeEventListener(w.TOUCH_END,this._endCallback),e.removeEventListener(w.TOUCH_DRAG,this._dragCallback),e.removeEventListener(w.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,o)=>{let a=!1;if(!this.editData)return a;const{viewport:s}=e,{viewportIdsToRender:r}=this.editData;if(!r.includes(s.id))return a;const{annotation:c}=this.editData,l=c.metadata,d=c.annotationUID,u=c.data,{points:h}=u.handles,g=h.map(E=>s.worldToCanvas(E)),f=g[0],m=g[1],v=[Math.floor((f[0]+m[0])/2),Math.floor((f[1]+m[1])/2)],p=Math.abs(f[1]-Math.floor((f[1]+m[1])/2)),I=`rgb(${l.segmentColor.slice(0,3)})`;return s.getRenderingEngine()?(Ae(o,d,"0",v,p,{color:I}),a=!0,a):(console.warn("Rendering Engine has been destroyed"),a)}}}o2.toolName="SphereScissor";const{transformWorldToIndex:Lc}=Rt;class i2 extends cr{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{simplified:!0,storePointData:!1,numSlicesToPropagate:10,calculatePointsInsideVolume:!0,getTextLines:a2,statsCalculator:Un,showTextBox:!1,throttleTimeout:100}}){super(t,n),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const o=e.detail,{currentPoints:a,element:s}=o,r=a.world,c=y(s),{viewport:l,renderingEngine:d}=c;this.isDrawing=!0;const u=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=u;let f,m,v;if(l instanceof Ie)throw new Error("Stack Viewport Not implemented");{const b=this.getTargetId(l);v=To(b),m=X.getVolume(v),f=qa(m,r,h)}const p=yl(m,h),I=this._getStartCoordinate(r,p,h),C=this._getEndCoordinate(r,p,h),E=l.getFrameOfReferenceUID();let S;this.configuration.simplified?S=[[...r],[...r]]:S=[[...r],[...r],[...r],[...r],[...r]];const _={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:E,referencedImageId:f,volumeId:v,spacingInNormal:p,enabledElement:c},data:{label:"",startCoordinate:I,endCoordinate:C,handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:S,activeHandleIndex:null},cachedStats:{pointsInVolume:[],projectionPoints:[],statistics:[]},labelmapUID:null}};this._computeProjectionPoints(_,m),mt(_,s);const D=Q(s,this.getToolName());return this.editData={annotation:_,viewportIdsToRender:D,newAnnotation:!0,hasMoved:!1},this._activateDraw(s),nt(s),e.preventDefault(),L(D),_},this._endCallback=e=>{const o=e.detail,{element:a}=o,{annotation:s,viewportIdsToRender:r,newAnnotation:c,hasMoved:l}=this.editData,{data:d}=s;if(c&&!l)return;s.highlighted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(a),this._deactivateDraw(a),ht(a);const{metadata:u}=s,{enabledElement:h}=u;this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(s.annotationUID);const g=this.getTargetId(h.viewport),f=X.getVolume(g.split(/volumeId:|\?/)[1]);this._computePointsInsideVolume(s,f,g,h),L(r),c?Lt(s):It(s,a)},this.renderAnnotation=(e,o)=>{let a=!1;const{viewport:s}=e;let r=Ct(this.getToolName(),s.element);if(!r?.length)return a;r=Vr(r,s.getCamera());const c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let l=0;l<r.length;l++){const d=r[l],{annotationUID:u,data:h,metadata:g}=d,{startCoordinate:f,endCoordinate:m}=h,{points:v,activeHandleIndex:p}=h.handles,{enabledElement:I}=g;c.annotationUID=u;const C=this.getStyle("lineWidth",c,d),E=this.getStyle("lineDash",c,d),S=this.getStyle("color",c,d),_=v.map(K=>s.worldToCanvas(K)),D=_[0],b=wo([_[0],_[1]]),{centerPointRadius:M}=this.configuration,P=Go([_[0],_[1]]),T=s.getCamera().focalPoint,x=s.getCamera().viewPlaneNormal;let A=f,O=m;Array.isArray(f)&&(A=this._getCoordinateForViewplaneNormal(A,x),h.startCoordinate=A),Array.isArray(m)&&(O=this._getCoordinateForViewplaneNormal(O,x),h.endCoordinate=O);const R=Fo(h.startCoordinate),N=Fo(h.endCoordinate),k=this._getCoordinateForViewplaneNormal(T,x),B=Fo(k);if(B<Math.min(R,N)||B>Math.max(R,N))continue;const V=Fo((h.startCoordinate+h.endCoordinate)/2);let $=!1;B===V&&($=!0),h.handles.points[0][this._getIndexOfCoordinatesForViewplaneNormal(x)]=V;const H=I.viewport?.volumeIds.values();for(const K of H)d.invalidated&&d.metadata.volumeId===K&&this._throttledCalculateCachedStats(d,I);if(!s.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;let G;if(!re(u))continue;!se(u)&&!this.editData&&p!==null&&$&&(this.configuration.simplified?G=[_[p]]:G=_),G&&$t(o,u,"0",G,{color:S});let Y=C,q=E;$?(Y=C,q=[]):q=[5,5];const j="0";if(Ae(o,u,j,D,b,{color:S,lineDash:q,lineWidth:Y}),M>0&&b>3*M&&Ae(o,u,`${j}-center`,D,M,{color:S,lineDash:E,lineWidth:C}),a=!0,this.configuration.showTextBox){const K=this.getLinkedTextBoxStyle(c,d);if(!K.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const it=this.configuration.getTextLines(h,{metadata:g});if(!it||it.length===0)continue;let at;h.handles.textBox.hasMoved||(at=qe(P),h.handles.textBox.worldPosition=s.canvasToWorld(at));const bt=s.worldToCanvas(h.handles.textBox.worldPosition),Yt=Oe(o,u,"1",it,bt,[_[0],_[1]],{},K),{x:qt,y:Nt,width:Tt,height:Jt}=Yt;h.handles.textBox.worldBoundingBox={topLeft:s.canvasToWorld([qt,Nt]),topRight:s.canvasToWorld([qt+Tt,Nt]),bottomLeft:s.canvasToWorld([qt,Nt+Jt]),bottomRight:s.canvasToWorld([qt+Tt,Nt+Jt])}}}return a},this.configuration.calculatePointsInsideVolume?this._throttledCalculateCachedStats=Fe(this._calculateCachedStatsTool,this.configuration.throttleTimeout,{trailing:!0}):this._throttledCalculateCachedStats=zi(this._calculateCachedStatsTool,this.configuration.throttleTimeout)}_computeProjectionPoints(t,n){const{data:e,metadata:o}=t,{viewPlaneNormal:a,spacingInNormal:s}=o,{startCoordinate:r,endCoordinate:c}=e,{points:l}=e.handles,d=this._getIndexOfCoordinatesForViewplaneNormal(a),u=xn(l[0]);u[d]=r;const h=xn(l[0]);h[d]=c;const g=W();oe(g,h,u);const f=We(g);if(f===0){const p=l.map(I=>{const C=xn(I);return C[d]=r,Array.from(C)});e.cachedStats.projectionPoints=[p];return}Zt(g,g);const m=Ro(l);m[0][d]=r,m[1][d]=r;const v=[];for(let p=0;p<=f+1e-6;p+=s)v.push(m.map(I=>{const C=W();return Wt(C,I,g,p),Array.from(C)}));e.cachedStats.projectionPoints=v}_computePointsInsideVolume(t,n,e,o){const{data:a,metadata:s}=t,{viewPlaneNormal:r,viewUp:c}=s,{viewport:l}=o,d=a.cachedStats.projectionPoints,u=[[]],h=this.getTargetImageData(e),g=a.handles.points.map(P=>l.worldToCanvas(P)),f=Go([g[0],g[1]])[0],m=Go([g[0],g[1]])[1],v=l.canvasToWorld(f),p=l.canvasToWorld(m),{worldWidth:I,worldHeight:C}=rs(r,c,v,p),E=nn(h,a.handles.points),S=wd(h),_=Math.abs(Math.PI*(I/E.scale/2)*(C/S/E.scale/2)),D={isPreScaled:io(l,e),isSuvScaled:this.isSuvScaled(l,e,t.metadata.referencedImageId)},b=so(s.Modality,t.metadata.referencedImageId,D);for(let P=0;P<d.length;P++){if(!n)continue;const T=d[P][0],x=d[P].map(K=>l.worldToCanvas(K)),[A,O]=Go([x[0],x[1]]),R=l.canvasToWorld(A),N=l.canvasToWorld(O),k=R,B=N,{dimensions:V,imageData:$,voxelManager:H}=n,G=Lc($,k),Y=Lc($,T),q=this._getIndexOfCoordinatesForViewplaneNormal(r);G[0]=Math.floor(G[0]),G[1]=Math.floor(G[1]),G[2]=Math.floor(G[2]),G[q]=Y[q];const j=Lc($,B);if(j[0]=Math.floor(j[0]),j[1]=Math.floor(j[1]),j[2]=Math.floor(j[2]),j[q]=Y[q],cr.isInsideVolume(V,[G,j])){const K=Math.min(G[0],j[0]),it=Math.max(G[0],j[0]),at=Math.min(G[1],j[1]),bt=Math.max(G[1],j[1]),Bt=Math.min(G[2],j[2]),Yt=Math.max(G[2],j[2]),qt=[[K,it],[at,bt],[Bt,Yt]],Tt={center:T,xRadius:Math.abs(R[0]-N[0])/2,yRadius:Math.abs(R[1]-N[1])/2,zRadius:Math.abs(R[2]-N[2])/2},Jt=H.forEach(this.configuration.statsCalculator.statsCallback,{isInObject:yt=>Pr(Tt,yt),boundsIJK:qt,imageData:$,returnPoints:this.configuration.storePointData});u.push(Jt)}}const M=this.configuration.statsCalculator.getStatistics();a.cachedStats.pointsInVolume=u,a.cachedStats.statistics={Modality:s.Modality,area:_,mean:M.mean?.value,stdDev:M.stdDev?.value,max:M.max?.value,statsArray:M.array,areaUnit:E.areaUnit,modalityUnit:b}}_calculateCachedStatsTool(t,n){const e=t.data,{viewport:o}=n,{cachedStats:a}=e,s=this.getTargetId(o),r=X.getVolume(s.split(/volumeId:|\?/)[1]);return this._computeProjectionPoints(t,r),this._computePointsInsideVolume(t,r,s,n),t.invalidated=!1,It(t,o.element),a}_getStartCoordinate(t,n,e){const o=this.configuration.numSlicesToPropagate,a=Math.round(o/2),s=W();return Wt(s,t,e,a*-n),this._getCoordinateForViewplaneNormal(s,e)}_getEndCoordinate(t,n,e){const o=this.configuration.numSlicesToPropagate,a=o-Math.round(o/2),s=W();return Wt(s,t,e,a*n),this._getCoordinateForViewplaneNormal(s,e)}_getIndexOfCoordinatesForViewplaneNormal(t){const n=[Math.abs(t[0]),Math.abs(t[1]),Math.abs(t[2])];return n.indexOf(Math.max(...n))}_getCoordinateForViewplaneNormal(t,n){const e=this._getIndexOfCoordinatesForViewplaneNormal(n);return t[e]}}function a2(i,t={}){const n=i.cachedStats.statistics,{area:e,mean:o,max:a,stdDev:s,areaUnit:r,modalityUnit:c}=n;if(o===void 0)return;const l=[];return l.push(`Area: ${_t(e)} ${r}`),l.push(`Mean: ${_t(o)} ${c}`),l.push(`Max: ${_t(a)} ${c}`),l.push(`Std Dev: ${_t(s)} ${c}`),l}i2.toolName="CircleROIStartEndThreshold";const{transformWorldToIndex:pg,isEqual:Rc}=Rt;class s2 extends de{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"]}){super(t,n),this.preMouseDownCallback=e=>{const o=e.detail,{currentPoints:a,element:s}=o,r=a.world,c=y(s),{viewport:l}=c,d=l.getCamera(),{viewPlaneNormal:u}=d,h=oo(l.id);if(!h)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:g}=h,f=$e(g),m=ai(g),{representationData:v}=pt(g);let p,I,C,E;if(this.doneEditMemo(),l instanceof ve){const{volumeId:R}=v[tt.Labelmap],N=X.getVolume(R);({dimensions:p,direction:I}=N),E=N.voxelManager,C=pg(N.imageData,r)}else{const R=Mo(l.id,g);if(!R)throw new Error("No active segmentation imageId detected, create one before using scissors tool");const{imageData:N}=l.getImageData();p=N.getDimensions(),I=N.getDirection(),E=X.getImage(R).voxelManager,C=pg(N,r)}const S=this.getFixedDimension(u,I);if(S===void 0){console.warn("Oblique paint fill not yet supported");return}const{floodFillGetter:_,getLabelValue:D,getScalarDataPositionFromPlane:b,inPlaneSeedPoint:M,fixedDimensionValue:P}=this.generateHelpers(E,p,C,S);if(C[0]<0||C[0]>=p[0]||C[1]<0||C[1]>=p[1]||C[2]<0||C[2]>=p[2])return;const T=D(C[0],C[1],C[2]);if(m.includes(T))return;const x=kd(_,M),{flooded:A}=x;A.forEach(R=>{const N=b(R[0],R[1]);E.setAtIndex(N,f)});const O=this.getFramesModified(S,P,x);return Pe(g,O),!0},this.getFramesModified=(e,o,a)=>{const{flooded:s}=a;if(e===2)return[o];let r=1/0,c=-1/0;for(let d=0;d<s.length;d++){const u=s[d][1];u<r&&(r=u),u>c&&(c=u)}const l=[];for(let d=r;d<=c;d++)l.push(d);return l},this.generateHelpers=(e,o,a,s=2)=>{let r,c;switch(s){case 0:r=a[0],c=[a[1],a[2]];break;case 1:r=a[1],c=[a[0],a[2]];break;case 2:r=a[2],c=[a[0],a[1]];break;default:throw new Error(`Invalid fixedDimension: ${s}`)}const l=(g,f,m)=>e.toIndex([g,f,m]),d=(g,f,m)=>e.getAtIJK(g,f,m),u=this.generateFloodFillGetter(o,s,r,d);return{getScalarDataPositionFromPlane:this.generateGetScalarDataPositionFromPlane(l,s,r),getLabelValue:d,floodFillGetter:u,inPlaneSeedPoint:c,fixedDimensionValue:r}},this.generateFloodFillGetter=(e,o,a,s)=>{let r;switch(o){case 0:r=(c,l)=>{if(!(c>=e[1]||c<0||l>=e[2]||l<0))return s(a,c,l)};break;case 1:r=(c,l)=>{if(!(c>=e[0]||c<0||l>=e[2]||l<0))return s(c,a,l)};break;case 2:r=(c,l)=>{if(!(c>=e[0]||c<0||l>=e[1]||l<0))return s(c,l,a)};break;default:throw new Error(`Invalid fixedDimension: ${o}`)}return r},this.generateGetScalarDataPositionFromPlane=(e,o,a)=>{let s;switch(o){case 0:s=(r,c)=>e(a,r,c);break;case 1:s=(r,c)=>e(r,a,c);break;case 2:s=(r,c)=>e(r,c,a);break;default:throw new Error(`Invalid fixedDimension: ${o}`)}return s}}getFixedDimension(t,n){const e=n.slice(0,3),o=n.slice(3,6),a=n.slice(6,9),s=[Math.abs(t[0]),Math.abs(t[1]),Math.abs(t[2])],r=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])];if(Rc(s,r))return 0;const c=[Math.abs(o[0]),Math.abs(o[1]),Math.abs(o[2])];if(Rc(s,c))return 1;const l=[Math.abs(a[0]),Math.abs(a[1]),Math.abs(a[2])];if(Rc(s,l))return 2}}s2.toolName="PaintFill";const r2={TOP_LEFT:"TOP_LEFT",TOP_RIGHT:"TOP_RIGHT",BOTTOM_LEFT:"BOTTOM_LEFT",BOTTOM_RIGHT:"BOTTOM_RIGHT"};var Jd={Corners:r2};const{vtkErrorMacro:Nc}=Mt,{Corners:As}=Jd;function c2(i,t){t.classHierarchy.push("vtkOrientationMarkerWidget");const n={...i},e=[],o=k0.newInstance(),a=new ResizeObserver(h=>{i.updateViewport()});let s=null,r=null,c=null,l=null,d=null;function u(){t._interactor.isAnimating()||i.updateMarkerOrientation()}t._onParentRendererChanged=()=>i.updateViewport(),i.computeViewport=()=>{const h=t.parentRenderer||t._interactor.getCurrentRenderer(),[g,f,m,v]=h.getViewport(),p=t._interactor.getView(),I=p.getSize(),[C,E]=p.getViewportSize(h),S=Math.min(C,E);let _=t.viewportSize*S;_=Math.max(Math.min(t.minPixelSize,S),Math.min(t.maxPixelSize,_));const D=_/I[0],b=_/I[1];switch(t.viewportCorner){case As.TOP_LEFT:return[g,v-b,g+D,v];case As.TOP_RIGHT:return[m-D,v-b,m,v];case As.BOTTOM_LEFT:return[g,f,g+D,f+b];case As.BOTTOM_RIGHT:return[m-D,f,m,f+b];default:return Nc("Invalid widget corner"),null}},i.updateViewport=()=>{t.enabled&&(o.setViewport(...i.computeViewport()),t._interactor.render())},i.updateMarkerOrientation=()=>{const g=(t.parentRenderer||t._interactor.getCurrentRenderer()).getActiveCamera();if(!g)return;const f=g.getReferenceByName("position"),m=g.getReferenceByName("focalPoint"),v=g.getReferenceByName("viewUp");if(e[0]!==f[0]||e[1]!==f[1]||e[2]!==f[2]||e[3]!==m[0]||e[4]!==m[1]||e[5]!==m[2]||e[6]!==v[0]||e[7]!==v[1]||e[8]!==v[2]){e[0]=f[0],e[1]=f[1],e[2]=f[2],e[3]=m[0],e[4]=m[1],e[5]=m[2],e[6]=v[0],e[7]=v[1],e[8]=v[2];const p=o.getActiveCamera();p.setPosition(f[0],f[1],f[2]),p.setFocalPoint(m[0],m[1],m[2]),p.setViewUp(v[0],v[1],v[2]),o.resetCamera()}},i.setEnabled=h=>{if(h){if(t.enabled)return;if(!t.actor){Nc("Must set actor before enabling orientation marker.");return}if(!t._interactor){Nc("Must set interactor before enabling orientation marker.");return}const g=t.parentRenderer||t._interactor.getCurrentRenderer(),f=g.getRenderWindow();f.addRenderer(o),f.getNumberOfLayers()<2&&f.setNumberOfLayers(2),o.setLayer(f.getNumberOfLayers()-1),o.setInteractive(t.interactiveRenderer),o.addViewProp(t.actor),t.actor.setVisibility(!0),s=g.onEvent(m=>{m.type==="ActiveCameraEvent"&&(r&&r.unsubscribe(),r=m.camera.onModified(u))}),r=g.getActiveCamera().onModified(u),c=t._interactor.onAnimation(i.updateMarkerOrientation),l=t._interactor.onEndAnimation(i.updateMarkerOrientation),a.observe(t._interactor.getView().getCanvas()),i.updateViewport(),i.updateMarkerOrientation(),t.enabled=!0}else{if(!t.enabled)return;t.enabled=!1,a.disconnect(),s.unsubscribe(),s=null,r.unsubscribe(),r=null,c.unsubscribe(),c=null,l.unsubscribe(),l=null,t.actor.setVisibility(!1),o.removeViewProp(t.actor);const g=t._interactor?.findPokedRenderer()?.getRenderWindow();g&&g.removeRenderer(o)}i.modified()},i.setViewportCorner=h=>{h!==t.viewportCorner&&(t.viewportCorner=h,i.updateViewport())},i.setViewportSize=h=>{const g=Math.min(1,Math.max(0,h));g!==t.viewportSize&&(t.viewportSize=g,i.updateViewport())},i.setActor=h=>{const g=t.enabled;i.setEnabled(!1),t.actor=h,i.setEnabled(g)},i.getRenderer=()=>o,i.delete=()=>{n.delete(),d&&(d.unsubscribe(),d=null),s&&(s.unsubscribe(),s=null),r&&(r.unsubscribe(),r=null),c&&(c.unsubscribe(),c=null),l&&(l.unsubscribe(),l=null),a.disconnect()},d=i.onModified(i.updateViewport)}const l2={viewportCorner:Jd.Corners.BOTTOM_LEFT,viewportSize:.2,minPixelSize:50,maxPixelSize:200,parentRenderer:null,interactiveRenderer:!1};function MI(i,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(t,l2,n),Mt.obj(i,t),Mt.get(i,t,["enabled","viewportCorner","viewportSize","interactiveRenderer"]),Mt.setGet(i,t,["_interactor","minPixelSize","maxPixelSize","parentRenderer"]),Mt.get(i,t,["actor"]),Mt.moveToProtected(i,t,["interactor"]),c2(i,t)}const d2=Mt.newInstance(MI,"vtkOrientationMarkerWidget");var vg={newInstance:d2,extend:MI,...Jd};function xI(i){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[0,0,0,0];const[n,e,o,a]=t,r=i.getContext("2d").getImageData(n,e,o||i.width,a||i.height),c=Mg.newInstance({type:"vtkImageData"});c.setOrigin(0,0,0),c.setSpacing(1,1,1),c.setExtent(0,(o||i.width)-1,0,(a||i.height)-1,0,0);const l=Zn.newInstance({numberOfComponents:4,values:new Uint8Array(r.data.buffer)});return l.setName("scalars"),c.getPointData().setScalars(l),c}function u2(i){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{flipX:!1,flipY:!1,rotate:0};const n=document.createElement("canvas");n.width=i.width,n.height=i.height;const e=n.getContext("2d"),{flipX:o,flipY:a,rotate:s}=t;return e.translate(n.width/2,n.height/2),e.scale(o?-1:1,a?-1:1),e.rotate(s*Math.PI/180),e.drawImage(i,-i.width/2,-i.height/2),xI(n)}var h2={canvasToImageData:xI,imageToImageData:u2};const yI={default:{defaultStyle:{fontStyle:"bold",fontFamily:"Arial",fontColor:"black",fontSizeScale:i=>i/2,faceColor:"white",edgeThickness:.1,edgeColor:"black",resolution:400},xMinusFaceProperty:{text:"X-",faceColor:"yellow"},xPlusFaceProperty:{text:"X+",faceColor:"yellow"},yMinusFaceProperty:{text:"Y-",faceColor:"red"},yPlusFaceProperty:{text:"Y+",faceColor:"red"},zMinusFaceProperty:{text:"Z-",faceColor:"#008000"},zPlusFaceProperty:{text:"Z+",faceColor:"#008000"}},lps:{xMinusFaceProperty:{text:"R",faceRotation:-90},xPlusFaceProperty:{text:"L",faceRotation:90},yMinusFaceProperty:{text:"A",faceRotation:0},yPlusFaceProperty:{text:"P",faceRotation:180},zMinusFaceProperty:{text:"I",faceRotation:180},zPlusFaceProperty:{text:"S",faceRotation:0}}};function AI(i,t){t.set(i)}function g2(i,t){return AI(yI[i],t)}function f2(i,t){yI[i]=t}var m2={applyDefinitions:AI,applyPreset:g2,registerStylePreset:f2};const p2={xPlus:0,xMinus:1,yPlus:2,yMinus:3,zPlus:4,zMinus:5};function v2(i,t){t.classHierarchy.push("vtkAnnotatedCubeActor"),t.xPlusFaceProperty={...t.xPlusFaceProperty},t.xMinusFaceProperty={...t.xMinusFaceProperty},t.yPlusFaceProperty={...t.yPlusFaceProperty},t.yMinusFaceProperty={...t.yMinusFaceProperty},t.zPlusFaceProperty={...t.zPlusFaceProperty},t.zMinusFaceProperty={...t.zMinusFaceProperty};let n=null;const e=document.createElement("canvas"),o=xi.newInstance(),a=G0.newInstance();a.setInterpolate(!0);function s(c){let l=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;l&&Object.assign(t[`${c}FaceProperty`],l);const d={...t.defaultStyle,...t[`${c}FaceProperty`]};e.width=d.resolution,e.height=d.resolution;const u=e.getContext("2d");u.fillStyle=d.faceColor,u.fillRect(0,0,e.width,e.height),d.edgeThickness>0&&(u.strokeStyle=d.edgeColor,u.lineWidth=d.edgeThickness*e.width,u.strokeRect(0,0,e.width,e.height)),u.save(),u.translate(0,e.height),u.scale(1,-1),u.translate(e.width/2,e.height/2),u.rotate(-Math.PI*(d.faceRotation/180));const h=d.fontSizeScale(d.resolution);u.fillStyle=d.fontColor,u.textAlign="center",u.textBaseline="middle",u.font=`${d.fontStyle} ${h}px "${d.fontFamily}"`,u.fillText(d.text,0,0),u.restore();const g=h2.canvasToImageData(e);a.setInputData(g,p2[c]),i.modified()}function r(){n=V0.newInstance({generate3DTextureCoordinates:!0}),o.setInputConnection(n.getOutputPort()),s("xPlus"),s("xMinus"),s("yPlus"),s("yMinus"),s("zPlus"),s("zMinus")}i.setDefaultStyle=c=>{t.defaultStyle={...t.defaultStyle,...c},r()},i.setXPlusFaceProperty=c=>s("xPlus",c),i.setXMinusFaceProperty=c=>s("xMinus",c),i.setYPlusFaceProperty=c=>s("yPlus",c),i.setYMinusFaceProperty=c=>s("yMinus",c),i.setZPlusFaceProperty=c=>s("zPlus",c),i.setZMinusFaceProperty=c=>s("zMinus",c),r(),o.setInputConnection(n.getOutputPort()),i.setMapper(o),i.addTexture(a)}const I2={defaultStyle:{text:"",faceColor:"white",faceRotation:0,fontFamily:"Arial",fontColor:"black",fontStyle:"normal",fontSizeScale:i=>i/1.8,edgeThickness:.1,edgeColor:"black",resolution:200}};function OI(i,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(t,I2,n),yi.extend(i,t,n),Mt.get(i,t,["defaultStyle","xPlusFaceProperty","xMinusFaceProperty","yPlusFaceProperty","yMinusFaceProperty","zPlusFaceProperty","zMinusFaceProperty"]),v2(i,t)}const w2=Mt.newInstance(OI,"vtkAnnotatedCubeActor");var Ig={newInstance:w2,extend:OI,Presets:m2};const{vtkErrorMacro:C2}=Mt;function E2(i,t){let n=0;return i.map((e,o)=>o===n?(n+=e+1,e):e+t)}function Os(i,t,n,e){i.set(E2(t,n),e)}function S2(i,t){t.classHierarchy.push("vtkAppendPolyData"),i.requestData=(n,e)=>{const o=i.getNumberOfInputPorts();if(!o){C2("No input specified.");return}if(o===1){e[0]=n[0];return}const a=e[0]&&n[0]!==e[0]?e[0].initialize():Eo.newInstance();let s=0,r=0,c=1,l=1,d=0,u=0,h=0,g=0,f=!0,m=!0,v=!0;for(let T=0;T<o;T++){const x=n[T];if(!x)continue;const A=x.getPoints().getNumberOfPoints();s+=A,d+=x.getVerts().getNumberOfValues(),u+=x.getLines().getNumberOfValues(),h+=x.getStrips().getNumberOfValues(),g+=x.getPolys().getNumberOfValues(),A&&(l&&(l=0,r=x.getPoints().getDataType()),c=x.getPoints().getDataType(),r=r>c?r:c);const O=x.getPointData();O?(f=f&&O.getNormals()!==null,m=m&&O.getTCoords()!==null,v=v&&O.getScalars()!==null):(f=!1,m=!1,v=!1)}t.outputPointsPrecision===zc.SINGLE?r=Eu.FLOAT:t.outputPointsPrecision===zc.DOUBLE&&(r=Eu.DOUBLE);const p=Fg.newInstance({dataType:r});p.setNumberOfPoints(s);const I=p.getData(),C=new Uint32Array(d),E=new Uint32Array(u),S=new Uint32Array(h),_=new Uint32Array(g);let D=null,b=null,M=null;const P=n[o-1];if(f){const T=P.getPointData().getNormals();D=Zn.newInstance({numberOfComponents:3,numberOfTuples:s,size:3*s,dataType:T.getDataType(),name:T.getName()})}if(m){const T=P.getPointData().getTCoords();b=Zn.newInstance({numberOfComponents:2,numberOfTuples:s,size:2*s,dataType:T.getDataType(),name:T.getName()})}if(v){const T=P.getPointData().getScalars();M=Zn.newInstance({numberOfComponents:T.getNumberOfComponents(),numberOfTuples:s,size:s*T.getNumberOfComponents(),dataType:T.getDataType(),name:T.getName()})}s=0,d=0,u=0,h=0,g=0;for(let T=0;T<o;T++){const x=n[T];I.set(x.getPoints().getData(),s*3),Os(C,x.getVerts().getData(),s,d),d+=x.getVerts().getNumberOfValues(),Os(E,x.getLines().getData(),s,u),u+=x.getLines().getNumberOfValues(),Os(S,x.getStrips().getData(),s,h),h+=x.getStrips().getNumberOfValues(),Os(_,x.getPolys().getData(),s,g),g+=x.getPolys().getNumberOfValues();const A=x.getPointData();if(f){const O=A.getNormals();D.getData().set(O.getData(),s*3)}if(m){const O=A.getTCoords();b.getData().set(O.getData(),s*2)}if(v){const O=A.getScalars();M.getData().set(O.getData(),s*M.getNumberOfComponents())}s+=x.getPoints().getNumberOfPoints()}a.setPoints(p),a.getVerts().setData(C),a.getLines().setData(E),a.getStrips().setData(S),a.getPolys().setData(_),D&&a.getPointData().setNormals(D),b&&a.getPointData().setTCoords(b),M&&a.getPointData().setScalars(M),e[0]=a}}const _2={outputPointsPrecision:zc.DEFAULT};function LI(i,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(t,_2,n),Mt.setGet(i,t,["outputPointsPrecision"]),Mt.obj(i,t),Mt.algo(i,t,1,1),S2(i,t)}const D2=Mt.newInstance(LI,"vtkAppendPolyData");var RI={newInstance:D2,extend:LI};function b2(i,t){t.classHierarchy.push("vtkConeSource"),i.requestData=(n,e)=>{const o=2*Math.PI/t.resolution,a=-t.height/2,s=t.resolution+1,r=4*t.resolution+1+t.resolution;let c=0;const l=Mt.newTypedArray(t.pointType,s*3);let d=0;const u=new Uint32Array(r);l[0]=t.height/2,l[1]=0,l[2]=0,t.capping&&(u[d++]=t.resolution);for(let g=0;g<t.resolution;g++)c++,l[c*3+0]=a,l[c*3+1]=t.radius*Math.cos(g*o),l[c*3+2]=t.radius*Math.sin(g*o),t.capping&&(u[t.resolution-d+++1]=c);for(let g=0;g<t.resolution;g++)u[d++]=3,u[d++]=0,u[d++]=g+1,u[d++]=g+2>t.resolution?1:g+2;pn.buildFromRadian().translate(...t.center).rotateFromDirections([1,0,0],t.direction).apply(l);const h=e[0]?.initialize()||Eo.newInstance();h.getPoints().setData(l,3),h.getPolys().setData(u,1),e[0]=h}}const T2={height:1,radius:.5,resolution:6,center:[0,0,0],direction:[1,0,0],capping:!0,pointType:"Float64Array"};function NI(i,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(t,T2,n),Mt.obj(i,t),Mt.setGet(i,t,["height","radius","resolution","capping"]),Mt.setGetArray(i,t,["center","direction"],3),Mt.algo(i,t,0,1),b2(i,t)}const P2=Mt.newInstance(NI,"vtkConeSource");var M2={newInstance:P2,extend:NI};function x2(i,t){t.classHierarchy.push("vtkCylinderSource"),i.requestData=(n,e)=>{const o=2*Math.PI/t.resolution;let a=2*t.resolution,s=5*t.resolution;t.capping&&(a=4*t.resolution,s=7*t.resolution+2);const r=Mt.newTypedArray(t.pointType,a*3);let c=0;const l=new Uint32Array(s),d=new Float32Array(a*3),u=Zn.newInstance({numberOfComponents:3,values:d,name:"Normals"}),h=new Float32Array(a*2),g=Zn.newInstance({numberOfComponents:2,values:h,name:"TCoords"}),f=[0,0,0],m=[0,0,0],v=[0,0,0],p=[0,0,0],I=[0,0],C=[0,0],E=t.otherRadius==null?t.radius:t.otherRadius;for(let _=0;_<t.resolution;_++){f[0]=Math.cos(_*o+t.initAngle),m[0]=f[0],v[0]=t.radius*f[0]+t.center[0],p[0]=v[0],I[0]=Math.abs(2*_/t.resolution-1),C[0]=I[0],v[1]=.5*t.height+t.center[1],p[1]=-.5*t.height+t.center[1],I[1]=0,C[1]=1,f[2]=-Math.sin(_*o+t.initAngle),m[2]=f[2],v[2]=E*f[2]+t.center[2],p[2]=v[2];const D=2*_;for(let b=0;b<3;b++)d[D*3+b]=f[b],d[(D+1)*3+b]=m[b],r[D*3+b]=v[b],r[(D+1)*3+b]=p[b],b<2&&(h[D*2+b]=I[b],h[(D+1)*2+b]=C[b])}for(let _=0;_<t.resolution;_++){l[c++]=4,l[c++]=2*_,l[c++]=2*_+1;const D=(2*_+3)%(2*t.resolution);l[c++]=D,l[c++]=D-1}if(t.capping){for(let _=0;_<t.resolution;_++){v[0]=t.radius*Math.cos(_*o+t.initAngle),p[0]=v[0],I[0]=v[0],C[0]=v[0],v[0]+=t.center[0],p[0]+=t.center[0],f[1]=1,m[1]=-1,v[1]=.5*t.height+t.center[1],p[1]=-.5*t.height+t.center[1],v[2]=-E*Math.sin(_*o+t.initAngle),p[2]=v[2],I[1]=v[2],C[1]=v[2],v[2]+=t.center[2],p[2]+=t.center[2];const D=2*t.resolution+_,b=3*t.resolution+t.resolution-_-1;for(let M=0;M<3;M++)d[3*D+M]=f[M],d[3*b+M]=m[M],r[3*D+M]=v[M],r[3*b+M]=p[M],M<2&&(h[2*D+M]=I[M],h[2*b+M]=C[M])}l[c++]=t.resolution;for(let _=0;_<t.resolution;_++)l[c++]=2*t.resolution+_;l[c++]=t.resolution;for(let _=0;_<t.resolution;_++)l[c++]=3*t.resolution+_}pn.buildFromRadian().translate(...t.center).rotateFromDirections([0,1,0],t.direction).translate(...t.center.map(_=>_*-1)).apply(r);const S=e[0]?.initialize()||Eo.newInstance();S.getPoints().setData(r,3),S.getPolys().setData(l,1),S.getPointData().setNormals(u),S.getPointData().setTCoords(g),e[0]=S}}const y2={height:1,initAngle:0,radius:1,resolution:6,center:[0,0,0],direction:[0,1,0],capping:!0,pointType:"Float64Array"};function UI(i,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(t,y2,n),Mt.obj(i,t),Mt.setGet(i,t,["height","initAngle","otherRadius","radius","resolution","capping"]),Mt.setGetArray(i,t,["center","direction"],3),Mt.algo(i,t,0,1),x2(i,t)}const A2=Mt.newInstance(UI,"vtkCylinderSource");var O2={newInstance:A2,extend:UI};function L2(i,t){t.classHierarchy.push("vtkArrowSource"),i.requestData=(n,e)=>{const o=O2.newInstance({capping:!0});o.setResolution(t.shaftResolution),o.setRadius(t.shaftRadius),o.setHeight(1-t.tipLength),o.setCenter(0,(1-t.tipLength)*.5,0);const a=o.getOutputData(),s=a.getPoints().getData(),r=a.getPointData().getNormals().getData();pn.buildFromDegree().rotateZ(-90).apply(s).apply(r);const c=M2.newInstance();c.setResolution(t.tipResolution),c.setHeight(t.tipLength),c.setRadius(t.tipRadius);const l=c.getOutputData(),d=l.getPoints().getData();pn.buildFromRadian().translate(1-t.tipLength*.5,0,0).apply(d);const u=RI.newInstance();u.setInputData(a),u.addInputData(l);const h=u.getOutputData(),g=h.getPoints().getData();pn.buildFromRadian().translate(-.5+t.tipLength*.5,0,0).apply(g),t.invert?(pn.buildFromRadian().rotateFromDirections([1,0,0],t.direction).scale(-1,-1,-1).apply(g),e[0]=h):(pn.buildFromRadian().rotateFromDirections([1,0,0],t.direction).scale(1,1,1).apply(g),e[0]=u.getOutputData())}}const R2={tipResolution:6,tipRadius:.1,tipLength:.35,shaftResolution:6,shaftRadius:.03,invert:!1,direction:[1,0,0],pointType:"Float64Array"};function kI(i,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};Object.assign(t,R2,n),Mt.obj(i,t),Mt.setGet(i,t,["tipResolution","tipRadius","tipLength","shaftResolution","shaftRadius","invert"]),Mt.setGetArray(i,t,["direction"],3),Mt.algo(i,t,0,1),L2(i,t)}const N2=Mt.newInstance(kI,"vtkArrowSource");var Uc={newInstance:N2,extend:kI};function kc(i){const t=i.getPoints().getBounds(),n=[-(t[0]+t[1])*.5,-(t[2]+t[3])*.5,-(t[4]+t[5])*.5];pn.buildFromDegree().translate(...n).apply(i.getPoints().getData())}function Vc(i,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;const e=i.getPoints().getBounds(),o=[0,0,0];n?o[t]=-e[t*2+1]:o[t]=-e[t*2],pn.buildFromDegree().translate(...o).apply(i.getPoints().getData())}function Fc(i,t,n,e){const o=i.getPoints().getData().length,a=new Uint8ClampedArray(o);let s=0;for(;s<o;)a[s++]=t,a[s++]=n,a[s++]=e;i.getPointData().setScalars(Zn.newInstance({name:"color",numberOfComponents:3,values:a}))}function U2(i,t){t.classHierarchy.push("vtkAxesActor");const n=xi.newInstance();i.setMapper(n),i.update=()=>{let o={...t.config,...t.xConfig};const a=Uc.newInstance({direction:[1,0,0],...o}).getOutputData();t.config.recenter?kc(a):Vc(a,0,o.invert),Fc(a,...o.color),o={...t.config,...t.yConfig};const s=Uc.newInstance({direction:[0,1,0],...o}).getOutputData();t.config.recenter?kc(s):Vc(s,1,o.invert),Fc(s,...o.color),o={...t.config,...t.zConfig};const r=Uc.newInstance({direction:[0,0,1],...o}).getOutputData();t.config.recenter?kc(r):Vc(r,2,o.invert),Fc(r,...o.color);const c=RI.newInstance();c.setInputData(a),c.addInputData(s),c.addInputData(r),n.setInputConnection(c.getOutputPort())},i.update();const e=Mt.debounce(i.update,0);i.setXAxisColor=o=>i.setXConfig({...i.getXConfig(),color:o}),i.setYAxisColor=o=>i.setYConfig({...i.getYConfig(),color:o}),i.setZAxisColor=o=>i.setZConfig({...i.getZConfig(),color:o}),i.getXAxisColor=()=>t.getXConfig().color,i.getYAxisColor=()=>t.getYConfig().color,i.getZAxisColor=()=>t.getZConfig().color,t._onConfigChanged=e,t._onXConfigChanged=e,t._onYConfigChanged=e,t._onZConfigChanged=e}function k2(i){return{config:{recenter:!0,tipResolution:60,tipRadius:.1,tipLength:.2,shaftResolution:60,shaftRadius:.03,invert:!1,...i?.config},xConfig:{color:[255,0,0],invert:!1,...i?.xConfig},yConfig:{color:[255,255,0],invert:!1,...i?.yConfig},zConfig:{color:[0,128,0],invert:!1,...i?.zConfig}}}function VI(i,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};yi.extend(i,t,k2(n)),Mt.setGet(i,t,["config","xConfig","yConfig","zConfig"]),U2(i,t)}const V2=Mt.newInstance(VI,"vtkAxesActor");var F2={newInstance:V2,extend:VI},ur;(function(i){i[i.ANNOTATED_CUBE=1]="ANNOTATED_CUBE",i[i.AXES=2]="AXES",i[i.CUSTOM=3]="CUSTOM"})(ur||(ur={}));const Mn=class Mn extends de{constructor(t={},n={configuration:{orientationWidget:{enabled:!0,viewportCorner:vg.Corners.BOTTOM_RIGHT,viewportSize:.15,minPixelSize:100,maxPixelSize:300},overlayMarkerType:Mn.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE,overlayConfiguration:{[Mn.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE]:{faceProperties:{xPlus:{text:"L",faceColor:"#ffff00",faceRotation:90},xMinus:{text:"R",faceColor:"#ffff00",faceRotation:270},yPlus:{text:"P",faceColor:"#00ffff",fontColor:"white",faceRotation:180},yMinus:{text:"A",faceColor:"#00ffff",fontColor:"white"},zPlus:{text:"S"},zMinus:{text:"I"}},defaultStyle:{fontStyle:"bold",fontFamily:"Arial",fontColor:"black",fontSizeScale:e=>e/2,faceColor:"#0000ff",edgeThickness:.1,edgeColor:"black",resolution:400}},[Mn.OVERLAY_MARKER_TYPES.AXES]:{},[Mn.OVERLAY_MARKER_TYPES.CUSTOM]:{polyDataURL:"https://raw.githubusercontent.com/Slicer/Slicer/80ad0a04dacf134754459557bf2638c63f3d1d1b/Base/Logic/Resources/OrientationMarkers/Human.vtp"}}}}){super(t,n),this._resizeObservers=new Map,this.onSetToolEnabled=()=>{this.initViewports(),this._subscribeToViewportEvents()},this.onSetToolActive=()=>{this.initViewports(),this._subscribeToViewportEvents()},this.onSetToolDisabled=()=>{this.cleanUpData(),this._unsubscribeToViewportNewVolumeSet()},this._getViewportsInfo=()=>_e(this.toolGroupId).viewportsInfo,this.resize=e=>{const o=this.orientationMarkers[e];if(!o)return;const{orientationWidget:a}=o;a.updateViewport()},this.orientationMarkers={},this.updatingOrientationMarker={}}_unsubscribeToViewportNewVolumeSet(){const t=()=>{this._getViewportsInfo().forEach(({viewportId:e,renderingEngineId:o})=>{const{viewport:a}=Gt(e,o),{element:s}=a;s.removeEventListener(ut.VOLUME_VIEWPORT_NEW_VOLUME,this.initViewports.bind(this)),this._resizeObservers.get(e).unobserve(s)})};z.removeEventListener(w.TOOLGROUP_VIEWPORT_ADDED,n=>{n.detail.toolGroupId===this.toolGroupId&&(t(),this.initViewports())})}_subscribeToViewportEvents(){const t=()=>{this._getViewportsInfo().forEach(({viewportId:e,renderingEngineId:o})=>{const{viewport:a}=Gt(e,o),{element:s}=a;this.initViewports(),s.addEventListener(ut.VOLUME_VIEWPORT_NEW_VOLUME,this.initViewports.bind(this));const r=new ResizeObserver(()=>{setTimeout(()=>{const c=Gt(e,o);if(!c)return;const{viewport:l}=c;this.resize(e),l.render()},100)});r.observe(s),this._resizeObservers.set(e,r)})};t(),z.addEventListener(w.TOOLGROUP_VIEWPORT_ADDED,n=>{n.detail.toolGroupId===this.toolGroupId&&(t(),this.initViewports())})}cleanUpData(){Co()[0].getViewports().forEach(o=>{const a=this.orientationMarkers[o.id];if(!a)return;const{actor:s,orientationWidget:r}=a;r?.setEnabled(!1),r?.delete(),s?.delete(),o.getRenderingEngine().getOffscreenMultiRenderWindow(o.id).getRenderWindow().render(),o.getRenderingEngine().render(),delete this.orientationMarkers[o.id]})}initViewports(){const n=Co()[0];if(!n)return;let e=n.getViewports();e=Lr(e,this.getToolName()),e.forEach(o=>{const a=o.getWidget(this.getToolName());(!a||a.isDeleted())&&this.addAxisActorInViewport(o)})}async addAxisActorInViewport(t){const n=t.id;if(!this.updatingOrientationMarker[n]){this.updatingOrientationMarker[n]=!0;const e=this.configuration.overlayMarkerType,o=this.configuration.overlayConfiguration[e];if(this.orientationMarkers[n]){const{actor:f,orientationWidget:m}=this.orientationMarkers[n];t.getRenderer().removeActor(f),m.setEnabled(!1)}let a;e===1?a=this.createAnnotationCube(o):e===2?a=F2.newInstance():e===3&&(a=await this.createCustomActor());const s=t.getRenderer(),r=t.getRenderingEngine().getOffscreenMultiRenderWindow(n).getRenderWindow(),{enabled:c,viewportCorner:l,viewportSize:d,minPixelSize:u,maxPixelSize:h}=this.configuration.orientationWidget,g=vg.newInstance({actor:a,interactor:r.getInteractor(),parentRenderer:s});g.setEnabled(c),g.setViewportCorner(l),g.setViewportSize(d),g.setMinPixelSize(u),g.setMaxPixelSize(h),g.updateMarkerOrientation(),this.orientationMarkers[n]={orientationWidget:g,actor:a},t.addWidget(this.getToolName(),g),r.render(),t.getRenderingEngine().render(),this.updatingOrientationMarker[n]=!1}}async createCustomActor(){const t=this.configuration.overlayConfiguration[ur.CUSTOM].polyDataURL,e=await(await fetch(t)).arrayBuffer(),o=W0.newInstance();o.parseAsArrayBuffer(e),o.update();const a=Eo.newInstance();a.shallowCopy(o.getOutputData()),a.getPointData().setActiveScalars("Color");const s=xi.newInstance();s.setInputData(a),s.setColorModeToDirectScalars();const r=yi.newInstance();return r.setMapper(s),r.rotateZ(180),r}createAnnotationCube(t){const n=Ig.newInstance();return n.setDefaultStyle({...t.defaultStyle}),n.setXPlusFaceProperty({...t.faceProperties.xPlus}),n.setXMinusFaceProperty({...t.faceProperties.xMinus}),n.setYPlusFaceProperty({...t.faceProperties.yPlus}),n.setYMinusFaceProperty({...t.faceProperties.yMinus}),n.setZPlusFaceProperty({...t.faceProperties.zPlus}),n.setZMinusFaceProperty({...t.faceProperties.zMinus}),n}async createAnnotatedCubeActor(){const t=Ig.newInstance(),{faceProperties:n,defaultStyle:e}=this.configuration.annotatedCube;return t.setDefaultStyle(e),Object.keys(n).forEach(o=>{const a=`set${o.charAt(0).toUpperCase()+o.slice(1)}FaceProperty`;t[a](n[o])}),t}};Mn.CUBE=1,Mn.AXIS=2,Mn.VTPFILE=3,Mn.OVERLAY_MARKER_TYPES=ur;let Dl=Mn;Dl.toolName="OrientationMarker";const Ma=class Ma extends de{constructor(t={},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{hoverTimeout:100,mode:Ma.SelectMode.Border,searchRadius:6}}){super(t,n),this.mouseMoveCallback=e=>{if(this.mode===Ot.Active)return this.hoverTimer&&clearTimeout(this.hoverTimer),this.hoverTimer=setTimeout(()=>{this._setActiveSegment(e),this.hoverTimer=null},this.configuration.hoverTimeout),!0},this.onSetToolEnabled=()=>{this.onSetToolActive()},this.onSetToolActive=()=>{this.hoverTimer=null},this.onSetToolDisabled=()=>{this.hoverTimer=null},this.hoverTimer=null}_setActiveSegment(t={}){if(U.isInteractingWithTool)return;const{element:n,currentPoints:e}=t.detail,o=e.world,a=y(n);if(!a)return;const{viewport:s}=a,r=oo(s.id);r&&this._setActiveSegmentForType(r,o,s)}_setActiveSegmentForType(t,n,e){if(!e.getImageData())return;const{segmentationId:a,representationData:s}=t;let r;if(this.configuration.mode===Ma.SelectMode.Inside?r=Fd(a,n,{viewport:e}):s.Labelmap?r=Nv(a,n,{viewport:e,searchRadius:this.configuration.searchRadius}):s.Contour?r=kv(a):s.Surface,!r||r===0)return;Ha(a,r);const l=e.getRenderingEngine().getViewports().map(d=>d.id);gn(a),L(l)}};Ma.SelectMode={Inside:"Inside",Border:"Border"};let bl=Ma;bl.toolName="SegmentSelectTool";const Si=class Si extends ar{constructor(t={}){super(t),this.renderAnnotation=(n,e)=>{let o=!0;const{viewport:a}=n,{element:s}=a,r=a.id;let c=Ct(this.getToolName(),s);if(!c?.length||(c=this.filterInteractableAnnotationsForElement(s,c),!c?.length))return o;const l=this.getTargetId(a),d=a.getRenderingEngine(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:n.viewport.id};for(let h=0;h<c.length;h++){const g=c[h],{annotationUID:f,data:m}=g,{points:v,activeHandleIndex:p}=m.handles,I=v.map(j=>a.worldToCanvas(j));u.annotationUID=f;const{segmentIndex:C,segmentationId:E}=g.metadata,{lineWidth:S,lineDash:_,shadow:D}=this.getAnnotationStyle({annotation:g,styleSpecifier:u}),M=`rgb(${Vn(r,E,C).slice(0,3).join(",")})`;if(!m.cachedStats[l]||m.cachedStats[l].unit==null?(m.cachedStats[l]={length:null,width:null,unit:null},this._calculateCachedStats(g,d,n)):g.invalidated&&this._throttledCalculateCachedStats(g,d,n),!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),o;let P;if(!re(f))continue;!se(f)&&!this.editData&&p!==null&&(P=[I[p]]),P&&$t(e,f,"0",P,{color:M});const T=`${f}-line-1`,x=`${f}-line-2`;Et(e,f,"0",I[0],I[1],{color:M,lineWidth:S,lineDash:_,shadow:D},T),Et(e,f,"1",I[2],I[3],{color:M,lineWidth:S,lineDash:_,shadow:D},x),o=!0;const R=this.getLinkedTextBoxStyle(u,g);if(!R.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}R.color=M;const N=this.configuration.getTextLines(m,l);if(!N||N.length===0)continue;let k;m.handles.textBox.hasMoved||(k=qe(I),m.handles.textBox.worldPosition=a.canvasToWorld(k));const B=a.worldToCanvas(m.handles.textBox.worldPosition),$=Oe(e,f,"1",N,B,I,{},R),{x:H,y:G,width:Y,height:q}=$;m.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([H,G]),topRight:a.canvasToWorld([H+Y,G]),bottomLeft:a.canvasToWorld([H,G+q]),bottomRight:a.canvasToWorld([H+Y,G+q])}}return o}}addNewAnnotation(t){const n=t.detail,{currentPoints:e,element:o}=n,a=e.world,s=y(o),{viewport:r}=s;this.isDrawing=!0;const c=r.getCamera(),{viewPlaneNormal:l,viewUp:d}=c,u=this.getReferencedImageId(r,a,l,d),h=r.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...l],viewUp:[...d],FrameOfReferenceUID:h,referencedImageId:u,...r.getViewReference({points:[a]})},data:{handles:{points:[[...a],[...a],[...a],[...a]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}}};mt(g,o);const f=Q(o,this.getToolName());return this.editData={annotation:g,viewportIdsToRender:f,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),nt(o),t.preventDefault(),L(f),g}};Si.toolName="SegmentBidirectional",Si.hydrate=(t,n,e)=>{const o=At(t);if(!o)return;const{viewport:a}=o,c=Fi().filter(D=>D.metadata.toolName==="SegmentBidirectional").find(D=>{const{metadata:b}=D;return b.segmentIndex===e?.segmentIndex&&b.segmentationId===e?.segmentationId});c&&ft(c.annotationUID);const{FrameOfReferenceUID:l,referencedImageId:d,viewPlaneNormal:u,instance:h}=Si.hydrateBase(Si,o,n[0],e),[g,f]=n,[m,v]=g,[p,I]=f,C=[m,v,p,I],{toolInstance:E,...S}=e||{},_={annotationUID:e?.annotationUID||Xt(),data:{handles:{points:C,activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},cachedStats:{}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{segmentIndex:e?.segmentIndex,segmentationId:e?.segmentationId,toolName:h.getToolName(),viewPlaneNormal:u,FrameOfReferenceUID:l,referencedImageId:d,...S}};return mt(_,a.element),L([a.id]),_};let wg=Si;class B2 extends de{constructor(t={data:{handles:{textBox:{worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}},n={supportedInteractionTypes:["Mouse","Touch"],configuration:{hoverTimeout:100,searchRadius:6,color:null,background:null}}){super(t,n),this.mouseMoveCallback=e=>(this.hoverTimer&&clearTimeout(this.hoverTimer),this.hoverTimer=setTimeout(()=>{this._setHoveredSegment(e),this.hoverTimer=null},this.configuration.hoverTimeout),!0),this.onSetToolEnabled=()=>{this.onSetToolActive()},this.onSetToolActive=()=>{this.hoverTimer=null},this.onSetToolDisabled=()=>{this.hoverTimer=null},this.data=t.data??{handles:{textBox:{worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}},this.hoverTimer=null}_setHoveredSegment(t={}){if(U.isInteractingWithTool)return;const{element:n,currentPoints:e}=t.detail,o=e.world,a=y(n);if(!a)return;const{viewport:s}=a,r=oo(s.id);r&&this._setHoveredSegmentForType(r,o,s)}_setHoveredSegmentForType(t,n,e){if(!e.getImageData())return;const{segmentationId:a}=t,s=Fd(a,n,{viewport:e}),r=t.segments[s],c=this.configuration.color??Vn(e.id,a,s),l=r?.label,d=e.worldToCanvas(n);if(this._editData={hoveredSegmentIndex:s,hoveredSegmentLabel:l,canvasCoordinates:d,color:c},!s||s===0)return;const h=e.getRenderingEngine().getViewports().map(g=>g.id);gn(a),L(h)}renderAnnotation(t,n){if(!this._editData)return;const{viewport:e}=t,{hoveredSegmentIndex:o,hoveredSegmentLabel:a,canvasCoordinates:s,color:r}=this._editData;if(!o)return;const c=-15,l=[s[0]+c,s[1]+c],d=eo(n,"segmentSelectLabelAnnotation","segmentSelectLabelTextBox",[a??"(unnamed segment)"],l,{color:`rgba(${r[0]}, ${r[1]}, ${r[2]}, ${r[3]})`,background:this.configuration.background??void 0}),u=s[0],h=s[1],{width:g,height:f}=d;this.data.handles.textBox.worldBoundingBox={topLeft:e.canvasToWorld([u,h]),topRight:e.canvasToWorld([u+g,h]),bottomLeft:e.canvasToWorld([u,h+f]),bottomRight:e.canvasToWorld([u+g,h+f])}}}B2.toolName="SegmentLabelTool";const Le=class Le extends Ga{constructor(t={}){const n=Be({configuration:{calculateStats:!1,allowOpenContours:!1}},t);super(n),this.onViewportAddedToToolGroupBinded=this.onViewportAddedToToolGroup.bind(this),this.onSegmentationModifiedBinded=this.onSegmentationModified.bind(this)}initializeListeners(){Le.annotationsToViewportMap.clear(),Le.viewportIdsChecked=[],z.addEventListener(w.ANNOTATION_MODIFIED,this.annotationModified),z.addEventListener(w.ANNOTATION_COMPLETED,this.annotationCompleted),z.addEventListener(w.TOOLGROUP_VIEWPORT_ADDED,this.onViewportAddedToToolGroupBinded),z.addEventListener(w.SEGMENTATION_MODIFIED,this.onSegmentationModifiedBinded),z.addEventListener(w.SEGMENTATION_REPRESENTATION_MODIFIED,this.onSegmentationModifiedBinded)}cleanUpListeners(){Le.annotationsToViewportMap.clear(),Le.viewportIdsChecked=[],z.removeEventListener(w.ANNOTATION_MODIFIED,this.annotationModified),z.removeEventListener(w.ANNOTATION_COMPLETED,this.annotationCompleted),z.removeEventListener(w.TOOLGROUP_VIEWPORT_ADDED,this.onViewportAddedToToolGroup.bind(this)),z.removeEventListener(w.SEGMENTATION_MODIFIED,this.onSegmentationModified.bind(this)),z.removeEventListener(w.SEGMENTATION_REPRESENTATION_MODIFIED,this.onSegmentationModified.bind(this))}async checkContourSegmentation(t){if(Le.viewportIdsChecked.includes(t))return;const n=Ko(t);if(!n)return console.log("No active segmentation detected"),!1;const e=n.segmentationId;return n.representationData.Contour?Le.viewportIdsChecked.push(t):(Le.viewportIdsChecked.push(t),await Bd(t,[{segmentationId:e,type:tt.Contour}]),jl({segmentationId:e,type:tt.Contour,data:{}})),!0}onViewportAddedToToolGroup(t){const{toolGroupId:n,viewportId:e}=t.detail;n===this.toolGroupId&&this.checkContourSegmentation(e)}onSegmentationModified(t){const{segmentationId:n}=t.detail||{};if(!n)return;const e=Nf(n);e&&e.forEach(async({viewportId:o})=>await this.checkContourSegmentation(o))}onSetToolEnabled(){this.initializeListeners()}onSetToolActive(){this.initializeListeners()}onSetToolDisabled(){this.cleanUpListeners()}annotationModified(t){const{annotation:n,renderingEngineId:e,viewportId:o}=t.detail,a=te(e)?.getViewport(o);a&&Le.annotationsToViewportMap.set(n.annotationUID,a)}annotationCompleted(t){const{annotation:n}=t.detail,{polyline:e}=n.data?.contour||{};if(n?.metadata?.toolName===Le.toolName&&e&&Le.annotationsToViewportMap.has(n.annotationUID)){const o=Le.annotationsToViewportMap.get(n.annotationUID);e.length>3&&ki.viewportContoursToLabelmap(o)}}};Le.toolName="LabelMapEditWithContour",Le.annotationsToViewportMap=new Map,Le.viewportIdsChecked=[];let Cg=Le;const hu=class hu extends zt{constructor(t={}){super(t,{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}),this.addNewAnnotation=n=>{const e=n.detail,{currentPoints:o,element:a}=e,s=o.world,r=y(a),{viewport:c}=r;this.isDrawing=!0;const l=this.constructor.createAnnotationForViewport(c,{data:{handles:{points:[[...s],[...s],[...s],[...s]]}}});mt(l,a);const d=Q(a,this.getToolName(),!1);return this.editData={annotation:l,viewportUIDsToRender:d,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),nt(a),n.preventDefault(),L(d),l},this.getHandleNearImagePoint=(n,e,o,a)=>{const s=y(n),{viewport:r}=s,{data:c}=e,{points:l}=c.handles;for(let d=0;d<l.length;d++){const u=l[d],h=r.worldToCanvas(u);if(jt(o,h)<a===!0)return c.handles.activeHandleIndex=d,u}c.handles.activeHandleIndex=null},this.isPointNearTool=(n,e,o,a)=>{const s=y(n),{viewport:r}=s,{data:c}=e,{points:l}=c.handles,d=r.worldToCanvas(l[0]),u=r.worldToCanvas(l[3]),h=this._getRectangleImageCoordinates([d,u]),g=[o[0],o[1]],{left:f,top:m,width:v,height:p}=h;if(rd([f,m,v,p],g)<=a)return!0},this.toolSelectedCallback=(n,e,o="mouse")=>{const a=n.detail,{element:s}=a,{data:r}=e;r.active=!0;const c=Q(s,this.getToolName(),!1);this.editData={annotation:e,viewportUIDsToRender:c},this._activateModify(s),nt(s),L(c),n.preventDefault()},this.handleSelectedCallback=(n,e,o,a="mouse")=>{const s=n.detail,{element:r}=s,{data:c}=e;c.active=!0;let l;o.worldPosition||(l=c.handles.points.findIndex(u=>u===o));const d=Q(r,this.getToolName(),!1);this.editData={annotation:e,viewportUIDsToRender:d,handleIndex:l},this._activateModify(r),nt(r),L(d),n.preventDefault()},this._endCallback=n=>{const e=n.detail,{element:o}=e,{annotation:a,viewportUIDsToRender:s,newAnnotation:r,hasMoved:c}=this.editData,{data:l}=a;r&&!c||(this.doneEditMemo(),l.active=!1,l.handles.activeHandleIndex=null,this._deactivateModify(o),this._deactivateDraw(o),ht(o),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&ft(a.annotationUID),L(s))},this._dragCallback=n=>{this.isDrawing=!0;const e=n.detail,{element:o}=e,{annotation:a,viewportUIDsToRender:s,handleIndex:r,newAnnotation:c}=this.editData;this.createMemo(o,a,{newAnnotation:c});const{data:l}=a;if(r===void 0){const{deltaPoints:d}=e,u=d.world,{points:h}=l.handles;h.forEach(g=>{g[0]+=u[0],g[1]+=u[1],g[2]+=u[2]}),l.invalidated=!0}else{const{currentPoints:d}=e,u=y(o),{worldToCanvas:h,canvasToWorld:g}=u.viewport,f=d.world,{points:m}=l.handles;m[r]=[...f];let v,p,I,C,E,S,_,D;switch(r){case 0:case 3:v=h(m[0]),C=h(m[3]),p=[C[0],v[1]],I=[v[0],C[1]],S=g(p),_=g(I),m[1]=S,m[2]=_;break;case 1:case 2:p=h(m[1]),I=h(m[2]),v=[I[0],p[1]],C=[p[0],I[1]],E=g(v),D=g(C),m[0]=E,m[3]=D;break}l.invalidated=!0}this.editData.hasMoved=!0,y(o),L(s)},this._activateDraw=n=>{U.isInteractingWithTool=!0,n.addEventListener(w.MOUSE_UP,this._endCallback),n.addEventListener(w.MOUSE_DRAG,this._dragCallback),n.addEventListener(w.MOUSE_MOVE,this._dragCallback),n.addEventListener(w.MOUSE_CLICK,this._endCallback),n.addEventListener(w.TOUCH_END,this._endCallback),n.addEventListener(w.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=n=>{U.isInteractingWithTool=!1,n.removeEventListener(w.MOUSE_UP,this._endCallback),n.removeEventListener(w.MOUSE_DRAG,this._dragCallback),n.removeEventListener(w.MOUSE_MOVE,this._dragCallback),n.removeEventListener(w.MOUSE_CLICK,this._endCallback),n.removeEventListener(w.TOUCH_END,this._endCallback),n.removeEventListener(w.TOUCH_DRAG,this._dragCallback)},this._activateModify=n=>{U.isInteractingWithTool=!0,n.addEventListener(w.MOUSE_UP,this._endCallback),n.addEventListener(w.MOUSE_DRAG,this._dragCallback),n.addEventListener(w.MOUSE_CLICK,this._endCallback),n.addEventListener(w.TOUCH_END,this._endCallback),n.addEventListener(w.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=n=>{U.isInteractingWithTool=!1,n.removeEventListener(w.MOUSE_UP,this._endCallback),n.removeEventListener(w.MOUSE_DRAG,this._dragCallback),n.removeEventListener(w.MOUSE_CLICK,this._endCallback),n.removeEventListener(w.TOUCH_END,this._endCallback),n.removeEventListener(w.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(n,e)=>{const{viewport:a}=n,{element:s}=a;let r=Ct(this.getToolName(),s);if(!r?.length||(r=this.filterInteractableAnnotationsForElement(s,r),!r?.length))return!1;const c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:n.viewport.id};for(let l=0;l<r.length;l++){const d=r[l],{annotationUID:u}=d,h=d.data,{points:g,activeHandleIndex:f}=h.handles,m=g.map(S=>a.worldToCanvas(S)),v=this.getStyle("lineWidth",c,d),p=this.getStyle("lineDash",c,d),I=this.getStyle("color",c,d);if(!a.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");return}let C;!this.editData&&f!==null&&(C=[m[f]]),C&&$t(e,u,"0",C,{color:I}),pm(e,u,"0",m[0],m[3],{color:"black",lineDash:p,lineWidth:v})}},this._getRectangleImageCoordinates=n=>{const[e,o]=n;return{left:Math.min(e[0],o[0]),top:Math.min(e[1],o[1]),width:Math.abs(e[0]-o[0]),height:Math.abs(e[1]-o[1])}},this._calculateCachedStats=(n,e,o,a,s)=>{const{data:r}=n,{viewportUID:c,renderingEngineUID:l,sceneUID:d}=s,u=r.handles.points[0],h=r.handles.points[3],{cachedStats:g}=r,f=Object.keys(g);for(let v=0;v<f.length;v++){const p=f[v],{imageVolume:I}=this._getImageVolumeFromTargetUID(p,a),{dimensions:C,scalarData:E,vtkImageData:S,metadata:_}=I,D=wt(0,0,0),b=wt(0,0,0);if(S.worldToIndexVec3(u,D),D[0]=Math.floor(D[0]),D[1]=Math.floor(D[1]),D[2]=Math.floor(D[2]),S.worldToIndexVec3(h,b),b[0]=Math.floor(b[0]),b[1]=Math.floor(b[1]),b[2]=Math.floor(b[2]),this._isInsideVolume(D,b,C)){this.isHandleOutsideImage=!1;const M=Math.min(D[0],b[0]),P=Math.max(D[0],b[0]),T=Math.min(D[1],b[1]),x=Math.max(D[1],b[1]),A=Math.min(D[2],b[2]),O=Math.max(D[2],b[2]),{worldWidth:R,worldHeight:N}=rs(e,o,u,h),k=R*N;let B=0,V=0,$=0;const H=C[0],G=C[0]*C[1];for(let Y=A;Y<=O;Y++)for(let q=T;q<=x;q++)for(let j=M;j<=P;j++){const K=E[Y*G+q*H+j];B++,V+=K}V/=B;for(let Y=A;Y<=O;Y++)for(let q=T;q<=x;q++)for(let j=M;j<=P;j++){const it=E[Y*G+q*H+j]-V;$+=it*it}$/=B,$=Math.sqrt($),g[p]={Modality:_.Modality,area:k,mean:V,stdDev:$}}else this.isHandleOutsideImage=!0,g[p]={Modality:_.Modality}}const m=n.invalidated;if(n.invalidated=!1,m){const v=w.ANNOTATION_MODIFIED,p={annotation:n,viewportUID:c,renderingEngineUID:l,sceneUID:d,changeType:lt.StatsUpdated};gt(z,v,p)}return g},this._isInsideVolume=(n,e,o)=>we(n,o)&&we(e,o),this._getTargetVolumeUID=n=>{if(this.configuration.volumeUID)return this.configuration.volumeUID;const e=n.getVolumeActors();if(!(!e&&!e.length))return e[0].uid},this._throttledCalculateCachedStats=Fe(this._calculateCachedStats,100,{trailing:!0})}cancel(t){if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(t),this._deactivateModify(t),ht(t);const{annotation:n,viewportUIDsToRender:e}=this.editData,{data:o}=n;return o.active=!1,o.handles.activeHandleIndex=null,L(e),this.editData=null,n.annotationUID}_getImageVolumeFromTargetUID(t,n){let e,o;if(t.startsWith("stackTarget")){const a=t.indexOf(":"),s=t.substring(a+1);e=n.getViewport(s).getImageData()}else e=X.getVolume(t);return{imageVolume:e,viewport:o}}_getTargetStackUID(t){return`stackTarget:${t.uid}`}};hu.toolName="VideoRedaction";let Eg=hu;export{rr as AdvancedMagnifyTool,ag as AngleTool,ao as AnnotationDisplayTool,zt as AnnotationTool,ig as ArrowAnnotateTool,de as BaseTool,ar as BidirectionalTool,ki as BrushTool,K2 as CONSTANTS,i2 as CircleROIStartEndThresholdTool,cr as CircleROITool,n2 as CircleScissorsTool,sg as CobbAngleTool,eA as CrosshairsTool,qh as DragProbeTool,Qh as ETDRSGridTool,Zh as EllipticalROITool,$2 as Enums,XA as EraserTool,Yh as HeightTool,hg as KeyImageTool,Cg as LabelMapEditWithContourTool,Il as LabelTool,Ui as LabelmapBaseTool,jh as LengthTool,og as LivewireContourSegmentationTool,El as LivewireContourTool,Ky as MIPJumpToClickTool,nA as MagnifyTool,Dl as OrientationMarkerTool,lA as OverlayGridTool,s2 as PaintFillTool,Ry as PanTool,Ga as PlanarFreehandContourSegmentationTool,il as PlanarFreehandROITool,Yy as PlanarRotateTool,wl as ProbeTool,hv as RectangleROIStartEndThresholdTool,gv as RectangleROIThresholdTool,nr as RectangleROITool,e2 as RectangleScissorsTool,gA as ReferenceCursors,cA as ReferenceLinesTool,mg as RegionSegmentPlusTool,fg as RegionSegmentTool,fA as ScaleOverlayTool,pA as SculptorTool,wg as SegmentBidirectionalTool,B2 as SegmentLabelTool,bl as SegmentSelectTool,dA as SegmentationIntersectionTool,o2 as SphereScissorsTool,ng as SplineContourSegmentationTool,Cl as SplineROITool,Xy as StackScrollTool,tv as Synchronizer,dT as SynchronizerManager,Ew as ToolGroupManager,Ny as TrackballRotateTool,eO as Types,cg as UltrasoundDirectionalTool,ug as UltrasoundPleuraBLineTool,Eg as VideoRedactionTool,$y as VolumeCroppingControlTool,By as VolumeCroppingTool,wA as VolumeRotateTool,JA as WholeBodySegmentTool,jy as WindowLevelRegionTool,zy as WindowLevelTool,qy as ZoomTool,Jg as addTool,j2 as annotation,iT as cancelActiveManipulations,H2 as cursors,q2 as destroy,z2 as drawing,Y2 as init,Mw as removeTool,nO as segmentation,oO as splines,U as state,X2 as store,Q2 as synchronizers,tO as utilities,Z2 as version};
