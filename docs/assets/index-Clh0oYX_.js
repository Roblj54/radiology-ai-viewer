const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DdKylV0O.js","assets/index-Cp4iUYqv.js","assets/Texture-C9D3AFRO.js","assets/imageRetrievalPoolManager-DiP2nqZv.js","assets/index-BFl08faP.js","assets/index-BE8N2Zch.js"])))=>i.map(i=>d[i]);
(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const Me="modulepreload",Te=function(e){return"/radiology-ai-viewer/"+e},de={},Y=function(t,n,i){let o=Promise.resolve();if(n&&n.length>0){let p=function(l){return Promise.all(l.map(h=>Promise.resolve(h).then(I=>({status:"fulfilled",value:I}),I=>({status:"rejected",reason:I}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),s=a?.nonce||a?.getAttribute("nonce");o=p(n.map(l=>{if(l=Te(l),l in de)return;de[l]=!0;const h=l.endsWith(".css"),I=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${I}`))return;const c=document.createElement("link");if(c.rel=h?"stylesheet":Me,h||(c.as="script"),c.crossOrigin="",c.href=l,s&&c.setAttribute("nonce",s),document.head.appendChild(c),h)return new Promise((C,_)=>{c.addEventListener("load",C),c.addEventListener("error",()=>_(new Error(`Unable to preload CSS for ${l}`)))})}))}function r(a){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=a,window.dispatchEvent(s),!s.defaultPrevented)throw a}return o.then(a=>{for(const s of a||[])s.status==="rejected"&&r(s.reason);return t().catch(r)})};function Re(e){const t=e&&e.viewport,n=e&&e.container;if(!n)throw new Error("setupAIMockOverlay: container is required");window.getComputedStyle(n).position==="static"&&(n.style.position="relative");const o=document.createElement("canvas");o.style.position="absolute",o.style.inset="0",o.style.pointerEvents="none",o.style.zIndex="9998",o.style.width="100%",o.style.height="100%",n.appendChild(o);const r=o.getContext("2d");let a=!1,s=[],p=[],l=[];const h=!!(t&&typeof t.canvasToWorld=="function"&&typeof t.worldToCanvas=="function"),I=(u,m)=>h?t.canvasToWorld([u,m]):[u,m,0],c=u=>h?t.worldToCanvas(u):[u[0],u[1]],C=(u,m)=>Math.hypot(u[0]-m[0],u[1]-m[1],(u[2]||0)-(m[2]||0));function _(){const u=t&&typeof t.getCanvas=="function"&&t.getCanvas()||n.querySelector("canvas"),m=u&&u.width?u.width:n.clientWidth,E=u&&u.height?u.height:n.clientHeight;o.width!==m&&(o.width=m),o.height!==E&&(o.height=E)}function f(u,m){_();const E=u*o.width,b=m*o.height;return I(E,b)}function x(){s=[{a:f(.28,.3),b:f(.55,.58),label:"Nodule 0.87"},{a:f(.62,.22),b:f(.82,.4),label:"Mass 0.73"}],p=[(()=>{const u=f(.48,.52),m=f(.56,.52);return{c:u,e:m,w:.55}})(),(()=>{const u=f(.7,.35),m=f(.76,.35);return{c:u,e:m,w:.35}})()],l=[(()=>{const u=f(.3,.72),m=f(.52,.72);return{p1:u,p2:m,label:"AI length"}})()]}function M(){r.clearRect(0,0,o.width,o.height)}function g(){if(_(),M(),!!a){r.save(),r.lineWidth=2,r.font="12px system-ui, -apple-system, Segoe UI, Roboto, Arial",r.textBaseline="top";for(const u of p){const m=c(u.c),E=c(u.e),b=Math.hypot(m[0]-E[0],m[1]-E[1]),L=r.createRadialGradient(m[0],m[1],0,m[0],m[1],b);L.addColorStop(0,"rgba(255,0,0,"+.35*u.w+")"),L.addColorStop(1,"rgba(255,0,0,0)"),r.fillStyle=L,r.beginPath(),r.arc(m[0],m[1],b,0,Math.PI*2),r.fill()}r.strokeStyle="rgba(0,255,0,0.9)",r.fillStyle="rgba(0,255,0,0.9)";for(const u of s){const m=c(u.a),E=c(u.b),b=Math.min(m[0],E[0]),L=Math.min(m[1],E[1]),H=Math.abs(m[0]-E[0]),oe=Math.abs(m[1]-E[1]);r.strokeRect(b,L,H,oe),r.fillText(u.label,b+3,L+3)}r.strokeStyle="rgba(255,255,0,0.95)",r.fillStyle="rgba(255,255,0,0.95)";for(const u of l){const m=c(u.p1),E=c(u.p2);r.beginPath(),r.moveTo(m[0],m[1]),r.lineTo(E[0],E[1]),r.stroke();const b=C(u.p1,u.p2).toFixed(1);r.fillText(u.label+": "+b+" mm",(m[0]+E[0])/2+6,(m[1]+E[1])/2+6)}r.restore()}}const v=()=>window.requestAnimationFrame(g);return window.addEventListener("resize",v,{passive:!0}),n.addEventListener("wheel",v,{passive:!0}),n.addEventListener("pointermove",v,{passive:!0}),n.addEventListener("pointerup",v,{passive:!0}),{start(){a=!0,x(),g()},stop(){a=!1,g()},toggle(){a?this.stop():this.start()},redraw:g,destroy(){try{o.remove()}catch{}window.removeEventListener("resize",v)}}}const $=document.getElementById("dicomViewport"),fe=document.getElementById("status"),Ae=document.getElementById("dicomFiles");let re,D,ae;function O(e){fe&&(fe.textContent=e)}function ve(e){return e?.stack||e?.message||String(e)}O("main.js running. Loading Cornerstone modules...");async function Pe(){try{const e=await Y(()=>import("./index-DdKylV0O.js"),__vite__mapDeps([0,1,2,3])),t=await Y(()=>import("./index-BFl08faP.js"),__vite__mapDeps([4,1,2])),n=await Y(()=>import("./index-BE8N2Zch.js"),__vite__mapDeps([5,1,3]));if(O("Initializing Cornerstone..."),await e.init(),await t.init(),n.init({maxWebWorkers:navigator.hardwareConcurrency||1}),ae=n.wadouri,!ae?.fileManager?.add)throw new Error("wadouri.fileManager.add is missing. DICOM image loader did not initialize.");const{addTool:i,ToolGroupManager:o,PanTool:r,ZoomTool:a,WindowLevelTool:s,StackScrollTool:p,LengthTool:l,Enums:h}=t;i(r),i(a),i(s),i(p),i(l);const I="re1",c="vp1";re=new e.RenderingEngine(I),re.enableElement({viewportId:c,type:e.Enums.ViewportType.STACK,element:$}),D=re.getViewport(c),window.__rav_viewport=D;const _=o.createToolGroup("tg1");_.addTool(p.toolName),_.addTool(s.toolName),_.addTool(r.toolName),_.addTool(a.toolName),_.addTool(l.toolName),_.addViewport(c,I);const f=h?.MouseBindings??null,x=h?.KeyboardBindings??null;f?(_.setToolActive(s.toolName,{bindings:[{mouseButton:f.Primary}]}),_.setToolActive(r.toolName,{bindings:[{mouseButton:f.Auxiliary}]}),_.setToolActive(a.toolName,{bindings:[{mouseButton:f.Secondary}]}),_.setToolActive(p.toolName,{bindings:[{mouseButton:f.Wheel}]}),x?.Shift!=null?_.setToolActive(l.toolName,{bindings:[{mouseButton:f.Primary,modifierKey:x.Shift}]}):_.setToolPassive(l.toolName)):(_.setToolActive(p.toolName),_.setToolActive(s.toolName),_.setToolPassive(r.toolName),_.setToolPassive(a.toolName),_.setToolPassive(l.toolName)),D.render(),O("Ready. Choose DICOM files (one series) to load.")}catch(e){console.error(e),O("Initialization failed:\\n"+ve(e))}}async function Ee(e){const t=Array.from(e||[]).filter(n=>n&&n.size>0);if(t.length!==0){if(!D){O("Viewer not initialized yet. See error above.");return}try{t.sort((i,o)=>i.name.localeCompare(o.name,void 0,{numeric:!0,sensitivity:"base"})),O("Indexing files...");const n=t.map(i=>ae.fileManager.add(i));O("Loading stack..."),await D.setStack(n),D.render(),O("Loaded "+n.length+" slices. Wheel scroll, left drag window/level, middle pan, right zoom.")}catch(n){console.error(n),O("Load failed:\\n"+ve(n)+"\\nTry selecting only one series.")}}}Ae?.addEventListener("change",e=>Ee(e.target.files));$?.addEventListener("dragover",e=>{e.preventDefault()});$?.addEventListener("drop",e=>{e.preventDefault(),Ee(e.dataTransfer.files)});Pe();(()=>{function e(){return typeof $<"u"&&$||document.getElementById("dicomViewport")||document.getElementById("viewport")||document.querySelector("[data-viewport]")||(document.querySelector("canvas")?document.querySelector("canvas").parentElement:null)}function t(){try{if(window.__rav_viewport)return window.__rav_viewport;if(typeof D<"u"&&D)return D}catch{}return null}function n(s){try{if(s&&typeof s.getImageIds=="function")return(s.getImageIds()||[]).length>0}catch{}return!1}function i(){let s=document.getElementById("btnAIMock");return s||(s=document.createElement("button"),s.id="btnAIMock",s.type="button",s.textContent="AI Overlay",s.setAttribute("aria-label","Toggle AI overlay"),document.body.appendChild(s)),s.style.setProperty("position","fixed","important"),s.style.setProperty("top","56px","important"),s.style.setProperty("right","12px","important"),s.style.setProperty("z-index","1000000","important"),s.style.setProperty("padding","8px 10px","important"),s.style.setProperty("border-radius","10px","important"),s.style.setProperty("border","1px solid rgba(255,255,255,0.35)","important"),s.style.setProperty("background","rgba(255,255,255,0.92)","important"),s.style.setProperty("color","#111","important"),s.style.setProperty("font-weight","700","important"),s.style.setProperty("font-size","13px","important"),s.style.setProperty("line-height","1","important"),s.style.setProperty("cursor","pointer","important"),s.style.setProperty("backdrop-filter","blur(6px)","important"),s}function o(){const s=e();!s||s.__ravWheelGuard||(s.__ravWheelGuard=!0,s.addEventListener("wheel",p=>{const l=t();n(l)||(p.preventDefault(),p.stopImmediatePropagation())},{capture:!0,passive:!1}))}function r(){if(window.__aiMock)return window.__aiMock;const s=e();if(!s)return null;const p=t();try{const l=Re({viewport:p,container:s});return window.__aiMock=l,l}catch(l){return console.warn("AI overlay install failed:",l),null}}function a(){const s=i();o(),s.addEventListener("click",()=>{const l=r();if(!l){alert("Load a DICOM series first, then click AI Overlay again.");return}l.toggle()}),new MutationObserver(()=>{o();const l=t();!window.__aiMock&&n(l)&&r()}).observe(document.documentElement,{childList:!0,subtree:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",a):a()})();(()=>{function e(){Y(()=>import("./aiOverlayServer-e110uUkE.js"),[]).then(t=>t.installAIServerPanel&&t.installAIServerPanel()).catch(()=>{})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):e()})();function k(e){return document.getElementById(e)}function Ce(e){const t=Number(e);return Number.isFinite(t)?t:null}function Oe(){return{renderingEngine:window.__CS_RENDERING_ENGINE__||null,viewportId:window.__CS_VIEWPORT_ID__||null}}async function De(e){const t=Oe();if(!t.renderingEngine||!t.viewportId){console.warn("[AI Results] Missing Cornerstone context. Set window.__CS_RENDERING_ENGINE__ and window.__CS_VIEWPORT_ID__ in your main code.");return}const n=t.renderingEngine.getViewport(t.viewportId);if(!n){console.warn("[AI Results] Viewport not found:",t.viewportId);return}const i=Ce(e.sliceIndex);if(i!==null)try{if(typeof n.setImageIdIndex=="function")await n.setImageIdIndex(i);else if(typeof n.setImageIndex=="function")await n.setImageIndex(i);else if(typeof n.scroll=="function"){const o=typeof n.getCurrentImageIdIndex=="function"?n.getCurrentImageIdIndex():null;o!==null&&n.scroll(i-o)}}catch(o){console.warn("[AI Results] Slice jump failed:",o)}try{if(typeof n.getZoom=="function"&&typeof n.setZoom=="function"){const o=n.getZoom()||1;n.setZoom(o*1.6)}else if(typeof n.getCamera=="function"&&typeof n.setCamera=="function"){const o=n.getCamera();o&&o.parallelScale&&n.setCamera({parallelScale:o.parallelScale/1.6})}}catch(o){console.warn("[AI Results] Zoom failed:",o)}try{typeof n.render=="function"&&n.render()}catch{}window.dispatchEvent(new CustomEvent("ai:select",{detail:e}))}function ke(){const e=k("aiResultsPanel"),t=k("aiResultsList"),n=k("aiResultsCount"),i=k("aiResultsDockBtn"),o=k("aiResultsToggleBtn"),r=k("aiResultsClearBtn"),a=k("aiResultsSearch"),s=k("aiResultsFilter");if(!e||!t||!n||!i||!o||!r||!a||!s)return console.warn("[AI Results] Missing panel elements. Did index.html injection run?"),null;let p=[];function l(){e.classList.remove("is-collapsed"),e.style.pointerEvents="auto",e.style.opacity="1"}function h(){const g=e.classList.toggle("is-collapsed");e.style.pointerEvents=g?"none":"auto",e.style.opacity=g?"0":"1"}function I(){p=[],x()}function c(g){const v=new Set;return g.forEach(u=>v.add(String(u.label||"Unknown").toLowerCase())),Array.from(v).sort()}function C(){const g=c(p),v=String(s.value||"all").toLowerCase(),u=['<option value="all">All</option>'].concat(g.map(E=>`<option value="${E}">${E}</option>`)).join("");s.innerHTML=u;const m=Array.from(s.options).some(E=>String(E.value).toLowerCase()===v);s.value=m?v:"all"}function _(g){const v=String(a.value||"").trim().toLowerCase(),u=String(s.value||"all").trim().toLowerCase();return g.filter(m=>{const E=String(m.label||"Unknown").toLowerCase(),b=String(m.id||"").toLowerCase(),L=u==="all"?!0:E===u,H=v?E.includes(v)||b.includes(v):!0;return L&&H})}function f(){const g=_(p);n.textContent=String(g.length),t.innerHTML=g.map(v=>{const u=String(v.label||"Unknown"),m=String(v.id||""),E=typeof v.score=="number"?`${Math.round(v.score*100)}%`:"NA",b=Ce(v.sliceIndex),L=b!==null?`Slice ${b}`:"Slice NA";return`
        <div class="aiResultItem" data-id="${m}">
          <div class="aiResultTop">
            <div class="aiResultLabel">${u}</div>
            <div class="aiResultBadge">${E}</div>
          </div>
          <div class="aiResultMeta">
            <span>${L}</span>
            ${m?`<span>${m}</span>`:""}
          </div>
        </div>
      `}).join("")}function x(){C(),f()}t.addEventListener("click",g=>{const v=g.target.closest(".aiResultItem");if(!v)return;const u=v.getAttribute("data-id")||"",m=p.find(E=>String(E.id||"")===u)||null;m&&De(m)}),i.addEventListener("click",h),o.addEventListener("click",h),r.addEventListener("click",I),a.addEventListener("input",x),s.addEventListener("change",x);function M(g){p=Array.isArray(g)?g:[],l(),x()}return window.addEventListener("ai:results",g=>{M(g&&g.detail?g.detail:[])}),window.setAIResults=M,x(),{setResults:M,clear:I,togglePanel:h,openPanel:l}}document.addEventListener("DOMContentLoaded",()=>{try{ke()}catch(e){console.warn("[AI Results] init failed:",e)}});function Fe(e,t=document){return Array.from(t.querySelectorAll(e))}function A(e){return Array.isArray(e)?e:[]}function We(e){return String(e??"").toLowerCase()}function Be(e){return String(e??"").trim().toUpperCase()}const T={get(e,t=""){try{if(typeof localStorage>"u"||!localStorage.getItem)return t;const n=localStorage.getItem(e);return n==null||n===""?t:n}catch{return t}},set(e,t){try{if(typeof localStorage>"u"||!localStorage.setItem)return;localStorage.setItem(e,String(t))}catch{}}};function He(){return{renderingEngine:window.__CS_RENDERING_ENGINE__||null,viewportId:window.__CS_VIEWPORT_ID__||null}}function N(){const e=He();if(!e.renderingEngine||!e.viewportId)return null;try{return e.renderingEngine.getViewport(e.viewportId)||null}catch{return null}}function be(e){return e&&e.element?e.element:window.__CS_ELEMENT__?window.__CS_ELEMENT__:null}function U(e){try{if(e&&typeof e.getImageIds=="function")return A(e.getImageIds()).length}catch{}if(Array.isArray(window.__STACK_IMAGE_IDS__))return window.__STACK_IMAGE_IDS__.length;try{if(e&&typeof e.getStack=="function"){const t=e.getStack();if(t&&Array.isArray(t.imageIds))return t.imageIds.length}}catch{}return 0}function F(e){try{if(e&&typeof e.getCurrentImageIdIndex=="function")return Number(e.getCurrentImageIdIndex())||0;if(e&&typeof e.getImageIdIndex=="function")return Number(e.getImageIdIndex())||0;if(e&&typeof e.getCurrentImageIndex=="function")return Number(e.getCurrentImageIndex())||0}catch{}return 0}function ee(e){try{const t=e&&typeof e.getImageIds=="function"?A(e.getImageIds()):[];if(!t.length)return null;const n=Math.min(Math.max(0,F(e)),t.length-1);return t[n]||null}catch{return null}}function Ve(e){try{if(e&&typeof e.getImageData=="function"){const o=e.getImageData();if(o&&o.dimensions&&o.dimensions.length>=2){const r=Number(o.dimensions[0])||0,a=Number(o.dimensions[1])||0;if(r>0&&a>0)return{cols:r,rows:a}}}}catch{}const t=ee(e),n=window.cornerstone||window.cornerstonejs||window.cornerstone3d||null,i=n&&n.metaData&&typeof n.metaData.get=="function"?n.metaData.get.bind(n.metaData):null;if(i&&t)try{const o=Number(i("x00280010",t)),r=Number(i("x00280011",t));if(o>0&&r>0)return{cols:r,rows:o}}catch{}return{cols:512,rows:512}}function me(e){const t=document.getElementById("aiResultsDockCount");t&&(t.textContent=String(Math.max(0,Number(e)||0)))}function Ge(){window.addEventListener("ai:results",t=>{const n=t&&t.detail?t.detail:[],i=A(n);window.__AI_FINDINGS__=i,me(i.length)});const e=setInterval(()=>{if(window.__AI_RESULTS_WRAPPED__){clearInterval(e);return}if(typeof window.setAIResults=="function"){const t=window.setAIResults;window.setAIResults=n=>{const i=A(n);return window.__AI_FINDINGS__=i,me(i.length),t(i)},window.__AI_RESULTS_WRAPPED__=!0,clearInterval(e)}},400)}function ze(){const e=document.getElementById("aiResultsPanel");if(!e)return;e.classList.toggle("is-collapsed");const t=e.classList.contains("is-collapsed");e.style.pointerEvents=t?"none":"auto",e.style.opacity=t?"0":"1"}function je(e,t){return!t||t<1?"-- / --":Math.min(Math.max(0,e),t-1)+1+" / "+t}function B(e){if(!e)return;const t=N();if(!t){e.textContent!=="-- / --"&&(e.textContent="-- / --");return}const n=U(t),i=F(t),o=je(i,n);e.textContent!==o&&(e.textContent=o)}function Ue(e){B(e),window.__SLICE_COUNTER_TIMER__&&clearInterval(window.__SLICE_COUNTER_TIMER__),window.__SLICE_COUNTER_TIMER__=setInterval(()=>B(e),200);const t=()=>{const n=N(),i=be(n);if(!i||!i.addEventListener||window.__SLICE_COUNTER_EVENTS_HOOKED__)return;window.__SLICE_COUNTER_EVENTS_HOOKED__=!0,["CORNERSTONE_STACK_NEW_IMAGE","CORNERSTONE_STACK_VIEWPORT_SCROLL","CORNERSTONE_VIEWPORT_NEW_IMAGE_SET","CORNERSTONE_IMAGE_RENDERED","CORNERSTONE_VOLUME_NEW_IMAGE"].forEach(r=>{try{i.addEventListener(r,()=>B(e))}catch{}})};setTimeout(t,300),setTimeout(t,1200),document.addEventListener("wheel",()=>B(e),{passive:!0}),document.addEventListener("keydown",n=>{const i=String(n.key||"");(i==="ArrowUp"||i==="ArrowDown"||i==="PageUp"||i==="PageDown")&&B(e)})}function pe(){const e=N();if(!e){console.warn("[Reset View] Missing viewport. Set window.__CS_RENDERING_ENGINE__ and window.__CS_VIEWPORT_ID__.");return}try{typeof e.resetCamera=="function"&&e.resetCamera(),typeof e.resetProperties=="function"&&e.resetProperties(),typeof e.setZoom=="function"&&e.setZoom(1),typeof e.setPan=="function"&&e.setPan({x:0,y:0}),typeof e.render=="function"&&e.render()}catch(t){console.warn("[Reset View] failed:",t)}}function K(e){const t=Be(e);return t.startsWith("CT")?"CT":t.startsWith("MR")?"MR":t||"OTHER"}function G(){const e=window.__DICOM_MODALITY__||window.__CS_MODALITY__||window.__MODALITY__;if(e)return K(e);const t=N();if(!t)return"OTHER";const n=ee(t);if(!n)return"OTHER";const i=window.cornerstone||window.cornerstonejs||window.cornerstone3d||null,o=i&&i.metaData&&typeof i.metaData.get=="function"?i.metaData.get.bind(i.metaData):null;if(o){try{const r=o("generalSeriesModule",n);if(r&&(r.modality||r.Modality))return K(r.modality||r.Modality)}catch{}try{const r=o("x00080060",n);if(r)return K(r)}catch{}}return window.__CS_METADATA__&&window.__CS_METADATA__.modality?K(window.__CS_METADATA__.modality):"OTHER"}function Ke(e,t){try{if(e&&typeof e.getProperties=="function"){const n=e.getProperties();if(n&&typeof n[t]=="boolean")return n[t]}}catch{}return null}function $e(e,t){try{if(e&&typeof e.setProperties=="function")return e.setProperties(t),typeof e.render=="function"&&e.render(),!0}catch{}return!1}function te(e){try{if(e&&typeof e.getViewPresentation=="function")return e.getViewPresentation()}catch{}return null}function ne(e,t){try{if(e&&typeof e.setViewPresentation=="function")return e.setViewPresentation(t),typeof e.render=="function"&&e.render(),!0}catch{}return!1}function we(e){const t=N();if(!t)return;const n=Ke(t,"invert");if(n!==null){const r=!n;$e(t,{invert:r}),e&&e.classList.toggle("is-active",r);return}const i=te(t);if(!i)return;const o=!i.invert;i.invert=o,ne(t,i),e&&e.classList.toggle("is-active",o)}function ge(){const e=N();if(!e)return;try{if(typeof e.getProperties=="function"&&typeof e.setProperties=="function"){const i=e.getProperties()||{},r=((Number(i.rotation)||0)+90)%360;e.setProperties({rotation:r}),typeof e.render=="function"&&e.render();return}}catch{}const t=te(e);if(!t)return;const n=Number(t.rotation)||0;t.rotation=(n+90)%360,ne(e,t)}function ye(e){const t=N();if(!t)return;const n=te(t);if(!n){try{if(typeof t.getProperties=="function"&&typeof t.setProperties=="function"){const r=!(t.getProperties()||{}).flipHorizontal;t.setProperties({flipHorizontal:r}),typeof t.render=="function"&&t.render(),e&&e.classList.toggle("is-active",r)}}catch{}return}const i=!n.flipHorizontal;n.flipHorizontal=i,ne(t,n),e&&e.classList.toggle("is-active",i)}function he(e){const t=N();if(!t)return;const n=te(t);if(!n){try{if(typeof t.getProperties=="function"&&typeof t.setProperties=="function"){const r=!(t.getProperties()||{}).flipVertical;t.setProperties({flipVertical:r}),typeof t.render=="function"&&t.render(),e&&e.classList.toggle("is-active",r)}}catch{}return}const i=!n.flipVertical;n.flipVertical=i,ne(t,n),e&&e.classList.toggle("is-active",i)}function J(e){if(!e)return null;try{if(typeof e.getProperties=="function"){const t=e.getProperties();if(t&&t.voiRange&&Number.isFinite(t.voiRange.lower)&&Number.isFinite(t.voiRange.upper))return{lower:Number(t.voiRange.lower),upper:Number(t.voiRange.upper)}}}catch{}try{if(typeof e.getVOI=="function"){const t=e.getVOI();if(t){if(Number.isFinite(t.lower)&&Number.isFinite(t.upper))return{lower:Number(t.lower),upper:Number(t.upper)};if(Number.isFinite(t.windowCenter)&&Number.isFinite(t.windowWidth)){const n=Number(t.windowCenter)-Number(t.windowWidth)/2,i=Number(t.windowCenter)+Number(t.windowWidth)/2;return{lower:n,upper:i}}}}}catch{}try{if(typeof e.getWindowLevel=="function"){const t=e.getWindowLevel();if(t&&Number.isFinite(t.windowCenter)&&Number.isFinite(t.windowWidth)){const n=Number(t.windowCenter)-Number(t.windowWidth)/2,i=Number(t.windowCenter)+Number(t.windowWidth)/2;return{lower:n,upper:i}}}}catch{}return null}function Q(e){if(!e||!Number.isFinite(e.lower)||!Number.isFinite(e.upper))return null;const t=e.upper-e.lower,n=(e.upper+e.lower)/2;return!Number.isFinite(t)||!Number.isFinite(n)||t<=0?null:{ww:t,wl:n}}function W(e,t){const n=N();if(!n){console.warn("[W/L] Missing viewport. Set window.__CS_RENDERING_ENGINE__ and window.__CS_VIEWPORT_ID__.");return}const i=Number(e),o=Number(t);if(!Number.isFinite(i)||!Number.isFinite(o)||i<=0)return;const r=o-i/2,a=o+i/2;try{typeof n.setProperties=="function"?n.setProperties({voiRange:{lower:r,upper:a}}):typeof n.setVOI=="function"?n.setVOI({windowWidth:i,windowCenter:o}):typeof n.setWindowLevel=="function"&&n.setWindowLevel(o,i),typeof n.render=="function"&&n.render()}catch(s){console.warn("[W/L] apply failed:",s)}}function qe(e){return e==="brain"?{ww:70,wl:35}:e==="soft"?{ww:350,wl:50}:e==="lung"?{ww:1500,wl:-600}:e==="bone"?{ww:2500,wl:500}:e==="abdomen"?{ww:400,wl:50}:e==="liver"?{ww:150,wl:30}:null}function se(e,t,n){if(!t||!n)return;const i=N(),o=Q(J(i));if(e==="CT"){t.min="-1024",t.max="3071",t.step="1",n.min="1",n.max="4000",n.step="1";return}const r=o?o.wl:0,a=o?o.ww:800,s=Math.floor(r-2e3),p=Math.ceil(r+2e3),l=Math.ceil(Math.max(2e3,a*3));t.min=String(s),t.max=String(p),t.step="1",n.min="1",n.max=String(l),n.step="1"}function R(e,t){return"wl_"+t+"_"+(e||"OTHER")}async function X(e,t){if(e){try{if(typeof e.setImageIdIndex=="function")await e.setImageIdIndex(t);else if(typeof e.setImageIndex=="function")await e.setImageIndex(t);else if(typeof e.scroll=="function"){const n=F(e);e.scroll(t-n)}typeof e.render=="function"&&e.render()}catch(n){console.warn("[Cine] set index failed:",n)}window.__SLICE_COUNTER_EL__&&B(window.__SLICE_COUNTER_EL__)}}function Ze(e){let t=!1,n=null;const i=document.createElement("button");i.className="btn small",i.type="button",i.textContent="Cine";const o=document.createElement("button");o.className="btn small",o.type="button",o.textContent="Prev";const r=document.createElement("button");r.className="btn small",r.type="button",r.textContent="Next";const a=document.createElement("span");a.className="cineFps",a.innerHTML='<span class="cineMini">FPS</span>';const s=document.createElement("input");s.className="cineSlider",s.type="range",s.min="1",s.max="30",s.step="1",s.value="12";const p=document.createElement("span");p.className="cineMini",p.textContent=s.value,a.appendChild(s),a.appendChild(p);function l(){t=!1,i.textContent="Cine",n&&(clearInterval(n),n=null)}async function h(){const c=N();if(!c){l();return}const C=U(c);if(!C){l();return}const f=(F(c)+1)%C;await X(c,f)}function I(){const c=N();if(!c){console.warn("[Cine] Missing viewport context.");return}if(!U(c)){console.warn("[Cine] No stack loaded.");return}t=!0,i.textContent="Pause";const _=Number(s.value)||12,f=Math.max(20,Math.round(1e3/_));n&&clearInterval(n),n=setInterval(()=>{h()},f)}i.addEventListener("click",()=>{t?l():I()}),s.addEventListener("input",()=>{p.textContent=s.value,t&&(l(),I())}),o.addEventListener("click",async()=>{const c=N();if(!c)return;const C=U(c);if(!C)return;const f=(F(c)-1+C)%C;await X(c,f)}),r.addEventListener("click",async()=>{const c=N();if(!c)return;const C=U(c);if(!C)return;const f=(F(c)+1)%C;await X(c,f)}),e.appendChild(i),e.appendChild(o),e.appendChild(r),e.appendChild(a)}function Ye(e){if(Array.isArray(e))return e.map((i,o)=>_e(i,o));const t=e&&typeof e=="object"?e:{},n=t.findings??t.detections??t.predictions??t.results??t.output??[];return A(n).map((i,o)=>_e(i,o))}function _e(e,t){const n=e&&typeof e=="object"?e:{},i=n.id??n.uid??n.nameId??"f"+(t+1),o=n.label??n.type??n.class??n.name??"Finding",r=typeof n.score=="number"?n.score:typeof n.confidence=="number"?n.confidence:typeof n.prob=="number"?n.prob:null,a=n.sliceIndex??n.slice??n.z??n.frame??null,s=n.bbox??n.box??n.boundingBox??null;return{id:String(i),label:String(o),score:r,sliceIndex:a,bbox:s}}function Je(e){const t=A(e);if(window.__AI_FINDINGS__=t,window.dispatchEvent(new CustomEvent("ai:results",{detail:t})),typeof window.setAIResults=="function")try{window.setAIResults(t)}catch{}}function Qe(){if(window.__AI_FETCH_INTERCEPTOR__)return;window.__AI_FETCH_INTERCEPTOR__=!0;const e=window.fetch;typeof e=="function"&&(window.fetch=async(...t)=>{const n=await e(...t);try{if(!(n.headers&&n.headers.get&&n.headers.get("content-type")||"").toLowerCase().includes("application/json"))return n;const r=await n.clone().json(),a=r&&typeof r=="object"?r:null;if(a&&("findings"in a||"detections"in a||"predictions"in a||"results"in a)||Array.isArray(r)){const p=Ye(r);p.length&&Je(p)}}catch{}return n})}function z(e){return e==null?"":typeof e=="string"?e.trim():typeof e=="number"?String(e):Array.isArray(e)?e.map(z).filter(Boolean).join("\\"):typeof e=="object"?e.Alphabetic?String(e.Alphabetic):Array.isArray(e.Value)?e.Value.map(z).filter(Boolean).join("\\"):JSON.stringify(e):String(e)}function Xe(e){const t=String(e||"").trim();return t?/^\d{8}$/.test(t)?t.slice(0,4)+"-"+t.slice(4,6)+"-"+t.slice(6,8):t:""}function P(e,t){const n=window.cornerstone||window.cornerstonejs||window.cornerstone3d||null,i=n&&n.metaData&&typeof n.metaData.get=="function"?n.metaData.get.bind(n.metaData):null;if(!i||!e)return"";try{return z(i(t,e))}catch{return""}}function et(e){if(document.getElementById("dicomHud"))return;const t=document.createElement("div");t.id="dicomHud",t.className="dicomHud";const n=document.createElement("div");n.className="dicomHudHeader";const i=document.createElement("div");i.className="dicomHudTitle",i.textContent="DICOM HUD";const o=document.createElement("button");o.className="dicomHudToggle",o.type="button",o.textContent="Hide",o.addEventListener("click",()=>{t.classList.toggle("is-collapsed");const h=t.classList.contains("is-collapsed");o.textContent=h?"Show":"Hide"}),n.appendChild(i),n.appendChild(o);const r=document.createElement("div");r.className="dicomHudBody";const a=document.createElement("div");a.className="dicomHudGrid",a.id="dicomHudGrid";const s=document.createElement("div");s.className="dicomHudFindings";const p=document.createElement("div");p.className="dicomHudFindingsTitle",p.textContent="Findings (click to jump)";const l=document.createElement("div");l.id="dicomHudFindingsList",s.appendChild(p),s.appendChild(l),r.appendChild(a),r.appendChild(s),t.appendChild(n),t.appendChild(r),e.appendChild(t)}function tt(e){const t=document.getElementById("dicomHudGrid");t&&(t.innerHTML="",e.forEach(n=>{const i=document.createElement("div");i.className="dicomHudField";const o=document.createElement("div");o.className="dicomHudKey",o.textContent=n.key;const r=document.createElement("div");r.className="dicomHudVal",r.textContent=n.val||"--",i.appendChild(o),i.appendChild(r),t.appendChild(i)}))}function Ie(){const e=N(),t=Se(e);if(!e||!t)return;et(t);const n=ee(e);if(!n)return;const i=P(n,"x00100010"),o=P(n,"x00100020"),r=Xe(P(n,"x00080020")),a=P(n,"x00081030"),s=P(n,"x0008103e"),p=P(n,"x00080060"),l=P(n,"x00200011"),h=P(n,"x00200013"),I=P(n,"x00180050"),c=P(n,"x00280030");tt([{key:"Patient",val:i},{key:"Patient ID",val:o},{key:"Study Date",val:r},{key:"Study",val:a},{key:"Series",val:s},{key:"Modality",val:K(p)},{key:"Series No",val:l},{key:"Instance No",val:h},{key:"Slice Thick",val:I},{key:"Pixel Spacing",val:c}]),Ne()}function Ne(){const e=document.getElementById("dicomHudFindingsList");if(!e)return;const t=N();if(!t){e.innerHTML="";return}const n=F(t),o=A(window.__AI_FINDINGS__).filter(r=>r&&r.sliceIndex!==null&&r.sliceIndex!==void 0&&r.sliceIndex!==""?Number(r.sliceIndex)===Number(n):!0);if(!o.length){e.innerHTML='<div class="dicomHudKey">No findings on this slice.</div>';return}e.innerHTML="",o.slice(0,25).forEach(r=>{const a=document.createElement("div");a.className="dicomHudFinding";const s=document.createElement("div");s.style.minWidth="0",s.style.flex="1 1 auto",s.textContent=r.label||"Finding";const p=document.createElement("div");p.className="dicomHudFindingMeta";const l=typeof r.score=="number"?" "+Math.round(r.score*100)+"%":"",h=r.sliceIndex!==null&&r.sliceIndex!==void 0&&r.sliceIndex!==""?"S"+(Number(r.sliceIndex)+1):"S"+(n+1);p.textContent=h+l,a.appendChild(s),a.appendChild(p),a.addEventListener("click",async()=>{const I=N();if(!I)return;const c=r.sliceIndex!==null&&r.sliceIndex!==void 0&&r.sliceIndex!==""?Number(r.sliceIndex):n;await X(I,c)}),e.appendChild(a)})}function nt(e){if(!e)return null;if(Array.isArray(e)&&e.length>=4){const t=e.map(Number);if(t.some(a=>!Number.isFinite(a)))return null;const n=t[0],i=t[1],o=t[2],r=t[3];return o>n&&r>i&&t.length===4?{x:n,y:i,w:o-n,h:r-i}:{x:t[0],y:t[1],w:t[2],h:t[3]}}if(typeof e=="object"){const t=Number(e.x??e.left??e.x1),n=Number(e.y??e.top??e.y1),i=Number(e.w??e.width),o=Number(e.h??e.height),r=Number(e.x2),a=Number(e.y2);if(Number.isFinite(t)&&Number.isFinite(n)&&Number.isFinite(i)&&Number.isFinite(o))return{x:t,y:n,w:i,h:o};if(Number.isFinite(t)&&Number.isFinite(n)&&Number.isFinite(r)&&Number.isFinite(a)&&r>t&&a>n)return{x:t,y:n,w:r-t,h:a-n}}return null}function ot(e,t){if(Math.max(e.x,e.y,e.w,e.h)<=1)return e;const i=Math.max(1,Number(t.cols)||1),o=Math.max(1,Number(t.rows)||1);return{x:e.x/i,y:e.y/o,w:e.w/i,h:e.h/o}}function it(e){let t=document.getElementById("aiOverlayCanvas");return t||(t=document.createElement("canvas"),t.id="aiOverlayCanvas",t.className="aiOverlayCanvas",e.appendChild(t),t)}function Se(e){const t=be(e);if(!t)return null;const i=String(t.tagName||"").toLowerCase()==="canvas"&&t.parentElement?t.parentElement:t;return window.getComputedStyle(i).position==="static"&&(i.style.position="relative"),i}function Z(){const e=N();if(!e)return;const t=Se(e);if(!t)return;const n=it(t),i=n.getContext("2d");if(!i)return;const o=Math.max(1,t.clientWidth),r=Math.max(1,t.clientHeight),a=Math.max(1,Math.floor(window.devicePixelRatio||1));(n.width!==o*a||n.height!==r*a)&&(n.width=o*a,n.height=r*a,n.style.width=o+"px",n.style.height=r+"px"),i.setTransform(a,0,0,a,0,0),i.clearRect(0,0,o,r);const s=F(e),p=Ve(e),h=A(window.__AI_FINDINGS__).filter(I=>I?I.sliceIndex===null||I.sliceIndex===void 0||I.sliceIndex===""?!0:Number(I.sliceIndex)===Number(s):!1);h.length&&(i.lineWidth=2,i.font="12px system-ui, -apple-system, Segoe UI, Roboto, Arial",i.textBaseline="top",h.forEach(I=>{const c=nt(I.bbox);if(!c)return;const C=ot(c,p),_=Math.max(0,Math.min(1,C.x))*o,f=Math.max(0,Math.min(1,C.y))*r,x=Math.max(0,Math.min(1,C.w))*o,M=Math.max(0,Math.min(1,C.h))*r;i.strokeStyle="rgba(34,197,94,0.95)",i.fillStyle="rgba(34,197,94,0.18)",i.strokeRect(_,f,x,M),i.fillRect(_,f,x,M);const g=(I.label||"Finding")+(typeof I.score=="number"?" "+Math.round(I.score*100)+"%":""),v=4,u=i.measureText(g).width,m=16;i.fillStyle="rgba(0,0,0,0.55)",i.fillRect(_,Math.max(0,f-m),u+v*2,m),i.fillStyle="rgba(255,255,255,0.95)",i.fillText(g,_+v,Math.max(0,f-m)+2)}))}function rt(e){const t=A(e),n=window.cornerstone||window.cornerstonejs||window.cornerstone3d||null,i=n&&n.metaData&&typeof n.metaData.get=="function"?n.metaData.get.bind(n.metaData):null;if(!i||!t.length)return[];const o=new Map;t.forEach(a=>{try{const s=z(i("x0020000e",a)),p=z(i("x0008103e",a)),l=z(i("x00200011",a)),h=s||"series-"+p+"-"+l;if(!o.has(h)){const I=(p||"Series")+(l?" #"+l:"");o.set(h,{id:h,label:I,imageIds:[]})}o.get(h).imageIds.push(a)}catch{}});const r=Array.from(o.values()).filter(a=>a.imageIds&&a.imageIds.length);return r.sort((a,s)=>String(a.label).localeCompare(String(s.label))),r}async function st(e){const t=N();if(!t||!e||!e.imageIds||!e.imageIds.length)return;const n=e.imageIds;try{if(typeof t.setStack=="function")await t.setStack(n,0);else if(typeof t.setImageIds=="function")await t.setImageIds(n);else if(typeof t.setImages=="function")await t.setImages(n);else{console.warn("[Series] No supported method found on viewport to set new imageIds.");return}window.__STACK_IMAGE_IDS__=n,typeof t.render=="function"&&t.render()}catch(i){console.warn("[Series] failed to apply series:",i)}}function at(){return Fe("button").find(t=>We(t.textContent).replace(/\s+/g," ").includes("ai analyze"))||null}function lt(){if(document.getElementById("toolbarControlsGroup"))return;const e=at(),t=e&&e.parentElement||document.body,n=document.createElement("span");n.id="toolbarControlsGroup",n.className="toolbarControlsGroup";const i=document.createElement("button");i.id="aiResultsDockBtn",i.className="btn small aiResultsDockBtn",i.type="button",i.title="AI Results",i.innerHTML='Results <span id="aiResultsDockCount" class="aiResultsDockCount">0</span>',i.addEventListener("click",()=>ze());const o=document.createElement("button");o.className="btn small",o.type="button",o.title="Reset view (zoom, pan, window level)",o.textContent="Reset View",o.addEventListener("click",()=>pe());const r=document.createElement("button");r.className="btn small",r.type="button",r.title="Invert",r.textContent="Invert",r.addEventListener("click",()=>we(r));const a=document.createElement("button");a.className="btn small",a.type="button",a.title="Rotate 90 degrees",a.textContent="Rotate",a.addEventListener("click",()=>ge());const s=document.createElement("button");s.className="btn small",s.type="button",s.title="Flip horizontal",s.textContent="Flip H",s.addEventListener("click",()=>ye(s));const p=document.createElement("button");p.className="btn small",p.type="button",p.title="Flip vertical",p.textContent="Flip V",p.addEventListener("click",()=>he(p));const l=document.createElement("select");l.id="seriesSelect",l.className="seriesSelect",l.title="Select series";const h=document.createElement("span");h.id="modalityBadge",h.className="modalityBadge",h.textContent="OTHER";const I=document.createElement("span");I.className="wlWrap";const c=document.createElement("select");c.className="wlSelect",c.title="Window/Level preset";const C=document.createElement("span");C.className="wlSliders";const _=document.createElement("span");_.className="wlSliderWrap",_.innerHTML='<span class="wlMini">WL</span>';const f=document.createElement("input");f.className="wlSlider",f.type="range";const x=document.createElement("span");x.className="wlMini",x.textContent="0",_.appendChild(f),_.appendChild(x);const M=document.createElement("span");M.className="wlSliderWrap",M.innerHTML='<span class="wlMini">WW</span>';const g=document.createElement("input");g.className="wlSlider",g.type="range";const v=document.createElement("span");v.className="wlMini",v.textContent="0",M.appendChild(g),M.appendChild(v),C.appendChild(_),C.appendChild(M),I.appendChild(c),I.appendChild(C);const u=document.createElement("span");u.id="sliceCounter",u.className="sliceCounter",u.textContent="-- / --",window.__SLICE_COUNTER_EL__=u,n.appendChild(i),n.appendChild(o),n.appendChild(r),n.appendChild(a),n.appendChild(s),n.appendChild(p),n.appendChild(l),n.appendChild(h),n.appendChild(I),n.appendChild(u),Ze(n),e&&e.parentElement?e.insertAdjacentElement("afterend",n):t.appendChild(n),Ge(),Ue(u);let m=!1;function E(w){const d=[];d.push({key:"default",label:"W/L: Default"}),w==="CT"?(d.push({key:"brain",label:"CT Brain (70/35)"}),d.push({key:"soft",label:"Soft Tissue (350/50)"}),d.push({key:"lung",label:"Lung (1500/-600)"}),d.push({key:"bone",label:"Bone (2500/500)"}),d.push({key:"abdomen",label:"Abdomen (400/50)"}),d.push({key:"liver",label:"Liver (150/30)"}),d.push({key:"custom",label:"Custom (sliders)"})):w==="MR"?(d.push({key:"mr_low",label:"MR Low contrast"}),d.push({key:"mr_high",label:"MR High contrast"}),d.push({key:"custom",label:"Custom (sliders)"})):d.push({key:"custom",label:"Custom (sliders)"}),c.innerHTML=d.map(y=>'<option value="'+y.key+'">'+y.label+"</option>").join("")}function b(){x.textContent=String(Math.round(Number(f.value)||0)),v.textContent=String(Math.round(Number(g.value)||0))}function L(w){const d=T.get(R(w,"preset"),"default"),y=Number(T.get(R(w,"wl"),"0")),S=Number(T.get(R(w,"ww"),"800"));return{preset:d,wl:y,ww:S}}function H(w){T.set(R(w,"wl"),f.value),T.set(R(w,"ww"),g.value),T.set(R(w,"preset"),"custom")}function oe(w){const d=N(),y=Q(J(d));if(!y)return;const S=w==="mr_high"?.7:1.4,j=Math.max(1,y.ww*S),V=y.wl;g.value=String(Math.round(j)),f.value=String(Math.round(V)),b(),W(g.value,f.value)}function ie(w,d){if(d==="default"){pe(),T.set(R(w,"preset"),"default"),setTimeout(()=>le(w),250);return}if(w==="CT"){if(d==="custom"){const S=L(w);Number.isFinite(S.ww)&&S.ww>0&&(g.value=String(Math.round(S.ww))),Number.isFinite(S.wl)&&(f.value=String(Math.round(S.wl))),b(),W(g.value,f.value),T.set(R(w,"preset"),"custom");return}const y=qe(d);if(!y)return;g.value=String(y.ww),f.value=String(y.wl),b(),W(y.ww,y.wl),T.set(R(w,"preset"),d);return}if(w==="MR"){if(d==="custom"){const y=L(w);Number.isFinite(y.ww)&&y.ww>0&&(g.value=String(Math.round(y.ww))),Number.isFinite(y.wl)&&(f.value=String(Math.round(y.wl))),b(),W(g.value,f.value),T.set(R(w,"preset"),"custom");return}(d==="mr_low"||d==="mr_high")&&(oe(d),T.set(R(w,"preset"),d));return}if(d==="custom"){const y=L(w);Number.isFinite(y.ww)&&y.ww>0&&(g.value=String(Math.round(y.ww))),Number.isFinite(y.wl)&&(f.value=String(Math.round(y.wl))),b(),W(g.value,f.value),T.set(R(w,"preset"),"custom")}}function le(w){const d=N(),y=Q(J(d));if(!y||m)return;const S=Number(f.value),j=Number(g.value),V=Math.round(y.wl),q=Math.round(y.ww);se(w,f,g),Math.abs(S-V)>2&&(f.value=String(V)),Math.abs(j-q)>2&&(g.value=String(q)),b()}function xe(){const w=G();window.__WL_MODALITY__=w,h.textContent=w,E(w),se(w,f,g);const d=L(w),y=N(),S=Q(J(y)),j=S?Math.round(S.wl):Number.isFinite(d.wl)?Math.round(d.wl):0,V=S?Math.round(S.ww):Number.isFinite(d.ww)&&d.ww>0?Math.round(d.ww):800;f.value=String(j),g.value=String(V),b();const q=d.preset||"default";c.value=q,setTimeout(()=>ie(w,c.value||"default"),300)}f.addEventListener("pointerdown",()=>{m=!0}),g.addEventListener("pointerdown",()=>{m=!0}),window.addEventListener("pointerup",()=>{m=!1}),f.addEventListener("input",()=>{b();const w=G();c.value!=="custom"&&(c.value="custom"),W(g.value,f.value),H(w)}),g.addEventListener("input",()=>{b();const w=G();c.value!=="custom"&&(c.value="custom"),W(g.value,f.value),H(w)}),c.addEventListener("change",()=>{const w=G();T.set(R(w,"preset"),c.value||"default"),ie(w,c.value||"default")});function Le(){let w=A(window.__SERIES_CATALOG__);if(!w.length){const y=A(window.__ALL_IMAGE_IDS__);y.length&&(w=rt(y))}const d=N();if(!w.length&&d&&typeof d.getImageIds=="function"){const y=A(d.getImageIds());y.length&&(w=[{id:"current",label:"Current series",imageIds:y}])}window.__SERIES_CATALOG_RESOLVED__=w,l.innerHTML=w.map(y=>'<option value="'+y.id+'">'+(y.label||y.id)+"</option>").join(""),w.length||(l.innerHTML='<option value="none">No series</option>')}l.addEventListener("change",async()=>{const w=A(window.__SERIES_CATALOG_RESOLVED__),d=String(l.value||""),y=w.find(S=>String(S.id)===d);y&&(await st(y),setTimeout(()=>{B(u),Ie(),Z()},250))}),Le(),document.addEventListener("keydown",w=>{const d=String(w.key||"").toLowerCase();d==="i"&&we(r),d==="r"&&ge(),d==="h"&&ye(s),d==="v"&&he(p)});let ce=G(),ue=null;setInterval(()=>{const w=N(),d=G();if(d!==ce){ce=d,window.__WL_MODALITY__=d,h.textContent=d,E(d),se(d,f,g);const S=L(d);c.value=S.preset||"default",ie(d,c.value||"default")}else h.textContent=d;le(d);const y=w?ee(w):null;y&&y!==ue&&(ue=y,Ie()),Z()},350),xe(),window.addEventListener("ai:results",()=>{Ne(),Z()})}document.addEventListener("DOMContentLoaded",()=>{try{lt(),Qe()}catch(e){console.warn("[Toolbar Controls] init failed:",e)}});export{Y as _};
